// ライブラリの読み込み

#runtime "hsp3mt"
#packopt runtime "hsp3mt.hrt"
#packopt name "editor"

#include "src/bass.as"
#include "src/bassconv.as"
#include "src/bass_fx.as"
#include "src/bass_vst.as"

#include "src/winapi.as"
#include "src/ksmcore.as"

#include "src/audio/key_sound.as"
#include "src/audio/laser_slam_sound.as"
#include "src/audio/fxdef.hsp"

#define FS_UTILS_REPLACE_CHDIR_WITH_SAFE_CHDIR
#include "src/filesystem_utils.as"

#include "d3m.hsp"
#include "third_party/a2d.hsp"
#include "third_party/bitmap.as"
#include "third_party/mod_encode.hsp"
#include "third_party/mod_string.hsp"
#include "third_party/gm_crlf.hsp"
#include "third_party/alib_hash.as"

//#include "hgimg3.as"
#include "llmod3/llmod3.hsp"
#include "llmod3/msgdlg.hsp"
#include "llmod3/winver.hsp"
#include "llmod3/about.hsp"
#include "llmod3/dragdrop.hsp"
#include "mod_menu.as"
#include "hspmath.as"
#include "hspext.as"
#include "mod_regexp.as"
#include "encode.as"
//#include "vAudio.as"

#const TBNUM	(3+14+7) // ツールバーの画像数


#define selnum (selnotenum+selanalognum+selspinnum+selstpnum)
#define clipnum (clipnotenum+clipanalognum+clipspinnum+clipstpnum+cliptiltnum+clipztopnum+clipzbotnum+clipzsidenum)

#define DBGSW 0

#enum CMD_NEW = 1
#enum CMD_OPEN
#enum CMD_SAVE
#enum CMD_SAVEAS
#enum CMD_QUIT
#enum CMD_EXPORT
#enum CMD_EXPORT_RPP
#enum CMD_EDIT_UNDO
#enum CMD_EDIT_RED
#enum CMD_EDIT_CUT
#enum CMD_EDIT_COPY
#enum CMD_EDIT_PASTE
#enum CMD_EDIT_DELETE
#enum CMD_EDIT_SELALL
#enum CMD_EDIT_CLEARSEL
#enum CMD_EDIT_SELFLIP
#enum CMD_EDIT_SELRANDOMIZE
#enum CMD_EDIT_LASER_COLOR_SELFLIP
#enum CMD_EDIT_REMOVEMEASURE
#enum CMD_EDIT_COPY_TILT
#enum CMD_EDIT_DELETE_TILT
#enum CMD_EDIT_COPY_ZOOM
#enum CMD_EDIT_DELETE_ZOOM
#enum CMD_EDIT_ADDBLANK
#enum CMD_EDIT_VIEWTIME
#enum CMD_EDIT_USE_CURSOR_TIME_FOR_SAMPLE
#enum CMD_EDIT_CLEARCOMMENT
#enum CMD_EDIT_CLEAR
#enum CMD_EDIT_SONGSETTINGS
#enum CMD_EDIT_SONGSETTINGS2
#enum CMD_TOOL_POINT
#enum CMD_TOOL_PENCIL
#enum CMD_TOOL_ERASE
#enum CMD_TOOL_POS
#enum CMD_TOOL_NOTE
#enum CMD_TOOL_NOTE2
#enum CMD_TOOL_LNOTE
#enum CMD_TOOL_LNOTE2
#enum CMD_TOOL_LNOTE2_SE
#enum CMD_TOOL_ANALOGL
#enum CMD_TOOL_ANALOGR
#enum CMD_TOOL_ANALOGPFILTER
#enum CMD_TOOL_ANALOGVOL
#enum CMD_TOOL_SPIN
#enum CMD_TOOL_ROTATE
#enum CMD_TOOL_ZOOMTOP
#enum CMD_TOOL_ZOOMBOTTOM
#enum CMD_TOOL_ZOOMSIDE
#enum CMD_TOOL_STOP
#enum CMD_TOOL_4
#enum CMD_TOOL_8
#enum CMD_TOOL_12
#enum CMD_TOOL_16
#enum CMD_TOOL_24
#enum CMD_TOOL_32
#enum CMD_TOOL_48
#enum CMD_TOOL_64
#enum CMD_TOOL_96
#enum CMD_TOOL_192
#enum CMD_TOOL_DISABLEANAN
#enum CMD_TOOL_DISABLEANMIN
#enum CMD_TOOL_ANARAN2XSTARTPOS
#enum CMD_VIEW_VSEPMINIMIZE
#enum CMD_VIEW_VSEPMAXIMIZE
#enum CMD_VIEW_2X
#enum CMD_VIEW_MAXIMIZE
#enum CMD_VIEW_ZOOMX
#enum CMD_VIEW_BARPERROW_2
#enum CMD_VIEW_BARPERROW_3
#enum CMD_VIEW_BARPERROW_4
#enum CMD_VIEW_BARPERROW_5
#enum CMD_VIEW_LINEBRIGHT
#enum CMD_VIEW_TRACE
#enum CMD_VIEW_TRACE_IMPORT
#enum CMD_VIEW_TRACE_SHIFTUP
#enum CMD_VIEW_TRACE_SHIFTDOWN
#enum CMD_VIEW_TRACE_SHIFTUPD
#enum CMD_VIEW_TRACE_SHIFTDOWND
#enum CMD_PLAY_PLAY
#enum CMD_PLAY_STOP
#enum CMD_PLAY_SYNCHRO
#enum CMD_PLAY_TICK
#enum CMD_PLAY_CHOKKAKU
#enum CMD_PLAY_VOL_100
#enum CMD_PLAY_VOL_75
#enum CMD_PLAY_VOL_50
#enum CMD_PLAY_VOL_25
#enum CMD_PLAY_VOL_0
#enum CMD_PLAY_BPMHALF
#enum CMD_PLAY_FX
#enum CMD_PLAY_LASER
#enum CMD_PLAY_LOOPPLAYBACK
#enum CMD_PLAY_SAMPLE
#enum CMD_PLAY_TESTPLAY
#enum CMD_PLAY_TESTPLAY_AUTO
#enum CMD_PLAY_TESTPLAY_CURSOR
#enum CMD_PLAY_TESTPLAY_AUTO_CURSOR
#enum CMD_TOOL_ANALOGDETAIL0
#enum CMD_TOOL_ANALOGDETAIL1
#enum CMD_TOOL_ANALOGDETAIL2
#enum CMD_TOOL_DIRECTCHARTEDITING

#enum MODE_POINT = 0
#enum MODE_PENCIL
#enum MODE_ERASE

#enum TARGET_POS = 0
#enum TARGET_NOTE
#enum TARGET_NOTE2
#enum TARGET_LNOTE2
#enum TARGET_LNOTE
#enum TARGET_ANALOGL
#enum TARGET_ANALOGR
#enum TARGET_ANALOGPFILTER
#enum TARGET_ANALOGVOL
#enum TARGET_SPIN
#enum TARGET_ROTATE
#enum TARGET_ZOOMTOP
#enum TARGET_ZOOMBOTTOM
#enum TARGET_ZOOMSIDE
#enum TARGET_STOP

#define atitle "K-Shoot Editor v1.71c"
#const CURRENT_KSH_VERSION 171

// 1小節あたりのカウント値
#define UNIT_MEASURE	192

#define BUF_ST			1
#define BUF_ST15X		2
#define BUF_NOTE		3
#define BUF_LNOTE		4
#define BUF_NOTE2		41
#define BUF_LNOTE2		42
#define BUF_LNOTE2_SE	47
#define BUF_ANALOG		5
#define BUF_CHOKKAKUSAMPLES	43
#define BUF_SPIN		8
#define BUF_STOP		9
#define BUF_TRACE		11
//#define BUF_FOREGROUND	11
#define BUF_TOOLS		20
#define BUF_TARGETS		21
#define BUF_QUANTIZE	22
#define BUF_KEYINFO		23
#define BUF_ZOOMTEMP	30

#define BUF_TOOLBAR		45
#define BUF_TOOLBARTMP	46

#define SIZE_TOOLBAR_H	32

#define SIZEOF_INT 4
#define UNDO_MAX 7

#define INPUT_LARGEWIDTH 1

#define DRAW_DARKENS_NOTE ((edittarget=TARGET_ZOOMTOP)|(edittarget=TARGET_ZOOMBOTTOM)|(edittarget=TARGET_ROTATE))

#undef pos
#define pos(%1,%2) if(ginfo_sel=0){pos@hsp %1,%2+SIZE_TOOLBAR_H}else{pos@hsp %1,%2}

#undef line
#define line(%1,%2,%3,%4) if(ginfo_sel=0){line@hsp %1,%2+SIZE_TOOLBAR_H,%3,%4+SIZE_TOOLBAR_H}else{line@hsp %1,%2,%3,%4}

#undef ginfo_cy
#define ginfo_cy (ginfo(23)-SIZE_TOOLBAR_H*(ginfo_sel=0))

#undef mousey
#define mousey (mousey@hsp-SIZE_TOOLBAR_H)

#undef picload
#module
#deffunc picload str filename
	exist filename
	if(strsize=-1){
		dialog "Cannot open image \""+filename+"\""
	}
	picload@hsp filename
	return
#global

#define _sjis_(%1)		if(isutf8=1):%1=sjisenc(%1)
#define _utf8_(%1)		if(isutf8=0):%1=utf8enc(%1)

#module
#defcfunc vzoom int value
	return int(vzoomrate@*value)
#global

#define vyoko int(vyokor*(maximize*13+16)/16)
#define vyk (vyoko*14/(14+vzoomx*5)+(vzoomx=1)*(vsep=24))
#define vsp (vsep*3/(3-vzoomx)+vzoomx*((41+9*2)*2/5-2)-(vzoomx=1)*(vsep=24)*8)

#define topsep 18

#define laserdelay (max(min(t-ldelayresett,laserdelay1),0)+40)*(filtertype=0)

#define analogdetail2 (analogdetail+(ctrl_key+shift_key=2))
#define analogdetail3 (analogdetail+(analogparentran.(analogparent.stat1)=2))

dir_default=dir_cur

// 各種モジュールの初期化
initKeySoundModule dir_default
initLaserSlamSoundModule dir_default

sdim _kaigyobuf,768
sdim _kaigyobuf2,768

// 変数の初期化
dim note,131072,6
sdim notesefname,256,131072

clearKeySoundLibrary

dim analog,131072,6
dim spin,131072,6
dim tilt,131072,3
dim ztop,131072,3
dim zbot,131072,3
dim zside,131072,3
dim anaran,131072,3
dim bpml,131072,2
dim stp,131072,2
dim anagain,131072,3
dim anafil,131072,3
dim anvol,131072,3
dim anse,131072,2
dim beatl,131072,3
dim comment,512
sdim commentstr,512,1024

ud_cnt=0
ud_cur=0
ud_redomax=0
dim ud_note,131072,6,UNDO_MAX
sdim ud_notesefname,256,131072,UNDO_MAX
dim ud_analog,131072,7,UNDO_MAX
dim ud_spin,131072,6,UNDO_MAX
dim ud_tilt,131072,3,UNDO_MAX
dim ud_ztop,131072,3,UNDO_MAX
dim ud_zbot,131072,3,UNDO_MAX
dim ud_zside,131072,3,UNDO_MAX
dim ud_bpml,131072,2,UNDO_MAX
dim ud_anagain,131072,2,UNDO_MAX
dim ud_anafil,131072,2,UNDO_MAX
dim ud_anvol,131072,2,UNDO_MAX
dim ud_anse,131072,2,UNDO_MAX
dim ud_beatl,131072,3,UNDO_MAX
dim ud_stp,131072,2,UNDO_MAX
dim ud_analogparent,131072,UNDO_MAX
dim ud_analogparentran,131072,UNDO_MAX
dim ud_comment,512,UNDO_MAX
sdim ud_commentstr,512,1280,UNDO_MAX
dim ud_num,16,UNDO_MAX

dim div,131072
ddim dstat,1

sdim _headcmpstr,64

sdim bom,4
poke bom,0,0xEF
poke bom,1,0xBB
poke bom,2,0xBF
poke bom,3,0x00

sdim str_lr,1,2
str_lr.0="l"
str_lr.1="r"

randomize

acmd=-1

onwheelfl=0
movepos_wheel=0
movecnowf_wheel=0
cnowflen_wheel=0
editmode_wheel=0
edittarget_wheel=0
editdiv_wheel=0

notenum=0
dim analogparent,131072
dim analogparentran,131072
analognum=0
dim chiprate,131072,2
dim longrate,131072,2
dim laserrate,131072,2
chipratenum=0
longratenum=0
laserratenum=0

userfxnum=0
sdim userfx_name,16,256
ddim userfx_params,256,10
ddim userfx_params_enable,256,10
userfilternum=0
sdim userfilter_name,16,256
ddim userfilter_params,256,10
ddim userfilter_params_min,256,10
ddim userfilter_params_max,256,10
userchprmnum=0
ddim userchprm,4096,6
sdim swaudio,96,32
swaudionum=0
dim userfx_swaudiomid,256
fxdefbuf_fx=""
fxdefbuf_filter=""
sharpstr=""
commentnum=0

spinnum=0
divnum=0
bpmlnum=1
bpm=120000
beatlnum=1
beatl.0.0=0
beatl.0.1=4
beatl.0.2=4
tiltnum=0
ztopnum=0
zbotnum=0
zsidenum=0
anarannum=0
stpnum=0
anagainnum=1
anafilnum=1
anvolnum=1
ansenum=0
bpml.0.1=120000
anagain.0.1=50
anafil.0.1=0
anvol.0.1=50
beat=4
offset=0
editdiv=16
editmode=0
edittarget=0

disableanan=1
disableanmin=1
anaranadjpos=1
isDirectChartEditingEnabled = 0

vol=100

fname=""
isutf8=1

saveasstat=0

csongtitle=""
csongtitleimg=""
csongtitle_a=""
csongartist=""
csongartistimg=""
csongeffect=""
csongjacket=".jpg"
csongillustrator=""
csonginfo=""
csongicon=".png"
csongdifficulty=2
csonglevel=1
csongtotal=0
csongoftbpm=0
csongvol=75
csongver = "" + CURRENT_KSH_VERSION
csongver_int = CURRENT_KSH_VERSION
csongfile=".mp3"
csongv=""
csongvoffset=0
bgname="desert"
bgname_l="arrow"
poffset=0
plength=15000
laserdelay1=40
disableautoanvol=1

cnowf=0
cnowflen=0
chocnt=0

enowstat=0
inputnow=0

pstartfl=0

clickngt=d3timer()

posnow=0
dim selnote,131072
dim selanalog,131072
dim selspin,131072
dim selstp,131072
gosub *selinit

dim clipnote,131072,6
clipnotenum=0
sdim clipnotesefname,256,131072
dim clipanalog,131072,7
clipanalognum=0
dim clipspin,131072,6
clipspinnum=0
dim clipstp,131072,2
clipstpnum=0

dim clipztop,131072,3
clipztopnum=0
dim clipzbot,131072,3
clipzbotnum=0
dim clipzside,131072,3
clipzsidenum=0
dim cliptilt,131072,3
cliptiltnum=0

tate=164

disabledd=0

ignoreconfirm=0

maximize=0

vtate=3
vyokor=8
vsep=24

linebright=0

ddim vzoomrate,1
vzoomrate=1.0f
vzoomx=0
vtrace=1
vUNIT_MEASURE=192
synchro=1

pendfl=-1
playingsample=0

drawall=0
redr=1

assisttick=0
preview_fx=1
preview_laser=1
assisttick=0
enablean=1
_bpmhalf=0
loopplayback=1

reducespacing=0

bufferlength=200
updateperiod=100
peffect=1
peffect2=1
pefftype=1

anadetail1=0,0,2,2,5,5,5,7,7,10,10,10,12,12,15,15,15,17,17,20,20,20,22,22,25,25,25,28,28,30,30,30,33,33,35,35,35,37,37,40,40,40,43,43,45,45,45,48,48,50,50
anadetail1next=2,2,5,5,7,7,7,10,10,12,12,12,15,15,15,17,17,20,20,22,22,22,25,25,28,28,28,30,30,33,33,33,35,35,37,37,37,40,40,43,43,43,45,45,48,48,48,50,50,50,50
anadetail1prev=0,0,0,0,2,2,2,5,5,7,7,7,10,10,10,12,12,15,15,17,17,17,20,20,22,22,22,25,25,28,28,28,30,30,33,33,33,35,35,37,37,37,40,40,43,43,43,45,45,48,48

clang="Japanese"

globaloffset=0
soundfx_delay=0

stat1=BASS_FX_GetVersion()

sdim confstr,256,1
exist "config.ini"
if(strsize>0){
	notesel confs
	noteload "config.ini"
	split confs,"\n",confstr
	repeat notemax
		/*
		if(StartsWith(confstr.cnt, "barmax=")){
			stat1=int(strmid(confstr.cnt,7,3))
			if(stat1>0):tate=stat1
		}*/
		if(StartsWith(confstr.cnt, "currentlang=")){
			clang=strmid(confstr.cnt,12,64)
		}
		if(StartsWith(confstr.cnt, "globaloffset=")){
			globaloffset=int(strmid(confstr.cnt,13,16))
		}
		if(StartsWith(confstr.cnt, "soundfx_delay=")){
			soundfx_delay=int(strmid(confstr.cnt,14,16))
		}
		if(StartsWith(confstr.cnt, "editor_disabledd=")){
			disabledd=int(strmid(confstr.cnt,17,1))
		}
		if(StartsWith(confstr.cnt, "editor_assisttick=")){
			assisttick=int(strmid(confstr.cnt,18,1))
		}
		if(StartsWith(confstr.cnt, "editor_reducespacing=")){
			reducespacing=int(strmid(confstr.cnt,21,2))
		}
		if(StartsWith(confstr.cnt, "editor_zoomlanex=")){
			vzoomx=int(strmid(confstr.cnt,17,1))
		}
		if(StartsWith(confstr.cnt, "editor_increasewinsize=")){
			maximize=int(strmid(confstr.cnt,23,1))
		}
		if(StartsWith(confstr.cnt, "editor_measurepercolumn=")){
			vtate=int(strmid(confstr.cnt,24,1))
		}/*
		if(StartsWith(confstr.cnt, "pfiltermode=")){
			pefftype=int(strmid(confstr.cnt,12,1))
		}*/
		if(StartsWith(confstr.cnt, "editor_linebrightness=")){
			linebright=int(strmid(confstr.cnt,22,1))
		}
		if(StartsWith(confstr.cnt, "editor_loopplayback=")){
			loopplayback=int(strmid(confstr.cnt,20,1))
		}
		if(strmid(confstr.cnt,0,14)="#bufferlength:"){
			bufferlength=max(int(strmid(confstr.cnt,14,64)),6)
		}
		if(strmid(confstr.cnt,0,14)="#updateperiod:"){
			updateperiod=max(int(strmid(confstr.cnt,14,64)),5)
		}
	loop
}

laserdelay0=bufferlength-globaloffset-soundfx_delay

chdir "./lang"
dirlist langliststr,"*.txt",1
split langliststr,"\n",langlist
exist clang+".txt"
if(strsize=-1){
	clang="Japanese"
	exist clang+".txt"
	if((strsize=-1)&(length(langlist)=0)){
		dialog "Language file does not exist.",0,"Error"
		end
	}else{
		clang=langlist.0
		exist clang+".txt"
		if(strsize=-1){
			dialog "Language file does not exist.",0,"Error"
			end
		}
	}
}
sdim lang,256,11,96
langstr=""
notesel langstr
noteload clang+".txt"
conv_crlf langstr,TYPE_CRLF
repeat notemax
	noteget stat1,cnt
	split stat1,"|",langstat
	if(length(langstat)<2):continue
	if(strmid(langstat.0,0,1)="e"){
		stat2=int(strmid(langstat.0,1,2))
		stat3=int(strmid(langstat.0,4,3))
		if((stat2<11)&(stat2>=0)&(stat3<96)&(stat3>=0)){
			lang.(stat2).(stat3)=replace(langstat.1,"\\\\n","\n")
			lang.(stat2).(stat3)=replace(lang.(stat2).(stat3),"\\\\t","\t")
		}
	}
loop
chdir ".."

fxfont="MS Gothic"
if(instr(lang.0.0,0,";")!=-1){
	split lang.0.0,";",splitstat
	lang.0.0=splitstat.0
	fxfont=splitstat.1
}

exist "bassconv.dll"
if(strsize=-1):dialog lang.0.3,1,lang.0.2:end
exist "bass.dll"
if(strsize=-1):dialog lang.0.4,1,lang.0.2:end
BASS_Init -1,44100,,hwnd
if(stat!=1):dialog lang.0.5,1,lang.0.2:end

BASS_SetConfig 1,updateperiod
BASS_SetConfig 0,bufferlength

// ウィンドウ初期化
screen 0,1194,64+vtate*vUNIT_MEASURE+SIZE_TOOLBAR_H
width 660,64+vtate*vUNIT_MEASURE+SIZE_TOOLBAR_H
title atitle

// サブメニュー作成
//newmenu hfileexportmenu, 1
//addmenu hfileexportmenu, lang.1.30/*"REAPERプロジェクト(&E)...\tCtrl+Alt+R"*/, CMD_EXPORT_RPP
newmenu hfilemenu, 1
addmenu hfilemenu, lang.1.10/*"新規作成(&N)\tCtrl+N"*/, CMD_NEW
addmenu hfilemenu, lang.1.11/*"開く(&O)...\tCtrl+O"*/, CMD_OPEN
addmenu hfilemenu, "", 0, 0x0800
addmenu hfilemenu, lang.1.12/*"保存(&S)\tCtrl+S"*/, CMD_SAVE
addmenu hfilemenu, lang.1.13/*"名前を付けて保存(&A)...\tCtrl+Shift+S"*/, CMD_SAVEAS
addmenu hfilemenu, "", 0, 0x0800
newmenu hfileexportmenu, 1
addmenu hfileexportmenu, lang.1.30/*"REAPERプロジェクト書き出し(&E)...\tCtrl+Alt+R"*/, CMD_EXPORT_RPP
addmenu hfilemenu, lang.1.16/*"エクスポート(&E)"*/, hfileexportmenu, 0x10
addmenu hfilemenu, "", 0, 0x0800
//if(DBGSW=1):addmenu hfilemenu, "RAW抽出(デバッグ用)(&S)", CMD_DEBUG, 0x00 : addmenu hfilemenu, "", 0, 0x0800
addmenu hfilemenu, lang.1.20/*"終了(&C)"*/, CMD_QUIT
newmenu heditmenu, 1
addmenu heditmenu, lang.2.10/*"元に戻す(&U)\tCtrl+Z"*/, CMD_EDIT_UNDO, 0x00
addmenu heditmenu, lang.2.11/*"やり直し(&R)\tCtrl+Y"*/, CMD_EDIT_REDO, 0x00
addmenu heditmenu, "", 0, 0x0800
addmenu heditmenu, lang.2.15/*"切り取り(&T)\tCtrl+X"*/, CMD_EDIT_CUT, 0x00
addmenu heditmenu, lang.2.16/*"コピー(&C)\tCtrl+C"*/, CMD_EDIT_COPY, 0x00
addmenu heditmenu, lang.2.17/*"貼り付け(&P)\tCtrl+V"*/, CMD_EDIT_PASTE, 0x00
addmenu heditmenu, lang.2.18/*"削除(&D)\tDelete"*/, CMD_EDIT_DELETE, 0x00
addmenu heditmenu, "", 0, 0x0800
addmenu heditmenu, lang.2.30/*"すべて選択(&A)\tCtrl+A"*/, CMD_EDIT_SELALL, 0x00
addmenu heditmenu, lang.2.31/*"選択を解除(&L)\tCtrl+D"*/, CMD_EDIT_CLEARSEL, 0x00
addmenu heditmenu, "", 0, 0x0800
addmenu heditmenu, lang.2.40/*"選択ノーツを左右反転(&F)\tCtrl+R"*/, CMD_EDIT_SELFLIP, 0x00
addmenu heditmenu, lang.2.41/*"選択ノーツのレーンをランダム入替(&R)\tCtrl+Shift+R"*/, CMD_EDIT_SELRANDOMIZE, 0x0
addmenu heditmenu, lang.2.54/*"選択中のLASERオブジェクトの色を反転(&W)"*/, CMD_EDIT_LASER_COLOR_SELFLIP, 0x00
addmenu heditmenu, "", 0, 0x0800
addmenu heditmenu, lang.2.55/*"選択範囲の傾きエフェクトをコピー(&I)"*/, CMD_EDIT_COPY_TILT, 0x00
addmenu heditmenu, lang.2.56/*"選択範囲の傾きエフェクトを削除(&N)"*/, CMD_EDIT_DELETE_TILT, 0x00
addmenu heditmenu, "", 0, 0x0800
addmenu heditmenu, lang.2.42/*"選択範囲のレーンの拡大をコピー\tCtrl+Shift+C"*/, CMD_EDIT_COPY_ZOOM, 0x00
addmenu heditmenu, lang.2.43/*"選択範囲のレーンの拡大を削除\tShift+Delete"*/, CMD_EDIT_DELETE_ZOOM, 0x00
addmenu heditmenu, "", 0, 0x0800
addmenu heditmenu, lang.2.45/*"選択範囲の領域を削除(&E)..."*/, CMD_EDIT_REMOVEMEASURE, 0x00
addmenu heditmenu, lang.2.46/*"カーソル位置に空白を挿入(&B)..."*/, CMD_EDIT_ADDBLANK, 0x00
addmenu heditmenu, lang.2.47/*"カーソル位置の時間を表示(&V)..."*/, CMD_EDIT_VIEWTIME, 0x00
addmenu heditmenu, lang.2.52/*"選曲ﾌﾟﾚﾋﾞｭｰ先頭をｶｰｿﾙ位置の時間に設定(&S)"*/, CMD_EDIT_USE_CURSOR_TIME_FOR_SAMPLE, 0x00
addmenu heditmenu, "", 0, 0x0800
addmenu heditmenu, lang.2.48/*"すべての注釈をクリア(&O)"*/, CMD_EDIT_CLEARCOMMENT, 0x00
addmenu heditmenu, lang.2.49/*"譜面内容をクリア(&H)..."*/, CMD_EDIT_CLEAR, 0x00
addmenu heditmenu, "", 0, 0x0800
addmenu heditmenu, lang.2.50/*"譜面に関する設定-全般(&T)...\tCtrl+T"*/, CMD_EDIT_SONGSETTINGS, 0x00
addmenu heditmenu, lang.2.51/*"譜面に関する設定-詳細(&T)...\tCtrl+Shift+T"*/, CMD_EDIT_SONGSETTINGS2, 0x00
newmenu hviewtracemenu, 1
addmenu hviewtracemenu, lang.3.30/*"トレースを表示(&V)\tCtrl+Alt+V"*/, CMD_VIEW_TRACE, 0x08
addmenu hviewtracemenu, "", 0, 0x0800
addmenu hviewtracemenu, lang.3.31/*"トレースの読み込み(&O)...\tCtrl+Alt+O"*/, CMD_VIEW_TRACE_IMPORT
addmenu hviewtracemenu, "", 0, 0x0800
addmenu hviewtracemenu, lang.3.32/*"トレース位置を初期化(&I)"*/, CMD_VIEW_TRACE_SHIFTINIT
addmenu hviewtracemenu, lang.3.33/*"トレース位置を上へずらす(&U)"*/, CMD_VIEW_TRACE_SHIFTUP
addmenu hviewtracemenu, lang.3.34/*"トレース位置を下へずらす(&D)"*/, CMD_VIEW_TRACE_SHIFTDOWN
addmenu hviewtracemenu, lang.3.35/*"トレース位置を上へ1小節ずらす(&P)"*/, CMD_VIEW_TRACE_SHIFTUPD
addmenu hviewtracemenu, lang.3.36/*"トレース位置を下へ1小節ずらす(&W)"*/, CMD_VIEW_TRACE_SHIFTDOWND
newmenu hviewbarperrowmenu, 1
addmenu hviewbarperrowmenu, lang.3.41/*"&2小節"*/, CMD_VIEW_BARPERROW_2, 0x00
addmenu hviewbarperrowmenu, lang.3.42/*"&3小節"*/, CMD_VIEW_BARPERROW_3, 0x00
addmenu hviewbarperrowmenu, lang.3.43/*"&4小節"*/, CMD_VIEW_BARPERROW_4, 0x00
addmenu hviewbarperrowmenu, lang.3.44/*"&5小節"*/, CMD_VIEW_BARPERROW_5, 0x00
newmenu hviewmenu, 1
addmenu hviewmenu, lang.3.10/*"トレース(&T)"*/, hviewtracemenu, 0x10
addmenu hviewmenu, "", 0, 0x0800
addmenu hviewmenu, lang.3.15/*"列の間隔を小さくする(&M)"*/, CMD_VIEW_VSEPMINIMIZE, 0x00
addmenu hviewmenu, lang.3.16/*"列の間隔を大きくする(&I)"*/, CMD_VIEW_VSEPMAXIMIZE, 0x00
addmenu hviewmenu, lang.3.21/*"ノーツ間隔を2倍表示する(&X)"*/, CMD_VIEW_2X, 0x00
addmenu hviewmenu, lang.3.17/*"横幅を拡大して表示する(&Z)"*/, CMD_VIEW_ZOOMX, 0x00
addmenu hviewmenu, lang.3.18/*"ウィンドウを大きくして表示範囲を広げる(&A)"*/, CMD_VIEW_MAXIMIZE, 0x00
addmenu hviewmenu, lang.3.19/*"拍線の色を明るくする(&H)"*/, CMD_VIEW_LINEBRIGHT, 0x00
addmenu hviewmenu, lang.3.20/*"列ごとの表示小節数(&N)"*/, hviewbarperrowmenu, 0x10
newmenu htoolmenu, 1
addmenu htoolmenu, lang.4.10/*"選択ツール(&P)\tP"*/, CMD_TOOL_POINT, 0x08
addmenu htoolmenu, lang.4.11/*"鉛筆ツール(&N)\tN"*/, CMD_TOOL_PENCIL, 0x00
addmenu htoolmenu, lang.4.12/*"消しゴムツール(&A)\tE"*/, CMD_TOOL_ERASE, 0x00
addmenu htoolmenu, "", 0, 0x0800
addmenu htoolmenu, lang.4.15/*"位置(&O)\tO"*/, CMD_TOOL_POS, 0x08
addmenu htoolmenu, lang.4.18/*"チップBTオブジェクト(&B)\tH"*/, CMD_TOOL_NOTE, 0x00
addmenu htoolmenu, lang.4.19/*"ロングBTオブジェクト(&T)\tJ"*/, CMD_TOOL_NOTE2, 0x00
addmenu htoolmenu, lang.4.20/*"チップFXオブジェクト(&F)\tK"*/, CMD_TOOL_LNOTE2, 0x00
addmenu htoolmenu, lang.4.21/*"ロングFXオブジェクト(&X)\tL"*/, CMD_TOOL_LNOTE, 0x00
addmenu htoolmenu, lang.4.25/*"左(青)LASERオブジェクト(&E)\tQ"*/, CMD_TOOL_ANALOGL, 0x00
addmenu htoolmenu, lang.4.26/*"右(赤)LASERオブジェクト(&R)\tW"*/, CMD_TOOL_ANALOGR, 0x00
addmenu htoolmenu, lang.4.27/*"LASER音声エフェクトの強さ(&G)\tM"*/, CMD_TOOL_ANALOGPFILTER, 0x00
addmenu htoolmenu, lang.4.28/*"LASER直角音の音量/種類(&S)\tV"*/, CMD_TOOL_ANALOGVOL, 0x00
addmenu htoolmenu, lang.4.30/*"回転エフェクト(&I)\tS"*/, CMD_TOOL_SPIN, 0x00
addmenu htoolmenu, lang.4.34/*"傾きエフェクトの種類(&L)\tR"*/, CMD_TOOL_ROTATE, 0x00
addmenu htoolmenu, lang.4.35/*"レーンの拡大(上部)(&Z)\tZ"*/, CMD_TOOL_ZOOMTOP, 0x00
addmenu htoolmenu, lang.4.36/*"レーンの拡大(下部)(&M)\tX"*/, CMD_TOOL_ZOOMBOTTOM, 0x00
addmenu htoolmenu, lang.4.37/*"レーンの左右移動(&D)\tC"*/, CMD_TOOL_ZOOMSIDE, 0x00
addmenu htoolmenu, lang.4.38/*"譜面停止(&F)\tF"*/, CMD_TOOL_STOP, 0x00
addmenu htoolmenu, "", 0, 0x0800
addmenu htoolmenu, lang.4.40/*"4分\tCtrl+4"*/, CMD_TOOL_4, 0x00
addmenu htoolmenu, lang.4.41/*"8分\tCtrl+8"*/, CMD_TOOL_8, 0x00
addmenu htoolmenu, lang.4.42/*"12分\tCtrl+2"*/, CMD_TOOL_12, 0x00
addmenu htoolmenu, lang.4.43/*"16分\tCtrl+6"*/, CMD_TOOL_16, 0x08
addmenu htoolmenu, lang.4.44/*"24分\tCtrl+Shift+4"*/, CMD_TOOL_24, 0x00
addmenu htoolmenu, lang.4.45/*"32分\tCtrl+Shift+2"*/, CMD_TOOL_32, 0x00
addmenu htoolmenu, lang.4.46/*"48分\tCtrl+Shift+8"*/, CMD_TOOL_48, 0x00
addmenu htoolmenu, lang.4.47/*"64分\tCtrl+Shift+6"*/, CMD_TOOL_64, 0x00
addmenu htoolmenu, lang.4.48/*"96分\tCtrl+Shift+9"*/, CMD_TOOL_96, 0x00
addmenu htoolmenu, lang.4.49/*"192分\tCtrl+Shift+1"*/, CMD_TOOL_192, 0x00
addmenu htoolmenu, "", 0, 0x0800
addmenu htoolmenu, lang.4.50/*"LASERオブジェクトの配置:標準"*/, CMD_TOOL_ANALOGDETAIL0, 0x08
addmenu htoolmenu, lang.4.51/*"LASERオブジェクトの配置:詳細"*/, CMD_TOOL_ANALOGDETAIL1, 0x00
addmenu htoolmenu, lang.4.52/*"LASERオブジェクトの配置:最も詳細"*/, CMD_TOOL_ANALOGDETAIL2, 0x00
addmenu htoolmenu, "", 0, 0x0800
addmenu htoolmenu, lang.4.55/*"16分挿入時に直角LASERの連続を避ける (推奨)"*/, CMD_TOOL_DISABLEANAN, 0x08
addmenu htoolmenu, lang.4.56/*"幅の小さい直角LASERの挿入を避ける (推奨)"*/, CMD_TOOL_DISABLEANMIN, 0x08
addmenu htoolmenu, lang.4.60/*"はみ出しLASER挿入時に始点位置を通常の標準位置にする"*/, CMD_TOOL_ANARAN2XSTARTPOS, 0x08
addmenu htoolmenu, lang.4.70/*"注釈による譜面ファイルの直接編集を有効にする"*/, CMD_TOOL_DIRECTCHARTEDITING, 0x08 * isDirectChartEditingEnabled
newmenu hplayvolmenu, 1
addmenu hplayvolmenu, lang.5.30/*"100%"*/, CMD_PLAY_VOL_100, 0x08
addmenu hplayvolmenu, lang.5.31/*" 75%"*/, CMD_PLAY_VOL_75, 0x00
addmenu hplayvolmenu, lang.5.32/*" 50%"*/, CMD_PLAY_VOL_50, 0x00
addmenu hplayvolmenu, lang.5.33/*" 25%"*/, CMD_PLAY_VOL_25, 0x00
addmenu hplayvolmenu, lang.5.34/*"  0%"*/, CMD_PLAY_VOL_0, 0x00
newmenu hplaymenu, 1
addmenu hplaymenu, lang.5.10/*"再生/停止(&P)\tSpace"*/, CMD_PLAY_PLAY, 0x00
addmenu hplaymenu, "", 0, 0x0800
addmenu hplaymenu, lang.5.23/*"選択範囲をループ再生する(&R)"*/, CMD_PLAY_LOOPPLAYBACK, 0x08*loopplayback
addmenu hplaymenu, lang.5.15/*"シンクロスクロールを有効にする(&Y)"*/, CMD_PLAY_SYNCHRO, 0x08
addmenu hplaymenu, lang.5.16/*"&ASSIST TICKを有効にする"*/, CMD_PLAY_TICK, 0x00
addmenu hplaymenu, lang.5.21/*"FXｴﾌｪｸﾄを有効にする(REAPERでの書出が必要)(&F)"*/, CMD_PLAY_FX, 0x08
addmenu hplaymenu, lang.5.22/*"ﾚｰｻﾞｰｴﾌｪｸﾄを有効にする(&L)"*/, CMD_PLAY_LASER, 0x08
addmenu hplaymenu, lang.5.17/*"直角音の再生を有効にする(&C)"*/, CMD_PLAY_CHOKKAKU, 0x08
addmenu hplaymenu, lang.5.18/*"BPMを1/2倍して再生する(&H)"*/, CMD_PLAY_BPMHALF, 0x00
addmenu hplaymenu, lang.5.19/*"曲の再生ボリューム(&V)"*/, hplayvolmenu, 0x10
addmenu hplaymenu, "", 0, 0x0800
addmenu hplaymenu, lang.5.40/*"選曲画面プレビューの再生(&S)"*/, CMD_PLAY_SAMPLE, 0x00
addmenu hplaymenu, "", 0, 0x0800
addmenu hplaymenu, lang.5.50/*"テストプレイ(&T)...\tF5"*/, CMD_PLAY_TESTPLAY, 0x00
addmenu hplaymenu, lang.5.51/*"テストプレイ(オート) (&A)...\tF11"*/, CMD_PLAY_TESTPLAY_AUTO, 0x00
addmenu hplaymenu, lang.5.52/*"カーソル小節からテストプレイ(&E)...\tF6"*/, CMD_PLAY_TESTPLAY_CURSOR, 0x00
addmenu hplaymenu, lang.5.53/*"カーソル小節からテストプレイ(オート) (&U)...\tF12"*/, CMD_PLAY_TESTPLAY_AUTO_CURSOR, 0x00
// トップメニュー作成
newmenu hmenu, 0
addmenu hmenu, lang.1.0/*"ファイル(&F)"*/, hfilemenu, 0x10
addmenu hmenu, lang.2.0/*"編集(&E)"*/, heditmenu, 0x10
addmenu hmenu, lang.3.0/*"表示(&V)"*/, hviewmenu, 0x10
addmenu hmenu, lang.4.0/*"ツール(&T)"*/, htoolmenu, 0x10
addmenu hmenu, lang.5.0/*"再生(&P)"*/, hplaymenu, 0x10
applymenu hmenu

newmenu htooltargetmenu, 1
addmenu htooltargetmenu, lang.4.27/*"LASER音声エフェクトの強さ(&G)\tM"*/, CMD_TOOL_ANALOGPFILTER, 0x00
addmenu htooltargetmenu, lang.4.28/*"LASER直角音の音量/種類(&S)\tV"*/, CMD_TOOL_ANALOGVOL, 0x00
addmenu htooltargetmenu, lang.4.30/*"回転エフェクト(&I)\tS"*/, CMD_TOOL_SPIN, 0x00
addmenu htooltargetmenu, lang.4.34/*"傾きエフェクトの種類(&L)\tR"*/, CMD_TOOL_ROTATE, 0x00
addmenu htooltargetmenu, lang.4.35/*"レーンの拡大(上部)(&Z)\tZ"*/, CMD_TOOL_ZOOMTOP, 0x00
addmenu htooltargetmenu, lang.4.36/*"レーンの拡大(下部)(&M)\tX"*/, CMD_TOOL_ZOOMBOTTOM, 0x00
addmenu htooltargetmenu, lang.4.37/*"レーンの左右移動(&H)\tC"*/, CMD_TOOL_ZOOMSIDE, 0x00
addmenu htooltargetmenu, lang.4.38/*"譜面停止(&F)\tF"*/, CMD_TOOL_STOP, 0x00

; コモンコントロールライブラリの初期化
InitCommonControls

chdir "./se"
tickid=BASS_SampleLoad(0,"tick.wav",0,0,0,40,0)
tick2id=BASS_SampleLoad(0,"tick2.wav",0,0,0,30,0)

// 画像の読み込み
chdir "../imgs/editor"
buffer BUF_ST     : picload "st.gif"
buffer BUF_NOTE   : picload "note.gif"
buffer BUF_LNOTE  : picload "lnote.gif"
buffer BUF_NOTE2  : picload "note2.gif"
buffer BUF_LNOTE2 : picload "lnote2.gif"
buffer BUF_LNOTE2_SE : picload "lnote2_se.gif"
buffer BUF_ANALOG : picload "laser.gif"
buffer BUF_SPIN : picload "spin.gif"
buffer BUF_CHOKKAKUSAMPLES : picload "chokkakusamples.gif"
buffer BUF_STOP : picload "stop.gif"
buffer BUF_TOOLS : picload "tools.gif"
buffer BUF_TARGETS : picload "targets.gif"
buffer BUF_QUANTIZE : picload "quantize.gif"
buffer BUF_KEYINFO : picload lang.0.50

buffer BUF_TOOLBAR,16*TBNUM,16
pos 0,0
gcopy BUF_TOOLS,0,0,16*3,16
pos 16*3,0
gcopy BUF_TARGETS,0,0,16*14,16
buffer BUF_TOOLBARTMP : picload "toolbar.gif"
gsel BUF_TOOLBAR
pos 16*17,0
gcopy BUF_TOOLBARTMP,0,0,16*7,16
htoolbarbmp = _CreateBitmap(0, 0, 16*TBNUM,16)

// 作業領域の確保
buffer 6,(41+9*2)*2,UNIT_MEASURE*vtate*vyoko+1
buffer 7 // 一時領域
buffer BUF_ZOOMTEMP,(41+9*2)*3,UNIT_MEASURE*tate+1
buffer BUF_TRACE,41+9*2,vUNIT_MEASURE*tate+1 // かぶせるやつ
pos 0,0
color 0,0,0
boxf
gsel 0
//buffer BUF_FOREGROUND,41+9*2,UNIT_MEASURE*tate+1 // かぶせるやつ その２
//pos 0,0
//color 0,0,0
//boxf

gosub *clipinit

if(dir_cmdline!=""){
	stat1=dir_cmdline
	stat1=strtrim(stat1,0,'"')
	exist stat1
	if(strsize>=0){
		afname=stat1
		acmd=CMD_OPEN
		gosub *OnCommand
	}
}
afname=""

getkey shift_key,16
getkey ctrl_key,17
getkey esc_key,27
if((shift_key+ctrl_key=2)&(esc_key=0)){
	disabledd=min(max(1-disabledd,0),1)
}
oncmd gosub *OnCommand, WM_COMMAND ; メッセージ割り込み
oncmd gosub *OnNotify,  WM_NOTIFY
onkey gosub *OnKeshu ; キー割り込み
onclick gosub *OnClick_ ; クリック時割り込み
oncmd gosub *OnWheel, 0x20A ; マウスホイール割り込み
oncmd gosub *OnWheel_H, 0x114 ; マウスホイール(横)割り込み
oncmd gosub *alt, 0x105 ; Altキー割り込み
onexit gosub *exit ; 終了時割り込み
if(disabledd=0):oncmd gosub *dd, 0x233 ; ドラッグ&ドロップ時割り込み
if(hspstat=0):onerror *error

alloc ddbuf,1024*64	;ドラッグ&ドロップされたファイル名を入れる変数

gosub *draw

if(disabledd=0):dd_accept ddbuf,ddnum

if(assisttick=1){
	assisttick=0
	acmd=CMD_PLAY_TICK
	gosub *OnCommand
	acmd=-1
}
if(reducespacing=-1){
	acmd=CMD_VIEW_VSEPMAXIMIZE
	gosub *OnCommand
	acmd=-1
}
if(reducespacing=1){
	acmd=CMD_VIEW_VSEPMINIMIZE
	gosub *OnCommand
	acmd=-1
}
if(vzoomx=1){
	vzoomx=0
	acmd=CMD_VIEW_ZOOMX
	gosub *OnCommand
	acmd=-1
}
if(maximize=1){
	maximize=0
	acmd=CMD_VIEW_MAXIMIZE
	gosub *OnCommand
	acmd=-1
}
if(linebright=1){
	linebright=0
	acmd=CMD_VIEW_LINEBRIGHT
	gosub *OnCommand
	acmd=-1
}

; ツールバー作成
idTool=-1
gosub *createtoolbar

stop

*draw
	if(pendfl=1):pendfl=-1
	dstat=double(vUNIT_MEASURE)
	dstat/=double(UNIT_MEASURE)
	dstat*=100
	rate=int(dstat)
	buffer 6,(41+9*2)*2,vUNIT_MEASURE*vtate*vyoko+1
	pos 0,0
	color 0,0,0
	boxf
	gmode 0
	if((edittarget=TARGET_ANALOGL)|(edittarget=TARGET_ANALOGR)){
		repeat vyoko*vtate
			color 34-(edittarget=TARGET_ANALOGL)*32,14+(edittarget=TARGET_ANALOGL)*10-(edittarget=TARGET_ANALOGR)*12,34-(edittarget=TARGET_ANALOGR)*6
			if(vsep<72){
				boxf (41+9*2)/2,cnt*vUNIT_MEASURE+1,(41+9*2)/2+41+9*2,(cnt+1)*vUNIT_MEASURE+1
			}else{
				boxf 4,cnt*vUNIT_MEASURE+1,(41+9*2)*2-5,(cnt+1)*vUNIT_MEASURE+1
			}
		loop
	}
	if(edittarget=TARGET_NOTE){
		repeat vyoko*vtate
			color 30,36,12
			boxf (41+9*2)/2+9,cnt*vUNIT_MEASURE+1,(41+9*2)/2+41+9,(cnt+1)*vUNIT_MEASURE+1
		loop
	}
	if(edittarget=TARGET_NOTE2){
		repeat vyoko*vtate
			color 30,36,24
			boxf (41+9*2)/2+9,cnt*vUNIT_MEASURE+1,(41+9*2)/2+41+9,(cnt+1)*vUNIT_MEASURE+1
		loop
	}
	if(edittarget=TARGET_LNOTE){
		repeat vyoko*vtate
			color 38,30,8
			boxf (41+9*2)/2+9,cnt*vUNIT_MEASURE+1,(41+9*2)/2+41+9,(cnt+1)*vUNIT_MEASURE+1
		loop
	}
	if(edittarget=TARGET_LNOTE2){
		repeat vyoko*vtate
			color 36,32,3
			boxf (41+9*2)/2+9,cnt*vUNIT_MEASURE+1,(41+9*2)/2+41+9,(cnt+1)*vUNIT_MEASURE+1
		loop
	}
	if(edittarget=TARGET_ANALOGPFILTER){
		repeat vyoko*vtate
			color 0,24,24
			boxf (41+9*2)/2+9,cnt*vUNIT_MEASURE+1,(41+9*2)/2+41+9,(cnt+1)*vUNIT_MEASURE+1
		loop
	}
	if(edittarget=TARGET_ANALOGVOL){
		repeat vyoko*vtate
			color 24,0,6
			boxf (41+9*2)/2+9,cnt*vUNIT_MEASURE+1,(41+9*2)/2+41+9,(cnt+1)*vUNIT_MEASURE+1
		loop
	}
	if(edittarget=TARGET_SPIN){
		repeat vyoko*vtate
			color 24,0,32
			boxf (41+9*2)/2+9,cnt*vUNIT_MEASURE+1,(41+9*2)/2+41+9,(cnt+1)*vUNIT_MEASURE+1
		loop
	}
	if(edittarget=TARGET_ROTATE){
		repeat vyoko*vtate
			color 0,32,24
			boxf (41+9*2)/2+9,cnt*vUNIT_MEASURE+1,(41+9*2)/2+41+9,(cnt+1)*vUNIT_MEASURE+1
		loop
	}
	if(edittarget=TARGET_ZOOMTOP){
		repeat vyoko*vtate
			color 0,4,24
			boxf (41+9*2)/2,cnt*vUNIT_MEASURE+1,(41+9*2)/2+41+9*2,(cnt+1)*vUNIT_MEASURE+1
		loop
	}
	if(edittarget=TARGET_ZOOMBOTTOM){
		repeat vyoko*vtate
			color 24,12,0
			boxf (41+9*2)/2,cnt*vUNIT_MEASURE+1,(41+9*2)/2+41+9*2,(cnt+1)*vUNIT_MEASURE+1
		loop
	}
	if(edittarget=TARGET_ZOOMSIDE){
		repeat vyoko*vtate
			color 0,24,0
			boxf (41+9*2)/2,cnt*vUNIT_MEASURE+1,(41+9*2)/2+41+9*2,(cnt+1)*vUNIT_MEASURE+1
		loop
	}
	if(edittarget=TARGET_STOP){
		repeat vyoko*vtate
			color 36,0,0
			boxf (41+9*2)/2+9,cnt*vUNIT_MEASURE+1,(41+9*2)/2+41+9,(cnt+1)*vUNIT_MEASURE+1
		loop
	}
	cbcnt=0
	beatlfcnt=0
	beatn=4
	beatd=4
	repeat
		repeat max(beatlnum-beatlfcnt,0),beatlfcnt
			if(vzoom(beatl.cnt.0)<=cbcnt){
				beatn=beatl.cnt.1
				beatd=beatl.cnt.2
				beatlfcnt=cnt+1
			}else:break
		loop
		repeat beatn
			if(cnt=0){
				color 255,255,0
				line (41+9*2)/2+9,(vyoko*vtate)*vUNIT_MEASURE-(cbcnt-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+41+7,(vyoko*vtate)*vUNIT_MEASURE-(cbcnt-posnow*vtate*UNIT_MEASURE)*rate/100
			}else{
				color 56+40*(linebright=1),56+40*(linebright=1),56+40*(linebright=1)
				line (41+9*2)/2+8,(vyoko*vtate)*vUNIT_MEASURE-(cbcnt-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+41+8,(vyoko*vtate)*vUNIT_MEASURE-(cbcnt-posnow*vtate*UNIT_MEASURE)*rate/100
			}
			cbcnt+=vzoom(vUNIT_MEASURE/beatd)
		loop
		if(cbcnt>(vyoko*vtate)*vUNIT_MEASURE+posnow*vtate*UNIT_MEASURE*rate/100):break
	loop
	ansefcnt=0
	gmode 5,,,256
	repeat ansenum
		if(drawall=0){
			if(vzoom(anse.cnt.0)<UNIT_MEASURE*vtate*posnow):ansefcnt=cnt:continue
			if(vzoom(anse.cnt.0)>UNIT_MEASURE*vtate*(posnow+vyk)):break
		}
		pos (41+9*2)/2,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(anse.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100-6
		gcopy BUF_CHOKKAKUSAMPLES,0,6*(anse.cnt.1-1),59,6
	loop

	// グラフ描画(zoom_top/bottom)
	gmode 5,,,256
	if((edittarget=TARGET_ZOOMTOP)|(edittarget=TARGET_ZOOMBOTTOM)){
		color 240,100,80
		if(zbotnum=0){
			repeat 3
				line (41+9*2)/2+56/2+cnt,0,(41+9*2)/2+56/2+cnt,(vyoko*vtate)*vUNIT_MEASURE+posnow*vtate*UNIT_MEASURE*rate/100
			loop
		}else:if(zbotnum=1){
			if(zbot.0.1!=zbot.0.2){
				repeat 3
					line (41+9*2)/2+56/2+cnt+56/2*zbot.0.1/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zbot.0.0)-posnow*vtate*UNIT_MEASURE)*rate/100-1+cnt,(41+9*2)/2+56/2+cnt+56/2*zbot.0.2/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zbot.0.0)-posnow*vtate*UNIT_MEASURE)*rate/100-1+cnt
				loop
			}
			repeat 3
				line (41+9*2)/2+56/2+cnt+56/2*zbot.0.2/150,0,(41+9*2)/2+56/2+cnt+56/2*zbot.0.2/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zbot.0.0)-posnow*vtate*UNIT_MEASURE)*rate/100
				line (41+9*2)/2+56/2+cnt+56/2*zbot.0.1/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zbot.0.0)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+56/2+cnt+56/2*zbot.0.1/150,(vyoko*vtate)*vUNIT_MEASURE+posnow*vtate*UNIT_MEASURE*rate/100
			loop
		}else{
			repeat zbotnum
				if((zbot.cnt.0<UNIT_MEASURE*vtate*posnow)&(cnt<zbotnum-1)&(drawall=0)):continue
				cnt2=cnt
				if(zbot.cnt2.1!=zbot.cnt2.2){
					repeat 3
						line (41+9*2)/2+56/2+cnt+56/2*zbot.cnt2.1/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zbot.cnt2.0)-posnow*vtate*UNIT_MEASURE)*rate/100-1+cnt,(41+9*2)/2+56/2+cnt+56/2*zbot.cnt2.2/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zbot.cnt2.0)-posnow*vtate*UNIT_MEASURE)*rate/100-1+cnt
					loop
				}
				if(zbotnum=cnt+1){
					repeat 3
						line (41+9*2)/2+56/2+cnt+56/2*zbot.cnt2.1/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zbot.cnt2.0)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+56/2+cnt+56/2*zbot.(cnt2-1).2/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zbot.(cnt2-1).0)-posnow*vtate*UNIT_MEASURE)*rate/100
						line (41+9*2)/2+56/2+cnt+56/2*zbot.cnt2.2/150,0,(41+9*2)/2+56/2+cnt+56/2*zbot.cnt2.2/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zbot.cnt2.0)-posnow*vtate*UNIT_MEASURE)*rate/100
					loop
				}else:if(cnt>0){
					repeat 3
						line (41+9*2)/2+56/2+cnt+56/2*zbot.cnt2.1/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zbot.cnt2.0)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+56/2+cnt+56/2*zbot.(cnt2-1).2/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zbot.(cnt2-1).0)-posnow*vtate*UNIT_MEASURE)*rate/100
					loop
					if((zbot.cnt.0>UNIT_MEASURE*vtate*(posnow+vyk))&(drawall=0)):break
				}else{
					repeat 3
						line (41+9*2)/2+56/2+cnt+56/2*zbot.cnt2.1/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zbot.cnt2.0)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+56/2+cnt+56/2*zbot.cnt2.1/150,(vyoko*vtate)*vUNIT_MEASURE+posnow*vtate*UNIT_MEASURE*rate/100
					loop
					if((zbot.cnt.0>UNIT_MEASURE*vtate*(posnow+vyk))&(drawall=0)):break
				}
			loop
		}
		color 80,100,240
		if(ztopnum=0){
			repeat 3
				line (41+9*2)/2+56/2+cnt,0,(41+9*2)/2+56/2+cnt,(vyoko*vtate)*vUNIT_MEASURE+posnow*vtate*UNIT_MEASURE*rate/100
			loop
		}else:if(ztopnum=1){
			if(ztop.0.1!=ztop.0.2){
				repeat 3
					line (41+9*2)/2+56/2+cnt+56/2*ztop.0.1/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(ztop.0.0)-posnow*vtate*UNIT_MEASURE)*rate/100-1+cnt,(41+9*2)/2+56/2+cnt+56/2*ztop.0.2/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(ztop.0.0)-posnow*vtate*UNIT_MEASURE)*rate/100-1+cnt
				loop
			}
			repeat 3
				line (41+9*2)/2+56/2+cnt+56/2*ztop.0.2/150,0,(41+9*2)/2+56/2+cnt+56/2*ztop.0.2/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(ztop.0.0)-posnow*vtate*UNIT_MEASURE)*rate/100
				line (41+9*2)/2+56/2+cnt+56/2*ztop.0.1/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(ztop.0.0)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+56/2+cnt+56/2*ztop.0.1/150,(vyoko*vtate)*vUNIT_MEASURE+posnow*vtate*UNIT_MEASURE*rate/100
			loop
		}else{
			repeat ztopnum
				if((vzoom(ztop.cnt.0)<UNIT_MEASURE*vtate*posnow)&(cnt<ztopnum-1)&(drawall=0)):continue
				cnt2=cnt
				if(ztop.cnt2.1!=ztop.cnt2.2){
					repeat 3
						line (41+9*2)/2+56/2+cnt+56/2*ztop.cnt2.1/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(ztop.cnt2.0)-posnow*vtate*UNIT_MEASURE)*rate/100-1+cnt,(41+9*2)/2+56/2+cnt+56/2*ztop.cnt2.2/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(ztop.cnt2.0)-posnow*vtate*UNIT_MEASURE)*rate/100-1+cnt
					loop
				}
				if(ztopnum=cnt+1){
					repeat 3
						line (41+9*2)/2+56/2+cnt+56/2*ztop.cnt2.1/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(ztop.cnt2.0)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+56/2+cnt+56/2*ztop.(cnt2-1).2/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(ztop.(cnt2-1).0)-posnow*vtate*UNIT_MEASURE)*rate/100
						line (41+9*2)/2+56/2+cnt+56/2*ztop.cnt2.2/150,0,(41+9*2)/2+56/2+cnt+56/2*ztop.cnt2.2/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(ztop.cnt2.0)-posnow*vtate*UNIT_MEASURE)*rate/100
					loop
				}else:if(cnt>0){
					repeat 3
						line (41+9*2)/2+56/2+cnt+56/2*ztop.cnt2.1/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(ztop.cnt2.0)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+56/2+cnt+56/2*ztop.(cnt2-1).2/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(ztop.(cnt2-1).0)-posnow*vtate*UNIT_MEASURE)*rate/100
					loop
					if((ztop.cnt.0>UNIT_MEASURE*vtate*(posnow+vyk))&(drawall=0)):break
				}else{
					repeat 3
						line (41+9*2)/2+56/2+cnt+56/2*ztop.cnt2.1/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(ztop.cnt2.0)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+56/2+cnt+56/2*ztop.cnt2.1/150,(vyoko*vtate)*vUNIT_MEASURE+posnow*vtate*UNIT_MEASURE*rate/100
					loop
					if((ztop.cnt.0>UNIT_MEASURE*vtate*(posnow+vyk))&(drawall=0)):break
				}
			loop
		}
	}

	// グラフ描画(zoom_side)
	if(edittarget=TARGET_ZOOMSIDE){
		color 120,240,100
		if(zsidenum=0){
			repeat 3
				line (41+9*2)/2+56/2+cnt,0,(41+9*2)/2+56/2+cnt,(vyoko*vtate)*vUNIT_MEASURE+posnow*vtate*UNIT_MEASURE*rate/100
			loop
		}else:if(zsidenum=1){
			if(zside.0.1!=zside.0.2){
				repeat 3
					line (41+9*2)/2+56/2+cnt+56/2*zside.0.1/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zside.0.0)-posnow*vtate*UNIT_MEASURE)*rate/100-1+cnt,(41+9*2)/2+56/2+cnt+56/2*zside.0.2/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zside.0.0)-posnow*vtate*UNIT_MEASURE)*rate/100-1+cnt
				loop
			}
			repeat 3
				line (41+9*2)/2+56/2+cnt+56/2*zside.0.2/150,0,(41+9*2)/2+56/2+cnt+56/2*zside.0.2/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zside.0.0)-posnow*vtate*UNIT_MEASURE)*rate/100
				line (41+9*2)/2+56/2+cnt+56/2*zside.0.1/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zside.0.0)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+56/2+cnt+56/2*zside.0.1/150,(vyoko*vtate)*vUNIT_MEASURE+posnow*vtate*UNIT_MEASURE*rate/100
			loop
		}else{
			repeat zsidenum
				if((vzoom(zside.cnt.0)<UNIT_MEASURE*vtate*posnow)&(cnt<zsidenum-1)&(drawall=0)):continue
				cnt2=cnt
				if(zside.cnt2.1!=zside.cnt2.2){
					repeat 3
						line (41+9*2)/2+56/2+cnt+56/2*zside.cnt2.1/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zside.cnt2.0)-posnow*vtate*UNIT_MEASURE)*rate/100-1+cnt,(41+9*2)/2+56/2+cnt+56/2*zside.cnt2.2/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zside.cnt2.0)-posnow*vtate*UNIT_MEASURE)*rate/100-1+cnt
					loop
				}
				if(zsidenum=cnt+1){
					repeat 3
						line (41+9*2)/2+56/2+cnt+56/2*zside.cnt2.1/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zside.cnt2.0)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+56/2+cnt+56/2*zside.(cnt2-1).2/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zside.(cnt2-1).0)-posnow*vtate*UNIT_MEASURE)*rate/100
						line (41+9*2)/2+56/2+cnt+56/2*zside.cnt2.2/150,0,(41+9*2)/2+56/2+cnt+56/2*zside.cnt2.2/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zside.cnt2.0)-posnow*vtate*UNIT_MEASURE)*rate/100
					loop
				}else:if(cnt>0){
					repeat 3
						line (41+9*2)/2+56/2+cnt+56/2*zside.cnt2.1/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zside.cnt2.0)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+56/2+cnt+56/2*zside.(cnt2-1).2/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zside.(cnt2-1).0)-posnow*vtate*UNIT_MEASURE)*rate/100
					loop
					if((zside.cnt.0>UNIT_MEASURE*vtate*(posnow+vyk))&(drawall=0)):break
				}else{
					repeat 3
						line (41+9*2)/2+56/2+cnt+56/2*zside.cnt2.1/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zside.cnt2.0)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+56/2+cnt+56/2*zside.cnt2.1/150,(vyoko*vtate)*vUNIT_MEASURE+posnow*vtate*UNIT_MEASURE*rate/100
					loop
					if((zside.cnt.0>UNIT_MEASURE*vtate*(posnow+vyk))&(drawall=0)):break
				}
			loop
		}
	}

	gmode 5,,,256
	if(edittarget=TARGET_ROTATE){
		color 0,180,60
		repeat tiltnum
			if((tilt.cnt.0<UNIT_MEASURE*vtate*posnow)&(cnt<tiltnum-1)&(drawall=0)):continue
			cnt2=cnt
			if((tilt.cnt.1<=6)&(cnt>0)){
				val1=int(tiltname_disp(tilt.(cnt-1).2))
			}else{
				val1=int(tiltname_disp(tilt.cnt.1))
			}
			val2=int(tiltname_disp(tilt.cnt.2))
			if((tilt.cnt2.1!=tilt.cnt2.2)&(tilt.cnt2.2>6)){
				repeat 3
					line (41+9*2)/2+56/2+cnt+56/2*val1/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(tilt.cnt2.0)-posnow*vtate*UNIT_MEASURE)*rate/100-1+cnt,(41+9*2)/2+56/2+cnt+56/2*val2/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(tilt.cnt2.0)-posnow*vtate*UNIT_MEASURE)*rate/100-1+cnt
				loop
			}
			if(tiltnum=cnt+1){
				if(cnt>0){
					val2p=int(tiltname_disp(tilt.(cnt-1).2))
					if(tilt.(cnt2-1).2>6){
						repeat 3
							line (41+9*2)/2+56/2+cnt+56/2*val1/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(tilt.cnt2.0)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+56/2+cnt+56/2*val2p/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(tilt.(cnt2-1).0)-posnow*vtate*UNIT_MEASURE)*rate/100
						loop
					}
				}
				if(tilt.cnt2.2>6){
					repeat 3
						line (41+9*2)/2+56/2+cnt+56/2*val2/150,0,(41+9*2)/2+56/2+cnt+56/2*val2/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(tilt.cnt2.0)-posnow*vtate*UNIT_MEASURE)*rate/100
					loop
				}
			}else:if(cnt>0){
				val2p=int(tiltname_disp(tilt.(cnt-1).2))
				if(tilt.(cnt-1).2>6){
					repeat 3
						line (41+9*2)/2+56/2+cnt+56/2*val1/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(tilt.cnt2.0)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+56/2+cnt+56/2*val2p/150,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(tilt.(cnt2-1).0)-posnow*vtate*UNIT_MEASURE)*rate/100
					loop
				}
				if((tilt.cnt.0>UNIT_MEASURE*vtate*(posnow+vyk))&(drawall=0)):break
			}else{
				if((tilt.cnt.0>UNIT_MEASURE*vtate*(posnow+vyk))&(drawall=0)):break
			}
		loop
	}
	color 240,120,100
	font fxfont,9
	zbotfcnt=0
	repeat zbotnum
		if(drawall=0){
			if(vzoom(zbot.cnt.0)<UNIT_MEASURE*vtate*posnow):zbotfcnt=cnt:continue
			if(vzoom(zbot.cnt.0)>UNIT_MEASURE*vtate*(posnow+vyk)):break
		}
		if((cnt<0)|(cnt>=length(zbot))):continue
		stat2=0
		cnt2=cnt
		repeat ansenum-ansefcnt,ansefcnt
			if(anse.cnt.0=zbot.cnt2.0):stat2++
			if(anse.cnt.0>zbot.cnt2.0):break
		loop
		line (41+9*2)/2,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zbot.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+41+9*2+1,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zbot.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100
		pos (41+9*2)/2+3,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zbot.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100-8-stat2*9-1
		if(zbot.cnt2.1!=zbot.cnt2.2){
			mes "B:"+zbot.cnt2.1+";"+zbot.cnt2.2
		}else:mes "B:"+zbot.cnt2.1
	loop
	gmode 5,,,256
	color 100,120,240
	font fxfont,9
	ztopfcnt=0
	repeat ztopnum
		if(drawall=0){
			if(vzoom(ztop.cnt.0)<UNIT_MEASURE*vtate*posnow):ztopfcnt=cnt:continue
			if(vzoom(ztop.cnt.0)>UNIT_MEASURE*vtate*(posnow+vyk)):break
		}
		if((cnt<0)|(cnt>=length(ztop))):continue
		stat2=0
		cnt2=cnt
		repeat zbotnum-zbotfcnt,zbotfcnt
			if(zbot.cnt.0=ztop.cnt2.0):stat2++
			if(zbot.cnt.0>ztop.cnt2.0):break
		loop
		repeat ansenum-ansefcnt,ansefcnt
			if(anse.cnt.0=ztop.cnt2.0):stat2++
			if(anse.cnt.0>ztop.cnt2.0):break
		loop
		line (41+9*2)/2,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(ztop.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+41+9*2+1,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(ztop.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100
		pos (41+9*2)/2+3,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(ztop.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100-8-stat2*9-1
		if(ztop.cnt2.1!=ztop.cnt2.2){
			mes "T:"+ztop.cnt2.1+";"+ztop.cnt2.2
		}else:mes "T:"+ztop.cnt2.1
	loop
	gmode 5,,,256
	color 120,240,100
	font fxfont,9
	zsidefcnt=0
	repeat zsidenum
		if(drawall=0){
			if(vzoom(zside.cnt.0)<UNIT_MEASURE*vtate*posnow):zsidefcnt=cnt:continue
			if(vzoom(zside.cnt.0)>UNIT_MEASURE*vtate*(posnow+vyk)):break
		}
		if((cnt<0)|(cnt>=length(zside))):continue
		stat2=0
		cnt2=cnt
		repeat zbotnum-zbotfcnt,zbotfcnt
			if(zbot.cnt.0=zside.cnt2.0):stat2++
			if(zbot.cnt.0>zside.cnt2.0):break
		loop
		repeat ztopnum-ztopfcnt,ztopfcnt
			if(ztop.cnt.0=zside.cnt2.0):stat2++
			if(ztop.cnt.0>zside.cnt2.0):break
		loop
		repeat ansenum-ansefcnt,ansefcnt
			if(anse.cnt.0=zside.cnt2.0):stat2++
			if(anse.cnt.0>zside.cnt2.0):break
		loop
		line (41+9*2)/2,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zside.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+41+9*2+1,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zside.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100
		pos (41+9*2)/2+3,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(zside.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100-8-stat2*9-1
		if(zside.cnt2.1!=zside.cnt2.2){
			mes "S:"+zside.cnt2.1+";"+zside.cnt2.2
		}else:mes "S:"+zside.cnt2.1
	loop
	gmode 5,,,256
	color 0,200,80
	font fxfont,9
	tiltfcnt=0
	repeat tiltnum
		if(drawall=0){
			if(vzoom(tilt.cnt.0)<UNIT_MEASURE*vtate*posnow):tiltfcnt=cnt:continue
			if(vzoom(tilt.cnt.0)>UNIT_MEASURE*vtate*(posnow+vyk)):break
		}
		if((cnt<0)|(cnt>=length(tilt))):continue
		stat2=0
		cnt2=cnt
		repeat zbotnum-zbotfcnt,zbotfcnt
			if(zbot.cnt.0=tilt.cnt2.0):stat2++
			if(zbot.cnt.0>tilt.cnt2.0):break
		loop
		repeat ztopnum-ztopfcnt,ztopfcnt
			if(ztop.cnt.0=tilt.cnt2.0):stat2++
			if(ztop.cnt.0>tilt.cnt2.0):break
		loop
		repeat zsidenum-zsidefcnt,zsidefcnt
			if(zside.cnt.0=tilt.cnt2.0):stat2++
			if(zside.cnt.0>tilt.cnt2.0):break
		loop
		repeat ansenum-ansefcnt,ansefcnt
			if(anse.cnt.0=tilt.cnt2.0):stat2++
			if(anse.cnt.0>tilt.cnt2.0):break
		loop
		line (41+9*2)/2,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(tilt.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+41+9*2+1,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(tilt.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100
		pos (41+9*2)/2+3,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(tilt.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100-8-stat2*9-1
		stat2=tiltname_disp(tilt.cnt.1)
		if(tilt.cnt.1!=tilt.cnt.2):stat2+=";"+tiltname_disp(tilt.cnt.2)
		mes stat2
	loop
	gmode 5,,,256
	color 60,200,200
	font fxfont,9
	anafilfcnt=0
	repeat anafilnum
		if(drawall=0){
			if(vzoom(anafil.cnt.0)<UNIT_MEASURE*vtate*posnow):anafilfcnt=cnt:continue
			if(vzoom(anafil.cnt.0)>UNIT_MEASURE*vtate*(posnow+vyk)):break
		}
		cnt2=cnt
		stat2=0
		repeat tiltnum-tiltfcnt,tiltfcnt
			if(tilt.cnt.0=anafil.cnt2.0):stat2++
			if(tilt.cnt.0>anafil.cnt2.0):break
		loop
		repeat zbotnum-zbotfcnt,zbotfcnt
			if(zbot.cnt.0=anafil.cnt2.0):stat2++
			if(zbot.cnt.0>anafil.cnt2.0):break
		loop
		repeat ztopnum-ztopfcnt,ztopfcnt
			if(ztop.cnt.0=anafil.cnt2.0):stat2++
			if(ztop.cnt.0>anafil.cnt2.0):break
		loop
		repeat zsidenum-zsidefcnt,zsidefcnt
			if(zside.cnt.0=anafil.cnt2.0):stat2++
			if(zside.cnt.0>anafil.cnt2.0):break
		loop
		repeat ansenum-ansefcnt,ansefcnt
			if(anse.cnt.0=anafil.cnt2.0):stat2++
			if(anse.cnt.0>anafil.cnt2.0):break
		loop
		line (41+9*2)/2,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(anafil.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+41+9*2+1,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(anafil.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100
		pos (41+9*2)/2+3,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(anafil.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100-8-stat2*9-1
		stat2=""
		if(anafil.cnt.1=0):stat2="PEAK"
		if(anafil.cnt.1=1):stat2="HPF"
		if(anafil.cnt.1=2):stat2="HPF2"
		if(anafil.cnt.1=3):stat2="LPF"
		if(anafil.cnt.1=4):stat2="LPF2"
		if(anafil.cnt.1=5):stat2="BITC"
		if(anafil.cnt.1=6):stat2="FX(BITC)"
		if(anafil.cnt.1>=100):stat2=userfilter_name.(anafil.cnt.1-100-(userfxnum-userfilternum))
		mes stat2
	loop
	gmode 5,,,256
	color 60,200,200
	font fxfont,9
	anagainfcnt=0
	repeat anagainnum
		if(drawall=0){
			if(vzoom(anagain.cnt.0)<UNIT_MEASURE*vtate*posnow):anagainfcnt=cnt:continue
			if(vzoom(anagain.cnt.0)>UNIT_MEASURE*vtate*(posnow+vyk)):break
		}
		cnt2=cnt
		stat2=0
		repeat tiltnum-tiltfcnt,tiltfcnt
			if(tilt.cnt.0=anagain.cnt2.0):stat2++
			if(tilt.cnt.0>anagain.cnt2.0):break
		loop
		repeat zbotnum-zbotfcnt,zbotfcnt
			if(zbot.cnt.0=anagain.cnt2.0):stat2++
			if(zbot.cnt.0>anagain.cnt2.0):break
		loop
		repeat ztopnum-ztopfcnt,ztopfcnt
			if(ztop.cnt.0=anagain.cnt2.0):stat2++
			if(ztop.cnt.0>anagain.cnt2.0):break
		loop
		repeat zsidenum-zsidefcnt,zsidefcnt
			if(zside.cnt.0=anagain.cnt2.0):stat2++
			if(zside.cnt.0>anagain.cnt2.0):break
		loop
		repeat ansenum-ansefcnt,ansefcnt
			if(anse.cnt.0=anagain.cnt2.0):stat2++
			if(anse.cnt.0>anagain.cnt2.0):break
		loop
		repeat anafilnum-anafilfcnt,anafilfcnt
			if(anafil.cnt.0=anagain.cnt2.0):stat2++
			if(anafil.cnt.0>anagain.cnt2.0):break
		loop
		line (41+9*2)/2,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(anagain.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+41+9*2+1,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(anagain.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100
		pos (41+9*2)/2+3,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(anagain.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100-8-stat2*9-1
		mes str(anagain.cnt.1)
	loop
	gmode 5,,,256
	color 255,60,80
	font fxfont,9
	anvolfcnt=0
	repeat anvolnum
		if(drawall=0){
			if(vzoom(anvol.cnt.0)<UNIT_MEASURE*vtate*posnow):anvolfcnt=cnt:continue
			if(vzoom(anvol.cnt.0)>UNIT_MEASURE*vtate*(posnow+vyk)):break
		}
		cnt2=cnt
		stat2=0
		repeat tiltnum-tiltfcnt,tiltfcnt
			if(tilt.cnt.0=anvol.cnt2.0):stat2++
			if(tilt.cnt.0>anvol.cnt2.0):break
		loop
		repeat zbotnum-zbotfcnt,zbotfcnt
			if(zbot.cnt.0=anvol.cnt2.0):stat2++
			if(zbot.cnt.0>anvol.cnt2.0):break
		loop
		repeat ztopnum-ztopfcnt,ztopfcnt
			if(ztop.cnt.0=anvol.cnt2.0):stat2++
			if(ztop.cnt.0>anvol.cnt2.0):break
		loop
		repeat zsidenum-zsidefcnt,zsidefcnt
			if(zside.cnt.0=anvol.cnt2.0):stat2++
			if(zside.cnt.0>anvol.cnt2.0):break
		loop
		repeat ansenum-ansefcnt,ansefcnt
			if(anse.cnt.0=anvol.cnt2.0):stat2++
			if(anse.cnt.0>anvol.cnt2.0):break
		loop
		repeat anagainnum-anagainfcnt,anagainfcnt
			if(anagain.cnt.0=anvol.cnt2.0):stat2++
			if(anagain.cnt.0>anvol.cnt2.0):break
		loop
		repeat anafilnum-anafilfcnt,anafilfcnt
			if(anafil.cnt.0=anvol.cnt2.0):stat2++
			if(anafil.cnt.0>anvol.cnt2.0):break
		loop
		line (41+9*2)/2,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(anvol.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+41+9*2+1,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(anvol.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100
		pos (41+9*2)/2+3,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(anvol.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100-8-stat2*9-1
		mes str(anvol.cnt.1)
	loop

	// 注釈の描画
	gmode 5,,,256
	commentfcnt=0
	repeat commentnum
		if(drawall=0){
			if(vzoom(comment.cnt)<UNIT_MEASURE*vtate*posnow):commentfcnt=cnt:continue
			if(vzoom(comment.cnt)>UNIT_MEASURE*vtate*(posnow+vyk)):break
		}
		cnt2=cnt
		stat2=0
		repeat tiltnum-tiltfcnt,tiltfcnt
			if(tilt.cnt.0=comment.cnt2):stat2++
			if(tilt.cnt.0>comment.cnt2):break
		loop
		repeat zbotnum-zbotfcnt,zbotfcnt
			if(zbot.cnt.0=comment.cnt2):stat2++
			if(zbot.cnt.0>comment.cnt2):break
		loop
		repeat ztopnum-ztopfcnt,ztopfcnt
			if(ztop.cnt.0=comment.cnt2):stat2++
			if(ztop.cnt.0>comment.cnt2):break
		loop
		repeat zsidenum-zsidefcnt,zsidefcnt
			if(zside.cnt.0=comment.cnt2):stat2++
			if(zside.cnt.0>comment.cnt2):break
		loop
		repeat ansenum-ansefcnt,ansefcnt
			if(anse.cnt.0=comment.cnt2):stat2++
			if(anse.cnt.0>comment.cnt2):break
		loop
		repeat anagainnum-anagainfcnt,anagainfcnt
			if(anagain.cnt.0=comment.cnt2):stat2++
			if(anagain.cnt.0>comment.cnt2):break
		loop
		repeat anafilnum-anafilfcnt,anafilfcnt
			if(anafil.cnt.0=comment.cnt2):stat2++
			if(anafil.cnt.0>comment.cnt2):break
		loop
		repeat anvolnum-anvolfcnt,anvolfcnt
			if(anvol.cnt.0=comment.cnt2):stat2++
			if(anvol.cnt.0>comment.cnt2):break
		loop
		if (isDirectChartEditingEnabled | (strmid(commentstr.cnt,0,2)="//")) {
			if (strmid(commentstr.cnt, 0, 2) = "//") {
				color 220,180,140
			} else {
				color 180,220,140
			}
			line (41+9*2)/2,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(comment.cnt)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+41+9*2+1,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(comment.cnt)-posnow*vtate*UNIT_MEASURE)*rate/100
			if(isutf8=1){
				stat1=sjisenc(commentstr.cnt)
			}else:stat1=commentstr.cnt
			stat1 = strmid(stat1, 2 * (1 - isDirectChartEditingEnabled), 512) // 注釈による直接編集が有効の場合は注釈先頭の"//"も表示する
			CoAutoLF stat1,_kaigyobuf,13
			CoAutoLF _kaigyobuf,_kaigyobuf2,13,1
			notesel _kaigyobuf2
			pos (41+9*2)/2+3,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(comment.cnt)-posnow*vtate*UNIT_MEASURE)*rate/100-stat2*9-getstrh(hdc,_kaigyobuf2)
			mes _kaigyobuf2
		}else:if(strmid(commentstr.cnt,0,3)="fx:"){
			color 180,220,140
			line (41+9*2)/2,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(comment.cnt)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+41+9*2+1,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(comment.cnt)-posnow*vtate*UNIT_MEASURE)*rate/100
			pos (41+9*2)/2+3,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(comment.cnt)-posnow*vtate*UNIT_MEASURE)*rate/100-8-stat2*9-1-9
			mes strmid(commentstr.cnt,0,3+instr(commentstr.cnt,3,":"))
			pos (41+9*2)/2+3,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(comment.cnt)-posnow*vtate*UNIT_MEASURE)*rate/100-8-stat2*9-1
			if(strlen(commentstr.cnt)>(3+instr(commentstr.cnt,3,":"))+12){
				font fxfont,8
			}else:font fxfont,9
			if(strlen(commentstr.cnt)<=(3+instr(commentstr.cnt,3,":"))+15){
				mes strmid(commentstr.cnt,3+instr(commentstr.cnt,3,":")+1,15)
			}else{
				mes strmid(commentstr.cnt,3+instr(commentstr.cnt,3,":")+1,12)+"..."
			}
		}else:if(strmid(commentstr.cnt,0,7)="filter:"){
			color 180,220,140
			line (41+9*2)/2,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(comment.cnt)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+41+9*2+1,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(comment.cnt)-posnow*vtate*UNIT_MEASURE)*rate/100
			pos (41+9*2)/2+3,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(comment.cnt)-posnow*vtate*UNIT_MEASURE)*rate/100-8-stat2*9-1-9
			mes strmid(commentstr.cnt,0,7+instr(commentstr.cnt,7,":"))
			font fxfont,8
			pos (41+9*2)/2+3,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(comment.cnt)-posnow*vtate*UNIT_MEASURE)*rate/100-8-stat2*9-1
			if(strlen(commentstr.cnt)>(7+instr(commentstr.cnt,7,":"))+12){
				font fxfont,8
			}else:font fxfont,9
			if(strlen(commentstr.cnt)<=(7+instr(commentstr.cnt,7,":"))+15){
				mes strmid(commentstr.cnt,7+instr(commentstr.cnt,7,":")+1,15)
			}else{
				mes strmid(commentstr.cnt,7+instr(commentstr.cnt,7,":")+1,12)+"..."
			}
		}
	loop
	color 150,240,60
	font fxfont,9
	repeat beatlnum
		if(drawall=0){
			if(vzoom(beatl.cnt.0)<UNIT_MEASURE*vtate*posnow):continue
			if(vzoom(beatl.cnt.0)>UNIT_MEASURE*vtate*(posnow+vyk)):break
		}
		stat1=""+beatl.cnt.1+"/"+beatl.cnt.2
		stat2=0
		cnt2=cnt
		repeat bpmlnum
			if(bpml.cnt.0=beatl.cnt2.0):stat2=1
			if(bpml.cnt.0>beatl.cnt2.0):break
		loop
		repeat ansenum-ansefcnt,ansefcnt
			if(anse.cnt.0=beatl.cnt2.0):stat2++
			if(anse.cnt.0>beatl.cnt2.0):break
		loop
		line (41+9*2)/2,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(beatl.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+41+9*2+1,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(beatl.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100
		pos (41+9*2)/2+41+9*2-strlen(stat1)*5,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(beatl.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100-8-stat2*9-1
		mes stat1
	loop
	color 100,160,255
	font fxfont,9
	repeat bpmlnum
		if(drawall=0){
			if(vzoom(bpml.cnt.0)<UNIT_MEASURE*vtate*posnow):continue
			if(vzoom(bpml.cnt.0)>UNIT_MEASURE*vtate*(posnow+vyk)):break
		}
		stat1=str(double(bpml.cnt.1)/1000)
		stat1=strtrim(stat1,2,'0')
		stat1=strtrim(stat1,2,'.')
		stat2=0
		cnt2=cnt
		repeat ansenum-ansefcnt,ansefcnt
			if(anse.cnt.0=bpml.cnt2.0):stat2++
			if(anse.cnt.0>bpml.cnt2.0):break
		loop
		line (41+9*2)/2,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(bpml.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100,(41+9*2)/2+41+9*2+1,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(bpml.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100
		pos (41+9*2)/2+41+9*2-strlen(stat1)*5,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(bpml.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100-8-stat2*9-1
		mes stat1
	loop
	gmode 5,,,256-128*DRAW_DARKENS_NOTE
	repeat spinnum
		if(drawall=0){
			if(vzoom(spin.cnt.1)>UNIT_MEASURE*vtate*(posnow+vyk)):break
		}
		buffer 7,41,vzoom(spin.cnt.2*rate/100)
		pos 0,0
		cnt2=cnt
		stat1=0
		repeat selspinnum
			if(selspin.cnt=cnt2):stat1=1:break
		loop
		gzoom 41,vzoom(spin.cnt.2*rate/100),BUF_SPIN,spin.cnt.0*41,(stat1=1)*192,41,192
		if((spin.cnt.0=4)|(spin.cnt.0=5)){
			color 240,210,220
			font fxfont,9
			mes ""+spin.cnt.3+"/"+spin.cnt.4
			pos 0,9
			stat1=""
			if(spin.cnt.5=0):stat1="DECAY:OFF":font fxfont,8
			if(spin.cnt.5=1):stat1="DECAY:SLOW":font fxfont,8
			mes stat1
		}
		gsel 6
		pos (41+9*2)/2+9+1,(vyoko*vtate)*vUNIT_MEASURE-vzoom(spin.cnt.2*rate/100)-(vzoom(spin.cnt.1)-posnow*vtate*UNIT_MEASURE)*rate/100
		gcopy 7,0,0,41,vzoom(spin.cnt.2*rate/100)
	loop
	repeat stpnum
		if(drawall=0){
			if(vzoom(stp.cnt.0+stp.cnt.1)<UNIT_MEASURE*vtate*posnow):continue
			if(vzoom(stp.cnt.0)>UNIT_MEASURE*vtate*(posnow+vyk)):break
		}
		buffer 7,41,vzoom(stp.cnt.1*rate/100)
		pos 0,0
		cnt2=cnt
		stat1=0
		repeat selstpnum
			if(selstp.cnt=cnt2):stat1=1:break
		loop
		gzoom 41,vzoom(stp.cnt.1*rate/100),BUF_STOP,0,(stat1=1)*192,41,192
		gsel 6
		pos (41+9*2)/2+9+1,(vyoko*vtate)*vUNIT_MEASURE-vzoom(stp.cnt.1*rate/100)-(vzoom(stp.cnt.0)-posnow*vtate*UNIT_MEASURE)*rate/100
		gcopy 7,0,0,41,vzoom(stp.cnt.1*rate/100)
	loop
	notefcnt2=0
	repeat notenum
		if(drawall=0){
			if((vzoom(note.cnt.1+note.cnt.2)<UNIT_MEASURE*vtate*posnow)&(notefcnt2>=cnt-1)):notefcnt2=cnt:continue
			if(vzoom(note.cnt.1)>UNIT_MEASURE*vtate*(posnow+vyk)):break
		}
		if(note.cnt.0>3){
			if(note.cnt.2!=0){
				cnt2=cnt
				stat1=0
				repeat selnotenum
					if(selnote.cnt=cnt2):stat1=1:break
				loop
				buffer 7,19,vzoom(note.cnt.2*rate/100)
				pos 0,0
				if(note.cnt.3>=100){
					gzoom 19,vzoom(note.cnt.2*rate/100),BUF_LNOTE,0,(stat1=1)+int(userfx_params.(note.cnt.3-100).0)*2+2,19,1
				}else:gzoom 19,vzoom(note.cnt.2*rate/100),BUF_LNOTE,0,(stat1=1)+((note.cnt.3>=1)+(note.cnt.3>=6)+(note.cnt.3>=12)+(note.cnt.3>=13)*(note.cnt.3-12))*2,19,1
				color 255,255,255
				font fxfont,10
				if(note.cnt.3>=100){
					stat1=0
					stat2=userfx_name.(note.cnt.3-100)
					if((int(userfx_params.(note.cnt.3-100).0)=FXDEF_FXTYPE_RETR)|(int(userfx_params.(note.cnt.3-100).0)=FXDEF_FXTYPE_GATE)|(int(userfx_params.(note.cnt.3-100).0)=FXDEF_FXTYPE_WOBB)|(int(userfx_params.(note.cnt.3-100).0)=FXDEF_FXTYPE_ECHO)){
						if((note.cnt.4<100)|(strlen(stat2)\4!=1)){
							if((strlen(stat2)\2!=0)|(strlen(str(note.cnt.4))=1)):stat2+=" "
						}
						stat2+=""+note.cnt.4
					}
					repeat int(ceil(double(strlen(stat2))/4.0f))
						pos 0,stat1*9
						mes strmid(stat2,cnt*4,4)
						stat1++
					loop
					pos 0,stat1*9
					if(int(userfx_params.(note.cnt.3-100).0)=FXDEF_FXTYPE_PITC){
						if(note.cnt.4!=12):mes ""+note.cnt.4
					}
					if(int(userfx_params.(note.cnt.3-100).0)=FXDEF_FXTYPE_BITC){
						if(note.cnt.4!=10):mes ""+note.cnt.4
					}
					if(int(userfx_params.(note.cnt.3-100).0)=FXDEF_FXTYPE_TSTP){
						mes ""+note.cnt.4
					}
					if(int(userfx_params.(note.cnt.3-100).0)=FXDEF_FXTYPE_ECHO){
						mes ""+note.cnt.5+"%"
					}
				}
				if(note.cnt.3=1){
					if(note.cnt.4>=100){
						mes "R"+note.cnt.4
					}else:if(note.cnt.4>=10){
						mes "Re"+note.cnt.4
					}else{
						mes "Re "+note.cnt.4
					}
				}
				if(note.cnt.3=2){
					mes "Re12"
				}
				if(note.cnt.3=3){
					mes "Re16"
				}
				if(note.cnt.3=4){
					mes "Re24"
				}
				if(note.cnt.3=5){
					mes "Re32"
				}
				if(note.cnt.3=6){
					if(note.cnt.4>=100){
						mes "G"+note.cnt.4
					}else:if(note.cnt.4>=10){
						mes "Ga"+note.cnt.4
					}else{
						mes "Ga "+note.cnt.4
					}
				}
				if(note.cnt.3=7){
					mes "Ga 8"
				}
				if(note.cnt.3=8){
					mes "Ga12"
				}
				if(note.cnt.3=9){
					mes "Ga16"
				}
				if(note.cnt.3=10){
					mes "Ga24"
				}
				if(note.cnt.3=11){
					mes "Ga32"
				}
				if(note.cnt.3=12){
					mes "Flan"
				}
				if(note.cnt.3=13){
					mes "Pitc"
					pos 0,9
					if(note.cnt.4!=12):mes ""+note.cnt.4
				}
				if(note.cnt.3=14){
					mes "BitC"
					pos 0,9
					if(note.cnt.4!=10):mes ""+note.cnt.4
				}
				if(note.cnt.3=15){
					mes "Phas"
				}
				if(note.cnt.3=16){
					if(note.cnt.4>=100){
						mes "W"+note.cnt.4
					}else:if(note.cnt.4>=10){
						mes "Wo"+note.cnt.4
					}else{
						mes "Wo "+note.cnt.4
					}
				}
				if(note.cnt.3=17){
					mes "TStp"
					pos 0,9
					mes ""+note.cnt.4
				}
				if(note.cnt.3=18){
					if(note.cnt.4>=100){
						mes "E"+note.cnt.4
					}else:if(note.cnt.4>=10){
						mes "Ec"+note.cnt.4
					}else{
						mes "Ec "+note.cnt.4
					}
					pos 0,9
					mes ""+note.cnt.5+"%"
				}
				if(note.cnt.3=19){
					mes "SiCh"
				}
				gsel 6
				pos (41+9*2)/2+9+1+20*(note.cnt.0-4),(vyoko*vtate)*vUNIT_MEASURE-vzoom(note.cnt.2*rate/100)-(vzoom(note.cnt.1)-posnow*vtate*UNIT_MEASURE)
				gcopy 7,0,0,19,vzoom(note.cnt.2*rate/100)
			}
		}
	loop
	gmode 5,,,256
	repeat vtate*vyoko+1
		pos (41+9*2)/2+9,(cnt-1)*vUNIT_MEASURE+1
		gcopy BUF_ST,0,0,41,vUNIT_MEASURE
	loop
	gmode 5,,,256-128*DRAW_DARKENS_NOTE
	repeat analognum
		analog.cnt.5=1
	loop
	repeat analognum
		cnt2=cnt
		repeat max(analognum-cnt-1,0),cnt2+1
			if((analog.cnt.1=analog.cnt2.1+analog.cnt2.2)&(analog.cnt2.0=analog.cnt.0)){
				analog.cnt.5=0
			}
			if(analog.cnt.1>analog.cnt2.1+analog.cnt2.2):break
		loop
	loop
	stat1=0
	stat2=0
	//dim analogparent,analognum
	repeat analognum
		if(analog.cnt.5=1){
			if(analog.cnt.0=0):stat1=cnt
			if(analog.cnt.0=1):stat2=cnt
		}else:analogparentran.cnt=0
		if(analog.cnt.0=0):analogparent.cnt=stat1
		if(analog.cnt.0=1):analogparent.cnt=stat2
	loop/*
	stat1=0
	dim analogparentran,analognum
	repeat anarannum
		cnt2=cnt
		repeat analognum-stat1,stat1
			if((anaran.cnt2.0=analog.cnt.0)&(analog.cnt.1<anaran.cnt2.1)){
				stat1=cnt
			}
			if((anaran.cnt2.0=analog.cnt.0)&(anaran.cnt2.1=analog.cnt.1)&(analog.cnt.5=1)){
				analogparentran.cnt=2
			}
			if((analog.cnt.1>=anaran.cnt2.1)&(analog.cnt.0=anaran.cnt2.0)):break
		loop
	loop*/
	repeat analognum
		if(drawall=0){
			if(vzoom(analog.cnt.1+analog.cnt.2)<UNIT_MEASURE*vtate*posnow):continue
			if(vzoom(analog.cnt.1)>UNIT_MEASURE*vtate*(posnow+vyk)):break
		}
		cnt2=cnt
		selstat=0
		repeat selanalognum
			if(selanalog.cnt=cnt2):selstat=1:break
		loop
		if(analog.cnt.5=1){
			stat1=(analogparentran.(analogparent.cnt)=2)
			gmode 5,,,max(255-(((edittarget=TARGET_ANALOGL)|(edittarget=TARGET_ANALOGR))&(vsep<72))*140*stat1-128*DRAW_DARKENS_NOTE,0)
			pos (1-stat1)*(41+9)/2+4+stat1*((analog.cnt.3=12)|(analog.cnt.3=37))+(1+stat1)*analog.cnt.3,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1)-posnow*vtate*UNIT_MEASURE)*rate/100
			gcopy BUF_ANALOG,9*analog.cnt.0,1+6*(selstat=1)+stat1*12,9,5
			stat1__=stat1:stat1=0
			if(((edittarget=TARGET_ANALOGL)|(edittarget=TARGET_ANALOGR))&(stat1__=1)&(vsep<72)){
				gmode 5,,,255-128*DRAW_DARKENS_NOTE
				pos (1-stat1)*(41+9)/2+4+stat1*((analog.cnt.3=12)|(analog.cnt.3=37))+(1+stat1)*analog.cnt.3,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1)-posnow*vtate*UNIT_MEASURE)*rate/100
				gcopy BUF_ANALOG,9*analog.cnt.0,1+6*(selstat=1)+stat1__*12,9,5
			}
		}
		dim sx1,4
		dim sy1,4/*
		dim sx2,4
		dim sy2,4
		sx2=9*analog.cnt.0,9+9*analog.cnt.0,9+9*analog.cnt.0,9*analog.cnt.0
		sy2=6*(selstat=1),6*(selstat=1),6*(selstat=1),6*(selstat=1)
		*/
		if(analog.cnt.0=0){
			if(selstat=0):color 0,115,144
			if(selstat=1):color 74,175,161
		}else{
			if(selstat=0):color 194,6,140
			if(selstat=1):color 214,85,175
		}
		stat1=(analogparentran.(analogparent.cnt)=2)
		gmode 5,,,max(255-(((edittarget=TARGET_ANALOGL)|(edittarget=TARGET_ANALOGR))&(vsep<72))*140*stat1-128*DRAW_DARKENS_NOTE,0)
		if(analog.cnt.2<=UNIT_MEASURE/32){
			if(analog.cnt.3<=analog.cnt.4){
				sx1=(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.3=12)|(analog.cnt.3=37))+(1+stat1)*analog.cnt.3,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+9+(1+stat1)*analog.cnt.4,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+9+(1+stat1)*analog.cnt.4,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.3=12)|(analog.cnt.3=37))+(1+stat1)*analog.cnt.3
			}else{
				sx1=(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+(1+stat1)*analog.cnt.4,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.3=12)|(analog.cnt.3=37))+(1+stat1)*analog.cnt.3+9,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.3=12)|(analog.cnt.3=37))+(1+stat1)*analog.cnt.3+9,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+(1+stat1)*analog.cnt.4
			}
			if(vzoomrate>=1.0f){
				sy1=(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1)+analog.cnt.2-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1)+analog.cnt.2-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1)-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1)-posnow*vtate*UNIT_MEASURE)*rate/100
			}else{
				sy1=(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1+analog.cnt.2)-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1+analog.cnt.2)-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1)-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1)-posnow*vtate*UNIT_MEASURE)*rate/100
			}
		}else{
			sx1=(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+(1+stat1)*analog.cnt.4,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+9+(1+stat1)*analog.cnt.4,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.3=12)|(analog.cnt.3=37))+9+(1+stat1)*analog.cnt.3,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.3=12)|(analog.cnt.3=37))+(1+stat1)*analog.cnt.3
			sy1=(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1+analog.cnt.2)-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1+analog.cnt.2)-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1)-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1)-posnow*vtate*UNIT_MEASURE)*rate/100
		}
		gsquare -1/*BUF_ANALOG*/,sx1,sy1//,sx2,sy2
		if((analog.cnt.2<=UNIT_MEASURE/32)&(vzoomrate>1.0f)){
			sx1=(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+(1+stat1)*analog.cnt.4,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+9+(1+stat1)*analog.cnt.4,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+9+(1+stat1)*analog.cnt.4,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+(1+stat1)*analog.cnt.4
			sy1=(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1+analog.cnt.2)-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1+analog.cnt.2)-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1)+analog.cnt.2-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1)+analog.cnt.2-posnow*vtate*UNIT_MEASURE)*rate/100
			gsquare -1/*BUF_ANALOG*/,sx1,sy1//,sx2,sy2
		}
		stat1__=stat1:stat1=0
		if(((edittarget=TARGET_ANALOGL)|(edittarget=TARGET_ANALOGR))&(stat1__=1)&(vsep<72)){
			gmode 5,,,255-128*DRAW_DARKENS_NOTE
			if(analog.cnt.2<=UNIT_MEASURE/32){
				if(analog.cnt.3<=analog.cnt.4){
					sx1=(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.3=12)|(analog.cnt.3=37))+(1+stat1)*analog.cnt.3,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+9+(1+stat1)*analog.cnt.4,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+9+(1+stat1)*analog.cnt.4,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.3=12)|(analog.cnt.3=37))+(1+stat1)*analog.cnt.3
				}else{
					sx1=(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+(1+stat1)*analog.cnt.4,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.3=12)|(analog.cnt.3=37))+(1+stat1)*analog.cnt.3+9,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.3=12)|(analog.cnt.3=37))+(1+stat1)*analog.cnt.3+9,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+(1+stat1)*analog.cnt.4
				}
				sy1=(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1)+analog.cnt.2-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1)+analog.cnt.2-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1)-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1)-posnow*vtate*UNIT_MEASURE)*rate/100
			}else{
				sx1=(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+(1+stat1)*analog.cnt.4,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+9+(1+stat1)*analog.cnt.4,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.3=12)|(analog.cnt.3=37))+9+(1+stat1)*analog.cnt.3,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.3=12)|(analog.cnt.3=37))+(1+stat1)*analog.cnt.3
				sy1=(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1+analog.cnt.2)-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1+analog.cnt.2)-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1)-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1)-posnow*vtate*UNIT_MEASURE)*rate/100
			}
			gsquare -1/*BUF_ANALOG*/,sx1,sy1//,sx2,sy2
			if((analog.cnt.2<=UNIT_MEASURE/32)&(vzoomrate>1.0f)){
				sx1=(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+(1+stat1)*analog.cnt.4,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+9+(1+stat1)*analog.cnt.4,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+9+(1+stat1)*analog.cnt.4,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+(1+stat1)*analog.cnt.4
				sy1=(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1+analog.cnt.2)-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1+analog.cnt.2)-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1)+analog.cnt.2-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(analog.cnt.1)+analog.cnt.2-posnow*vtate*UNIT_MEASURE)*rate/100
				gsquare -1/*BUF_ANALOG*/,sx1,sy1//,sx2,sy2
			}
		}
		if((analog.cnt.2<=UNIT_MEASURE/32)&(analog.cnt.2>0)&(analog.cnt.3!=analog.cnt.4)&(vzoomrate<=1.0f)){
			stattype=analog.cnt.0
			statpos=analog.cnt.1+analog.cnt.2
			f2=1
			repeat max(analognum-(cnt+1),0),cnt+1
				if((analog.cnt.1=statpos)&(analog.cnt.0=stattype)&(analog.cnt.2>0)){
					f2=0
					break
				}
				if(analog.cnt.1>statpos):break
			loop
			if(f2=1){
				stat1=(analogparentran.(analogparent.cnt)=2)
				gmode 5,,,max(255-(((edittarget=TARGET_ANALOGL)|(edittarget=TARGET_ANALOGR))&(vsep<72))*140*stat1-128*DRAW_DARKENS_NOTE,0)
				sx1=(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+(1+stat1)*analog.cnt.4,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+9+(1+stat1)*analog.cnt.4,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+9+(1+stat1)*analog.cnt.4,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+(1+stat1)*analog.cnt.4
				sy1=(vyoko*vtate)*vUNIT_MEASURE-(vzoom(statpos)+4-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(statpos)+4-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(statpos)-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(statpos)-posnow*vtate*UNIT_MEASURE)*rate/100
				gsquare -1/*BUF_ANALOG*/,sx1,sy1//,sx2,sy2
				stat1__=stat1:stat1=0
				if(((edittarget=TARGET_ANALOGL)|(edittarget=TARGET_ANALOGR))&(stat1__=1)&(vsep<72)){
					gmode 5,,,255-128*DRAW_DARKENS_NOTE
					sx1=(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+(1+stat1)*analog.cnt.4,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+9+(1+stat1)*analog.cnt.4,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+9+(1+stat1)*analog.cnt.4,(1-stat1)*(41+9)/2+4+stat1*((analog.cnt.4=12)|(analog.cnt.4=37))+(1+stat1)*analog.cnt.4
					sy1=(vyoko*vtate)*vUNIT_MEASURE-(vzoom(statpos)+4-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(statpos)+4-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(statpos)-posnow*vtate*UNIT_MEASURE)*rate/100,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(statpos)-posnow*vtate*UNIT_MEASURE)*rate/100
					gsquare -1/*BUF_ANALOG*/,sx1,sy1//,sx2,sy2
				}
			}
		}
		f=0
		stat2=0
		stat3=-1
	loop
	repeat notenum-notefcnt2,notefcnt2
		if(drawall=0){
			if(vzoom(note.cnt.1+note.cnt.2)<UNIT_MEASURE*vtate*posnow):continue
			if(vzoom(note.cnt.1)>UNIT_MEASURE*vtate*(posnow+vyk)):break
		}
		if(note.cnt.0>3){
			if(note.cnt.2=0){
				cnt2=cnt
				stat1=0
				repeat selnotenum
					if(selnote.cnt=cnt2):stat1=1:break
				loop
				pos (41+9*2)/2+9+1+20*(note.cnt.0-4),(vyoko*vtate)*vUNIT_MEASURE-5-(vzoom(note.cnt.1)-posnow*vtate*UNIT_MEASURE)*rate/100
				stat2=BUF_LNOTE2
				if(notesefname.cnt!=""):stat2=BUF_LNOTE2_SE
				gmode 3,,,160-80*DRAW_DARKENS_NOTE
				gcopy stat2,0,5*(stat1=1),19,5
				gmode 5,,,96-48*DRAW_DARKENS_NOTE
				gcopy stat2,0,5*(stat1=1),19,5
			}
		}
	loop
	repeat notenum-notefcnt2,notefcnt2
		if(drawall=0){
			if(vzoom(note.cnt.1+note.cnt.2)<UNIT_MEASURE*vtate*posnow):continue
			if(vzoom(note.cnt.1)>UNIT_MEASURE*vtate*(posnow+vyk)):break
		}
		if(note.cnt.0<=3){
			if(note.cnt.2=0){
				gmode 0
				if(DRAW_DARKENS_NOTE):gmode 5,,,128
				cnt2=cnt
				stat1=0
				repeat selnotenum
					if(selnote.cnt=cnt2):stat1=1:break
				loop
				pos (41+9*2)/2+9+1+10*note.cnt.0,(vyoko*vtate)*vUNIT_MEASURE-3-(vzoom(note.cnt.1)-posnow*vtate*UNIT_MEASURE)*rate/100
				gcopy BUF_NOTE,0,3*(stat1=1),9,3
			}else{
				gmode 5,,,256-128*DRAW_DARKENS_NOTE
				cnt2=cnt
				stat1=0
				repeat selnotenum
					if(selnote.cnt=cnt2):stat1=1:break
				loop
				buffer 7,9,vzoom(note.cnt.2*rate/100)
				pos 0,0
				gzoom 9,vzoom(note.cnt.2*rate/100),BUF_NOTE2,0,stat1,9,1
				gsel 6
				pos (41+9*2)/2+9+1+10*note.cnt.0,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(note.cnt.1+note.cnt.2)-posnow*vtate*UNIT_MEASURE)*rate/100
				gcopy 7,0,0,9,vzoom(note.cnt.2*rate/100)
			}
		}
	loop
	if((vtrace=1)&(vzoomrate=1.0f)){
		gmode 5,,,128-72*DRAW_DARKENS_NOTE
		pos (41+9*2)/2,0
		gcopy BUF_TRACE,0,(tate-posnow*vtate-vyoko*vtate)*vUNIT_MEASURE+vtracesh,41+9*2,vyoko*vtate*vUNIT_MEASURE
	}
	color 255,64,0
	line (41+9*2)/2,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(cnowf)-posnow*vtate*UNIT_MEASURE),(41+9*2)/2+41+9*2+1,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(cnowf)-posnow*vtate*UNIT_MEASURE)
	if(cnowflen!=0){
		color 255,128,0
		gmode 3,,,48
		grect ginfo_winx/2+1,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(cnowf+cnowflen/2)-posnow*vtate*UNIT_MEASURE),0.0f,ginfo_winx/2,abs(vzoom(cnowflen))
		color 255,64,0
		line (41+9*2)/2,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(cnowf+cnowflen)-posnow*vtate*UNIT_MEASURE),(41+9*2)/2+41+9*2+1,(vyoko*vtate)*vUNIT_MEASURE-(vzoom(cnowf+cnowflen)-posnow*vtate*UNIT_MEASURE)
	}
	if(redr=1){
		gsel 0
		redraw 0
		pos 0,0
		color 0,0,0
		boxf
		gmode 5,,,256
		repeat vyk
			cnt2=cnt
			repeat vtate
				pos vsep/2+cnt2*(41+9*2+vsp)-(41+9*2)/2*(vzoomx=0)-(41+9*2)*3/4*(vzoomx=1),topsep-10+vUNIT_MEASURE*(vtate-cnt-1)
				if(vzoomx=0){
					gcopy 6,0,vUNIT_MEASURE*(vtate*vyoko-1)-vUNIT_MEASURE*(cnt2*vtate+cnt),(41+9*2)*2,vUNIT_MEASURE+(cnt=0)
				}else{
					gsel BUF_ZOOMTEMP
					pos 0,0
					gzoom (41+9*2)*3,vUNIT_MEASURE+1,6,0,vUNIT_MEASURE*(vtate*vyoko-1)-vUNIT_MEASURE*(cnt2*vtate+cnt),(41+9*2)*2,vUNIT_MEASURE+1,0
					gsel 0
					gcopy BUF_ZOOMTEMP,0,0,(41+9*2)*3,vUNIT_MEASURE+(cnt=0)
				}
			loop
		loop
		pos 20,topsep+vtate*vUNIT_MEASURE
		gcopy BUF_TOOLS,16*editmode,0,16,16
		pos 38,topsep+vtate*vUNIT_MEASURE
		gcopy BUF_TARGETS,16*edittarget,0,16,16
		stat1=8
		if(editdiv=4):stat1=0
		if(editdiv=8):stat1=1
		if(editdiv=12):stat1=2
		if(editdiv=16):stat1=3
		if(editdiv=24):stat1=4
		if(editdiv=32):stat1=5
		if(editdiv=48):stat1=6
		if(editdiv=64):stat1=7
		if(editdiv=96):stat1=8
		if(editdiv=192):stat1=9
		pos 56,topsep+vtate*vUNIT_MEASURE
		gcopy BUF_QUANTIZE,16*stat1,0,16,16
		stat1=0
		if(edittarget=TARGET_POS){
			if(editmode=MODE_POINT):stat1=0
			if(editmode=MODE_PENCIL):stat1=1
			if(editmode=MODE_ERASE):stat1=2
		}else:if(edittarget=TARGET_NOTE){
			if(editmode=MODE_POINT):stat1=3
			if(editmode=MODE_PENCIL):stat1=4
			if(editmode=MODE_ERASE):stat1=8
		}else:if(edittarget=TARGET_NOTE2){
			if(editmode=MODE_POINT):stat1=3
			if(editmode=MODE_PENCIL):stat1=4
			if(editmode=MODE_ERASE):stat1=8
		}else:if(edittarget=TARGET_LNOTE){
			if(editmode=MODE_POINT):stat1=3
			if(editmode=MODE_PENCIL):stat1=6
			if(editmode=MODE_ERASE):stat1=8
		}else:if(edittarget=TARGET_LNOTE2){
			if(editmode=MODE_POINT):stat1=3
			if(editmode=MODE_PENCIL):stat1=5
			if(editmode=MODE_ERASE):stat1=8
		}else:if(edittarget=TARGET_ANALOGL){
			if(editmode=MODE_POINT):stat1=3
			if(editmode=MODE_PENCIL):stat1=7
			if(editmode=MODE_ERASE):stat1=8
		}else:if(edittarget=TARGET_ANALOGR){
			if(editmode=MODE_POINT):stat1=3
			if(editmode=MODE_PENCIL):stat1=7
			if(editmode=MODE_ERASE):stat1=8
		}else:if(edittarget=TARGET_ANALOGPFILTER){
			if(editmode=MODE_POINT):stat1=9
			if(editmode=MODE_PENCIL):stat1=10
			if(editmode=MODE_ERASE):stat1=11
		}else:if(edittarget=TARGET_ANALOGVOL){
			if(editmode=MODE_POINT):stat1=9
			if(editmode=MODE_PENCIL):stat1=12
			if(editmode=MODE_ERASE):stat1=13
		}else:if(edittarget=TARGET_SPIN){
			if(editmode=MODE_POINT):stat1=14
			if(editmode=MODE_PENCIL):stat1=15
			if(editmode=MODE_ERASE):stat1=16
		}else:if(edittarget=TARGET_ROTATE){
			if(editmode=MODE_POINT):stat1=17
			if(editmode=MODE_PENCIL):stat1=18
			if(editmode=MODE_ERASE):stat1=19
		}else:if((edittarget=TARGET_ZOOMTOP)|(edittarget=TARGET_ZOOMBOTTOM)|(edittarget=TARGET_ZOOMSIDE)){
			if(editmode=MODE_POINT):stat1=20
			if(editmode=MODE_PENCIL):stat1=21
			if(editmode=MODE_ERASE):stat1=22
		}else:if(edittarget=TARGET_STOP){
			if(editmode=MODE_POINT):stat1=23
			if(editmode=MODE_PENCIL):stat1=24
			if(editmode=MODE_ERASE):stat1=25
		}
		gmode 0
		pos 84,12+vtate*vUNIT_MEASURE
		gcopy BUF_KEYINFO,0,27*stat1,520,27
		pos ginfo_winx-58,18+vtate*vUNIT_MEASURE
		color 255,255,255
		font lang.0.0,10
		cbcnt=0
		beatn=4
		beatd=4
		stat1=0
		beatlfcnt=0
		repeat
			repeat max(beatlnum-beatlfcnt,0),beatlfcnt
				if(beatl.cnt.0<=cbcnt){
					beatn=beatl.cnt.1
					beatd=beatl.cnt.2
					beatlfcnt=cnt+1
				}
			loop
			if(cbcnt+UNIT_MEASURE*beatn/beatd>cnowf):break
			cbcnt+=UNIT_MEASURE*beatn/beatd
			stat1++
		loop
		stat2=cnowf-cbcnt
		if(stat2\(UNIT_MEASURE/16)=0){
			stat3=""+(stat2/(UNIT_MEASURE/16)+1)+"/16"
		}else:if(stat2\(UNIT_MEASURE/24)=0){
			stat3=""+(stat2/(UNIT_MEASURE/24)+1)+"/24"
		}else:if(stat2\(UNIT_MEASURE/32)=0){
			stat3=""+(stat2/(UNIT_MEASURE/32)+1)+"/32"
		}else:if(stat2\(UNIT_MEASURE/48)=0){
			stat3=""+(stat2/(UNIT_MEASURE/48)+1)+"/48"
		}else:if(stat2\(UNIT_MEASURE/64)=0){
			stat3=""+(stat2/(UNIT_MEASURE/64)+1)+"/64"
		}else:if(stat2\(UNIT_MEASURE/96)=0){
			stat3=""+(stat2/(UNIT_MEASURE/96)+1)+"/96"
		}else:if(stat2\(UNIT_MEASURE/192)=0){
			stat3=""+(stat2/(UNIT_MEASURE/192)+1)+"/192"
		}else{
			stat3=""+(stat2+1)+"/"+UNIT_MEASURE
		}
		stat4=""
		repeat max(9-strlen(stat3),0)
			stat4+=" "
		loop
		stat6=""+(stat1+1)
		stat5=""
		repeat max(3-strlen(stat6),0)
			stat5+=" "
		loop
		stat1=""+lang.0.55+stat5+(stat1+1)+lang.0.56
		stat2=""
		repeat max(9-strlen(stat1),0)
			stat2+=" "
		loop
		mes stat2+stat1+"\n"+stat4+stat3
		stat1=0
		if(selnum>0){
			stat1=1
			if(selnum=1){
				if((selnotenum=1)&(note.(selnote.0).2>0)):stat1=4
				if(selanalognum=1):stat1=5
				if(selspinnum=1):stat1=5
				if(selstpnum=1):stat1=2
			}else{
				if(selanalognum=selnum):stat1=3
			}
		}
		gmode 5,,,256
		pos 84,12+vtate*vUNIT_MEASURE
		gcopy BUF_KEYINFO,0,27*26+stat1*27,520,27
		redraw 1
	}
	gmode 0
	return

*OnCommand
	if(acmd=-1){
		cmd=wparam&0xFFFF
		if((inputnow=1)|(enowstat!=0)):return
	}else{
		cmd=acmd
		acmd=-1
	}
	if(cmd=CMD_NEW){
		if(pendfl!=-1):pendfl=1:return
		gosub *new
		return
	}else:if(cmd=CMD_OPEN){
		gosub *confirmsave
		if(confirmstat=2){
			acmd=-1
			return
		}
		if(pendfl!=-1):pendfl=1:return
		gosub *selinit
		cnowf=0
		cnowflen=0
		caution=0
		if(afname=""){
			dialog "ksh|sm",16,lang.0.30+"|"+lang.0.31
			stat1=refstr
		}else{
			stat1=afname
		}
		exist stat1
		if((stat1="")|(strsize=-1)):acmd=-1:return

		dim note,131072,6
		sdim notesefname,256,131072

		clearKeySoundLibrary

		dim analog,131072,6
		dim spin,131072,6
		dim bpml,131072,2
		dim tilt,131072,3
		dim ztop,131072,3
		dim zbot,131072,3
		dim zside,131072,3
		dim anaran,131072,3
		dim bpml,131072,2
		dim stp,131072,2
		dim anagain,131072,3
		dim anafil,131072,3
		dim anvol,131072,3
		dim anse,131072,2
		dim beatl,131072,3
		dim comment,512
		sdim commentstr,512,1024
		dim fxparams,131072,3
		dim fx,131072,5
		dim analogparentran,131072
		dim div,131072
		notenum=0
		analognum=0
		dim chiprate,131072,2
		dim longrate,131072,2
		dim laserrate,131072,2
		chipratenum=0
		longratenum=0
		laserratenum=0
		userfxnum=0
		sdim userfx_name,16,256
		ddim userfx_params,256,10
		ddim userfx_params_enable,256,10
		userfilternum=0
		sdim userfilter_name,16,256
		ddim userfilter_params,256,10
		ddim userfilter_params_min,256,10
		ddim userfilter_params_max,256,10
		userchprmnum=0
		ddim userchprm,4096,6
		sdim swaudio,64,32
		swaudionum=0
		dim userfx_swaudiomid,256
		fxdefbuf_fx=""
		fxdefbuf_filter=""
		sharpstr=""
		commentnum=0
		spinnum=0
		bpmlnum=0
		tiltnum=0
		ztopnum=0
		zbotnum=0
		zsidenum=0
		anarannum=0
		stpnum=0
		beatlnum=0
		anagainnum=0
		anafilnum=0
		anvolnum=0
		ansenum=0
		fxparamsnum=0
		fxnum=0
		divnum=0
		bpm=120000
		offset=0
		csongtitle=""
		csongtitleimg=""
		csongtitle_a=""
		csongartist=""
		csongartistimg=""
		csongeffect=""
		csongjacket=".jpg"
		csongillustrator=""
		csonginfo=""
		csongicon=".png"
		csongv=""
		csongvoffset=0
		csongdifficulty=2
		csonglevel=1
		csongtotal=0
		csongoftbpm=0
		csongvol=100
		csongver=""
		csongver_int=100
		csongfile=".mp3"
		bgname="desert"
		bgname_l="arrow"
		poffset=0
		plength=15000
		laserdelay1=40
		disableautoanvol=0
		editdiv=16
		editmode=0
		edittarget=0
		posnow=0
		ud_cnt=0
		ud_cur=0
		ud_redomax=0
		gosub *refreshmenu_undo
		sm=0
		dim lev,32
		sdim levlabel,32,32
		dim levl,32
		levnum=0
		buf=""
		dim bpms,1
		isutf8=0
		if(getpath(stat1,18)=".sm"){
			gosub *smlabel
		}else:if((getpath(stat1,18)=".mp3")|(getpath(stat1,18)=".ogg")|(getpath(stat1,18)=".wav")){
			csongfilestat=getpath(stat1,11)
			acmd=CMD_NEW
			ignoreconfirm=1
			gosub *OnCommand
			ignoreconfirm=0
			csongfile=csongfilestat
			e=1:gosub *refreshtitle
			acmd=-1:return
		}else{
			notesel buf
			noteload stat1
			if (lpeek(buf, 0) & 0x00FFFFFF) == 0xBFBBEF{
				isutf8=1
				DeleteUTF8BOM buf
			}
			fname=stat1
			e=0:gosub *refreshtitle
		}
		notesel buf
		//buf=replace(buf,"\n","=:@")
		cnt3=-1
		sdim d,384,notemax
		repeat notemax
			noteget d.cnt,cnt
		loop
		sp=notemax
		buf=""
		repeat sp
			cnt2=cnt
			if(d.cnt="--"){
				div.divnum=0
				exc=0
				repeat
					if(cnt2+cnt+1>=length(d)){
						break
					}
					if(d.(cnt2+cnt+1)="--"){
						break
					}
					if(strmid(d.(cnt2+cnt+1),7,1)!="|"){
						div.divnum--
					}
					div.divnum++
				loop
				if(div.divnum<=0):div.divnum=1
				divnum++
			}
		loop
		pbpm=0
		if(sm=1){
			repeat stpnum
				cstp=cnt
				stat2=0
				if(bpmlnum>0){
					repeat bpmlnum-1,1
						if(bpml.cnt.0>stp.cstp.0){
							stat2=stp.cstp.1
							pbpm=cnt
						}
					loop
				}
				repeat bpmlnum
					if((bpml.cnt.0+stat2*(cnt=pbpm)<=stp.cstp.0)&(pbpm>=cnt)):stat1=bpml.cnt.1
				loop
				stp.cstp.1=stp.cstp.1*stat1*2/625/beat/100
				if(bpmlnum>0){
					repeat bpmlnum-1,1
						if(bpml.cnt.0>stp.cstp.0){
							bpml.cnt.0+=stp.cstp.1
						}
					loop
				}
			loop
		}
		dim fxfl,2
		sdim nextKeySoundStrsLR, 256, 2
		nextKeySoundStrsLR = "", ""
		cnt2a=-1
		stat4=0
		stpsh=0
		cstp=-1
		cbcnt=0
		beatn=4
		beatd=4
		repeat sp
			stat1=replace(d.cnt,"\t"," ")
			if(strmid(stat1,0,11)="#define_fx "){
				fxdefbuf_fx+=stat1+"\n"
				continue
			}
			if(strmid(stat1,0,15)="#define_filter "){
				fxdefbuf_filter+=stat1+"\n"
				continue
			}
		loop
		notesel fxdefbuf_fx
		repeat notemax
			notesel fxdefbuf_fx
			noteget stat1,cnt
			stat1=strmid(stat1,11,1024)
			stat1=strtrim(stat1,0,' ')
			if(stat1=""):continue
			//sdim fxdefstat,1
			//split stat1," ",fxdefstat
			sdim fxdefstat,,2
			fxdefstat.0=strmid(stat1,0,instr(stat1,0," "))
			fxdefstat.1=strmid(stat1,instr(stat1,0," ")+1,strlen(stat1)-instr(stat1,0," ")-1)
			if(length(fxdefstat)>=2){
				f2=1
				sdim fxdefstat2,1
				split fxdefstat.1,";",fxdefstat2
				foreach fxdefstat2
					fxdefstat2.cnt=strtrim(fxdefstat2.cnt,0,' ')
				loop
				// 一致するエフェクト名があるか調べる
				repeat FXDEF_FXTYPEMAX+1
					if(fxdef_name.0.cnt=""):continue
					if(fxdefstat2.0="type="+fxdef_name.0.cnt){
						userfx_name.userfxnum=fxdefstat.0
						userfx_params.userfxnum.0=double(cnt)
						// まずはデフォルト値を流し込む
						repeat fxdef_prmnum.cnt,1
							userfx_params.userfxnum.cnt=fxdef_default.cnt.(int(userfx_params.userfxnum.0))
							userfx_params_enable.userfxnum.cnt=fxdef_enable.cnt.(int(userfx_params.userfxnum.0))
						loop
						// 各パラメータ設定を反復処理
						repeat max(length(fxdefstat2)-1,0),1
							f=1
							sdim fxdefstat3,1
							split fxdefstat2.cnt,"=",fxdefstat3
							if(length(fxdefstat3)<=1){
								dialog "Warning: Unknown format (\""+fxdefstat2.cnt+"\")"
							}else{
								f=1
								// 一致するパラメータ名があるか調べる
								repeat fxdef_prmnum.(int(userfx_params.userfxnum.0)),1
									if(fxdefstat3.0=fxdef_name.cnt.(int(userfx_params.userfxnum.0))){
										if(fxdef_type.cnt.(int(userfx_params.userfxnum.0))=FXDEF_FILENAME){
											if(swaudionum>=31){
												dialog "Error: Too many \"Switch Audio\" Effects"
											}else{
												userfx_swaudiomid.userfxnum=swaudionum
												userfx_params.userfxnum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
											}
										}else{
											if(instr(fxdefstat3.1,0,">")=-1){
												userfx_params.userfxnum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
												userfx_params_enable.userfxnum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
											}else{
												userfx_params.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,0,">")),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
												userfx_params_enable.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,0,">")+1,256),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
											}
										}
										f=0
										break
									}
								loop
								if(f=1):dialog "Warning: Unknown paramater (\""+fxdefstat3.0+"\")"
							}
						loop
						userfxnum++
						f2=0
						break
					}
				loop
				if(f2=1):dialog "Error: Unknown effect type (\""+fxdefstat2.0+"\")"
			}
		loop
		notesel fxdefbuf_filter
		repeat notemax
			notesel fxdefbuf_filter
			noteget stat1,cnt
			stat1=strmid(stat1,15,1024)
			stat1=strtrim(stat1,0,' ')
			if(stat1=""):continue
			//sdim fxdefstat,1
			//split stat1," ",fxdefstat
			sdim fxdefstat,,2
			fxdefstat.0=strmid(stat1,0,instr(stat1,0," "))
			fxdefstat.1=strmid(stat1,instr(stat1,0," ")+1,strlen(stat1)-instr(stat1,0," ")-1)
			if(length(fxdefstat)>=2){
				f2=1
				sdim fxdefstat2,1
				split fxdefstat.1,";",fxdefstat2
				foreach fxdefstat2
					fxdefstat2.cnt=strtrim(fxdefstat2.cnt,0,' ')
				loop
				// 一致するエフェクト名があるか調べる
				repeat FXDEF_FXTYPEMAX+1
					if(fxdef_name.0.cnt=""):continue
					if(fxdefstat2.0="type="+fxdef_name.0.cnt){
						userfilter_name.userfilternum=fxdefstat.0
						userfilter_params.userfilternum.0=double(cnt)
						userfx_name.userfxnum=""
						userfx_params.userfxnum.0=double(cnt)
						// まずはデフォルト値を流し込む
						repeat fxdef_prmnum.cnt,1
							userfilter_params.userfilternum.cnt=fxdef_default.cnt.(int(userfilter_params.userfilternum.0))
							userfilter_params_min.userfilternum.cnt=fxdef_enable.cnt.(int(userfilter_params.userfilternum.0))
							userfilter_params_max.userfilternum.cnt=fxdef_enable.cnt.(int(userfilter_params.userfilternum.0))
							userfx_params.userfxnum.cnt=fxdef_default.cnt.(int(userfx_params.userfxnum.0))
							userfx_params_enable.userfxnum.cnt=fxdef_enable.cnt.(int(userfx_params.userfxnum.0))
						loop
						// 各パラメータ設定を反復処理
						repeat max(length(fxdefstat2)-1,0),1
							f=1
							sdim fxdefstat3,1
							split fxdefstat2.cnt,"=",fxdefstat3
							if(length(fxdefstat3)<=1){
								dialog "Warning: Unknown format (\""+fxdefstat2.cnt+"\")"
							}else{
								f=1
								// 一致するパラメータ名があるか調べる
								repeat fxdef_prmnum.(int(userfilter_params.userfilternum.0)),1
									if(fxdefstat3.0=fxdef_name.cnt.(int(userfilter_params.userfilternum.0))){
										if(fxdef_type.cnt.(int(userfx_params.userfxnum.0))=FXDEF_FILENAME){
											if(swaudionum>=31){
												dialog "Error: Too many \"Switch Audio\" Effects"
											}else{
												userfx_swaudiomid.userfxnum=swaudionum
												userfx_params.userfxnum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
											}
										}else{
											if(instr(fxdefstat3.1,0,">")=-1){
												if(instr(fxdefstat3.1,1,"-")=-1){
													userfilter_params.userfilternum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_min.userfilternum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_max.userfilternum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfx_params.userfxnum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
													userfx_params_enable.userfxnum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
												}else{
													userfilter_params.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,1,"-")+1),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_min.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,1,"-")+1),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_max.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,1,"-")+2,256),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfx_params.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,1,"-")+1),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
													userfx_params_enable.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,1,"-")+1),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
												}
											}else{
												if(instr(fxdefstat3.1,instr(fxdefstat3.1,0,">")+2,"-")=-1){
													userfilter_params.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,0,">")),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_min.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,0,">")+1,256),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_max.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,0,">")+1,256),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfx_params.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,0,">")),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
													userfx_params_enable.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,0,">")+1,256),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
												}else{
													userfilter_params.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,0,">")),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_min.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,0,">")+1,instr(fxdefstat3.1,instr(fxdefstat3.1,0,">")+2,"-")+1),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_max.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,instr(fxdefstat3.1,0,">")+2,"-")+instr(fxdefstat3.1,0,">")+2+1,256),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfx_params.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,0,">")),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
													userfx_params_enable.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,0,">")+1,instr(fxdefstat3.1,instr(fxdefstat3.1,0,">")+2,"-")+1),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
												}
											}
										}
										f=0
										break
									}
								loop
								if(f=1):dialog "Warning: Unknown paramater (\""+fxdefstat3.0+"\")"
							}
						loop
						userfilternum++
						userfxnum++
						f2=0
						break
					}
				loop
				if(f2=1):dialog "Error: Unknown effect type (\""+fxdefstat2.0+"\")"
			}
		loop
		repeat sp
			cnt2a++
			if(d.cnt="--"){
				cnt3++ // カレント小節数
				if(cnt3>0):cbcnt+=UNIT_MEASURE*beatn/beatd
				cnt2=-1
				continue
			}
			if(StartsWith(d.cnt, "bg=")){
				bgname=strmid(d.cnt,3,128)
				_sjis_ bgname
				continue
			}
			if(StartsWith(d.cnt, "layer=")){
				bgname_l=strmid(d.cnt,6,128)
				_sjis_ bgname_l
				continue
			}
			if(StartsWith(d.cnt, "title=")){
				csongtitle=strmid(d.cnt,6,128)
				_utf8_ csongtitle
				continue
			}
			if(StartsWith(d.cnt, "title_img=")){
				csongtitleimg=strmid(d.cnt,10,128)
				_sjis_ csongtitleimg
				continue
			}
			if(StartsWith(d.cnt, "artist=")){
				csongartist=strmid(d.cnt,7,128)
				_utf8_ csongartist
				continue
			}
			if(StartsWith(d.cnt, "artist_img=")){
				csongartistimg=strmid(d.cnt,11,128)
				_sjis_ csongartistimg
				continue
			}
			if(StartsWith(d.cnt, "effect=")){
				csongeffect=strmid(d.cnt,7,128)
				_utf8_ csongeffect
				continue
			}
			if(StartsWith(d.cnt, "jacket=")){
				csongjacket=strmid(d.cnt,7,128)
				_sjis_ csongjacket
				continue
			}
			if(StartsWith(d.cnt, "illustrator=")){
				csongillustrator=strmid(d.cnt,12,128)
				_utf8_ csongillustrator
				continue
			}
			if(StartsWith(d.cnt, "difficulty=")){
				stat2=strmid(d.cnt,11,16)
				if(stat2="light"){
					csongdifficulty=0
				}else:if(stat2="challenge"){
					csongdifficulty=1
				}else:if(stat2="extended"){
					csongdifficulty=2
				}else:csongdifficulty=3
				continue
			}
			if(StartsWith(d.cnt, "total=")){
				csongtotal=int(strmid(d.cnt,6,16))
				if(csongtotal<100):csongtotal=0
				continue
			}
			if(StartsWith(d.cnt, "ver=")){
				csongver=strmid(d.cnt,4,128)
				csongver_int=int(strmid(csongver,0,3))
				continue
			}
			if(StartsWith(d.cnt, "mvol=")){
				csongvol=max(int(strmid(d.cnt,5,3)),0)
				continue
			}
			if(StartsWith(d.cnt, "level=")){
				csonglevel=int(strmid(d.cnt,6,16))
				if(csonglevel<1):csonglevel=1
				continue
			}
			if(StartsWith(d.cnt, "chokkakuautovol=")){
				disableautoanvol=1-int(strmid(d.cnt,16,1))
				continue
			}
			if(StartsWith(d.cnt, "chiprate=")){
				if(cnt3<0){
					chiprate.chipratenum.0=cbcnt
				}else{
					chiprate.chipratenum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt
				}
				if(strmid(d.cnt,10,2)="1x"){
					chiprate.chipratenum.1=1
				}else:if(strmid(d.cnt,10,2)="2x"){
					chiprate.chipratenum.1=2
				}else:if(strmid(d.cnt,10,2)="3x"){
					chiprate.chipratenum.1=3
				}
				chipratenum++
				continue
			}
			if(StartsWith(d.cnt, "longrate=")){
				if(cnt3<0){
					longrate.laserratenum.0=cbcnt
				}else{
					longrate.laserratenum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt
				}
				if(strmid(d.cnt,9,2)="1x"){
					longrate.longratenum.1=1
				}else:if(strmid(d.cnt,9,2)="2x"){
					longrate.longratenum.1=2
				}else:if(strmid(d.cnt,9,2)="3x"){
					longrate.longratenum.1=3
				}
				longratenum++
				continue
			}
			if(StartsWith(d.cnt, "laserrate=")){
				if(cnt3<0){
					laserrate.laserratenum.0=cbcnt
				}else{
					laserrate.laserratenum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt
				}
				if(strmid(d.cnt,10,2)="1x"){
					laserrate.laserratenum.1=1
				}else:if(strmid(d.cnt,10,2)="2x"){
					laserrate.laserratenum.1=2
				}else:if(strmid(d.cnt,10,2)="3x"){
					laserrate.laserratenum.1=3
				}else{
					laserrate.laserratenum.1=1
				}
				laserratenum++
				continue
			}
			continuefl=0
			_cnt=cnt
			repeat 2
				if(headcmp(d._cnt,5,"fx-"+str_lr.cnt+"=")){
					fx.fxnum.0=cnt
					if(cnt3<0){
						fx.fxnum.1=cbcnt
					}else{
						fx.fxnum.1=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt
					}
					stat1=strmid(d._cnt,5,64)
					if(stat1=""){
						fx.fxnum.2=0
					}else{
						sdim fxsplitstat,1
						split stat1,";",fxsplitstat
						if(fxsplitstat.0=""){
							fx.fxnum.2=0
							f=0
						}else{
							f=1
							repeat userfxnum
								if(fxsplitstat.0=userfx_name.cnt){
									fx.fxnum.2=100+cnt
									if(userfx_params.cnt.0=FXDEF_FXTYPE_RETR){
										if(length(fxsplitstat)<=1){
											fx.fxnum.3=8
										}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
									}else:if(userfx_params.cnt.0=FXDEF_FXTYPE_GATE){
										if(length(fxsplitstat)<=1){
											fx.fxnum.3=4
										}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
									}else:if(userfx_params.cnt.0=FXDEF_FXTYPE_BITC){
										if(length(fxsplitstat)<=1){
											fx.fxnum.3=5
										}else:fx.fxnum.3=max(min(int(fxsplitstat.1),64),1)
									}else:if(userfx_params.cnt.0=FXDEF_FXTYPE_WOBB){
										if(length(fxsplitstat)<=1){
											fx.fxnum.3=12
										}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
									}else:if(userfx_params.cnt.0=FXDEF_FXTYPE_TSTP){
										if(length(fxsplitstat)<=1){
											fx.fxnum.3=50
										}else:fx.fxnum.3=max(min(int(fxsplitstat.1),100),1)
									}else:if(userfx_params.cnt.0=FXDEF_FXTYPE_ECHO){
										if(length(fxsplitstat)<=1){
											fx.fxnum.3=4
											fx.fxnum.4=60
										}else:if(length(fxsplitstat)<=2){
											fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
											fx.fxnum.4=60
										}else{
											fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
											fx.fxnum.4=max(min(int(fxsplitstat.2),100),0)
										}
									}else:if(userfx_params.cnt.0=FXDEF_FXTYPE_PITC){
										if(length(fxsplitstat)<=1){
											fx.fxnum.3=12
										}else:fx.fxnum.3=max(min(int(fxsplitstat.1),48),-48)
									}
									f=0
									break
								}
							loop
						}
						if(f=1){
							switch fxsplitstat.0
							case "Retrigger":
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=8
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
								if(fx.fxnum.3=12){
									fx.fxnum.2=FX_RE12
								}else:if(fx.fxnum.3=16){
									fx.fxnum.2=FX_RE16
								}else:if(fx.fxnum.3=24){
									fx.fxnum.2=FX_RE24
								}else:if(fx.fxnum.3=32){
									fx.fxnum.2=FX_RE32
								}else{
									fx.fxnum.2=FX_RE8
								}
								swbreak
							case "Gate":
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=4
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
								if(fx.fxnum.3=8){
									fx.fxnum.2=FX_GA8
								}else:if(fx.fxnum.3=12){
									fx.fxnum.2=FX_GA12
								}else:if(fx.fxnum.3=16){
									fx.fxnum.2=FX_GA16
								}else:if(fx.fxnum.3=24){
									fx.fxnum.2=FX_GA24
								}else:if(fx.fxnum.3=32){
									fx.fxnum.2=FX_GA32
								}else{
									fx.fxnum.2=FX_GA4
								}
								swbreak
							case "Flanger":
								fx.fxnum.2=FX_FLAN
								swbreak
							case "PitchShift":
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=12
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),48),-48)
								fx.fxnum.2=FX_PITC
								swbreak
							case "Phaser":
								fx.fxnum.2=FX_PHAS
								swbreak
							case "BitCrusher":
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=5
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),64),0)
								fx.fxnum.2=FX_BITC
								swbreak
							case "Wobble":
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=12
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
								fx.fxnum.2=FX_WO12
								swbreak
							case "TapeStop":
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=50
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),100),0)
								fx.fxnum.2=FX_TSTP
								swbreak
							case "Echo":
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=4
									fx.fxnum.4=60
								}else:if(length(fxsplitstat)<=2){
									fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
									fx.fxnum.4=60
								}else{
									fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
									fx.fxnum.4=max(min(int(fxsplitstat.2),100),0)
								}
								fx.fxnum.2=FX_EC4
								swbreak
							case "SideChain":
								fx.fxnum.2=FX_SICH
								swbreak
							case "":
								fx.fxnum.2=0
								swbreak
							default:
								fx.fxnum.2=0
								dialog "Error: Undefined fx (\""+fxsplitstat.0+"\")"
							swend
						}
					}
					fxfl.cnt=1
					fxnum++
					continuefl=1
				}
			loop
			if(continuefl=1):continue
			if(StartsWith(d.cnt, "fx-l_param1=")){
				fxparams.fxparamsnum.0=0
				if(cnt3<0){
					fxparams.fxparamsnum.1=cbcnt
				}else{
					fxparams.fxparamsnum.1=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt
				}
				fxparams.fxparamsnum.2=int(strmid(d.cnt,12,8))
				fxparamsnum++
				continue
			}
			if(StartsWith(d.cnt, "fx-r_param1=")){
				fxparams.fxparamsnum.0=1
				if(cnt3<0){
					fxparams.fxparamsnum.1=cbcnt
				}else{
					fxparams.fxparamsnum.1=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt
				}
				fxparams.fxparamsnum.2=int(strmid(d.cnt,12,8))
				fxparamsnum++
				continue
			}
			if(StartsWith(d.cnt, "fx-l_se=")|StartsWith(d.cnt, "fx-r_se=")){
				_stat1=strmid(d.cnt,8,256)
				sdim splitstat,1
				split _stat1,";",splitstat
				_stat1 = splitstat.0
				if(length(splitstat)=1){
					_stat3=100
				}else{
					_stat3=min(max(int(splitstat.1),0),100)
				}
				loadKeySoundToLibrary _stat1, getpath(fname, 32), csongver_int
				if (StartsWith(d.cnt, "fx-l_se=")) {
					nextKeySoundStrsLR.0 = _stat1
					if (_stat3 != 100) : nextKeySoundStrsLR.0 += ";" + _stat3
				}
				if (StartsWith(d.cnt, "fx-r_se=")) {
					nextKeySoundStrsLR.1 = _stat1
					if (_stat3 != 100) : nextKeySoundStrsLR.1 += ";" + _stat3
				}
				continue
			}
			if((StartsWith(d.cnt, "fx:")&(instr(d.cnt,3,"="))!=-1)){
				if(cnt3<0){
					comment.commentnum=cbcnt
				}else{
					comment.commentnum=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt
				}
				commentstr.commentnum=d.cnt
				commentnum++
				if(cnt3<0){
					userchprm.userchprmnum.0=double(cbcnt)
				}else{
					userchprm.userchprmnum.0=double((cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt)
				}
				sdim fxsplit_stat,1
				_stat1=strmid(d.cnt,3,instr(d.cnt,3,"="))
				_stat4=strmid(d.cnt,4+instr(d.cnt,3,"="),256)
				if(instr(_stat1,0,":")!=-1){
					_stat2=strmid(_stat1,0,instr(_stat1,0,":"))
					_stat3=0
					f=1
					repeat userfxnum-userfilternum
						// 一致するユーザー定義FXを探索
						if(_stat2=userfx_name.cnt){
							userchprm.userchprmnum.1=double(cnt)
							_stat3=int(userfx_params.cnt.0)
							f=0
							break
						}
					loop
					if(f=1){
						dialog "Error: Undefined fx (\""+_stat2+"\")"
					}else:if(_stat3=FXDEF_FXTYPE_AUDI){
						dialog "Error: \"SwitchAudio\" value cannot be changed"
					}else{
						f=1
						_stat1=strmid(_stat1,instr(_stat1,0,":")+1,256)
						// 一致するパラメータ名があるか調べる
						repeat fxdef_prmnum._stat3,1
							if(_stat1=fxdef_name.cnt._stat3){
								userchprm.userchprmnum.2=double(cnt)
								if(instr(_stat4,0,">")=-1){
									userchprm.userchprmnum.3=fxdef_str2param(_stat4,fxdef_type.cnt._stat3)
									userchprm.userchprmnum.4=fxdef_str2param(_stat4,fxdef_type.cnt._stat3)
								}else{
									userchprm.userchprmnum.3=fxdef_str2param(strmid(_stat4,0,instr(_stat4,0,">")),fxdef_type.cnt._stat3)
									userchprm.userchprmnum.4=fxdef_str2param(strmid(_stat4,instr(_stat4,0,">")+1,256),fxdef_type.cnt._stat3)
								}
								userchprmnum++
								f=0
								break
							}
						loop
						if(f=1):dialog "Error: Unknown paramater (\""+_stat1+"\")"
					}
				}
				continue
			}
			if((StartsWith(d.cnt, "filter:")&(instr(d.cnt,7,"="))!=-1)){
				if(cnt3<0){
					comment.commentnum=cbcnt
				}else{
					comment.commentnum=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt
				}
				commentstr.commentnum=d.cnt
				commentnum++
				if(cnt3<0){
					userchprm.userchprmnum.0=double(cbcnt)
				}else{
					userchprm.userchprmnum.0=double((cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt)
				}
				_stat1=strmid(d.cnt,7,instr(d.cnt,7,"="))
				_stat4=strmid(d.cnt,8+instr(d.cnt,7,"="),256)
				if(instr(_stat1,0,":")!=-1){
					_stat2=strmid(_stat1,0,instr(_stat1,0,":"))
					_stat3=0
					f=1
					repeat userfilternum
						// 一致するユーザー定義FXを探索
						if(_stat2=userfilter_name.cnt){
							userchprm.userchprmnum.1=double(cnt+userfxnum-userfilternum)
							_stat3=int(userfx_params.(cnt+userfxnum-userfilternum).0)
							f=0
							break
						}
					loop
					if(f=1){
						dialog "Error: Undefined filter (\""+_stat2+"\")"
					}else:if(_stat3=FXDEF_FXTYPE_AUDI){
						dialog "Error: \"SwitchAudio\" value cannot be changed"
					}else{
						f=1
						_stat1=strmid(_stat1,instr(_stat1,0,":")+1,256)
						// 一致するパラメータ名があるか調べる
						repeat fxdef_prmnum._stat3,1
							if(_stat1=fxdef_name.cnt._stat3){
								userchprm.userchprmnum.2=double(cnt)
								if(instr(_stat4,0,">")=-1){
									if(instr(_stat4,1,"-")=-1){
										userchprm.userchprmnum.3=fxdef_str2param(_stat4,fxdef_type.cnt._stat3)
										userchprm.userchprmnum.4=fxdef_str2param(_stat4,fxdef_type.cnt._stat3)
										userchprm.userchprmnum.5=fxdef_str2param(_stat4,fxdef_type.cnt._stat3)
									}else{
										userchprm.userchprmnum.3=fxdef_str2param(strmid(_stat4,0,instr(_stat4,1,"-")+1),fxdef_type.cnt.(_stat3))
										userchprm.userchprmnum.4=fxdef_str2param(strmid(_stat4,0,instr(_stat4,1,"-")+1),fxdef_type.cnt.(_stat3))
										userchprm.userchprmnum.5=fxdef_str2param(strmid(_stat4,instr(_stat4,1,"-")+2,256),fxdef_type.cnt.(_stat3))
									}
								}else{
									if(instr(_stat4,instr(_stat4,0,">")+2,"-")=-1){
										userchprm.userchprmnum.3=fxdef_str2param(strmid(_stat4,0,instr(_stat4,0,">")),fxdef_type.cnt.(_stat3))
										userchprm.userchprmnum.4=fxdef_str2param(strmid(_stat4,instr(_stat4,0,">")+1,256),fxdef_type.cnt.(_stat3))
										userchprm.userchprmnum.5=fxdef_str2param(strmid(_stat4,instr(_stat4,0,">")+1,256),fxdef_type.cnt.(_stat3))
									}else{
										userchprm.userchprmnum.3=fxdef_str2param(strmid(_stat4,0,instr(_stat4,0,">")),fxdef_type.cnt.(_stat3))
										userchprm.userchprmnum.4=fxdef_str2param(strmid(_stat4,instr(_stat4,0,">")+1,instr(_stat4,instr(_stat4,0,">")+2,"-")+1),fxdef_type.cnt.(_stat3))
										userchprm.userchprmnum.5=fxdef_str2param(strmid(_stat4,instr(_stat4,instr(_stat4,0,">")+2,"-")+instr(_stat4,0,">")+2+1,256),fxdef_type.cnt.(_stat3))
									}
								}
								userchprmnum++
								f=0
								break
							}
						loop
						if(f=1):dialog "Error: Unknown paramater (\""+_stat1+"\")"
					}
				}
				continue
			}
			if(StartsWith(d.cnt, "t=")){
				if((sm=0)&(int(double(strmid(d.cnt,2,64))*1000)>0)&(strmid(d.cnt,2,64)=replace(strmid(d.cnt,2,64),"-",""))){
					bpm=int(double(strmid(d.cnt,2,64))*1000)
					if(cnt3<0){
						bpml.bpmlnum.0=cbcnt
					}else{
						bpml.bpmlnum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt
					}
					if(bpml.bpmlnum.0<0):bpml.bpmlnum.0=0
					bpml.bpmlnum.1=min(bpm,65535000)
					bpmlnum++
				}
				continue
			}
			if(StartsWith(d.cnt, "to=")){
				csongoftbpm=int(double(strmid(d.cnt,3,16))*1000)
				if(csongoftbpm<1):csongoftbpm=0
				if(csongoftbpm>65535000):csongoftbpm=0
				continue
			}
			if(StartsWith(d.cnt, "beat=")){
				sdim beatstat,16,2
				stat1=strmid(d.cnt,5,33)
				split stat1,"/",beatstat
				if(length(beatstat)=2){
					if(cnt3<0){
						beatl.beatlnum.0=cbcnt+stpsh
					}else{
						beatl.beatlnum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt+stpsh
					}
					beatl.beatlnum.1=int(beatstat.0)
					beatl.beatlnum.2=int(beatstat.1)
					if((beatl.beatlnum.1>0)&(beatl.beatlnum.2>0)){
						beatlnum++
						beatn=int(beatstat.0)
						beatd=int(beatstat.1)
					}
				}
				continue
			}
			if(StartsWith(d.cnt, "stop=")){
				if(cnt3<0){
					stp.stpnum.0=cbcnt+stpsh
				}else{
					stp.stpnum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt+stpsh
				}
				if(stp.stpnum.0>=0){
					stp.stpnum.1=int(strmid(d.cnt,5,16))
					//stpsh+=stp.stpnum.1
					if(stpnum<=0){
						stpnum++
					}else:if(stp.(stpnum-1).0+stp.(stpnum-1).1<=stp.stpnum.0){
						stpnum++
					}
				}
				continue
			}
			if(StartsWith(d.cnt, "filtertype=")){
				if(cnt3<0){
					anafil.anafilnum.0=int(cbcnt)
				}else{
					anafil.anafilnum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+int(cbcnt)
				}
				f=1
				_cnt=cnt
				repeat userfilternum,userfxnum-userfilternum
					if(strmid(d._cnt,11,256)=userfilter_name.(cnt-(userfxnum-userfilternum))){
						anafil.anafilnum.1=100+cnt
						f=0
						break
					}
				loop
				if(f=1){
					if(strmid(d.cnt,11,4)="hpf1"){
						anafil.anafilnum.1=1
					}else:if(strmid(d.cnt,11,4)="hpf2"){
						anafil.anafilnum.1=2
					}else:if(strmid(d.cnt,11,4)="lpf1"){
						anafil.anafilnum.1=3
					}else:if(strmid(d.cnt,11,4)="lpf2"){
						anafil.anafilnum.1=4
					}else:if(strmid(d.cnt,11,4)="bitc"){
						anafil.anafilnum.1=5
					}else:if(strmid(d.cnt,11,7)="fx;bitc"){
						anafil.anafilnum.1=6
					}else:if((strmid(d.cnt,11,3)="fx;")|(strmid(d.cnt,11,3)="fx")){
						anafil.anafilnum.1=-1
					}else:if(strmid(d.cnt,11,4)="peak"){
						anafil.anafilnum.1=0
					}else{
						dialog "Error: Undefined filter (\""+strmid(d.cnt,11,256)+"\")"
						anafil.anafilnum.1=0
					}
				}
				anafilnum++
				continue
			}
			if(StartsWith(d.cnt, "chokkakuvol=")){
				if(cnt3<0){
					anvol.anvolnum.0=cbcnt+stpsh
				}else{
					anvol.anvolnum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt+stpsh
				}
				if((int(strmid(d.cnt,12,3))>=0)&(int(strmid(d.cnt,12,3))<=100)){
					if((anvol.anvolnum.0<=0)&(anvolnum>=1)):anvolnum--
					anvol.anvolnum.1=int(strmid(d.cnt,12,3))
					anvolnum++
				}
				continue
			}
			if(StartsWith(d.cnt, "zoom_top=")){
				if(cnt3<0){
					ztop.ztopnum.0=int(cbcnt)
				}else{
					ztop.ztopnum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+int(cbcnt)
				}
				if((int(strmid(d.cnt,9,16))<=65535)&(int(strmid(d.cnt,9,16))>=-65535)){
					if((ztop.ztopnum.0=ztop.max(ztopnum-1,0).0)&(ztopnum>0)){
						ztop.(ztopnum-1).2=int(strmid(d.cnt,9,16))
					}else{
						ztop.ztopnum.1=int(strmid(d.cnt,9,16))
						ztop.ztopnum.2=int(strmid(d.cnt,9,16))
						ztopnum++
					}
				}
				continue
			}
			if(StartsWith(d.cnt, "zoom_bottom=")){
				if(cnt3<0){
					zbot.zbotnum.0=int(cbcnt)
				}else{
					zbot.zbotnum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+int(cbcnt)
				}
				if((int(strmid(d.cnt,12,16))<=65535)&(int(strmid(d.cnt,12,16))>=-65535)){
					if((zbot.zbotnum.0=zbot.max(zbotnum-1,0).0)&(zbotnum>0)){
						zbot.(zbotnum-1).2=int(strmid(d.cnt,12,16))
					}else{
						zbot.zbotnum.1=int(strmid(d.cnt,12,16))
						zbot.zbotnum.2=int(strmid(d.cnt,12,16))
						zbotnum++
					}
				}
				continue
			}
			if(StartsWith(d.cnt, "zoom_side=")){
				if(cnt3<0){
					zside.zsidenum.0=int(cbcnt)
				}else{
					zside.zsidenum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+int(cbcnt)
				}
				if((int(strmid(d.cnt,10,16))<=65535)&(int(strmid(d.cnt,10,16))>=-65535)){
					if((zside.zsidenum.0=zside.max(zsidenum-1,0).0)&(zsidenum>0)){
						zside.(zsidenum-1).2=int(strmid(d.cnt,10,16))
					}else{
						zside.zsidenum.1=int(strmid(d.cnt,10,16))
						zside.zsidenum.2=int(strmid(d.cnt,10,16))
						zsidenum++
					}
				}
				continue
			}
			if(StartsWith(d.cnt, "laserrange_l=")){
				anaran.anarannum.0=0
				if(cnt3<0){
					anaran.anarannum.1=int(cbcnt)
				}else{
					anaran.anarannum.1=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+int(cbcnt)
				}
				if(strmid(d.cnt,13,2)="2x"){
					anaran.anarannum.2=2
					anarannum++
				}//else:anaran.anarannum.2=1
				continue
			}
			if(StartsWith(d.cnt, "laserrange_r=")){
				anaran.anarannum.0=1
				if(cnt3<0){
					anaran.anarannum.1=int(cbcnt)
				}else{
					anaran.anarannum.1=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+int(cbcnt)
				}
				if(strmid(d.cnt,13,2)="2x"){
					anaran.anarannum.2=2
					anarannum++
				}//else:anaran.anarannum.2=1
				continue
			}
			if(StartsWith(d.cnt, "pfiltergain=")){
				if(cnt3<0){
					anagain.anagainnum.0=cbcnt+stpsh
				}else{
					anagain.anagainnum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt+stpsh
				}
				if((int(strmid(d.cnt,12,3))>=0)&(int(strmid(d.cnt,12,3))<=100)){
					if((anagain.anagainnum.0<=0)&(anagainnum>=1)):anagainnum--
					anagain.anagainnum.1=int(strmid(d.cnt,12,3))
					anagainnum++
				}
				continue
			}
			if(StartsWith(d.cnt, "pfilterdelay=")){
				laserdelay1=int(strmid(d.cnt,13,16))
				if(laserdelay1<0):laserdelay1=40
				if(laserdelay1>160):laserdelay1=160
				continue
			}
			if(StartsWith(d.cnt, "chokkakuse=")){
				if(cnt3<0){
					anse.ansenum.0=cbcnt+stpsh
				}else{
					anse.ansenum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt+stpsh
				}
				f=1
				switch strmid(d.cnt,11,64)
				case "down"
					anse.ansenum.1=1
					swbreak
				case "up"
					anse.ansenum.1=2
					swbreak
				case "swing"
					anse.ansenum.1=3
					swbreak
				case "mute"
					anse.ansenum.1=4
					swbreak
				default
					f=0
				swend
				if(f=1):ansenum++
				continue
			}
			if(StartsWith(d.cnt, "tilt=")){
				if(cnt3<0){
					tilt.tiltnum.0=cbcnt+stpsh
				}else{
					tilt.tiltnum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt+stpsh
				}
				if(strmid(d.cnt,5,16)="normal"){
					_stat1=0
				}else:if(strmid(d.cnt,5,16)="big"){
					_stat1=1
				}else:if(strmid(d.cnt,5,16)="bigger"){
					_stat1=1
				}else:if(strmid(d.cnt,5,16)="biggest"){
					_stat1=2
				}else:if(strmid(d.cnt,5,16)="keep_normal"){
					_stat1=3
				}else:if(strmid(d.cnt,5,16)="keep_bigger"){
					_stat1=4
				}else:if(strmid(d.cnt,5,16)="keep_biggest"){
					_stat1=5
				}else:if(strmid(d.cnt,5,16)="zero"){
					_stat1=6
				}else:if(strmid(d.cnt,5,16)="keep"){
					_stat1=4
				}else{
					_stat1=int((double(strmid(d.cnt,5,16))+1000.0f)*100000)+7
				}
				if(tiltnum>0){
					_stat2=(tilt.(tiltnum-1).0=tilt.tiltnum.0) // 1つ前の傾き指定と同じかどうか？
				}else{
					_stat2=0
				}
				if(_stat2=1){
					tilt.(tiltnum-1).2=_stat1
				}else{
					tilt.tiltnum.1=_stat1
					tilt.tiltnum.2=_stat1
					if((tilt.tiltnum.0!=0)|(tilt.tiltnum.1!=0)):tiltnum++
				}
				continue
			}
			if(StartsWith(d.cnt, "m=")){
				csongfile=strmid(d.cnt,2,1024)
				_sjis_ csongfile
				continue
			}
			if(StartsWith(d.cnt, "o=")){
				offset=int(strmid(d.cnt,2,64))
				continue
			}
			if(StartsWith(d.cnt, "po=")){
				poffset=int(strmid(d.cnt,3,64))
				continue
			}
			if(StartsWith(d.cnt, "plength=")){
				plength=int(strmid(d.cnt,8,64))
				continue
			}
			if(StartsWith(d.cnt, "v=")){
				csongv=strmid(d.cnt,2,128)
				continue
			}
			if(StartsWith(d.cnt, "vo=")){
				csongvoffset=int(strmid(d.cnt,3,64))
				_sjis_ csongv
				continue
			}
			if(StartsWith(d.cnt, "information=")){
				csonginfo=strmid(d.cnt,12,128)
				_utf8_ csonginfo
				continue
			}
			if(StartsWith(d.cnt, "icon=")){
				csongicon=strmid(d.cnt,5,64)
				_sjis_ csongicon
				if(csongicon=""):csongicon=".png"
				continue
			}
			if(strmid(d.cnt,0,11)="#define_fx ")|(strmid(d.cnt,0,15)="#define_filter "):continue
			if(strmid(d.cnt,0,1)="#"){
				sharpstr=sharpstr+d.cnt+"\n"
				continue
			}
			if(d.cnt=""){
				continue
			}
			if((strmid(d.cnt,7,1)!="|")|(d.cnt!=replace(d.cnt,"=",""))){
				if(cnt3<0){
					comment.commentnum=-1
				}else{
					comment.commentnum=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt
				}
				commentstr.commentnum=d.cnt
				commentnum++
				continue
			}
			if(cnt3<0){
				dialog lang.0.8/*"譜面データの始端には小節線(--)を入力する必要があります。"*/,1,lang.0.1/*"エラー"*/
				break
			}
			if(div.cnt3=0){
				continue
			}
			cnt2++ // カレント小節数/div(小節内)
			// StepMania用譜面データ変換時、譜面停止分のカウント値をずらす
			if(sm=1){
				repeat stpnum-cstp-1,cstp+1
					if(stp.cnt.0<cbcnt+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3){
						stp.cnt.0+=stpsh
						stpsh+=stp.cnt.1
						cstp=cnt
					}
				loop
				repeat bpmnum
					if(bpml.cnt.0<=cbcnt+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3){
						bpm=bpml.cnt.1
					}
				loop
			}
			exc=0
			if(cnt2a>0){
				repeat
					if((cnt2a-cnt-1)<0){
						exc=-1
						break
					}
					if(strmid(d.(cnt2a-cnt-1),4,1)!="|"){
						exc++
						continue
					}
					break
				loop
			}
			// ショートオブジェクトのリストアップ
			repeat 4
				// short
				if(strmid(d.cnt2a,cnt,1)="1"){
					note.notenum.0=cnt
					note.notenum.1=cbcnt+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3+stpsh
					note.notenum.2=0
					note.notenum.3=0
					notesefname.notenum=""
					notenum++
					stat4+=2
					continue
				}
				// long
				lcnt=cnt
				if(strmid(d.cnt2a,cnt,1)="2")&((strmid(d.(cnt2a-exc-1),cnt,1)!=strmid(d.cnt2a,cnt,1))|(exc=-1)){
					excd=0
					beatn2=beatn
					beatd2=beatd
					lend=UNIT_MEASURE*beatn2/beatd2/div.cnt3
					repeat
						if(cnt2a+cnt+1>=length(d)){
							break
						}
						if(d.(cnt2a+cnt+1)=""){
							continue
						}
						if(strmid(d.(cnt2a+cnt+1),0,2)="--"){
							excd++
							continue
						}
						if(StartsWith(d.(cnt2a+cnt+1), "beat=")){
							sdim beatstat,16,2
							stat1=strmid(d.(cnt2a+cnt+1),5,33)
							split stat1,"/",beatstat
							if(length(beatstat)=2){
								if((int(beatstat.0)>0)&(int(beatstat.1)>0)){
									beatn2=int(beatstat.0)
									beatd2=int(beatstat.1)
								}
							}
							continue
						}
						if(strmid(d.(cnt2a+cnt+1),4,1)!="|"){
							continue
						}
						if(strmid(d.(cnt2a+cnt+1),lcnt,1)=strmid(d.cnt2a,lcnt,1)){
							if(div.(cnt3+excd)=0):break
							lend+=UNIT_MEASURE*beatn2/beatd2/div.(cnt3+excd)
						}else{
							break
						}
					loop
					note.notenum.0=cnt
					note.notenum.1=cbcnt+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3+stpsh
					stpsh2=0
					if(sm=1){
						stat1=0
						repeat stpnum-cstp-1,cstp+1
							if(stp.cnt.0<cbcnt+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3+stat1/100){
								stpsh2+=stp.cnt.1
							}
						loop
					}
					note.notenum.2=lend+stpsh2
					stat1=strmid(d.cnt2a,cnt,1)
					note.notenum.3=0
					notesefname.notenum=""
					notenum++
				}
			loop
			// ロングオブジェクトのリストアップ
			repeat 2
				lcnt=cnt
				if(strmid(d.cnt2a,cnt+5,1)="2"){
					note.notenum.0=cnt+4
					note.notenum.1=cbcnt+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3+stpsh
					note.notenum.2=0
					note.notenum.3=0
					notesefname.notenum=nextKeySoundStrsLR.lcnt
					notenum++
					continue
				}
				if((strmid(d.cnt2a,cnt+5,1)!="0")&((strmid(d.(cnt2a-exc-1),cnt+5,1)!=strmid(d.cnt2a,cnt+5,1))|(exc=-1)|((csongver_int>=160)&(fxfl.cnt=1)))){
					excd=0
					beatn2=beatn
					beatd2=beatd
					lend=UNIT_MEASURE*beatn2/beatd2/div.cnt3
					repeat
						if(cnt2a+cnt+1>=length(d)){
							break
						}
						if(d.(cnt2a+cnt+1)=""){
							continue
						}
						if(strmid(d.(cnt2a+cnt+1),0,2)="--"){
							excd++
							continue
						}
						if((csongver_int>=160)&(headcmp(d.(cnt2a+cnt+1),5,"fx-"+str_lr.lcnt+"="))){
							break
						}
						if(StartsWith(d.(cnt2a+cnt+1), "beat=")){
							sdim beatstat,16,2
							stat1=strmid(d.(cnt2a+cnt+1),5,33)
							split stat1,"/",beatstat
							if(length(beatstat)=2){
								if((int(beatstat.0)>0)&(int(beatstat.1)>0)){
									beatn2=int(beatstat.0)
									beatd2=int(beatstat.1)
								}
							}
							continue
						}
						if(strmid(d.(cnt2a+cnt+1),4,1)!="|"){
							continue
						}
						if(strmid(d.(cnt2a+cnt+1),lcnt+5,1)=strmid(d.cnt2a,lcnt+5,1)){
							if(div.(cnt3+excd)=0):break
							lend+=UNIT_MEASURE*beatn2/beatd2/div.(cnt3+excd)
						}else{
							break
						}
					loop
					note.notenum.0=cnt+4
					note.notenum.1=cbcnt+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3+stpsh
					stpsh2=0
					if(sm=1){
						stat1=0
						repeat stpnum-cstp-1,cstp+1
							if(stp.cnt.0<cbcnt+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3+stat1/100){
								stpsh2+=stp.cnt.1
							}
						loop
					}
					note.notenum.2=lend+stpsh2
					if(csongver_int>=160){
						repeat fxnum
							if((fx.cnt.0=lcnt)&(fx.cnt.1=note.notenum.1)){
								note.notenum.3=fx.cnt.2
								note.notenum.4=fx.cnt.3
								note.notenum.5=fx.cnt.4
								break
							}
						loop
					}else{
						stat1=strmid(d.cnt2a,cnt+5,1)
						if(stat1="S"){
							note.notenum.3=1
							note.notenum.4=fx_div.(note.notenum.3)
						}else:if(stat1="V"){
							note.notenum.3=2
							note.notenum.4=fx_div.(note.notenum.3)
						}else:if(stat1="T"){
							note.notenum.3=3
							note.notenum.4=fx_div.(note.notenum.3)
						}else:if(stat1="W"){
							note.notenum.3=4
							note.notenum.4=fx_div.(note.notenum.3)
						}else:if(stat1="U"){
							note.notenum.3=5
							note.notenum.4=fx_div.(note.notenum.3)
						}else:if(stat1="G"){
							note.notenum.3=6
							note.notenum.4=fx_div.(note.notenum.3)
						}else:if(stat1="H"){
							note.notenum.3=7
							note.notenum.4=fx_div.(note.notenum.3)
						}else:if(stat1="K"){
							note.notenum.3=8
							note.notenum.4=fx_div.(note.notenum.3)
						}else:if(stat1="I"){
							note.notenum.3=9
							note.notenum.4=fx_div.(note.notenum.3)
						}else:if(stat1="L"){
							note.notenum.3=10
							note.notenum.4=fx_div.(note.notenum.3)
						}else:if(stat1="J"){
							note.notenum.3=11
							note.notenum.4=fx_div.(note.notenum.3)
						}else:if(stat1="F"){
							note.notenum.3=12
						}else:if(stat1="P"){
							note.notenum.3=13
							note.notenum.4=12
						}else:if(stat1="B"){
							note.notenum.3=14
							note.notenum.4=5
							repeat fxparamsnum
								if((fxparams.cnt.0=note.notenum.0-4)&(fxparams.cnt.1=note.notenum.1)){
									note.notenum.4=min(max(fxparams.cnt.2,0),64)
								}
							loop
						}else:if(stat1="Q"){
							note.notenum.3=15
						}else:if(stat1="X"){
							note.notenum.3=16
							note.notenum.4=fx_div.(note.notenum.3)
						}else:if(stat1="A"){
							note.notenum.3=17
							repeat fxparamsnum
								if((fxparams.cnt.0=note.notenum.0-4)&(fxparams.cnt.1=note.notenum.1)){
									note.notenum.4=min(max(fxparams.cnt.2,0),100)
								}
							loop
						}else:if(stat1="D"){
							note.notenum.3=19
						}else{
							note.notenum.3=0
						}
					}
					notesefname.notenum=""
					notenum++
				}
				fxfl.cnt=0
			loop
			// アナログデバイスのリストアップ
			repeat 2
				if((strmid(d.cnt2a,cnt+8,1)!="-")&(strmid(d.cnt2a,cnt+8,1)!=":")){
					cnt0=cnt
					// アナログデバイスの開始地点かどうかを判定
					exc=0
					if(cnt2a=0){
						analog.analognum.5=1
					}else{
						repeat
							if(cnt2a-cnt-1<0){
								analog.analognum.5=1
								break
							}
							if(strmid(d.(cnt2a-cnt-1),cnt0+8,1)=":"){
								exc++
								continue
							}
							if(strmid(d.(cnt2a-cnt-1),4,1)!="|"){
								exc++
								continue
							}
							break
						loop
						if(cnt2a-exc-1>=0){
							if(strmid(d.(cnt2a-exc-1),cnt+8,1)="-"){
								analog.analognum.5=1
							}
							if(cnt2a>1){
								exc2=0
								repeat
									if(strmid(d.(cnt2a-exc-cnt-1),4,1)!="|"){
										exc2++
										continue
									}
									break
								loop
							}
						}
					}
					// アナログデバイスの変化にかかる長さを確認
					excd=0
					stat3=0
					beatn2=beatn
					beatd2=beatd
					lend=UNIT_MEASURE*beatn2/beatd2/div.(cnt3+excd)
					repeat
						if(stat3=1){
							stat3=0
						}
						if(cnt2a+cnt+1>=sp){
							stat1=-1 // 異常
							break
						}
						if(strmid(d.(cnt2a+cnt+1),0,2)="--"){
							excd++
							continue
						}
						if(StartsWith(d.(cnt2a+cnt+1), "beat=")){
							sdim beatstat,16,2
							stat1=strmid(d.(cnt2a+cnt+1),5,33)
							split stat1,"/",beatstat
							if(length(beatstat)=2){
								if((int(beatstat.0)>0)&(int(beatstat.1)>0)){
									beatn2=int(beatstat.0)
									beatd2=int(beatstat.1)
								}
							}
							continue
						}
						if(strmid(d.(cnt2a+cnt+1),4,1)!="|"){
							continue
						}
						if(div.(cnt3+excd)=0){
							break
						}
						if(strmid(d.(cnt2a+cnt+1),cnt0+8,1)!=":"){
							stat1=a2p(strmid(d.(cnt2a+cnt+1),cnt0+8,1))
							break
						}
						lend+=UNIT_MEASURE*beatn2/beatd2/div.(cnt3+excd)
					loop
					// 異常がなければリストに追加
					if(stat1!=-1){
						analog.analognum.0=cnt // 対象のアナログデバイス(L:0,R:1)
						analog.analognum.1=cbcnt+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3+stpsh // 変化の始点カウント値
						analog.analognum.2=lend // 変化にかかる時間
						analog.analognum.3=a2p(strmid(d.cnt2a,cnt+8,1)) // 変化の初期値
						analog.analognum.4=stat1 // 変化の目標値
						analognum++
					}
				}
			loop
			// 画面回転のリストアップ
			if(strmid(d.cnt2a,10,1)="@"){
				f=1
				if(strmid(d.cnt2a,11,1)="("){
					spin.spinnum.0=0 // 時計回り回転
				}else:if(strmid(d.cnt2a,11,1)=")"){
					spin.spinnum.0=1 // 反時計回り
				}else:if(strmid(d.cnt2a,11,1)="<"){
					spin.spinnum.0=2 // 時計回り半回転
				}else:if(strmid(d.cnt2a,11,1)=">"){
					spin.spinnum.0=3 // 反時計回り半回転
				}else:f=0
				if(f=1){
					spin.spinnum.1=cbcnt+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3+stpsh // 位置
					spin.spinnum.2=int(strmid(d.cnt2a,12,32)) // 長さ(c)
					if(spin.spinnum.0=4):spin.spinnum.2=UNIT_MEASURE/32
					spinnum++
				}
			}
			// ばねエフェクトのリストアップ
			if(strmid(d.cnt2a,10,1)="S"){
				f=1
				if(strmid(d.cnt2a,11,1)="<"){
					spin.spinnum.0=4 // 左向き
				}else:if(strmid(d.cnt2a,11,1)=">"){
					spin.spinnum.0=5 // 右向き
				}else:f=0
				if(f=1){
					spin.spinnum.1=cbcnt+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3+stpsh // 位置
					spin.spinnum.2=int(strmid(d.cnt2a,12,32)) // 長さ(c)
					stat1=strmid(d.cnt2a,12,64)
					sdim splitstat,64,1
					split stat1,";",splitstat
					spin.spinnum.3=250 //揺れ幅
					if(length(splitstat)>=2):spin.spinnum.3=max(int(splitstat.1),0)
					spin.spinnum.4=3 //回数 (片道+1 往復+2)
					if(length(splitstat)>=3):spin.spinnum.4=max(int(splitstat.2),0)
					if(spin.spinnum.4>0){
						spin.spinnum.5=2 //減衰の有無 (0:なし 1:あり(遅) 2:あり)
						if(length(splitstat)>=4):spin.spinnum.5=min(max(int(splitstat.3),0),2)
						spinnum++
					}
				}
			}
			nextKeySoundStrsLR = "", ""
		loop

		// layer名の区切り文字置き換え(v1.67)
		if(csongver_int<167):strrep bgname_l,"/",";"

		if (csongver_int < 160) {
			csongver="160"
			csongver_int = 160
		}

		// レーザー移動幅の適用
		stat1=0
		stat2=0
		//dim analogparent,analognum
		repeat analognum
			if(analog.cnt.5=1){
				if(analog.cnt.0=0):stat1=cnt
				if(analog.cnt.0=1):stat2=cnt
			}
			if(analog.cnt.0=0):analogparent.cnt=stat1
			if(analog.cnt.0=1):analogparent.cnt=stat2
		loop
		stat1=0
		stat2=0
		//dim analogparentran,analognum
		repeat anarannum
			cnt2=cnt
			repeat analognum-(stat1*(anaran.cnt2.0=0)+stat2*(anaran.cnt2.0=1)),(stat1*(anaran.cnt2.0=0)+stat2*(anaran.cnt2.0=1))
				if((anaran.cnt2.0=analog.cnt.0)&(analog.cnt.1<anaran.cnt2.1)){
					if(analog.cnt.0=0):stat1=cnt
					if(analog.cnt.0=1):stat2=cnt
				}
				if((anaran.cnt2.0=analog.cnt.0)&(anaran.cnt2.1=analog.cnt.1)){
					analogparentran.(analogparent.cnt)=2
				}
				if((analog.cnt.1>=anaran.cnt2.1)&(analog.cnt.0=anaran.cnt2.0)):break
			loop
		loop
		if(beatlnum=0){
			beatl.0.0=0
			beatlnum=1
			beatl.0.1=4
			beatl.0.2=4
		}
		if(anagainnum=0){
			anagain.0.0=0
			anagain.0.1=50
			anagainnum=1
		}
		if(anafilnum=0){
			anafil.0.0=0
			anafil.0.1=0
			anafilnum=1
		}
		if(anvolnum=0){
			anvol.0.0=0
			anvol.0.1=30
			anvolnum=1
		}
		if(csongver=""){
			csongvol=csongvol*6/10
		}
		sdim d,1
		if(caution=1){
			dialog lang.0.25/*"この譜面データには特殊な譜面配置が存在するため、上書き保存するとデータが破損する可能性があります。"*/,0,lang.0.10/*"注意"*/
		}
		gosub *draw
	}else:if(cmd=CMD_SAVE){
		if(pendfl!=-1):pendfl=1:return
		gosub *command_save
	}else:if(cmd=CMD_SAVEAS){
		if(pendfl!=-1):pendfl=1:return
		saveasstat=1
		//stat1=0
		//repeat analognum
		//	if((analog.cnt.5=1)&(analog.cnt.3!=analog.cnt.0*50)):stat1=1:stat2=analog.cnt.0:stat3=c2b(analog.cnt.1)+1:break
		//loop
		//inputnow=1
		//if(stat1=1){
		//if(stat2=0){
		//		dialogstat=lang.0.11/*"LEFT(青)LASERオブジェクトが正常でない位置から始まっている箇所があります。\n続行しますか?"*/
		//	}else{
		//		dialogstat=lang.0.12/*"RIGHT(赤)LASERオブジェクトが正常でない位置から始まっている箇所があります。\n続行しますか?"*/
		//	}
		//	dialogstat=replace(dialogstat,"%0",""+stat3)
		//	dialog dialogstat,2,lang.0.10/*"注意"*/
		//	if(stat=7){
		//		inputnow=0
		//		acmd=-1:return
		//	}
		//}
		if((csongtitle="")&(err=0)){
			dialog lang.0.15/*"曲のタイトル(title)が指定されていません。\n続行しますか?"*/,2,lang.0.10/*"注意"*/
			if(stat=7){
				dialog lang.0.16/*"曲のタイトル(title)は「ツール(T)」→「譜面に関する設定(T)」から編集できます。"*/
				inputnow=0
				acmd=-1:return
			}
		}
		dialog "ksh",17,lang.0.30
		if(refstr=""){
			saveasstat=0
			inputnow=0
			acmd=-1:return
		}
		inputnow=0
		fname=refstr
		acmd=CMD_SAVE
		gosub *OnCommand
		saveasstat=0
	}else:if(cmd=CMD_EXPORT_RPP){
		if(pendfl!=-1):pendfl=1:return
		dialog lang.0.48/*"注意:\nREAPERプロジェクト書き出しは旧バージョンとの互換性保持のために残されている機能です。v1.60以降に追加されたエフェクトは正常に書き出されません。"*/,0,lang.0.10
		csongexist=1
		//exist getpath(fname,32)+csongfile
		//if((stat<=0)|(csongfile="")){
		//	csongexist=0
		//}
		sdim csongflist,256,1
		split csongfile,";",csongflist
		dialog "rpp",17,lang.0.32
		if(refstr=""){
			acmd=-1:return
		}
		rppfname=refstr
		if(getpath(rppfname,18)!=".rpp"):rppfname+=".rpp"
		ot=0
		repeat analognum
			cnt2=cnt
			repeat analognum-cnt2-1,cnt2+1
				cnt3=cnt
				if(analog.cnt.1>analog.cnt2.1):break
				if((analog.cnt.1=analog.cnt2.1)&(analog.cnt2.2>analog.cnt.2)){
					dim anaarstat,6
					repeat 6
						anaarstat.cnt=analog.cnt2.cnt
					loop
					repeat 6
						analog.cnt2.cnt=analog.cnt3.cnt
					loop
					repeat 6
						analog.cnt3.cnt=anaarstat.cnt
					loop
				}
			loop
		loop

		// 曲の長さ(ms)を調べる
		filepath=getpath(fname,32)+csongflist
		if(mid!=-1):BASS_StreamFree mid
		mid=BASS_StreamCreateFile(0,filepath,0,0,0,0,0x20000)
		mlength=BASS_ChannelGetLength_ms(mid)

		buf="<REAPER_PROJECT 0.1\n  RIPPLE 0\n  GROUPOVERRIDE 0\n  AUTOXFADE 1\n  ENVATTACH 0\n  MIXERUIFLAGS 11\n  PEAKGAIN 1.000000\n  FEEDBACK 0\n  AUTOMUTE 0 8.000000\n  PANLAW 1.000000\n  MAXPROJLEN 0 600.000000\n  GRID 127 20 1.000000 20 1.000000\n  TIMEMODE 0\n  CURSOR 0.000000\n  ZOOM 100.000000 0\n  VZOOMEX 2\n  AUTOMODE 0\n  RECMODE 1\n  LOOP 0\n  LOOPGRAN 0 4.000000\n  RECORD_PATH \"\"\n  <RECORD_CFG\n  >\n  RENDER_FILE \""
		if(csongdifficulty=0){
			stat1="_lt"
		}else:if(csongdifficulty=1){
			stat1="_ch"
		}else:if(csongdifficulty=2){
			stat1="_ex"
		}else{
			stat1="_in"
		}
		buf+=getpath(csongflist.0,1)+stat1+"_f.ogg"//+getpath(csongflist.0,2)
		buf+="\"\n  RENDER_FMT 0 2 44100\n  RENDER_RANGE 1 0.000000 "+str(double(mlength+min(-offset,0))/1000)+"\n  RENDER_RESAMPLE 3\n  RENDER_ADDTOPROJ 0\n  RENDER_STEMS 0\n  SAMPLERATE 44100 0\n  <RENDER_CFG\n    dmdnbwAAAD8AgAAAAIAAAAAgAAAAAAEAAA==\n  >"
		stat1=str(double(bpml.0.1)/1000)
		stat1=strtrim(stat1,2,'0')
		buf+="\n  TEMPO "+strtrim(stat1,2,'.')+" "+beat
		buf+="\n  PLAYRATE 1.000000\n  SELECTION 0.000000 0.000000 0\n  MASTERTRACKHEIGHT 0\n  MASTERMUTESOLO 0\n  MASTERTRACKVIEW 0\n  MASTERHWOUT 0\n  MASTER_VOLUME 1.000000 0.000000 -1.000000\n  MASTER_FX 1\n  <MASTERFXLIST\n    WNDRECT 173 537 693 449\n    SHOW 0\n    LASTSEL 0\n    DOCKED 0\n    BYPASS 0\n    <VST \"VST: TLs-Pocket_Limiter (TbT v1.2)\" \"TLs-Pocket_Limiter.dll\"\n      ZXRFTO9e7f4CAAAAAQAAAAAAAAACAAAAAAAAAAIAAAABAAAAAAAAAA==\n      AgAAAAAAAAAgAAAAAAAAAAAAAADvvq3eDfCt3gAAAD/OZjM/AAAAAA==\n      AACAPwAAgD8AAAAA\n    >\n  >\n  <MASTERPLAYSPEEDENV\n    ACT 1\n    VIS 1\n    ARM 0\n    DEFSHAPE 0\n  >\n  <TEMPOENVNEW\n    ACT 1\n    VIS 1\n    ARM 0\n    DEFSHAPE 1"
		buf+="\n    PT 0.000000 "+stat1+"000000 1"
		if((beatl.0.0=0)&(beatlnum>=1)){
			buf+=" "+(4*beatl.cnt.1/beatl.cnt.2)
		}
		repeat bpmlnum-1,1
			stat1=4
			cnt2=cnt
			repeat beatlnum
				if(beatl.cnt.0<=bpml.cnt2.0):stat1=4*beatl.cnt.1/beatl.cnt.2
			loop
			buf+="\n    PT "+str(double(c2ta(bpml.cnt.0))/1000)+" "+str(double(bpml.cnt.1)/1000)+" 1 "+stat1
		loop
		repeat beatlnum
			if(beatl.cnt.0=0):continue
			stat1=bpml.0.1
			cnt2=cnt
			repeat max(bpmlnum-1,0),1
				if(bpml.cnt.0<=beatl.cnt2.0):stat1=bpml.cnt.1
			loop
			f=1
			repeat bpmlnum
				if(bpml.cnt.0=beatl.cnt2):f=0
			loop
			if(f=0):continue
			buf+="\n    PT "+str(double(c2ta(beatl.cnt.0))/1000)+" "+str(double(stat1)/1000)+" 1 "+(4*beatl.cnt.1/beatl.cnt.2)
		loop
		buf+="\n  >\n  <MASTERVOLENV\n    ACT 1\n    VIS 1\n    ARM 0\n    DEFSHAPE 0\n  >\n  <MASTERPANENV\n    ACT 1\n    VIS 1\n    ARM 0\n    DEFSHAPE 0\n  >\n  <MASTERVOLENV2\n    ACT 1\n    VIS 1\n    ARM 0\n    DEFSHAPE 0\n  >\n  <MASTERPANENV2\n    ACT 1\n    VIS 1\n    ARM 0\n    DEFSHAPE 0\n  >\n  <TRACK\n    NAME \""+getpath(csongflist.0,1)+"\""
		buf+="\n    VOLPAN 1.000000 0.000000 -1.000000\n    MUTESOLO 0 0\n    IPHASE 0\n    ISBUS 0\n    BUSCOMP 0\n    SHOWINMIX 1\n    SEL 1\n    REC 0 0 0 0\n    TRACKHEIGHT 128\n    NCHAN 2\n    FX 1\n    MIDIOUT -1\n    MAINSEND 1\n    <FXCHAIN\n      WNDRECT 166 510 1097 247\n      SHOW 0\n      LASTSEL 2\n      DOCKED 0"
		/*
		buf+="\n      BYPASS 0\n      <VST \"VST: Octaver12B (TbT    Beta v1.0)\" \"Octaver12B.dll\"\n        ZXRDT+9e7f4CAAAAAQAAAAAAAAACAAAAAAAAAAIAAAABAAAAAAAAAA==\n        AgAAAAAAAAAwAAAAAAAAAAAAAADvvq3eDfCt3gAAAAAAAAAAAACAPw==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAA5juM+OY7jPg==\n      >\n      <PARMENV 7 0.000000 1.000000\n        ACT 1\n        VIS 1\n        ARM 0\n        DEFSHAPE 1\n        PT 0.000000 1.000000 1"
		dim pitchsh,131072,2
		pitchshnum=0
		repeat notenum
			if((note.cnt.0>3)&(note.cnt.3=13)){
				f=0
				cnt2=cnt
				repeat pitchshnum
					if((pitchsh.cnt.0<=note.cnt2.1)&(pitchsh.cnt.0+pitchsh.cnt.1>=note.cnt2.1+note.cnt2.2)):f=1
					if((pitchsh.cnt.0+pitchsh.cnt.1>=note.cnt2.1)&(pitchsh.cnt.0+pitchsh.cnt.1<=note.cnt2.1+note.cnt2.2)){
						pitchsh.cnt.1+=(note.cnt2.1+note.cnt2.2)-(pitchsh.cnt.0+pitchsh.cnt.1)
						f=1
					}
					if(f=1):break
				loop
				if(f=0){
					pitchsh.pitchshnum.0=note.cnt.1
					pitchsh.pitchshnum.1=note.cnt.2
					pitchshnum++
				}
			}
		loop
		repeat pitchshnum
			buf+="\n        PT "+str(double(c2ta(pitchsh.cnt.0))/1000)+" 0.000000 1"
			buf+="\n        PT "+str(double(c2ta(pitchsh.cnt.0+pitchsh.cnt.1))/1000)+" 1.000000 1"
		loop
		buf+="\n      >\n      "*/
		buf+="\n      BYPASS 0\n      <VST \"VST: dblue Glitch v1.3 (dblue)\" \"dblue_Glitch_v1_3.dll\"\n        X1tHZO9e7f4CAAAAAQAAAAAAAAACAAAAAAAAAAIAAAABAAAAAAAAAA==\n        AgAAAAAAAADwCgAAAQAAAAAAAABQcm9ncmFtIDEAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAACAPgAAgD4AAIA+AACAPwAAgD8AAAAAAAAAAA==\n        AACAPwAAAD8AAAAAAACAPwAAgD8AAAA/AACAPwAAAD8AAAA/AACAPw==\n        AAAAPwAAAAAAAAA/AAAAAAAAgD4AAAAAzcxMPQAAAAAAAAA/AAAAPw==\n        AACAPwAAAD8AAAAAAAAAPwAAAADNzMw8AACAPwAAAADNzEw+AAAAPw==\n        AAAAPwAAAAAAAAA/AAAAAAAAAD8AAAAAAAAAACh9Mj8AAAA/AAAAPw==\n        AAAAPwAAAD8AAIA/AAAAPwAAAAAAAAA/AAAAAOxROD+F61E/AAAAPw==\n        AACAPwAAAD8AAAA/AACAPwAAAD8AAAAAAAAAPwAAAAAAAAAAAAAAPw==\n        AAAAAAAAAAAAAAA/AAAAPwAAgD8AAAA/AAAAAAAAAD8AAAAAmpmZPQ==\n        AAAAAAAAAAAAAAAAAAAAPwAAAD8AAIA/AAAAPwAAAAAAAAA/AAAAAA==\n        AACAPgAAAD8AAIA/AAAAAAAAAD8AAAA/AACAPwAAAD8AAAAAAAAAPw==\n        AAAAAArXIz0AAEA/AABAPwAAAD8AAAA/AAAAPwAAgD8AAAA/AAAAAA==\n        AAAAPwAAAADNzMw+AAAAPgAAgD4AAAAAAAAAPwAAAD8AAIA/AAAAPw==\n        AAAAAAAAAD8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD8AAAA/AACAPw==\n        AAAAPwAAAAAAAAA/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/AAAAPw==\n        AACAPwAAAD8AAAAAAAAAPwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPw==\n        AAAAPwAAgD8AAAA/AAAAAAAAAD8AAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAACwAAAAAAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAA==\n        AAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQABAAEAAQ==\n        AAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQ==\n        AAEAAQABAAEAAQABAAEAAQABAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQ==\n        AQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQ==\n        AQEAAAAAAAAAAQAAAAAAAAABAAAAAAAAAAEAAAAAAAAAAQAAAAAAAA==\n        AAEAAAAAAAAAAQAAAAAAAAABAAAAAAAAAAEAAAABAAAAAQABAAEBAQ==\n        AAEAAAABAAAAAQABAAEBAQABAAAAAQAAAAEAAQABAQEAAQAAAAEAAA==\n        AAEAAQABAQEAAQAAAAEAAQAAAQAAAQAAAAEAAAABAAEAAAEAAAEAAA==\n        AAEAAAABAAEAAAEAAAEAAAABAAAAAQABAAABAAABAAAAAQAAAAAAAQ==\n        AAAAAAABAAAAAAABAAAAAAABAAAAAAABAAAAAAABAAAAAAABAAAAAA==\n        AAEAAAAAAAEAAAAAAAEAAAABAAABAAABAAABAAABAAABAAABAAABAA==\n        AAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAA==\n        AQEAAAEAAAEAAQAAAQAAAQABAAABAAABAAEAAAEAAAEAAQAAAQAAAQ==\n        AAEAAAEAAAEAAQAAAQAAAQABAAABAAABAAEAAAEAAQABAQEAAQABAA==\n        AAEAAAEAAQABAQEAAQABAAABAAABAAEAAQEBAAEAAQAAAQAAAQABAA==\n        AQEBAAEAAQAAAQEAAQAAAQABAQABAAABAAEBAAEAAAEAAQEAAQAAAQ==\n        AAEBAAEAAAEAAQEAAQAAAQABAQABAAABAAEBAAEAAAEAAQABAAEAAA==\n        AQAAAQABAAAAAQABAAEAAAEAAAEAAQAAAAEAAQABAAABAAABAAEAAA==\n        AAEAAQABAAABAAABAAEAAAABAAAAAQAAAAEAAQAAAQAAAQAAAAEAAA==\n        AAEAAQAAAQAAAQAAAAEAAAABAAEAAAEAAAEAAAABAAAAAQABAAABAA==\n        AAEAAQAAAQABAAABAAEAAQABAAEAAAEAAQAAAQABAAEAAQABAAABAA==\n        AQAAAQABAAEAAQABAAABAAEAAAEAAQABAAEAAAABAQEBAAABAAEBAA==\n        AAEAAAABAQEBAAABAAEBAAABAAAAAQEBAQAAAQABAQAAAQAAAAEBAQ==\n        AQAAAQABAQAAAQEAAQAAAQABAAEBAAABAAEBAAEAAAEAAQABAQAAAQ==\n        AAEBAAEAAAEAAQABAQAAAQABAQABAAABAAEAAQEAAAEABv///////w==\n        ////////////Av///////////////////wgAAAAAAAACAf///////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        //8AAQEBAQEBAQEBAQEBAQEBAQAAAAAAAAAAAAABATYAAIA//////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        ////////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAA0=\n      >\n      <PARMENV 56 0.000000 1.000000\n        ACT 1\n        VIS 1\n        ARM 0\n        DEFSHAPE 1\n        PT 0.000000 0.000000 1"
		dim retrigger,131072,4
		retriggernum=0
		f=0
		repeat notenum
			if((note.cnt.0>3)&((note.cnt.3>=1)&(note.cnt.3<=5))){
				retrigger.retriggernum.0=note.cnt.1
				retrigger.retriggernum.1=note.cnt.2
				retrigger.retriggernum.2=note.cnt.3-1
				retrigger.retriggernum.3=-1
				retriggernum++
			}
		loop
		// 終端が他に囲まれている場合を検出
		repeat retriggernum
			cnt2=cnt
			repeat retriggernum
				if(cnt=cnt2):continue
				if((retrigger.cnt.0<=retrigger.cnt2.0+retrigger.cnt2.1)&(retrigger.cnt.0+retrigger.cnt.1>retrigger.cnt2.0+retrigger.cnt2.1)){
					retrigger.cnt2.3=retrigger.cnt.2
					break
				}
				if(retrigger.cnt.0<=retrigger.cnt2.0+retrigger.cnt2.1):break
			loop
		loop
		repeat retriggernum
			if(retrigger.cnt.1>0){
				buf+="\n        PT "+str(double(c2ta(retrigger.cnt.0))/1000)+" 1.000000 1"
				if(retrigger.cnt.3=-1):buf+="\n        PT "+str(double(c2ta(retrigger.cnt.0+retrigger.cnt.1))/1000)+" 0.000000 1"
			}
		loop
		stat1="0.000000"
		buf+="\n      >\n      <PARMENV 6 0.000000 1.000000\n        ACT 1\n        VIS 1\n        ARM 0\n        DEFSHAPE 1\n        PT 0.000000 "+stat1+" 1"
		repeat retriggernum
			if(retrigger.cnt.2=0){
				stat1="0.000000"
			}else:if(retrigger.cnt.2=1){
				stat1="0.033333"
			}else:if(retrigger.cnt.2=2){
				stat1="0.066667"
			}else:if(retrigger.cnt.2=3){
				stat1="0.133333"
			}else{
				stat1="0.200000"
			}
			if((retrigger.cnt.3=-1)&(cnt!=retriggernum-1)):retrigger.cnt.3=retrigger.(cnt+1).2
			if(retrigger.cnt.3=0){
				stat2="0.000000"
			}else:if(retrigger.cnt.3=1){
				stat2="0.033333"
			}else:if(retrigger.cnt.3=2){
				stat2="0.066667"
			}else:if(retrigger.cnt.3=3){
				stat2="0.133333"
			}else{
				stat2="0.200000"
			}
			buf+="\n        PT "+str(double(max(c2ta(retrigger.cnt.0)-30,0))/1000)+" "+stat1+" 1"
			if(retrigger.cnt.3!=-1):buf+="\n        PT "+str(double(max(c2ta(retrigger.cnt.0+retrigger.cnt.1)-30,0))/1000)+" "+stat2+" 1"
		loop
		dim tapestp,131072,3
		tapestpnum=0
		f=0
		repeat notenum
			if((note.cnt.0>3)&(note.cnt.3=17)){
				f=0
				cnt2=cnt
				repeat tapestpnum
					if((tapestp.cnt.0<=note.cnt2.1)&(tapestp.cnt.0+tapestp.cnt.1>=note.cnt2.1+note.cnt2.2)):f=1
					if((tapestp.cnt.0+tapestp.cnt.1>=note.cnt2.1)&(tapestp.cnt.0+tapestp.cnt.1<=note.cnt2.1+note.cnt2.2)){
						tapestp.cnt.1+=(note.cnt2.1+note.cnt2.2)-(tapestp.cnt.0+tapestp.cnt.1)
						f=1
					}
					if(f=1):dialog replace(lang.0.47,"%0",""+(c2b(tapestp.cnt.0)+1))/*"2つ以上のTapeStopエフェクトを重ねたり連続させたりすることはできません(%0小節目)。"*/:break
				loop
				if(f=1):break
				if(f=0){
					tapestp.tapestpnum.0=note.cnt.1
					tapestp.tapestpnum.1=note.cnt.2
					tapestp.tapestpnum.2=note.cnt.4
					tapestpnum++
				}
			}
		loop
		if(f=1):stop
		if(tapestpnum>0){
			buf+="\n      >\n      \n      BYPASS 0\n      <VST \"VST: dblue.TapeStop (dblue)\" \"dblue_TapeStop.dll\"\n        NXQ4ZO9e7f4CAAAAAQAAAAAAAAACAAAAAAAAAAIAAAABAAAAAAAAAA==\n        AgAAAAAAAAAUAAAAAAAAAAAAAADvvq3eDfCt3gAAAAAAAIA+AACAPw==\n      >\n      <PARMENV 0 0.000000 1.000000\n        ACT 1\n        VIS 1\n        ARM 0\n        DEFSHAPE 1\n        PT 0.000000 0.000000 1"
			repeat tapestpnum
				buf+="\n        PT "+str(double(c2ta(tapestp.cnt.0))/1000)+" 1.000000 1"
				buf+="\n        PT "+str(double(c2ta(tapestp.cnt.0+tapestp.cnt.1))/1000)+" 0.000000 1"
			loop
			buf+="\n      >\n      <PARMENV 1 0.000000 1.000000\n        ACT 1\n        VIS 1\n        ARM 0\n        DEFSHAPE 1\n        PT 0.000000 0.000000 1"
			repeat tapestpnum
				buf+="\n        PT "+str(double(c2ta(tapestp.cnt.0))/1000)+" "+str(double(tapestp.cnt.2)/100)+" 1"
				buf+="\n        PT "+str(double(c2ta(tapestp.cnt.0+tapestp.cnt.1))/1000)+" 0.000000 1"
			loop
		}
		dim bitcr,131072,4
		bitcrnum=0
		repeat notenum
			if((note.cnt.0>3)&(note.cnt.3=14)){
				bitcr.bitcrnum.0=note.cnt.1
				bitcr.bitcrnum.1=note.cnt.2
				bitcr.bitcrnum.2=note.cnt.4
				bitcr.bitcrnum.3=-1
				bitcrnum++
			}
		loop
		repeat bitcrnum
			cnt2=cnt
			repeat bitcrnum
				if(cnt=cnt2):continue
				if((bitcr.cnt.0<=bitcr.cnt2.0+bitcr.cnt2.1)&(bitcr.cnt.0+bitcr.cnt.1>bitcr.cnt2.0+bitcr.cnt2.1)){
					bitcr.cnt2.3=bitcr.cnt.2
					break
				}
			loop
		loop
		if(bitcrnum>0){
			buf+="\n      >\n      \n      BYPASS 0\n      <VST \"VST: dblue Glitch v1.3 (dblue)\" \"dblue_Glitch_v1_3.dll\"\n        X1tHZO9e7f4CAAAAAQAAAAAAAAACAAAAAAAAAAIAAAABAAAAAAAAAA==\n        AgAAAAAAAADwCgAAAQAAAAAAAABQcm9ncmFtIDEAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAACAPgAAgD4AAIA+AACAPwAAgD8AAAAAAAAAAA==\n        AACAPwAAAD8AAAAAAACAPwAAgD8AAAA/AACAPwAAAD8AAAA/AACAPw==\n        AAAAPwAAAAAAAAA/AAAAAAAAgD4AAAAAzcxMPQAAAAAAAAA/AAAAPw==\n        AACAPwAAAD8AAAAAAAAAPwAAAADNzMw8AACAPwAAAADNzEw+AAAAPw==\n        AAAAPwAAAAAAAAA/AAAAAAAAAD8AAAAAAAAAACh9Mj8AAAA/AAAAPw==\n        AAAAPwAAAD8AAIA/AAAAPwAAAAAAAAA/AAAAAOxROD+F61E/AAAAPw==\n        AACAPwAAAD8AAAA/AACAPwAAAD8AAAAAAAAAPwAAAAAAAAAAAAAAPw==\n        AAAAAAAAAAAAAAA/AAAAPwAAgD8AAAA/AAAAAAAAAD8AAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAPwAAAD8AAIA/AAAAPwAAAAAAAAA/AAAAAA==\n        AAAAAAAAAD8AAIA/AAAAAAAAAD8AAAA/AACAPwAAAD8AAAAAAAAAPw==\n        AAAAAArXIz0AAEA/AABAPwAAAD8AAAA/AAAAPwAAgD8AAAA/AAAAAA==\n        AAAAPwAAAADNzMw+AAAAPgAAgD4AAAAAAAAAPwAAAD8AAIA/AAAAPw==\n        AAAAAAAAAD8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD8AAAA/AACAPw==\n        AAAAPwAAAAAAAAA/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/AAAAPw==\n        AACAPwAAAD8AAAAAAAAAPwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPw==\n        AAAAPwAAgD8AAAA/AAAAAAAAAD8AAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAACwAAAAAAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAA==\n        AAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQABAAEAAQ==\n        AAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQ==\n        AAEAAQABAAEAAQABAAEAAQABAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQ==\n        AQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQ==\n        AQEAAAAAAAAAAQAAAAAAAAABAAAAAAAAAAEAAAAAAAAAAQAAAAAAAA==\n        AAEAAAAAAAAAAQAAAAAAAAABAAAAAAAAAAEAAAABAAAAAQABAAEBAQ==\n        AAEAAAABAAAAAQABAAEBAQABAAAAAQAAAAEAAQABAQEAAQAAAAEAAA==\n        AAEAAQABAQEAAQAAAAEAAQAAAQAAAQAAAAEAAAABAAEAAAEAAAEAAA==\n        AAEAAAABAAEAAAEAAAEAAAABAAAAAQABAAABAAABAAAAAQAAAAAAAQ==\n        AAAAAAABAAAAAAABAAAAAAABAAAAAAABAAAAAAABAAAAAAABAAAAAA==\n        AAEAAAAAAAEAAAAAAAEAAAABAAABAAABAAABAAABAAABAAABAAABAA==\n        AAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAA==\n        AQEAAAEAAAEAAQAAAQAAAQABAAABAAABAAEAAAEAAAEAAQAAAQAAAQ==\n        AAEAAAEAAAEAAQAAAQAAAQABAAABAAABAAEAAAEAAQABAQEAAQABAA==\n        AAEAAAEAAQABAQEAAQABAAABAAABAAEAAQEBAAEAAQAAAQAAAQABAA==\n        AQEBAAEAAQAAAQEAAQAAAQABAQABAAABAAEBAAEAAAEAAQEAAQAAAQ==\n        AAEBAAEAAAEAAQEAAQAAAQABAQABAAABAAEBAAEAAAEAAQABAAEAAA==\n        AQAAAQABAAAAAQABAAEAAAEAAAEAAQAAAAEAAQABAAABAAABAAEAAA==\n        AAEAAQABAAABAAABAAEAAAABAAAAAQAAAAEAAQAAAQAAAQAAAAEAAA==\n        AAEAAQAAAQAAAQAAAAEAAAABAAEAAAEAAAEAAAABAAAAAQABAAABAA==\n        AAEAAQAAAQABAAABAAEAAQABAAEAAAEAAQAAAQABAAEAAQABAAABAA==\n        AQAAAQABAAEAAQABAAABAAEAAAEAAQABAAEAAAABAQEBAAABAAEBAA==\n        AAEAAAABAQEBAAABAAEBAAABAAAAAQEBAQAAAQABAQAAAQAAAAEBAQ==\n        AQAAAQABAQAAAQEAAQAAAQABAAEBAAABAAEBAAEAAAEAAQABAQAAAQ==\n        AAEBAAEAAAEAAQABAQAAAQABAQABAAABAAEAAQEAAAEABf///////w==\n        /////////////////////////////////wgAAAAAAAACAf///////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        //8AAQEBAQEBAQEBAQEBAQEBAQEAAAAAAAEAAAABATYAAIA//////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        ////////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAA0=\n      >\n      <PARMENV 9 0.000000 1.000000\n        ACT 1\n        VIS 1\n        ARM 0\n        DEFSHAPE 1\n        PT 0.000000 0.000000 1"
			repeat bitcrnum
				buf+="\n        PT "+str(double(c2ta(bitcr.cnt.0))/1000)+" "+str(double(bitcr.cnt.2)/64)+" 1"
				if(bitcr.cnt.3=-1){
					buf+="\n        PT "+str(double(c2ta(bitcr.cnt.0+bitcr.cnt.1))/1000)+" 0.000000 1"
				}else{
					buf+="\n        PT "+str(double(c2ta(bitcr.cnt.0+bitcr.cnt.1))/1000)+" "+str(double(bitcr.cnt.3)/64)+" 1"
				}
			loop
		}
		buf+="\n      >\n      \n      BYPASS 0\n      <VST \"VST: dblue Glitch v1.3 (dblue)\" \"dblue_Glitch_v1_3.dll\"\n        X1tHZO9e7f4CAAAAAQAAAAAAAAACAAAAAAAAAAIAAAABAAAAAAAAAA==\n        AgAAAAAAAADwCgAAAQAAAAAAAABQcm9ncmFtIDEAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAACAPgAAgD4AAIA+AACAPwAAgD8AAAAAAAAAAA==\n        AACAPwAAAD8AAAAAAACAPwAAgD8AAAA/AACAPwAAAD8AAAA/AACAPw==\n        AAAAPwAAAAAAAAA/AAAAAAAAgD4AAAAAzcxMPQAAAAAAAAA/AAAAPw==\n        AACAPwAAAD8AAAAAAAAAPwAAAADNzMw8AACAPwAAAADNzEw+AAAAPw==\n        AAAAPwAAgD8AAAA/AAAAAAAAAD8AAAAAAAAAAAAAgD8AAAA/AAAAPw==\n        AAAAPwAAAD9hC7Y7AAAAPwAAAAAAAAA/AAAAAOxROD+F61E/AAAAPw==\n        AACAPwAAAD8AAAA/AACAPwAAAD8AAAAAAAAAPwAAAAAAAAAAAAAAPw==\n        AAAAAAAAAAAAAAA/AAAAPwAAgD8AAAA/AAAAAAAAAD8AAAAAmpmZPQ==\n        AAAAAAAAAAAAAAAAAAAAPwAAAD8AAIA/AAAAPwAAAAAAAAA/AAAAAA==\n        AACAPgAAAD8ofdI9AAAAAAAAAD8AAAA/AACAPwAAAD8AAAAAAAAAPw==\n        AAAAAArXIz0AAEA/AABAPwAAAD8AAAA/AAAAPwAAgD8AAAA/AAAAAA==\n        AAAAPwAAAADNzMw+AAAAPgAAgD4AAAAAAAAAPwAAAD8AAIA/AAAAPw==\n        AAAAAAAAAD8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD8AAAA/AACAPw==\n        AAAAPwAAAAAAAAA/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/AAAAPw==\n        AACAPwAAAD8AAAAAAAAAPwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPw==\n        AAAAPwAAgD8AAAA/AAAAAAAAAD8AAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAACwAAAAAAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAA==\n        AAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQABAAEAAQ==\n        AAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQ==\n        AAEAAQABAAEAAQABAAEAAQABAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQ==\n        AQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQ==\n        AQEAAAAAAAAAAQAAAAAAAAABAAAAAAAAAAEAAAAAAAAAAQAAAAAAAA==\n        AAEAAAAAAAAAAQAAAAAAAAABAAAAAAAAAAEAAAABAAAAAQABAAEBAQ==\n        AAEAAAABAAAAAQABAAEBAQABAAAAAQAAAAEAAQABAQEAAQAAAAEAAA==\n        AAEAAQABAQEAAQAAAAEAAQAAAQAAAQAAAAEAAAABAAEAAAEAAAEAAA==\n        AAEAAAABAAEAAAEAAAEAAAABAAAAAQABAAABAAABAAAAAQAAAAAAAQ==\n        AAAAAAABAAAAAAABAAAAAAABAAAAAAABAAAAAAABAAAAAAABAAAAAA==\n        AAEAAAAAAAEAAAAAAAEAAAABAAABAAABAAABAAABAAABAAABAAABAA==\n        AAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAA==\n        AQEAAAEAAAEAAQAAAQAAAQABAAABAAABAAEAAAEAAAEAAQAAAQAAAQ==\n        AAEAAAEAAAEAAQAAAQAAAQABAAABAAABAAEAAAEAAQABAQEAAQABAA==\n        AAEAAAEAAQABAQEAAQABAAABAAABAAEAAQEBAAEAAQAAAQAAAQABAA==\n        AQEBAAEAAQAAAQEAAQAAAQABAQABAAABAAEBAAEAAAEAAQEAAQAAAQ==\n        AAEBAAEAAAEAAQEAAQAAAQABAQABAAABAAEBAAEAAAEAAQABAAEAAA==\n        AQAAAQABAAAAAQABAAEAAAEAAAEAAQAAAAEAAQABAAABAAABAAEAAA==\n        AAEAAQABAAABAAABAAEAAAABAAAAAQAAAAEAAQAAAQAAAQAAAAEAAA==\n        AAEAAQAAAQAAAQAAAAEAAAABAAEAAAEAAAEAAAABAAAAAQABAAABAA==\n        AAEAAQAAAQABAAABAAEAAQABAAEAAAEAAQAAAQABAAEAAQABAAABAA==\n        AQAAAQABAAEAAQABAAABAAEAAAEAAQABAAEAAAABAQEBAAABAAEBAA==\n        AAEAAAABAQEBAAABAAEBAAABAAAAAQEBAQAAAQABAQAAAQAAAAEBAQ==\n        AQAAAQABAQAAAQEAAQAAAQABAAEBAAABAAEBAAEAAAEAAQABAQAAAQ==\n        AAEBAAEAAAEAAQABAQAAAQABAQABAAABAAEAAQEAAAEABv///////w==\n        /////////////////////////////////wgAAAAAAAACAf///////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        //8AAQEBAQEBAQEBAQEBAQEBAQAAAAAAAAAAAAABATYAAIA//////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        ////////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAA0=\n      >\n      <PARMENV 3 0.000000 1.000000\n        ACT 1\n        VIS 1\n        ARM 0\n        DEFSHAPE 1\n        PT 0.000000 0.000000 1"
		dim gater,131072,4
		gaternum=0
		repeat notenum
			if((note.cnt.0>3)&((note.cnt.3>=6)&(note.cnt.3<=11))){
				cnt2=cnt
				gater.gaternum.0=note.cnt2.1
				gater.gaternum.1=note.cnt2.2
				gater.gaternum.2=note.cnt2.3-6
				gater.gaternum.3=-1
				gaternum++
			}
		loop
		repeat gaternum
			cnt2=cnt
			repeat gaternum
				if(cnt=cnt2):continue
				if((gater.cnt.0<=gater.cnt2.0+gater.cnt2.1)&(gater.cnt.0+gater.cnt.1>gater.cnt2.0+gater.cnt2.1)){
					gater.cnt2.3=gater.cnt.2
					break
				}
			loop
		loop
		repeat gaternum
			if(gater.cnt.1>UNIT_MEASURE/32){
				buf+="\n        PT "+str(double(c2ta(gater.cnt.0))/1000)+" 1.000000 1"
				if(gater.cnt.3=-1):buf+="\n        PT "+str(double(c2ta(gater.cnt.0+gater.cnt.1))/1000)+" 0.000000 1"
			}
		loop
		if(gater.0.2=0){
			stat1="0.000000"
		}else:if(gater.0.2=1){
			stat1="0.125000"
		}else:if(gater.0.2=2){
			stat1="0.187500"
		}else:if(gater.0.2=3){
			stat1="0.250000"
		}else:if(gater.0.2=4){
			stat1="0.375000"
		}else{
			stat1="0.500000"
		}
		buf+="\n      >\n      <PARMENV 11 0.000000 1.000000\n        ACT 1\n        VIS 1\n        ARM 0\n        DEFSHAPE 1\n        PT 0.000000 "+stat1+" 1"
		repeat gaternum
			if(gater.cnt.2=0){
				stat1="0.000000"
			}else:if(gater.cnt.2=1){
				stat1="0.125000"
			}else:if(gater.cnt.2=2){
				stat1="0.187500"
			}else:if(gater.cnt.2=3){
				stat1="0.250000"
			}else:if(gater.cnt.2=4){
				stat1="0.375000"
			}else{
				stat1="0.500000"
			}
			if(gater.cnt.3=0){
				stat2="0.000000"
			}else:if(gater.cnt.3=1){
				stat2="0.125000"
			}else:if(gater.cnt.3=2){
				stat2="0.187500"
			}else:if(gater.cnt.3=3){
				stat2="0.250000"
			}else:if(gater.cnt.3=4){
				stat2="0.375000"
			}else{
				stat2="0.500000"
			}
			buf+="\n        PT "+str(double(max(c2ta(gater.cnt.0)-20,0))/1000)+" "+stat1+" 1"
			if(gater.cnt.3!=-1):buf+="\n        PT "+str(double(max(c2ta(gater.cnt.0+gater.cnt.1)-20,0))/1000)+" "+stat2+" 1"
		loop
		dim flanger,131072,2
		flangernum=0
		repeat notenum
			if((note.cnt.0>3)&(note.cnt.3=12)){
				f=0
				cnt2=cnt
				repeat flangernum
					if((flanger.cnt.0<=note.cnt2.1)&(flanger.cnt.0+flanger.cnt.1>=note.cnt2.1+note.cnt2.2)):f=1
					if((flanger.cnt.0+flanger.cnt.1>=note.cnt2.1)&(flanger.cnt.0+flanger.cnt.1<=note.cnt2.1+note.cnt2.2)){
						flanger.cnt.1+=(note.cnt2.1+note.cnt2.2)-(flanger.cnt.0+flanger.cnt.1)
						f=1
					}
					if(f=1):break
				loop
				if(f=0){
					flanger.flangernum.0=note.cnt.1
					flanger.flangernum.1=note.cnt.2
					flangernum++
				}
			}
		loop
		if(flangernum>0){
			buf+="\n      >\n      BYPASS 0\n      <VST \"VST: TAL Flanger - TAL (TAL - Togu Audio Line)\" \"TAL-Flanger.dll\"\n        djQzM+9e7f4CAAAAAQAAAAAAAAACAAAAAAAAAAIAAAABAAAAAAAAAA==\n        AgAAAAAAAABsBAAAAQAAAAQAAABFeHRyZW1lIEZsYW5nZXIAAAAAAA==\n        AAAAAAAAAACGLbg+AAAAQArXAz8ehes+AAAAAIXrET8AAAAAsnAmPw==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAACAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=\n      >\n      <PARMENV 7 0.000000 1.000000\n        ACT 1\n        VIS 1\n        ARM 0\n        DEFSHAPE 1\n        PT 0.000000 0.000000 1"
			repeat flangernum
				buf+="\n        PT "+str(double(c2ta(flanger.cnt.0))/1000)+" 1.000000 1"
				buf+="\n        PT "+str(double(c2ta(flanger.cnt.0+flanger.cnt.1))/1000)+" 0.000000 1"
			loop
		}
		dim phaser,131072,2
		phasernum=0
		repeat notenum
			if((note.cnt.0>3)&(note.cnt.3=15)){
				f=0
				cnt2=cnt
				repeat phasernum
					if((phaser.cnt.0<=note.cnt2.1)&(phaser.cnt.0+phaser.cnt.1>=note.cnt2.1+note.cnt2.2)):f=1
					if((phaser.cnt.0+phaser.cnt.1>=note.cnt2.1)&(phaser.cnt.0+phaser.cnt.1<=note.cnt2.1+note.cnt2.2)){
						phaser.cnt.1+=(note.cnt2.1+note.cnt2.2)-(phaser.cnt.0+phaser.cnt.1)
						f=1
					}
					if(f=1):break
				loop
				if(f=0){
					phaser.phasernum.0=note.cnt.1
					phaser.phasernum.1=note.cnt.2
					phasernum++
				}
			}
		loop
		if(phasernum>0){
			buf+="\n      >\n      BYPASS 0\n      \n      <VST \"VST: TAL Phaser - TAL (TAL - Togu Audio Line)\" \"TAL-Phaser.dll\"\n        MGc4be9e7f4CAAAAAQAAAAAAAAACAAAAAAAAAAIAAAABAAAAAAAAAA==\n        AgAAAAAAAABwBAAAAQAAAAUAAAA2IFN0YWdlIFBoYXNlcgAAAAAAAA==\n        AAAAAAAAAACqlwY/AABAQC3TLz+ei64+QlhbPwAAAEC89sk+AAAAAA==\n        u4s2PwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAkAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n      >\n      <PARMENV 8 0.000000 1.000000\n        ACT 1\n        VIS 1\n        ARM 0\n        DEFSHAPE 1\n        PT 0.000000 0.000000 1"
			repeat phasernum
				buf+="\n        PT "+str(double(c2ta(phaser.cnt.0))/1000)+" 0.750000 1"
				buf+="\n        PT "+str(double(c2ta(phaser.cnt.0+phaser.cnt.1))/1000)+" 0.000000 1"
			loop
		}
		dim sidechain,131072,2
		sidechainnum=0
		repeat notenum
			if((note.cnt.0>3)&(note.cnt.3=19)){
				f=0
				cnt2=cnt
				repeat sidechainnum
					if((sidechain.cnt.0<=note.cnt2.1)&(sidechain.cnt.0+sidechain.cnt.1>=note.cnt2.1+note.cnt2.2)):f=1
					if((sidechain.cnt.0+sidechain.cnt.1>=note.cnt2.1)&(sidechain.cnt.0+sidechain.cnt.1<=note.cnt2.1+note.cnt2.2)){
						sidechain.cnt.1+=(note.cnt2.1+note.cnt2.2)-(sidechain.cnt.0+sidechain.cnt.1)
						f=1
					}
					if(f=1):break
				loop
				if(f=0){
					sidechain.sidechainnum.0=note.cnt.1
					sidechain.sidechainnum.1=note.cnt.2
					sidechainnum++
				}
			}
		loop
		ddim scparam,2
		scparam.0=0.00f
		scparam.1=0.20f
		if(sidechainnum>0){
			buf+="\n      >\n      BYPASS 0\n      <VST \"VST: ReaComp (Cockos)\" \"reacomp.dll\"\n        bWNlcu9e7f4EAAAAAQAAAAAAAAACAAAAAAAAAAQAAAAAAAAACAAAAA==\n        AAAAAAIAAAABAAAAAAAAAAIAAAAAAAAARAAAAAAAAAAAAAAA776t3g==\n        DfCt3gAAgD8AAIA/j8J1Pa0yEz0AAAAAAAAAAAAAgD8AAAAAAAAAAA==\n        AAAAAAAAgDUAAIA/AAAAAAAAAAAAAAAA\n      >\n      <PARMENV 0 0.000000 1.000000\n        ACT 1\n        VIS 1\n        ARM 0\n        DEFSHAPE 0\n        PT 0.000000 1.000000 0"
			repeat sidechainnum
				stat1=c2ta(sidechain.cnt.0)
				stat3=sidechain.cnt.0
				buf+="\n        PT "+str(double(stat1)/1000)+" 1.000000 0"
				if(sidechain.cnt.0\(UNIT_MEASURE/4)<UNIT_MEASURE/8){
					stat2=str(double(UNIT_MEASURE/8-sidechain.cnt.0\(UNIT_MEASURE/4))*scparam.0/(UNIT_MEASURE/8)+double(sidechain.cnt.0\(UNIT_MEASURE/4))*scparam.1/(UNIT_MEASURE/8))
					buf+="\n        PT "+str(double(stat1)/1000)+" "+stat2+" 0"
					stat3=sidechain.cnt.0-sidechain.cnt.0\(UNIT_MEASURE/4)+UNIT_MEASURE/8
					if(stat3<sidechain.cnt.0+sidechain.cnt.1){
						stat1=c2ta(stat3)
						buf+="\n        PT "+str(double(stat1)/1000)+" "+str(scparam.1)+" 0"
					}
				}else{
					stat2=str(double(UNIT_MEASURE/4-sidechain.cnt.0\(UNIT_MEASURE/4))*scparam.1/(UNIT_MEASURE/8)+double(sidechain.cnt.0\(UNIT_MEASURE/4)-UNIT_MEASURE/8)/(UNIT_MEASURE/8))
					buf+="\n        PT "+str(double(stat1)/1000)+" "+stat2+" 0"
				}
				cnt_=cnt
				repeat
					stat3+=UNIT_MEASURE/8
					stat2=c2ta(stat3)
					if(sidechain.cnt_.0+sidechain.cnt_.1<stat3){
						break
					}
					buf+="\n        PT "+str(double(stat2)/1000)+" 1.000000 0"
					buf+="\n        PT "+str(double(stat2)/1000)+" "+str(scparam.0)+" 0"
					stat3+=UNIT_MEASURE/8
					stat2=c2ta(stat3)
					if(sidechain.cnt_.0+sidechain.cnt_.1<stat3){
						break
					}
					buf+="\n        PT "+str(double(stat2)/1000)+" "+str(scparam.1)+" 0"
				loop
				stat1=c2ta(sidechain.cnt.0+sidechain.cnt.1)
				if(sidechain.cnt.0\(UNIT_MEASURE/4)<UNIT_MEASURE/8){
					stat2=str(double(UNIT_MEASURE/8-(sidechain.cnt.0+sidechain.cnt.1)\(UNIT_MEASURE/4))*scparam.0/(UNIT_MEASURE/8)+double((sidechain.cnt.0+sidechain.cnt.1)\(UNIT_MEASURE/4))*scparam.1/(UNIT_MEASURE/8))
					buf+="\n        PT "+str(double(stat1)/1000)+" "+stat2+" 0"
				}else{
					stat2=str(double(UNIT_MEASURE/4-(sidechain.cnt.0+sidechain.cnt.1)\(UNIT_MEASURE/4))*scparam.1/(UNIT_MEASURE/8)+double((sidechain.cnt.0+sidechain.cnt.1)\(UNIT_MEASURE/4)-UNIT_MEASURE/8)/(UNIT_MEASURE/8))
					buf+="\n        PT "+str(double(stat1)/1000)+" "+stat2+" 0"
				}
				buf+="\n        PT "+str(double(stat1)/1000)+" 1.000000 0"
			loop
		}
		dim wobble,131072,2
		wobblenum=0
		repeat notenum
			if((note.cnt.0>3)&(note.cnt.3=16)){
				f=0
				cnt2=cnt
				repeat wobblenum
					if((wobble.cnt.0<=note.cnt2.1)&(wobble.cnt.0+wobble.cnt.1>=note.cnt2.1+note.cnt2.2)):f=1
					if((wobble.cnt.0+wobble.cnt.1>=note.cnt2.1)&(wobble.cnt.0+wobble.cnt.1<=note.cnt2.1+note.cnt2.2)){
						wobble.cnt.1+=(note.cnt2.1+note.cnt2.2)-(wobble.cnt.0+wobble.cnt.1)
						f=1
					}
					if(f=1):break
				loop
				if(f=0){
					wobble.wobblenum.0=note.cnt.1
					wobble.wobblenum.1=note.cnt.2
					wobblenum++
				}
			}
		loop
		if(wobblenum>0){
			buf+="\n      >\n      BYPASS 0\n      \n      <VST \"VST: Wobble effects(Blue Cat's Triple EQ (Stereo) (Blue Cat Audio))\" \"Blue Cat Triple EQ VST(Stereo).dll\"\n        Mno3NO9e7f4CAAAAAQAAAAAAAAACAAAAAAAAAAIAAAABAAAAAAAAAA==\n        AgAAAAAAAAClAwAAAQAAAAAAAAA8P3htbCB2ZXJzaW9uPSIxLjAiIA==\n        ZW5jb2Rpbmc9InV0Zi04IiA/PjxQcmVzZXQ+PHZlcnNpb24+Mjwvdg==\n        ZXJzaW9uPjxwcm9nTmFtZT5EZWZhdWx0PC9wcm9nTmFtZT48YnlwYQ==\n        c3M+MDwvYnlwYXNzPjxpbnB1dFBhcmFtcz48cGFyYW1Db3VudD42PA==\n        L3BhcmFtQ291bnQ+PHBhcmFtMD4wPC9wYXJhbTA+PHBhcmFtMT4yMQ==\n        ODcuMDAxOTUzMTwvcGFyYW0xPjxwYXJhbTI+MC4wMDk5OTk5OTk3Nw==\n        NjU8L3BhcmFtMj48cGFyYW0zPjQuNTAwMDAyODYxPC9wYXJhbTM+PA==\n        cGFyYW00PjA8L3BhcmFtND48cGFyYW01Pi0yMDwvcGFyYW01PjwvaQ==\n        bnB1dFBhcmFtcz48TUlESUlucHV0RGVmYXVsdD4xPC9NSURJSW5wdQ==\n        dERlZmF1bHQ+PE1JRElPdXRwdXREZWZhdWx0PjE8L01JRElPdXRwdQ==\n        dERlZmF1bHQ+PEdVST48dXNlRGVmYXVsdD4xPC91c2VEZWZhdWx0Pg==\n        PHZlcnNpb24+MjwvdmVyc2lvbj48c3RhdGU+PHBhcmFtU3RhdGVzPg==\n        PHBhcmFtQ291bnQ+MzwvcGFyYW1Db3VudD48cGFyYW0wPjxuYW1lPg==\n        YXV0b19saW5rLmVuYWJsZWQ8L25hbWU+PHZhbHVlPjA8L3ZhbHVlPg==\n        PC9wYXJhbTA+PHBhcmFtMT48bmFtZT5nbG9iYWxfb3BhY2l0eTwvbg==\n        YW1lPjx2YWx1ZT4xMDA8L3ZhbHVlPjwvcGFyYW0xPjxwYXJhbTI+PA==\n        bmFtZT55X3pvb208L25hbWU+PHZhbHVlPjI8L3ZhbHVlPjwvcGFyYQ==\n        bTI+PC9wYXJhbVN0YXRlcz48Y3VydmVTdGF0ZXM+PGN1cnZlQ291bg==\n        dD4wPC9jdXJ2ZUNvdW50PjwvY3VydmVTdGF0ZXM+PHN1cmZhY2VTdA==\n        YXRlcz48c3VyZmFjZUNvdW50PjA8L3N1cmZhY2VDb3VudD48L3N1cg==\n        ZmFjZVN0YXRlcz48c3RyaW5nU3RhdGVzPjxzdHJpbmdDb3VudD4wPA==\n        L3N0cmluZ0NvdW50Pjwvc3RyaW5nU3RhdGVzPjwvc3RhdGU+PC9HVQ==\n        ST48bW9kZWwgLz48QXV0b21hdGlvbk91dHB1dERlZmF1bHQ+MTwvQQ==\n        dXRvbWF0aW9uT3V0cHV0RGVmYXVsdD48L1ByZXNldD4A\n      >\n      <PARMENV 2 0.000000 1.000000\n        ACT 1\n        VIS 1\n        ARM 0\n        DEFSHAPE 0\n        PT 0.000000 0.000000 0"
			wobblepstat=""
			repeat wobblenum
				if(wobble.cnt.0\(UNIT_MEASURE/12)!=0){
					wobble.cnt.0=UNIT_MEASURE/12*wobble.cnt.0/(UNIT_MEASURE/12)+UNIT_MEASURE/12
				}
				stat1=c2ta(wobble.cnt.0)
				stat3=wobble.cnt.0
				cnt_=cnt
				f=0
				if(wobble.cnt.0\(UNIT_MEASURE/12)!=0){
					f=1
				}
				repeat
					stat3+=UNIT_MEASURE/24
					stat2=c2ta(stat3)
					if(wobble.cnt_.0+wobble.cnt_.1+UNIT_MEASURE/24<stat3){
						break
					}
					wobblepstat+="\n        PT "+str(double(stat1)/1000)+" 0.000000 0"
					wobblepstat+="\n        PT "+str(double(stat1+stat2)/2/1000)+" 0.150000 0"
					stat2_=c2ta(stat3+UNIT_MEASURE/24)
					wobblepstat+="\n        PT "+str(double(stat2)/1000)+" 0.750000 0"
					wobblepstat+="\n        PT "+str(double(stat2+stat2_)/2/1000)+" 0.150000 0"
					stat1=stat2
					stat3+=UNIT_MEASURE/24
					stat2=stat2_
					if(wobble.cnt_.0+wobble.cnt_.1<stat3){
						break
					}
					stat1=stat2
				loop
				wobblepstat+="\n        PT "+str(double(stat1)/1000)+" 0.750000 0"
				wobblepstat+="\n        PT "+str(double(stat1)/1000)+" 0.000000 0"
			loop
			buf+=wobblepstat
			buf+="\n      >\n      <PARMENV 7 0.000000 1.000000\n        ACT 1\n        VIS 1\n        ARM 0\n        DEFSHAPE 1\n        PT 0.000000 1.000000 1"
			repeat wobblenum
				f=0
				if(c2ta(wobble.cnt.0+wobble.cnt.1)-c2ta(wobble.cnt.0)>30):f=1
				buf+="\n        PT "+str(double(c2ta(wobble.cnt.0))/1000)+" 0.000000 1"
				buf+="\n        PT "+str(double(c2ta(wobble.cnt.0+wobble.cnt.1))/1000)+" 1.000000 1"
			loop
		}
		// 標準値を0かつ終端値を0にした配列を作成
		dim g,131072,7
		gnum=0
		dim shu,131072,2
		shunum=0
		repeat analognum
			f=1
			cnt2=cnt
			//repeat cnt2
			//	if((analog.cnt2.0!=analog.cnt.0)&(analog.cnt2.1=analog.cnt.1)&(analog.cnt2.2<=UNIT_MEASURE/32)&(analog.cnt.2<=UNIT_MEASURE/32)&(abs(analog.cnt2.4-50*analog.cnt2.0)=abs(analog.cnt.4-50*analog.cnt.0))):f=0:break
			//loop
			//if(f=0):continue
			f2=0
			/*if((analog.cnt.2<=UNIT_MEASURE/32)&(analog.cnt.2>0)&(analog.cnt.3!=analog.cnt.4)){
				f=1
				repeat analognum
					if((analog.cnt.1=analog.cnt2.1)&(analog.cnt.2<=UNIT_MEASURE/32)&(analog.cnt.0!=analog.cnt2.0)&(50*analog.cnt.0+analog.cnt.3*(1-analog.cnt.0*2)>50*analog.cnt2.0+analog.cnt2.3*(1-analog.cnt2.0*2))&(50*analog.cnt.0+analog.cnt.4*(1-analog.cnt.0*2)>50*analog.cnt2.0+analog.cnt2.4*(1-analog.cnt2.0*2))){
						f=0
						break
					}else:if(analog.cnt2.1<analog.cnt.1){
						break
					}
				loop
				if(f=0):continue
			}*//*
			if((analog.cnt.2<=UNIT_MEASURE/32)&(analog.cnt.2>0)&(analog.cnt.3!=analog.cnt.4)&(analog.cnt.5=1)){
				// 直角後に繋がっているものがあるか探索
				stattype=analog.cnt.0
				statpos=analog.cnt.1+analog.cnt.2
				f2=1
				repeat analognum
					if((analog.cnt.1=statpos)&(analog.cnt.0=stattype)&(analog.cnt.2>0)){
						f2=0
						break
					}
					if(analog.cnt.1>statpos):break
				loop
			}*/
			stat1=1
			if(f2=0){
				chofl=0
				repeat analognum-(cnt2+1),cnt2+1
					if((analog.cnt2.0=analog.cnt.0)&(analog.cnt2.1+analog.cnt2.2=analog.cnt.1)){
						stat1=0 // 後ろに繋がる物がある
						break
					}else:if(analog.cnt2.1+analog.cnt2.2<analog.cnt.1){
						break
					}
				loop
				repeat 5
					g.gnum.cnt=analog.cnt2.cnt
				loop
				repeat 2,1
					g.gnum.cnt*=36
				loop
				repeat 2,3
					g.gnum.cnt=20*g.gnum.cnt
				loop
				if(analog.cnt2.0=1){
					repeat 2,3
						g.gnum.cnt=1000-g.gnum.cnt
					loop
				}
				if(analog.cnt2.2<=UNIT_MEASURE/32){
					// stat1:後ろにつながるものがあるか(ある:0)
					if(stat1=0){
						if(analog.cnt2.5=1):g.gnum.3=0
						g.gnum.2=18
						g.gnum.5=2
						g.gnum.6=analog.cnt2.5
						f=1
						repeat gnum
							if((g.cnt.0!=g.gnum.0)&(g.cnt.1>g.gnum.1)):break
							//if((g.cnt.0!=g.gnum.0)&(g.cnt.1=g.gnum.1)&(g.cnt.5=2)&(g.cnt.3>g.gnum.3))://g.gnum.5=-1
							if((g.cnt.0!=g.gnum.0)&(g.cnt.1=g.gnum.1)&(g.cnt.5=2)&(g.cnt.4>g.gnum.4)):f=0
							//if((g.cnt.0!=g.gnum.0)&(g.cnt.1=g.gnum.1)&(g.cnt.5=2)&(g.cnt.3<g.gnum.3))://g.cnt.5=-1
							//if((g.cnt.0!=g.gnum.0)&(g.cnt.1=g.gnum.1)&(g.cnt.5=2)&(g.cnt.4<g.gnum.4))://g.(cnt+1).5=-1
							if((g.cnt.0!=g.gnum.0)&(g.cnt.1=g.gnum.1)&(g.cnt.5=2)&(g.cnt.3=g.gnum.3)&(g.cnt.6=1)&(g.gnum.6=1)):g.gnum.5=3
						loop
						gnum++
						repeat 5
							g.gnum.cnt=g.(gnum-1).cnt
						loop
						g.gnum.1+=18
						g.gnum.2=analog.cnt2.2*36-18
						g.gnum.3=g.gnum.4
						g.gnum.5=0
						if(f=0):g.gnum.5=-1
					}else:if(analog.cnt2.5=0){
						g.gnum.0=analog.cnt2.0
						g.gnum.1=analog.cnt2.1*36
						g.gnum.2=18
						g.gnum.3=20*analog.cnt2.3
						if(analog.cnt2.0=1){
							g.gnum.3=1000-g.gnum.3
						}
						g.gnum.4=0
						g.gnum.5=0
						gnum++
						g.gnum.0=analog.cnt2.0
						g.gnum.1=analog.cnt2.1*36+18
						g.gnum.2=18
						g.gnum.3=0
						g.gnum.4=0
						g.gnum.5=1
						stat1=0
					}else:stat1=0:chofl=1
				}else:if((analog.cnt2.5=1)&(g.gnum.3>0)){
					repeat 5
						g.(gnum+1).cnt=g.gnum.cnt
					loop
					g.(gnum+1).6=0
					g.gnum.2=18
					g.gnum.4=g.gnum.3
					g.gnum.3=0
					g.(gnum+1).1+=18
					g.(gnum+1).2-=18
					gnum++
				}
				if(stat1=1){
					gnum++
					g.gnum.0=analog.cnt2.0
					g.gnum.1=(analog.cnt2.1+analog.cnt2.2)*36
					g.gnum.2=18
					g.gnum.3=20*analog.cnt2.4
					g.gnum.4=0
					g.gnum.5=0
					if(analog.cnt2.0=1){
						g.gnum.3=1000-g.gnum.3
					}
					gnum++
					g.gnum.0=analog.cnt2.0
					g.gnum.1=(analog.cnt2.1+analog.cnt2.2)*36+18
					g.gnum.2=18
					g.gnum.3=0
					g.gnum.4=0
					g.gnum.5=1
				}
				if(chofl=0):gnum++
			}
		loop
		/*
		repeat gnum
			if(g.cnt.5=-1):continue
			if((g.cnt2.2=0)&(g.cnt.5=2)){
				cnt2=cnt
				repeat gnum
					if((g.cnt.1+g.cnt.2=g.cnt2.1)&(g.cnt.2>0)&(g.cnt.4>g.cnt2.3)){
						g.cnt2.3=g.cnt.4
					}
				loop
			}
		loop
		*//*
		↓ たぶん入れても大丈夫だけど一応コメントアウト
		repeat gnum
			cnt2=cnt
			repeat analognum
				if((g.cnt2.1=analog.cnt.1)&(analog.cnt.2<=UNIT_MEASURE/32)&(analog.cnt.4>0)&(g.cnt2.2=0)&(g.cnt2.3=0)&(g.cnt2.4=0)){
					g.cnt2.5=-1
				}
			loop
		loop*/
		// 配列をソート
		dim g2,gnum,7
		g2num=0
		repeat
			if(g2num>=gnum):break
			minval=-1
			mincnt=-1
			repeat gnum
				if(g.cnt.5=-1):continue
				if(((g.cnt.1<minval)|(minval=-1))&(g.cnt.1!=-1)){
					mincnt=cnt
					minval=g.cnt.1
				}
			loop
			if(mincnt!=-1){
				repeat 7
					g2.g2num.cnt=g.mincnt.cnt
				loop
				g.mincnt.1=-1
				g2num++
			}else:break
		loop
		repeat g2num
			cnt2=cnt
			repeat 7
				g.cnt2.cnt=g2.cnt2.cnt
			loop
		loop
		gnum=g2num
		repeat
			stat1=0
			repeat max(gnum-1,0)
				if((g.cnt.1=g.(cnt+1).1)&(g.cnt.2>g.(cnt+1).2)){
					dim g3,7
					g3=g.cnt.0,g.cnt.1,g.cnt.2,g.cnt.3,g.cnt.4,g.cnt.5,g.cnt.6
					cnt2=cnt
					repeat 7
						g.cnt2.cnt=g.(cnt2+1).cnt
					loop
					repeat 7
						g.(cnt2+1).cnt=g3.cnt
					loop
					stat1++
				}
			loop
			if(stat1=0):break
		loop
		repeat
			stat1=0
			repeat max(gnum-1,0)
				if((g.cnt.1=g.(cnt+1).1)&(g.cnt.5=1)&(g.(cnt+1).5!=1)){
					dim g3,7
					g3=g.cnt.0,g.cnt.1,g.cnt.2,g.cnt.3,g.cnt.4,g.cnt.5,g.cnt.6
					cnt2=cnt
					repeat 7
						g.cnt2.cnt=g.(cnt2+1).cnt
					loop
					repeat 7
						g.(cnt2+1).cnt=g3.cnt
					loop
					stat1++
				}
			loop
			if(stat1=0):break
		loop
		/*
		if(gnum!=g2num){
			dialog "内部エラー\n 値の個数が不一致("+gnum+"≠"+g2num+")\n ピークフィルタの値が正常に書き出されない可能性があります"
		}*/
		stat1=0
		repeat max(gnum-2,0)
			if((g.(cnt-stat1).0!=g.((cnt-stat1)+2).0)&(g.(cnt-stat1).2=18)&(g.((cnt-stat1)+2).2=18)/*&(g.(cnt-stat1).3=0)*/&(g.((cnt-stat1)+2).3=0)&(g.((cnt-stat1)+2).4=0)&(g.(cnt-stat1).1=g.((cnt-stat1)+2).1-18)){
				ardel2 g,gnum,length2(g),(cnt-stat1)+2
				stat1++
			}
		loop
		dim pichu,131072,2
		pichunum=0
		// 交点を列挙
		innum=0
		dim in,131072,3
		repeat gnum
			cnt2=cnt
			repeat gnum
				// cstat:交点のx座標(カウント値)
				if(g.cnt.0=g.cnt2.0){
					continue
				}/*
				if(g.cnt.0!=g.cnt2.0){
					if((g.cnt.1=g.cnt2.1)&(g.cnt.3=g.cnt2.3)&(g.cnt.2+g.cnt2.2=0)){
						in.innum.0=g.cnt.1
						in.innum.1=g.cnt.3
						innum++
						continue
					}
				}*/
				if(g.cnt.2+g.cnt2.2=0):continue
				if((g.cnt.3>g.cnt2.3)&(g.cnt.4>g.cnt2.4)):continue
				if((g.cnt.3<g.cnt2.3)&(g.cnt.4<g.cnt2.4)):continue
				ddim cstat,1
				if(g.cnt2.2*(g.cnt.4-g.cnt.3)-g.cnt.2*(g.cnt2.4-g.cnt2.3)=0){
					if((g.cnt.4-g.cnt.3!=0)|(g.cnt2.4-g.cnt2.3!=0)){
						if(g.cnt.2=0){
							cstat=g.cnt.1
						}else:if(g.cnt2.2=0){
							cstat=g.cnt2.1
						}else:continue
					}else:continue
				}else{
					cstat=double(g.cnt.2)*g.cnt2.2*(g.cnt2.3-g.cnt.3)-double(g.cnt.2)*(g.cnt2.4-g.cnt2.3)*g.cnt2.1+double(g.cnt2.2)*(g.cnt.4-g.cnt.3)*g.cnt.1
					cstat/=g.cnt2.2*(g.cnt.4-g.cnt.3)-g.cnt.2*(g.cnt2.4-g.cnt2.3)
				}
				if((((cstat>g.cnt2.1)&(cstat<g.cnt2.1+g.cnt2.2))|((cstat=g.cnt2.1)&((g.cnt.2=0)|(g.cnt2.2=0))|((cstat=g.cnt2.1+g.cnt2.2)&(g.cnt.2=0)))|((cstat=g.cnt.1+g.cnt.2)&(g.cnt2.2=0)))&(((cstat>g.cnt.1)&(cstat<g.cnt.1+g.cnt.2))|((cstat=g.cnt.1)&((g.cnt.2=0)|(g.cnt2.2=0)))|((cstat=g.cnt.1+g.cnt.2)&(g.cnt2.2=0)))){
					in.innum.0=int(cstat)
					f=1
					repeat innum
						if(in.(innum-cnt-1).0=cstat):f=0:break
					loop
					if(g.cnt.2>0){
						in.innum.1=(g.cnt.4-g.cnt.3)*(cstat-g.cnt.1)/g.cnt.2+g.cnt.3
						if((g.cnt2.2<=UNIT_MEASURE/32)&(g.cnt2.3!=g.cnt2.4)){
							if(g.cnt2.4<g.cnt2.3){
								in.innum.2=1
							}else{
								in.innum.2=2
							}/*
							pichu.pichunum.0=1
							pichu.pichunum.1=c2ta(g.cnt2.1)
							pichunum++*/
						}
						//if((g.cnt2.2=0)&((g.cnt.2>6)|(g.cnt.3!=g.cnt.4)|(g.cnt.3!=g.cnt2.4))):in.innum.3=1
					}else:if(g.cnt2.2>0){
						in.innum.1=(g.cnt2.4-g.cnt2.3)*(cstat-g.cnt2.1)/g.cnt2.2+g.cnt2.3
						if((g.cnt.2<=UNIT_MEASURE/32)&(g.cnt.3!=g.cnt.4)){
							if(g.cnt.4<g.cnt.3){
								in.innum.2=1
							}else{
								in.innum.2=2
							}/*
							pichu.pichunum.0=1
							pichu.pichunum.1=c2ta(g.cnt.1)
							pichunum++*/
						}
						//if((g.cnt.2=0)&((g.cnt2.2>6)|(g.cnt2.3!=g.cnt2.4)|(g.cnt2.3!=g.cnt.4))):in.innum.3=1
					}else:continue
					if((f=1)&(in.innum.1>0)&(in.innum.1<1000)):innum++
				}
			loop
		loop
		// 交点以外の点を列挙
		pnum=0
		dim p,131072,3
		dim anaend,analognum
		repeat analognum
			if((analog.cnt.5=1)&(cnt>0)){
				for i,cnt-1,-1,-1
					if(analog.cnt.0=analog.i.0):anaend.i=1:_break
				next
			}
		loop
		repeat gnum
			stat_1=g.cnt.1
			stat1=-1
			cnt2=cnt
			repeat gnum
				if((g.cnt.0!=g.cnt2.0)&(((g.cnt.1+g.cnt.2=stat_1)&(g.cnt2.5!=1)&(g.cnt.5!=1)&((g.cnt2.2>UNIT_MEASURE/32)|(g.cnt2.3!=g.cnt2.4)|(g.cnt2.2=0)))|(g.cnt.1+g.cnt.2>stat_1))&(((g.cnt.1=stat_1)&(g.cnt2.5!=1)&(g.cnt.5!=1))|(g.cnt.1<stat_1))){
					if(g.cnt.2>0){
						stat1=(g.cnt.4-g.cnt.3)*(stat_1-g.cnt.1)/g.cnt.2+g.cnt.3
					}else{
						stat1=g.cnt.4
					}
					break
				}
			loop
			f=1
			/*
			if(g.cnt2.5=1){
				repeat analognum
					if((g.cnt2.1>=analog.cnt.1)&(g.cnt2.1<analog.cnt.1+analog.cnt.2)&((anaend.cnt=1)|(analog.cnt.2>UNIT_MEASURE/32))):f=0:break
				loop
			}*/
			if((g.cnt2.2=0)&(g.cnt2.3=0)&(g.cnt2.4=0)){
				repeat gnum
					if((g.(gnum-cnt-1).5=2)&(g.(gnum-cnt-1).1=g.cnt2.1)&(g.(gnum-cnt-1).0!=g.cnt2.0)){
						f=0
						break
					}
				loop
			}
			if((f=1)&((g.cnt.3>=stat1)|(g.cnt.5=3))){
				p.pnum.0=g.cnt.1
				p.pnum.1=g.cnt.3
				p.pnum.2=g.cnt.5/*
				if(g.cnt.2<=UNIT_MEASURE/32){
					pichu.pichunum.0=1
					pichu.pichunum.1=c2ta(g.cnt.1)
					pichunum++
				}*/
				f=1
				cnt2=cnt
				if(p.pnum.1=0){
					repeat analognum
						if((analog.(analognum-cnt-1).0=1-g.cnt2.0)&(analog.(analognum-cnt-1).1=p.pnum.0)&(analog.(analognum-cnt-1).2>UNIT_MEASURE/32)&(analog.(analognum-cnt-1).3!=analog.(analognum-cnt-1).0*50)){
							f=0
							break
						}
					loop
				}
				if(f=1):pnum++
			}
		loop
		repeat shunum
			stat_1=shu.cnt.1
			stat1=-1
			cnt2=cnt
			repeat gnum
				if((g.cnt.0=1-shu.cnt2.0)&(g.cnt.1<=stat_1)&(g.cnt.1+g.cnt.2>stat_1)){
					if(g.cnt.2!=0){
						stat1=(g.cnt.4-g.cnt.3)*(stat_1-g.cnt.1)/g.cnt.2+g.cnt.3
					}else{
						stat1=g.cnt.4
					}
					break
				}
			loop
			if(g.cnt.3<stat1){
				shu.cnt2.0=-1
			}
		loop
		// 結果的に必要となる点を列挙
		dim refp,131072,3
		refpnum=1 : refpcp=0 : infcnt=0 : pfcnt=0
		dim refpp,2
		repeat 16777216
			stat1=0
			stat2=0
			if(((in.infcnt.0<=p.pfcnt.0)|(pfcnt>=pnum))&(infcnt<innum)){
				stat1=1
			}
			if(((in.infcnt.0>=p.pfcnt.0)|(infcnt>=innum))&(pfcnt<pnum)){
				stat2=1
			}
			if((infcnt<innum)&(pfcnt<pnum)&(stat1+stat2=2)){
				if((in.infcnt.0=p.pfcnt.0)&(in.infcnt.2=1)):stat1=0
				//if((in.infcnt.0=p.pfcnt.0)&(in.infcnt.2=2)):stat2=0
			}
			if(stat1+stat2=0):break
			if((stat1=1)&(in.infcnt.2=2)){
				f=1
				if(refpnum>0){
					if(refp.(refpnum-1).0>in.infcnt.0):f=0
				}
				if(refpnum>1){
					if((refp.(refpnum-1).0=in.infcnt.0)&(refp.(refpnum-2).0=in.infcnt.0)):f=0
				}
				if((f=1)&((in.infcnt.0!=refpp.0)|(in.infcnt.1!=refpp.1))){
					refp.refpnum.0=in.infcnt.0
					refp.refpnum.1=in.infcnt.1
					refp.refpnum.2=0
					if(refp.refpnum.0/36=refpp.0/36){
						pichu.pichunum.0=1
						pichu.pichunum.1=c2ta(refp.refpnum.0/36)
						pichunum++
					}
					refpp=refp.refpnum.0,refp.refpnum.1
					refpnum++
					refpcp=in.infcnt.0
				}
			}
			if(stat2=1){
				f=1
				if(refpnum>0){
					if(refp.(refpnum-1).0>p.pfcnt.0):f=0
				}
				if(refpnum>1){
					//if((refp.(refpnum-1).0=p.pfcnt.0)&(refp.(refpnum-2).0=p.pfcnt.0)&(refp.(refpnum-1).1>0)&(refp.(refpnum-2).1=0)&(p.pfcnt.1=0)):f=0
					if((refp.(refpnum-1).0=p.pfcnt.0)&(refp.(refpnum-2).0=p.pfcnt.0)):f=0
				}
				if((f=1)&((p.pfcnt.0!=refpp.0)|(p.pfcnt.1!=refpp.1))){
					refp.refpnum.0=p.pfcnt.0
					refp.refpnum.1=p.pfcnt.1
					refp.refpnum.2=1
					if(refp.refpnum.0/36=refpp.0/36){
						pichu.pichunum.0=1
						pichu.pichunum.1=c2ta(refp.refpnum.0/36)
						pichunum++
					}
					refpp=refp.refpnum.0,refp.refpnum.1
					refpnum++
					refpcp=p.pfcnt.0
				}
			}
			if((stat1=1)&(in.infcnt.2!=2)){
				f=1
				if(refpnum>0){
					if(refp.(refpnum-1).0>in.infcnt.0):f=0
				}
				if(refpnum>1){
					if((refp.(refpnum-1).0=in.infcnt.0)&(refp.(refpnum-2).0=in.infcnt.0)):f=0
				}
				if((f=1)&((in.infcnt.0!=refpp.0)|(in.infcnt.1!=refpp.1))){
					refp.refpnum.0=in.infcnt.0
					refp.refpnum.1=in.infcnt.1
					refp.refpnum.2=0
					if(refp.refpnum.0/36=refpp.0/36){
						pichu.pichunum.0=1
						pichu.pichunum.1=c2ta(refp.refpnum.0/36)
						pichunum++
					}
					refpp=refp.refpnum.0,refp.refpnum.1
					refpnum++
					refpcp=in.infcnt.0
				}
			}
			if(stat2=1){
				pfcnt++
			}
			if(stat1=1){
				infcnt++
			}
		loop
		repeat refpnum
			refp.cnt.0/=36
		loop/*
		bbuf="//g\n"
		repeat gnum
			bbuf+=" "+g.cnt.0+",\t"+g.cnt.1+",\t"+g.cnt.2+",\t"+g.cnt.3+",\t"+g.cnt.4+"\n"
		loop
		bbuf+="\n//in (交点)\n"
		repeat innum
			bbuf+=" "+in.cnt.0+",\t"+in.cnt.1+",\t"+in.cnt.2+"\n"
		loop
		bbuf+="\n//p (交点以外)\n"
		repeat pnum
			bbuf+=" "+p.cnt.0+",\t"+p.cnt.1+"\n"
		loop
		bbuf+="\n//refp (結果的に必要となる点)\n"
		repeat refpnum
			if(refp.cnt.2=0){
				bbuf+=" "+refp.cnt.0+",\t"+refp.cnt.1+",\t"+"in"+"\n"
			}else{
				bbuf+=" "+refp.cnt.0+",\t"+refp.cnt.1+",\t"+"p "+"\n"
			}
		loop
		notesel bbuf
		notesave "c:\\test.txt"
		notesel buf*/
		
		// 配列を文字列に変換
		/*buf+="\n      >\n      BYPASS 0\n      <VST \"VST: TDAe MP5D (TDA)\" \"TDAe MP5D.dll\"\n        QURUKu9e7f4CAAAAAQAAAAAAAAACAAAAAAAAAAIAAAABAAAAAAAAAA==\n        AgAAAAAAAABIAAAAAQAAAAAAAADCnCU+AACAP0MyAD8AAIA/AAAAAA==\n        AAAAAAAAgEAAAIA/AAAAAAAAAABkZWZhdWx0ADA7DQppbmMgW2VheA==\n        XTsNCgAAAAAAAAAA\n      >\n      <PARMENV 3 0.000000 1.000000\n        ACT 1\n        VIS 1\n        ARM 0\n        DEFSHAPE 0\n        PT 0.000000 0.400000 0"
		repeat innum
			cnt2=cnt
			f=0
			/*repeat cnt
				if((in.cnt.0=in.cnt2.0)&(in.cnt.1=in.cnt2.1)):f=1
			loop*_/
			if(f=1):continue
			buf+="\n        PT "+str(double(c2ta(in.cnt2.0))/1000)+" "+str(0.4+double(in.cnt.1)/2000)+" 0"
		loop
		repeat pnum
			cnt2=cnt
			f=0
			/*repeat innum
				if((in.cnt.0=in.cnt2.0)&(p.cnt2.1=p.cnt2.1)):f=1
			loop*/
			/*repeat cnt
				if((p.cnt.0=p.cnt2.0)&(p.cnt2.1=p.cnt2.1)):f=1
			loop*_/
			if(f=1):continue
			buf+="\n        PT "+str(double(c2ta(p.cnt.0))/1000)+" "+str(0.4+double(p.cnt.1)/2000)+" 0"
		loop
		*/
		/*repeat refpnum
			buf+="\n        PT "+str(double(c2ta(refp.cnt.0))/1000)+" "+str(0.4+double(refp.cnt.1)/2000)+" 0"
		loop*/
		/*
		buf+="\n      >\n      BYPASS 0\n      <VST \"VST: BC Triple EQ 4 (Stereo) (Blue Cat Audio)\" \"BC Triple EQ 4 VST(Stereo).dll\"\n        NjU2OO9e7f4CAAAAAQAAAAAAAAACAAAAAAAAAAIAAAABAAAAAAAAAA==\n        AgAAAAAAAABHAwAAAQAAAAAAAAA8P3htbCB2ZXJzaW9uPSIxLjAiIA==\n        ZW5jb2Rpbmc9InV0Zi04IiA/PjxQcmVzZXQgdmVyc2lvbj0iNCIgcA==\n        cm9nTmFtZT0iRGVmYXVsdCIgTUlESUlucHV0RGVmYXVsdD0iMSIgTQ==\n        SURJT3V0cHV0RGVmYXVsdD0iMSI+PGlucHV0UGFyYW1zIGNvdW50PQ==\n        IjciIHAwPSIwIiBwMT0iMCIgcDI9IjEwMDIuMjA0NzQzOTU1MzUwOA==\n        IiBwMz0iMS4xMDc3OTk5OTM4NzcxMTI4IiBwND0iMCIgcDU9IjE0Lg==\n        MDAwMDAwOTUzNjc0MzE2IiBwNj0iMCIgLz48aW5wdXRTdHJpbmdzIA==\n        Lz48aW5wdXRDdXJ2ZXMgLz48aW5wdXRTdXJmYWNlcyAvPjxpbnB1dA==\n        Q3VzdG9tUHJvcGVydGllcyAvPjxtb2RlbCAvPjxHVUkgdmVyc2lvbg==\n        PSIxIiB1c2VEZWZhdWx0PSIxIiBjaGFuZ2VkU2luY2VQcmVzZXRMbw==\n        YWRlZD0iMSI+PHNraW4gdmVyc2lvbj0iMiI+PHN0YXRlIHZlcnNpbw==\n        bj0iMyI+PHBhcmFtcyBwQ291bnQ9IjYiPjxwMCBuYW1lPSJhdXRvXw==\n        bGluay5lbmFibGVkIiB2YWx1ZT0iMCIgLz48cDEgbmFtZT0iZGlzcA==\n        bGF5X2NvbnRyb2xzIiB2YWx1ZT0iMCIgLz48cDIgbmFtZT0ic2hvdw==\n        X2hpZGVfZ3JhcGgiIHZhbHVlPSIxIiAvPjxwMyBuYW1lPSJ0aGVtZQ==\n        Lm9wYWNpdHkiIHZhbHVlPSIxMDAiIC8+PHA0IG5hbWU9InRoZW1lLg==\n        c2hvd19zZXR0aW5ncyIgdmFsdWU9IjAiIC8+PHA1IG5hbWU9Inlfeg==\n        b29tIiB2YWx1ZT0iMiIgLz48L3BhcmFtcz48Y3VydmVzIGNDb3VudA==\n        PSIwIiAvPjxzdXJmYWNlcyBzQ291bnQ9IjAiIC8+PHN0cmluZ3Mgcw==\n        Q291bnQ9IjAiIC8+PGNvbGxlY3Rpb25Db3VudHMgY0NvdW50PSIwIg==\n        IC8+PHByb3BlcnRpZXMgcENvdW50PSIwIiAvPjwvc3RhdGU+PC9zaw==\n        aW4+PC9HVUk+PC9QcmVzZXQ+AA==\n      >\n      <PARMENV 2 0.000000 1.000000\n        ACT 1\n        VIS 1\n        ARM 0\n        DEFSHAPE 0\n        PT 0.000000 0.000000 0"*/
		dim bitcr,131072,2
		bitcrnum=0
		repeat anafilnum
			cnt2=cnt
			bitcr.bitcrnum.0=anafil.cnt2.0
			bitcr.bitcrnum.1=0
			bitcrnum++
			if(anafil.cnt2.1=6){
				stat1=0
				repeat refpnum
					if(refp.cnt.0>=anafil.cnt2.0){
						if(stat1=0){
							if((cnt>0)&(refp.cnt.0>anafil.cnt2.0)){
								if(refp.cnt.0>refp.(cnt-1).0){
									bitcr.bitcrnum.0=anafil.cnt2.0
									bitcr.bitcrnum.1=(refp.cnt.1-refp.(cnt-1).1)*(anafil.cnt2.0-refp.(cnt-1).0)/(refp.cnt.0-refp.(cnt-1).0)+refp.(cnt-1).1
									bitcrnum++
								}
							}
							stat1=1
						}
						if((refp.cnt.0>anafil.(cnt2+1).0)&(anafilnum>cnt2+1)){
							if(cnt>0){
								if(refp.cnt.0>refp.(cnt-1).0){
									bitcr.bitcrnum.0=anafil.(cnt2+1).0
									bitcr.bitcrnum.1=(refp.cnt.1-refp.(cnt-1).1)*(anafil.(cnt2+1).0-refp.(cnt-1).0)/(refp.cnt.0-refp.(cnt-1).0)+refp.(cnt-1).1
									bitcrnum++
								}
							}
							break
						}
						bitcr.bitcrnum.0=refp.cnt.0
						bitcr.bitcrnum.1=refp.cnt.1
						bitcrnum++
					}
				loop
			}
		loop
		if(bitcrnum>0){
			buf+="\n      >\n      \n      BYPASS 0\n      <VST \"VST: dblue Glitch v1.3 (dblue)\" \"dblue_Glitch_v1_3.dll\"\n        X1tHZO9e7f4CAAAAAQAAAAAAAAACAAAAAAAAAAIAAAABAAAAAAAAAA==\n        AgAAAAAAAADwCgAAAQAAAAAAAABQcm9ncmFtIDEAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAACAPgAAgD4AAIA+AACAPwAAgD8AAAAAAAAAAA==\n        AACAPwAAAD8AAAAAAACAPwAAgD8AAAA/AACAPwAAAD8AAAA/AACAPw==\n        AAAAPwAAAAAAAAA/AAAAAAAAgD4AAAAAzcxMPQAAAAAAAAA/AAAAPw==\n        AACAPwAAAD8AAAAAAAAAPwAAAADNzMw8AACAPwAAAADNzEw+AAAAPw==\n        AAAAPwAAAAAAAAA/AAAAAAAAAD8AAAAAAAAAACh9Mj8AAAA/AAAAPw==\n        AAAAPwAAAD8AAIA/AAAAPwAAAAAAAAA/AAAAAOxROD+F61E/AAAAPw==\n        AACAPwAAAD8AAAA/AACAPwAAAD8AAAAAAAAAPwAAAAAAAAAAAAAAPw==\n        AAAAAAAAAAAAAAA/AAAAPwAAgD8AAAA/AAAAAAAAAD8AAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAPwAAAD8AAIA/AAAAPwAAAAAAAAA/AAAAAA==\n        AAAAAAAAAD8AAIA/AAAAAAAAAD8AAAA/AACAPwAAAD8AAAAAAAAAPw==\n        AAAAAArXIz0AAEA/AABAPwAAAD8AAAA/AAAAPwAAgD8AAAA/AAAAAA==\n        AAAAPwAAAADNzMw+AAAAPgAAgD4AAAAAAAAAPwAAAD8AAIA/AAAAPw==\n        AAAAAAAAAD8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD8AAAA/AACAPw==\n        AAAAPwAAAAAAAAA/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/AAAAPw==\n        AACAPwAAAD8AAAAAAAAAPwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPw==\n        AAAAPwAAgD8AAAA/AAAAAAAAAD8AAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAACwAAAAAAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAA==\n        AAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQABAAEAAQ==\n        AAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQ==\n        AAEAAQABAAEAAQABAAEAAQABAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQ==\n        AQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQ==\n        AQEAAAAAAAAAAQAAAAAAAAABAAAAAAAAAAEAAAAAAAAAAQAAAAAAAA==\n        AAEAAAAAAAAAAQAAAAAAAAABAAAAAAAAAAEAAAABAAAAAQABAAEBAQ==\n        AAEAAAABAAAAAQABAAEBAQABAAAAAQAAAAEAAQABAQEAAQAAAAEAAA==\n        AAEAAQABAQEAAQAAAAEAAQAAAQAAAQAAAAEAAAABAAEAAAEAAAEAAA==\n        AAEAAAABAAEAAAEAAAEAAAABAAAAAQABAAABAAABAAAAAQAAAAAAAQ==\n        AAAAAAABAAAAAAABAAAAAAABAAAAAAABAAAAAAABAAAAAAABAAAAAA==\n        AAEAAAAAAAEAAAAAAAEAAAABAAABAAABAAABAAABAAABAAABAAABAA==\n        AAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAA==\n        AQEAAAEAAAEAAQAAAQAAAQABAAABAAABAAEAAAEAAAEAAQAAAQAAAQ==\n        AAEAAAEAAAEAAQAAAQAAAQABAAABAAABAAEAAAEAAQABAQEAAQABAA==\n        AAEAAAEAAQABAQEAAQABAAABAAABAAEAAQEBAAEAAQAAAQAAAQABAA==\n        AQEBAAEAAQAAAQEAAQAAAQABAQABAAABAAEBAAEAAAEAAQEAAQAAAQ==\n        AAEBAAEAAAEAAQEAAQAAAQABAQABAAABAAEBAAEAAAEAAQABAAEAAA==\n        AQAAAQABAAAAAQABAAEAAAEAAAEAAQAAAAEAAQABAAABAAABAAEAAA==\n        AAEAAQABAAABAAABAAEAAAABAAAAAQAAAAEAAQAAAQAAAQAAAAEAAA==\n        AAEAAQAAAQAAAQAAAAEAAAABAAEAAAEAAAEAAAABAAAAAQABAAABAA==\n        AAEAAQAAAQABAAABAAEAAQABAAEAAAEAAQAAAQABAAEAAQABAAABAA==\n        AQAAAQABAAEAAQABAAABAAEAAAEAAQABAAEAAAABAQEBAAABAAEBAA==\n        AAEAAAABAQEBAAABAAEBAAABAAAAAQEBAQAAAQABAQAAAQAAAAEBAQ==\n        AQAAAQABAQAAAQEAAQAAAQABAAEBAAABAAEBAAEAAAEAAQABAQAAAQ==\n        AAEBAAEAAAEAAQABAQAAAQABAQABAAABAAEAAQEAAAEABf///////w==\n        /////////////////////////////////wgAAAAAAAACAf///////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        //8AAQEBAQEBAQEBAQEBAQEBAQEAAAAAAAEAAAABATYAAIA//////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        /////////////////////////////////////////////////////w==\n        ////////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\n        AAAAAAAAAAAAAAAAAAAAAAAAAA0=\n      >\n      <PARMENV 9 0.000000 1.000000\n        ACT 1\n        VIS 1\n        ARM 0\n        DEFSHAPE 0\n        PT 0.000000 0.000000 1"
			repeat bitcrnum
				buf+="\n        PT "+str(double(c2ta(bitcr.cnt.0))/1000)+" "+str(double(bitcr.cnt.1)*30/64/1000)+" 0"
			loop
		}
		buf+="\n      >\n      \n      BYPASS 1\n      <VST \"VST: Blue Cat's Triple EQ (Stereo) (Blue Cat Audio)\" \"Blue Cat Triple EQ VST(Stereo).dll\"\n        Mno3NO9e7f4CAAAAAQAAAAAAAAACAAAAAAAAAAIAAAABAAAAAAAAAA==\n        AgAAAAAAAADZAwAAAQAAAAAAAAA8P3htbCB2ZXJzaW9uPSIxLjAiIA==\n        ZW5jb2Rpbmc9InV0Zi04IiA/PjxQcmVzZXQ+PHZlcnNpb24+Mjwvdg==\n        ZXJzaW9uPjxwcm9nTmFtZT5EZWZhdWx0PC9wcm9nTmFtZT48YnlwYQ==\n        c3M+MDwvYnlwYXNzPjxpbnB1dFBhcmFtcz48cGFyYW1Db3VudD42PA==\n        L3BhcmFtQ291bnQ+PHBhcmFtMD4tNC43NjgzNzE1ODJlLTA2PC9wYQ==\n        cmFtMD48cGFyYW0xPjcwLjYzMTA4MDYyNzwvcGFyYW0xPjxwYXJhbQ==\n        Mj4xLjEwNzgwMDAwNjk8L3BhcmFtMj48cGFyYW0zPi00Ljc2ODM3MQ==\n        NTgyZS0wNjwvcGFyYW0zPjxwYXJhbTQ+MTQuMjI2NTcwMTI5PC9wYQ==\n        cmFtND48cGFyYW01Pi00Ljc2ODM3MTU4MmUtMDY8L3BhcmFtNT48Lw==\n        aW5wdXRQYXJhbXM+PE1JRElJbnB1dERlZmF1bHQ+MTwvTUlESUlucA==\n        dXREZWZhdWx0PjxNSURJT3V0cHV0RGVmYXVsdD4xPC9NSURJT3V0cA==\n        dXREZWZhdWx0PjxHVUk+PHVzZURlZmF1bHQ+MTwvdXNlRGVmYXVsdA==\n        Pjx2ZXJzaW9uPjI8L3ZlcnNpb24+PHN0YXRlPjxwYXJhbVN0YXRlcw==\n        PjxwYXJhbUNvdW50PjM8L3BhcmFtQ291bnQ+PHBhcmFtMD48bmFtZQ==\n        PmF1dG9fbGluay5lbmFibGVkPC9uYW1lPjx2YWx1ZT4wPC92YWx1ZQ==\n        PjwvcGFyYW0wPjxwYXJhbTE+PG5hbWU+Z2xvYmFsX29wYWNpdHk8Lw==\n        bmFtZT48dmFsdWU+MTAwPC92YWx1ZT48L3BhcmFtMT48cGFyYW0yPg==\n        PG5hbWU+eV96b29tPC9uYW1lPjx2YWx1ZT4xLjYyNDUwNDY4NTQ8Lw==\n        dmFsdWU+PC9wYXJhbTI+PC9wYXJhbVN0YXRlcz48Y3VydmVTdGF0ZQ==\n        cz48Y3VydmVDb3VudD4wPC9jdXJ2ZUNvdW50PjwvY3VydmVTdGF0ZQ==\n        cz48c3VyZmFjZVN0YXRlcz48c3VyZmFjZUNvdW50PjA8L3N1cmZhYw==\n        ZUNvdW50Pjwvc3VyZmFjZVN0YXRlcz48c3RyaW5nU3RhdGVzPjxzdA==\n        cmluZ0NvdW50PjA8L3N0cmluZ0NvdW50Pjwvc3RyaW5nU3RhdGVzPg==\n        PC9zdGF0ZT48L0dVST48bW9kZWwgLz48QXV0b21hdGlvbk91dHB1dA==\n        RGVmYXVsdD4xPC9BdXRvbWF0aW9uT3V0cHV0RGVmYXVsdD48L1ByZQ==\n        c2V0PgA=\n      >\n      <PARMENV 2 0.000000 1.000000\n        ACT 1\n        VIS 1\n        ARM 0\n        DEFSHAPE 0\n        PT 0.000000 0.000000 0"
		repeat refpnum
			cnt2=cnt
			buf+="\n        PT "+str(double(c2ta(refp.cnt.0))/1000)+" "+str((0.35-cos(double(refp.cnt.1)*M_PI/2000)*0.25)*(double(refp.cnt.1))/1000*(4000+double(refp.cnt.1))/5000)+" 0"
			if(cnt!=refpnum-1){
				if((refp.cnt.0!=refp.(cnt+1).0)&(refp.cnt.1!=refp.(cnt+1).1)){
					dn=6+(refp.(cnt+1).0-refp.cnt.0)*4/UNIT_MEASURE
					for i,1,dn
						buf+="\n        PT "+str((double(c2ta(refp.cnt.0))+double(c2ta(refp.(cnt+1).0)-c2ta(refp.cnt.0))*i/dn)/1000)+" "+str((0.35-cos(double(refp.cnt.1-(refp.cnt.1-refp.(cnt+1).1)*i/dn)*M_PI/2000)*0.25)*(double(refp.cnt.1)-(refp.cnt.1-refp.(cnt+1).1)*i/dn)/1000*(4000+double(refp.cnt.1)-(refp.cnt.1-refp.(cnt+1).1)*i/dn)/5000)+" 0"
					next
				}
			}else{
				pichu.pichunum.0=0
				pichu.pichunum.1=c2ta(refp.cnt.0)
				pichunum++
			}
		loop
		buf+="\n      >\n      <PARMENV 0 0.000000 1.000000\n        ACT 1\n        VIS 1\n        ARM 0\n        DEFSHAPE 1\n        PT 0.000000 0.000000 1"
		repeat pichunum
			if(pichu.cnt.0=0){
				//buf+="\n        PT "+str(double(pichu.cnt.1)/1000-0.05)+" 0.000000 0"
				//buf+="\n        PT "+str(double(pichu.cnt.1)/1000)+" 1.000000 0"
			}else:if(pichu.cnt.0=1){
				buf+="\n        PT "+str(double(pichu.cnt.1)/1000-0.03)+" 1.000000 1"
				buf+="\n        PT "+str(double(pichu.cnt.1)/1000+0.03)+" 0.000000 1"
			}else{
				//buf+="\n        PT "+str(double(pichu.cnt.1)/1000)+" 1.000000 0"
				//buf+="\n        PT "+str(double(pichu.cnt.1)/1000+0.05)+" 0.000000 0"
			}
		loop
		buf+="\n      >\n      <PARMENV 5 0.000000 1.000000\n        ACT 1\n        VIS 1\n        ARM 0\n        DEFSHAPE 0\n        PT 0.000000 0.630000 0"
		repeat refpnum
			cnt2=cnt
			f=0
			if(f=1):continue
			shuu=0
			cnt2=cnt
			buf+="\n        PT "+str(double(c2ta(refp.cnt.0))/1000)+" "+str(minf(0.68-(double(refp.cnt.1-800)/2000)*(refp.cnt.1>800)-(double(400-refp.cnt.1)/8000)*(refp.cnt.1<400),0.68))+" 0"
			if(cnt!=refpnum-1){
				if((refp.cnt.0!=refp.(cnt+1).0)&(refp.cnt.1!=refp.(cnt+1).1)){
					dn=6+(refp.(cnt+1).0-refp.cnt.0)*4/UNIT_MEASURE
					for i,1,dn
						cnt2=cnt
						shuu=0
						buf+="\n        PT "+str((double(c2ta(refp.cnt.0))+double(c2ta(refp.(cnt+1).0)-c2ta(refp.cnt.0))*i/dn)/1000)+" "+str(minf(0.68+double(shuu)/2000-(double(refp.cnt.1-(refp.cnt.1-refp.(cnt+1).1)*i/dn-800)/2000)*(refp.cnt.1-(refp.cnt.1-refp.(cnt+1).1)*i/dn>800)-(double(400-refp.cnt.1+(refp.cnt.1-refp.(cnt+1).1)*i/dn)/8000)*(refp.cnt.1-(refp.cnt.1-refp.(cnt+1).1)*i/dn<400),0.68))+" 0"
					next
				}
			}
		loop
		buf+="\n      >\n    >"
		buf+="\n    <ITEM\n      POSITION "+str(double(max(-offset,0))/1000)
		buf+="\n      LENGTH "+str(double(mlength+min(-offset,0))/1000)
		buf+="\n      SNAPOFFS 0.000000\n      LOOP 1\n      SEL 1\n      FADEIN 1 0.000000 0.000000\n      FADEOUT 1 0.000000 0.000000\n      MUTE 0\n      NAME \""+csongflist.0+"\""
		stat1=getpath(csongflist.0,18)
		if(stat1=".mp3"){
			stat1="MP3"
		}else:if(stat1=".wav"){
			stat1="WAVE"
		}else:if(stat1=".ogg"){
			stat1="VORBIS"
		}else:stat1=strtrim(stat1,1,'.')
		buf+="\n      VOLPAN 1.000000 0.000000 1.000000 -1.000000\n      SOFFS "+str(double(-min(-offset,0))/1000)+"   PLAYRATE 1.000000 1 0.000000\n      CHANMODE 0\n      <SOURCE "+stat1
		buf+="\n        FILE \""+getpath(fname,32)+csongflist.0+"\""
		buf+="\n      >\n    >"
		buf+="\n  >\n  <TRACK\n    NAME \"chokkaku(※タイミング確認用)\"\n    VOLPAN 1.000000 0.000000 -1.000000\n    MUTESOLO 1 0\n    IPHASE 0\n    ISBUS 0\n    BUSCOMP 0\n    SHOWINMIX 1\n    SEL 0\n    REC 0 0 0 0\n    TRACKHEIGHT 0\n    NCHAN 2\n    FX 1\n    MIDIOUT -1\n    MAINSEND 1"
		dim an,131072
		annum=0
		repeat analognum
			if((analog.cnt.2<=UNIT_MEASURE/32)&(analog.cnt.3!=analog.cnt.4)){
				f=0
				if(annum>0){
					if(an.(annum-1)=analog.cnt.1){
						f=1
					}
				}
				if(f=0){
					an.annum=analog.cnt.1
					annum++
				}
			}
		loop
		repeat annum
			buf+="\n    <ITEM\n      POSITION "+str(double(c2ta(an.cnt))/1000)+"\n      LENGTH 2.000000\n      SNAPOFFS 0.000000\n      LOOP 0\n      SEL 0\n      FADEIN 1 0.000000 0.000000\n      FADEOUT 1 0.000000 0.000000\n      MUTE 0\n      NAME \"chokkaku.wav\"\n      VOLPAN 1.000000 0.000000 1.000000 -1.000000\n      SOFFS 0.000000\n      PLAYRATE 1.000000 1 0.000000\n      CHANMODE 0\n      <SOURCE WAVE\n        FILE \""+dir_default+"\\se\\chokkaku.wav\"\n      >\n    >"
		loop
		buf+="\n  >\n  <TRACK\n    NAME \"tick(※タイミング確認用)\"\n    VOLPAN 1.000000 0.000000 -1.000000\n    MUTESOLO 1 0\n    IPHASE 0\n    ISBUS 0\n    BUSCOMP 0\n    SHOWINMIX 1\n    SEL 0\n    REC 0 0 0 0\n    TRACKHEIGHT 0\n    NCHAN 2\n    FX 1\n    MIDIOUT -1\n    MAINSEND 1"
		dim tc,131072,2
		tcnum=0
		repeat notenum
			if(note.cnt.0<=3){
				f=0
				if(tcnum>0){
					if(tc.(tcnum-1)=note.cnt.1){
						f=1
					}
				}
				if(f=0){
					tc.tcnum.0=note.cnt.1
					tc.tcnum.1=0
					tcnum++
				}
			}
		loop
		repeat notenum
			if((note.cnt.0>3)&(note.cnt.2=0)){
				f=0
				if((tcnum>0)&(cnt>0)){
					if(tc.(tcnum-1)=note.cnt.1){
						f=1
					}
				}
				if(f=0){
					tc.tcnum.0=note.cnt.1
					tc.tcnum.1=1
					tcnum++
				}
			}
		loop
		repeat tcnum
			if(tc.cnt.1=0){
				stat1="tick.wav"
			}else{
				stat1="tick2.wav"
			}
			buf+="\n    <ITEM\n      POSITION "+str(double(c2ta(tc.cnt.0))/1000)+"\n      LENGTH 0.075000\n      SNAPOFFS 0.000000\n      LOOP 0\n      SEL 0\n      FADEIN 1 0.000000 0.000000\n      FADEOUT 1 0.000000 0.000000\n      MUTE 0\n      NAME \""+stat1+"\"\n      VOLPAN 1.000000 0.000000 1.000000 -1.000000\n      SOFFS 0.000000\n      PLAYRATE 1.000000 1 0.000000\n      CHANMODE 0\n      <SOURCE WAVE\n        FILE \""+dir_default+"\\se\\"+stat1+"\"\n      >\n    >"
		loop
		buf+="\n  >\n>\n"
		notesel buf
		notesave rppfname
	}else:if(cmd=CMD_QUIT){
		if(pendfl!=-1):pendfl=1:return
		gosub *exit
	}else:if(cmd=CMD_EDIT_UNDO){
		if(pendfl!=-1):pendfl=1:return
		if(ud_cnt<=0):return
		if(ud_redofl=1){
			gosub *undokakuho
			ud_cur=(UNDO_MAX+ud_cur-1)\UNDO_MAX
			ud_cnt--
			ud_redofl=0
		}
		ud_cur=(UNDO_MAX+ud_cur-1)\UNDO_MAX
		ud_cnt--
		ud_redomax++
		gosub *undofukugen
		e=1:gosub *refreshtitle
		gosub *draw
	}else:if(cmd=CMD_EDIT_REDO){
		if(pendfl!=-1):pendfl=1:return
		if(ud_redomax<=0):return
		ud_cur=(ud_cur+1)\UNDO_MAX
		ud_cnt++
		ud_redomax--
		gosub *undofukugen
		e=1:gosub *refreshtitle
		gosub *draw
	}else:if(cmd=CMD_EDIT_CUT){
		if(pendfl!=-1):pendfl=1:return
		acmd=CMD_EDIT_COPY
		gosub *OnCommand
		acmd=CMD_EDIT_DELETE
		gosub *OnCommand
	}else:if(cmd=CMD_EDIT_COPY){
		if(pendfl!=-1):pendfl=1:return
		if(selnum>0){
			clipnotenum=selnotenum
			repeat selnotenum
				cnt2=cnt
				repeat 6
					clipnote.cnt2.cnt=note.(selnote.cnt2).cnt
				loop
				clipnotesefname.cnt2=notesefname.(selnote.cnt2)
			loop
			clipanalognum=selanalognum
			repeat selanalognum
				cnt2=cnt
				repeat 6
					clipanalog.cnt2.cnt=analog.(selanalog.cnt2).cnt
				loop
				clipanalog.cnt2.6=analogparentran.(selanalog.cnt2)
			loop
			clipspinnum=selspinnum
			repeat selspinnum
				cnt2=cnt
				repeat 6
					clipspin.cnt2.cnt=spin.(selspin.cnt2).cnt
				loop
			loop
			clipstpnum=selstpnum
			repeat selstpnum
				cnt2=cnt
				repeat 2
					clipstp.cnt2.cnt=stp.(selstp.cnt2).cnt
				loop
			loop
			cliptiltnum=0
			clipztopnum=0
			clipzbotnum=0
			clipzsidenum=0
		}
	}else:if(cmd=CMD_EDIT_PASTE){
		if(pendfl!=-1):pendfl=1:return
		if(clipnum>0){
			gosub *undokakuho
			e=1
			gosub *selinit
			minpos=-1
			repeat clipnotenum
				if((minpos>clipnote.cnt.1)|(minpos=-1)):minpos=clipnote.cnt.1
			loop
			repeat clipanalognum
				if((minpos>clipanalog.cnt.1)|(minpos=-1)):minpos=clipanalog.cnt.1
			loop
			repeat clipspinnum
				if((minpos>clipspin.cnt.1)|(minpos=-1)):minpos=clipspin.cnt.1
			loop
			repeat clipstpnum
				if((minpos>clipstp.cnt.0)|(minpos=-1)):minpos=clipstp.cnt.0
			loop
			repeat cliptiltnum
				if((minpos>cliptilt.cnt.0)|(minpos=-1)):minpos=cliptilt.cnt.0
			loop
			repeat clipztopnum
				if((minpos>clipztop.cnt.0)|(minpos=-1)):minpos=clipztop.cnt.0
			loop
			repeat clipzbotnum
				if((minpos>clipzbot.cnt.0)|(minpos=-1)):minpos=clipzbot.cnt.0
			loop
			repeat clipzsidenum
				if((minpos>clipzside.cnt.0)|(minpos=-1)):minpos=clipzside.cnt.0
			loop
			repeat clipnotenum
				cnt3=cnt
				stat1=notenum
				repeat notenum
					if(note.cnt.1>cnowf+clipnote.cnt3.1-minpos){
						stat1=cnt
						break
					}
				loop
				repeat notenum-stat1
					cnt2=notenum-1-cnt
					repeat length2(note)
						note.(cnt2+1).cnt=note.cnt2.cnt
					loop
					notesefname.(cnt2+1)=notesefname.cnt2
				loop
				repeat selnotenum
					if(selnote.cnt>=stat1):selnote.cnt++
				loop
				note.stat1.0=clipnote.cnt3.0
				note.stat1.1=cnowf+clipnote.cnt3.1-minpos
				note.stat1.2=clipnote.cnt3.2
				note.stat1.3=clipnote.cnt3.3
				note.stat1.4=clipnote.cnt3.4
				note.stat1.5=clipnote.cnt3.5
				notesefname.stat1=clipnotesefname.cnt3
				notenum++
				selnote.selnotenum=stat1
				lastsel=selnotenum
				selnotenum++
				selshift=0
			loop
			repeat clipanalognum
				cnt3=cnt
				stat1=analognum
				repeat analognum
					if(analog.cnt.1>cnowf+clipanalog.cnt3.1-minpos){
						stat1=cnt
						break
					}
				loop
				repeat analognum-stat1
					cnt2=analognum-1-cnt
					analog.(cnt2+1).0=analog.cnt2.0
					analog.(cnt2+1).1=analog.cnt2.1
					analog.(cnt2+1).2=analog.cnt2.2
					analog.(cnt2+1).3=analog.cnt2.3
					analog.(cnt2+1).4=analog.cnt2.4
					analog.(cnt2+1).5=analog.cnt2.5
					analogparentran.(cnt2+1)=analogparentran.cnt2
				loop
				repeat selanalognum
					if(selanalog.cnt>=stat1):selanalog.cnt++
				loop
				analog.stat1.0=clipanalog.cnt3.0
				analog.stat1.1=cnowf+clipanalog.cnt3.1-minpos
				analog.stat1.2=clipanalog.cnt3.2
				analog.stat1.3=clipanalog.cnt3.3
				analog.stat1.4=clipanalog.cnt3.4
				analog.stat1.5=clipanalog.cnt3.5
				analogparentran.stat1=clipanalog.cnt3.6
				analognum++
				selanalog.selanalognum=stat1
				selanalognum++
				selshift=0
			loop
			repeat clipspinnum
				cnt3=cnt
				stat1=spinnum
				repeat spinnum
					if(spin.cnt.1>cnowf+clipspin.cnt3.1-minpos){
						stat1=cnt
						break
					}
				loop
				repeat spinnum-stat1
					cnt2=spinnum-1-cnt
					spin.(cnt2+1).0=spin.cnt2.0
					spin.(cnt2+1).1=spin.cnt2.1
					spin.(cnt2+1).2=spin.cnt2.2
					spin.(cnt2+1).3=spin.cnt2.3
					spin.(cnt2+1).4=spin.cnt2.4
					spin.(cnt2+1).5=spin.cnt2.5
				loop
				repeat selspinnum
					if(selspin.cnt>=stat1):selspin.cnt++
				loop
				spin.stat1.0=clipspin.cnt3.0
				spin.stat1.1=cnowf+clipspin.cnt3.1-minpos
				spin.stat1.2=clipspin.cnt3.2
				spin.stat1.3=clipspin.cnt3.3
				spin.stat1.4=clipspin.cnt3.4
				spin.stat1.5=clipspin.cnt3.5
				spinnum++
				selspin.selspinnum=stat1
				selspinnum++
				selshift=0
			loop
			repeat clipstpnum
				cnt3=cnt
				stat1=stpnum
				repeat stpnum
					if(stp.cnt.0>cnowf+clipstp.cnt3.0-minpos){
						stat1=cnt
						break
					}
				loop
				repeat stpnum-stat1
					cnt2=stpnum-1-cnt
					stp.(cnt2+1).0=stp.cnt2.0
					stp.(cnt2+1).1=stp.cnt2.1
				loop
				repeat selstpnum
					if(selstp.cnt>=stat1):selstp.cnt++
				loop
				stp.stat1.0=cnowf+clipstp.cnt3.0-minpos
				stp.stat1.1=clipstp.cnt3.1
				stpnum++
				selstp.selstpnum=stat1
				selstpnum++
				selshift=0
			loop
			repeat cliptiltnum
				cnt3=cnt
				stat1=tiltnum
				repeat tiltnum
					if(tilt.cnt.0>cnowf+cliptilt.cnt3.0-minpos){
						stat1=cnt
						break
					}
				loop
				f=1
				if(stat1-1>0){
					// 同じ位置にあれば上書き
					if(tilt.(stat1-1).0=cnowf+cliptilt.cnt3.0-minpos){
						stat1--
						f=0
					}
				}
				if(f=1){
					repeat tiltnum-stat1
						cnt2=tiltnum-1-cnt
						repeat length2(tilt)
							tilt.(cnt2+1).cnt=tilt.cnt2.cnt
						loop
					loop
					tiltnum++
				}
				tilt.stat1.0=cnowf+cliptilt.cnt3.0-minpos
				tilt.stat1.1=cliptilt.cnt3.1
				tilt.stat1.2=cliptilt.cnt3.2
			loop
			repeat clipztopnum
				cnt3=cnt
				stat1=ztopnum
				repeat ztopnum
					if(ztop.cnt.0>cnowf+clipztop.cnt3.0-minpos){
						stat1=cnt
						break
					}
				loop
				f=1
				if(stat1-1>0){
					// 同じ位置にあれば上書き
					if(ztop.(stat1-1).0=cnowf+clipztop.cnt3.0-minpos){
						stat1--
						f=0
					}
				}
				if(f=1){
					repeat ztopnum-stat1
						cnt2=ztopnum-1-cnt
						repeat length2(ztop)
							ztop.(cnt2+1).cnt=ztop.cnt2.cnt
						loop
					loop
					ztopnum++
				}
				ztop.stat1.0=cnowf+clipztop.cnt3.0-minpos
				ztop.stat1.1=clipztop.cnt3.1
				ztop.stat1.2=clipztop.cnt3.2
			loop
			repeat clipzbotnum
				cnt3=cnt
				stat1=zbotnum
				repeat zbotnum
					if(zbot.cnt.0>cnowf+clipzbot.cnt3.0-minpos){
						stat1=cnt
						break
					}
				loop
				f=1
				if(stat1-1>0){
					// 同じ位置にあれば上書き
					if(zbot.(stat1-1).0=cnowf+clipzbot.cnt3.0-minpos){
						stat1--
						f=0
					}
				}
				if(f=1){
					repeat zbotnum-stat1
						cnt2=zbotnum-1-cnt
						repeat length2(zbot)
							zbot.(cnt2+1).cnt=zbot.cnt2.cnt
						loop
					loop
					zbotnum++
				}
				zbot.stat1.0=cnowf+clipzbot.cnt3.0-minpos
				zbot.stat1.1=clipzbot.cnt3.1
				zbot.stat1.2=clipzbot.cnt3.2
			loop
			repeat clipzsidenum
				cnt3=cnt
				stat1=zsidenum
				repeat zsidenum
					if(zside.cnt.0>cnowf+clipzside.cnt3.0-minpos){
						stat1=cnt
						break
					}
				loop
				f=1
				if(stat1-1>0){
					// 同じ位置にあれば上書き
					if(zside.(stat1-1).0=cnowf+clipzside.cnt3.0-minpos){
						stat1--
						f=0
					}
				}
				if(f=1){
					repeat zsidenum-stat1
						cnt2=zsidenum-1-cnt
						repeat length2(zside)
							zside.(cnt2+1).cnt=zside.cnt2.cnt
						loop
					loop
					zsidenum++
				}
				zside.stat1.0=cnowf+clipzside.cnt3.0-minpos
				zside.stat1.1=clipzside.cnt3.1
				zside.stat1.2=clipzside.cnt3.2
			loop
		}
		gosub *refreshtitle
		gosub *draw
	}else:if(cmd=CMD_EDIT_DELETE){
		if(pendfl!=-1):pendfl=1:return
		if(selnum>0):gosub *undokakuho
		en=0
		if(selnotenum>0){
			repeat selnotenum
				nt=selnote.cnt
				repeat notenum-nt-1,nt+1
					note.(cnt-1).0=note.cnt.0
					note.(cnt-1).1=note.cnt.1
					note.(cnt-1).2=note.cnt.2
					note.(cnt-1).3=note.cnt.3
					note.(cnt-1).4=note.cnt.4
					note.(cnt-1).5=note.cnt.5
					notesefname.(cnt-1)=notesefname.cnt
				loop
				repeat selnotenum-cnt-1,cnt+1
					if(selnote.cnt>nt):selnote.cnt--
				loop
				notenum--
			loop
			en=1
		}
		if(selanalognum>0){
			repeat selanalognum
				nt=selanalog.cnt
				if(nt>=0){
					stat3=analog.nt.1+analog.nt.2
					stat4=analog.nt.0
					if((analog.(nt+1).1=analog.nt.0+analog.nt.1)&(analog.nt.0=analog.(nt+1).0)):analog.(nt+1).5=1
					if((analog.(nt+2).1=analog.nt.0+analog.nt.1)&(analog.nt.0=analog.(nt+2).0)):analog.(nt+2).5=1
					if(nt<analognum){
						if(analogparent.(nt+1)=nt){
							analogparentran.(nt+1)=analogparentran.nt
						}
					}
					if(nt<analognum-1){
						if(analogparent.(nt+2)=nt){
							analogparentran.(nt+2)=analogparentran.nt
						}
					}
					repeat analognum-nt-1,nt+1
						cnt2=cnt
						if(cnt2-1>=0){
							repeat 6
								analog.(cnt2-1).cnt=analog.cnt2.cnt
							loop
							analogparentran.(cnt2-1)=analogparentran.cnt2
						}
					loop
					repeat selanalognum-cnt-1,cnt+1
						if(selanalog.cnt>nt):selanalog.cnt--
					loop
					analognum--
					repeat analognum
						if((analog.cnt.1=stat3)&(analog.cnt.0=stat4)){
							analog.cnt.5=1
						}
					loop
				}
			loop
			en=1
		}
		if(selspinnum>0){
			repeat selspinnum
				nt=selspin.cnt
				repeat spinnum-nt-1,nt+1
					spin.(cnt-1).0=spin.cnt.0
					spin.(cnt-1).1=spin.cnt.1
					spin.(cnt-1).2=spin.cnt.2
					spin.(cnt-1).3=spin.cnt.3
					spin.(cnt-1).4=spin.cnt.4
					spin.(cnt-1).5=spin.cnt.5
				loop
				repeat selspinnum-cnt-1,cnt+1
					if(selspin.cnt>nt):selspin.cnt--
				loop
				spinnum--
			loop
			en=1
		}
		if(selstpnum>0){
			repeat selstpnum
				nt=selstp.cnt
				repeat stpnum-nt-1,nt+1
					stp.(cnt-1).0=stp.cnt.0
					stp.(cnt-1).1=stp.cnt.1
				loop
				repeat selstpnum-cnt-1,cnt+1
					if(selstp.cnt>nt):selstp.cnt--
				loop
				stpnum--
			loop
			en=1
		}
		e=e|en
		gosub *refreshtitle
		gosub *selinit
		gosub *draw
	}else:if(cmd=CMD_EDIT_SELALL){
		gosub *selinit
		selnotenum=notenum
		repeat notenum
			selnote.cnt=cnt
		loop
		selanalognum=analognum
		repeat analognum
			selanalog.cnt=cnt
		loop
		selspinnum=spinnum
		repeat spinnum
			selspin.cnt=cnt
		loop
		selstpnum=stpnum
		repeat stpnum
			selstp.cnt=cnt
		loop
		gosub *draw
	}else:if(cmd=CMD_EDIT_CLEARSEL){
		gosub *selinit
		gosub *draw
	}else:if(cmd=CMD_EDIT_SELFLIP){
		if(pendfl!=-1):pendfl=1:return
		if(selnum>0):gosub *undokakuho
		en=0
		repeat selnotenum
			if((selnote.cnt<0)|(selnote.cnt>=notenum)):break
			switch note.(selnote.cnt).0
			case 0
				note.(selnote.cnt).0=3
				swbreak
			case 1
				note.(selnote.cnt).0=2
				swbreak
			case 2
				note.(selnote.cnt).0=1
				swbreak
			case 3
				note.(selnote.cnt).0=0
				swbreak
			case 4
				note.(selnote.cnt).0=5
				swbreak
			default
				note.(selnote.cnt).0=4
				swbreak
			swend
			en=1
		loop
		repeat selanalognum
			if((selanalog.cnt<0)|(selanalog.cnt>=analognum)):break
			analog.(selanalog.cnt).0=1-analog.(selanalog.cnt).0
			analog.(selanalog.cnt).3=50-analog.(selanalog.cnt).3
			analog.(selanalog.cnt).4=50-analog.(selanalog.cnt).4
			en=1
		loop
		repeat selspinnum
			if((selspin.cnt<0)|(selspin.cnt>=spinnum)):break
			spin.(selspin.cnt).0=spin.(selspin.cnt).0/2*2+1-(spin.(selspin.cnt).0\2)
			en=1
		loop
		e=e|en
		gosub *draw
		gosub *refreshtitle
	}else:if(cmd=CMD_EDIT_SELRANDOMIZE){
		if(pendfl!=-1):pendfl=1:return
		if(selnum>0):gosub *undokakuho
		en=0
		randomize
		stat1=0
		dim pturn,4
		repeat 4
			cnt2=cnt
			repeat
				pturn.cnt2=rnd(4)
				repeat cnt2
					if(pturn.cnt=pturn.cnt2){
						stat1=1
						break
					}else:stat1=0
				loop
				if(stat1=0){
					break
				}
			loop
		loop
		pturnl=rnd(2)
		repeat selnotenum
			if((selnote.cnt<0)|(selnote.cnt>=notenum)):break			
			if(note.(selnote.cnt).0<=3){
				note.(selnote.cnt).0=pturn.(note.(selnote.cnt).0)
			}else{
				note.(selnote.cnt).0=4+((note.(selnote.cnt).0-4)^pturnl)
			}
			en=1
		loop
		e=e|en
		gosub *draw
		gosub *refreshtitle
	}else : if(cmd = CMD_EDIT_LASER_COLOR_SELFLIP) {
		if(pendfl!=-1):pendfl=1:return
		if(selnum>0):gosub *undokakuho
		en=0
		repeat selanalognum
			if((selanalog.cnt<0)|(selanalog.cnt>=analognum)):break
			analog.(selanalog.cnt).0=1-analog.(selanalog.cnt).0
			en=1
		loop
		e=e|en
		gosub *draw
		gosub *refreshtitle
	}else:if(cmd=CMD_EDIT_REMOVEMEASURE){
		if(pendfl!=-1):pendfl=1:return
		en=0
		if(cnowflen=0){
			dialog lang.10.40/*"削除したい領域を範囲選択してください。"*/,0,lang.0.10/*"注意"*/
		}else{
			gosub *selinit2
			stat1=min(cnowf,cnowf+cnowflen)
			stat2=max(cnowf,cnowf+cnowflen)
			repeat analognum
				if(analog.cnt.1+analog.cnt.2<=stat1):continue
				if(analog.cnt.1>=stat2):break
				selanalog.selanalognum=cnt
				selanalognum++
			loop
			repeat spinnum
				if(spin.cnt.1+spin.cnt.2<=stat1):continue
				if(spin.cnt.1>=stat2):break
				selspin.selspinnum=cnt
				selspinnum++
			loop
			repeat stpnum
				if(stp.cnt.0+stp.cnt.1<=stat1):continue
				if(stp.cnt.0>=stat2):break
				selstp.selstpnum=cnt
				selstpnum++
			loop
			repeat notenum
				if((note.cnt.2>0)&(note.cnt.1+note.cnt.2<=stat1)):continue
				if((note.cnt.2=0)&(note.cnt.1<stat1)):continue
				if(note.cnt.1>=stat2):break
				selnote.selnotenum=cnt
				selnotenum++
			loop
			gosub *draw
			dialog lang.10.41/*"範囲内のオブジェクトは削除されますが、よろしいですか？"*/,2,lang.0.26/*"確認"*/
			if(stat=6){
				cnowf=min(cnowf,cnowf+cnowflen)
				cnowflen_=abs(cnowflen)
				if(selnum!=0){
					acmd=CMD_EDIT_DELETE
					gosub *OnCommand
				}else:gosub *undokakuho
				cnowflen=cnowflen_
				
				cnt2=0
				repeat chipratenum
					if((chiprate.cnt2.0>=cnowf)&(chiprate.cnt2.0<cnowf+cnowflen)){
						ardel2 chiprate,chipratenum,2,cnt2
						chipratenum--
						cnt2--
					}
					cnt2++
				loop
				
				cnt2=0
				repeat longratenum
					if((longrate.cnt2.0>=cnowf)&(longrate.cnt2.0<cnowf+cnowflen)){
						ardel2 longrate,longratenum,2,cnt2
						longratenum--
						cnt2--
					}
					cnt2++
				loop
	
				cnt2=0
				repeat analogratenum
					if((analograte.cnt2.0>=cnowf)&(analograte.cnt2.0<cnowf+cnowflen)){
						ardel2 analograte,analogratenum,2,cnt2
						analogratenum--
						cnt2--
					}
					cnt2++
				loop
	
				cnt2=1
				repeat max(anagainnum-1,0),1
					if((anagain.cnt2.0>=cnowf)&(anagain.cnt2.0<cnowf+cnowflen)){
						ardel2 anagain,anagainnum,3,cnt2
						anagainnum--
						cnt2--
					}
					cnt2++
				loop
	
				cnt2=1
				repeat max(anafilnum-1,0),1
					if((anafil.cnt2.0>=cnowf)&(anafil.cnt2.0<cnowf+cnowflen)){
						ardel2 anafil,anafilnum,3,cnt2
						anafilnum--
						cnt2--
					}
					cnt2++
				loop
	
				cnt2=1
				repeat max(anvolnum-1,0),1
					if((anvol.cnt2.0>=cnowf)&(anvol.cnt2.0<cnowf+cnowflen)){
						ardel2 anvol,anvolnum,3,cnt2
						anvolnum--
						cnt2--
					}
					cnt2++
				loop
	
				cnt2=0
				repeat ansenum
					if((anse.cnt2.0>=cnowf)&(anse.cnt2.0<cnowf+cnowflen)){
						ardel2 anse,ansenum,2,cnt2
						ansenum--
						cnt2--
					}
					cnt2++
				loop
	
				cnt2=0
				repeat tiltnum
					if((tilt.cnt2.0>=cnowf)&(tilt.cnt2.0<cnowf+cnowflen)){
						ardel2 tilt,tiltnum,2,cnt2
						tiltnum--
						cnt2--
					}
					cnt2++
				loop
	
				cnt2=0
				repeat ztopnum
					if((ztop.cnt2.0>=cnowf)&(ztop.cnt2.0<cnowf+cnowflen)){
						ardel2 ztop,ztopnum,3,cnt2
						ztopnum--
						cnt2--
					}
					cnt2++
				loop
	
				cnt2=0
				repeat zbotnum
					if((zbot.cnt2.0>=cnowf)&(zbot.cnt2.0<cnowf+cnowflen)){
						ardel2 zbot,zbotnum,3,cnt2
						zbotnum--
						cnt2--
					}
					cnt2++
				loop
	
				cnt2=0
				repeat zsidenum
					if((zside.cnt2.0>=cnowf)&(zside.cnt2.0<cnowf+cnowflen)){
						ardel2 zside,zsidenum,3,cnt2
						zsidenum--
						cnt2--
					}
					cnt2++
				loop
				
				cnt2=1
				repeat max(beatlnum-1,0),1
					if((beatl.cnt2.0>=cnowf)&(beatl.cnt2.0<cnowf+cnowflen)){
						ardel2 beatl,beatlnum,3,cnt2
						beatlnum--
						cnt2--
					}
					cnt2++
				loop
				
				cnt2=1
				repeat max(bpmlnum-1,0),1
					if((bpml.cnt2.0>=cnowf)&(bpml.cnt2.0<cnowf+cnowflen)){
						ardel2 bpml,bpmlnum,2,cnt2
						bpmlnum--
						cnt2--
					}
					cnt2++
				loop
				
				cnt2=0
				repeat commentnum
					if((comment.cnt2>=cnowf)&(comment.cnt2<cnowf+cnowflen)){
						ardel comment,commentnum,cnt2
						ardel commentstr,commentnum,cnt2
						commentnum--
						cnt2--
					}
					cnt2++
				loop
				
				cnt2=0
				repeat userchprmnum
					if((userchprm.cnt.0>=cnowf)&(userchprm.cnt.0<cnowf+cnowflen)){
						ardel2 userchprm,userchprmnum,6,cnt
						userchprmnum--
						cnt2--
					}
					cnt2++
				loop

				repeat notenum
					if(note.cnt.1>=cnowf+cnowflen){
						note.cnt.1-=cnowflen
					}
				loop
				repeat analognum
					if(analog.cnt.1>=cnowf+cnowflen){
						analog.cnt.1-=cnowflen
					}
				loop
				repeat chipratenum
					if((chiprate.cnt.0>=cnowf+cnowflen)){
						chiprate.cnt.0-=cnowflen
					}
				loop
				repeat longratenum
					if((longrate.cnt.0>=cnowf+cnowflen)){
						longrate.cnt.0-=cnowflen
					}
				loop
				repeat analogratenum
					if((analograte.cnt.0>=cnowf+cnowflen)){
						analograte.cnt.0-=cnowflen
					}
				loop
				repeat max(anagainnum-1,0),1
					if(anagain.cnt.0>=cnowf+cnowflen){
						anagain.cnt.0-=cnowflen
					}
				loop
				repeat max(anafilnum-1,0),1
					if(anafil.cnt.0>=cnowf+cnowflen){
						anafil.cnt.0-=cnowflen
					}
				loop
				repeat max(anvolnum-1,0),1
					if(anvol.cnt.0>=cnowf+cnowflen){
						anvol.cnt.0-=cnowflen
					}
				loop
				repeat ansenum
					if(anse.cnt.0>=cnowf+cnowflen){
						anse.cnt.0-=cnowflen
					}
				loop
				repeat spinnum
					if(spin.cnt.1>=cnowf+cnowflen){
						spin.cnt.1-=cnowflen
					}
				loop
				repeat tiltnum
					if(tilt.cnt.0>=cnowf+cnowflen){
						tilt.cnt.0-=cnowflen
					}
				loop
				repeat stpnum
					if(stp.cnt.0>=cnowf+cnowflen){
						stp.cnt.0-=cnowflen
					}
				loop
				repeat ztopnum
					if(ztop.cnt.0>=cnowf+cnowflen){
						ztop.cnt.0-=cnowflen
					}
				loop
				repeat zbotnum
					if(zbot.cnt.0>=cnowf+cnowflen){
						zbot.cnt.0-=cnowflen
					}
				loop
				repeat zsidenum
					if(zside.cnt.0>=cnowf+cnowflen){
						zside.cnt.0-=cnowflen
					}
				loop
				repeat max(beatlnum-1,0),1
					if(beatl.cnt.0>=cnowf+cnowflen){
						beatl.cnt.0-=cnowflen
					}
				loop
				repeat max(bpmlnum-1,0),1
					if(bpml.cnt.0>=cnowf+cnowflen){
						bpml.cnt.0-=cnowflen
					}
				loop
				repeat commentnum
					if((comment.cnt>=cnowf+cnowflen)){
						comment.cnt-=cnowflen
					}
				loop
				repeat userchprmnum
					if((userchprm.cnt.0>=cnowf+cnowflen)){
						userchprm.cnt.0-=cnowflen
					}
				loop
				if(anagainnum>=2){
					if((anagain.0.0=0)&(anagain.1.0=0)){
						ardel2 anagain,anagainnum,3,0
						anagainnum--
					}
				}
				if(anafilnum>=2){
					if((anafil.0.0=0)&(anafil.1.0=0)){
						ardel2 anafil,anafilnum,3,0
						anafilnum--
					}
				}
				if(anvolnum>=2){
					if((anvol.0.0=0)&(anvol.1.0=0)){
						ardel2 anvol,anvolnum,3,0
						anvolnum--
					}
				}
				if(beatlnum>=2){
					if((beatl.0.0=0)&(beatl.1.0=0)){
						ardel2 beatl,beatlnum,3,0
						beatlnum--
					}
				}
				if(bpmlnum>=2){
					if((bpml.0.0=0)&(bpml.1.0=0)){
						ardel2 bpml,bpmlnum,3,0
						bpmlnum--
					}
				}
				en=1
				gosub *selinit
			}
		}
		e=e|en
		gosub *draw
		gosub *refreshtitle
	}else:if(cmd=CMD_EDIT_COPY_TILT){
		if(pendfl!=-1):pendfl=1:return

		// 長さを正としたときのカウント値を求める
		cnowf_=min(cnowf,cnowf+cnowflen)
		cnowflen_=abs(cnowflen)

		if(cnowflen_>0){
			// tiltをコピー
			cliptiltnum=0
			repeat tiltnum
				if(tilt.cnt.0<cnowf_):continue
				if(tilt.cnt.0>=cnowf_+max(cnowflen_,1)):break

				cnt2=cnt
				repeat 3
					cliptilt.cliptiltnum.cnt=tilt.cnt2.cnt
				loop
				cliptiltnum++
			loop
		}
	
		// クリップボードのtilt以外を初期化
		clipnotenum=0
		clipanalognum=0
		clipspinnum=0
		clipstpnum=0
		clipztopnum=0
		clipzbotnum=0
		clipzsidenum=0
	}else:if(cmd=CMD_EDIT_DELETE_TILT){
		if(pendfl!=-1):pendfl=1:return
		if(cnowflen!=0):gosub *undokakuho
		
		// 長さを正としたときのカウント値を求める
		cnowf_=min(cnowf,cnowf+cnowflen)
		cnowflen_=abs(cnowflen)

		en=0

		cnt2=0
		repeat tiltnum
			if((tilt.cnt2.0>=cnowf_)&(tilt.cnt2.0<cnowf_+cnowflen_)){
				ardel2 tilt,tiltnum,3,cnt2
				tiltnum--
				en=1
				cnt2--
			}
			cnt2++
		loop

		e=e|en
		gosub *refreshtitle
		gosub *selinit
		gosub *draw
	}else:if(cmd=CMD_EDIT_COPY_ZOOM){
		if(pendfl!=-1):pendfl=1:return

		// 長さを正としたときのカウント値を求める
		cnowf_=min(cnowf,cnowf+cnowflen)
		cnowflen_=abs(cnowflen)

		if(cnowflen_>0){
			// zoom_topをコピー
			clipztopnum=0
			repeat ztopnum
				if(ztop.cnt.0<cnowf_):continue
				if(ztop.cnt.0>=cnowf_+max(cnowflen_,1)):break
				
				cnt2=cnt
				repeat 3
					clipztop.clipztopnum.cnt=ztop.cnt2.cnt
				loop
				clipztopnum++
			loop
	
			// zoom_bottomをコピー
			clipzbotnum=0
			repeat zbotnum
				if(zbot.cnt.0<cnowf_):continue
				if(zbot.cnt.0>=cnowf_+max(cnowflen_,1)):break
				
				cnt2=cnt
				repeat 3
					clipzbot.clipzbotnum.cnt=zbot.cnt2.cnt
				loop
				clipzbotnum++
			loop
	
			// zoom_sideをコピー
			clipzsidenum=0
			repeat zsidenum
				if(zside.cnt.0<cnowf_):continue
				if(zside.cnt.0>=cnowf_+max(cnowflen_,1)):break
				
				cnt2=cnt
				repeat 3
					clipzside.clipzsidenum.cnt=zside.cnt2.cnt
				loop
				clipzsidenum++
			loop
		}
	
		// クリップボードのzoom以外を初期化
		clipnotenum=0
		clipanalognum=0
		clipspinnum=0
		clipstpnum=0
		cliptiltnum=0
	}else:if(cmd=CMD_EDIT_DELETE_ZOOM){
		if(pendfl!=-1):pendfl=1:return
		if(cnowflen!=0):gosub *undokakuho
		
		// 長さを正としたときのカウント値を求める
		cnowf_=min(cnowf,cnowf+cnowflen)
		cnowflen_=abs(cnowflen)
		
		en=0
	
		cnt2=0
		repeat ztopnum
			if((ztop.cnt2.0>=cnowf_)&(ztop.cnt2.0<cnowf_+cnowflen_)){
				ardel2 ztop,ztopnum,3,cnt2
				ztopnum--
				en=1
				cnt2--
			}
			cnt2++
		loop

		cnt2=0
		repeat zbotnum
			if((zbot.cnt2.0>=cnowf_)&(zbot.cnt2.0<cnowf_+cnowflen_)){
				ardel2 zbot,zbotnum,3,cnt2
				zbotnum--
				en=1
				cnt2--
			}
			cnt2++
		loop

		cnt2=0
		repeat zsidenum
			if((zside.cnt2.0>=cnowf_)&(zside.cnt2.0<cnowf_+cnowflen_)){
				ardel2 zside,zsidenum,3,cnt2
				zsidenum--
				en=1
				cnt2--
			}
			cnt2++
		loop
		
		e=e|en
		gosub *refreshtitle
		gosub *selinit
		gosub *draw
	}else:if(cmd=CMD_EDIT_ADDBLANK){
		if(pendfl!=-1):pendfl=1:return
		en=0
		if(cnowflen=0){
			sdim it,256,1
			dim t,1
			sdim r,1024,1
			sdim opt,256,1
			i=0
			t.i=1 : it.i=lang.8.41/*"長さ:"*/ : opt.i=lang.8.42+"\n"+lang.8.43+"\n"+lang.8.44+"\n"+lang.8.45+"\n"+lang.8.46+"\n"+lang.8.47 : r.i="2"
			_input lang.8.40/*"空白の挿入"*/,it,t,opt,r,1,0
			if(stat!=-1){
				gosub *undokakuho
				gosub *selinit
				if(r=0){
					stat1=UNIT_MEASURE/4
				}else:if(r=1){
					stat1=UNIT_MEASURE/2
				}else:if(r=2){
					stat1=UNIT_MEASURE
				}else:if(r=3){
					stat1=UNIT_MEASURE*2
				}else:if(r=4){
					stat1=UNIT_MEASURE*4
				}else{
					stat1=UNIT_MEASURE*8
				}
				repeat notenum
					if(note.cnt.1>=cnowf){
						note.cnt.1+=stat1
					}
				loop
				repeat analognum
					if(analog.cnt.1>=cnowf){
						analog.cnt.1+=stat1
					}
				loop
				repeat chipratenum
					if(chiprate.cnt.0>=cnowf){
						chiprate.cnt.0+=stat1
					}
				loop
				repeat longratenum
					if(longrate.cnt.0>=cnowf){
						longrate.cnt.0+=stat1
					}
				loop
				repeat analogratenum
					if(analograte.cnt.0>=cnowf){
						analograte.cnt.0+=stat1
					}
				loop
				repeat max(anagainnum-1,0),1
					if(anagain.cnt.0>=cnowf){
						anagain.cnt.0+=stat1
					}
				loop
				repeat max(anafilnum-1,0),1
					if(anafil.cnt.0>=cnowf){
						anafil.cnt.0+=stat1
					}
				loop
				repeat max(anvolnum-1,0),1
					if(anvol.cnt.0>=cnowf){
						anvol.cnt.0+=stat1
					}
				loop
				repeat ansenum
					if(anse.cnt.0>=cnowf){
						anse.cnt.0+=stat1
					}
				loop
				repeat spinnum
					if(spin.cnt.1>=cnowf){
						spin.cnt.1+=stat1
					}
				loop
				repeat tiltnum
					if(tilt.cnt.0>=cnowf){
						tilt.cnt.0+=stat1
					}
				loop
				repeat stpnum
					if(stp.cnt.0>=cnowf){
						stp.cnt.0+=stat1
					}
				loop
				repeat ztopnum
					if(ztop.cnt.0>=cnowf){
						ztop.cnt.0+=stat1
					}
				loop
				repeat zbotnum
					if(zbot.cnt.0>=cnowf){
						zbot.cnt.0+=stat1
					}
				loop
				repeat zsidenum
					if(zside.cnt.0>=cnowf){
						zside.cnt.0+=stat1
					}
				loop
				repeat max(beatlnum-1,0),1
					if(beatl.cnt.0>=cnowf){
						beatl.cnt.0+=stat1
					}
				loop
				repeat max(bpmlnum-1,0),1
					if(bpml.cnt.0>=cnowf){
						bpml.cnt.0+=stat1
					}
				loop
				repeat commentnum
					if(comment.cnt>=cnowf){
						comment.cnt+=stat1
					}
				loop
				repeat userchprmnum
					if(userchprm.cnt.0>=cnowf){
						userchprm.cnt.0+=stat1
					}
				loop
				en=1
			}
		}else{
			gosub *undokakuho
			cnowf=min(cnowf,cnowf+cnowflen)
			stat1=abs(cnowflen)
			gosub *selinit
			repeat notenum
				if(note.cnt.1>=cnowf){
					note.cnt.1+=stat1
				}
			loop
			repeat analognum
				if(analog.cnt.1>=cnowf){
					analog.cnt.1+=stat1
				}
			loop
			repeat chipratenum
				if(chiprate.cnt.0>=cnowf){
					chiprate.cnt.0+=stat1
				}
			loop
			repeat longratenum
				if(longrate.cnt.0>=cnowf){
					longrate.cnt.0+=stat1
				}
			loop
			repeat analogratenum
				if(analograte.cnt.0>=cnowf){
					analograte.cnt.0+=stat1
				}
			loop
			repeat max(anagainnum-1,0),1
				if(anagain.cnt.0>=cnowf){
					anagain.cnt.0+=stat1
				}
			loop
			repeat max(anafilnum-1,0),1
				if(anafil.cnt.0>=cnowf){
					anafil.cnt.0+=stat1
				}
			loop
			repeat max(anvolnum-1,0),1
				if(anvol.cnt.0>=cnowf){
					anvol.cnt.0+=stat1
				}
			loop
			repeat ansenum
				if(anse.cnt.0>=cnowf){
					anse.cnt.0+=stat1
				}
			loop
			repeat spinnum
				if(spin.cnt.1>=cnowf){
					spin.cnt.1+=stat1
				}
			loop
			repeat tiltnum
				if(tilt.cnt.0>=cnowf){
					tilt.cnt.0+=stat1
				}
			loop
			repeat stpnum
				if(stp.cnt.0>=cnowf){
					stp.cnt.0+=stat1
				}
			loop
			repeat ztopnum
				if(ztop.cnt.0>=cnowf){
					ztop.cnt.0+=stat1
				}
			loop
			repeat zbotnum
				if(zbot.cnt.0>=cnowf){
					zbot.cnt.0+=stat1
				}
			loop
			repeat zsidenum
				if(zside.cnt.0>=cnowf){
					zside.cnt.0+=stat1
				}
			loop
			repeat max(beatlnum-1,0),1
				if(beatl.cnt.0>=cnowf){
					beatl.cnt.0+=stat1
				}
			loop
			repeat max(bpmlnum-1,0),1
				if(bpml.cnt.0>=cnowf){
					bpml.cnt.0+=stat1
				}
			loop
			repeat commentnum
				if(comment.cnt>=cnowf){
					comment.cnt+=stat1
				}
			loop
			repeat userchprmnum
				if(userchprm.cnt.0>=cnowf){
					userchprm.cnt.0+=stat1
				}
			loop
			en=1
		}
		e=e|en
		gosub *draw
		gosub *refreshtitle
	}else:if(cmd=CMD_EDIT_VIEWTIME){
		if(pendfl!=-1):pendfl=1:return
		cnowflen=0
		gosub *draw
		stat1=lang.10.0
		stat1=replace(stat1,"\%0",str(c2ta(cnowf)))
		stat1=replace(stat1,"\%1",str(offset))
		stat1=replace(stat1,"\%2",str(c2ta(cnowf)+offset))
		dialog stat1
	}else:if(cmd=CMD_EDIT_USE_CURSOR_TIME_FOR_SAMPLE){
		if(pendfl!=-1):pendfl=1:return
		stat1=c2ta(cnowf)+offset
		if(poffset!=stat1){
			poffset=stat1
			e=1
		}
		gosub *draw
		gosub *refreshtitle
	}else:if(cmd=CMD_EDIT_CLEARCOMMENT){
		// 注釈の全消去
		if(pendfl!=-1):pendfl=1:return
		if(commentnum>0){
			gosub *undokakuho
			stat1=0 // ループ中に削除された配列要素の個数を表す一時変数
			repeat commentnum
				// 注釈("//"から始まるもの)のみを削除
				// (直接編集が有効の場合は注釈以外も削除する)
				if (isDirectChartEditingEnabled | StartsWith(commentstr.(cnt-stat1), "//")) {
					ardel comment,commentnum,(cnt-stat1)
					ardel commentstr,commentnum,(cnt-stat1)
					commentnum--
					stat1++
					e=1
				}
			loop
			gosub *refreshtitle
		}
		gosub *draw
	}else:if(cmd=CMD_EDIT_CLEAR){
		if(pendfl!=-1):pendfl=1:return
		msgdlg lang.10.20,lang.0.26,4+$100,2
		if(stat=6){
			gosub *undokakuho
			notenum=0
			analognum=0
			chipratenum=0
			longratenum=0
			analogratenum=0
			if((anagainnum<=0)|(anagain.0.0!=0)){
				anagain.0.0=0
				anagain.0.1=50
			}
			anagainnum=1
			anafilnum=1
			anafil.0.0=0
			anafil.0.1=0
			if((anvolnum<=0)|(anvol.0.0!=0)){
				anvol.0.0=0
				anvol.0.1=50
			}
			anvolnum=1
			ansenum=0
			spinnum=0
			tiltnum=0
			stpnum=0
			ztopnum=0
			zbotnum=0
			zsidenum=0
			commentnum=0
			userchprmnum=0
			en=1
		}
		e=e|en
		gosub *draw
		gosub *refreshtitle
	}else:if(cmd=CMD_EDIT_SONGSETTINGS){
		if(pendfl=1):pendfl=-1
		if(pendfl!=-1):pendfl=1:acmd=-1:return
		sdim it,256,14
		dim t,14
		sdim r,1024,14
		sdim opt,256,14
		i=0
		t.i=2 : it.i=lang.7.1/*"曲のタイトル(title):"*/ : r.i=csongtitle : i++
		t.i=2 : it.i=lang.7.2/*"アーティスト名(artist):"*/ : r.i=csongartist : i++
		t.i=2 : it.i=lang.7.3/*"譜面データの作者名(effect):"*/ : r.i=csongeffect : i++
		t.i=1 : it.i=lang.7.4/*"ジャケットの画像ファイル名(jacket):"*/ : r.i=csongjacket : i++
		t.i=2 : it.i=lang.7.5/*"ジャケットのｲﾗｽﾄﾚｰﾀｰ名(illustrator):"*/ : r.i=csongillustrator : i++
		t.i=1 : it.i=lang.7.6/*"難易度(difficulty):"*/ : opt.i="Light\nChallenge\nExtended\nInfinite" : r.i=str(csongdifficulty) : i++
		t.i=1 : it.i=lang.7.7/*"レベル[1-20](level):"*/ : opt.i="1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20" : r.i=str(csonglevel-1) : i++
		bpmstat=str(double(bpml.0.1)/1000)
		bpmstat=strtrim(bpmstat,2,'0')
		bpmstat=strtrim(bpmstat,2,'.')
		t.i=1 : it.i=lang.7.8/*"BPM(t):"*/ : r.i=bpmstat : i++
		t.i=1 : it.i=lang.7.9/*"曲の音声ファイル名(m):"*/ : r.i=csongfile : i++
		t.i=0 : it.i=lang.9.5/*"曲の音量[%]:"*/ : r.i=str(csongvol) : i++
		t.i=0 : it.i=lang.7.10/*"曲の先頭のタイミング[msec](o):"*/ : r.i=str(offset) : i++
		t.i=0 : it.i=lang.7.11/*"選曲画面ﾌﾟﾚﾋﾞｭｰの先頭[msec](po):"*/ : r.i=str(poffset) : i++
		t.i=0 : it.i=lang.7.12/*"選曲画面ﾌﾟﾚﾋﾞｭｰの長さ[msec](plength):"*/ : r.i=str(plength) : i++
		bgstat=""
		switch bgname
		case "desert"
			stat1=0
			swbreak
		case "grass"
			stat1=1
			swbreak
		case "night"
			stat1=2
			swbreak
		case "deepsea"
			stat1=3
			swbreak
		case "sky"
			stat1=4
			swbreak
		case "sunset"
			stat1=5
			swbreak
		case "ocean"
			stat1=6
			swbreak
		case "flame"
			stat1=7
			swbreak
		case "cyber"
			stat1=8
			swbreak
		case "space"
			stat1=9
			swbreak
		case "mars"
			stat1=10
			swbreak
		case "cloudy"
			stat1=11
			swbreak
		case "fantasy"
			stat1=12
			swbreak
		default
			bgstat="\n"+bgname
			stat1=13
			swbreak
		swend
		t.i=1 : it.i=lang.7.25/*"プレイ背景(bg):"*/ : opt.i=lang.7.26+"\n"+lang.7.27+"\n"+lang.7.28+"\n"+lang.7.29+"\n"+lang.7.30+"\n"+lang.7.31+"\n"+lang.7.32+"\n"+lang.7.38+"\n"+lang.7.39+"\n"+lang.7.40+"\n"+lang.7.42+"\n"+lang.7.43+"\n"+lang.7.44/*"砂漠(desert)\n草原(grass)\n夜(night)\n深海(deepsea)\n空(sky)\n火炎(flame)\nサイバー(cyber)\n宇宙(space)\n火星(mars)\n薄曇り(cloudy)\n幻想(fantasy)"*/+bgstat : r.i=str(stat1) : i++
		bgstat=""
		switch bgname_l
		case "arrow"
			stat1_2=0
			swbreak
		case "smoke"
			stat1_2=1
			swbreak
		case "wave"
			stat1_2=2
			swbreak
		case "techno"
			stat1_2=3
			swbreak
		case "snow;1100;1"
			stat1_2=4
			swbreak
		case "sakura;900;1"
			stat1_2=5
			swbreak
		case "hidden"
			stat1_2=6
			swbreak
		default
			bgstat="\n"+bgname_l
			stat1_2=7
			swbreak
		swend
		f11fl=1
		t.i=1 : it.i=lang.7.48/*"プレイ背景の前面ｱﾆﾒｰｼｮﾝ(layer):"*/ : opt.i=lang.7.49+"\n"+lang.7.50+"\n"+lang.7.51+"\n"+lang.7.58+"\n"+lang.7.54+"\n"+lang.7.57+"\n"+lang.7.63/*"矢印(arrow)\nスモーク(smoke)\n波(wave)\nテクノ(techno)\n雪(snow)\n桜(sakura)\nなし(hidden)"*/+bgstat : r.i=str(stat1_2)
		_input lang.7.0/*"譜面に関する設定"*/,it,t,opt,r,0,0
		f11fl=0
		if(stat!=-1){
			i=-1
			i++ : if(csongtitle!=r.i) : csongtitle=r.i : e=e|1
			i++ : if(csongartist!=r.i) : csongartist=r.i : e=e|1
			i++ : if(csongeffect!=r.i) : csongeffect=r.i : e=e|1
			i++ : if(csongjacket!=r.i) : csongjacket=r.i : e=e|1
			i++ : if(csongillustrator!=r.i) : csongillustrator=r.i : e=e|1
			i++ : if(csongdifficulty!=int(r.i)) : csongdifficulty=int(r.i) : e=e|1
			i++ : if(csonglevel!=int(r.i)+1) : csonglevel=int(r.i)+1 : e=e|1
			if(csonglevel<1):csonglevel=1
			i++ : if((bpmstat!=r.i)&(int(double(r.i)*1000)>0)&(int(r.i)<65536)&(int(r.i)>0)&(stat!=-1)) : bpml.0.1=int(double(r.i)*1000) : e=e|1
			i++ : if(csongfile!=r.i) : csongfile=r.i : e=e|1
			i++ : if(csongvol!=r.i) : csongvol=max(int(r.i),0) : e=e|1
			i++ : if(offset!=int(r.i)) : offset=int(r.i) : e=e|1
			i++ : if(poffset!=int(r.i)) : poffset=int(r.i) : e=e|1
			i++ : if(plength!=int(r.i)) : plength=int(r.i) : e=e|1
			i++ : if(stat1!=r.i) : stat1=r.i : e=e|1
			i++ : if(stat1_2!=r.i) : stat1_2=r.i : e=e|1
			switch stat1
			case 0
				bgname="desert"
				swbreak
			case 1
				bgname="grass"
				swbreak
			case 2
				bgname="night"
				swbreak
			case 3
				bgname="deepsea"
				swbreak
			case 4
				bgname="sky"
				swbreak
			case 5
				bgname="sunset"
				swbreak
			case 6
				bgname="ocean"
				swbreak
			case 7
				bgname="flame"
				swbreak
			case 8
				bgname="cyber"
				swbreak
			case 9
				bgname="space"
				swbreak
			case 10
				bgname="mars"
				swbreak
			case 11
				bgname="cloudy"
				swbreak
			case 12
				bgname="fantasy"
				swbreak
			swend
			switch stat1_2
			case 0
				bgname_l="arrow"
				swbreak
			case 1
				bgname_l="smoke"
				swbreak
			case 2
				bgname_l="wave"
				swbreak
			case 3
				bgname_l="techno"
				swbreak
			case 4
				bgname_l="snow;1100;1"
				swbreak
			case 5
				bgname_l="sakura;900;1"
				swbreak
			case 6
				bgname_l="hidden"
				swbreak
			swend
			gosub *refreshtitle
			gosub *draw
		}
	}else:if(cmd=CMD_EDIT_SONGSETTINGS2){
		if(pendfl=1):pendfl=-1
		if(pendfl!=-1):pendfl=1:acmd=-1:return
		sdim it, 256, 7
		dim t, 7
		sdim r, 1024, 7
		sdim opt, 256, 7
		i=0
		t.i=2 : it.i=lang.7.20/*"曲についての情報(information):"*/ : r.i=csonginfo : i++
		stat2=str(double(csongoftbpm)/1000)
		stat2=strtrim(stat2,2,'0')
		stat2=strtrim(stat2,2,'.')
		t.i=0 : it.i=lang.9.3/*"ハイスピードの基準BPM値[0:自動]:"*/ : r.i=stat2 : i++
		t.i=1 : it.i=lang.9.7/*"幅の狭い直角ﾚｰｻﾞｰ音を小さくする:"*/ : opt.i=lang.9.8+"\n"+lang.9.9 : r.i=str(1-disableautoanvol) : i++
		t.i=0 : it.i=lang.9.10/*"LASER音声エフェクトの遅延[msec]:"*/ : r.i=str(laserdelay1) : i++
		t.i=0 : it.i=lang.9.15/*"TOTAL値[0:自動,100-:手動指定]:"*/ : r.i=str(csongtotal) : i++
		t.i=1 : it.i=lang.9.20/*"ｼﾞｬﾝﾙｱｲｺﾝ画像ﾌｧｲﾙ(比率2:1,PNG):"*/ : r.i=str(csongicon) : i++
		if (csongver = "") {
			csongver_ = "100"
		} else {
			csongver_ = csongver
		}
		t.i=1 : it.i = replace(lang.9.50, "%1", "" + CURRENT_KSH_VERSION)/*"KSH譜面ﾌｫｰﾏｯﾄのﾊﾞｰｼﾞｮﾝ(推奨値:%1):"*/ : r.i = csongver_ : i++
		_input lang.9.0/*"譜面に関する設定 (詳細)"*/,it,t,opt,r,0,0
		f11fl=0
		if(stat!=-1){
			i=-1
			i++ : if(csonginfo!=r.i) : csonginfo=r.i : e=e|1
			i++ : if((stat2!=r.1)&(int(double(r.i)*1000)>=0)&(int(double(r.i)*1000)<65536000)&(int(r.i)>=0)) : csongoftbpm=int(double(r.i)*1000) : e=e|1
			i++ : if(disableautoanvol!=1-int(r.i)) : disableautoanvol=1-int(r.i) : e=e|1
			i++ : if(laserdelay1!=r.i) : laserdelay1=max(int(r.i),0) : e=e|1
			i++ : if(csongtotal!=r.i) : csongtotal=int(r.i) : e=e|1
			if(csongtotal<100):csongtotal=0
			i++ : if(csongicon!=r.i) : csongicon=r.i : e=e|1
			i++ : if(csongver != r.i) : csongver = r.i : csongver_int = int(csongver) : clearKeySoundLibrary /* ←同時発音数が変化する可能性があるためキー音を初期化 */ : e = e | 1

			// KSH譜面フォーマットのバージョンが範囲外の値をとっている場合は丸める
			if (csongver_int >= 100 & csongver_int < 160) {
				csongver = "160"
				csongver_int = 160
			} else : if (csongver_int < 100 | csongver_int > CURRENT_KSH_VERSION) {
				csongver = "" + CURRENT_KSH_VERSION
				csongver_int = CURRENT_KSH_VERSION
			}

			gosub *refreshtitle
			gosub *draw
		}
	}else:if(cmd=CMD_TOOL_POINT){
		editmode=MODE_POINT
		gosub *refreshmenu_editmode
		gosub *draw
	}else:if(cmd=CMD_TOOL_PENCIL){
		editmode=MODE_PENCIL
		gosub *refreshmenu_editmode
		gosub *draw
	}else:if(cmd=CMD_TOOL_ERASE){
		editmode=MODE_ERASE
		gosub *refreshmenu_editmode
		gosub *draw
	}else:if(cmd=CMD_TOOL_POS){
		edittarget=TARGET_POS
		gosub *refreshmenu_edittarget
		gosub *draw
	}else:if(cmd=CMD_TOOL_NOTE){
		edittarget=TARGET_NOTE
		gosub *refreshmenu_edittarget
		gosub *draw
	}else:if(cmd=CMD_TOOL_NOTE2){
		edittarget=TARGET_NOTE2
		gosub *refreshmenu_edittarget
		gosub *draw
	}else:if(cmd=CMD_TOOL_LNOTE2){
		edittarget=TARGET_LNOTE2
		gosub *refreshmenu_edittarget
		gosub *draw
	}else:if(cmd=CMD_TOOL_LNOTE){
		edittarget=TARGET_LNOTE
		gosub *refreshmenu_edittarget
		gosub *draw
	}else:if(cmd=CMD_TOOL_ANALOGL){
		edittarget=TARGET_ANALOGL
		gosub *refreshmenu_edittarget
		gosub *draw
	}else:if(cmd=CMD_TOOL_ANALOGR){
		edittarget=TARGET_ANALOGR
		gosub *refreshmenu_edittarget
		gosub *draw
	}else:if(cmd=CMD_TOOL_ANALOGPFILTER){
		edittarget=TARGET_ANALOGPFILTER
		gosub *refreshmenu_edittarget
		gosub *draw
	}else:if(cmd=CMD_TOOL_ANALOGVOL){
		edittarget=TARGET_ANALOGVOL
		gosub *refreshmenu_edittarget
		gosub *draw
	}else:if(cmd=CMD_TOOL_SPIN){
		edittarget=TARGET_SPIN
		gosub *refreshmenu_edittarget
		gosub *draw
	}else:if(cmd=CMD_TOOL_ROTATE){
		edittarget=TARGET_ROTATE
		gosub *refreshmenu_edittarget
		gosub *draw
	}else:if(cmd=CMD_TOOL_ZOOMTOP){
		edittarget=TARGET_ZOOMTOP
		gosub *refreshmenu_edittarget
		gosub *draw
	}else:if(cmd=CMD_TOOL_ZOOMBOTTOM){
		edittarget=TARGET_ZOOMBOTTOM
		gosub *refreshmenu_edittarget
		gosub *draw
	}else:if(cmd=CMD_TOOL_ZOOMSIDE){
		edittarget=TARGET_ZOOMSIDE
		gosub *refreshmenu_edittarget
		gosub *draw
	}else:if(cmd=CMD_TOOL_STOP){
		edittarget=TARGET_STOP
		gosub *refreshmenu_edittarget
		gosub *draw
	}else:if(cmd=CMD_TOOL_4){
		CheckMenuItem hmenu, CMD_TOOL_4,  0x08
		CheckMenuItem hmenu, CMD_TOOL_8,  0x00
		CheckMenuItem hmenu, CMD_TOOL_12, 0x00
		CheckMenuItem hmenu, CMD_TOOL_16, 0x00
		CheckMenuItem hmenu, CMD_TOOL_24, 0x00
		CheckMenuItem hmenu, CMD_TOOL_32, 0x00
		CheckMenuItem hmenu, CMD_TOOL_48, 0x00
		CheckMenuItem hmenu, CMD_TOOL_64, 0x00
		CheckMenuItem hmenu, CMD_TOOL_96, 0x00
		CheckMenuItem hmenu, CMD_TOOL_192, 0x00
		editdiv=4
		gosub *draw
	}else:if(cmd=CMD_TOOL_8){
		CheckMenuItem hmenu, CMD_TOOL_4,  0x00
		CheckMenuItem hmenu, CMD_TOOL_8,  0x08
		CheckMenuItem hmenu, CMD_TOOL_12, 0x00
		CheckMenuItem hmenu, CMD_TOOL_16, 0x00
		CheckMenuItem hmenu, CMD_TOOL_24, 0x00
		CheckMenuItem hmenu, CMD_TOOL_32, 0x00
		CheckMenuItem hmenu, CMD_TOOL_48, 0x00
		CheckMenuItem hmenu, CMD_TOOL_64, 0x00
		CheckMenuItem hmenu, CMD_TOOL_96, 0x00
		CheckMenuItem hmenu, CMD_TOOL_192, 0x00
		editdiv=8
		gosub *draw
	}else:if(cmd=CMD_TOOL_12){
		CheckMenuItem hmenu, CMD_TOOL_4,  0x00
		CheckMenuItem hmenu, CMD_TOOL_8,  0x00
		CheckMenuItem hmenu, CMD_TOOL_12, 0x08
		CheckMenuItem hmenu, CMD_TOOL_16, 0x00
		CheckMenuItem hmenu, CMD_TOOL_24, 0x00
		CheckMenuItem hmenu, CMD_TOOL_32, 0x00
		CheckMenuItem hmenu, CMD_TOOL_48, 0x00
		CheckMenuItem hmenu, CMD_TOOL_64, 0x00
		CheckMenuItem hmenu, CMD_TOOL_96, 0x00
		CheckMenuItem hmenu, CMD_TOOL_192, 0x00
		editdiv=12
		gosub *draw
	}else:if(cmd=CMD_TOOL_16){
		CheckMenuItem hmenu, CMD_TOOL_4,  0x00
		CheckMenuItem hmenu, CMD_TOOL_8,  0x00
		CheckMenuItem hmenu, CMD_TOOL_12, 0x00
		CheckMenuItem hmenu, CMD_TOOL_16, 0x08
		CheckMenuItem hmenu, CMD_TOOL_24, 0x00
		CheckMenuItem hmenu, CMD_TOOL_32, 0x00
		CheckMenuItem hmenu, CMD_TOOL_48, 0x00
		CheckMenuItem hmenu, CMD_TOOL_64, 0x00
		CheckMenuItem hmenu, CMD_TOOL_96, 0x00
		CheckMenuItem hmenu, CMD_TOOL_192, 0x00
		editdiv=16
		gosub *draw
	}else:if(cmd=CMD_TOOL_24){
		CheckMenuItem hmenu, CMD_TOOL_4,  0x00
		CheckMenuItem hmenu, CMD_TOOL_8,  0x00
		CheckMenuItem hmenu, CMD_TOOL_12, 0x00
		CheckMenuItem hmenu, CMD_TOOL_16, 0x00
		CheckMenuItem hmenu, CMD_TOOL_24, 0x08
		CheckMenuItem hmenu, CMD_TOOL_32, 0x00
		CheckMenuItem hmenu, CMD_TOOL_48, 0x00
		CheckMenuItem hmenu, CMD_TOOL_64, 0x00
		CheckMenuItem hmenu, CMD_TOOL_96, 0x00
		CheckMenuItem hmenu, CMD_TOOL_192, 0x00
		editdiv=24
		gosub *draw
	}else:if(cmd=CMD_TOOL_32){
		CheckMenuItem hmenu, CMD_TOOL_4,  0x00
		CheckMenuItem hmenu, CMD_TOOL_8,  0x00
		CheckMenuItem hmenu, CMD_TOOL_12, 0x00
		CheckMenuItem hmenu, CMD_TOOL_16, 0x00
		CheckMenuItem hmenu, CMD_TOOL_24, 0x00
		CheckMenuItem hmenu, CMD_TOOL_32, 0x08
		CheckMenuItem hmenu, CMD_TOOL_48, 0x00
		CheckMenuItem hmenu, CMD_TOOL_64, 0x00
		CheckMenuItem hmenu, CMD_TOOL_96, 0x00
		CheckMenuItem hmenu, CMD_TOOL_192, 0x00
		editdiv=32
		gosub *draw
	}else:if(cmd=CMD_TOOL_48){
		CheckMenuItem hmenu, CMD_TOOL_4,  0x00
		CheckMenuItem hmenu, CMD_TOOL_8,  0x00
		CheckMenuItem hmenu, CMD_TOOL_12, 0x00
		CheckMenuItem hmenu, CMD_TOOL_16, 0x00
		CheckMenuItem hmenu, CMD_TOOL_24, 0x00
		CheckMenuItem hmenu, CMD_TOOL_32, 0x00
		CheckMenuItem hmenu, CMD_TOOL_48, 0x08
		CheckMenuItem hmenu, CMD_TOOL_64, 0x00
		CheckMenuItem hmenu, CMD_TOOL_96, 0x00
		CheckMenuItem hmenu, CMD_TOOL_192, 0x00
		editdiv=48
		gosub *draw
	}else:if(cmd=CMD_TOOL_64){
		CheckMenuItem hmenu, CMD_TOOL_4,  0x00
		CheckMenuItem hmenu, CMD_TOOL_8,  0x00
		CheckMenuItem hmenu, CMD_TOOL_12, 0x00
		CheckMenuItem hmenu, CMD_TOOL_16, 0x00
		CheckMenuItem hmenu, CMD_TOOL_24, 0x00
		CheckMenuItem hmenu, CMD_TOOL_32, 0x00
		CheckMenuItem hmenu, CMD_TOOL_48, 0x00
		CheckMenuItem hmenu, CMD_TOOL_64, 0x08
		CheckMenuItem hmenu, CMD_TOOL_96, 0x00
		CheckMenuItem hmenu, CMD_TOOL_192, 0x00
		editdiv=64
		gosub *draw
	}else:if(cmd=CMD_TOOL_96){
		CheckMenuItem hmenu, CMD_TOOL_4,  0x00
		CheckMenuItem hmenu, CMD_TOOL_8,  0x00
		CheckMenuItem hmenu, CMD_TOOL_12, 0x00
		CheckMenuItem hmenu, CMD_TOOL_16, 0x00
		CheckMenuItem hmenu, CMD_TOOL_24, 0x00
		CheckMenuItem hmenu, CMD_TOOL_32, 0x00
		CheckMenuItem hmenu, CMD_TOOL_48, 0x00
		CheckMenuItem hmenu, CMD_TOOL_64, 0x00
		CheckMenuItem hmenu, CMD_TOOL_96, 0x08
		CheckMenuItem hmenu, CMD_TOOL_192, 0x00
		editdiv=96
		gosub *draw
	}else:if(cmd=CMD_TOOL_192){
		CheckMenuItem hmenu, CMD_TOOL_4,  0x00
		CheckMenuItem hmenu, CMD_TOOL_8,  0x00
		CheckMenuItem hmenu, CMD_TOOL_12, 0x00
		CheckMenuItem hmenu, CMD_TOOL_16, 0x00
		CheckMenuItem hmenu, CMD_TOOL_24, 0x00
		CheckMenuItem hmenu, CMD_TOOL_32, 0x00
		CheckMenuItem hmenu, CMD_TOOL_48, 0x00
		CheckMenuItem hmenu, CMD_TOOL_64, 0x00
		CheckMenuItem hmenu, CMD_TOOL_96, 0x00
		CheckMenuItem hmenu, CMD_TOOL_192, 0x08
		editdiv=192
		gosub *draw
	}else:if(cmd=CMD_TOOL_ANALOGDETAIL0){
		CheckMenuItem hmenu, CMD_TOOL_ANALOGDETAIL0,  0x08
		CheckMenuItem hmenu, CMD_TOOL_ANALOGDETAIL1,  0x00
		CheckMenuItem hmenu, CMD_TOOL_ANALOGDETAIL2,  0x00
		analogdetail=0
	}else:if(cmd=CMD_TOOL_ANALOGDETAIL1){
		CheckMenuItem hmenu, CMD_TOOL_ANALOGDETAIL0,  0x00
		CheckMenuItem hmenu, CMD_TOOL_ANALOGDETAIL1,  0x08
		CheckMenuItem hmenu, CMD_TOOL_ANALOGDETAIL2,  0x00
		analogdetail=1
	}else:if(cmd=CMD_TOOL_ANALOGDETAIL2){
		CheckMenuItem hmenu, CMD_TOOL_ANALOGDETAIL0,  0x00
		CheckMenuItem hmenu, CMD_TOOL_ANALOGDETAIL1,  0x00
		CheckMenuItem hmenu, CMD_TOOL_ANALOGDETAIL2,  0x08
		analogdetail=2
	}else:if(cmd=CMD_TOOL_DISABLEANAN){
		disableanan=1-disableanan
		CheckMenuItem hmenu, CMD_TOOL_DISABLEANAN, 0x08*disableanan
	}else:if(cmd=CMD_TOOL_DISABLEANMIN){
		disableanmin=1-disableanmin
		CheckMenuItem hmenu, CMD_TOOL_DISABLEANMIN, 0x08*disableanmin
	}else:if(cmd=CMD_TOOL_ANARAN2XSTARTPOS){
		anaranadjpos=1-anaranadjpos
		CheckMenuItem hmenu, CMD_TOOL_ANARAN2XSTARTPOS, 0x08*anaranadjpos
	}else:if(cmd=CMD_TOOL_DIRECTCHARTEDITING){
		isDirectChartEditingEnabled = 1 - isDirectChartEditingEnabled
		CheckMenuItem hmenu, CMD_TOOL_DIRECTCHARTEDITING, 0x08 * isDirectChartEditingEnabled
		gosub *draw
	}else:if(cmd=CMD_VIEW_VSEPMINIMIZE){
		if(vsep=7){
			CheckMenuItem hmenu, CMD_VIEW_VSEPMINIMIZE, 0x00
			CheckMenuItem hmenu, CMD_VIEW_VSEPMAXIMIZE, 0x00
			vsep=24
			vyokor=8
		}else{
			CheckMenuItem hmenu, CMD_VIEW_VSEPMINIMIZE, 0x08
			CheckMenuItem hmenu, CMD_VIEW_VSEPMAXIMIZE, 0x00
			vsep=7
			vyokor=10
		}
		gosub *draw
		sendmsg hTool, 0x402, CMD_VIEW_VSEPMAXIMIZE,(vsep=72)
	}else:if(cmd=CMD_VIEW_VSEPMAXIMIZE){
		if(vsep=72){
			CheckMenuItem hmenu, CMD_VIEW_VSEPMAXIMIZE, 0x00
			CheckMenuItem hmenu, CMD_VIEW_VSEPMINIMIZE, 0x00
			vsep=24
			vyokor=8
		}else{
			CheckMenuItem hmenu, CMD_VIEW_VSEPMAXIMIZE, 0x08
			CheckMenuItem hmenu, CMD_VIEW_VSEPMINIMIZE, 0x00
			vsep=72
			vyokor=5
		}
		gosub *draw
		sendmsg hTool, 0x402, CMD_VIEW_VSEPMAXIMIZE,(vsep=72)
	}else:if(cmd=CMD_VIEW_MAXIMIZE){
		if(maximize=0){
			CheckMenuItem hmenu, CMD_VIEW_MAXIMIZE, 0x08
			gsel 0
			width 1194,64+vtate*vUNIT_MEASURE+SIZE_TOOLBAR_H
			maximize=1
		}else{
			CheckMenuItem hmenu, CMD_VIEW_MAXIMIZE, 0x00
			gsel 0
			width 660,64+vtate*vUNIT_MEASURE+SIZE_TOOLBAR_H
			maximize=0
		}
		gosub *draw
		sendmsg hTool, TB_AUTOSIZE, 0, 0
	}else:if(cmd=CMD_VIEW_2X){
		if(vzoomrate=1.0f){
			CheckMenuItem hmenu, CMD_VIEW_2X, 0x08
			getkey ctrl_key,17
			if(ctrl_key=1){
				vzoomrate=0.5f
			}else{
				vzoomrate=2.0f
			}
			posnow=vzoom(posnow)
			if(vtrace=1):vtrace=-1
		}else{
			CheckMenuItem hmenu, CMD_VIEW_2X, 0x00
			posnow*=10:posnow/=vzoom(10)
			vzoomrate=1.0f
			if(vtrace=-1):vtrace=1
		}
		sendmsg hTool, 0x402, CMD_VIEW_2X,  (vzoomrate!=1.0f)
		buffer 6,41+9*2,vUNIT_MEASURE*tate+1
		if(posnow<0):posnow=0
		if(posnow>=tate/vtate-vyk):posnow=tate/vtate-vyk-1
		gosub *draw
	}else:if(cmd=CMD_VIEW_ZOOMX){
		if(vzoomx=0){
			CheckMenuItem hmenu, CMD_VIEW_ZOOMX, 0x08
			vzoomx=1
		}else{
			CheckMenuItem hmenu, CMD_VIEW_ZOOMX, 0x00
			vzoomx=0
		}
		gosub *draw
	}else:if(cmd=CMD_VIEW_BARPERROW_2){
		vtate=2
		dd_reject 0,0
		screen 0,1194,64+vtate*vUNIT_MEASURE+SIZE_TOOLBAR_H
		width 660+(maximize=1)*534,64+vtate*vUNIT_MEASURE+SIZE_TOOLBAR_H
		dd_reject 0,1
		gosub *refreshtitle
		gosub *draw
		gosub *createtoolbar
	}else:if(cmd=CMD_VIEW_BARPERROW_3){
		vtate=3
		dd_reject 0,0
		screen 0,1194,64+vtate*vUNIT_MEASURE+SIZE_TOOLBAR_H
		width 660+(maximize=1)*534,64+vtate*vUNIT_MEASURE+SIZE_TOOLBAR_H
		dd_reject 0,1
		gosub *refreshtitle
		gosub *draw
		gosub *createtoolbar
	}else:if(cmd=CMD_VIEW_BARPERROW_4){
		vtate=4
		dd_reject 0,0
		screen 0,1194,64+vtate*vUNIT_MEASURE+SIZE_TOOLBAR_H
		width 660+(maximize=1)*534,64+vtate*vUNIT_MEASURE+SIZE_TOOLBAR_H
		dd_reject 0,1
		gosub *refreshtitle
		gosub *draw
		gosub *createtoolbar
	}else:if(cmd=CMD_VIEW_BARPERROW_5){
		vtate=5
		dd_reject 0,0
		screen 0,1194,64+vtate*vUNIT_MEASURE+SIZE_TOOLBAR_H
		width 660+(maximize=1)*534,64+vtate*vUNIT_MEASURE+SIZE_TOOLBAR_H
		dd_reject 0,1
		gosub *refreshtitle
		gosub *draw
		gosub *createtoolbar
	}else:if(cmd=CMD_VIEW_LINEBRIGHT){
		if(linebright=0){
			CheckMenuItem hmenu, CMD_VIEW_LINEBRIGHT, 0x08
			linebright=1
		}else{
			CheckMenuItem hmenu, CMD_VIEW_LINEBRIGHT, 0x00
			linebright=0
		}
		gosub *draw
	}else:if(cmd=CMD_VIEW_TRACE){
		if(vzoomrate=1.0f){
			if(vtrace=0){
				CheckMenuItem hmenu, CMD_VIEW_TRACE, 0x08
				vtrace=1
			}else{
				CheckMenuItem hmenu, CMD_VIEW_TRACE, 0x00
				vtrace=0
			}
			gosub *draw
		}
	}else:if(cmd=CMD_VIEW_TRACE_IMPORT){
		drawall=1
		dstat=double(vUNIT_MEASURE)
		dstat/=double(UNIT_MEASURE)
		dstat*=100
		rate=int(dstat)
		notesel buf
		dialog "ksh",16,lang.0.30/*"K-Shoot MANIA譜面ファイル"*/
		if(refstr=""):acmd=-1:return
		stat1=refstr
		exist stat1
		if((stat1="")|(strsize=-1)):acmd=-1:return
		sm=0
		t_csongver_int=100
		dim t_note,131072,6
		dim t_analog,131072,6
		dim t_spin,131072,6
		dim t_bpml,131072,2
		dim t_stp,131072,2
		dim t_anagain,131072,2
		dim t_anafil,131072,2
		dim t_anvol,131072,3
		dim t_anse,131072,2
		dim t_tilt,131072,3
		dim t_beatl,131072,3
		dim fxparams,131072,3
		dim fx,131072,5
		dim div,131072
		t_notenum=0
		t_analognum=0
		t_spinnum=0
		t_bpmlnum=0
		t_tiltnum=0
		t_stpnum=0
		t_beatlnum=0
		t_anagainnum=0
		t_anafilnum=0
		t_anvolnum=0
		t_ansenum=0
		fxparamsnum=0
		fxnum=0
		divnum=0
		buf=""
		notesel buf
		noteload stat1
		DeleteUTF8BOM buf
		sdim d,384,notemax
		repeat notemax
			noteget d.cnt,cnt
		loop
		sp=notemax
		buf=""
		cnt3=-1
		repeat sp
			cnt2=cnt
			if(d.cnt="--"){
				div.divnum=0
				exc=0
				repeat
					if(cnt2+cnt+1>=length(d)){
						break
					}
					if(d.(cnt2+cnt+1)="--"){
						break
					}
					if(strmid(d.(cnt2+cnt+1),7,1)!="|"){
						div.divnum--
					}
					div.divnum++
				loop
				divnum++
			}
		loop
		dim fxfl,2
		cnt2a=-1
		stat4=0
		t_stpsh=0
		ct_stp=-1
		cbcnt=0
		beatn=4
		beatd=4
		repeat sp
			cnt2a++
			if(d.cnt="--"){
				cnt3++ // カレント小節数
				if(cnt3>0):cbcnt+=UNIT_MEASURE*beatn/beatd
				cnt2=-1
				continue
			}
			if(StartsWith(d.cnt, "ver=")){
				t_csongver_int=int(strmid(d.cnt,4,3))
				continue
			}
			continuefl=0
			_cnt=cnt
			repeat 2
				if(headcmp(d._cnt,5,"fx-"+str_lr.cnt+"=")){
					fx.fxnum.0=cnt
					if(cnt3<0){
						fx.fxnum.1=cbcnt
					}else{
						fx.fxnum.1=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt
					}
					stat1=strmid(d._cnt,5,64)
					if(stat1=""){
						fx.fxnum.2=0
					}else{
						sdim fxsplitstat,1
						split stat1,";",fxsplitstat
						if(fxsplitstat.0=""){
							fx.fxnum.2=0
							f=0
						}else{
							f=1/*
							repeat userfxnum
								if(fxsplitstat.0=userfx_name.cnt){
									fx.fxnum.2=100+cnt
									if(userfx_params.cnt.0=FXDEF_FXTYPE_RETR){
										if(length(fxsplitstat)<=1){
											fx.fxnum.3=8
										}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
									}else:if(userfx_params.cnt.0=FXDEF_FXTYPE_GATE){
										if(length(fxsplitstat)<=1){
											fx.fxnum.3=4
										}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
									}else:if(userfx_params.cnt.0=FXDEF_FXTYPE_BITC){
										if(length(fxsplitstat)<=1){
											fx.fxnum.3=5
										}else:fx.fxnum.3=max(min(int(fxsplitstat.1),64),1)
									}else:if(userfx_params.cnt.0=FXDEF_FXTYPE_WOBB){
										if(length(fxsplitstat)<=1){
											fx.fxnum.3=12
										}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
									}else:if(userfx_params.cnt.0=FXDEF_FXTYPE_TSTP){
										if(length(fxsplitstat)<=1){
											fx.fxnum.3=50
										}else:fx.fxnum.3=max(min(int(fxsplitstat.1),100),1)
									}else:if(userfx_params.cnt.0=FXDEF_FXTYPE_ECHO){
										if(length(fxsplitstat)<=1){
											fx.fxnum.3=4
											fx.fxnum.4=60
										}else:if(length(fxsplitstat)<=2){
											fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
											fx.fxnum.4=60
										}else{
											fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
											fx.fxnum.4=max(min(int(fxsplitstat.2),100),0)
										}
									}
									f=0
									break
								}
							loop*/
						}
						if(f=1){
							switch fxsplitstat.0
							case "Retrigger":
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=8
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
								if(fx.fxnum.3=12){
									fx.fxnum.2=FX_RE12
								}else:if(fx.fxnum.3=16){
									fx.fxnum.2=FX_RE16
								}else:if(fx.fxnum.3=24){
									fx.fxnum.2=FX_RE24
								}else:if(fx.fxnum.3=32){
									fx.fxnum.2=FX_RE32
								}else{
									fx.fxnum.2=FX_RE8
								}
								swbreak
							case "Gate":
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=4
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
								if(fx.fxnum.3=8){
									fx.fxnum.2=FX_GA8
								}else:if(fx.fxnum.3=12){
									fx.fxnum.2=FX_GA12
								}else:if(fx.fxnum.3=16){
									fx.fxnum.2=FX_GA16
								}else:if(fx.fxnum.3=24){
									fx.fxnum.2=FX_GA24
								}else:if(fx.fxnum.3=32){
									fx.fxnum.2=FX_GA32
								}else{
									fx.fxnum.2=FX_GA4
								}
								swbreak
							case "Flanger":
								fx.fxnum.2=FX_FLAN
								swbreak
							case "PitchShift":
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=12
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),48),-48)
								fx.fxnum.2=FX_PITC
								swbreak
							case "Phaser":
								fx.fxnum.2=FX_PHAS
								swbreak
							case "BitCrusher":
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=5
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),64),0)
								fx.fxnum.2=FX_BITC
								swbreak
							case "Wobble":
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=12
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
								fx.fxnum.2=FX_WO12
								swbreak
							case "TapeStop":
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=50
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),100),0)
								fx.fxnum.2=FX_TSTP
								swbreak
							case "Echo":
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=4
									fx.fxnum.4=60
								}else:if(length(fxsplitstat)<=2){
									fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
									fx.fxnum.4=60
								}else{
									fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
									fx.fxnum.4=max(min(int(double(fxsplitstat.2)),100),0)
								}
								fx.fxnum.2=FX_EC4
								swbreak
							case "SideChain":
								fx.fxnum.2=FX_SICH
								swbreak
							case "":
								fx.fxnum.2=0
								swbreak
							default:
								fx.fxnum.2=0
								//dialog "Error: Undefined fx (\""+fxsplitstat.0+"\")"
							swend
						}
					}
					fxfl.cnt=1
					fxnum++
					continuefl=1
				}
			loop
			if(continuefl=1):continue
			if(StartsWith(d.cnt, "t=")){
				if((sm=0)&(int(double(strmid(d.cnt,2,64))*1000)>0)&(strmid(d.cnt,2,64)=replace(strmid(d.cnt,2,64),"-",""))){
					bpm=int(double(strmid(d.cnt,2,64))*1000)
					if(cnt3<0){
						t_bpml.t_bpmlnum.0=cbcnt
					}else{
						t_bpml.t_bpmlnum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt
					}
					if(t_bpml.t_bpmlnum.0<0):t_bpml.t_bpmlnum.0=0
					t_bpml.t_bpmlnum.1=min(bpm,65535000)
					t_bpmlnum++
				}
				continue
			}
			if(StartsWith(d.cnt, "beat=")){
				sdim beatstat,16,2
				stat1=strmid(d.cnt,5,33)
				split stat1,"/",beatstat
				if(length(beatstat)=2){
					if(cnt3<0){
						t_beatl.t_beatlnum.0=cbcnt+t_stpsh
					}else{
						t_beatl.t_beatlnum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt+t_stpsh
					}
					t_beatl.t_beatlnum.1=int(beatstat.0)
					t_beatl.t_beatlnum.2=int(beatstat.1)
					if((t_beatl.t_beatlnum.1>0)&(t_beatl.t_beatlnum.2>0)){
						t_beatlnum++
						beatn=int(beatstat.0)
						beatd=int(beatstat.1)
					}
				}
				continue
			}
			if(StartsWith(d.cnt, "stop=")){
				if(cnt3<0){
					t_stp.t_stpnum.0=cbcnt+t_stpsh
				}else{
					t_stp.t_stpnum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt+t_stpsh
				}
				if(t_stp.t_stpnum.0>=0){
					t_stp.t_stpnum.1=int(strmid(d.cnt,5,16))
					//t_stpsh+=t_stp.t_stpnum.1
					if(t_stpnum<=0){
						t_stpnum++
					}else:if(t_stp.(t_stpnum-1).0+t_stp.(t_stpnum-1).1<=t_stp.t_stpnum.0){
						t_stpnum++
					}
				}
				continue
			}
			if(StartsWith(d.cnt, "chokkakuvol=")){
				if(cnt3<0){
					t_anvol.t_anvolnum.0=cbcnt+t_stpsh
				}else{
					t_anvol.t_anvolnum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt+t_stpsh
				}
				if((int(strmid(d.cnt,12,3))>=0)&(int(strmid(d.cnt,12,3))<=100)){
					if((t_anvol.t_anvolnum.0<=0)&(t_anvolnum>=1)):t_anvolnum--
					t_anvol.t_anvolnum.1=int(strmid(d.cnt,12,3))
					t_anvolnum++
				}
				continue
			}
			if(StartsWith(d.cnt, "pfiltergain=")){
				if(cnt3<0){
					t_anagain.t_anagainnum.0=cbcnt+stpsh
				}else{
					t_anagain.t_anagainnum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt+stpsh
				}
				if((int(strmid(d.cnt,12,3))>=0)&(int(strmid(d.cnt,12,3))<=100)){
					if((t_anagain.t_anagainnum.0<=0)&(t_anagainnum>=1)):t_anagainnum--
					t_anagain.t_anagainnum.1=int(strmid(d.cnt,12,3))
					t_anagainnum++
				}
				continue
			}/*
			if(StartsWith(d.cnt, "filtertype=")){
				if(cnt3<0){
					t_anafil.t_anafilnum.0=cbcnt+stpsh
				}else{
					t_anafil.t_anafilnum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt+stpsh
				}
				if(strmid(d.cnt,11,4)="hpf1"){
					t_anafil.t_anafilnum.1=1
				}else:if(strmid(d.cnt,11,4)="hpf2"){
					t_anafil.t_anafilnum.1=2
				}else:if(strmid(d.cnt,11,4)="lpf1"){
					t_anafil.t_anafilnum.1=3
				}else:if(strmid(d.cnt,11,4)="lpf2"){
					t_anafil.t_anafilnum.1=4
				}else:t_anafil.t_anafilnum.1=0
				t_anafilnum++
				continue
			}*/
			if(StartsWith(d.cnt, "chokkakuse=")){
				if(cnt3<0){
					t_anse.t_ansenum.0=int(cbcnt)+t_stpsh
				}else{
					t_anse.t_ansenum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+int(cbcnt)+t_stpsh
				}
				f=1
				switch strmid(d.cnt,11,64)
				case "down"
					t_anse.t_ansenum.1=1
					swbreak
				case "up"
					t_anse.t_ansenum.1=2
					swbreak
				case "swing"
					t_anse.t_ansenum.1=3
					swbreak
				case "mute"
					t_anse.t_ansenum.1=4
					swbreak
				default
					f=0
				swend
				if(f=1):t_ansenum++
				continue
			}
			if(StartsWith(d.cnt, "tilt=")){
				if(cnt3<0){
					t_tilt.t_tiltnum.0=cbcnt+t_stpsh
				}else{
					t_tilt.t_tiltnum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt+t_stpsh
				}
				if(strmid(d.cnt,5,16)="normal"){
					t_tilt.t_tiltnum.1=0
				}
				if(strmid(d.cnt,5,16)="big"){
					t_tilt.t_tiltnum.1=1
				}
				if(strmid(d.cnt,5,16)="bigger"){
					t_tilt.t_tiltnum.1=1
				}
				if(strmid(d.cnt,5,16)="biggest"){
					t_tilt.t_tiltnum.1=2
				}
				if(strmid(d.cnt,5,16)="keep_normal"){
					t_tilt.t_tiltnum.1=3
				}
				if(strmid(d.cnt,5,16)="keep_bigger"){
					t_tilt.t_tiltnum.1=4
				}
				if(strmid(d.cnt,5,16)="keep_biggest"){
					t_tilt.t_tiltnum.1=5
				}
				if(strmid(d.cnt,5,16)="zero"){
					t_tilt.t_tiltnum.1=6
				}
				if(strmid(d.cnt,5,16)="keep"){
					t_tilt.t_tiltnum.1=4
				}
				if((t_tilt.t_tiltnum.0!=0)|(t_tilt.t_tiltnum.1!=0)):t_tiltnum++
				continue
			}
			if(StartsWith(d.cnt, "fx-l_param1=")){
				fxparams.fxparamsnum.0=0
				if(cnt3<0){
					fxparams.fxparamsnum.1=cbcnt
				}else{
					fxparams.fxparamsnum.1=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt
				}
				fxparams.fxparamsnum.2=int(strmid(d.cnt,12,8))
				fxparamsnum++
				continue
			}
			if(StartsWith(d.cnt, "fx-r_param1=")){
				fxparams.fxparamsnum.0=1
				if(cnt3<0){
					fxparams.fxparamsnum.1=cbcnt
				}else{
					fxparams.fxparamsnum.1=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt
				}
				fxparams.fxparamsnum.2=int(strmid(d.cnt,12,8))
				fxparamsnum++
				continue
			}
			if((strmid(d.cnt,7,1)!="|")|(d.cnt!=replace(d.cnt,"=",""))){
				continue
			}
			if(cnt3<0){
				dialog lang.0.8/*"譜面データの始端には小節線(--)を入力する必要があります。"*/,1,lang.0.2/*"エラー"*/
				break
			}
			if(div.cnt3=0){
				continue
			}
			cnt2++ // カレント小節数/div(小節内)
			exc=0
			if(cnt2a>0){
				repeat
					if((cnt2a-cnt-1)<0){
						exc=-1
						break
					}
					if(strmid(d.(cnt2a-cnt-1),4,1)!="|"){
						exc++
						continue
					}
					break
				loop
			}
			// ショートオブジェクトのリストアップ
			repeat 4
				// short
				if(strmid(d.cnt2a,cnt,1)="1"){
					t_note.t_notenum.0=cnt
					t_note.t_notenum.1=cbcnt+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3+t_stpsh
					t_note.t_notenum.2=0
					t_note.t_notenum.3=0
					t_notenum++
					stat4+=2
					continue
				}
				// long
				lcnt=cnt
				if(strmid(d.cnt2a,cnt,1)="2")&((strmid(d.(cnt2a-exc-1),cnt,1)!=strmid(d.cnt2a,cnt,1))|(exc=-1)){
					excd=0
					beatn2=beatn
					beatd2=beatd
					lend=UNIT_MEASURE*beatn2/beatd2/div.cnt3
					repeat
						if(cnt2a+cnt+1>=length(d)){
							break
						}
						if(d.(cnt2a+cnt+1)=""){
							continue
						}
						if(strmid(d.(cnt2a+cnt+1),0,2)="--"){
							excd++
							continue
						}
						if(StartsWith(d.(cnt2a+cnt+1), "beat=")){
							sdim beatstat,16,2
							stat1=strmid(d.(cnt2a+cnt+1),5,33)
							split stat1,"/",beatstat
							if(length(beatstat)=2){
								if((int(beatstat.0)>0)&(int(beatstat.1)>0)){
									beatn2=int(beatstat.0)
									beatd2=int(beatstat.1)
								}
							}
							continue
						}
						if(strmid(d.(cnt2a+cnt+1),4,1)!="|"){
							continue
						}
						if(strmid(d.(cnt2a+cnt+1),lcnt,1)=strmid(d.cnt2a,lcnt,1)){
							if(div.(cnt3+excd)=0):break
							lend+=UNIT_MEASURE*beatn2/beatd2/div.(cnt3+excd)
						}else{
							break
						}
					loop
					t_note.t_notenum.0=cnt
					t_note.t_notenum.1=cbcnt+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3+t_stpsh
					t_stpsh2=0
					if(sm=1){
						stat1=0
						repeat t_stpnum-ct_stp-1,ct_stp+1
							if(t_stp.cnt.0<cbcnt+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3+stat1/100){
								t_stpsh2+=t_stp.cnt.1
							}
						loop
					}
					t_note.t_notenum.2=lend+t_stpsh2
					stat1=strmid(d.cnt2a,cnt,1)
					t_note.t_notenum.3=0
					t_notenum++
				}
			loop
			// ロングオブジェクトのリストアップ
			repeat 2
				lcnt=cnt
				if(strmid(d.cnt2a,cnt+5,1)="2"){
					t_note.t_notenum.0=cnt+4
					t_note.t_notenum.1=cbcnt+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3+stpsh
					t_note.t_notenum.2=0
					t_note.t_notenum.3=0
					t_notenum++
					continue
				}
				if((strmid(d.cnt2a,cnt+5,1)!="0")&((strmid(d.(cnt2a-exc-1),cnt+5,1)!=strmid(d.cnt2a,cnt+5,1))|(exc=-1)|((t_csongver_int>=160)&(fxfl.cnt=1)))){
					excd=0
					beatn2=beatn
					beatd2=beatd
					lend=UNIT_MEASURE*beatn2/beatd2/div.cnt3
					repeat
						if(cnt2a+cnt+1>=length(d)){
							break
						}
						if(d.(cnt2a+cnt+1)=""){
							continue
						}
						if(strmid(d.(cnt2a+cnt+1),0,2)="--"){
							excd++
							continue
						}
						if((t_csongver_int>=160)&(headcmp(d.(cnt2a+cnt+1),5,"fx-"+str_lr.lcnt+"="))){
							break
						}
						if(StartsWith(d.(cnt2a+cnt+1), "beat=")){
							sdim beatstat,16,2
							stat1=strmid(d.(cnt2a+cnt+1),5,33)
							split stat1,"/",beatstat
							if(length(beatstat)=2){
								if((int(beatstat.0)>0)&(int(beatstat.1)>0)){
									beatn2=int(beatstat.0)
									beatd2=int(beatstat.1)
								}
							}
							continue
						}
						if(strmid(d.(cnt2a+cnt+1),4,1)!="|"){
							continue
						}
						if(strmid(d.(cnt2a+cnt+1),lcnt+5,1)=strmid(d.cnt2a,lcnt+5,1)){
							if(div.(cnt3+excd)=0):break
							lend+=UNIT_MEASURE*beatn2/beatd2/div.(cnt3+excd)
						}else{
							break
						}
					loop
					t_note.t_notenum.0=cnt+4
					t_note.t_notenum.1=cbcnt+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3+stpsh
					stpsh2=0
					if(sm=1){
						stat1=0
						repeat stpnum-cstp-1,cstp+1
							if(stp.cnt.0<cbcnt+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3+stat1/100){
								stpsh2+=stp.cnt.1
							}
						loop
					}
					t_note.t_notenum.2=lend+stpsh2
					if(t_csongver_int>=160){
						repeat fxnum
							if((fx.cnt.0=lcnt)&(fx.cnt.1=t_note.t_notenum.1)){
								t_note.t_notenum.3=fx.cnt.2
								t_note.t_notenum.4=fx.cnt.3
								t_note.t_notenum.5=fx.cnt.4
								break
							}
						loop
					}else{
						stat1=strmid(d.cnt2a,cnt+5,1)
						if(stat1="S"){
							t_note.t_notenum.3=1
							t_note.t_notenum.4=fx_div.(t_note.t_notenum.3)
						}else:if(stat1="V"){
							t_note.t_notenum.3=2
							t_note.t_notenum.4=fx_div.(t_note.t_notenum.3)
						}else:if(stat1="T"){
							t_note.t_notenum.3=3
							t_note.t_notenum.4=fx_div.(t_note.t_notenum.3)
						}else:if(stat1="W"){
							t_note.t_notenum.3=4
							t_note.t_notenum.4=fx_div.(t_note.t_notenum.3)
						}else:if(stat1="U"){
							t_note.t_notenum.3=5
							t_note.t_notenum.4=fx_div.(t_note.t_notenum.3)
						}else:if(stat1="G"){
							t_note.t_notenum.3=6
							t_note.t_notenum.4=fx_div.(t_note.t_notenum.3)
						}else:if(stat1="H"){
							t_note.t_notenum.3=7
							t_note.t_notenum.4=fx_div.(t_note.t_notenum.3)
						}else:if(stat1="K"){
							t_note.t_notenum.3=8
							t_note.t_notenum.4=fx_div.(t_note.t_notenum.3)
						}else:if(stat1="I"){
							t_note.t_notenum.3=9
							t_note.t_notenum.4=fx_div.(t_note.t_notenum.3)
						}else:if(stat1="L"){
							t_note.t_notenum.3=10
							t_note.t_notenum.4=fx_div.(t_note.t_notenum.3)
						}else:if(stat1="J"){
							t_note.t_notenum.3=11
							t_note.t_notenum.4=fx_div.(t_note.t_notenum.3)
						}else:if(stat1="F"){
							t_note.t_notenum.3=12
						}else:if(stat1="P"){
							t_note.t_notenum.3=13
							t_note.t_notenum.4=12
						}else:if(stat1="B"){
							t_note.t_notenum.3=14
							t_note.t_notenum.4=5
							repeat fxparamsnum
								if((fxparams.cnt.0=t_note.t_notenum.0-4)&(fxparams.cnt.1=t_note.t_notenum.1)){
									t_note.t_notenum.4=min(max(fxparams.cnt.2,0),64)
								}
							loop
						}else:if(stat1="Q"){
							t_note.t_notenum.3=15
						}else:if(stat1="X"){
							t_note.t_notenum.3=16
							t_note.t_notenum.4=fx_div.(t_note.t_notenum.3)
						}else:if(stat1="A"){
							t_note.t_notenum.3=17
							repeat fxparamsnum
								if((fxparams.cnt.0=t_note.t_notenum.0-4)&(fxparams.cnt.1=t_note.t_notenum.1)){
									t_note.t_notenum.4=min(max(fxparams.cnt.2,0),100)
								}
							loop
						}else:if(stat1="D"){
							t_note.t_notenum.3=19
						}else{
							t_note.t_notenum.3=0
						}
					}
					t_notenum++
				}
				fxfl.cnt=0
			loop
			// アナログデバイスのリストアップ
			repeat 2
				if((strmid(d.cnt2a,cnt+8,1)!="-")&(strmid(d.cnt2a,cnt+8,1)!=":")){
					cnt0=cnt
					// アナログデバイスの開始地点かどうかを判定
					exc=0
					if(cnt2a=0){
						t_analog.t_analognum.5=1
					}else{
						repeat
							if(cnt2a-cnt-1<0){
								t_analog.t_analognum.5=1
								break
							}
							if(strmid(d.(cnt2a-cnt-1),cnt0+8,1)=":"){
								exc++
								continue
							}
							if(strmid(d.(cnt2a-cnt-1),4,1)!="|"){
								exc++
								continue
							}
							break
						loop
						if(cnt2a-exc-1>=0){
							if(strmid(d.(cnt2a-exc-1),cnt+8,1)="-"){
								t_analog.t_analognum.5=1
							}
							if(cnt2a>1){
								exc2=0
								repeat
									if(strmid(d.(cnt2a-exc-cnt-1),4,1)!="|"){
										exc2++
										continue
									}
									break
								loop
							}
						}
					}
					// アナログデバイスの変化にかかる長さを確認
					excd=0
					stat3=0
					beatn2=beatn
					beatd2=beatd
					lend=UNIT_MEASURE*beatn2/beatd2/div.(cnt3+excd)
					repeat
						if(stat3=1){
							stat3=0
						}
						if(cnt2a+cnt+1>=sp){
							stat1=-1 // 異常
							break
						}
						if(strmid(d.(cnt2a+cnt+1),0,2)="--"){
							excd++
							continue
						}
						if(StartsWith(d.(cnt2a+cnt+1), "beat=")){
							sdim beatstat,16,2
							stat1=strmid(d.(cnt2a+cnt+1),5,33)
							split stat1,"/",beatstat
							if(length(beatstat)=2){
								if((int(beatstat.0)>0)&(int(beatstat.1)>0)){
									beatn2=int(beatstat.0)
									beatd2=int(beatstat.1)
								}
							}
							continue
						}
						if(strmid(d.(cnt2a+cnt+1),4,1)!="|"){
							continue
						}
						if(div.(cnt3+excd)=0){
							break
						}
						if(strmid(d.(cnt2a+cnt+1),cnt0+8,1)!=":"){
							stat1=a2p(strmid(d.(cnt2a+cnt+1),cnt0+8,1))
							break
						}
						lend+=UNIT_MEASURE*beatn2/beatd2/div.(cnt3+excd)
					loop
					// 異常がなければリストに追加
					if(stat1!=-1){
						t_analog.t_analognum.0=cnt0 // 対象のアナログデバイス(L:0,R:1)
						t_analog.t_analognum.1=cbcnt+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3+t_stpsh // 変化の始点カウント値
						t_analog.t_analognum.2=lend // 変化にかかる時間
						t_analog.t_analognum.3=a2p(strmid(d.cnt2a,cnt+8,1)) // 変化の初期値
						t_analog.t_analognum.4=stat1 // 変化の目標値
						t_analognum++
					}
				}
			loop
			// 画面回転のリストアップ
			if(strmid(d.cnt2a,10,1)="@"){
				f=1
				if(strmid(d.cnt2a,11,1)="("){
					t_spin.t_spinnum.0=0 // 時計回り回転
				}else:if(strmid(d.cnt2a,11,1)=")"){
					t_spin.t_spinnum.0=1 // 反時計回り
				}else:if(strmid(d.cnt2a,11,1)="<"){
					t_spin.t_spinnum.0=2 // 時計回り半回転
				}else:if(strmid(d.cnt2a,11,1)=">"){
					t_spin.t_spinnum.0=3 //反時計回り半回転
				}else:f=0
				if(f=1){
					t_spin.t_spinnum.1=cbcnt+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3+t_stpsh // 位置
					t_spin.t_spinnum.2=int(strmid(d.cnt2a,12,32)) // 長さ(c)
					t_spinnum++
				}
			}
			// ばねエフェクトのリストアップ
			if(strmid(d.cnt2a,10,1)="S"){
				f=1
				if(strmid(d.cnt2a,11,1)="<"){
					t_spin.t_spinnum.0=4 // 左向き
				}else:if(strmid(d.cnt2a,11,1)=">"){
					t_spin.t_spinnum.0=5 // 右向き
				}else:f=0
				if(f=1){
					t_spin.t_spinnum.1=cbcnt+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3+stpsh // 位置
					t_spin.t_spinnum.2=int(strmid(d.cnt2a,12,32)) // 長さ(c)
					stat1=strmid(d.cnt2a,12,64)
					sdim splitstat,64,1
					split stat1,";",splitstat
					t_spin.t_spinnum.3=250 //揺れ幅
					if(length(splitstat)>=2):t_spin.t_spinnum.3=max(int(splitstat.1),0)
					t_spin.t_spinnum.4=3 //回数 (片道+1 往復+2)
					if(length(splitstat)>=3):t_spin.t_spinnum.4=max(int(splitstat.2),0)
					if(t_spin.t_spinnum.4>0){
						t_spin.t_spinnum.5=2 //減衰の有無 (0:なし 1:あり(遅)　2:あり)
						if(length(splitstat)>=4):t_spin.t_spinnum.5=min(max(int(splitstat.3),0),2)
						t_spinnum++
					}
				}
			}
		loop
		buffer BUF_TRACE,41+9*2,tate*vUNIT_MEASURE+1
		pos 0,0
		color 0,0,0
		boxf
		cbcnt=0
		t_beatlfcnt=0
		beatn=4
		beatd=4
		repeat
			repeat max(t_beatlnum-t_beatlfcnt,0),t_beatlfcnt
				if(t_beatl.cnt.0<=cbcnt){
					beatn=t_beatl.cnt.1
					beatd=t_beatl.cnt.2
					t_beatlfcnt=cnt+1
				}else:break
			loop
			repeat beatn
				if(cnt=0){
					color 255,255,0
					line 9,tate*vUNIT_MEASURE-cbcnt*rate/100,41+7,tate*vUNIT_MEASURE-cbcnt*rate/100
				}else{
					color 56,56,56
					line 8,tate*vUNIT_MEASURE-cbcnt*rate/100,41+8,tate*vUNIT_MEASURE-cbcnt*rate/100
				}
				cbcnt+=vUNIT_MEASURE/beatd
			loop
			if(cbcnt>tate*vUNIT_MEASURE):break
		loop/*
		gmode 5,,,256
		repeat t_ansenum
			pos 0,tate*vUNIT_MEASURE-(t_anse.cnt.0)*rate/100-6
			gcopy BUF_CHOKKAKUSAMPLES,0,6*(t_anse.cnt.1-1),59,6
		loop
		gmode 5,,,256
		color 255,60,80
		repeat anvolnum
			cnt2=cnt
			stat2=0
			repeat t_tiltnum
				if(t_tilt.cnt.0=t_anvol.cnt2.0):stat2++
				if(t_tilt.cnt.0>t_anvol.cnt2.0):break
			loop
			repeat t_ansenum
				if(t_anse.cnt.0=t_anvol.cnt2.0):stat2++
				if(t_anse.cnt.0>t_anvol.cnt2.0):break
			loop
			line 0,tate*vUNIT_MEASURE-(anvol.cnt.0)*rate/100,41+(9+1)*2,tate*vUNIT_MEASURE-(anvol.cnt.0)*rate/100
			font fxfont,9
			pos 3,tate*vUNIT_MEASURE-(anvol.cnt.0)*rate/100-8-stat2*9
			mes str(anvol.cnt.1)
		loop
		gmode 5,,,256
		color 0,200,80
		repeat t_tiltnum
			if((cnt<0)|(cnt>=length(t_tilt))):continue
			stat2=0
			cnt2=cnt
			repeat t_ansenum
				if(t_anse.cnt.0=t_tilt.cnt2.0):stat2++
				if(t_anse.cnt.0>t_tilt.cnt2.0):break
			loop
			line 0,tate*vUNIT_MEASURE-(t_tilt.cnt.0)*rate/100,41+(9+1)*2,tate*vUNIT_MEASURE-(t_tilt.cnt.0)*rate/100
			font fxfont,9
			pos 3,tate*vUNIT_MEASURE-(t_tilt.cnt.0)*rate/100-8-stat2*9
			if(t_tilt.cnt.1=0):mes "NORMAL"
			if(t_tilt.cnt.1=1):mes "BIGGER"
			if(t_tilt.cnt.1=2):mes "BIGGEST"
			if(t_tilt.cnt.1=3):mes "KEEP(NOR)"
			if(t_tilt.cnt.1=4):mes "KEEP(ER)"
			if(t_tilt.cnt.1=5):mes "KEEP(EST)"
			if(t_tilt.cnt.1=6):mes "ZERO"
		loop*/
		color 150,240,60
		repeat t_beatlnum
			stat1=""+t_beatl.cnt.1+"/"+t_beatl.cnt.2
			stat2=0
			cnt2=cnt
			repeat t_bpmlnum
				if(t_bpml.cnt.0=t_beatl.cnt2.0):stat2=1
				if(t_bpml.cnt.0>t_beatl.cnt2.0):break
			loop
			line 0,tate*vUNIT_MEASURE-(t_beatl.cnt.0)*rate/100,41+(9+1)*2,tate*vUNIT_MEASURE-(t_beatl.cnt.0)*rate/100
			font fxfont,9
			pos 41+9*2-strlen(stat1)*5,tate*vUNIT_MEASURE-(t_beatl.cnt.0)*rate/100-8-stat2*9
			mes stat1
		loop
		color 100,160,255
		repeat t_bpmlnum
			stat1=str(double(t_bpml.cnt.1)/1000)
			stat1=strtrim(stat1,2,'0')
			stat1=strtrim(stat1,2,'.')
			line 0,tate*vUNIT_MEASURE-(t_bpml.cnt.0)*rate/100,41+(9+1)*2,tate*vUNIT_MEASURE-(t_bpml.cnt.0)*rate/100
			font fxfont,9
			pos 41+9*2-strlen(stat1)*5,tate*vUNIT_MEASURE-(t_bpml.cnt.0)*rate/100-8
			mes stat1
		loop
		repeat t_spinnum
			if(drawall=0){
				if(t_spin.cnt.1>UNIT_MEASURE*vtate*(posnow+vyk)):break
			}
			buffer 7,41,t_spin.cnt.2*rate/100
			pos 0,0
			cnt2=cnt
			stat1=0
			gzoom 41,t_spin.cnt.2*rate/100,BUF_SPIN,t_spin.cnt.0*41,(stat1=1)*192,41,192
			if((t_spin.cnt.0=4)|(t_spin.cnt.0=5)){
				color 240,210,220
				font fxfont,9
				mes ""+t_spin.cnt.3+"/"+t_spin.cnt.4
				pos 0,9
				stat1=""
				if(t_spin.cnt.5=0):stat1="DECAY:OFF":font fxfont,8
				if(t_spin.cnt.5=1):stat1="DECAY:SLOW":font fxfont,8
				mes stat1
			}
			gsel BUF_TRACE
			pos 9+1,tate*vUNIT_MEASURE-t_spin.cnt.2*rate/100-(t_spin.cnt.1)*rate/100
			gcopy 7,0,0,41,t_spin.cnt.2*rate/100
		loop
		repeat t_stpnum
			if(drawall=0){
				if(t_stp.cnt.0+t_stp.cnt.1<UNIT_MEASURE*vtate*posnow):continue
				if(t_stp.cnt.0>UNIT_MEASURE*vtate*(posnow+vyk)):break
			}
			buffer 7,41,t_stp.cnt.1*rate/100
			pos 0,0
			cnt2=cnt
			stat1=0
			gzoom 41,t_stp.cnt.1*rate/100,BUF_STOP,0,(stat1=1)*192,41,192
			gsel BUF_TRACE
			pos 9+1,tate*vUNIT_MEASURE-t_stp.cnt.1*rate/100-(t_stp.cnt.0)*rate/100
			gcopy 7,0,0,41,t_stp.cnt.1*rate/100
		loop
		repeat t_notenum
			if(drawall=0){
				if(t_note.cnt.1+t_note.cnt.2<UNIT_MEASURE*vtate*posnow):continue
				if(t_note.cnt.1>UNIT_MEASURE*vtate*(posnow+vyk)):break
			}
			if(t_note.cnt.0>3){
				if(t_note.cnt.2!=0){
					cnt2=cnt
					stat1=0
					repeat selt_notenum
						if(selt_note.cnt=cnt2):stat1=1:break
					loop
					buffer 7,19,t_note.cnt.2*rate/100
					pos 0,0
					if(t_note.cnt.3>=100){
						gzoom 19,t_note.cnt.2*rate/100,BUF_LNOTE,0,(stat1=1)+int(userfx_params.(t_note.cnt.3-100).0)*2+2,19,1
					}else:gzoom 19,t_note.cnt.2*rate/100,BUF_LNOTE,0,(stat1=1)+((t_note.cnt.3>=1)+(t_note.cnt.3>=6)+(t_note.cnt.3>=12)+(t_note.cnt.3>=13)*(t_note.cnt.3-12))*2,19,1
					color 255,255,255
					font fxfont,10
					if(t_note.cnt.3>=100){
						stat1=0
						stat2=userfx_name.(t_note.cnt.3-100)
						if(int(userfx_params.(t_note.cnt.3-100).0)=FXDEF_FXTYPE_RETR)|(int(userfx_params.(t_note.cnt.3-100).0)=FXDEF_FXTYPE_GATE)|(int(userfx_params.(t_note.cnt.3-100).0)=FXDEF_FXTYPE_WOBB)|(int(userfx_params.(t_note.cnt.3-100).0)=FXDEF_FXTYPE_ECHO){
							if((t_note.cnt.4<100)|(strlen(stat2)\4!=1)){
								if((strlen(stat2)\2!=0)|(strlen(str(t_note.cnt.4))=1)):stat2+=" "
							}
							stat2+=""+t_note.cnt.4
						}
						repeat int(ceil(double(strlen(stat2))/4.0f))
							pos 0,stat1*9
							mes strmid(stat2,cnt*4,4)
							stat1++
						loop
						pos 0,stat1*9
						if(int(userfx_params.(t_note.cnt.3-100).0)=FXDEF_FXTYPE_BITC){
							if(t_note.cnt.4!=10):mes ""+t_note.cnt.4
						}
						if(int(userfx_params.(t_note.cnt.3-100).0)=FXDEF_FXTYPE_TSTP){
							mes ""+t_note.cnt.4
						}
						if(int(userfx_params.(t_note.cnt.3-100).0)=FXDEF_FXTYPE_ECHO){
							mes ""+t_note.cnt.5+"%"
						}
					}
					if(t_note.cnt.3=1){
						if(t_note.cnt.4>=100){
							mes "R"+t_note.cnt.4
						}else:if(t_note.cnt.4>=10){
							mes "Re"+t_note.cnt.4
						}else{
							mes "Re "+t_note.cnt.4
						}
					}
					if(t_note.cnt.3=2){
						mes "Re12"
					}
					if(t_note.cnt.3=3){
						mes "Re16"
					}
					if(t_note.cnt.3=4){
						mes "Re24"
					}
					if(t_note.cnt.3=5){
						mes "Re32"
					}
					if(t_note.cnt.3=6){
						if(t_note.cnt.4>=100){
							mes "G"+t_note.cnt.4
						}else:if(t_note.cnt.4>=10){
							mes "Ga"+t_note.cnt.4
						}else{
							mes "Ga "+t_note.cnt.4
						}
					}
					if(t_note.cnt.3=7){
						mes "Ga 8"
					}
					if(t_note.cnt.3=8){
						mes "Ga12"
					}
					if(t_note.cnt.3=9){
						mes "Ga16"
					}
					if(t_note.cnt.3=10){
						mes "Ga24"
					}
					if(t_note.cnt.3=11){
						mes "Ga32"
					}
					if(t_note.cnt.3=12){
						mes "Flan"
					}
					if(t_note.cnt.3=13){
						mes "Pitc"
						pos 0,9
						if(t_note.cnt.4!=12):mes ""+t_note.cnt.4
					}
					if(t_note.cnt.3=14){
						mes "BitC"
						pos 0,9
						if(t_note.cnt.4!=10):mes ""+t_note.cnt.4
					}
					if(t_note.cnt.3=15){
						mes "Phas"
					}
					if(t_note.cnt.3=16){
						if(t_note.cnt.4>=100){
							mes "W"+t_note.cnt.4
						}else:if(t_note.cnt.4>=10){
							mes "Wo"+t_note.cnt.4
						}else{
							mes "Wo "+t_note.cnt.4
						}
					}
					if(t_note.cnt.3=17){
						mes "TStp"
						pos 0,9
						mes ""+t_note.cnt.4
					}
					if(t_note.cnt.3=18){
						if(t_note.cnt.4>=100){
							mes "E"+t_note.cnt.4
						}else:if(t_note.cnt.4>=10){
							mes "Ec"+t_note.cnt.4
						}else{
							mes "Ec "+t_note.cnt.4
						}
						pos 0,9
						mes ""+t_note.cnt.5+"%"
					}
					if(t_note.cnt.3=19){
						mes "SiCh"
					}
					gsel BUF_TRACE
					pos 9+1+20*(t_note.cnt.0-4),tate*vUNIT_MEASURE-t_note.cnt.2*rate/100-(t_note.cnt.1)*rate/100
					gcopy 7,0,0,19,t_note.cnt.2*rate/100
				}
			}
		loop
		gmode 5,,,256
		repeat vtate*vyoko+1
			pos 9,(cnt-1)*vUNIT_MEASURE+1
			gcopy BUF_ST+(vzoomrate>1.0f),0,0,41,vUNIT_MEASURE
		loop
		repeat t_analognum
			if(drawall=0){
				if(t_analog.cnt.1+t_analog.cnt.2<UNIT_MEASURE*vtate*posnow):continue
				if(t_analog.cnt.1>UNIT_MEASURE*vtate*(posnow+vyk)):break
			}
			cnt2=cnt
			selstat=0
			if(t_analog.cnt.5=1){
				pos t_analog.cnt.3,tate*vUNIT_MEASURE-(t_analog.cnt.1)*rate/100
				gcopy BUF_ANALOG,9*t_analog.cnt.0,1+6*(selstat=1),9,5
			}
			dim sx1,4
			dim sy1,4
			dim sx2,4
			dim sy2,4/*
			sx2=9*t_analog.cnt.0,9+9*t_analog.cnt.0,9+9*t_analog.cnt.0,9*t_analog.cnt.0
			sy2=6*(selstat=1),6*(selstat=1),6*(selstat=1),6*(selstat=1)
			*/
			if(t_analog.cnt.0=0){
				color 0,115,144
			}else{
				color 194,6,140
			}
			if(t_analog.cnt.2<=UNIT_MEASURE/32){
				if(t_analog.cnt.3<=t_analog.cnt.4){
					sx1=t_analog.cnt.3,9+t_analog.cnt.4,9+t_analog.cnt.4,t_analog.cnt.3
				}else{
					sx1=t_analog.cnt.4,t_analog.cnt.3+9,t_analog.cnt.3+9,t_analog.cnt.4
				}
				sy1=tate*vUNIT_MEASURE-((t_analog.cnt.1+t_analog.cnt.2))*rate/100,tate*vUNIT_MEASURE-((t_analog.cnt.1+t_analog.cnt.2))*rate/100,tate*vUNIT_MEASURE-(t_analog.cnt.1)*rate/100,tate*vUNIT_MEASURE-(t_analog.cnt.1)*rate/100
			}else{
				sx1=t_analog.cnt.4,9+t_analog.cnt.4,9+t_analog.cnt.3,t_analog.cnt.3
				sy1=tate*vUNIT_MEASURE-((t_analog.cnt.1+t_analog.cnt.2))*rate/100,tate*vUNIT_MEASURE-((t_analog.cnt.1+t_analog.cnt.2))*rate/100,tate*vUNIT_MEASURE-(t_analog.cnt.1)*rate/100,tate*vUNIT_MEASURE-(t_analog.cnt.1)*rate/100
			}
			gsquare -1/*BUF_ANALOG*/,sx1,sy1//,sx2,sy2
			if((t_analog.cnt.2<=UNIT_MEASURE/32)&(t_analog.cnt.2>0)&(t_analog.cnt.3!=t_analog.cnt.4)){
				stattype=t_analog.cnt.0
				statpos=t_analog.cnt.1+t_analog.cnt.2
				f2=1
				repeat max(t_analognum-(cnt+1),0),cnt+1
					if((t_analog.cnt.1=statpos)&(t_analog.cnt.0=stattype)&(t_analog.cnt.2>0)){
						f2=0
						break
					}
					if(t_analog.cnt.1>statpos):break
				loop
				if(f2=1){
					sx1=t_analog.cnt.4,9+t_analog.cnt.4,9+t_analog.cnt.4,t_analog.cnt.4
					sy1=tate*vUNIT_MEASURE-((statpos+4))*rate/100,tate*vUNIT_MEASURE-((statpos+4))*rate/100,tate*vUNIT_MEASURE-(statpos)*rate/100,tate*vUNIT_MEASURE-(statpos)*rate/100
					gsquare -1/*BUF_ANALOG*/,sx1,sy1//,sx2,sy2
				}
			}
			f=0
			stat2=0
			stat3=-1
		loop
		repeat t_notenum
			if(drawall=0){
				if(t_note.cnt.1+t_note.cnt.2<UNIT_MEASURE*vtate*posnow):continue
				if(t_note.cnt.1>UNIT_MEASURE*vtate*(posnow+vyk)):break
			}
			if(t_note.cnt.0>3){
				if(t_note.cnt.2=0){
					cnt2=cnt
					stat1=0
					pos 9+1+20*(t_note.cnt.0-4),tate*vUNIT_MEASURE-5-(t_note.cnt.1)*rate/100
					gmode 3,,,160
					gcopy BUF_LNOTE2,0,5*(stat1=1),19,5
					gmode 5,,,96
					gcopy BUF_LNOTE2,0,5*(stat1=1),19,5
				}
			}
		loop
		repeat t_notenum
			if(drawall=0){
				if(t_note.cnt.1+t_note.cnt.2<UNIT_MEASURE*vtate*posnow):continue
				if(t_note.cnt.1>UNIT_MEASURE*vtate*(posnow+vyk)):break
			}
			if(t_note.cnt.0<=3){
				if(t_note.cnt.2=0){
					gmode 0
					cnt2=cnt
					stat1=0
					pos 9+1+10*t_note.cnt.0,tate*vUNIT_MEASURE-3-(t_note.cnt.1)*rate/100
					gcopy BUF_NOTE,0,3*(stat1=1),9,3
				}else{
					gmode 5,,,256
					cnt2=cnt
					stat1=0
					buffer 7,9,t_note.cnt.2*rate/100
					pos 0,0
					gzoom 9,t_note.cnt.2*rate/100,BUF_NOTE2,0,stat1,9,1
					gsel BUF_TRACE
					pos 9+1+10*t_note.cnt.0,tate*vUNIT_MEASURE-(t_note.cnt.1+t_note.cnt.2)*rate/100
					gcopy 7,0,0,9,t_note.cnt.2*rate/100
				}
			}
		loop
		sdim d,1
		/*
		if((strmid(stat1,-1,3)="gif")|(strmid(stat1,-1,3)="GIF")){
			CheckMenuItem hmenu, CMD_VIEW_TRACE, 0x08
			vtrace=1
			buffer BUF_TRACE,41+9*2,192*tate+1
			pos 0,0
			color 96,96,96
			boxf
			buffer 7
			picload stat1
			cx=20
			cy=ginfo_winy-5
			cnt1=-1
			dim col1,6
			col1=0,0,0, 0,2,0
			repeat
				pget cx-1,cy // 小節線の確認
				stat1=0
				repeat length(col1)/3
					if((ginfo_r=col1.(cnt*3))&(ginfo_g=col1.(cnt*3+1))&(ginfo_b=col1.(cnt*3+2))):stat1=1
				loop
				if((stat1=1)|(cy<=0)){
					stat1=ginfo_winy-5
					gsel BUF_TRACE
					gmode 0
					pos 0,ginfo_winy-cnt1-1
					gcopy 7,cx-10,cy,cx+48,stat1
					gsel 7
					cx+=69
					cy=ginfo_winy-5-(ginfo_winy-cy-5)\48
					continue
				}
				cnt1++
				dcnt=cnt1/(48*4) // 小節数
				cy--
				if(cx>ginfo_winx):break
			loop
			vtracesh=0
			gosub *draw
		}*/
		CheckMenuItem hmenu, CMD_VIEW_TRACE, 0x08
		vtrace=1
		drawall=0
		vtracesh=0
		gosub *draw
	}else:if(cmd=CMD_VIEW_TRACE_SHIFTINIT){
		vtracesh=0
		gosub *draw
	}else:if(cmd=CMD_VIEW_TRACE_SHIFTUP){
		vtracesh+=UNIT_MEASURE/editdiv
		gosub *draw
	}else:if(cmd=CMD_VIEW_TRACE_SHIFTDOWN){
		vtracesh-=UNIT_MEASURE/editdiv
		gosub *draw
	}else:if(cmd=CMD_VIEW_TRACE_SHIFTUPD){
		vtracesh+=UNIT_MEASURE
		gosub *draw
	}else:if(cmd=CMD_VIEW_TRACE_SHIFTDOWND){
		vtracesh-=UNIT_MEASURE
		gosub *draw
	}else:if(cmd=CMD_PLAY_PLAY){
		gosub *playing
	}else:if(cmd=CMD_PLAY_SYNCHRO){
		if(synchro=0){
			CheckMenuItem hmenu, CMD_PLAY_SYNCHRO, 0x08
			synchro=1
		}else{
			CheckMenuItem hmenu, CMD_PLAY_SYNCHRO, 0x00
			synchro=0
		}
	}else:if(cmd=CMD_PLAY_TICK){
		if(assisttick=0){
			CheckMenuItem hmenu, CMD_PLAY_TICK, 0x08
			assisttick=1
			//acmd=CMD_PLAY_VOL_75
			//gosub *OnCommand
		}else{
			CheckMenuItem hmenu, CMD_PLAY_TICK, 0x00
			assisttick=0
			//acmd=CMD_PLAY_VOL_100
			//gosub *OnCommand
		}
		sendmsg hTool, 0x402, CMD_PLAY_TICK,  assisttick
	}else:if(cmd=CMD_PLAY_FX){
		if(preview_fx=0){
			CheckMenuItem hmenu, CMD_PLAY_FX, 0x08
			preview_fx=1
		}else{
			CheckMenuItem hmenu, CMD_PLAY_FX, 0x00
			preview_fx=0
		}
	}else:if(cmd=CMD_PLAY_LASER){
		if(preview_laser=0){
			CheckMenuItem hmenu, CMD_PLAY_LASER, 0x08
			preview_laser=1
		}else{
			CheckMenuItem hmenu, CMD_PLAY_LASER, 0x00
			preview_laser=0
		}
	}else:if(cmd=CMD_PLAY_CHOKKAKU){
		if(enablean=0){
			CheckMenuItem hmenu, CMD_PLAY_CHOKKAKU, 0x08
			enablean=1
		}else{
			CheckMenuItem hmenu, CMD_PLAY_CHOKKAKU, 0x00
			enablean=0
		}
	}else:if(cmd=CMD_PLAY_LOOPPLAYBACK){
		if(loopplayback=0){
			CheckMenuItem hmenu, CMD_PLAY_LOOPPLAYBACK, 0x08
			loopplayback=1
		}else{
			CheckMenuItem hmenu, CMD_PLAY_LOOPPLAYBACK, 0x00
			loopplayback=0
		}
	}else:if(cmd=CMD_PLAY_VOL_100){
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_100, 0x08
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_75, 0x00
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_50, 0x00
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_25, 0x00
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_0, 0x00
		vol=100
	}else:if(cmd=CMD_PLAY_VOL_75){
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_100, 0x00
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_75, 0x08
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_50, 0x00
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_25, 0x00
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_0, 0x00
		vol=75
	}else:if(cmd=CMD_PLAY_VOL_50){
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_100, 0x00
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_75, 0x00
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_50, 0x08
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_25, 0x00
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_0, 0x00
		vol=50
	}else:if(cmd=CMD_PLAY_VOL_25){
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_100, 0x00
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_75, 0x00
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_50, 0x00
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_25, 0x08
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_0, 0x00
		vol=25
	}else:if(cmd=CMD_PLAY_VOL_0){
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_100, 0x00
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_75, 0x00
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_50, 0x00
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_25, 0x00
		CheckMenuItem hplayvolmenu, CMD_PLAY_VOL_0, 0x08
		vol=0
	}else:if(cmd=CMD_PLAY_BPMHALF){
		_bpmhalf=1-_bpmhalf
		CheckMenuItem hplaymenu, CMD_PLAY_BPMHALF, 0x08*_bpmhalf
	}else:if(cmd=CMD_PLAY_SAMPLE){
		if(pendfl!=-1){
			pendfl=1
			acmd=-1:return
		}
		playingsample=1
		if(fname!=""){
			sdim csongflist,256,1
			split csongfile,";",csongflist
			exist getpath(fname,32)+csongflist.0
			if(strsize!=-1){
				filepath=getpath(fname,32)+csongflist.0
				mid=BASS_StreamCreateFile(0,filepath,0,0,0,0,0x20000)
				mlength=BASS_ChannelGetLength_ms(mid)
				if(csongvol>100){
					hVolFX=BASS_ChannelSetFX(mid,0x10003,0)
					dim volfx,2
					volfx=0,tofloat(double(csongvol)/100.0f)
					BASS_FXSetParameters hVolFX,volfx
				}
			}
		}
		pendfl=0
		BASS_ChannelSetAttribute mid,2,0.0f
		BASS_ChannelPlay(mid)
		BASS_ChannelSetPosition_ms mid,poffset
		BASS_ChannelSlideAttribute mid,2,double(min(csongvol,100))/100,500
		fadeoutfl=0
		repeat
			gsel 0
			redraw 0
			stat1=BASS_ChannelGetPosition_ms(mid)
			if((stat1>=poffset+plength-2000)&(fadeoutfl=0)):BASS_ChannelSlideAttribute mid,2,0.0,500:fadeoutfl=1
			if((stat1>=poffset+plength+550)|(stat1>=mlength-1)|(pendfl=1)):break
			gsel 0
			redraw 1
			await 1
		loop
		gsel 0
		redraw 1
		pendfl=-1
		playingsample=0
		if(mid!=-1){
			BASS_StreamFree mid
			mid=-1
		}
		if(mid2!=-1){
			BASS_StreamFree mid2
			mid2=-1
		}
		pendfl=-1
	}else:if(cmd=CMD_PLAY_TESTPLAY){
		getkey shift_key,16
		getkey ctrl_key,17
		stat1=""
		if(shift_key=1):stat1=" -hard"
		if(ctrl_key=1):stat1=" -easy"
		if((fname="")|(e=1)){
			dialog lang.10.50/*"譜面ファイルを保存してください。"*/,0,lang.0.10/*"注意"*/
		}else{
			chdir dir_default
			exist fname
			if(strsize>0){
				exist "kshootmania.exe"
				if(strsize>0){
					exec "kshootmania.exe \""+fname+"\""+stat1
				}else{
					exist "..\\kshootmania.exe"
					if(strsize>0){
						exec "..\\kshootmania.exe \""+fname+"\""+stat1
					}
				}
			}
		}
	}else:if(cmd=CMD_PLAY_TESTPLAY_AUTO){
		getkey shift_key,16
		getkey ctrl_key,17
		stat1=""
		if(shift_key=1):stat1=" -hard"
		if(ctrl_key=1):stat1=" -easy"
		if((fname="")|(e=1)){
			dialog lang.10.50/*"譜面ファイルを保存してください。"*/,0,lang.0.10/*"注意"*/
		}else{
			chdir dir_default
			exist fname
			if(strsize>0){
				exist "kshootmania.exe"
				if(strsize>0){
					exec "kshootmania.exe \""+fname+"\" -auto"+stat1
				}else{
					exist "..\\kshootmania.exe"
					if(strsize>0){
						exec "..\\kshootmania.exe \""+fname+"\" -auto"+stat1
					}
				}
			}
		}
	}else:if(cmd=CMD_PLAY_TESTPLAY_CURSOR){
		getkey shift_key,16
		getkey ctrl_key,17
		stat1=""
		if(shift_key=1):stat1=" -hard"
		if(ctrl_key=1):stat1=" -easy"
		if((fname="")|(e=1)){
			dialog lang.10.50/*"譜面ファイルを保存してください。"*/,0,lang.0.10/*"注意"*/
		}else{
			chdir dir_default
			exist fname
			if(strsize>0){
				exist "kshootmania.exe"
				if(strsize>0){
					exec "kshootmania.exe \""+fname+"\""+stat1+" -from "+c2b(cnowf)
				}else{
					exist "..\\kshootmania.exe"
					if(strsize>0){
						exec "..\\kshootmania.exe \""+fname+"\""+stat1+" -from "+c2b(cnowf)
					}
				}
			}
		}
	}else:if(cmd=CMD_PLAY_TESTPLAY_AUTO_CURSOR){
		getkey shift_key,16
		getkey ctrl_key,17
		stat1=""
		if(shift_key=1):stat1=" -hard"
		if(ctrl_key=1):stat1=" -easy"
		if((fname="")|(e=1)){
			dialog lang.10.50/*"譜面ファイルを保存してください。"*/,0,lang.0.10/*"注意"*/
		}else{
			chdir dir_default
			exist fname
			if(strsize>0){
				exist "kshootmania.exe"
				if(strsize>0){
					exec "kshootmania.exe \""+fname+"\" -auto"+stat1+" -from "+c2b(cnowf)
				}else{
					exist "..\\kshootmania.exe"
					if(strsize>0){
						exec "..\\kshootmania.exe \""+fname+"\" -auto"+stat1+" -from "+c2b(cnowf)
					}
				}
			}
		}
	}
	acmd=-1:return
	
*OnKeshu
	if(playingsample=1):pendfl=1:return
	if((inputnow=1)|(enowstat!=0)){
		return
	}
	if(ginfo2()!=-1){
		getkey alt_key,18
		getkey ctrl_key,17
		getkey shift_key,16
		// Tab
		if((wparam=9)&(ctrl_key+alt_key+shift_key=0)){
			if(selnum>0){
				if(lastseltype=0):stat3=selnote.lastsel:stat4=(stat3<notenum-1)
				if(lastseltype=1):stat3=selanalog.lastsel:stat4=(stat3<analognum-1)
				if(lastseltype=2):stat3=selspin.lastsel:stat4=(stat3<spinnum-1)
				if(lastseltype=4):stat3=selstp.lastsel:stat4=(stat3<stpnum-1)
				if(stat4=1){
					stat1=lastseltype
					gosub *selinit
					lastsel=0
					lastseltype=stat1
					if(lastseltype=0):selnote.0=stat3+1:selnotenum++
					if(lastseltype=1):selanalog.0=stat3+1:selanalognum++
					if(lastseltype=2):selspin.0=stat3+1:selspinnum++
					if(lastseltype=4):selstp.0=stat3+1:selstpnum++
				}
			}else{
				cnowf=b2c(c2b(cnowf)+1)
				cnowflen=0
				trackcursor cnowf
			}
			gosub *draw
		}
		// Shift+Tab
		if((wparam=9)&(shift_key=1)&(ctrl_key+alt_key=0)){
			if(selnum>0){
				if(lastseltype=0):stat3=selnote.lastsel
				if(lastseltype=1):stat3=selanalog.lastsel
				if(lastseltype=2):stat3=selspin.lastsel
				if(lastseltype=4):stat3=selstp.lastsel
				if(stat3>0){
					stat1=lastseltype
					gosub *selinit
					lastsel=0
					lastseltype=stat1
					if(lastseltype=0):selnote.0=stat3-1:selnotenum++
					if(lastseltype=1):selanalog.0=stat3-1:selanalognum++
					if(lastseltype=2):selspin.0=stat3-1:selspinnum++
					if(lastseltype=4):selstp.0=stat3-1:selstpnum++
				}
			}else{
				cnowf=max(b2c(c2b(cnowf-1)),0)
				cnowflen=0
				trackcursor cnowf
			}
			gosub *draw
		}
		// Left
		if((wparam=37)&((ctrl_key+alt_key+shift_key=0))){
			if(((pendfl=-1)|(synchro=0))|((pendfl=0)&((posnow+vyoko/2)*vtate*UNIT_MEASURE>vzoom(cnow)))){
				if(posnow>0){
					posnow--
					gosub *draw
				}
			}
		}
		if((wparam=37)&((ctrl_key+alt_key=2)&(shift_key=0))){
			if(pendfl!=-1){
				acmd=CMD_PLAY_STOP
				gosub *OnCommand
				acmd=-1
				return
			}
			cnowf-=vtate*UNIT_MEASURE
			cnowf=max(cnowf,0)
			cnowflen=0
			trackcursor cnowf+cnowflen
			gosub *draw
		}
		if((wparam=37)&(ctrl_key+alt_key+shift_key=3)){
			if(pendfl!=-1){
				acmd=CMD_PLAY_STOP
				gosub *OnCommand
				acmd=-1
				return
			}
			cnowflen-=vtate*UNIT_MEASURE
			if(cnowf+cnowflen<0):cnowflen=-cnowf
			gosub *selinit2
			stat1=min(cnowf,cnowf+cnowflen)
			stat2=max(cnowf,cnowf+cnowflen)
			repeat analognum
				if(analog.cnt.1+analog.cnt.2<=stat1):continue
				if(analog.cnt.1>=stat2):break
				selanalog.selanalognum=cnt
				selanalognum++
			loop
			repeat spinnum
				if(spin.cnt.1+spin.cnt.2<=stat1):continue
				if(spin.cnt.1>=stat2):break
				selspin.selspinnum=cnt
				selspinnum++
			loop
			repeat stpnum
				if(stp.cnt.0+stp.cnt.1<=stat1):continue
				if(stp.cnt.0>=stat2):break
				selstp.selstpnum=cnt
				selstpnum++
			loop
			repeat notenum
				if((note.cnt.2>0)&(note.cnt.1+note.cnt.2<=stat1)):continue
				if((note.cnt.2=0)&(note.cnt.1<stat1)):continue
				if(note.cnt.1>=stat2):break
				selnote.selnotenum=cnt
				selnotenum++
			loop
			trackcursor cnowf+cnowflen
			gosub *draw
		}
		if((wparam=37)&(alt_key+shift_key=0)&(ctrl_key=1)){
			if(selnum>=1){
				if((selnotenum>=0)&(selanalognum+selspinnum+selstpnum=0)){
					f=1
					g=0
					repeat selnotenum
						if(note.(selnote.cnt).0<=3){
							h=1
						}else{
							h=2
						}
						if(g=0){
							g=h
						}else:if(g!=h){
							f=0
						}
					loop
					if(f=1){
						gosub *undokakuho
						if(note.(selnote.0).0<=3){
							repeat selnotenum
								nt=selnote.cnt
								if(note.nt.0>0){
									note.nt.0--
								}else{
									note.nt.0=3
								}
							loop
						}else{
							repeat selnotenum
								nt=selnote.cnt
								note.nt.0=4+(1-(note.nt.0-4))
							loop
						}
						e=1:gosub *refreshtitle
					}
				}
				if((selanalognum>=0)&(selnotenum+selspinnum+selstpnum=0)){
					g=0
					repeat selanalognum
						nt=selanalog.cnt
						if(analogdetail+(analogparentran.(analogparent.(selanalog.0))=2)=0){
							f=5
						}else:if(analogdetail+(analogparentran.(analogparent.(selanalog.0))=2)=1){
							f=analog.nt.4-anadetail1prev.(analog.nt.4)
						}else{
							f=1
						}
						if(analog.nt.4>0){
							g=1
							break
						}
					loop
					if(g=1){
						gosub *undokakuho
						repeat selanalognum
							nt=selanalog.cnt
							if(analogdetail+(analogparentran.(analogparent.(selanalog.0))=2)=0){
								f=5
							}else:if(analogdetail+(analogparentran.(analogparent.(selanalog.0))=2)=1){
								f=analog.nt.4-anadetail1prev.(analog.nt.4)
							}else{
								f=1
							}
							if(analog.nt.4>0){
								analog.nt.4-=f
								analog.nt.4=max(0,analog.nt.4)
								if(analognum-nt-1>0){
									repeat analognum-nt-1,nt+1
										if((analog.cnt.0=analog.nt.0)&(analog.cnt.1=analog.nt.1+analog.nt.2)){
											analog.cnt.3=analog.nt.4
										}
									loop
								}
							}
						loop
					}
					e=1:gosub *refreshtitle
				}
				if((selspinnum>=0)&(selnotenum+selanalognum+selstpnum=0)){
					gosub *undokakuho
					repeat selspinnum
						nt=selspin.cnt
						spin.nt.0=spin.nt.0/2*2+1-spin.nt.0\2
					loop
					e=1:gosub *refreshtitle
				}
				gosub *draw
			}
		}
		if((wparam=37)&(alt_key=0)&(ctrl_key+shift_key=2)){
			if(selnum>=1){
				if((selanalognum>=0)&(selnotenum+selspinnum+selstpnum=0)){
					g=0
					repeat selanalognum
						nt=selanalog.(selanalognum-cnt-1)
						if(analogdetail+(analogparentran.(analogparent.(selanalog.0))=2)=0){
							f=5
						}else:if(analogdetail+(analogparentran.(analogparent.(selanalog.0))=2)=1){
							f=analog.nt.3-anadetail1prev.(analog.nt.3)
						}else{
							f=1
						}
						if(analog.nt.3>0){
							g=1
							break
						}
					loop
					if(g=1){
						gosub *undokakuho
						repeat selanalognum
							nt=selanalog.(selanalognum-cnt-1)
							if(analogdetail+(analogparentran.(analogparent.(selanalog.0))=2)=0){
								f=5
							}else:if(analogdetail+(analogparentran.(analogparent.(selanalog.0))=2)=1){
								f=analog.nt.3-anadetail1prev.(analog.nt.3)
							}else{
								f=1
							}
							if(analog.nt.3>0){
								analog.nt.3-=f
								analog.nt.3=max(0,analog.nt.3)
								if((analog.nt.5=0)&(nt>0)){
									repeat nt,1
										if((analog.(nt-cnt).0=analog.nt.0)&(analog.(nt-cnt).1+analog.(nt-cnt).2=analog.nt.1)){
											analog.(nt-cnt).4=analog.nt.3
										}
									loop
								}
							}
						loop
					}
					e=1:gosub *refreshtitle
				}
				gosub *draw
			}
		}
		// Right
		if((wparam=39)&((ctrl_key+alt_key+shift_key=0))){
			/*if(posnow<tate/vtate-vyk):*/posnow++
			gosub *draw
		}
		if((wparam=39)&((ctrl_key+alt_key=2)&(shift_key=0))){
			if(pendfl!=-1){
				acmd=CMD_PLAY_STOP
				gosub *OnCommand
				acmd=-1
				return
			}
			cnowf+=vtate*UNIT_MEASURE
			cnowflen=0
			trackcursor cnowf+cnowflen
			gosub *draw
		}
		if((wparam=39)&(ctrl_key+alt_key+shift_key=3)){
			if(pendfl!=-1){
				acmd=CMD_PLAY_STOP
				gosub *OnCommand
				acmd=-1
				return
			}
			cnowflen+=vtate*UNIT_MEASURE
			gosub *selinit2
			stat1=min(cnowf,cnowf+cnowflen)
			stat2=max(cnowf,cnowf+cnowflen)
			repeat analognum
				if(analog.cnt.1+analog.cnt.2<=stat1):continue
				if(analog.cnt.1>=stat2):break
				selanalog.selanalognum=cnt
				selanalognum++
			loop
			repeat spinnum
				if(spin.cnt.1+spin.cnt.2<=stat1):continue
				if(spin.cnt.1>=stat2):break
				selspin.selspinnum=cnt
				selspinnum++
			loop
			repeat stpnum
				if(stp.cnt.0+stp.cnt.1<=stat1):continue
				if(stp.cnt.0>=stat2):break
				selstp.selstpnum=cnt
				selstpnum++
			loop
			repeat notenum
				if((note.cnt.2>0)&(note.cnt.1+note.cnt.2<=stat1)):continue
				if((note.cnt.2=0)&(note.cnt.1<stat1)):continue
				if(note.cnt.1>=stat2):break
				selnote.selnotenum=cnt
				selnotenum++
			loop
			trackcursor cnowf+cnowflen
			gosub *draw
		}
		if((wparam=39)&(alt_key+shift_key=0)&(ctrl_key=1)){
			if(selnum>=1){
				if((selnotenum>=0)&(selanalognum+selspinnum+selstpnum=0)){
					f=1
					g=0
					repeat selnotenum
						if(note.(selnote.cnt).0<=3){
							h=1
						}else{
							h=2
						}
						if(g=0){
							g=h
						}else:if(g!=h){
							f=0
						}
					loop
					if(f=1){
						gosub *undokakuho
						if(note.(selnote.0).0<=3){
							repeat selnotenum
								nt=selnote.cnt
								if(note.nt.0<3){
									note.nt.0++
								}else{
									note.nt.0=0
								}
							loop
						}else{
							repeat selnotenum
								nt=selnote.cnt
								note.nt.0=4+(1-(note.nt.0-4))
							loop
						}
						e=1:gosub *refreshtitle
					}
				}
				if((selanalognum>=0)&(selnotenum+selspinnum+selstpnum=0)){
					g=0
					repeat selanalognum
						nt=selanalog.cnt
						if(analogdetail2=0){
							f=5
						}else:if(analogdetail2=1){
							f=anadetail1next.(analog.nt.4)-analog.nt.4
						}else{
							f=1
						}
						if(analog.nt.4<50){
							g=1
							break
						}
					loop
					if(g=1){
						gosub *undokakuho
						repeat selanalognum
							nt=selanalog.cnt
							if(analogdetail+(analogparentran.(analogparent.(selanalog.0))=2)=0){
								f=5
							}else:if(analogdetail+(analogparentran.(analogparent.(selanalog.0))=2)=1){
								f=anadetail1next.(analog.nt.4)-analog.nt.4
							}else{
								f=1
							}
							if(analog.nt.4<50){
								analog.nt.4+=f
								analog.nt.4=min(50,analog.nt.4)
								if(analognum-nt-1>0){
									repeat analognum-nt-1,nt+1
										if((analog.cnt.0=analog.nt.0)&(analog.cnt.1=analog.nt.1+analog.nt.2)){
											analog.cnt.3=analog.nt.4
										}
									loop
								}
							}
						loop
					}
					e=1:gosub *refreshtitle
				}
				if((selspinnum>=0)&(selnotenum+selanalognum+selstpnum=0)){
					gosub *undokakuho
					repeat selspinnum
						nt=selspin.cnt
						spin.nt.0=spin.nt.0/2*2+1-spin.nt.0\2
					loop
					e=1:gosub *refreshtitle
				}
				gosub *draw
			}
		}
		if((wparam=39)&(alt_key=0)&(ctrl_key+shift_key=2)){
			if(selnum>=1){
				if((selanalognum>=0)&(selnotenum+selspinnum+selstpnum=0)){
					g=0
					repeat selanalognum
						nt=selanalog.(selanalognum-cnt-1)
						if(analogdetail+(analogparentran.(analogparent.(selanalog.0))=2)=0){
							f=5
						}else:if(analogdetail+(analogparentran.(analogparent.(selanalog.0))=2)=1){
							f=anadetail1next.(analog.nt.3)-analog.nt.3
						}else{
							f=1
						}
						if(analog.nt.3<50){
							g=1
							break
						}
					loop
					if(g=1){
						gosub *undokakuho
						repeat selanalognum
							nt=selanalog.(selanalognum-cnt-1)
							if(analogdetail+(analogparentran.(analogparent.(selanalog.0))=2)=0){
								f=5
							}else:if(analogdetail+(analogparentran.(analogparent.(selanalog.0))=2)=1){
								f=anadetail1next.(analog.nt.3)-analog.nt.3
							}else{
								f=1
							}
							if(analog.nt.3<50){
								analog.nt.3+=f
								analog.nt.3=min(50,analog.nt.3)
								if((analog.nt.5=0)&(nt>0)){
									repeat nt,1
										if((analog.(nt-cnt).0=analog.nt.0)&(analog.(nt-cnt).1+analog.(nt-cnt).2=analog.nt.1)){
											analog.(nt-cnt).4=analog.nt.3
										}
									loop
								}
							}
						loop
					}
					e=1:gosub *refreshtitle
				}
				gosub *draw
			}
		}
		// Down
		if((wparam=40)&(((ctrl_key+alt_key=2)&(shift_key=0))|((selnum=0)&(ctrl_key+alt_key+shift_key=0)))){
			if(pendfl!=-1){
				acmd=CMD_PLAY_STOP
				gosub *OnCommand
				acmd=-1
				return
			}
			cnowf-=UNIT_MEASURE/editdiv
			cnowf=max(cnowf,0)
			cnowflen=0
			trackcursor cnowf+cnowflen
			gosub *draw
		}else:if((wparam=40)&(ctrl_key+alt_key+shift_key=3)){
			if(pendfl!=-1){
				acmd=CMD_PLAY_STOP
				gosub *OnCommand
				acmd=-1
				return
			}
			cnowflen-=UNIT_MEASURE/editdiv
			if(cnowf+cnowflen<0):cnowflen=-cnowf
			gosub *selinit2
			stat1=min(cnowf,cnowf+cnowflen)
			stat2=max(cnowf,cnowf+cnowflen)
			repeat analognum
				if(analog.cnt.1+analog.cnt.2<=stat1):continue
				if(analog.cnt.1>=stat2):break
				selanalog.selanalognum=cnt
				selanalognum++
			loop
			repeat spinnum
				if(spin.cnt.1+spin.cnt.2<=stat1):continue
				if(spin.cnt.1>=stat2):break
				selspin.selspinnum=cnt
				selspinnum++
			loop
			repeat stpnum
				if(stp.cnt.0+stp.cnt.1<=stat1):continue
				if(stp.cnt.0>=stat2):break
				selstp.selstpnum=cnt
				selstpnum++
			loop
			repeat notenum
				if((note.cnt.2>0)&(note.cnt.1+note.cnt.2<=stat1)):continue
				if((note.cnt.2=0)&(note.cnt.1<stat1)):continue
				if(note.cnt.1>=stat2):break
				selnote.selnotenum=cnt
				selnotenum++
			loop
			trackcursor cnowf+cnowflen
			gosub *draw
		}else:if((wparam=40)&(ctrl_key+alt_key=0)&(shift_key=1)){
			if(pendfl!=-1){
				acmd=CMD_PLAY_STOP
				gosub *OnCommand
				acmd=-1
				return
			}
			cnowflen=0
			if(selnum>0){
				if(selshift=0){
					if(lastseltype=0):stat3=selnote.lastsel
					if(lastseltype=1):stat3=selanalog.lastsel
					if(lastseltype=2):stat3=selspin.lastsel
					if(lastseltype=4):stat3=selstp.lastsel
					stat1=lastseltype
					gosub *selinit
					lastsel=0
					lastseltype=stat1
					if(lastseltype=0):selnote.0=stat3:selnotenum++
					if(lastseltype=1):selanalog.0=stat3:selanalognum++
					if(lastseltype=2):selspin.0=stat3:selspinnum++
					if(lastseltype=4):selstp.0=stat3:selstpnum++
				}
				if(lastseltype=0){
					if(selnote.lastsel>0){
						f=0
						repeat selnotenum
							if(selnote.cnt=selnote.lastsel-1):f=1
						loop
						if(f=0){
							selnote.selnotenum=selnote.lastsel-1
							selnotenum++
							selshift=1
							lastsel++
						}else{
							selnotenum--
							selshift=1
							lastsel--
						}
					}
				}else:if(lastseltype=1){
					if(selanalog.lastsel>0){
						f=0
						repeat selanalognum
							if(selanalog.cnt=selanalog.lastsel-1):f=1
						loop
						if(f=0){
							selanalog.selanalognum=selanalog.lastsel-1
							selanalognum++
							selshift=1
							lastsel++
						}else{
							selanalognum--
							selshift=1
							lastsel--
						}
					}
				}else:if(lastseltype=2){
					if(selspin.lastsel>0){
						f=0
						repeat selspinnum
							if(selspin.cnt=selspin.lastsel-1):f=1
						loop
						if(f=0){
							selspin.selspinnum=selspin.lastsel-1
							selspinnum++
							selshift=1
							lastsel++
						}else{
							selspinnum--
							selshift=1
							lastsel--
						}
					}
				}else:if(lastseltype=4){
					if(selstp.lastsel>0){
						f=0
						repeat selstpnum
							if(selstp.cnt=selstp.lastsel-1):f=1
						loop
						if(f=0){
							selstp.selstpnum=selstp.lastsel-1
							selstpnum++
							selshift=1
							lastsel++
						}else{
							selstpnum--
							selshift=1
							lastsel--
						}
					}
				}
				gosub *draw
			}
		}else:if((wparam=40)&(alt_key+shift_key=0)&(ctrl_key=1)){
			if(pendfl!=-1){
				acmd=CMD_PLAY_STOP
				gosub *OnCommand
				acmd=-1
				return
			}
			cnowflen=0
			if(selnum=1){
				if((selnotenum=1)/*&(note.(selnote.0).2>0)*/){
					nt=selnote.0
					if(note.nt.2>0/*UNIT_MEASURE/editdiv*/){
						gosub *undokakuho
						note.nt.2-=UNIT_MEASURE/editdiv
						if(note.nt.2<=0){
							note.nt.2=0
							//note.nt.3=0
							//note.nt.4=0
							//note.nt.5=0
						}
						trackcursor note.nt.1+note.nt.2
						e=1:gosub *refreshtitle
					}
				}
				if(selanalognum=1){
					nt=selanalog.0
					if(analog.nt.2>UNIT_MEASURE/32){
						gosub *undokakuho
						analog.nt.2-=UNIT_MEASURE/editdiv
						if(analog.nt.2<UNIT_MEASURE/32):analog.nt.2=UNIT_MEASURE/32
						trackcursor analog.nt.1+analog.nt.2
						e=1:gosub *refreshtitle
					}
				}
				if(selspinnum=1){
					nt=selspin.0
					if(spin.nt.2>UNIT_MEASURE/editdiv){
						gosub *undokakuho
						spin.nt.2-=UNIT_MEASURE/editdiv
						if(spin.nt.2<UNIT_MEASURE/16):spin.nt.2=UNIT_MEASURE/16
						trackcursor spin.nt.1+spin.nt.2
						e=1:gosub *refreshtitle
					}
				}
				if(selstpnum=1){
					nt=selstp.0
					if(stp.nt.1>UNIT_MEASURE/editdiv){
						gosub *undokakuho
						stp.nt.1-=UNIT_MEASURE/editdiv
						if(stp.nt.1<UNIT_MEASURE/48):stp.nt.1=UNIT_MEASURE/48
						e=1:gosub *refreshtitle
						trackcursor stp.nt.0+stp.nt.1
					}
				}
				gosub *draw
			}
		}else:if((wparam=40)&(ctrl_key+shift_key+alt_key=0)){
			if(pendfl!=-1){
				acmd=CMD_PLAY_STOP
				gosub *OnCommand
				acmd=-1
				return
			}
			cnowflen=0
			f=1
			if(selnum<=0):f=0
			repeat selnotenum
				if(note.(selnote.cnt).1<UNIT_MEASURE/editdiv):f=0:break
			loop
			repeat selanalognum
				if(analog.(selanalog.cnt).1<UNIT_MEASURE/editdiv):f=0:break
			loop
			repeat selspinnum
				if(spin.(selspin.cnt).1<UNIT_MEASURE/editdiv):f=0:break
			loop
			repeat selstpnum
				if(stp.(selstp.cnt).0<UNIT_MEASURE/editdiv):f=0:break
			loop
			if(f=1){
				gosub *undokakuho
				repeat selnotenum
					cnt3=cnt
					nt=selnote.cnt3
					note.nt.1-=UNIT_MEASURE/editdiv
					trackcursor note.nt.1
					repeat nt
						cnt2=nt-1
						if(note.cnt2.1>note.nt.1){
							repeat 5
								stat1=note.cnt2.cnt
								note.cnt2.cnt=note.nt.cnt
								note.nt.cnt=stat1
							loop
							stat1=notesefname.cnt2
							notesefname.cnt2=notesefname.nt
							notesefname.nt=stat1
							nt--
							repeat selnotenum
								if(selnote.cnt=cnt2):selnote.cnt++:selshift=0
							loop
							selnote.cnt3--
						}else:break
					loop
				loop
				repeat selanalognum
					cnt3=cnt
					nt=selanalog.cnt3
					analog.nt.1-=UNIT_MEASURE/editdiv
					trackcursor analog.nt.1
					repeat nt
						cnt2=nt-1
						if(analog.cnt2.1>analog.nt.1){
							repeat 6
								stat1=analog.cnt2.cnt
								analog.cnt2.cnt=analog.nt.cnt
								analog.nt.cnt=stat1
							loop
							nt--
							repeat selanalognum
								if(selanalog.cnt=cnt2):selanalog.cnt++:selshift=0
							loop
							selanalog.cnt3--
						}else:break
					loop
				loop
				repeat selspinnum
					cnt3=cnt
					nt=selspin.cnt3
					spin.nt.1-=UNIT_MEASURE/editdiv
					trackcursor spin.nt.1
					repeat nt
						cnt2=nt-1
						if(spin.cnt2.1>spin.nt.1){
							repeat 3
								stat1=spin.cnt2.cnt
								spin.cnt2.cnt=spin.nt.cnt
								spin.nt.cnt=stat1
							loop
							nt--
							repeat selspinnum
								if(selspin.cnt=cnt2):selspin.cnt++:selshift=0
							loop
							selspin.cnt3--
						}else:break
					loop
				loop
				repeat selstpnum
					cnt3=cnt
					nt=selstp.cnt3
					stp.nt.0-=UNIT_MEASURE/editdiv
					trackcursor stp.nt.0
					repeat nt
						cnt2=nt-1
						if(stp.cnt2.0>stp.nt.0){
							repeat 2
								stat1=stp.cnt2.cnt
								stp.cnt2.cnt=stp.nt.cnt
								stp.nt.cnt=stat1
							loop
							nt--
							repeat selstpnum
								if(selstp.cnt=cnt2):selstp.cnt++:selshift=0
							loop
							selstp.cnt3--
						}else:break
					loop
				loop
				e=1:gosub *refreshtitle
			}
			gosub *draw
		}
		// Up
		if((wparam=38)&(((ctrl_key+alt_key=2)&(shift_key=0))|((selnum=0)&(ctrl_key+alt_key+shift_key=0)))){
			if(pendfl!=-1){
				acmd=CMD_PLAY_STOP
				gosub *OnCommand
				acmd=-1
				return
			}
			cnowf+=UNIT_MEASURE/editdiv
			cnowflen=0
			trackcursor cnowf+cnowflen
			gosub *draw
		}else:if((wparam=38)&(ctrl_key+alt_key+shift_key=3)){
			if(pendfl!=-1){
				acmd=CMD_PLAY_STOP
				gosub *OnCommand
				acmd=-1
				return
			}
			cnowflen+=UNIT_MEASURE/editdiv
			gosub *selinit2
			stat1=min(cnowf,cnowf+cnowflen)
			stat2=max(cnowf,cnowf+cnowflen)
			repeat analognum
				if(analog.cnt.1+analog.cnt.2<=stat1):continue
				if(analog.cnt.1>=stat2):break
				selanalog.selanalognum=cnt
				selanalognum++
			loop
			repeat spinnum
				if(spin.cnt.1+spin.cnt.2<=stat1):continue
				if(spin.cnt.1>=stat2):break
				selspin.selspinnum=cnt
				selspinnum++
			loop
			repeat stpnum
				if(stp.cnt.0+stp.cnt.1<=stat1):continue
				if(stp.cnt.0>=stat2):break
				selstp.selstpnum=cnt
				selstpnum++
			loop
			repeat notenum
				if((note.cnt.2>0)&(note.cnt.1+note.cnt.2<=stat1)):continue
				if((note.cnt.2=0)&(note.cnt.1<stat1)):continue
				if(note.cnt.1>=stat2):break
				selnote.selnotenum=cnt
				selnotenum++
			loop
			trackcursor cnowf+cnowflen
			gosub *draw
		}else:if((wparam=38)&(ctrl_key+alt_key=0)&(shift_key=1)){
			if(pendfl!=-1){
				acmd=CMD_PLAY_STOP
				gosub *OnCommand
				acmd=-1
				return
			}
			cnowflen=0
			if(selnum>0){
				if(selshift=0){
					if(lastseltype=0):stat3=selnote.lastsel
					if(lastseltype=1):stat3=selanalog.lastsel
					if(lastseltype=2):stat3=selspin.lastsel
					if(lastseltype=4):stat3=selstp.lastsel
					stat1=lastseltype
					gosub *selinit
					lastsel=0
					lastseltype=stat1
					if(lastseltype=0):selnote.0=stat3:selnotenum++
					if(lastseltype=1):selanalog.0=stat3:selanalognum++
					if(lastseltype=2):selspin.0=stat3:selspinnum++
					if(lastseltype=4):selstp.0=stat3:selstpnum++
				}
				if(lastseltype=0){
					if(selnote.lastsel<notenum-1){
						f=0
						repeat selnotenum
							if(selnote.cnt=selnote.lastsel+1):f=1
						loop
						if(f=0){
							selnote.selnotenum=selnote.lastsel+1
							selnotenum++
							selshift=1
							lastsel++
						}else{
							selnotenum--
							selshift=1
							lastsel--
						}
					}
				}else:if(lastseltype=1){
					if(selanalog.lastsel<analognum-1){
						f=0
						repeat selanalognum
							if(selanalog.cnt=selanalog.lastsel+1):f=1
						loop
						if(f=0){
							selanalog.selanalognum=selanalog.lastsel+1
							selanalognum++
							selshift=1
							lastsel++
						}else{
							selanalognum--
							selshift=1
							lastsel--
						}
					}
				}else:if(lastseltype=2){
					if(selspin.lastsel<spinnum-1){
						f=0
						repeat selspinnum
							if(selspin.cnt=selspin.lastsel+1):f=1
						loop
						if(f=0){
							selspin.selspinnum=selspin.lastsel+1
							selspinnum++
							selshift=1
							lastsel++
						}else{
							selspinnum--
							selshift=1
							lastsel--
						}
					}
				}else:if(lastseltype=4){
					if(selstp.lastsel<stpnum-1){
						f=0
						repeat selstpnum
							if(selstp.cnt=selstp.lastsel+1):f=1
						loop
						if(f=0){
							selstp.selstpnum=selstp.lastsel+1
							selstpnum++
							selshift=1
							lastsel++
						}else{
							selstpnum--
							selshift=1
							lastsel--
						}
					}
				}
				gosub *draw
			}
		}else:if((wparam=38)&(alt_key+shift_key=0)&(ctrl_key=1)){
			if(pendfl!=-1){
				acmd=CMD_PLAY_STOP
				gosub *OnCommand
				acmd=-1
				return
			}
			cnowflen=0
			if(selnum=1){
				if((selnotenum=1)/*&(note.(selnote.0).2>0)*/){
					nt=selnote.0
					gosub *undokakuho
					note.nt.2+=UNIT_MEASURE/editdiv
					trackcursor note.nt.1+note.nt.2
					e=1:gosub *refreshtitle
				}
				if(selanalognum=1){
					nt=selanalog.0
					gosub *undokakuho
					if((editdiv<32)&(analog.nt.2<=UNIT_MEASURE/32)){
						if(((analog.nt.1\(UNIT_MEASURE/16))!=0)&((analog.nt.1\(UNIT_MEASURE/32))=0)){
							analog.nt.2+=UNIT_MEASURE/editdiv
						}else{
							analog.nt.2=UNIT_MEASURE/editdiv
						}
					}else:if((editdiv=48)&(analog.nt.2<=UNIT_MEASURE/32)){
						analog.nt.2=UNIT_MEASURE/24
					}else:analog.nt.2+=UNIT_MEASURE/editdiv
					trackcursor analog.nt.1+analog.nt.2
					e=1:gosub *refreshtitle
				}
				if(selspinnum=1){
					nt=selspin.0
					gosub *undokakuho
					spin.nt.2+=UNIT_MEASURE/editdiv
					trackcursor spin.nt.1+spin.nt.2
					e=1:gosub *refreshtitle
				}
				if(selstpnum=1){
					nt=selstp.0
					gosub *undokakuho
					stp.nt.1+=UNIT_MEASURE/editdiv
					trackcursor stp.nt.0+stp.nt.1
					e=1:gosub *refreshtitle
				}
				gosub *draw
			}
		}else:if((wparam=38)&(ctrl_key+shift_key+alt_key=0)){
			if(pendfl!=-1){
				acmd=CMD_PLAY_STOP
				gosub *OnCommand
				acmd=-1
				return
			}
			cnowflen=0
			if(selnum>0){
				gosub *undokakuho
				repeat selnotenum
					cnt3=cnt
					nt=selnote.cnt3
					note.nt.1+=UNIT_MEASURE/editdiv
					trackcursor note.nt.1
					repeat notenum-nt-1,nt+1
						cnt2=cnt
						if(note.cnt2.1<note.nt.1){
							repeat length2(note)
								stat1=note.cnt2.cnt
								note.cnt2.cnt=note.nt.cnt
								note.nt.cnt=stat1
							loop
							stat1=notesefname.cnt2
							notesefname.cnt2=notesefname.nt
							notesefname.nt=stat1
							nt++
							repeat selnotenum
								if(selnote.cnt=cnt2):selnote.cnt--:selshift=0
							loop
							selnote.cnt3++
						}else:break
					loop
				loop
				repeat selanalognum
					cnt3=cnt
					nt=selanalog.cnt3
					analog.nt.1+=UNIT_MEASURE/editdiv
					trackcursor analog.nt.1
					repeat analognum-nt-1,nt+1
						cnt2=cnt
						if(analog.cnt2.1<analog.nt.1){
							repeat 6
								stat1=analog.cnt2.cnt
								analog.cnt2.cnt=analog.nt.cnt
								analog.nt.cnt=stat1
							loop
							nt++
							repeat selanalognum
								if(selanalog.cnt=cnt2):selanalog.cnt--:selshift=0
							loop
							selanalog.cnt3++
						}else:break
					loop
				loop
				repeat selspinnum
					cnt3=cnt
					nt=selspin.cnt3
					spin.nt.1+=UNIT_MEASURE/editdiv
					trackcursor spin.nt.1
					repeat spinnum-nt-1,nt+1
						cnt2=cnt
						if(spin.cnt2.1<spin.nt.1){
							repeat 6
								stat1=spin.cnt2.cnt
								spin.cnt2.cnt=spin.nt.cnt
								spin.nt.cnt=stat1
							loop
							nt++
							repeat selspinnum
								if(selspin.cnt=cnt2):selspin.cnt--:selshift=0
							loop
							selspin.cnt3++
						}else:break
					loop
				loop
				repeat selstpnum
					cnt3=cnt
					nt=selstp.cnt3
					stp.nt.0+=UNIT_MEASURE/editdiv
					trackcursor stp.nt.0
					repeat stpnum-nt-1,nt+1
						cnt2=cnt
						if(stp.cnt2.0<stp.nt.0){
							repeat 2
								stat1=stp.cnt2.cnt
								stp.cnt2.cnt=stp.nt.cnt
								stp.nt.cnt=stat1
							loop
							nt++
							repeat selstpnum
								if(selstp.cnt=cnt2):selstp.cnt--:selshift=0
							loop
							selstp.cnt3++
						}else:break
					loop
				loop
				e=1:gosub *refreshtitle
			}
			gosub *draw
		}
		if(lparam>>30=0){ // 長押し無視
			// Delete
			if((shift_key=0)&(wparam=46)){
				acmd=CMD_EDIT_DELETE
				gosub *OnCommand
			}
			if((ctrl_key=1)&(shift_key+alt_key=0)){
				if(iparam = 'N'){
					acmd=CMD_NEW
					gosub *OnCommand
				}
				if(iparam = 'O'){
					acmd=CMD_OPEN
					gosub *OnCommand
				}
				if(iparam = 'R'){
					acmd=CMD_EDIT_SELFLIP
					gosub *OnCommand
				}
				if(iparam = 'S'){
					acmd=CMD_SAVE
					gosub *OnCommand
				}
				if(iparam = 'T'){
					acmd=CMD_EDIT_SONGSETTINGS
					gosub *OnCommand
				}
				if(iparam = 'Z'){
					acmd=CMD_EDIT_UNDO
					gosub *OnCommand
				}
				if(iparam = 'Y'){
					acmd=CMD_EDIT_REDO
					gosub *OnCommand
				}
				if(iparam = 'X'){
					acmd=CMD_EDIT_CUT
					gosub *OnCommand
				}
				if(iparam = 'C'){
					acmd=CMD_EDIT_COPY
					gosub *OnCommand
				}
				if(iparam = 'V'){
					acmd=CMD_EDIT_PASTE
					gosub *OnCommand
				}
				if(iparam = 'A'){
					acmd=CMD_EDIT_SELALL
					gosub *OnCommand
				}
				if(iparam = 'D'){
					acmd=CMD_EDIT_CLEARSEL
					gosub *OnCommand
				}
				if(iparam = '4'){
					acmd=CMD_TOOL_4
					gosub *OnCommand
				}
				if(iparam = '8'){
					acmd=CMD_TOOL_8
					gosub *OnCommand
				}
				if(iparam = '6'){
					acmd=CMD_TOOL_16
					gosub *OnCommand
				}
				if(iparam = '2'){
					acmd=CMD_TOOL_12
					gosub *OnCommand
				}
				if(wparam=35){
					// Ctrl+End
					stat1=0
					if(notenum>0):stat1=max(note.(notenum-1).1+note.(notenum-1).2,0)
					if(analognum>0):stat1=max(analog.(analognum-1).1+analog.(analognum-1).2,stat1)
					if(spinnum>0):stat1=max(spin.(spinnum-1).1+spin.(spinnum-1).2,stat1)
					if(stpnum>0):stat1=max(stp.(stpnum-1).0+stp.(stpnum-1).1,stat1)
					if(bpmlnum>0):stat1=max(bpml.(bpmlnum-1).0,stat1)
					if(beatlnum>0):stat1=max(beatl.(beatlnum-1).0,stat1)
					if(tiltnum>0):stat1=max(tilt.(tiltnum-1).0,stat1)
					if(anvolnum>0):stat1=max(anvol.(anvolnum-1).0,stat1)
					if(ansenum>0):stat1=max(anse.(ansenum-1).0,stat1)
					if(anagainnum>0):stat1=max(anagain.(anagainnum-1).0,stat1)
					if(anafilnum>0):stat1=max(anafil.(anafilnum-1).0,stat1)
					//posnow=max(stat1/(vUNIT_MEASURE*vtate)-vyoko+1,0)
					cnowf=stat1
					cnowflen=0
					trackcursor stat1
					gosub *draw
				}
				if(wparam=36){
					// Ctrl+Home
					posnow=0
					cnowf=0
					cnowflen=0
					gosub *draw
				}
				if(wparam=32){
					// Ctrl+Space
					if((selnum=selnotenum)&(selnotenum>0)){
						stat1=-1
						f=1
						repeat selnotenum
							if((note.(selnote.cnt).3!=stat1)&(note.(selnote.cnt).0>3)&(note.(selnote.cnt).2>0)){
								if(stat1=-1){
									stat1=note.(selnote.cnt).3
								}else{
									f=0
									break
								}
							}
						loop
						if(f=1){
							repeat selnotenum
								if((note.(selnote.cnt).0>3)&(note.(selnote.cnt).2>0)){
									notefxplus selnote.cnt
								}
							loop
						}
					}
					gosub *draw
				}
			}
			if((ctrl_key+shift_key=2)&(alt_key=0)){
				if(iparam = 'R'){
					acmd=CMD_EDIT_SELRANDOMIZE
					gosub *OnCommand
				}
				if(iparam = 'T'){
					acmd=CMD_EDIT_SONGSETTINGS2
					gosub *OnCommand
				}
				if(iparam = 'C'){
					acmd=CMD_EDIT_COPY_ZOOM
					gosub *OnCommand
				}
				if(iparam = '4'){
					acmd=CMD_TOOL_24
					gosub *OnCommand
				}
				if(iparam = '2'){
					acmd=CMD_TOOL_32
					gosub *OnCommand
				}
				if(iparam = '8'){
					acmd=CMD_TOOL_48
					gosub *OnCommand
				}
				if(iparam = '6'){
					acmd=CMD_TOOL_64
					gosub *OnCommand
				}
				if(iparam = '9'){
					acmd=CMD_TOOL_96
					gosub *OnCommand
				}
				if(iparam = '1'){
					acmd=CMD_TOOL_192
					gosub *OnCommand
				}
				if(iparam = 'S'){
					acmd=CMD_SAVEAS
					gosub *OnCommand
				}
				if(wparam=32){
					// Ctrl+Shift+Space
					if((selnum=selnotenum)&(selnotenum>0)){
						stat1=-1
						f=1
						repeat selnotenum
							if((note.(selnote.cnt).3!=stat1)&(note.(selnote.cnt).0>3)&(note.(selnote.cnt).2>0)){
								if(stat1=-1){
									stat1=note.(selnote.cnt).3
								}else{
									f=0
									break
								}
							}
						loop
						if(f=1){
							repeat selnotenum
								if((note.(selnote.cnt).0>3)&(note.(selnote.cnt).2>0)){
									gosub *undokakuho
									if(note.(selnote.cnt).3=12){
										note.(selnote.cnt).3=9
										note.(selnote.cnt).4=16
									}else{
										note.(selnote.cnt).3=12
										note.(selnote.cnt).4=0
									}
									e=1:gosub *refreshtitle
								}
							loop
						}
					}
					gosub *draw
				}
			}
			if((ctrl_key+alt_key=2)&(shift_key=0)){
				if((iparam = 'V')){
					acmd=CMD_VIEW_TRACE
					gosub *OnCommand
				}
				if((iparam = 'O')){
					acmd=CMD_VIEW_TRACE_IMPORT
					gosub *OnCommand
				}
				if((iparam = 'R')){
					acmd=CMD_EXPORT_RPP
					gosub *OnCommand
				}
				if((iparam = 'T')){
					acmd=CMD_PLAY_TICK
					gosub *OnCommand
				}
			}
			if((shift_key=1)&(ctrl_key+alt_key=0)){
				if(wparam=46){
					// Shift+Delete
					acmd=CMD_EDIT_DELETE_ZOOM
					gosub *OnCommand
				}
				if((iparam='1')|(iparam='2')|(iparam='3')|(iparam='4')|(iparam='5')|(iparam='6')){
					cbtn=iparam-'1'
					cc=cnowf
					stat2=-1
					repeat notenum
						if((note.cnt.1<=cc)&(note.cnt.1+note.cnt.2>=cc)&(note.cnt.0=cbtn)){
							stat2=cnt
							break
						}
						if(note.cnt.1>cc){
							break
						}
					loop
					if(stat2>=0){
						stat1=-1
						repeat selnotenum
							if(selnote.cnt=stat2){
								stat1=cnt
								break
							}
						loop
						if(stat1>=0){
							// 既に選択済みの場合は選択を解除
							ardel selnote,selnotenum,stat1
							selnotenum--
							lastseltype=-1
							selshift=0
						}else{
							// 既に存在する場合はノーツを選択
							selnote.selnotenum=stat2
							lastseltype=0
							lastsel=selnotenum
							selnotenum++
							selshift=0
						}
						gosub *draw
					}
				}
				if(wparam=36){
					// Shift+Home
					if((selnotenum>0)&(lastseltype=0)){
						stat3=selnote.0
						gosub *selinit
						lastseltype=0
						lastsel=-1
						cnt2=0
						selnotenum=0
						selshift=1
						for i,stat3,-1,-1
							selnote.cnt2=i
							selnotenum++
							lastsel++
							cnt2++
						next
					}else:if((selanalognum>0)&(lastseltype=1)){
						stat3=selanalog.0
						gosub *selinit
						lastseltype=1
						lastsel=-1
						cnt2=0
						selanalognum=0
						selshift=1
						for i,stat3,-1,-1
							selanalog.cnt2=i
							selanalognum++
							lastsel++
							cnt2++
						next
					}else:if((selspinnum>0)&(lastseltype=2)){
						stat3=selspin.0
						gosub *selinit
						lastseltype=2
						lastsel=-1
						cnt2=0
						selspinnum=0
						selshift=1
						for i,stat3,-1,-1
							selspin.cnt2=i
							selspinnum++
							lastsel++
							cnt2++
						next
					}else:if((selstpnum>0)&(lastseltype=4)){
						stat3=selstp.0
						gosub *selinit
						lastseltype=4
						lastsel=-1
						cnt2=0
						selstpnum=0
						selshift=1
						for i,stat3,-1,-1
							selstp.cnt2=i
							selstpnum++
							lastsel++
							cnt2++
						next
					}
					gosub *draw
				}
				if(wparam=35){
					// Shift+End
					if((selnotenum>0)&(lastseltype=0)){
						stat3=selnote.0
						gosub *selinit
						lastseltype=0
						lastsel=-1
						cnt2=0
						selnotenum=0
						selshift=1
						for i,stat3,notenum,1
							selnote.cnt2=i
							selnotenum++
							lastsel++
							cnt2++
						next
					}else:if((selanalognum>0)&(lastseltype=1)){
						stat3=selanalog.0
						gosub *selinit
						lastseltype=1
						lastsel=-1
						cnt2=0
						selanalognum=0
						selshift=1
						for i,stat3,analognum,1
							selanalog.cnt2=i
							selanalognum++
							lastsel++
							cnt2++
						next
					}else:if((selspinnum>0)&(lastseltype=2)){
						stat3=selspin.0
						gosub *selinit
						lastseltype=2
						lastsel=-1
						cnt2=0
						selspinnum=0
						selshift=1
						for i,stat3,spinnum,1
							selspin.cnt2=i
							selspinnum++
							lastsel++
							cnt2++
						next
					}else:if((selstpnum>0)&(lastseltype=4)){
						stat3=selstp.0
						gosub *selinit
						lastseltype=4
						lastsel=-1
						cnt2=0
						selstpnum=0
						selshift=1
						for i,stat3,stpnum,1
							selstp.cnt2=i
							selstpnum++
							lastsel++
							cnt2++
						next
					}
					gosub *draw
				}
				if(wparam=32){
					// Shift+Space
					if((selnum=selnotenum)&(selnotenum>0)){
						stat1=-1
						f=1
						repeat selnotenum
							if((note.(selnote.cnt).3!=stat1)&(note.(selnote.cnt).0>3)&(note.(selnote.cnt).2>0)){
								if(stat1=-1){
									stat1=note.(selnote.cnt).3
								}else{
									f=0
									break
								}
							}
						loop
						if(f=1){
							repeat selnotenum
								if((note.(selnote.cnt).0>3)&(note.(selnote.cnt).2>0)){
									notefxminus selnote.cnt
								}
							loop
						}
					}
					gosub *draw
				}
			}
			if((wparam=116)){
				acmd=CMD_PLAY_TESTPLAY
				gosub *OnCommand
			}
			if((wparam=117)){
				acmd=CMD_PLAY_TESTPLAY_CURSOR
				gosub *OnCommand
			}
			if((wparam=122)){
				acmd=CMD_PLAY_TESTPLAY_AUTO
				gosub *OnCommand
			}
			if((wparam=123)){
				acmd=CMD_PLAY_TESTPLAY_AUTO_CURSOR
				gosub *OnCommand
			}
			if((ctrl_key+shift_key+alt_key=0)|((ctrl_key+alt_key=2)&(shift_key=0))){
				if((iparam='1')|(iparam='2')|(iparam='3')|(iparam='4')|(iparam='5')|(iparam='6')){
					cbtn=iparam-'1'
					cc=cnowf
					stat1=notenum
					stat2=-1
					repeat notenum
						if((note.cnt.1<=cc)&(note.cnt.1+note.cnt.2>=cc)&(note.cnt.0=cbtn)){
							stat2=cnt
							break
						}
						if(note.cnt.1>cc){
							stat1=cnt
							break
						}
					loop
					if(stat2>=0){
						if((selnum=1)&(selnotenum=1)&(selnote.0=stat2)){
							// 既に選択済みの場合はノーツを削除
							gosub *undokakuho
							repeat notenum-stat2-1,stat2+1
								note.(cnt-1).0=note.cnt.0
								note.(cnt-1).1=note.cnt.1
								note.(cnt-1).2=note.cnt.2
								note.(cnt-1).3=note.cnt.3
								note.(cnt-1).4=note.cnt.4
								note.(cnt-1).5=note.cnt.5
								notesefname.(cnt-1)=notesefname.cnt
							loop
							notenum--
							gosub *selinit
						}else{
							// 既に存在する場合はノーツを選択
							gosub *selinit
							selnote.0=stat2
							selnotenum=1
							lastseltype=0
							lastsel=0
						}
						gosub *draw
						return
					}
					gosub *selinit
					gosub *undokakuho
					for i,notenum,stat1-1,-1
						note.(i+1).0=note.i.0
						note.(i+1).1=note.i.1
						note.(i+1).2=note.i.2
						note.(i+1).3=note.i.3
						note.(i+1).4=note.i.4
						note.(i+1).5=note.i.5
						notesefname.(i+1)=notesefname.i
					next
					note.stat1.0=cbtn
					note.stat1.1=cc
					note.stat1.2=0
					note.stat1.3=0
					note.stat1.4=0
					note.stat1.5=0
					notesefname.stat1=""
					notenum++
					e=1:gosub *refreshtitle
					gosub *draw
				}
			}
			if(ctrl_key+shift_key+alt_key=0){
				if((iparam = 'O')){
					acmd=CMD_TOOL_POS
					gosub *OnCommand
				}
				if((iparam = 'H')){
					acmd=CMD_TOOL_NOTE
					gosub *OnCommand
				}
				if((iparam = 'J')){
					acmd=CMD_TOOL_NOTE2
					gosub *OnCommand
				}
				if((iparam = 'K')){
					acmd=CMD_TOOL_LNOTE2
					gosub *OnCommand
				}
				if((iparam = 'L')){
					acmd=CMD_TOOL_LNOTE
					gosub *OnCommand
				}
				if((iparam = 'Q')){
					acmd=CMD_TOOL_ANALOGL
					gosub *OnCommand
				}
				if((iparam = 'W')){
					acmd=CMD_TOOL_ANALOGR
					gosub *OnCommand
				}
				if((iparam = 'G')){
					acmd=CMD_TOOL_ANALOGPFILTER
					gosub *OnCommand
				}
				if((iparam = 'V')){
					acmd=CMD_TOOL_ANALOGVOL
					gosub *OnCommand
				}
				if((iparam = 'S')){
					acmd=CMD_TOOL_SPIN
					gosub *OnCommand
				}
				if((iparam = 'R')){
					acmd=CMD_TOOL_ROTATE
					gosub *OnCommand
				}
				if((iparam = 'Z')){
					acmd=CMD_TOOL_ZOOMTOP
					gosub *OnCommand
				}
				if((iparam = 'X')){
					acmd=CMD_TOOL_ZOOMBOTTOM
					gosub *OnCommand
				}
				if((iparam = 'C')){
					acmd=CMD_TOOL_ZOOMSIDE
					gosub *OnCommand
				}
				if((iparam = 'F')){
					acmd=CMD_TOOL_STOP
					gosub *OnCommand
				}
				if((iparam = 'P')){
					acmd=CMD_TOOL_POINT
					gosub *OnCommand
				}
				if((iparam = 'N')){
					acmd=CMD_TOOL_PENCIL
					gosub *OnCommand
				}
				if((iparam = 'E')){
					acmd=CMD_TOOL_ERASE
					gosub *OnCommand
				}
				if(iparam = '^'){
					acmd=CMD_VIEW_VSEPMAXIMIZE
					gosub *OnCommand
				}
				if(iparam = '-'){
					acmd=CMD_VIEW_VSEPMINIMIZE
					gosub *OnCommand
				}
				if(iparam = ':'){
					acmd=CMD_VIEW_2X
					gosub *OnCommand
				}
				if(wparam=32){
					acmd=CMD_PLAY_PLAY
					gosub *OnCommand
				}
				if(wparam=33){
					posnow=max(posnow-vyoko,0)
					gosub *draw
				}
				if(wparam=34){
					posnow+=vyoko
					gosub *draw
				}
				if(wparam=35){
					// End
					if(notenum>0):stat1=max(note.(notenum-1).1+note.(notenum-1).2,0)
					if(analognum>0):stat1=max(analog.(analognum-1).1+analog.(analognum-1).2,stat1)
					if(spinnum>0):stat1=max(spin.(spinnum-1).1+spin.(spinnum-1).2,stat1)
					if(stpnum>0):stat1=max(stp.(stpnum-1).0+stp.(stpnum-1).1,stat1)
					if(bpmlnum>0):stat1=max(bpml.(bpmlnum-1).0,stat1)
					if(beatlnum>0):stat1=max(beatl.(beatlnum-1).0,stat1)
					if(tiltnum>0):stat1=max(tilt.(tiltnum-1).0,stat1)
					if(anvolnum>0):stat1=max(anvol.(anvolnum-1).0,stat1)
					if(ansenum>0):stat1=max(anse.(ansenum-1).0,stat1)
					if(anagainnum>0):stat1=max(anagain.(anagainnum-1).0,stat1)
					if(anafilnum>0):stat1=max(anafil.(anafilnum-1).0,stat1)
					trackcursor stat1
					gosub *draw
				}
				if(wparam=36){
					// Home
					posnow=0
					gosub *draw
				}
			}
		}
	}
	acmd=-1
	return
	
*OnClick_
	if(playingsample=1):pendfl=1:return
	if(inputnow=1):return
	if(mousey<=7):return
	getkey stat1,1
	getkey stat2,2
	if(stat1+stat2=2):clickngt=d3timer():return
	getkey alt_key,18
	getkey ctrl_key,17
	getkey shift_key,16
	if((d3timer()-clickngt<100)&(d3timer()-clickngt>=0)){
		return
	}
	if((pendfl!=0)&(pendfl!=2)){
		if((mousex>=20)&(mousex<20+16)&(mousey>=topsep+vtate*vUNIT_MEASURE)&(mousey<topsep+vtate*vUNIT_MEASURE+16)){
			if(iparam=0){
				editmode++
				if(editmode>2):editmode=0
			}else{
				editmode--
				if(editmode<0):editmode=2
			}
			gosub *refreshmenu_editmode
			gosub *draw
			return
		}
		if((mousex>=38)&(mousex<38+16)&(mousey>=topsep+vtate*vUNIT_MEASURE)&(mousey<topsep+vtate*vUNIT_MEASURE+16)){
			if(iparam=0){
				edittarget++
				if(edittarget>TARGET_STOP):edittarget=0
			}else{
				edittarget--
				if(edittarget<0):edittarget=TARGET_STOP
			}
			gosub *refreshmenu_edittarget
			gosub *draw
			return
		}
		if((mousex>=56)&(mousex<56+16)&(mousey>=topsep+vtate*vUNIT_MEASURE)&(mousey<topsep+vtate*vUNIT_MEASURE+16)){
			if(iparam=0){
				if(editdiv=4):acmd=CMD_TOOL_8
				if(editdiv=8):acmd=CMD_TOOL_12
				if(editdiv=12):acmd=CMD_TOOL_16
				if(editdiv=16):acmd=CMD_TOOL_24
				if(editdiv=24):acmd=CMD_TOOL_32
				if(editdiv=32):acmd=CMD_TOOL_48
				if(editdiv=48):acmd=CMD_TOOL_64
				if(editdiv=64):acmd=CMD_TOOL_96
				if(editdiv=96):acmd=CMD_TOOL_192
				if(editdiv=192):acmd=CMD_TOOL_4
			}else{
				if(editdiv=4):acmd=CMD_TOOL_192
				if(editdiv=8):acmd=CMD_TOOL_4
				if(editdiv=12):acmd=CMD_TOOL_8
				if(editdiv=16):acmd=CMD_TOOL_12
				if(editdiv=24):acmd=CMD_TOOL_16
				if(editdiv=32):acmd=CMD_TOOL_24
				if(editdiv=48):acmd=CMD_TOOL_32
				if(editdiv=64):acmd=CMD_TOOL_48
				if(editdiv=96):acmd=CMD_TOOL_64
				if(editdiv=192):acmd=CMD_TOOL_96
			}
			gosub *OnCommand
			acmd=-1
			return
		}
	}else:return
	gsel 0
	if(mousey>=ginfo_winy-35-SIZE_TOOLBAR_H):return
	// 「 横列の始点カウント値 ＋ 縦列での小節頭までのカウント値差分 ＋ 小節内でのカウント値差分 」の形式
	//cc=(posnow+(mousex-vsep/2)/(41+9*2+vsp))*vtate*UNIT_MEASURE+(-10+topsep+vUNIT_MEASURE*vtate-mousey)/vUNIT_MEASURE*UNIT_MEASURE+((-10+topsep+vUNIT_MEASURE*vtate-mousey)\vUNIT_MEASURE)/(vUNIT_MEASURE/editdiv)*UNIT_MEASURE/editdiv
	// 以下はvUNIT_MEASUREとUNIT_MEASUREが同じであることを前提にした計算なので注意
	cc=(posnow+mousex/(41+9*2+vsp))*vtate*UNIT_MEASURE+(-10+topsep+vUNIT_MEASURE*vtate-mousey)
	cc*=10:cc/=vzoom(10)
	stat2=b2c(c2b(cc))
	cc=stat2+(cc-stat2)/(UNIT_MEASURE/editdiv)*(UNIT_MEASURE/editdiv)
	if(vzoomx=0){
		if(((edittarget=TARGET_NOTE)|(edittarget=TARGET_NOTE2)|(edittarget=TARGET_LNOTE)|(edittarget=TARGET_LNOTE2))&((mousex<vsep/2+9)|(mousex-vsep/2-9)\(41+9*2+vsp)>=41)):return
		//if(((edittarget=TARGET_ANALOGL)|(edittarget=TARGET_ANALOGR))&((mousex<vsep/2)|(mousex-vsep/2)\(41+9*2+vsp)>41+9*2)&((ctrl_key=0)|(shift_key=0)|(vsep<72))):return
		if(cc<0):return
		cbtn=((mousex-vsep/2-9)\(41+9*2+vsp))/10
		clbtn=4+((mousex-vsep/2-9)\(41+9*2+vsp))/20
	}else{
		if(((edittarget=TARGET_NOTE)|(edittarget=TARGET_NOTE2)|(edittarget=TARGET_LNOTE)|(edittarget=TARGET_LNOTE2))&((mousex<vsep/2+9)|(mousex-vsep/2-9)\(41+9*2+vsp)>=41*3/2)):return
		//if(((edittarget=TARGET_ANALOGL)|(edittarget=TARGET_ANALOGR))&((mousex<vsep/2)|(mousex-vsep/2)\(41+9*2+vsp)>(41+9*2)*3/2)&((ctrl_key=0)|(shift_key=0)|(vsep<72))):return
		if(cc<0):return
		cbtn=((mousex-vsep/2-12)\(41+9*2+vsp))/15
		clbtn=4+((mousex-vsep/2-12)\(41+9*2+vsp))/30
	}
	if((ctrl_key=1)&(shift_key=1)&(vsep>=72)){
		if(analogdetail2=0){
			capos=((mousex-6*(2+vzoomx)/2-(vsep/2-(41+9*2)/2*(vzoomx=0)-(41+9*2)*3/4*(vzoomx=1)))\(41+9*2+vsp))*(3-vzoomx)/3/2/5*5
		}else:if(analogdetail2=1){
			capos=anadetail1.(min(max(((mousex-6*(2+vzoomx)/2-(vsep/2-(41+9*2)/2*(vzoomx=0)-(41+9*2)*3/4*(vzoomx=1)))\(41+9*2+vsp))*(3-vzoomx)/3/2,0),50))
		}else{
			capos=((mousex-6*(2+vzoomx)/2-(vsep/2-(41+9*2)/2*(vzoomx=0)-(41+9*2)*3/4*(vzoomx=1)))\(41+9*2+vsp))*(3-vzoomx)/3/2
		}
		//if(((mousex-2*(2+vzoomx)/2-vsep/2)\(41+9*2+vsp))*(3-vzoomx)/3>=94):capos=0
	}else{
		if(analogdetail2=0){
			capos=((mousex-2*(2+vzoomx)/2-vsep/2)\(41+9*2+vsp))*(3-vzoomx)/3/5*5
		}else:if(analogdetail2=1){
			capos=anadetail1.(min(max(((mousex-2*(2+vzoomx)/2-vsep/2)\(41+9*2+vsp))*(3-vzoomx)/3,0),50))
		}else{
			capos=((mousex-2*(2+vzoomx)/2-vsep/2)\(41+9*2+vsp))*(3-vzoomx)/3
		}
		if(((mousex-2*(2+vzoomx)/2-vsep/2)\(41+9*2+vsp))*(3-vzoomx)/3>=(59-5*vzoomx)*(vsep=7)+(67-7*vzoomx)*(vsep=24)+91*(vsep=72)):capos=0
	}
	if(cbtn>3):cbtn=3
	if(clbtn>5):clbtn=5
	capos=min(max(capos,0),50)
	if(((iparam=0)&(ctrl_key+alt_key=2))|(iparam=6)){
		if(pendfl!=-1){
			acmd=CMD_PLAY_STOP
			gosub *OnCommand
		}else{
			if(enowstat!=0):return
			if(shift_key=1){
				gosub *selinit
				stat1=min(cnowf,cc)
				stat2=max(cnowf,cc)
				repeat analognum
					if(analog.cnt.1+analog.cnt.2<=stat1):continue
					if(analog.cnt.1>=stat2):break
					selanalog.selanalognum=cnt
					selanalognum++
				loop
				repeat spinnum
					if(spin.cnt.1+spin.cnt.2<=stat1):continue
					if(spin.cnt.1>=stat2):break
					selspin.selspinnum=cnt
					selspinnum++
				loop
				repeat stpnum
					if(stp.cnt.0+stp.cnt.1<=stat1):continue
					if(stp.cnt.0>=stat2):break
					selstp.selstpnum=cnt
					selstpnum++
				loop
				repeat notenum
					if((note.cnt.2>0)&(note.cnt.1+note.cnt.2<=stat1)):continue
					if((note.cnt.2=0)&(note.cnt.1<stat1)):continue
					if(note.cnt.1>=stat2):break
					selnote.selnotenum=cnt
					selnotenum++
				loop
				cnowflen=cc-cnowf
				if(cnowf+cnowflen<0):cnowflen=-cnowf
			}else{
				cnowf=cc
				if(cnowflen!=0){
					gosub *selinit
				}
				cnowflen=0
			}
			cc=cnowf
			enowstat=1
			oncmd gosub *OnClick2, 0x0202
			repeat
				getkey stat2,1
				getkey stat2_wheel,4
				if((stat2=0)&(stat2_wheel=0)):break
				if(enowstat=2):break
				//cc2=(posnow+(mousex-vsep/2-9)/(41+9*2+vsp))*vtate*UNIT_MEASURE+(-10+topsep+vUNIT_MEASURE*vtate-mousey)/vUNIT_MEASURE*UNIT_MEASURE+(((-10+topsep+vUNIT_MEASURE*vtate-mousey)\vUNIT_MEASURE)/(vUNIT_MEASURE/editdiv)+1)*UNIT_MEASURE/editdiv
				// 以下はvUNIT_MEASUREがUNIT_MEASUREと同じことを想定した計算なので注意
				cc2=(posnow+mousex/(41+9*2+vsp))*vtate*UNIT_MEASURE+(-10+topsep+vUNIT_MEASURE*vtate-mousey)
				cc2*=10:cc2/=vzoom(10)
				cc2_=b2c(c2b(cc2))
				cc2=cc2_+((cc2-cc2_)/(UNIT_MEASURE/editdiv))*(UNIT_MEASURE/editdiv)
				cnowflen=cc2-cc
				if(cnowf+cnowflen<0):cnowflen=-cnowf
				gosub *draw
				await 0
			loop
			enowstat=0
			if(cnowflen=0){
				if(shift_key=1):gosub *selinit
			}else{
				stat1=min(cnowf,cnowf+cnowflen)
				stat2=max(cnowf,cnowf+cnowflen)
				gosub *selinit
				if(stat1=cnowf):cnowflen=stat2-stat1
				if(stat1!=cnowf):cnowflen=stat1-stat2
				repeat analognum
					if(analog.cnt.1+analog.cnt.2<=stat1):continue
					if(analog.cnt.1>=stat2):break
					selanalog.selanalognum=cnt
					selanalognum++
				loop
				repeat spinnum
					if(spin.cnt.1+spin.cnt.2<=stat1):continue
					if(spin.cnt.1>=stat2):break
					selspin.selspinnum=cnt
					selspinnum++
				loop
				repeat stpnum
					if(stp.cnt.0+stp.cnt.1<=stat1):continue
					if(stp.cnt.0>=stat2):break
					selstp.selstpnum=cnt
					selstpnum++
				loop
				repeat notenum
					if((note.cnt.2>0)&(note.cnt.1+note.cnt.2<=stat1)):continue
					if((note.cnt.2=0)&(note.cnt.1<stat1)):continue
					if(note.cnt.1>=stat2):break
					selnote.selnotenum=cnt
					selnotenum++
				loop
			}
		}
		gosub *draw
		return
	}
	// 選択ツール
	if((iparam=0)&(editmode=MODE_POINT)){
		if(edittarget=TARGET_POS){
			if(pendfl!=-1){
				acmd=CMD_PLAY_STOP
				gosub *OnCommand
			}else{
				if(enowstat!=0):return
				if((shift_key=1)&((ctrl_key+alt_key=0)|(ctrl_key+alt_key=2))){
					gosub *selinit
					stat1=min(cnowf,cc)
					stat2=max(cnowf,cc)
					repeat analognum
						if(analog.cnt.1+analog.cnt.2<=stat1):continue
						if(analog.cnt.1>=stat2):break
						selanalog.selanalognum=cnt
						selanalognum++
					loop
					repeat spinnum
						if(spin.cnt.1+spin.cnt.2<=stat1):continue
						if(spin.cnt.1>=stat2):break
						selspin.selspinnum=cnt
						selspinnum++
					loop
					repeat stpnum
						if(stp.cnt.0+stp.cnt.1<=stat1):continue
						if(stp.cnt.0>=stat2):break
						selstp.selstpnum=cnt
						selstpnum++
					loop
					repeat notenum
						if((note.cnt.2>0)&(note.cnt.1+note.cnt.2<=stat1)):continue
						if((note.cnt.2=0)&(note.cnt.1<stat1)):continue
						if(note.cnt.1>=stat2):break
						selnote.selnotenum=cnt
						selnotenum++
					loop
					cnowflen=cc-cnowf
				}else{
					cnowf=cc
					if(cnowflen!=0){
						gosub *selinit
					}
					cnowflen=0
				}
				if(ctrl_key=0){
					cc=cnowf
					enowstat=1
					oncmd gosub *OnClick2, 0x0202
					repeat
						getkey stat2,1
						if(stat2=0):break
						if(enowstat=2):break
						//cc2=(posnow+(mousex-vsep/2-9)/(41+9*2+vsp))*vtate*UNIT_MEASURE+(-10+topsep+vUNIT_MEASURE*vtate-mousey)/vUNIT_MEASURE*UNIT_MEASURE+(((-10+topsep+vUNIT_MEASURE*vtate-mousey)\vUNIT_MEASURE)/(vUNIT_MEASURE/editdiv)+1)*UNIT_MEASURE/editdiv
						// 以下はvUNIT_MEASUREがUNIT_MEASUREと同じことを想定した計算なので注意
						cc2=(posnow+mousex/(41+9*2+vsp))*vtate*UNIT_MEASURE+(-10+topsep+vUNIT_MEASURE*vtate-mousey)
						cc2*=10:cc2/=vzoom(10)
						cc2_=b2c(c2b(cc2))
						cc2=cc2_+((cc2-cc2_)/(UNIT_MEASURE/editdiv))*(UNIT_MEASURE/editdiv)
						cnowflen=cc2-cc
						gosub *draw
						await 0
					loop
					enowstat=0
					if(cnowflen=0){
						if(shift_key=1):gosub *selinit
					}else{
						stat1=min(cnowf,cnowf+cnowflen)
						stat2=max(cnowf,cnowf+cnowflen)
						gosub *selinit
						if(stat1=cnowf):cnowflen=stat2-stat1
						if(stat1!=cnowf):cnowflen=stat1-stat2
						repeat analognum
							if(analog.cnt.1+analog.cnt.2<=stat1):continue
							if(analog.cnt.1>=stat2):break
							selanalog.selanalognum=cnt
							selanalognum++
						loop
						repeat spinnum
							if(spin.cnt.1+spin.cnt.2<=stat1):continue
							if(spin.cnt.1>=stat2):break
							selspin.selspinnum=cnt
							selspinnum++
						loop
						repeat stpnum
							if(stp.cnt.0+stp.cnt.1<=stat1):continue
							if(stp.cnt.0>=stat2):break
							selstp.selstpnum=cnt
							selstpnum++
						loop
						repeat notenum
							if((note.cnt.2>0)&(note.cnt.1+note.cnt.2<=stat1)):continue
							if((note.cnt.2=0)&(note.cnt.1<stat1)):continue
							if(note.cnt.1>=stat2):break
							selnote.selnotenum=cnt
							selnotenum++
						loop
					}
				}
			}
			gosub *draw
		}else:if(edittarget=TARGET_NOTE){
			if(ctrl_key+shift_key=0):gosub *selinit
			repeat notenum
				if((ctrl_key=1)&(shift_key=0)){
					if((note.cnt.1=cc)&(note.cnt.2=0)&(note.cnt.0=cbtn)){
						nt=cnt
						f=1
						repeat selnotenum
							if(selnote.cnt=nt){
								ardel selnote,selnotenum,cnt
								selnotenum--
								lastseltype=-1
								selshift=0
								f=0
								break
							}
						loop
						if(f=1){
							selnote.selnotenum=cnt
							lastseltype=0
							lastsel=selnotenum
							selnotenum++
							selshift=0
						}
					}
					cnowflen=0
				}else:if((ctrl_key=0)&(shift_key=1)){
					if((note.cnt.1=cc)&(note.cnt.2=0)&(note.cnt.0=cbtn)&(selnotenum>0)){
						stat3=selnote.0
						gosub *selinit
						lastseltype=0
						lastsel=-1
						cnt2=0
						selnotenum=0
						selshift=1
						for i,stat3,cnt+(cnt>=stat3)-(cnt<stat3),(cnt>=stat3)-(cnt<stat3)
							selnote.cnt2=i
							selnotenum++
							lastsel++
							cnt2++
						next
					}
					cnowflen=0
				}else{
					if((note.cnt.1=cc)&(note.cnt.2=0)&(note.cnt.0=cbtn)){
						selnote.0=cnt
						lastseltype=0
						lastsel=0
						selnotenum=1
						selshift=0
					}
				}
			loop
		}else:if(edittarget=TARGET_NOTE2){
			if(ctrl_key+shift_key=0):gosub *selinit
			repeat notenum
				if((ctrl_key=1)&(shift_key=0)){
					if((note.cnt.1<=cc)&(note.cnt.2>0)&(note.cnt.1+note.cnt.2>cc)&(note.cnt.0=cbtn)){
						nt=cnt
						f=1
						repeat selnotenum
							if(selnote.cnt=nt){
								ardel selnote,selnotenum,cnt
								selnotenum--
								lastseltype=-1
								selshift=0
								f=0
								break
							}
						loop
						if(f=1){
							selnote.selnotenum=cnt
							lastseltype=0
							lastsel=selnotenum
							selnotenum++
							selshift=0
						}
					}
					cnowflen=0
				}else:if((ctrl_key=0)&(shift_key=1)){
					if((note.cnt.1<=cc)&(note.cnt.2>0)&(note.cnt.1+note.cnt.2>cc)&(note.cnt.0=cbtn)){
						stat3=selnote.0
						gosub *selinit
						lastseltype=0
						lastsel=-1
						cnt2=0
						selnotenum=0
						selshift=1
						for i,stat3,cnt+(cnt>=stat3)-(cnt<stat3),(cnt>=stat3)-(cnt<stat3)
							selnote.cnt2=i
							selnotenum++
							lastsel++
							cnt2++
						next
					}
					cnowflen=0
				}else{
					if((note.cnt.1<=cc)&(note.cnt.2>0)&(note.cnt.1+note.cnt.2>cc)&(note.cnt.0=cbtn)){
						selnote.0=cnt
						lastseltype=0
						lastsel=0
						selnotenum=1
						selshift=0
					}
				}
			loop
		}else:if(edittarget=TARGET_LNOTE2){
			if(ctrl_key+shift_key=0):gosub *selinit
			repeat notenum
				if((ctrl_key=1)&(shift_key=0)){
					if((note.cnt.1=cc)&(note.cnt.2=0)&(note.cnt.0=clbtn)){
						nt=cnt
						f=1
						repeat selnotenum
							if(selnote.cnt=nt){
								ardel selnote,selnotenum,cnt
								selnotenum--
								lastseltype=-1
								selshift=0
								f=0
								break
							}
						loop
						if(f=1){
							selnote.selnotenum=cnt
							lastseltype=0
							lastsel=selnotenum
							selnotenum++
							selshift=0
						}
					}
					cnowflen=0
				}else:if((ctrl_key=0)&(shift_key=1)){
					if((note.cnt.1=cc)&(note.cnt.2=0)&(note.cnt.0=clbtn)&(selnotenum>0)){
						stat3=selnote.0
						gosub *selinit
						lastseltype=0
						lastsel=-1
						cnt2=0
						selnotenum=0
						selshift=1
						for i,stat3,cnt+(cnt>=stat3)-(cnt<stat3),(cnt>=stat3)-(cnt<stat3)
							selnote.cnt2=i
							selnotenum++
							lastsel++
							cnt2++
						next
					}
					cnowflen=0
				}else{
					if((note.cnt.1=cc)&(note.cnt.2=0)&(note.cnt.0=clbtn)){
						selnote.0=cnt
						lastseltype=0
						lastsel=0
						selnotenum=1
						selshift=0
					}
				}
			loop
		}else:if(edittarget=TARGET_LNOTE){
			if(ctrl_key+shift_key=0):gosub *selinit
			repeat notenum
				if((ctrl_key=1)&(shift_key=0)){
					if((note.cnt.1<=cc)&(note.cnt.2>0)&(note.cnt.1+note.cnt.2>cc)&(note.cnt.0=clbtn)){
						nt=cnt
						f=1
						repeat selnotenum
							if(selnote.cnt=nt){
								ardel selnote,selnotenum,cnt
								selnotenum--
								lastseltype=-1
								selshift=0
								f=0
								break
							}
						loop
						if(f=1){
							selnote.selnotenum=cnt
							lastseltype=0
							lastsel=selnotenum
							selnotenum++
							selshift=0
						}
					}
					cnowflen=0
				}else:if((ctrl_key=0)&(shift_key=1)){
					if((note.cnt.1<=cc)&(note.cnt.2>0)&(note.cnt.1+note.cnt.2>cc)&(note.cnt.0=clbtn)){
						stat3=selnote.0
						gosub *selinit
						lastseltype=0
						lastsel=-1
						cnt2=0
						selnotenum=0
						selshift=1
						for i,stat3,cnt+(cnt>=stat3)-(cnt<stat3),(cnt>=stat3)-(cnt<stat3)
							selnote.cnt2=i
							selnotenum++
							lastsel++
							cnt2++
						next
					}
					cnowflen=0
				}else{
					if((note.cnt.1<=cc)&(note.cnt.2>0)&(note.cnt.1+note.cnt.2>cc)&(note.cnt.0=clbtn)){
						selnote.0=cnt
						lastseltype=0
						lastsel=0
						selnotenum=1
						selshift=0
					}
				}
			loop
		}else:if((edittarget=TARGET_ANALOGL)|(edittarget=TARGET_ANALOGR)){
			if(ctrl_key+shift_key=0):gosub *selinit
			stat0=edittarget-TARGET_ANALOGL
			repeat analognum
				if((ctrl_key=1)&(shift_key=0)){
					if((analog.cnt.1<=cc)&(analog.cnt.1+analog.cnt.2>cc)&(analog.cnt.0=stat0)){
						nt=cnt
						f=1
						repeat selanalognum
							if(selanalog.cnt=nt){
								ardel selanalog,selanalognum,cnt
								selanalognum--
								selshift=0
								f=0
								break
							}
						loop
						if(f=1){
							selanalog.selanalognum=cnt
							lastseltype=1
							lastsel=selanalognum
							selanalognum++
							selshift=0
						}
					}
					cnowflen=0
				}else:if((ctrl_key=0)&(shift_key=1)){
					if((analog.cnt.1<=cc)&(analog.cnt.1+analog.cnt.2>cc)&(analog.cnt.0=stat0)){
						stat3=selanalog.0
						gosub *selinit
						lastseltype=1
						lastsel=-1
						cnt2=0
						selanalognum=0
						selshift=1
						for i,stat3,cnt+(cnt>=stat3)-(cnt<stat3),(cnt>=stat3)-(cnt<stat3)
							selanalog.cnt2=i
							selanalognum++
							lastsel++
							cnt2++
						next
					}
					cnowflen=0
				}else{
					if((analog.cnt.1<=cc)&(analog.cnt.1+analog.cnt.2>cc)&(analog.cnt.0=stat0)){
						selanalog.0=cnt
						lastseltype=1
						lastsel=0
						selanalognum=1
						selshift=0
					}
				}
			loop
		}else:if(edittarget=TARGET_SPIN){
			if(ctrl_key+shift_key=0):gosub *selinit
			repeat spinnum
				if((ctrl_key=1)&(shift_key=0)){
					if((spin.cnt.1<=cc)&(spin.cnt.1+spin.cnt.2>cc)){
						nt=cnt
						f=1
						repeat selspinnum
							if(selspin.cnt=nt){
								ardel selspin,selspinnum,cnt
								selspinnum--
								selshift=0
								f=0
								break
							}
						loop
						if(f=1){
							selspin.selspinnum=cnt
							lastseltype=2
							lastsel=selspinnum
							selspinnum++
							selshift=0
						}
					}
					cnowflen=0
				}else:if((ctrl_key=0)&(shift_key=1)){
					if((spin.cnt.1<=cc)&(spin.cnt.1+spin.cnt.2>cc)){
						stat3=selspin.0
						gosub *selinit
						lastseltype=2
						lastsel=-1
						cnt2=0
						selspinnum=0
						selshift=1
						for i,stat3,cnt+(cnt>=stat3)-(cnt<stat3),(cnt>=stat3)-(cnt<stat3)
							selspin.cnt2=i
							selspinnum++
							lastsel++
							cnt2++
						next
					}
					cnowflen=0
				}else{
					if((spin.cnt.1<=cc)&(spin.cnt.1+spin.cnt.2>cc)){
						selspin.0=cnt
						lastseltype=2
						lastsel=0
						selspinnum=1
						selshift=0
					}
				}
			loop
		}else:if(edittarget=TARGET_STOP){
			if(ctrl_key+shift_key=0):gosub *selinit
			repeat stpnum
				if((ctrl_key=1)&(shift_key=0)){
					if((stp.cnt.0<=cc)&(stp.cnt.0+stp.cnt.1>cc)){
						nt=cnt
						f=1
						repeat selstpnum
							if(selstp.cnt=nt){
								ardel selstp,selstpnum,cnt
								selstpnum--
								selshift=0
								f=0
								break
							}
						loop
						if(f=1){
							selstp.selstpnum=cnt
							lastseltype=4
							lastsel=selstpnum
							selstpnum++
							selshift=0
						}
					}
					cnowflen=0
				}else:if((ctrl_key=0)&(shift_key=1)){
					if((stp.cnt.0<=cc)&(stp.cnt.0+stp.cnt.1>cc)){
						stat3=selstp.0
						gosub *selinit
						lastseltype=4
						lastsel=-1
						cnt2=0
						selstpnum=0
						selshift=1
						for i,stat3,cnt+(cnt>=stat3)-(cnt<stat3),(cnt>=stat3)-(cnt<stat3)
							selstp.cnt2=i
							selstpnum++
							lastsel++
							cnt2++
						next
					}
					cnowflen=0
				}else{
					if((stp.cnt.0<=cc)&(stp.cnt.0+stp.cnt.1>cc)){
						selstp.0=cnt
						lastseltype=4
						lastsel=selstpnum
						selstpnum=1
						selshift=0
					}
				}
			loop
		}
		gosub *draw
	}
	// 鉛筆ツール
	if(((iparam=0)&(editmode=MODE_PENCIL))|((iparam=3)&(editmode=MODE_ERASE)&(edittarget=TARGET_NOTE))){
		gosub *selinit
		if((edittarget=TARGET_POS)&(ctrl_key=1)&(shift_key=0)){
			sdim it,128,2
			dim t,2
			sdim r,128,2
			sdim opt,128,2
			i=0
			stat1="4"
			stat3="4"
			stat2_=0
			stat7=beatlnum
			repeat beatlnum
				if(beatl.cnt.0=cc){
					stat7=cnt
					stat2_=1
					stat1=str(beatl.cnt.1)
					stat3=str(beatl.cnt.2)
					break
				}else:if(beatl.cnt.0>cc){
					stat7=cnt
					break
				}else{
					stat1=str(beatl.cnt.1)
					stat3=str(beatl.cnt.2)
				}
			loop
			t.i=0 : it.i=lang.8.1 : r.i=stat1 : i++
			t.i=0 : it.i=lang.8.2 : r.i=stat3
			_input lang.8.0/*"変拍子の挿入"*/,it,t,opt,r,2,0
			if((int(r.0)>0)&(int(r.1)>0)&((r.0!=stat1)|(r.1!=stat3))&(stat!=-1)){
				if((192\(int(r.1)))!=0){
					dialog lang.8.5/*"拍子の分母の値は192の約数で指定してください。"*/,1,lang.0.2
				}else{
					gosub *undokakuho
					if(stat2_=1){
						if((beatl.stat7.1!=int(r.0))|(beatl.stat7.2!=int(r.1))){
							beatl.stat7.1=int(r.0)
							beatl.stat7.2=int(r.1)
							e=1:gosub *refreshtitle
						}
					}else{
						for i,beatlnum,stat7-1,-1
							beatl.(i+1).0=beatl.i.0
							beatl.(i+1).1=beatl.i.1
							beatl.(i+1).2=beatl.i.2
						next
						beatlnum++
						beatl.stat7.0=cc
						beatl.stat7.1=int(r.0)
						beatl.stat7.2=int(r.1)
						e=1:gosub *refreshtitle
					}
				}
			}
		}else:if((edittarget=TARGET_POS)&(ctrl_key=1)&(shift_key=1)){
			sdim it,128,1
			dim t,1
			sdim r,128,1
			sdim opt,128,1
			i=0
			stat1=""
			stat2_=0 // 同じ場所に既に注釈が存在するか
			stat7=commentnum // 同じ場所に存在した注釈のID
			stat8 = 2 * (1 - isDirectChartEditingEnabled) // 付加される"//"の文字数(直接編集の場合は"//"を付加しないので0)
			repeat commentnum
				if((comment.cnt=cc)&(isDirectChartEditingEnabled | StartsWith(commentstr.cnt, "//"))){
					stat7=cnt
					stat2_=1 // 注釈が存在した
					stat1=strmid(commentstr.cnt,stat8,strlen(commentstr.cnt) - stat8)
					break
				}else:if(comment.cnt=cc){
					stat7=cnt
				}else:if(comment.cnt>cc){
					stat7=cnt
					break
				}
			loop
			t.i=2 : it.i=lang.8.81 : r.i=stat1
			_input lang.8.80/*"注釈の挿入"*/,it,t,opt,r,2,INPUT_LARGEWIDTH
			if((r.0!=stat1)&(stat!=-1)){
				gosub *undokakuho
				strrep r.0,"|","" // 譜面の行("0000|00|--")と誤る可能性のある文字('|')を除去
				if (isDirectChartEditingEnabled = 0) {
					// 直接編集が無効の場合は注釈の内容部分のみが入力対象なので先頭に"//"を付加
					r.0 = "//" + r.0
				}
				if(stat2_=1){
					// 既存の注釈の上書き
					if(r.0=""){
						// 空文字列が指定された場合は注釈を削除
						ardel comment,commentnum,stat7
						ardel commentstr,commentnum,stat7
						commentnum--
					}else:if(commentstr.stat7!=r.0){
						// 以前と異なる内容ならば上書き
						commentstr.stat7=r.0
						e=1:gosub *refreshtitle
					}
				}else{
					// 注釈の新規挿入
					for i,commentnum,stat7-1,-1
						comment.(i+1)=comment.i
						commentstr.(i+1)=commentstr.i
					next
					commentnum++
					comment.stat7=cc
					commentstr.stat7=r.0
					e=1:gosub *refreshtitle
				}
			}
		}else:if(edittarget=TARGET_POS){
			sdim it,128,1
			dim t,1
			sdim r,128,1
			sdim opt,128,1
			i=0
			stat1=120
			stat2_=0
			stat7=bpmlnum
			stat8=""
			repeat bpmlnum
				if(bpml.cnt.0=cc){
					stat7=cnt
					stat2_=1
					stat1=str(double(bpml.cnt.1)/1000)
					stat1=strtrim(stat1,2,'0')
					stat1=strtrim(stat1,2,'.')
					stat8=bpml.cnt.1
					break
				}else:if(bpml.cnt.0>cc){
					stat7=cnt
					break
				}else{
					stat1=str(double(bpml.cnt.1)/1000)
					stat1=strtrim(stat1,2,'0')
					stat1=strtrim(stat1,2,'.')
					stat8=bpml.cnt.1
				}
			loop
			t.i=1 : it.i=lang.8.11/*"BPM:"*/ : r.i=stat1
			_input lang.8.10/*"BPMの変更"*/,it,t,opt,r,1,0
			if((int(double(r.0)*1000)>0)&(int(r.0)<65536)&(int(r.0)>0)&(stat!=-1)&(int(double(r.0)*1000)!=stat8)){
				gosub *undokakuho
				if(stat2_=1){
					if(bpml.stat7.1!=int(double(r.0)*1000)){
						bpml.stat7.1=int(double(r.0)*1000)
						e=1:gosub *refreshtitle
					}
				}else{
					for i,bpmlnum,stat7-1,-1
						bpml.(i+1).0=bpml.i.0
						bpml.(i+1).1=bpml.i.1
					next
					bpmlnum++
					bpml.stat7.0=cc
					bpml.stat7.1=int(double(r.0)*1000)
					e=1:gosub *refreshtitle
				}
			}
		}
		if(edittarget=TARGET_NOTE){
			if((ctrl_key=0)&(shift_key=1)){
				f=0
				repeat notenum
					if((note.cnt.1=cc)&(note.cnt.2=0)&(note.cnt.0=cbtn)){
						selnote.0=cnt
						lastseltype=0
						lastsel=0
						selnotenum=1
						selshift=0
						f=1
					}
				loop
				if(f=1){
					gosub *draw
					return
				}
			}
			gosub *undokakuho
			stat1=notenum
			stat2=0
			repeat notenum
				if((note.cnt.1<=cc)&(note.cnt.1+note.cnt.2>=cc)&(note.cnt.0=cbtn)){
					stat2=1
					break
				}
				if(note.cnt.1>cc){
					stat1=cnt
					break
				}
			loop
			if(stat2=1){
				gosub *selinit
				gosub *draw
				return
			}
			for i,notenum,stat1-1,-1
				note.(i+1).0=note.i.0
				note.(i+1).1=note.i.1
				note.(i+1).2=note.i.2
				note.(i+1).3=note.i.3
				note.(i+1).4=note.i.4
				note.(i+1).5=note.i.5
				notesefname.(i+1)=notesefname.i
			next
			note.stat1.0=cbtn
			note.stat1.1=cc
			note.stat1.2=0
			note.stat1.3=0
			note.stat1.4=0
			note.stat1.5=0
			notesefname.stat1=""
			selnote.0=stat1
			selnotenum=1
			selshift=0
			lastseltype=0
			lastsel=0
			notenum++
			e=1:gosub *refreshtitle
		}
		if(edittarget=TARGET_LNOTE2){
			if((ctrl_key=1)&(shift_key=0)){
				f=0
				repeat notenum
					if((note.cnt.1=cc)&(note.cnt.2=0)&(note.cnt.0=clbtn)){
						f=1
						stat7=cnt
						break
					}
				loop
				if(f=1){
					sdim splitstat,1
					split notesefname.stat7,";",splitstat
					if(length(splitstat)=1){
						_stat3=100
					}else{
						_stat3=int(splitstat.1)
					}
					_stat1=splitstat.0
					sdim it,128,2
					dim t,2
					sdim r,128,2
					sdim opt,128,2
					i=0
					stat3=lang.8.92
					stat2="clap.wav\nclap_impact.wav\nclap_punchy.wav\nsnare.wav\nsnare_lo.wav" // ユーザーによるseフォルダへの誤追加を防止するために追加されても選択肢に加えない
					notesel stat2
					r.0="0"
					repeat notemax
						noteget stat1,cnt
						stat1 = strmid(stat1, 0, strlen(stat1) - 4/*".wav"の文字数*/)
						stat3 += "\n" + stat1
						if(_stat1 = stat1){
							r.0 = str(cnt + 1)
						}
					loop
					preset_sfx_count = notemax
					dirlist stat2, getpath(fname,32) + "*.wav"
					notesel stat2
					repeat notemax
						noteget stat1, cnt
						stat3 += "\n" + stat1
						if(_stat1 = stat1){
							r.0 = str(preset_sfx_count + cnt + 1)
						}
					loop
					if((r.0 = "0") & (_stat1 != "")){
						stat3 += "\n" + _stat1
						r.0 = str(preset_sfx_count + notemax + 1)
					}
					t.i=1 : it.i=lang.8.91/*"効果音の種類:"*/ : opt.i=stat3 : i++
					t.i=0 : it.i=lang.8.93/*"再生音量[%]:"*/ : r.i=str(min(max(_stat3,0),100))
					_input lang.8.90/*"効果音チップの設定"*/,it,t,opt,r,2,0
					if(stat!=-1){
						gosub *undokakuho
						if(int(r.0)>0){
							notesel opt.0
							noteget notesefname.stat7,int(r.0)
							if(int(r.1)<100){
								notesefname.stat7+=";"+str(max(int(r.1),0))
							}
						}else{
							notesefname.stat7=""
						}
						e=1:gosub *refreshtitle
					}
				}
			}
			if((ctrl_key=0)&(shift_key=1)){
				f=0
				repeat notenum
					if((note.cnt.1=cc)&(note.cnt.2=0)&(note.cnt.0=clbtn)){
						selnote.0=cnt
						lastseltype=0
						lastsel=0
						selnotenum=1
						selshift=0
						f=1
					}
				loop
				if(f=1){
					gosub *draw
					return
				}
			}
			gosub *undokakuho
			stat1=notenum
			stat2=0
			repeat notenum
				if((note.cnt.1<=cc)&(note.cnt.1+note.cnt.2>=cc)&(note.cnt.0=clbtn)){
					stat2=1
					break
				}
				if(note.cnt.1>cc){
					stat1=cnt
					break
				}
			loop
			if(stat2=1){
				gosub *selinit
				gosub *draw
				return
			}
			for i,notenum,stat1-1,-1
				note.(i+1).0=note.i.0
				note.(i+1).1=note.i.1
				note.(i+1).2=note.i.2
				note.(i+1).3=note.i.3
				note.(i+1).4=note.i.4
				note.(i+1).5=note.i.5
				notesefname.(i+1)=notesefname.i
			next
			note.stat1.0=clbtn
			note.stat1.1=cc
			note.stat1.2=0
			note.stat1.3=0
			note.stat1.4=0
			note.stat1.5=0
			notesefname.stat1=""
			selnote.0=stat1
			selnotenum=1
			selshift=0
			lastseltype=0
			lastsel=0
			notenum++
			e=1:gosub *refreshtitle
		}
		if((edittarget=TARGET_NOTE2)&(ctrl_key=0)){
			if(enowstat!=0):return
			if((ctrl_key=0)&(shift_key=1)){
				f=0
				repeat notenum
					if((note.cnt.1<=cc)&(note.cnt.2>0)&(note.cnt.1+note.cnt.2>cc)&(note.cnt.0=cbtn)){
						selnote.0=cnt
						lastseltype=0
						lastsel=0
						selnotenum=1
						selshift=0
						f=1
					}
				loop
				if(f=1){
					gosub *draw
					return
				}
			}
			gosub *undokakuho
			stat_1=notenum
			stat2=0
			repeat notenum
				if(note.cnt.1>cc){
					stat_1=cnt
					break
				}
			loop
			if(stat2=1){
				gosub *selinit
				gosub *draw
				return
			}
			for i,notenum-1,stat_1-1,-1
				note.(i+1).0=note.i.0
				note.(i+1).1=note.i.1
				note.(i+1).2=note.i.2
				note.(i+1).3=note.i.3
				note.(i+1).4=note.i.4
				note.(i+1).5=note.i.5
				notesefname.(i+1)=notesefname.i
			next
			note.stat_1.0=cbtn
			note.stat_1.1=cc
			note.stat_1.2=UNIT_MEASURE/editdiv
			note.stat_1.3=0
			note.stat_1.4=0
			note.stat_1.5=0
			notesefname.stat_1=""
			enowstat=1
			enowl=stat_1
			selnote.0=stat_1
			selnotenum=1
			selshift=0
			lastseltype=0
			lastsel=0
			notenum++
			e=1:gosub *refreshtitle
			oncmd gosub *OnClick2, 0x0202
			repeat
				stat_1=enowl
				getkey stat2,1
				if(stat2=0):break
				if(enowstat=2):break
				//cc2=(posnow+(mousex-vsep/2-9)/(41+9*2+vsp))*vtate*UNIT_MEASURE+(-10+topsep+vUNIT_MEASURE*vtate-mousey)/vUNIT_MEASURE*UNIT_MEASURE+(((-10+topsep+vUNIT_MEASURE*vtate-mousey)\vUNIT_MEASURE)/(vUNIT_MEASURE/editdiv)+1)*UNIT_MEASURE/editdiv
				// 以下はvUNIT_MEASUREがUNIT_MEASUREと同じことを想定した計算なので注意
				cc2=(posnow+mousex/(41+9*2+vsp))*vtate*UNIT_MEASURE+(-10+topsep+vUNIT_MEASURE*vtate-mousey)
				cc2*=10:cc2/=vzoom(10)
				cc2_=b2c(c2b(cc2))
				cc2=cc2_+((cc2-cc2_)/(UNIT_MEASURE/editdiv)+1)*(UNIT_MEASURE/editdiv)
				if(cc2-cc<0){
					note.stat_1.1=cc
					note.stat_1.2=UNIT_MEASURE/editdiv
				}else{
					note.stat_1.1=cc
					note.stat_1.2=cc2-cc
				}
				if(cc=cc2):note.stat_1.2=UNIT_MEASURE/editdiv
				st1=stat_1
				gosub *draw
				await 0
			loop
			// ※ [  ]が挿入するノーツ
			repeat notenum
				// [( )]のパターン
				if((note.st1.1=note.cnt.1)&(note.st1.1+note.st1.2=note.cnt.1+note.cnt.2)&(cnt!=st1)&(note.cnt.0=note.st1.0)){
					repeat notenum-cnt-1,cnt
						note.cnt.0=note.(cnt+1).0
						note.cnt.1=note.(cnt+1).1
						note.cnt.2=note.(cnt+1).2
						note.cnt.3=note.(cnt+1).3
						note.cnt.4=note.(cnt+1).4
						note.cnt.5=note.(cnt+1).5
						notesefname.cnt=notesefname.(cnt+1)
					loop
					notenum--
					gosub *selinit
					e=1
					stat2=1
					break
				}
			loop
			if(stat2=0){
				repeat notenum
					// ( [ ] )のパターン
					if((note.st1.1>=note.cnt.1)&(note.st1.1+note.st1.2<=note.cnt.1+note.cnt.2)&(cnt!=st1)&(note.cnt.0=note.st1.0)){
						repeat notenum-st1-1,st1
							note.cnt.0=note.(cnt+1).0
							note.cnt.1=note.(cnt+1).1
							note.cnt.2=note.(cnt+1).2
							note.cnt.3=note.(cnt+1).3
							note.cnt.4=note.(cnt+1).4
							note.cnt.5=note.(cnt+1).5
							notesefname.cnt=notesefname.(cnt+1)
						loop
						notenum--
						gosub *selinit
						e=1
						stat2=1
						break
					}
				loop
				if(stat2=0){
					repeat
						stat2=0
						repeat notenum
							// [ ( ) ]のパターン
							if((note.st1.1<=note.cnt.1)&(note.st1.1+note.st1.2>=note.cnt.1+note.cnt.2)&(cnt!=st1)&(note.cnt.0=note.st1.0)){
								stat_1=0
								repeat notenum-cnt-1,cnt
									if(cnt+1=st1):stat_1--
									note.cnt.0=note.(cnt+1).0
									note.cnt.1=note.(cnt+1).1
									note.cnt.2=note.(cnt+1).2
									note.cnt.3=note.(cnt+1).3
									note.cnt.4=note.(cnt+1).4
									note.cnt.5=note.(cnt+1).5
									notesefname.cnt=notesefname.(cnt+1)
								loop
								notenum--
								gosub *selinit
								e=1
								st1+=stat_1
								stat2=1
								break
							}
						loop
						repeat notenum
							// ( [ ) ]のパターン
							if((note.st1.1>=note.cnt.1)&(note.st1.1<note.cnt.1+note.cnt.2)&(note.st1.1+note.st1.2>note.cnt.1+note.cnt.2)&(cnt!=st1)&(note.cnt.0=note.st1.0)){
								note.cnt.2+=note.st1.1+note.st1.2-note.cnt.1-note.cnt.2
								stat_1=0
								st2=cnt
								repeat notenum-st1-1,st1
									if(cnt+1>=notenum):break
									if(cnt+1=st2):stat_1--
									note.cnt.0=note.(cnt+1).0
									note.cnt.1=note.(cnt+1).1
									note.cnt.2=note.(cnt+1).2
									note.cnt.3=note.(cnt+1).3
									note.cnt.4=note.(cnt+1).4
									note.cnt.5=note.(cnt+1).5
									notesefname.cnt=notesefname.(cnt+1)
								loop
								notenum--
								gosub *selinit
								e=1
								st1=cnt+stat_1
								stat2=1
								break
							}
						loop
						repeat notenum
							// [ ( ] )のパターン
							if((note.st1.1<=note.cnt.1)&(note.st1.1+note.st1.2>note.cnt.1)&(note.st1.1+note.st1.2<=note.cnt.1+note.cnt.2)&(cnt!=st1)&(note.cnt.0=note.st1.0)){
								note.st1.2+=note.cnt.1+note.cnt.2-note.st1.1-note.st1.2
								stat_1=0
								st2=cnt
								repeat notenum-cnt-1,cnt
									if(cnt+1>=notenum):break
									if(cnt=st1):stat_1--
									note.cnt.0=note.(cnt+1).0
									note.cnt.1=note.(cnt+1).1
									note.cnt.2=note.(cnt+1).2
									note.cnt.3=note.(cnt+1).3
									note.cnt.4=note.(cnt+1).4
									note.cnt.5=note.(cnt+1).5
									notesefname.cnt=notesefname.(cnt+1)
								loop
								notenum--
								gosub *selinit
								e=1
								st1+=stat_1
								stat2=1
								break
							}
						loop
						if(stat2=0):break
					loop
					if(enowl<notenum){
						selnote.0=enowl
						selnotenum=1
						lastseltype=0
						lastsel=0
					}else:selnotenum=0
					selshift=0
				}
			}
			gosub *refreshtitle
			enowstat=0
		}
		if((edittarget=TARGET_LNOTE)&(ctrl_key=1)&(shift_key=0)){
			repeat notenum
				if((note.cnt.1<=cc)&(note.cnt.1+note.cnt.2>cc)&(note.cnt.0=clbtn)){
					notefxplus cnt
					break
				}
			loop
		}
		if((edittarget=TARGET_LNOTE)&(ctrl_key=0)&(shift_key=1)){
			f=0
			repeat notenum
				if((note.cnt.1<=cc)&(note.cnt.1+note.cnt.2>cc)&(note.cnt.0=clbtn)&(((note.cnt.3>=FX_RE8)&(note.cnt.3<=FX_RE32))|((note.cnt.3>=100)&(int(userfx_params.(max(note.cnt.3-100,0)).0)=FXDEF_FXTYPE_RETR)))){
					sdim it,128,1
					dim t,1
					sdim r,128,1
					sdim opt,128,1
					i=0
					stat1_=""+note.cnt.4
					stat2_=0
					t.i=1 : it.i=lang.8.55/*"間隔(1/*小節)[1-]:"*/ : r.i=stat1_
					_input replace(lang.8.54,"%0","Retrigger")/*"%0エフェクトの速度を変更"*/,it,t,opt,r,1,0
					if((int(r.0)<=192)&(int(r.0)>0)&(r.0!=stat1_)&(stat!=-1)){
						gosub *undokakuho
						note.cnt.4=int(r.0)
						if(note.cnt.3<100){
							if(note.cnt.4=12){
								note.cnt.3=FX_RE12
							}else:if(note.cnt.4=16){
								note.cnt.3=FX_RE16
							}else:if(note.cnt.4=24){
								note.cnt.3=FX_RE24
							}else:if(note.cnt.4=32){
								note.cnt.3=FX_RE32
							}else:note.cnt.3=FX_RE8
						}
						e=1:gosub *refreshtitle
					}
					break
				}
				if((note.cnt.1<=cc)&(note.cnt.1+note.cnt.2>cc)&(note.cnt.0=clbtn)&(((note.cnt.3>=FX_GA4)&(note.cnt.3<=FX_GA32))|((note.cnt.3>=100)&(int(userfx_params.(max(note.cnt.3-100,0)).0)=FXDEF_FXTYPE_GATE)))){
					sdim it,128,1
					dim t,1
					sdim r,128,1
					sdim opt,128,1
					i=0
					stat1_=""+note.cnt.4
					stat2_=0
					t.i=1 : it.i=lang.8.55/*"間隔(1/*小節)[1-]:"*/ : r.i=stat1_
					_input replace(lang.8.54,"%0","Gate")/*"%0エフェクトの速度を変更"*/,it,t,opt,r,1,0
					if((int(r.0)<=192)&(int(r.0)>0)&(r.0!=stat1_)&(stat!=-1)){
						gosub *undokakuho
						note.cnt.4=int(r.0)
						if(note.cnt.3<100){
							if(note.cnt.4=8){
								note.cnt.3=FX_GA8
							}else:if(note.cnt.4=12){
								note.cnt.3=FX_GA12
							}else:if(note.cnt.4=16){
								note.cnt.3=FX_GA16
							}else:if(note.cnt.4=24){
								note.cnt.3=FX_GA24
							}else:if(note.cnt.4=32){
								note.cnt.3=FX_GA32
							}else:note.cnt.3=FX_GA4
						}
						e=1:gosub *refreshtitle
					}
					break
				}
				if((note.cnt.1<=cc)&(note.cnt.1+note.cnt.2>cc)&(note.cnt.0=clbtn)&((note.cnt.3=FX_WO12)|((note.cnt.3>=100)&(int(userfx_params.(max(note.cnt.3-100,0)).0)=FXDEF_FXTYPE_WOBB)))){
					sdim it,128,1
					dim t,1
					sdim r,128,1
					sdim opt,128,1
					i=0
					stat1_=""+note.cnt.4
					stat2_=0
					t.i=1 : it.i=lang.8.55/*"間隔(1/*小節)[1-]:"*/ : r.i=stat1_
					_input replace(lang.8.54,"%0","Wobble")/*"%0エフェクトの速度を変更"*/,it,t,opt,r,1,0
					if((int(r.0)<=192)&(int(r.0)>0)&(r.0!=stat1_)&(stat!=-1)){
						gosub *undokakuho
						note.cnt.4=int(r.0)
						e=1:gosub *refreshtitle
					}
					break
				}
				if((note.cnt.1<=cc)&(note.cnt.1+note.cnt.2>cc)&(note.cnt.0=clbtn)&((note.cnt.3=FX_EC4)|((note.cnt.3>=100)&(int(userfx_params.(max(note.cnt.3-100,0)).0)=FXDEF_FXTYPE_ECHO)))){
					sdim it,128,2
					dim t,2
					sdim r,128,2
					sdim opt,128,2
					i=0
					stat1_=""+note.cnt.4
					stat2_=""+note.cnt.5
					t.i=1 : it.i=lang.8.55/*"間隔(1/*小節)[1-]:"*/ : r.i=stat1_ : i++
					t.i=1 : it.i=lang.8.57/*"フィードバック[%]:"*/ : r.i=stat2_
					_input replace(lang.8.56,"%0","Echo")/*"%0エフェクトの値を変更"*/,it,t,opt,r,2,0
					if((int(r.0)<=192)&(int(r.0)>0)&(r.0!=stat1_)&(stat!=-1)){
						gosub *undokakuho
						note.cnt.4=int(r.0)
						e=1:gosub *refreshtitle
					}
					if((int(r.1)<=100)&(int(r.1)>=0)&(r.1!=stat2_)&(stat!=-1)){
						gosub *undokakuho
						note.cnt.5=int(r.1)
						e=1:gosub *refreshtitle
					}
					break
				}
				if((note.cnt.1<=cc)&(note.cnt.1+note.cnt.2>cc)&(note.cnt.0=clbtn)&((note.cnt.3=FX_PITC)|((note.cnt.3>=100)&(int(userfx_params.(max(note.cnt.3-100,0)).0)=FXDEF_FXTYPE_PITC)))){
					sdim it,128,1
					dim t,1
					sdim r,128,1
					sdim opt,128,1
					i=0
					stat1_=""+note.cnt.4
					stat2_=0
					t.i=1 : it.i=lang.8.58/*"ピッチ [-48 - 48]:"*/ : r.i=stat1_
					_input replace(lang.8.54,"%0","PitchShift")/*"%0エフェクトの速度を変更"*/,it,t,opt,r,1,0
					if((int(r.0)<=48)&(int(r.0)>=-48)&(r.0!=stat1_)&(stat!=-1)){
						gosub *undokakuho
						note.cnt.4=int(r.0)
						e=1:gosub *refreshtitle
					}
					break
				}
				if((note.cnt.1<=cc)&(note.cnt.1+note.cnt.2>cc)&(note.cnt.0=clbtn)&((note.cnt.3=FX_BITC)|((note.cnt.3>=100)&(int(userfx_params.(max(note.cnt.3-100,0)).0)=FXDEF_FXTYPE_BITC)))){
					sdim it,128,1
					dim t,1
					sdim r,128,1
					sdim opt,128,1
					i=0
					stat1_=""+note.cnt.4
					stat2_=0
					t.i=1 : it.i=lang.8.53/*"強さ[0-64]:"*/ : r.i=stat1_
					_input lang.8.52/*"BitCrusherエフェクトの強さを変更"*/,it,t,opt,r,1,0
					if((int(r.0)<=64)&((r.0="0")|(int(r.0)>0))&(r.0!=stat1_)&(stat!=-1)){
						gosub *undokakuho
						note.cnt.4=int(r.0)
						e=1:gosub *refreshtitle
					}
					break
				}
				if((note.cnt.1<=cc)&(note.cnt.1+note.cnt.2>cc)&(note.cnt.0=clbtn)&((note.cnt.3=FX_TSTP)|((note.cnt.3>=100)&(int(userfx_params.(max(note.cnt.3-100,0)).0)=FXDEF_FXTYPE_TSTP)))){
					sdim it,128,1
					dim t,1
					sdim r,128,1
					sdim opt,128,1
					i=0
					stat1_=""+note.cnt.4
					stat2_=0
					t.i=1 : it.i=lang.8.51/*"速度[0-100]:"*/ : r.i=stat1_
					_input lang.8.50/*"TapeStopエフェクトの速度を変更"*/,it,t,opt,r,1,0
					if((int(r.0)<=100)&((r.0="0")|(int(r.0)>0))&(r.0!=stat1_)&(stat!=-1)){
						gosub *undokakuho
						note.cnt.4=int(r.0)
						e=1:gosub *refreshtitle
					}
					break
				}
				if((note.cnt.1<=cc)&(note.cnt.2>0)&(note.cnt.1+note.cnt.2>cc)&(note.cnt.0=clbtn)){
					selnote.0=cnt
					lastseltype=0
					lastsel=0
					selnotenum=1
					selshift=0
					f=1
				}
			loop
			if(f=1){
				gosub *draw
				return
			}
		}else:if((edittarget=TARGET_LNOTE)&(ctrl_key=1)&(shift_key=1)){
			repeat notenum
				if((note.cnt.1<=cc)&(note.cnt.1+note.cnt.2>cc)&(note.cnt.0=clbtn)){
					gosub *undokakuho
					note.cnt.3=12
					note.cnt.4=0
					e=1:gosub *refreshtitle
					break
				}
			loop
		}else:if((edittarget=TARGET_LNOTE)&(ctrl_key=0)&(shift_key=0)){
			if(enowstat!=0):return
			gosub *undokakuho
			stat_1=notenum
			stat2=0
			repeat notenum
				if(note.cnt.1>cc){
					stat_1=cnt
					break
				}
			loop
			if(stat2=1){
				gosub *selinit
				gosub *draw
				return
			}
			for i,notenum-1,stat_1-1,-1
				note.(i+1).0=note.i.0
				note.(i+1).1=note.i.1
				note.(i+1).2=note.i.2
				note.(i+1).3=note.i.3
				note.(i+1).4=note.i.4
				note.(i+1).5=note.i.5
				notesefname.(i+1)=notesefname.i
			next
			note.stat_1.0=clbtn
			note.stat_1.1=cc
			note.stat_1.2=UNIT_MEASURE/editdiv
			note.stat_1.3=0
			note.stat_1.4=0
			note.stat_1.5=0
			notesefname.stat_1=""
			enowstat=1
			enowl=stat_1
			selnote.0=stat_1
			selnotenum=1
			selshift=0
			lastseltype=0
			lastsel=0
			notenum++
			e=1:gosub *refreshtitle
			oncmd gosub *OnClick2, 0x0202
			repeat
				stat_1=enowl
				getkey stat2,1
				if(stat2=0):break
				if(enowstat=2):break
				//cc2=(posnow+(mousex-vsep/2-9)/(41+9*2+vsp))*vtate*UNIT_MEASURE+(-10+topsep+vUNIT_MEASURE*vtate-mousey)/vUNIT_MEASURE*UNIT_MEASURE+(((-10+topsep+vUNIT_MEASURE*vtate-mousey)\vUNIT_MEASURE)/(vUNIT_MEASURE/editdiv)+1)*UNIT_MEASURE/editdiv
				// 以下はvUNIT_MEASUREがUNIT_MEASUREと同じことを想定した計算なので注意
				cc2=(posnow+mousex/(41+9*2+vsp))*vtate*UNIT_MEASURE+(-10+topsep+vUNIT_MEASURE*vtate-mousey)
				cc2*=10:cc2/=vzoom(10)
				cc2_=b2c(c2b(cc2))
				cc2=cc2_+((cc2-cc2_)/(UNIT_MEASURE/editdiv)+1)*(UNIT_MEASURE/editdiv)
				if(cc2-cc<0){
					note.stat_1.1=cc
					note.stat_1.2=UNIT_MEASURE/editdiv
				}else{
					note.stat_1.1=cc
					note.stat_1.2=cc2-cc
				}
				if(cc=cc2):note.stat_1.2=UNIT_MEASURE/editdiv
				st1=stat_1
				gosub *draw
				await 0
			loop
			// ※ [  ]が挿入するノーツ
			repeat notenum
				// [( )]のパターン
				if((note.st1.1=note.cnt.1)&(note.st1.1+note.st1.2=note.cnt.1+note.cnt.2)&(cnt!=st1)&(note.cnt.0=note.st1.0)){
					repeat notenum-cnt-1,cnt
						note.cnt.0=note.(cnt+1).0
						note.cnt.1=note.(cnt+1).1
						note.cnt.2=note.(cnt+1).2
						note.cnt.3=note.(cnt+1).3
						note.cnt.4=note.(cnt+1).4
						note.cnt.5=note.(cnt+1).5
						notesefname.cnt=notesefname.(cnt+1)
					loop
					notenum--
					gosub *selinit
					e=1
					stat2=1
					break
				}
			loop
			if(stat2=0){
				repeat notenum
					// ( [ ] )のパターン
					if((note.st1.1>=note.cnt.1)&(note.st1.1+note.st1.2<=note.cnt.1+note.cnt.2)&(cnt!=st1)&(note.cnt.0=note.st1.0)){
						repeat notenum-st1-1,st1
							note.cnt.0=note.(cnt+1).0
							note.cnt.1=note.(cnt+1).1
							note.cnt.2=note.(cnt+1).2
							note.cnt.3=note.(cnt+1).3
							note.cnt.4=note.(cnt+1).4
							note.cnt.5=note.(cnt+1).5
							notesefname.cnt=notesefname.(cnt+1)
						loop
						notenum--
						gosub *selinit
						e=1
						stat2=1
						break
					}
				loop
				if(stat2=0){
					repeat
						stat2=0
						repeat notenum
							// [ ( ) ]のパターン
							if((note.st1.1<=note.cnt.1)&(note.st1.1+note.st1.2>=note.cnt.1+note.cnt.2)&(cnt!=st1)&(note.cnt.0=note.st1.0)){
								stat_1=0
								repeat notenum-cnt-1,cnt
									if(cnt+1=st1):stat_1--
									note.cnt.0=note.(cnt+1).0
									note.cnt.1=note.(cnt+1).1
									note.cnt.2=note.(cnt+1).2
									note.cnt.3=note.(cnt+1).3
									note.cnt.4=note.(cnt+1).4
									note.cnt.5=note.(cnt+1).5
									notesefname.cnt=notesefname.(cnt+1)
								loop
								notenum--
								gosub *selinit
								e=1
								st1+=stat_1
								stat2=1
								break
							}
						loop
						repeat notenum
							// ( [ ) ]のパターン
							if((note.st1.1>=note.cnt.1)&(note.st1.1<note.cnt.1+note.cnt.2)&(note.st1.1+note.st1.2>note.cnt.1+note.cnt.2)&(cnt!=st1)&(note.cnt.0=note.st1.0)){
								note.cnt.2+=note.st1.1+note.st1.2-note.cnt.1-note.cnt.2
								stat_1=0
								st2=cnt
								repeat notenum-st1-1,st1
									if(cnt+1>=notenum):break
									if(cnt+1=st2):stat_1--
									note.cnt.0=note.(cnt+1).0
									note.cnt.1=note.(cnt+1).1
									note.cnt.2=note.(cnt+1).2
									note.cnt.3=note.(cnt+1).3
									note.cnt.4=note.(cnt+1).4
									note.cnt.5=note.(cnt+1).5
									notesefname.cnt=notesefname.(cnt+1)
								loop
								notenum--
								gosub *selinit
								e=1
								st1=cnt+stat_1
								stat2=1
								break
							}
						loop
						repeat notenum
							// [ ( ] )のパターン
							if((note.st1.1<=note.cnt.1)&(note.st1.1+note.st1.2>note.cnt.1)&(note.st1.1+note.st1.2<=note.cnt.1+note.cnt.2)&(cnt!=st1)&(note.cnt.0=note.st1.0)){
								note.st1.2+=note.cnt.1+note.cnt.2-note.st1.1-note.st1.2
								stat_1=0
								st2=cnt
								repeat notenum-cnt-1,cnt
									if(cnt+1>=notenum):break
									if(cnt=st1):stat_1--
									note.cnt.0=note.(cnt+1).0
									note.cnt.1=note.(cnt+1).1
									note.cnt.2=note.(cnt+1).2
									note.cnt.3=note.(cnt+1).3
									note.cnt.4=note.(cnt+1).4
									note.cnt.5=note.(cnt+1).5
									notesefname.cnt=notesefname.(cnt+1)
								loop
								notenum--
								gosub *selinit
								e=1
								st1+=stat_1
								stat2=1
								break
							}
						loop
						if(stat2=0):break
					loop
					if(enowl<notenum){
						selnote.0=enowl
						selnotenum=1
						lastseltype=0
						lastsel=0
					}else:selnotenum=0
					selshift=0
				}
			}
			gosub *refreshtitle
			enowstat=0
		}
		if((edittarget=TARGET_STOP)&(ctrl_key=0)){
			if(enowstat!=0):return
			if((ctrl_key=0)&(shift_key=1)){
				f=0
				repeat stpnum
					if((stp.cnt.0<=cc)&(stp.cnt.0+stp.cnt.1>cc)){
						selstp.0=cnt
						lastseltype=4
						lastsel=selstpnum
						selstpnum=1
						selshift=0
						f=1
					}
				loop
				if(f=1){
					gosub *draw
					return
				}
			}
			gosub *undokakuho
			stat1_=stpnum
			stat2=0
			repeat stpnum
				if(stp.cnt.0>cc){
					stat1_=cnt
					break
				}
			loop
			if(stat2=1){
				gosub *selinit
				gosub *draw
				return
			}
			for i,stpnum,stat1_-1,-1
				stp.(i+1).0=stp.i.0
				stp.(i+1).1=stp.i.1
			next
			stp.stat1_.0=cc
			stp.stat1_.1=UNIT_MEASURE/editdiv
			enowstat=0//??
			enowl=stat1_
			lastseltype=4
			lastsel=0
			selstp.0=stat1_
			selstpnum=1
			selshift=0
			stpnum++
			e=1:gosub *refreshtitle
			oncmd gosub *OnClick2, 0x0202
			repeat
				getkey stat2,1
				if(stat2=0):break
				if(enowstat=2):break
				//cc2=(posnow+(mousex-vsep/2-9)/(41+9*2+vsp))*vtate*UNIT_MEASURE+(-10+topsep+vUNIT_MEASURE*vtate-mousey)/vUNIT_MEASURE*UNIT_MEASURE+(((-10+topsep+vUNIT_MEASURE*vtate-mousey)\vUNIT_MEASURE)/(vUNIT_MEASURE/editdiv)+1)*UNIT_MEASURE/editdiv
				// 以下はvUNIT_MEASUREがUNIT_MEASUREと同じことを想定した計算なので注意
				cc2=(posnow+mousex/(41+9*2+vsp))*vtate*UNIT_MEASURE+(-10+topsep+vUNIT_MEASURE*vtate-mousey)
				cc2*=10:cc2/=vzoom(10)
				cc2_=b2c(c2b(cc2))
				cc2=cc2_+((cc2-cc2_)/(UNIT_MEASURE/editdiv)+1)*(UNIT_MEASURE/editdiv)
				if(cc2-cc<0){
					stp.stat1_.0=cc
					stp.stat1_.1=UNIT_MEASURE/editdiv
				}else{
					stp.stat1_.0=cc
					stp.stat1_.1=cc2-cc
				}
				if(cc=cc2):stp.stat1_.1=UNIT_MEASURE/editdiv
				st1=stat1_
				gosub *draw
				await 0
			loop
			// ※ [  ]が挿入するノーツ
			repeat stpnum
				// [( )]のパターン
				if((stp.st1.0=stp.cnt.0)&(stp.st1.0+stp.st1.1=stp.cnt.0+stp.cnt.1)&(cnt!=st1)){
					repeat stpnum-cnt-1,cnt
						stp.cnt.0=stp.(cnt+1).0
						stp.cnt.1=stp.(cnt+1).1
					loop
					stpnum--
					gosub *selinit
					e=1
					stat2=1
					break
				}
			loop
			if(stat2=0){
				repeat stpnum
					// ( [ ] )のパターン
					if((stp.st1.0>=stp.cnt.0)&(stp.st1.0+stp.st1.1<=stp.cnt.0+stp.cnt.1)&(cnt!=st1)){
						repeat stpnum-st1-1,st1
							stp.cnt.0=stp.(cnt+1).0
							stp.cnt.1=stp.(cnt+1).1
						loop
						stpnum--
						gosub *selinit
						e=1
						stat2=1
						break
					}
				loop
				if(stat2=0){
					repeat
						stat2=0
						repeat stpnum
							// [ ( ) ]のパターン
							if((stp.st1.0<=stp.cnt.0)&(stp.st1.0+stp.st1.1>=stp.cnt.0+stp.cnt.1)&(cnt!=st1)){
								stat_1=0
								repeat stpnum-cnt-1,cnt
									if(cnt+1=st1):stat_1--
									stp.cnt.0=stp.(cnt+1).0
									stp.cnt.1=stp.(cnt+1).1
								loop
								stpnum--
								gosub *selinit
								e=1
								st1+=stat_1
								stat2=1
								break
							}
						loop
						repeat stpnum
							// ( [ ) ]のパターン
							if((stp.st1.0>=stp.cnt.0)&(stp.st1.0<stp.cnt.0+stp.cnt.1)&(stp.st1.0+stp.st1.1>stp.cnt.0+stp.cnt.1)&(cnt!=st1)){
								stp.cnt.1+=stp.st1.0+stp.st1.1-stp.cnt.0-stp.cnt.1
								stat_1=0
								repeat stpnum-st1-1,st1
									if(cnt+1>=stpnum):break
									if(cnt+1=st2):stat_1--
									stp.cnt.0=stp.(cnt+1).0
									stp.cnt.1=stp.(cnt+1).1
								loop
								stpnum--
								gosub *selinit
								e=1
								st1=cnt+stat_1
								stat2=1
								break
							}
						loop
						repeat stpnum
							// [ ( ] )のパターン
							if((stp.st1.0<=stp.cnt.0)&(stp.st1.0+stp.st1.1>stp.cnt.0)&(stp.st1.0+stp.st1.1<=stp.cnt.0+stp.cnt.1)&(cnt!=st1)){
								stp.st1.1+=stp.cnt.0+stp.cnt.1-stp.st1.0-stp.st1.1
								stat_1=0
								repeat stpnum-cnt-1,cnt
									if(cnt+1>=stpnum):break
									if(cnt=st1):stat_1--
									stp.cnt.0=stp.(cnt+1).0
									stp.cnt.1=stp.(cnt+1).1
								loop
								stpnum--
								gosub *selinit
								e=1
								st1+=stat_1
								stat2=1
								break
							}
						loop
						if(stat2=0):break
					loop
					if(enowl<stpnum){
						selstp.0=enowl
						selstpnum=1
						lastseltype=4
						lastsel=0
					}else:selstpnum=0
					selshift=0
				}
			}
		}
		if((edittarget=TARGET_ROTATE)&(ctrl_key=0)){
			gosub *selinit
			sdim it,128,1
			dim t,1
			sdim r,128,1
			sdim opt,128,1
			i=0
			stat1_="0"
			stat2_=0
			stat7=tiltnum
			stat2=""
			stat3_=0
			repeat tiltnum
				if(tilt.cnt.0=cc){
					stat7=cnt
					stat2_=1
					if((tilt.cnt.1=tilt.cnt.2)&(tilt.cnt.1<=6)){
						stat1_=str(tilt.cnt.1)
						stat2=""
					}else{
						stat1_="7"
						stat2="\n"+tiltname2_disp_long(tilt.cnt.1,tilt.cnt.2)
					}
					break
				}else:if(tilt.cnt.0>cc){
					stat7=cnt
					break
				}else:if(tilt.cnt.0<cc){
					if(tilt.cnt.2<=6){
						stat1_=str(tilt.cnt.2)
						stat2=""
					}else{
						stat1_="7"
						stat2="\n"+tiltname_disp_long(tilt.cnt.2)
						stat3_=tilt.cnt.2
					}
				}
			loop
			t.i=1 : it.i=lang.8.21/*"傾きエフェクトの種類:"*/ : r.i=stat1_
			opt.i=tiltname_disp_long(0)+"\n"+tiltname_disp_long(1)+"\n"+tiltname_disp_long(2)+"\n"+tiltname_disp_long(3)+"\n"+tiltname_disp_long(4)+"\n"+tiltname_disp_long(5)+"\n"+tiltname_disp_long(6)+stat2
			_input lang.8.20/*"傾きエフェクトの種類を設定"*/,it,t,opt,r,1,0
			if(((r.0="0")|(int(r.0)>0))&((r.0!=stat1_)|((stat2_!=1)&(r.0="7")))&(stat!=-1)){
				if(stat2_=1){
					if((tilt.stat7.1!=int(r.0))|(tilt.stat7.2!=int(r.0))){
						gosub *undokakuho
						tilt.stat7.1=int(r.0)
						tilt.stat7.2=int(r.0)
						e=1:gosub *refreshtitle
					}
				}else{
					gosub *undokakuho
					for i,tiltnum,stat7-1,-1
						tilt.(i+1).0=tilt.i.0
						tilt.(i+1).1=tilt.i.1
						tilt.(i+1).2=tilt.i.2
					next
					tiltnum++
					tilt.stat7.0=cc
					if(r.0="7"){
						tilt.stat7.1=stat3_
						tilt.stat7.2=stat3_
					}else{
						tilt.stat7.1=int(r.0)
						tilt.stat7.2=int(r.0)
					}
					e=1:gosub *refreshtitle
				}
			}
			stat1=0
		}
		if((edittarget=TARGET_ROTATE)&(ctrl_key=1)){
			gosub *selinit
			sdim it,128,1
			dim t,1
			sdim r,128,1
			sdim opt,128,1
			i=0
			stat2_=0
			stat7=tiltnum
			stat1_="normal"
			repeat tiltnum
				if(tilt.cnt.0=cc){
					stat7=cnt
					stat2_=1
					stat1_=tiltname2_input(tilt.cnt.1,tilt.cnt.2)
					break
				}else:if(tilt.cnt.0>cc){
					stat7=cnt
					break
				}else:if(tilt.cnt.0<cc){
					stat1_=tiltname_input(tilt.cnt.2)
				}
			loop
			t.i=1 : it.i=lang.8.19/*"傾き[-100 - 100](または傾きｴﾌｪｸﾄの種類):"*/ : r.i=stat1_
			_input lang.8.18/*"傾きエフェクトの手動指定"*/,it,t,opt,r,1,0
			if(stat!=-1){
				val1=tiltval1(r.0)
				val2=tiltval2(r.0)
				if((val1!=-1)&(val2!=-1)&((r.0!=stat1_)|(val1>6)|(val2>6))){
					if(stat2_=1){
						if((tilt.stat7.1!=val1)|(tilt.stat7.2!=val2)){
							gosub *undokakuho
							tilt.stat7.1=val1
							tilt.stat7.2=val2
							e=1:gosub *refreshtitle
						}
					}else{
						gosub *undokakuho
						for i,tiltnum,stat7-1,-1
							tilt.(i+1).0=tilt.i.0
							tilt.(i+1).1=tilt.i.1
							tilt.(i+1).2=tilt.i.2
						next
						tiltnum++
						tilt.stat7.0=cc
						tilt.stat7.1=val1
						tilt.stat7.2=val2
						e=1:gosub *refreshtitle
					}
				}
			}
			stat1=0
		}
		if(((edittarget=TARGET_ANALOGPFILTER)&(ctrl_key=0)&(shift_key=0))){
			sdim it,128,1
			dim t,1
			sdim r,128,1
			sdim opt,128,1
			i=0
			stat1_="50"
			stat2_=0
			stat7=anagainnum
			repeat anagainnum
				if(anagain.cnt.0=cc){
					stat7=cnt
					stat2_=1
					stat1_=str(anagain.cnt.1)
					break
				}else:if(anagain.cnt.0>cc){
					stat7=cnt
					break
				}else{
					stat1_=str(anagain.cnt.1)
				}
			loop
			t.i=1 : it.i=lang.8.23/*"強さ[0-100]:"*/ : r.i=stat1_
			_input lang.8.22/*"LASER音声エフェクトの強さを変更"*/,it,t,opt,r,1,0
			if((int(r.0)<=100)&((r.0="0")|(int(r.0)>0))&(r.0!=stat1_)&(stat!=-1)){
				gosub *undokakuho
				if(stat2_=1){
					if(anagain.stat7.1!=int(r.0)){
						anagain.stat7.1=int(r.0)
						e=1:gosub *refreshtitle
					}
				}else{
					for i,anagainnum,stat7-1,-1
						anagain.(i+1).0=anagain.i.0
						anagain.(i+1).1=anagain.i.1
					next
					anagainnum++
					anagain.stat7.0=cc
					anagain.stat7.1=int(r.0)
					e=1:gosub *refreshtitle
				}
			}
		}else:if(((edittarget=TARGET_ANALOGPFILTER)&(ctrl_key=1)&(shift_key=0))){
			gosub *undokakuho
			sdim it,128,1
			dim t,1
			sdim r,128,1
			sdim opt,128,1
			i=0
			stat1_=0
			stat2_=0
			stat7=anafilnum
			repeat anafilnum
				if(anafil.cnt.0=cc){
					stat7=cnt
					stat2_=1
					//stat1_=anafil.cnt.1
					break
				}else:if(anafil.cnt.0>cc){
					stat7=cnt
					break
				}else{
					stat1_=anafil.cnt.1
				}
			loop
			if(stat2_=1){
				if(anafil.stat7.1=0){
					anafil.stat7.1=1
				}else:if(anafil.stat7.1=1){
					anafil.stat7.1=3
				}else:if(anafil.stat7.1=3){
					anafil.stat7.1=5
				}else:if((anafil.stat7.1=5)|(anafil.stat7.1=6)){
					if(userfilternum>0){
						anafil.stat7.1=100+userfxnum-userfilternum
					}else:anafil.stat7.1=0
				}else:if(anafil.stat7.1>=100){
					anafil.stat7.1++
					if(userfilternum<=anafil.stat7.1-(userfxnum-userfilternum)-100){
						anafil.stat7.1=0
					}
				}
				if((anafil.stat7.1=stat1_)&(stat7!=0)){
					ardel2 anafil,anafilnum,3,stat7
					anafilnum--
				}
				e=1:gosub *refreshtitle
			}else{
				for i,anafilnum,stat7-1,-1
					anafil.(i+1).0=anafil.i.0
					anafil.(i+1).1=anafil.i.1
				next
				anafilnum++
				anafil.stat7.0=cc
				if(stat1_=0){
					anafil.stat7.1=1
				}else:if(stat1_=1){
					anafil.stat7.1=3
				}else:if(stat1_=3){
					anafil.stat7.1=5
				}else:if((stat1_=5)|(stat1_=6)){
					if(userfilternum>0){
						anafil.stat7.1=100+userfxnum-userfilternum
					}else:anafil.stat7.1=0
				}else:if(stat1_>=100){
					anafil.stat7.1=stat1_+1
					if(userfilternum<=anafil.stat7.1-(userfxnum-userfilternum)-100){
						anafil.stat7.1=0
					}
				}
				e=1:gosub *refreshtitle
			}
		}
		if((edittarget=TARGET_ANALOGVOL)&(ctrl_key=1)&(shift_key=0)){
			gosub *undokakuho
			stat1=ansenum
			stat2=0
			stat3=0
			repeat ansenum
				if(anse.cnt.0=cc){
					stat1=cnt+1
					stat2=1
					stat3=anse.cnt.1
					break
				}
				if(anse.cnt.0>cc){
					stat1=cnt
					break
				}
			loop
			f=0
			if(stat2=1){
				ardel2 anse,ansenum,2,stat1-1
				ansenum--
				e=1:gosub *refreshtitle
				f=(stat3<4)
				stat1--
			}else{
				f=1
			}
			if(f=1){
				for i,ansenum,stat1-1,-1
					anse.(i+1).0=anse.i.0
					anse.(i+1).1=anse.i.1
				next
				anse.stat1.0=cc
				anse.stat1.1=stat3+1
				ansenum++
				e=1:gosub *refreshtitle
			}
		}
		if((edittarget=TARGET_ANALOGVOL)&(ctrl_key=0)&(shift_key=0)){
			sdim it,128,1
			dim t,1
			sdim r,128,1
			sdim opt,128,1
			i=0
			stat1_="50"
			stat2_=0
			stat7=anvolnum
			repeat anvolnum
				if(anvol.cnt.0=cc){
					stat7=cnt
					stat2_=1
					stat1_=str(anvol.cnt.1)
					break
				}else:if(anvol.cnt.0>cc){
					stat7=cnt
					break
				}else{
					stat1_=str(anvol.cnt.1)
				}
			loop
			t.i=1 : it.i=lang.8.31/*"Volume[0-100]:"*/ : r.i=stat1_
			_input lang.8.30/*"直角音ボリュームの変更"*/,it,t,opt,r,1,0
			if((int(r.0)<=100)&((r.0="0")|(int(r.0)>0))&(r.0!=stat1_)&(stat!=-1)){
				gosub *undokakuho
				if(stat2_=1){
					if(anvol.stat7.1!=int(r.0)){
						anvol.stat7.1=int(r.0)
						e=1:gosub *refreshtitle
					}
				}else{
					for i,anvolnum,stat7-1,-1
						anvol.(i+1).0=anvol.i.0
						anvol.(i+1).1=anvol.i.1
					next
					anvolnum++
					anvol.stat7.0=cc
					anvol.stat7.1=int(r.0)
					e=1:gosub *refreshtitle
				}
			}
		}
		if((edittarget=TARGET_ANALOGL)|(edittarget=TARGET_ANALOGR)){
			stat0=edittarget-TARGET_ANALOGL
			stat1=analognum
			stat2=0
			if((ctrl_key=1)&(shift_key=1)){
				f=0
				repeat analognum
					if((analog.cnt.1<=cc)&(analog.cnt.1+analog.cnt.2>cc)&(analog.cnt.0=stat0)){
						gosub *undokakuho
						if(analogparentran.(analogparent.cnt)=2){
							analogparentran.(analogparent.cnt)=0
							cnt2=cnt
							repeat ,analogparent.cnt2
								if(cnt>=analognum):break
								if(analog.cnt.0!=analog.cnt2.0):continue
								if(analogparent.cnt!=analogparent.cnt2):break
								analog.cnt.3=max(min(int(round((double(analog.cnt.3)-12.5f)*2))+(analog.cnt.3=37),50),0)
								analog.cnt.4=max(min(int(round((double(analog.cnt.4)-12.5f)*2))+(analog.cnt.4=37),50),0)
							loop
						}else{
							analogparentran.(analogparent.cnt)=2
							cnt2=cnt
							repeat ,analogparent.cnt2
								if(cnt>=analognum):break
								if(analog.cnt.0!=analog.cnt2.0):continue
								if(analogparent.cnt!=analogparent.cnt2):break
								analog.cnt.3=12+int(round(double(analog.cnt.3)/2))
								analog.cnt.4=12+int(round(double(analog.cnt.4)/2))
							loop
						}
						e=1:gosub *refreshtitle
						f=1
						break
					}
				loop
				if(f=1){
					gosub *draw
					return
				}
			}
			if((ctrl_key=0)&(shift_key=1)){
				f=0
				repeat analognum
					if((analog.cnt.1<=cc)&(analog.cnt.1+analog.cnt.2>cc)&(analog.cnt.0=stat0)){
						selanalog.0=cnt
						lastseltype=1
						lastsel=0
						selanalognum=1
						selshift=0
						f=1
					}
				loop
				if(f=1){
					gosub *draw
					return
				}
			}
			gosub *undokakuho
			repeat analognum
				if((analog.cnt.1=cc)&(analog.cnt.0=stat0)){
					cc=analog.cnt.1+analog.cnt.2
					capos=analog.cnt.4
					stat1=cnt+1
					if(analognum-cnt-1>0){
						stat2=0
						statpos=analog.cnt.1+analog.cnt.2
						stattype=analog.cnt.0
						repeat analognum-cnt-1,cnt+1
							if((analog.cnt.0=stattype)&(analog.cnt.1=statpos)){
								stat2=1
							}
							if((analog.cnt.0=stattype)&(analog.cnt.1+analog.cnt.2>statpos)):break
						loop
					}
					break
				}
				if(analog.cnt.1>cc){
					stat1=cnt
					break
				}
			loop
			if((stat2=1)|(stat1<0)){
				gosub *selinit
				gosub *draw
				return
			}
			f=-1
			f2=0
			f3=0
			f2_cnt=0
			repeat analognum
				if(analog.cnt.0=stat0){
					if(analog.cnt.1+analog.cnt.2=cc){
						f2=1
						if((analogparentran.(analogparent.cnt)=2)&(vsep>=72)){
							if(analogdetail=0){
								capos=anadetail1.(min(max(((mousex-6*(2+vzoomx)/2-(vsep/2-(41+9*2)/2*(vzoomx=0)-(41+9*2)*3/4*(vzoomx=1)))\(41+9*2+vsp))*(3-vzoomx)/3/2,0),50))
							}else{
								capos=((mousex-6*(2+vzoomx)/2-(vsep/2-(41+9*2)/2*(vzoomx=0)-(41+9*2)*3/4*(vzoomx=1)))\(41+9*2+vsp))*(3-vzoomx)/3/2
							}
						}else{
							if(analogdetail+(analogparentran.(analogparent.cnt)=2)=0){
								capos=((mousex-vsep/2)\(41+9*2+vsp))*(3-vzoomx)/3/5*5
							}else:if(analogdetail+(analogparentran.(analogparent.cnt)=2)=1){
								capos=anadetail1.(min(max(((mousex-vsep/2)\(41+9*2+vsp))*(3-vzoomx)/3*2/5*5/2,0),50))
							}else{
								capos=((mousex-vsep/2)\(41+9*2+vsp))*(3-vzoomx)/3
							}
						}
						capos=min(max(capos,0),50)
						if((analog.cnt.4!=capos)&((disableanmin=0)|(abs(analog.cnt.4-capos)*(1+(analogparentran.(analogparent.cnt)=2))>11))):f=analog.cnt.4
						f2_cnt=cnt
					}
					if((analog.cnt.1<=cc)&(cc<analog.cnt.1+analog.cnt.2)):f3=1
				}
			loop
			if((f2=0)&((capos!=12*((ctrl_key=1)&(shift_key=1))+stat0*50/(1+((ctrl_key=1)&(shift_key=1))))&((disableanmin=0)|(abs(12*((ctrl_key=1)&(shift_key=1)&(anaranadjpos=1))+stat0*50/(1+((ctrl_key=1)&(shift_key=1)&(anaranadjpos=1)))-capos)*(1+((ctrl_key=1)&(shift_key=1)))>11)))&(f3=0)&((shift_key=1)|(ctrl_key=0))){
				f=stat0*50
				if((ctrl_key=1)&(shift_key=1)&(anaranadjpos=1)):f=12+f/2
			}
			if((shift_key=1)&(ctrl_key=0)):f=-1:f2=0:f3=0
			if(f=-1){
				shiftfl=0
				if((shift_key=1)&(ctrl_key=0)){
					ccp=cc
					caposp=capos
					fstat=0
					if(analognum>=32){
						repeat 15,1
							if(analog.(analognum-analognum/16*cnt-1).1+analog.(analognum-analognum/16*cnt-1).2>ccp){
								fstat=cnt
							}
						loop
					}
					repeat max(analognum-fstat*(analognum/16),0),fstat*(analognum/16)
						if(analog.(analognum-cnt-1).0=stat0){
							if(analog.(analognum-cnt-1).1+analog.(analognum-cnt-1).2<=ccp){
								cc=analog.(analognum-cnt-1).1+analog.(analognum-cnt-1).2
								capos=analog.(analognum-cnt-1).4
								shiftfl=1
								stat1=analognum
								break
							}
						}
					loop
					fstat=0
					if(analognum>=32){
						repeat 15,1
							if(analog.(analognum-analognum/16*cnt-1).1>cc){
								fstat=cnt
							}
						loop
					}
					repeat max(analognum-fstat*(analognum/16),0),fstat*(analognum/16)
						if(analog.(analognum-cnt-1).1<=cc){
							stat1=(analognum-cnt-1)+1
							break
						}
					loop
				}else:if(stat1>0){
					if((analog.(stat1-1).0=stat0)&(analog.(stat1-1).1+analog.(stat1-1).2=cc)){
						capos=analog.(stat1-1).4
					}
				}
				if(shiftfl=1){
					if((analogparentran.(analogparent.(stat1-1))=0)&((mousex<vsep/2)|(mousex-vsep/2)\(41+9*2+vsp)>41+9*2)&((ctrl_key=0)|(shift_key=0)|(vsep<72))){
						gosub *draw
						return
					}
				}
				for i,analognum,stat1-1,-1
					analog.(i+1).0=analog.i.0
					analog.(i+1).1=analog.i.1
					analog.(i+1).2=analog.i.2
					analog.(i+1).3=analog.i.3
					analog.(i+1).4=analog.i.4
					analog.(i+1).5=analog.i.5
					analogparentran.(i+1)=analogparentran.i
				next
				analog.stat1.0=stat0
				analog.stat1.1=cc
				analog.stat1.2=max(max(ccp-cc,cc/(UNIT_MEASURE/editdiv)*(UNIT_MEASURE/editdiv)+(UNIT_MEASURE/editdiv)-cc),UNIT_MEASURE/32)
				analog.stat1.3=capos
				analog.stat1.4=caposp
				analog.stat1.5=1-shiftfl
				analogparentran.stat1=((ctrl_key=1)&(shift_key=1))*2
			}else{
				ifstat=(editdiv<=16)&((analog.(max(stat1-1,0)).0!=stat0)|(analog.(max(stat1-1,0)).1+analog.(max(stat1-1,0)).2!=cc)|(analog.(max(stat1-1,0)).2>UNIT_MEASURE/32)|(stat1<=0)|(disableanan=0))
				for i,analognum,stat1-1,-1
					analog.(i+1+ifstat).0=analog.i.0
					analog.(i+1+ifstat).1=analog.i.1
					analog.(i+1+ifstat).2=analog.i.2
					analog.(i+1+ifstat).3=analog.i.3
					analog.(i+1+ifstat).4=analog.i.4
					analog.(i+1+ifstat).5=analog.i.5
					analogparentran.(i+1+ifstat)=analogparentran.i
				next
				if(ifstat=1){
					analog.stat1.0=stat0
					analog.stat1.1=cc
					analog.stat1.2=(UNIT_MEASURE/editdiv)*(editdiv>16)+(UNIT_MEASURE/32)*(editdiv<=16)
					analog.stat1.3=f
					analog.stat1.4=capos
					analog.stat1.5=1-f2
					analogparentran.stat1=((ctrl_key=1)&(shift_key=1))*2
					stat1++:analognum++
					cc+=UNIT_MEASURE/32
				}else:if(stat1>0){
					if((analog.(stat1-1).0=stat0)&(analog.(stat1-1).1+analog.(stat1-1).2=cc)){
						capos=analog.(stat1-1).4
					}
				}
				analog.stat1.0=stat0
				analog.stat1.1=cc
				analog.stat1.2=UNIT_MEASURE/editdiv+(UNIT_MEASURE/32)//*(editdiv<=16)
				analog.stat1.3=capos
				analog.stat1.4=capos
				analog.stat1.5=(editdiv>16)
				analogparentran.stat1=(editdiv>16)*((ctrl_key=1)&(shift_key=1))*2
			}
			f2=f
			enowstat=1
			enowl=stat1
			selanalog.0=stat1
			selanalognum=1
			selshift=0
			lastseltype=1
			lastsel=0
			analognum++
			gsel 0
			oncmd gosub *OnClick2, 0x0202
			ctrl_key2=ctrl_key
			shift_key2=shift_key
			stat1=0
			stat2=0
			repeat analognum
				if(analog.cnt.5=1){
					if(analog.cnt.0=0):stat1=cnt
					if(analog.cnt.0=1):stat2=cnt
				}else:analogparentran.cnt=0
				if(analog.cnt.0=0):analogparent.cnt=stat1
				if(analog.cnt.0=1):analogparent.cnt=stat2
			loop
			repeat
				stat1=enowl
				//cc2=(posnow+(mousex-vsep/2)/(41+9*2+vsp))*vtate*UNIT_MEASURE+(-10+topsep+vUNIT_MEASURE*vtate-mousey)/vUNIT_MEASURE*UNIT_MEASURE+(((-10+topsep+vUNIT_MEASURE*vtate-mousey)\vUNIT_MEASURE)/(vUNIT_MEASURE/editdiv)+1)*UNIT_MEASURE/editdiv
				// 以下はvUNIT_MEASUREがUNIT_MEASUREと同じことを想定した計算なので注意
				cc2=(posnow+mousex/(41+9*2+vsp))*vtate*UNIT_MEASURE+(-10+topsep+vUNIT_MEASURE*vtate-mousey)
				cc2*=10:cc2/=vzoom(10)
				cc2_=b2c(c2b(cc2))
				cc2=cc2_+((cc2-cc2_)/(UNIT_MEASURE/editdiv)+1)*(UNIT_MEASURE/editdiv)
				if((analogparentran.(analogparent.stat1)=2)&(vsep>=72)){
					if(analogdetail3=0){
						capos2=((mousex-6*(2+vzoomx)/2-(vsep/2-(41+9*2)/2*(vzoomx=0)-(41+9*2)*3/4*(vzoomx=1)))\(41+9*2+vsp))*(3-vzoomx)/3/2/5*5
					}else:if(analogdetail3=1){
						capos2=anadetail1.(min(max(((mousex-6*(2+vzoomx)/2-(vsep/2-(41+9*2)/2*(vzoomx=0)-(41+9*2)*3/4*(vzoomx=1)))\(41+9*2+vsp))*(3-vzoomx)/3/2,0),50))
					}else{
						capos2=((mousex-6*(2+vzoomx)/2-(vsep/2-(41+9*2)/2*(vzoomx=0)-(41+9*2)*3/4*(vzoomx=1)))\(41+9*2+vsp))*(3-vzoomx)/3/2
					}
					if(((mousex-6*(2+vzoomx)/2-(vsep/2-(41+9*2)/2*(vzoomx=0)-(41+9*2)*3/4*(vzoomx=1)))\(41+9*2+vsp))*(3-vzoomx)/3/2>=60+3*vzoomx):capos2=0
				}else{
					if(analogdetail3=0){
						capos2=((mousex-2*(2+vzoomx)/2-vsep/2)\(41+9*2+vsp))*(3-vzoomx)/3/5*5
					}else:if(analogdetail3=1){
						capos2=anadetail1.(min(max(((mousex-2*(2+vzoomx)/2-vsep/2)\(41+9*2+vsp))*(3-vzoomx)/3,0),50))
					}else{
						capos2=((mousex-2*(2+vzoomx)/2-vsep/2)\(41+9*2+vsp))*(3-vzoomx)/3
					}
					if(((mousex-2*(2+vzoomx)/2-vsep/2)\(41+9*2+vsp))*(3-vzoomx)/3>=(59-5*vzoomx)*(vsep=7)+(67-7*vzoomx)*(vsep=24)+91*(vsep=72)):capos2=0
				}
				capos2=min(max(capos2,0),50)
				if((shift_key2=0)&(ctrl_key2=1)){
					analog.stat1.1=cc
					analog.stat1.2=max(cc2-cc,UNIT_MEASURE/32)
					analog.stat1.4=capos2
				}else:if(cc2-cc<0){
					/*analog.stat1.1=cc2
					analog.stat1.2=cc-cc2*/
					analog.stat1.1=cc
					analog.stat1.2=UNIT_MEASURE/editdiv*(f2=-1)
					analog.stat1.4=capos2
				}else:if((cc2-cc<=UNIT_MEASURE/32)&(editdiv=16)&(disableanan=1)){
					/*analog.stat1.1=cc2
					analog.stat1.2=cc-cc2*/
					analog.stat1.1=cc
					analog.stat1.2=0//max(cc2-cc,cc/(UNIT_MEASURE/editdiv)*(UNIT_MEASURE/editdiv)+(UNIT_MEASURE/editdiv)-cc)
					//UNIT_MEASURE/editdiv*(f2=-1)
					analog.stat1.4=capos2
				}else{
					analog.stat1.1=cc
					analog.stat1.2=max(cc2-cc,UNIT_MEASURE/32)
					analog.stat1.4=capos2
				}
				if(((shift_key2=1)|(ctrl_key2=0))&(cc=cc2)):analog.stat1.2=UNIT_MEASURE/editdiv*(f2=-1)
				st1=enowl
				getkey stat2,1
				if(stat2=0):break
				if(enowstat=2):break
				gosub *draw
				await 0
			loop
			e=1:gosub *refreshtitle
			stat3=((shift_key2=1)&(ctrl_key2=0))
			f3=0
			if((stat2=0)&(st1>=0)){
				if(analog.st1.2=0){
					repeat max(analognum-st1,0),st1
						if(cnt<0):break
						cnt2=cnt
						repeat 6
							analog.cnt2.cnt=analog.(cnt2+1).cnt
						loop
						analogparentran.cnt2=analogparentran.(cnt2+1)
					loop
					analognum--
					if(analognum<0):analognum=0
					stat2=1
					st1--
					selanalog.0=st1
					selanalognum=1
					selshift=0
					lastseltype=1
					f3=1
					if(st1>=0){
						repeat analognum
							if((analog.st1.1<analog.cnt.1)&(analog.st1.1+analog.st1.2>=analog.cnt.1)&(analog.cnt.0=analog.st1.0)&(cnt!=st1)){
								analog.st1.2=analog.cnt.1-analog.st1.1
								analog.st1.4=analog.cnt.3
								analog.cnt.5=0
								break
							}
						loop
					}
				}else:if(st1>=0){
					if(f3=0){
						if(f2!=-1){
							//st1--
							if(st1>=0){
								repeat analognum
									if((analog.st1.1<analog.cnt.1)&(analog.st1.1+analog.st1.2>=analog.cnt.1)&(analog.cnt.0=analog.st1.0)&(cnt!=st1)){
										analog.st1.2=analog.cnt.1-analog.st1.1
										analog.st1.4=analog.cnt.3
										analog.cnt.5=0
										break
									}
								loop
							}
							//st1++
						}
						repeat analognum
							if((analog.st1.1>=analog.cnt.1)&(analog.st1.1+analog.st1.2<=analog.cnt.1+analog.cnt.2)&(cnt!=st1)&(analog.cnt.0=analog.st1.0)){
								if(st1<analognum){
									if(analogparent.(st1+1)=st1){
										analogparentran.(st1+1)=analogparentran.st1
									}
								}
								repeat max(analognum-st1-1,0),st1
									cnt2=cnt
									if(cnt2+1>length(analog)):break
									repeat 6
										analog.cnt2.cnt=analog.(cnt2+1).cnt
									loop
									analogparentran.cnt2=analogparentran.(cnt2+1)
								loop
								analognum--
								stat2=1
								break
							}
						loop
						if(stat2=0){
							stat5=0
							// [ ( ) ]
							repeat analognum
								if((analog.st1.1<analog.cnt.1)&(analog.st1.1+analog.st1.2>=analog.cnt.1)&(analog.cnt.0=analog.st1.0)&(cnt!=st1)){
									analog.st1.2=analog.cnt.1-analog.st1.1
									analog.st1.4=analog.cnt.3
									if(analognum>1){
										repeat max(analognum-st1-1,0),st1+1
											if(analog.cnt.0=stat0){
												//if(analog.cnt.5=0):stat5=1
												break
											}
										loop
									}
									break
								}
							loop
							if(stat5=1){
								if(st1<analognum){
									if(analogparent.(st1+1)=st1){
										analogparentran.(st1+1)=analogparentran.st1
									}
								}
								repeat max(analognum-st1-1,0),st1
									cnt2=cnt
									repeat 6
										analog.cnt2.cnt=analog.(cnt2+1).cnt
									loop
									analogparentran.cnt2=analogparentran.(cnt2+1)
								loop
								analognum--
								gosub *selinit
							}else{
								// ( [ ) ]
								repeat analognum
									if(((analog.st1.1<=analog.cnt.1+analog.cnt.2)|(stat3=1))&(analog.st1.1+analog.st1.2>analog.cnt.1+analog.cnt.2)&(analog.cnt.0=analog.st1.0)&(cnt!=st1)){
										analog.st1.2=analog.st1.1+analog.st1.2-analog.cnt.1-analog.cnt.2
										analog.st1.1=analog.cnt.1+analog.cnt.2
										analog.st1.3=analog.cnt.4
										stat3=0
									}
								loop
								repeat analognum
									if((analog.st1.1=analog.cnt.1+analog.cnt.2)&(analog.cnt.0=analog.st1.0)):analog.st1.5=0
								loop
								repeat analognum
									if((analog.cnt.1=analog.st1.1+analog.st1.2)&(analog.cnt.0=analog.st1.0)):analog.cnt.5=0
								loop
								if((analog.st1.3!=12*((ctrl_key=1)&(shift_key=1)&(anaranadjpos=1))+stat0*50/(1+((ctrl_key=1)&(shift_key=1)&(anaranadjpos=1))))&(analog.st1.5=1)&((shift_key=1)|(ctrl_key=0))):analog.st1.3=12*((ctrl_key=1)&(shift_key=1)&(anaranadjpos=1))+stat0*50/(1+((ctrl_key=1)&(shift_key=1)&(anaranadjpos=1)))
							}
						}
					}
				}
			}
			enowstat=0
		}
		if((edittarget=TARGET_SPIN)&(ctrl_key+alt_key=0)){
			gosub *undokakuho
			stat1=spinnum
			stat2=0
			repeat spinnum
				if((spin.cnt.1=cc)&(spin.cnt.0=cbtn)){
					stat2=1
					break
				}
				if(spin.cnt.1>cc){
					stat1=cnt
					break
				}
			loop
			if(stat2=1){
				gosub *selinit
				gosub *draw
				return
			}
			for i,spinnum,stat1-1,-1
				spin.(i+1).0=spin.i.0
				spin.(i+1).1=spin.i.1
				spin.(i+1).2=spin.i.2
				spin.(i+1).3=spin.i.3
				spin.(i+1).4=spin.i.4
				spin.(i+1).5=spin.i.5
			next
			spin.stat1.0=clbtn-4+((shift_key=1)&(ctrl_key=0))*2
			spin.stat1.1=cc
			spin.stat1.2=UNIT_MEASURE
			spin.stat1.3=150 //揺れ幅
			spin.stat1.4=3 //回数 (片道+1 往復+2)
			spin.stat1.5=2 //減衰の有無 (0:なし 1:あり(遅) 2:あり)
			selspin.0=stat1
			selspinnum=1
			lastseltype=2
			lastsel=0
			spinnum++
			e=1:gosub *refreshtitle
		}
		if((edittarget=TARGET_SPIN)&(ctrl_key=1)&(alt_key+shift_key=0)){
			gosub *undokakuho
			repeat spinnum
				if((spin.cnt.1<=cc)&(spin.cnt.1+spin.cnt.2>cc)){
					if(spin.cnt.0<4){
						spin.cnt.0+=2
					}else{
						spin.cnt.0=spin.cnt.0\2
					}
					spin.cnt.3=150 //揺れ幅
					spin.cnt.4=3 //回数 (片道+1 往復+2)
					spin.cnt.5=2 //減衰の有無 (0:なし 1:あり(遅) 2:あり)
					e=1:gosub *refreshtitle
				}
			loop
		}
		if((edittarget=TARGET_SPIN)&(ctrl_key+shift_key=2)&(alt_key=0)){
			repeat spinnum
				if((spin.cnt.1<=cc)&(spin.cnt.1+spin.cnt.2>cc)&(spin.cnt.0/2=2)){
					sdim it,128,3
					dim t,3
					sdim r,128,3
					sdim opt,128,3
					i=0
					stat1_=""+spin.cnt.4
					stat2_=0
					t.i=1 : it.i=lang.8.61/*"振動の幅[0-](標準:150):"*/ : r.i=""+spin.cnt.3 : i++
					t.i=1 : it.i=lang.8.62/*"振動の回数[1-](片側につき+1):"*/ : r.i=""+spin.cnt.4 : i++
					t.i=1 : it.i=lang.8.63/*"振動の減衰:"*/ : r.i=""+spin.cnt.5
					opt.i=lang.8.64+"\n"+lang.8.65+"\n"+lang.8.66
					_input lang.8.60/*"ばねエフェクトの設定"*/,it,t,opt,r,1,0
					if(stat!=-1){
						gosub *undokakuho
						spin.cnt.3=min(max(int(r.0),0),65535)
						spin.cnt.4=min(max(int(r.1),1),65535)
						spin.cnt.5=min(max(int(r.2),0),2)
					}
					break
				}
			loop
		}
		if(((edittarget=TARGET_ZOOMTOP)&(ctrl_key=0)&(shift_key=0))){
			sdim it,128,1
			dim t,1
			sdim r,128,1
			sdim opt,128,1
			i=0
			stat1_="0"
			if(ztopnum>=1):stat1_=""+ztop.0.1
			stat2_=0
			stat7=ztopnum
			repeat ztopnum
				if(ztop.cnt.0=cc){
					stat7=cnt
					stat2_=1
					if(ztop.cnt.1!=ztop.cnt.2){
						stat1_=str(ztop.cnt.1)+";"+str(ztop.cnt.2)
					}else:stat1_=str(ztop.cnt.1)
					break
				}else:if(ztop.cnt.0>cc){
					stat7=cnt
					break
				}else{
					stat1_=str(ztop.cnt.2)
				}
			loop
			t.i=1 : it.i=lang.8.71/*"拡大の度合い[-150 - 150]:"*/ : r.i=stat1_
			_input lang.8.70/*"レーン拡大の挿入"*/,it,t,opt,r,1,0
			if(stat!=-1){
				sdim splitstat,64,1
				split r.0,";",splitstat
				if(stat=1):splitstat.1=splitstat.0
				if((int(splitstat.0)<=65535)&(int(splitstat.0)>=-65535)&(int(splitstat.1)<=65535)&(int(splitstat.1)>=-65535)&((splitstat.0="0")|(abs(int(splitstat.0))>0))&((splitstat.1="0")|(abs(int(splitstat.1))>0))&((stat2_=0)|(r.0!=stat1_))){
					gosub *undokakuho
					if(stat2_=1){
						if((ztop.stat7.1!=int(splitstat.0))|(ztop.stat7.2!=int(splitstat.1))){
							ztop.stat7.1=int(splitstat.0)
							ztop.stat7.2=int(splitstat.1)
							e=1:gosub *refreshtitle
						}
					}else{
						for i,ztopnum,stat7-1,-1
							ztop.(i+1).0=ztop.i.0
							ztop.(i+1).1=ztop.i.1
							ztop.(i+1).2=ztop.i.2
						next
						ztopnum++
						ztop.stat7.0=cc
						ztop.stat7.1=int(splitstat.0)
						ztop.stat7.2=int(splitstat.1)
						e=1:gosub *refreshtitle
					}
				}
			}
		}
		if(((edittarget=TARGET_ZOOMBOTTOM)&(ctrl_key=0)&(shift_key=0))){
			sdim it,128,1
			dim t,1
			sdim r,128,1
			sdim opt,128,1
			i=0
			stat1_="0"
			if(zbotnum>=1):stat1_=""+zbot.0.1
			stat2_=0
			stat7=zbotnum
			repeat zbotnum
				if(zbot.cnt.0=cc){
					stat7=cnt
					stat2_=1
					if(zbot.cnt.1!=zbot.cnt.2){
						stat1_=str(zbot.cnt.1)+";"+str(zbot.cnt.2)
					}else:stat1_=str(zbot.cnt.1)
					break
				}else:if(zbot.cnt.0>cc){
					stat7=cnt
					break
				}else{
					stat1_=str(zbot.cnt.2)
				}
			loop
			t.i=1 : it.i=lang.8.71/*"拡大の度合い[-100 - 100]:"*/ : r.i=stat1_
			_input lang.8.70/*"レーン拡大の挿入"*/,it,t,opt,r,1,0
			if(stat!=-1){
				sdim splitstat,64,1
				split r.0,";",splitstat
				if(stat=1):splitstat.1=splitstat.0
				if((int(splitstat.0)<=65535)&(int(splitstat.0)>=-65535)&(int(splitstat.1)<=65535)&(int(splitstat.1)>=-65535)&((splitstat.0="0")|(abs(int(splitstat.0))>0))&((splitstat.1="0")|(abs(int(splitstat.1))>0))&((stat2_=0)|(r.0!=stat1_))){
					gosub *undokakuho
					if(stat2_=1){
						if((zbot.stat7.1!=int(splitstat.0))|(zbot.stat7.2!=int(splitstat.1))){
							zbot.stat7.1=int(splitstat.0)
							zbot.stat7.2=int(splitstat.1)
							e=1:gosub *refreshtitle
						}
					}else{
						for i,zbotnum,stat7-1,-1
							zbot.(i+1).0=zbot.i.0
							zbot.(i+1).1=zbot.i.1
							zbot.(i+1).2=zbot.i.2
						next
						zbotnum++
						zbot.stat7.0=cc
						zbot.stat7.1=int(splitstat.0)
						zbot.stat7.2=int(splitstat.1)
						e=1:gosub *refreshtitle
					}
				}
			}
		}
		if(((edittarget=TARGET_ZOOMSIDE)&(ctrl_key=0)&(shift_key=0))){
			sdim it,128,1
			dim t,1
			sdim r,128,1
			sdim opt,128,1
			i=0
			stat1_="0"
			if(zsidenum>=1):stat1_=""+zside.0.1
			stat2_=0
			stat7=zsidenum
			repeat zsidenum
				if(zside.cnt.0=cc){
					stat7=cnt
					stat2_=1
					if(zside.cnt.1!=zside.cnt.2){
						stat1_=str(zside.cnt.1)+";"+str(zside.cnt.2)
					}else:stat1_=str(zside.cnt.1)
					break
				}else:if(zside.cnt.0>cc){
					stat7=cnt
					break
				}else{
					stat1_=str(zside.cnt.2)
				}
			loop
			t.i=1 : it.i=lang.8.71/*"拡大の度合い[-150 - 150]:"*/ : r.i=stat1_
			_input lang.8.70/*"レーン拡大の挿入"*/,it,t,opt,r,1,0
			if(stat!=-1){
				sdim splitstat,64,1
				split r.0,";",splitstat
				if(stat=1):splitstat.1=splitstat.0
				if((int(splitstat.0)<=65535)&(int(splitstat.0)>=-65535)&(int(splitstat.1)<=65535)&(int(splitstat.1)>=-65535)&((splitstat.0="0")|(abs(int(splitstat.0))>0))&((splitstat.1="0")|(abs(int(splitstat.1))>0))&((stat2_=0)|(r.0!=stat1_))){
					gosub *undokakuho
					if(stat2_=1){
						if((zside.stat7.1!=int(splitstat.0))|(zside.stat7.2!=int(splitstat.1))){
							zside.stat7.1=int(splitstat.0)
							zside.stat7.2=int(splitstat.1)
							e=1:gosub *refreshtitle
						}
					}else{
						for i,zsidenum,stat7-1,-1
							zside.(i+1).0=zside.i.0
							zside.(i+1).1=zside.i.1
							zside.(i+1).2=zside.i.2
						next
						zsidenum++
						zside.stat7.0=cc
						zside.stat7.1=int(splitstat.0)
						zside.stat7.2=int(splitstat.1)
						e=1:gosub *refreshtitle
					}
				}
			}
		}
		gosub *draw
	}
	// 消しゴムツール
	if(((iparam=3)&(editmode=MODE_PENCIL))|((iparam=0)&(editmode=MODE_ERASE))){
		if((edittarget=TARGET_POS)&(ctrl_key=1)&(shift_key=0)){
			if((beatlnum>1)&(cc!=0)){
				repeat beatlnum-1,1
					if(beatl.cnt.0=cc){
						gosub *undokakuho
						repeat beatlnum-cnt-1,cnt+1
							beatl.(cnt-1).0=beatl.cnt.0
							beatl.(cnt-1).1=beatl.cnt.1
							beatl.(cnt-1).2=beatl.cnt.2
						loop
						beatlnum--
						e=1:gosub *refreshtitle
						gosub *selinit
					}
				loop
			}
		}else:if((edittarget=TARGET_POS)&(ctrl_key=1)&(shift_key=1)){
			repeat commentnum
				if((comment.cnt=cc)&(StartsWith(commentstr.cnt, "//"))){
					gosub *undokakuho
					ardel comment,commentnum,cnt
					ardel commentstr,commentnum,cnt
					commentnum--
					e=1:gosub *refreshtitle
					gosub *selinit
				}
			loop
		}else:if(edittarget=TARGET_POS){
			if((bpmlnum>1)&(cc!=0)){
				repeat bpmlnum-1,1
					if(bpml.cnt.0=cc){
						gosub *undokakuho
						repeat bpmlnum-cnt-1,cnt+1
							bpml.(cnt-1).0=bpml.cnt.0
							bpml.(cnt-1).1=bpml.cnt.1
						loop
						bpmlnum--
						e=1:gosub *refreshtitle
						gosub *selinit
					}
				loop
			}
		}
		if(edittarget=TARGET_NOTE){
			fl=0
			g=0
			repeat notenum
				f=(note.(cnt-g).1=cc)
				if(shift_key=1):f=f|((note.(cnt-g).1>=cc)&(note.(cnt-g).1<cc+UNIT_MEASURE/editdiv))
				if((f=1)&(note.(cnt-g).0=cbtn)&(note.(cnt-g).2=0)){
					if(fl=0):gosub *undokakuho
					fl=1
					repeat notenum-(cnt-g)-1,(cnt-g)+1
						note.(cnt-1).0=note.cnt.0
						note.(cnt-1).1=note.cnt.1
						note.(cnt-1).2=note.cnt.2
						note.(cnt-1).3=note.cnt.3
						note.(cnt-1).4=note.cnt.4
						note.(cnt-1).5=note.cnt.5
						notesefname.(cnt-1)=notesefname.cnt
					loop
					notenum--
					g++
					gosub *selinit
				}
				if(fl=1):e=1:gosub *refreshtitle
			loop
		}
		if((edittarget=TARGET_NOTE2)){
			fl=0
			g=0
			repeat notenum
				f=((note.(cnt-g).1<=cc)&(note.(cnt-g).1+note.(cnt-g).2>cc))
				if(shift_key=1):f=f|((note.(cnt-g).1>=cc)&(note.(cnt-g).1<cc+UNIT_MEASURE/editdiv))
				if((f=1)&(note.(cnt-g).0=cbtn)&(note.(cnt-g).2>0)){
					if(fl=0):gosub *undokakuho
					fl=1
					repeat notenum-(cnt-g)-1,(cnt-g)+1
						if(cnt<1):continue
						if(cnt>=notenum):continue
						note.(cnt-1).0=note.cnt.0
						note.(cnt-1).1=note.cnt.1
						note.(cnt-1).2=note.cnt.2
						note.(cnt-1).3=note.cnt.3
						note.(cnt-1).4=note.cnt.4
						note.(cnt-1).5=note.cnt.5
						notesefname.(cnt-1)=notesefname.cnt
					loop
					notenum--
					g++
					gosub *selinit
				}
			loop
			if(fl=1):e=1:gosub *refreshtitle
		}
		if((edittarget=TARGET_LNOTE)&(ctrl_key=1)&(shift_key=0)&(editmode=MODE_PENCIL)){
			repeat notenum
				if((note.cnt.1<=cc)&(note.cnt.1+note.cnt.2>cc)&(note.cnt.0=clbtn)&(note.cnt.2>0)){
					notefxminus cnt
					break
				}
			loop
		}else:if((edittarget=TARGET_LNOTE)&(ctrl_key=1)&(shift_key=1)&(editmode=MODE_PENCIL)){
			repeat notenum
				if((note.cnt.1<=cc)&(note.cnt.1+note.cnt.2>cc)&(note.cnt.0=clbtn)&(note.cnt.2>0)){
					gosub *undokakuho
					note.cnt.3=9
					note.cnt.4=16
					note.cnt.5=0
					e=1:gosub *refreshtitle
					break
				}
			loop
		}else:if((edittarget=TARGET_LNOTE)&(shift_key=0)){
			fl=0
			g=0
			repeat notenum
				f=((note.(cnt-g).1<=cc)&(note.(cnt-g).1+note.(cnt-g).2>cc))
				if(shift_key=1):f=f|((note.(cnt-g).1>=cc)&(note.(cnt-g).1<cc+UNIT_MEASURE/editdiv))
				if((f=1)&(note.(cnt-g).0=clbtn)&(note.(cnt-g).2>0)){
					if(fl=0):gosub *undokakuho
					fl=1
					repeat notenum-(cnt-g)-1,(cnt-g)+1
						if(cnt<1):continue
						if(cnt>=notenum):continue
						note.(cnt-1).0=note.cnt.0
						note.(cnt-1).1=note.cnt.1
						note.(cnt-1).2=note.cnt.2
						note.(cnt-1).3=note.cnt.3
						note.(cnt-1).4=note.cnt.4
						note.(cnt-1).5=note.cnt.5
						notesefname.(cnt-1)=notesefname.cnt
					loop
					notenum--
					g++
					gosub *selinit
					break
				}
			loop
			if(fl=1):e=1:gosub *refreshtitle
		}
		if(edittarget=TARGET_LNOTE2){
			fl=0
			g=0
			repeat notenum
				f=(note.(cnt-g).1=cc)
				if(shift_key=1):f=f|((note.(cnt-g).1>=cc)&(note.(cnt-g).1<cc+UNIT_MEASURE/editdiv))
				if((f=1)&(note.(cnt-g).0=clbtn)&(note.(cnt-g).2=0)){
					if(fl=0):gosub *undokakuho
					fl=1
					repeat notenum-(cnt-g)-1,(cnt-g)+1
						note.(cnt-1).0=note.cnt.0
						note.(cnt-1).1=note.cnt.1
						note.(cnt-1).2=note.cnt.2
						note.(cnt-1).3=note.cnt.3
						note.(cnt-1).4=note.cnt.4
						note.(cnt-1).5=note.cnt.5
						notesefname.(cnt-1)=notesefname.cnt
					loop
					notenum--
					g++
					gosub *selinit
				}
			loop
			if(fl=1):e=1:gosub *refreshtitle
		}
		if((edittarget=TARGET_ROTATE)&(ctrl_key=0)&(shift_key=0)){
			repeat tiltnum,0
				if(tilt.cnt.0=cc){
					gosub *undokakuho
					repeat tiltnum-cnt-1,cnt+1
						tilt.(cnt-1).0=tilt.cnt.0
						tilt.(cnt-1).1=tilt.cnt.1
						tilt.(cnt-1).2=tilt.cnt.2
					loop
					tiltnum--
					e=1:gosub *refreshtitle
					gosub *selinit
				}
			loop
		}
		if((edittarget=TARGET_STOP)&(ctrl_key=0)&(shift_key=0)){
			repeat stpnum
				if((stp.cnt.0<=cc)&(stp.cnt.0+stp.cnt.1>cc)){
					gosub *undokakuho
					repeat stpnum-cnt-1,cnt+1
						if(cnt<1):continue
						if(cnt>=stpnum):continue
						stp.(cnt-1).0=stp.cnt.0
						stp.(cnt-1).1=stp.cnt.1
					loop
					stpnum--
					e=1:gosub *refreshtitle
					gosub *selinit
				}
			loop
		}
		if((edittarget=TARGET_ANALOGPFILTER)&(ctrl_key=0)&(shift_key=0)){
			if((anagainnum>1)&(cc!=0)){
				repeat anagainnum-1,1
					if(anagain.cnt.0=cc){
						gosub *undokakuho
						repeat anagainnum-cnt-1,cnt+1
							anagain.(cnt-1).0=anagain.cnt.0
							anagain.(cnt-1).1=anagain.cnt.1
						loop
						anagainnum--
						e=1:gosub *refreshtitle
						gosub *selinit
					}
				loop
			}
		}else:if((edittarget=TARGET_ANALOGPFILTER)&(ctrl_key=1)&(shift_key=0)){
			if((anafilnum>1)&(cc!=0)){
				repeat anafilnum-1,1
					if(anafil.cnt.0=cc){
						gosub *undokakuho
						repeat anafilnum-cnt-1,cnt+1
							anafil.(cnt-1).0=anafil.cnt.0
							anafil.(cnt-1).1=anafil.cnt.1
						loop
						anafilnum--
						e=1:gosub *refreshtitle
						gosub *selinit
					}
				loop
			}
		}
		if((edittarget=TARGET_ANALOGVOL)&(ctrl_key=1)&(shift_key=0)){
			if(ansenum>0){
				repeat ansenum,0
					if(anse.cnt.0=cc){
						gosub *undokakuho
						repeat ansenum-cnt-1,cnt+1
							anse.(cnt-1).0=anse.cnt.0
							anse.(cnt-1).1=anse.cnt.1
						loop
						ansenum--
						e=1:gosub *refreshtitle
						gosub *selinit
					}
				loop
			}
		}
		if((edittarget=TARGET_ANALOGVOL)&(ctrl_key=0)&(shift_key=0)){
			if((anvolnum>1)&(cc!=0)){
				repeat anvolnum-1,1
					if(anvol.cnt.0=cc){
						gosub *undokakuho
						repeat anvolnum-cnt-1,cnt+1
							anvol.(cnt-1).0=anvol.cnt.0
							anvol.(cnt-1).1=anvol.cnt.1
						loop
						anvolnum--
						e=1:gosub *refreshtitle
						gosub *selinit
					}
				loop
			}
		}
		if((edittarget=TARGET_ANALOGL)|(edittarget=TARGET_ANALOGR)){
			stat0=edittarget-TARGET_ANALOGL
			if((ctrl_key=1)&(shift_key=1)){
				f=0
				repeat analognum
					if((analog.cnt.1<=cc)&(analog.cnt.1+analog.cnt.2>cc)&(analog.cnt.0=stat0)){
						gosub *undokakuho
						if(analogparentran.(analogparent.cnt)=2){
							analogparentran.(analogparent.cnt)=0
							if(anaranadjpos=1){
								if(analog.cnt.0=0){
									if(analog.(analogparent.cnt).3=12){
										analog.(analogparent.cnt).3=0
									}
								}else{
									if(analog.(analogparent.cnt).3=37){
										analog.(analogparent.cnt).3=50
									}
								}
							}
						}else{
							analogparentran.(analogparent.cnt)=2
							if(anaranadjpos=1){
								if(analog.cnt.0=0){
									if(analog.(analogparent.cnt).3=0){
										analog.(analogparent.cnt).3=12
									}
								}else{
									if(analog.(analogparent.cnt).3=50){
										analog.(analogparent.cnt).3=37
									}
								}
							}
						}
						e=1:gosub *refreshtitle
						f=1
						break
					}
				loop
				if(f=1){
					gosub *draw
					return
				}
			}
			fl=0
			g=0
			repeat analognum
				f=((analog.(cnt-g).1<=cc)&(analog.(cnt-g).1+analog.(cnt-g).2>cc))
				if(shift_key=1):f=f|((analog.(cnt-g).1>=cc)&(analog.(cnt-g).1<cc+UNIT_MEASURE/editdiv))
				if((f=1)&(analog.(cnt-g).0=stat0)){
					if(fl=0):gosub *undokakuho
					fl=1
					fl2=-1
					stat3=analog.(cnt-g).1+analog.(cnt-g).2
					stat4=analog.(cnt-g).0
					if(analog.(cnt-g).2<=UNIT_MEASURE/32){
						fl2=analog.(cnt-g).1
						fl3=analog.(cnt-g).5
					}
					if(cnt-g<analognum){
						if(analogparent.(cnt-g+1)=cnt-g){
							analogparentran.(cnt-g+1)=analogparentran.(cnt-g)
						}
					}
					repeat analognum-(cnt-g)-1,(cnt-g)+1
						analog.(cnt-1).0=analog.cnt.0
						analog.(cnt-1).1=analog.cnt.1
						analog.(cnt-1).2=analog.cnt.2
						analog.(cnt-1).3=analog.cnt.3
						analog.(cnt-1).4=analog.cnt.4
						analog.(cnt-1).5=analog.cnt.5
						analogparentran.(cnt-1)=analogparentran.cnt
					loop
					analognum--
					g++
					gosub *selinit
					repeat analognum
						if((analog.cnt.1=stat3)&(analog.cnt.0=stat4)){
							if(fl2=-1):analog.cnt.5=1
							if(fl2>=0){
								analog.cnt.2+=analog.cnt.1-fl2
								analog.cnt.1=fl2
								analog.cnt.5=fl3
								fl4=cnt
								repeat fl4,1
									if((analog.(fl4-cnt).0=stat4)&(analog.(fl4-cnt).1+analog.(fl4-cnt).2=fl2)){
										analog.fl4.3=analog.(fl4-cnt).4
										break
									}
								loop
							}
						}
					loop
					break
				}
			loop
			if(fl=1):e=1:gosub *refreshtitle
		}
		if((edittarget=TARGET_SPIN)&(ctrl_key+alt_key+shift_key=0)){
			repeat spinnum
				if((spin.cnt.1<=cc)&(spin.cnt.1+spin.cnt.2>cc)){
					gosub *undokakuho
					repeat spinnum-cnt-1,cnt+1
						spin.(cnt-1).0=spin.cnt.0
						spin.(cnt-1).1=spin.cnt.1
						spin.(cnt-1).2=spin.cnt.2
						spin.(cnt-1).3=spin.cnt.3
						spin.(cnt-1).4=spin.cnt.4
						spin.(cnt-1).5=spin.cnt.5
					loop
					spinnum--
					e=1:gosub *refreshtitle
					gosub *selinit
					break
				}
			loop
		}
		if((edittarget=TARGET_SPIN)&(ctrl_key=1)&(alt_key+shift_key=0)){
			gosub *undokakuho
			gosub *selinit
			repeat spinnum
				if((spin.cnt.1<=cc)&(spin.cnt.1+spin.cnt.2>cc)){
					if(spin.cnt.0>=2){
						spin.cnt.0-=2
					}else{
						spin.cnt.0=4+spin.cnt.0\2
					}
					spin.cnt.3=150 //揺れ幅
					spin.cnt.4=3 //回数 (片道+1 往復+2)
					spin.cnt.5=2 //減衰の有無 (0:なし 1:あり(遅) 2:あり)
					e=1:gosub *refreshtitle
				}
			loop
		}
		if((edittarget=TARGET_ZOOMTOP)&(ctrl_key=0)&(shift_key=0)){
			if(ztopnum>0){
				repeat ztopnum
					if(ztop.cnt.0=cc){
						gosub *undokakuho
						repeat max(ztopnum-cnt-1,0),cnt+1
							ztop.(cnt-1).0=ztop.cnt.0
							ztop.(cnt-1).1=ztop.cnt.1
							ztop.(cnt-1).2=ztop.cnt.2
						loop
						ztopnum--
						e=1:gosub *refreshtitle
						gosub *selinit
					}
				loop
			}
		}
		if((edittarget=TARGET_ZOOMBOTTOM)&(ctrl_key=0)&(shift_key=0)){
			if(zbotnum>0){
				repeat zbotnum
					if(zbot.cnt.0=cc){
						gosub *undokakuho
						repeat max(zbotnum-cnt-1,0),cnt+1
							zbot.(cnt-1).0=zbot.cnt.0
							zbot.(cnt-1).1=zbot.cnt.1
							zbot.(cnt-1).2=zbot.cnt.2
						loop
						zbotnum--
						e=1:gosub *refreshtitle
						gosub *selinit
					}
				loop
			}
		}
		if((edittarget=TARGET_ZOOMSIDE)&(ctrl_key=0)&(shift_key=0)){
			if(zsidenum>0){
				repeat zsidenum
					if(zside.cnt.0=cc){
						gosub *undokakuho
						repeat max(zsidenum-cnt-1,0),cnt+1
							zside.(cnt-1).0=zside.cnt.0
							zside.(cnt-1).1=zside.cnt.1
							zside.(cnt-1).2=zside.cnt.2
						loop
						zsidenum--
						e=1:gosub *refreshtitle
						gosub *selinit
					}
				loop
			}
		}
		gosub *draw
	}
	return
	
*OnClick2
	if(enowstat=1){
		enowstat=2
	}
	return

*OnWheel
	if(playingsample=1):pendfl=1:return
	if(inputnow=1):return
	if((0 <= d3timer() - wheeltp) & (d3timer() - wheeltp < 5)) : return
	if(pendfl!=-1){
		acmd=CMD_PLAY_STOP
		gosub *OnCommand
		acmd=-1
		return
	}
	if(onwheelfl=0){
		onwheelfl=1
		getkey shift_key_wheel,16
		getkey ctrl_key_wheel,17
		getkey alt_key_wheel,18
		if(ctrl_key_wheel+alt_key_wheel+shift_key_wheel=0){
			movepos_wheel+=(wparam>>16)
			if(movepos_wheel>=120){
				/*if(posnow<tate/vtate-vyk):*/posnow++
				gosub *draw
				movepos_wheel=0
			}else:if(movepos_wheel<=-120){
				if(((pendfl=-1)|(synchro=0))|((pendfl=0)&((posnow+vyoko/2)*vtate*UNIT_MEASURE>cnow))){
					if(posnow>0){
						posnow--
						gosub *draw
					}
				}
				movepos_wheel=movepos_wheel\120
			}
		}else:if((ctrl_key_wheel=1)&(alt_key_wheel=0)&(shift_key_wheel=0)){
			editmode_wheel+=(wparam>>16)
			f_wheel=0
			if(editmode_wheel>=120){
				if(editmode<2):editmode++
				//if(editmode>2):editmode=0
				f_wheel=1
			}else:if(editmode_wheel<=-120){
				if(editmode>0):editmode--
				//if(editmode<0):editmode=2
				f_wheel=1
			}
			if(f_wheel=1){
				gosub *refreshmenu_editmode
				editmode_wheel=editmode_wheel\120
				gosub *draw
			}
		}else:if((ctrl_key_wheel=0)&(alt_key_wheel=1)&(shift_key_wheel=0)){
			edittarget_wheel+=(wparam>>16)
			f_wheel=0
			if(edittarget_wheel>=120){
				if(edittarget<TARGET_STOP):edittarget++
				//if(edittarget>TARGET_STOP):edittarget=0
				f_wheel=1
			}else:if(edittarget_wheel<=-120){
				if(edittarget>0):edittarget--
				//if(edittarget<0):edittarget=TARGET_STOP
				f_wheel=1
			}
			if(f_wheel=1){
				gosub *refreshmenu_edittarget
				edittarget_wheel=edittarget_wheel\120
				gosub *draw
			}
		}else:if((ctrl_key_wheel=1)&(alt_key_wheel=1)&(shift_key_wheel=0)){
			movecnowf_wheel+=(wparam>>16)
			if(movecnowf_wheel>=120){
				cnowf+=UNIT_MEASURE/editdiv*(movecnowf_wheel/120)
				cnowflen=0
				movecnowf_wheel=movecnowf_wheel\120
				trackcursor cnowf+cnowflen
			}else:if(movecnowf_wheel<=-120){
				cnowf+=UNIT_MEASURE/editdiv*(movecnowf_wheel/120)
				cnowflen=0
				movecnowf_wheel=movecnowf_wheel\120
				trackcursor cnowf+cnowflen
			}
			cnowf=max(cnowf,0)
			gosub *draw
		}else:if((ctrl_key_wheel=1)&(alt_key_wheel=1)&(shift_key_wheel=1)){
			cnowflen_wheel+=(wparam>>16)
			f_wheel=0
			if(cnowflen_wheel>=120){
				cnowflen+=UNIT_MEASURE/editdiv*(cnowflen_wheel/120)
				cnowflen_wheel=cnowflen_wheel\120
				f_wheel=1
			}else:if(cnowflen_wheel<=-120){
				cnowflen+=UNIT_MEASURE/editdiv*(cnowflen_wheel/120)
				cnowflen_wheel=cnowflen_wheel\120
				f_wheel=1
			}
			if(f_wheel=1){
				if(cnowf+cnowflen<0):cnowflen=-cnowf
				gosub *selinit2
				stat1=min(cnowf,cnowf+cnowflen)
				stat2=max(cnowf,cnowf+cnowflen)
				repeat analognum
					if(analog.cnt.1+analog.cnt.2<=stat1):continue
					if(analog.cnt.1>=stat2):break
					selanalog.selanalognum=cnt
					selanalognum++
				loop
				repeat spinnum
					if(spin.cnt.1+spin.cnt.2<=stat1):continue
					if(spin.cnt.1>=stat2):break
					selspin.selspinnum=cnt
					selspinnum++
				loop
				repeat stpnum
					if(stp.cnt.0+stp.cnt.1<=stat1):continue
					if(stp.cnt.0>=stat2):break
					selstp.selstpnum=cnt
					selstpnum++
				loop
				repeat notenum
					if((note.cnt.2>0)&(note.cnt.1+note.cnt.2<=stat1)):continue
					if((note.cnt.2=0)&(note.cnt.1<stat1)):continue
					if(note.cnt.1>=stat2):break
					selnote.selnotenum=cnt
					selnotenum++
				loop
				trackcursor cnowf+cnowflen
			}
			gosub *draw
		}else:if((ctrl_key_wheel=0)&(alt_key_wheel=0)&(shift_key_wheel=1)){
			editdiv_wheel+=(wparam>>16)
			f_wheel=0
			if(editdiv_wheel>=120){
				f_wheel=1
				if(editdiv=4):acmd=CMD_TOOL_8
				if(editdiv=8):acmd=CMD_TOOL_12
				if(editdiv=12):acmd=CMD_TOOL_16
				if(editdiv=16):acmd=CMD_TOOL_24
				if(editdiv=24):acmd=CMD_TOOL_32
				if(editdiv=32):acmd=CMD_TOOL_48
				if(editdiv=48):acmd=CMD_TOOL_64
				if(editdiv=64):acmd=CMD_TOOL_96
				if(editdiv=96):acmd=CMD_TOOL_192
				if(editdiv=192):f_wheel=0:editdiv_wheel=editdiv_wheel\120//acmd=CMD_TOOL_4
			}else:if(editdiv_wheel<=-120){
				f_wheel=1
				if(editdiv=4):f_wheel=0:editdiv_wheel=editdiv_wheel\120//acmd=CMD_TOOL_64
				if(editdiv=8):acmd=CMD_TOOL_4
				if(editdiv=12):acmd=CMD_TOOL_8
				if(editdiv=16):acmd=CMD_TOOL_12
				if(editdiv=24):acmd=CMD_TOOL_16
				if(editdiv=32):acmd=CMD_TOOL_24
				if(editdiv=48):acmd=CMD_TOOL_32
				if(editdiv=64):acmd=CMD_TOOL_48
				if(editdiv=96):acmd=CMD_TOOL_64
				if(editdiv=192):acmd=CMD_TOOL_96
			}
			if(f_wheel=1){
				gosub *OnCommand
				acmd=-1
				editdiv_wheel=editdiv_wheel\120
			}
		}
		wheeltp=d3timer()
		onwheelfl=0
	}
	wheelfl=1
	return

*alt
	if((wParam=18)&(wheelfl=1)){
		wheelfl=0
		return 0
	}else{
		return
	}

*OnWheel_H
	if(playingsample=1):pendfl=1:return
	if(inputnow=1):return
	if((0 <= d3timer() - wheeltp) & (d3timer() - wheeltp < 40)) : return
	if(pendfl!=-1){
		acmd=CMD_PLAY_STOP
		gosub *OnCommand
		acmd=-1
		return
	}
	if(onwheelfl=0){
		onwheelfl=1
		if(wparam>0){
			/*if(posnow<tate/vtate-vyk):*/posnow++
			gosub *draw
		}else{
			if(((pendfl=-1)|(synchro=0))|((pendfl=0)&((posnow+vyoko/2)*vtate*UNIT_MEASURE>cnow))){
				if(posnow>0){
					posnow--
					gosub *draw
				}
			}
		}
		wheeltp=d3timer()
		onwheelfl=0
	}
	return

*undokakuho
	ud_num.0.ud_cur=notenum,analognum,spinnum,tiltnum,ztopnum,zbotnum,zsidenum,bpmlnum,anagainnum,anafilnum,anvolnum,ansenum,beatlnum,stpnum,commentnum
	memcpy ud_note.0.0.ud_cur,note,SIZEOF_INT*length(note)*length2(note)
	repeat 131072
		memcpy ud_notesefname.cnt.ud_cur,notesefname.cnt,256
	loop
	memcpy ud_analog.0.0.ud_cur,analog,SIZEOF_INT*length(analog)*length2(analog)
	memcpy ud_spin.0.0.ud_cur,spin,SIZEOF_INT*length(spin)*length2(spin)
	memcpy ud_tilt.0.0.ud_cur,tilt,SIZEOF_INT*length(tilt)*length2(tilt)
	memcpy ud_ztop.0.0.ud_cur,ztop,SIZEOF_INT*length(ztop)*length2(ztop)
	memcpy ud_zbot.0.0.ud_cur,zbot,SIZEOF_INT*length(zbot)*length2(zbot)
	memcpy ud_zside.0.0.ud_cur,zside,SIZEOF_INT*length(zside)*length2(zside)
	memcpy ud_bpml.0.0.ud_cur,bpml,SIZEOF_INT*length(bpml)*length2(bpml)
	memcpy ud_anagain.0.0.ud_cur,anagain,SIZEOF_INT*length(anagain)*2
	memcpy ud_anafil.0.0.ud_cur,anafil,SIZEOF_INT*length(anafil)*2
	memcpy ud_anvol.0.0.ud_cur,anvol,SIZEOF_INT*length(anvol)*2
	memcpy ud_anse.0.0.ud_cur,anse,SIZEOF_INT*length(anse)*length2(anse)
	memcpy ud_beatl.0.0.ud_cur,beatl,SIZEOF_INT*length(beatl)*length2(beatl)
	memcpy ud_stp.0.0.ud_cur,stp,SIZEOF_INT*length(stp)*length2(stp)
	memcpy ud_analogparent.0.ud_cur,analogparent,SIZEOF_INT*length(analogparent)
	memcpy ud_analogparentran.0.ud_cur,analogparentran,SIZEOF_INT*length(analogparentran)
	memcpy ud_comment.0.ud_cur,comment,SIZEOF_INT*length(comment)
	repeat 1024
		memcpy ud_commentstr.cnt.ud_cur,commentstr.cnt,512
	loop
	ud_cur=(ud_cur+1)\UNDO_MAX
	ud_cnt=min(ud_cnt+1,UNDO_MAX)
	ud_redomax=0
	ud_redofl=1
	gosub *refreshmenu_undo
	return

*undofukugen
	i=0
	notenum=ud_num.i.ud_cur : i++
	analognum=ud_num.i.ud_cur : i++
	spinnum=ud_num.i.ud_cur : i++
	tiltnum=ud_num.i.ud_cur : i++
	ztopnum=ud_num.i.ud_cur : i++
	zbotnum=ud_num.i.ud_cur : i++
	zsidenum=ud_num.i.ud_cur : i++
	bpmlnum=ud_num.i.ud_cur : i++
	anagainnum=ud_num.i.ud_cur : i++
	anafilnum=ud_num.i.ud_cur : i++
	anvolnum=ud_num.i.ud_cur : i++
	ansenum=ud_num.i.ud_cur : i++
	beatlnum=ud_num.i.ud_cur : i++
	stpnum=ud_num.i.ud_cur : i++
	commentnum=ud_num.i.ud_cur : i++
	memcpy note,ud_note.0.0.ud_cur,SIZEOF_INT*length(note)*length2(note)
	repeat 131072
		memcpy notesefname.cnt,ud_notesefname.cnt.ud_cur,256
	loop
	memcpy analog,ud_analog.0.0.ud_cur,SIZEOF_INT*length(analog)*length2(analog)
	memcpy spin,ud_spin.0.0.ud_cur,SIZEOF_INT*length(spin)*length2(spin)
	memcpy tilt,ud_tilt.0.0.ud_cur,SIZEOF_INT*length(tilt)*length2(tilt)
	memcpy ztop,ud_ztop.0.0.ud_cur,SIZEOF_INT*length(ztop)*length2(ztop)
	memcpy zbot,ud_zbot.0.0.ud_cur,SIZEOF_INT*length(zbot)*length2(zbot)
	memcpy zside,ud_zside.0.0.ud_cur,SIZEOF_INT*length(zside)*length2(zside)
	memcpy bpml,ud_bpml.0.0.ud_cur,SIZEOF_INT*length(bpml)*length2(bpml)
	memcpy anagain,ud_anagain.0.0.ud_cur,SIZEOF_INT*length(anagain)*2
	memcpy anafil,ud_anafil.0.0.ud_cur,SIZEOF_INT*length(anafil)*2
	memcpy anvol,ud_anvol.0.0.ud_cur,SIZEOF_INT*length(anvol)*2
	memcpy anse,ud_anse.0.0.ud_cur,SIZEOF_INT*length(anse)*length2(anse)
	memcpy beatl,ud_beatl.0.0.ud_cur,SIZEOF_INT*length(beatl)*length2(beatl)
	memcpy stp,ud_stp.0.0.ud_cur,SIZEOF_INT*length(stp)*length2(stp)
	memcpy analogparent,ud_analogparent.0.ud_cur,SIZEOF_INT*length(analogparent)
	memcpy analogparentran,ud_analogparentran.0.ud_cur,SIZEOF_INT*length(analogparentran)
	memcpy comment,ud_comment.0.ud_cur,SIZEOF_INT*length(comment)
	repeat 1024
		memcpy commentstr.cnt,ud_commentstr.cnt.ud_cur,512
	loop
	gosub *selinit
	gosub *refreshmenu_undo
	return

*refreshtitle
	stat_1=ginfo_sel
	stat_2=""
	gsel 0
	if(e=1):stat_2=" *"
	title atitle+stat_2
	gsel stat_1
	return

*confirmsave
	if(ignoreconfirm=1){
		confirmstat=1
		return
	}
	confirmstat=-1
	if(e=1){
		exist fname
		if((stat!=-1)&(fname!="")){
			stat1=lang.0.28
		}else:stat1=lang.0.29
		stat3=""
		if(csongdifficulty=0):stat3="LT"
		if(csongdifficulty=1):stat3="CH"
		if(csongdifficulty=2):stat3="EX"
		if(csongdifficulty=3):stat3="IN"
		stat2=lang.0.27
		stat2=replace(stat2,"\%0",sjisenc(csongtitle))
		stat2=replace(stat2,"\%1",stat3)
		stat2=replace(stat2,"\%2",stat1)
		inputnow=1
		msgdlg stat2,lang.0.26,3,2
		inputnow=0
		
		if(stat=6){
			acmd=CMD_SAVE
			gosub *OnCommand
			wait 10
			if(savestat=1){
				confirmstat=0
			}else:confirmstat=2
		}
		if(stat=7){
			confirmstat=1
		}
		if(stat=2){
			confirmstat=2
		}
	}
	return

*smlabel
	sm=1
	notesel buf2
	noteload stat1
	repeat
		buf2=replace(buf2,"\n,(.*)=(.*)",",$1=$2",,,1)
		if(match(buf2,"\n,(.*)=(.*)",,1)=""):break
	loop
	repeat notemax
		noteget stat1,cnt
		if(strmid(stat1,0,7)="#TITLE:"){
			stat2=strmid(stat1,7,64)
			csongtitle=strtrim(stat2,2,';')
		}
		if(strmid(stat1,0,8)="#ARTIST:"){
			stat2=strmid(stat1,8,64)
			csongartist=strtrim(stat2,2,';')
		}
		if(strmid(stat1,0,6)="#BPMS:"){
			stat2=strmid(stat1,6,131072)
			stat2=strtrim(stat2,2,';')
			split stat2,",",bpms
			foreach bpms
				stat3=bpms.cnt
				split stat3,"=",bpms2
				bpml.bpmlnum.0=int(double(bpms2.0)*UNIT_MEASURE/beat)
				bpm=int(double(bpms2.1)*1000)
				bpml.bpmlnum.1=bpm
				bpmlnum++
			loop
			bpm=bpml.0.1
		}
		if(strmid(stat1,0,7)="#STOPS:"){
			stat2=strmid(stat1,7,131072)
			stat2=strtrim(stat2,2,';')
			split stat2,",",stps
			foreach stps
				stat3=stps.cnt
				split stat3,"=",stps2
				if(length(stps2)<2):break
				stp.stpnum.0=int(double(stps2.0)*UNIT_MEASURE/beat)
				stp.stpnum.1=int(double(stps2.1)*1000)
				stpnum++
			loop
		}
		if(strmid(stat1,0,7)="#MUSIC:"){
			stat2=strmid(stat1,7,64)
			csongfile=strtrim(stat2,2,';')
		}
		if(strmid(stat1,0,7)="#NOTES:"){
			lev.levnum=cnt
			noteget stat2,cnt+3
			stat2=strtrim(stat2,0,' ')
			levlabel.levnum=strtrim(stat2,2,':')
			noteget stat2,cnt+4
			stat2=strtrim(stat2,0,' ')
			levl.levnum=int(strtrim(stat2,2,':'))
			levnum++
		}
	loop
	repeat notemax
		noteget stat1,cnt
		stat2=strmid(stat1,8,16)
		if(strmid(stat1,0,8)="#OFFSET:"):offset=-int(double(strtrim(stat2,2,';'))*1000)-78
	loop
	ocnt=0/*
	while offset<0
		offset=10000+offset
		ocnt++
	wend*/
	repeat bpmlnum
		if(bpml.cnt.0!=0):bpml.cnt.0+=ocnt*UNIT_MEASURE
	loop
	repeat stpnum
		stp.cnt.0+=ocnt*UNIT_MEASURE
	loop
	buf ="title="+csongtitle+"\n"
	if(csongtitleimg!=""):buf+="title_img="+csongtitleimg+"\n"
	if(csongtitle_a!=""):buf+="atitle="+csongtitle_a+"\n"
	buf+="artist="+csongartist+"\n"
	if(csongartistimg!=""):buf+="artist_img="+csongartistimg+"\n"
	buf+="effect="+csongeffect+"\n"
	buf+="jacket="+csongjacket+"\n"
	buf+="illustrator="+csongillustrator+"\n"
	if(csongdifficulty=0){
		buf+="difficulty=light\n"
	}else:if(csongdifficulty=1){
		buf+="difficulty=challenge\n"
	}else:if(csongdifficulty=2){
		buf+="difficulty=extended\n"
	}else{
		buf+="difficulty=infinite\n"
	}
	buf+="level="+csonglevel+"\n"
	stat1=str(double(bpm)/1000)
	stat1=strtrim(stat1,2,'0')
	buf+="t="+strtrim(stat1,2,'.')+"\n"
	buf+="m="+csongfile+"\n"
	buf+="o="+offset+"\n"
	buf+="bg="+bgname+"\n"
	buf+="layer="+bgname_l+"\n"
	buf+="po="+poffset+"\n"
	buf+="plength="+plength+"\n"
	if(csongv!=""){
		buf+="v="+csongv+"\n"
		buf+="vo="+csongvoffset+"\n"
	}
	buf+="mvol="+csongvol+"\n"
	buf+="--\n"
	repeat ocnt
		buf+="0000|00|--\n--\n"
	loop
	clev=-1
	stat1_=lang.0.40/*"以下の難易度があります"*/+"\n"
	repeat levnum
		stat1_+=" "+levlabel.cnt+"("+levl.cnt+")\n"
	loop
	repeat levnum-1
		dialog stat1_+"\n"+lang.0.41+levlabel.cnt+lang.0.42+levl.cnt+lang.0.43,2,""+(cnt+1)+"/"+levnum
		if(stat=6){
			clev=cnt
			break
		}else{
			continue
		}
	loop
	if(clev=-1):clev=levnum-1
	dialog lang.0.44+levlabel.clev+lang.0.45+levl.clev+lang.0.46
	bcnt=0
	dim l,2
	dim lp,2
	repeat 16777216
		cnt2=cnt
		noteget stat1,lev.clev+cnt+6
		if(strmid(stat1,0,1)=","){
			dcnt++
			bcnt=0
			buf+="--\n"
			divnum2=0
			repeat 192
				noteget stat2,clev+cnt2+6+cnt
				if((strmid(stat2,0,1)=",")|(strmid(stat2,0,1)=";")):break
				divnum2++
			loop
			continue
		}
		if(strmid(stat1,0,1)=";"){
			break
		}
		dim n,4
		repeat 4
			if(strmid(stat1,cnt,1)="1"):n.cnt=1
			if(strmid(stat1,cnt,1)="2"){
				if(divnum2>=16){
					if(bcnt=divnum2-1){
						noteget stat2,clev+cnt2+6+2
					}else{
						noteget stat2,clev+cnt2+6+1
					}
					if(strmid(stat2,cnt,1)="3"){
						n.cnt=1
					}else{
						l.(cnt/2)=1
					}
				}else{
					if(lp.(cnt/2)=0){
						l.(cnt/2)=1
					}else{
						n.cnt=1
					}
				}
			}
			if(strmid(stat1,cnt,1)="3"):l.(cnt/2)=0
			lp=l.0,l.1
		loop
		buf+=""+n.0+n.1+n.2+n.3+"|"+l.0+l.1+"|--\n"
		bcnt++
	loop
	buf+="--"
	notesel buf
	fname=""
	isutf8=1
	e=1:gosub *refreshtitle
	return

*exit
	if(inputnow=1){
		inputnow=3
		return
	}
	gosub *confirmsave
	if(confirmstat!=2){
		gosub *saveconfig
		if (htoolbarbmp) {
		    DeleteBitmap htoolbarbmp
		}
		end
	}
	return

*dd
	if(playingsample=1):pendfl=1:return
	if(pendfl!=-1):pendfl=1:return
	if(inputnow!=0):return
	notesel ddbuf
	if(notemax=1){
		noteget stat1,0
		exist stat1
		if(strsize>=0){
			afname=stat1
			acmd=CMD_OPEN
			gosub *OnCommand
			afname=""
		}
	}
	return

*createtoolbar
	gsel 0
	if(idTool!=-1):clrobj idTool
	winobj "ToolbarWindow32", "", 0, 0x50000801, 0, 0
	idTool = stat
	hTool = objinfo_hwnd(idTool)
	
	sendmsg hTool, TB_BUTTONSTRUCTSIZE, 20, 0
	sendmsg hTool, TB_SETEXTENDEDSTYLE, 0, TBSTYLE_EX_DRAWDDARROWS
	
	tbadd(0) = 0
	tbadd(1) = htoolbarbmp
	sendmsg hTool, TB_ADDBITMAP, 14, varptr(tbadd)
	tbadd(0) = -1        ; HINST_COMMCTRL
	tbadd(1) = 0         ; IDB_STD_SMALL_COLOR
	sendmsg hTool, TB_ADDBITMAP, 0, varptr(tbadd)
	
	i=0
	tbb(i*5) =  0,			0						, 256 , 1, 0 : i++	; ---
	tbb(i*5) =  TBNUM+6,	CMD_NEW					, 0x04, 0, 0 : i++	; 新規作成
	tbb(i*5) =  TBNUM+7,	CMD_OPEN				, 0x04, 0, 0 : i++	; 開く
	tbb(i*5) =  TBNUM+8,	CMD_SAVE				, 0x04, 0, 0 : i++	; 保存
	tbb(i*5) =  0,			0						, 256 , 1, 0 : i++	; ---
	tbb(i*5) =  TBNUM+0,	CMD_EDIT_CUT			, 0x04, 0, 0 : i++	; 切り取り
	tbb(i*5) =  TBNUM+1,	CMD_EDIT_COPY			, 0x04, 0, 0 : i++	; コピー
	tbb(i*5) =  TBNUM+2,	CMD_EDIT_PASTE			, 0x04, 0, 0 : i++	; 貼り付け
	tbb(i*5) =  0,			0						, 256 , 1, 0 : i++	; ---
	tbb(i*5) =  TBNUM+3,	CMD_EDIT_UNDO			, 0x04, 0, 0 : i++	; 元に戻す
	tbb(i*5) =  TBNUM+4,	CMD_EDIT_REDO			, 0x04, 0, 0 : i++	; やり直し
	tbb(i*5) =  0,			0						, 256 , 1, 0 : i++	; ---
	tbb(i*5) =  17,			CMD_VIEW_2X				, 0x04, 0, 0 : i++	; 縦幅拡大
	tbb(i*5) =  18,			CMD_VIEW_VSEPMAXIMIZE	, 0x04, 0, 0 : i++	; 横間隔広く
	tbb(i*5) =  0,			0						, 256 , 1, 0 : i++	; ---
	tbb(i*5) =  0,			CMD_TOOL_POINT			, 0x04, 0, 0 : i++	; 
	tbb(i*5) =  1,			CMD_TOOL_PENCIL			, 0x04, 0, 0 : i++	; 
	tbb(i*5) =  2,			CMD_TOOL_ERASE			, 0x04, 0, 0 : i++	; 
	tbb(i*5) =  0,			0						, 256 , 1, 0 : i++	; ---
	tbb(i*5) =  3,			CMD_TOOL_POS			, 0x04, 0, 0 : i++	; 
	tbb(i*5) =  4,			CMD_TOOL_NOTE			, 0x04, 0, 0 : i++	; 
	tbb(i*5) =  5,			CMD_TOOL_NOTE2			, 0x04, 0, 0 : i++	; 
	tbb(i*5) =  6,			CMD_TOOL_LNOTE2			, 0x04, 0, 0 : i++	; 
	tbb(i*5) =  7,			CMD_TOOL_LNOTE			, 0x04, 0, 0 : i++	; 
	tbb(i*5) =  8,			CMD_TOOL_ANALOGL		, 0x04, 0, 0 : i++	; 
	tbb(i*5) =  9,			CMD_TOOL_ANALOGR		, ($8<<8)|0x04, 0, 0 : i++	; 
	tbb(i*5) =  0,			0						, 256 , 1, 0 : i++	; ---
	tbb(i*5) =  19,			CMD_EDIT_SONGSETTINGS	, 0x04, 0, 0 : i++	; 譜面についての設定
	tbb(i*5) =  0,			0						, 256 , 1, 0 : i++	; ---
	tbb(i*5) =  20,			CMD_PLAY_PLAY			, 0x04, 0, 0 : i++	; 再生
	tbb(i*5) =  23,			CMD_PLAY_TICK			, 0x04, 0, 0 : i++	; ASSIST TICK
	tbb(i*5) =  21,			CMD_PLAY_TESTPLAY		, 0x04, 0, 0 : i++	; テストプレイ
	tbb(i*5) =  22,			CMD_PLAY_TESTPLAY_AUTO	, 0x04, 0, 0 : i++	; テストプレイ(AUTO)
	tbb(i*5) =  0,			0						, 256 , 1, 0 : i++	; ---
	
	sendmsg hTool, TB_ADDBUTTONS, i, varptr(tbb)
	sendmsg hTool, TB_AUTOSIZE, 0, 0
	
	gosub *refreshmenu_editmode
	gosub *refreshmenu_edittarget
	gosub *refreshmenu_undo
	sendmsg hTool, 0x402, CMD_VIEW_2X,    (vzoomrate!=1.0f)
	sendmsg hTool, 0x402, CMD_VIEW_VSEPMAXIMIZE,    (vsep=72)
	sendmsg hTool, 0x402, CMD_PLAY_TICK,  assisttick
	
	return

*OnNotify
    dupptr nmhdr, lParam, 12
    if (nmhdr(0) == hTool) && (nmhdr(2) == TBN_DROPDOWN) :gosub *OnToolDropDown
    return

*OnToolDropDown
    dupptr nmtoolbar, lParam, 44
    itemId = nmtoolbar(3)
    if (itemId == CMD_TOOL_ANALOGR) {
        dim rc, 4
        sendmsg hTool, TB_GETRECT, itemId, varptr(rc)
        pt = rc(0), rc(3)
        ClientToScreen hTool, varptr(pt)
        TrackPopupMenuEx htooltargetmenu, 0, pt(0), pt(1), hwnd, 0
    }
    return

*refreshmenu_editmode
	CheckMenuItem hmenu, CMD_TOOL_POINT,    0x08*(editmode=MODE_POINT)
	CheckMenuItem hmenu, CMD_TOOL_PENCIL,   0x08*(editmode=MODE_PENCIL)
	CheckMenuItem hmenu, CMD_TOOL_ERASE,    0x08*(editmode=MODE_ERASE)
	sendmsg hTool, 0x402, CMD_TOOL_POINT,  (editmode=MODE_POINT)
	sendmsg hTool, 0x402, CMD_TOOL_PENCIL, (editmode=MODE_PENCIL)
	sendmsg hTool, 0x402, CMD_TOOL_ERASE, (editmode=MODE_ERASE)
	return

*refreshmenu_edittarget
	CheckMenuItem hmenu, CMD_TOOL_POS,     0x08*(edittarget=TARGET_POS)
	CheckMenuItem hmenu, CMD_TOOL_NOTE,    0x08*(edittarget=TARGET_NOTE)
	CheckMenuItem hmenu, CMD_TOOL_NOTE2,   0x08*(edittarget=TARGET_NOTE2)
	CheckMenuItem hmenu, CMD_TOOL_LNOTE,   0x08*(edittarget=TARGET_LNOTE)
	CheckMenuItem hmenu, CMD_TOOL_LNOTE2,  0x08*(edittarget=TARGET_LNOTE2)
	CheckMenuItem hmenu, CMD_TOOL_ANALOGL, 0x08*(edittarget=TARGET_ANALOGL)
	CheckMenuItem hmenu, CMD_TOOL_ANALOGR, 0x08*(edittarget=TARGET_ANALOGR)
	CheckMenuItem hmenu, CMD_TOOL_ANALOGPFILTER, 0x08*(edittarget=TARGET_ANALOGPFILTER)
	CheckMenuItem hmenu, CMD_TOOL_ANALOGVOL, 0x08*(edittarget=TARGET_ANALOGVOL)
	CheckMenuItem hmenu, CMD_TOOL_SPIN   , 0x08*(edittarget=TARGET_SPIN)
	CheckMenuItem hmenu, CMD_TOOL_ROTATE , 0x08*(edittarget=TARGET_ROTATE)
	CheckMenuItem hmenu, CMD_TOOL_ZOOMTOP , 0x08*(edittarget=TARGET_ZOOMTOP)
	CheckMenuItem hmenu, CMD_TOOL_ZOOMBOTTOM , 0x08*(edittarget=TARGET_ZOOMBOTTOM)
	CheckMenuItem hmenu, CMD_TOOL_ZOOMSIDE , 0x08*(edittarget=TARGET_ZOOMSIDE)
	CheckMenuItem hmenu, CMD_TOOL_STOP   , 0x08*(edittarget=TARGET_STOP)
	sendmsg hTool, 0x402, CMD_TOOL_POS,  (edittarget=TARGET_POS)
	sendmsg hTool, 0x402, CMD_TOOL_NOTE, (edittarget=TARGET_NOTE)
	sendmsg hTool, 0x402, CMD_TOOL_NOTE2, (edittarget=TARGET_NOTE2)
	sendmsg hTool, 0x402, CMD_TOOL_LNOTE, (edittarget=TARGET_LNOTE)
	sendmsg hTool, 0x402, CMD_TOOL_LNOTE2, (edittarget=TARGET_LNOTE2)
	sendmsg hTool, 0x402, CMD_TOOL_ANALOGL, (edittarget=TARGET_ANALOGL)
	sendmsg hTool, 0x402, CMD_TOOL_ANALOGR, (edittarget=TARGET_ANALOGR)
	return

*refreshmenu_undo
	EnableMenuItem hmenu, CMD_EDIT_UNDO,    1-(ud_cnt>0)
	EnableMenuItem hmenu, CMD_EDIT_REDO,    1-(ud_redomax>0)
	sendmsg hTool, 0x401, CMD_EDIT_UNDO,  (ud_cnt>0)
	sendmsg hTool, 0x401, CMD_EDIT_REDO,  (ud_redomax>0)
	return

#defcfunc c2t int c
	ddim ct,1
	cnt2=0
	if(bpmlnum>0){
		repeat bpmlnum
			cbpm=bpml.cnt.1/(bpmhalf+1)
			if(cnt=bpmlnum-1):break
			if(bpml.(cnt+1).0<c){
				ct+=double(bpml.(cnt+1).0-bpml.cnt.0)/8*beat*625*500/cbpm*8
			}else:break
			cnt2++
		loop
	}else{
		cbpm=120000
	}
	ct+=double(c-bpml.cnt2.0)/8*beat*625*500/cbpm*8
	//ct+=ot
	return int(ct)//c*beat*6/bpm+ot


#defcfunc c2tf int c
	ddim ct,1
	cnt2=0
	if(bpmlnum>0){
		repeat bpmlnum
			cbpm=bpml.cnt.1/(bpmhalf+1)
			if(cnt=bpmlnum-1):break
			if(bpml.(cnt+1).0<c){
				ct+=double(bpml.(cnt+1).0-bpml.cnt.0)/8*beat*625*500/cbpm*8
			}else:break
			cnt2++
		loop
	}else{
		cbpm=120000
	}
	ct+=double(c-bpml.cnt2.0)/8*beat*625*500/cbpm*8
	//ct+=ot
	return ct//c*beat*6/bpm+ot

#defcfunc c2ta int c
	ddim ct,1
	cnt2=0
	if(bpmlnum>0){
		repeat bpmlnum
			cbpm=bpml.cnt.1
			if(cnt=bpmlnum-1):break
			if(bpml.(cnt+1).0<c){
				ct+=double(bpml.(cnt+1).0-bpml.cnt.0)/8*beat*625*500/cbpm*8
			}else:break
			cnt2++
		loop
	}else{
		cbpm=120000
	}
	ct+=double(c-bpml.cnt2.0)/8*beat*625*500/cbpm*8
	//ct+=ot
	return int(ct)//c*beat*6/bpm+ot

#defcfunc c2t2 int c
	ct=0
	cnt2=0
	if(bpmlnum>0){
		repeat bpmlnum
			cbpm=bpml.cnt.1/(bpmhalf+1)
			if(cnt=bpmlnum-1):break
			if(bpml.(cnt+1).0*625/12<c){
				ct+=(bpml.(cnt+1).0-bpml.cnt.0)/8*beat*3*1000/cbpm*4
			}else:break
			cnt2++
		loop
	}else{
		cbpm=120000
	}
	ct+=(c-bpml.cnt2.0*625/12)/8*6*beat*1000/cbpm*8
	//ct+=ot
	return ct//c*beat*6/bpm+ot

#deffunc notefxplus int noteno
	gosub *undokakuho
	note.noteno.3++
	if(note.noteno.3>19){
		if(note.noteno.3<100){
			if(userfxnum-userfilternum>0){
				note.noteno.3=100
			}else{
				note.noteno.3=0
			}
		}else{
			if(userfxnum-userfilternum<=note.noteno.3-100){
				note.noteno.3=0
			}
		}
	}
	note.noteno.4=0
	note.noteno.5=0
	if((note.noteno.3>=FX_RE8)&(note.noteno.3<=FX_RE32)):note.noteno.4=fx_div.(note.noteno.3)
	if((note.noteno.3>=FX_GA4)&(note.noteno.3<=FX_GA32)):note.noteno.4=fx_div.(note.noteno.3)
	if(note.noteno.3=FX_WO12):note.noteno.4=12
	if(note.noteno.3=FX_PITC):note.noteno.4=12
	if(note.noteno.3=FX_BITC):note.noteno.4=10
	if(note.noteno.3=FX_TSTP):note.noteno.4=50
	if(note.noteno.3=FX_EC4){
		note.noteno.4=4
		note.noteno.5=60
	}
	if(note.noteno.3>=100){
		if(int(userfx_params.(note.noteno.3-100).0)=FXDEF_FXTYPE_RETR){
			note.noteno.4=8
		}else:if(int(userfx_params.(note.noteno.3-100).0)=FXDEF_FXTYPE_GATE){
			note.noteno.4=4
		}else:if(int(userfx_params.(note.noteno.3-100).0)=FXDEF_FXTYPE_WOBB){
			note.noteno.4=12
		}else:if(int(userfx_params.(note.noteno.3-100).0)=FXDEF_FXTYPE_PITC){
			note.noteno.4=12
		}else:if(int(userfx_params.(note.noteno.3-100).0)=FXDEF_FXTYPE_BITC){
			note.noteno.4=10
		}else:if(int(userfx_params.(note.noteno.3-100).0)=FXDEF_FXTYPE_TSTP){
			note.noteno.4=50
		}else:if(int(userfx_params.(note.noteno.3-100).0)=FXDEF_FXTYPE_ECHO){
			note.noteno.4=4
			note.noteno.5=60
		}
	}
	e=1:gosub *refreshtitle
	return

#deffunc notefxminus int noteno
	gosub *undokakuho
	note.noteno.3--
	if(note.noteno.3=99){
		note.noteno.3=19
	}
	if(note.noteno.3<0){
		if(userfxnum-userfilternum>0){
			note.noteno.3=100+userfxnum-userfilternum-1
		}else:note.noteno.3=19
	}
	note.noteno.4=0
	note.noteno.5=0
	if((note.noteno.3>=FX_RE8)&(note.noteno.3<=FX_RE32)):note.noteno.4=fx_div.(note.noteno.3)
	if((note.noteno.3>=FX_GA4)&(note.noteno.3<=FX_GA32)):note.noteno.4=fx_div.(note.noteno.3)
	if(note.noteno.3=FX_WO12):note.noteno.4=12
	if(note.noteno.3=FX_PITC):note.noteno.4=12
	if(note.noteno.3=FX_BITC):note.noteno.4=10
	if(note.noteno.3=FX_TSTP):note.noteno.4=50
	if(note.noteno.3=FX_EC4){
		note.noteno.4=4
		note.noteno.5=60
	}
	if(note.noteno.3>=100){
		if(int(userfx_params.(note.noteno.3-100).0)=FXDEF_FXTYPE_RETR){
			note.noteno.4=8
		}else:if(int(userfx_params.(note.noteno.3-100).0)=FXDEF_FXTYPE_GATE){
			note.noteno.4=4
		}else:if(int(userfx_params.(note.noteno.3-100).0)=FXDEF_FXTYPE_WOBB){
			note.noteno.4=12
		}else:if(int(userfx_params.(note.noteno.3-100).0)=FXDEF_FXTYPE_PITC){
			note.noteno.4=12
		}else:if(int(userfx_params.(note.noteno.3-100).0)=FXDEF_FXTYPE_BITC){
			note.noteno.4=10
		}else:if(int(userfx_params.(note.noteno.3-100).0)=FXDEF_FXTYPE_TSTP){
			note.noteno.4=50
		}else:if(int(userfx_params.(note.noteno.3-100).0)=FXDEF_FXTYPE_ECHO){
			note.noteno.4=4
			note.noteno.5=60
		}
	}
	e=1:gosub *refreshtitle
	return

#deffunc trackcursor int c
	if(vzoom(c)<=posnow*vtate*UNIT_MEASURE){
		posnow=vzoom(c)/(vtate*UNIT_MEASURE)
	}else:if(vzoom(c)>(posnow+vyoko)*vtate*UNIT_MEASURE){
		posnow=vzoom(c)/(vtate*UNIT_MEASURE)-vyoko+1
	}
	posnow=max(posnow,0)
	return

#deffunc _input str caption,array item,array type,array option,array ref,int enter,int flag
	if((inputnow=1)|(pendfl!=-1)):return -1
	inputnow=1
	dim hinput,length(item)
	gsel 0
	gmode 3,,,150
	color 0,0,0
	font lang.0.0,14
	dim sx1,4
	dim sy1,4
	sx1=0,ginfo_winx,ginfo_winx,0
	sy1=0,0,ginfo_winy,ginfo_winy
	gsquare -1,sx1,sy1
	color 255,255,255
	pos 64,48-40*((vtate=2)&(length(item)>=12))
	mes caption
	cy=ginfo_cy+24-14*((vtate=2)&(length(item)>=12))
	if(cnt!=length(item)-1):line ginfo_winx-90,cy-36+31+6*((vtate=2)&(length(item)>=12)),90,cy-36+31+6*((vtate=2)&(length(item)>=12))
	if(flag&INPUT_LARGEWIDTH){
		objsize ginfo_winx-460,21
	}else:objsize 200,21
	dim ref2,length(item)
	foreach item
		if(((option.cnt!="")&(option.cnt!="*"))|(type.cnt=0)):ref2.cnt=int(ref.cnt)
	loop
	dim hFont,length(item)
	foreach item
		if(type.cnt=2){
			font lang.0.0,12
			mref BMSCR, 67
			CreateFontIndirect varptr(BMSCR(49))
			hFont.cnt = stat
		}
	loop
	font lang.0.0,14
	foreach item
		pos 100,cy+5+3*((vtate=2)&(length(item)>=12))
		mes item.cnt
		pos 360,cy+3*((vtate=2)&(length(item)>=12))
		if(option.cnt!=""){
			if(option.cnt!="*"):combox ref2.cnt, 100, option.cnt
			hinput.cnt=stat
		}else{
			if(type.cnt=0){
				input ref2.cnt,,,256
				hinput.cnt=stat
			}else:if(type.cnt=1){
				input ref.cnt,,,256
				hinput.cnt=stat
			}else{
				//input ref.cnt,,,256
				//hinput.cnt=stat
				winobj "Edit", "", UNKNOWN, STYLE
				hinput.cnt = stat
				objskip hinput.cnt,1
				sendmsg objinfo_hwnd(hinput.cnt), WM_SETFONT, hFont.cnt, 1
				UTF8toUTF16 ref.cnt,refstat
				SetWindowTextW objinfo_hwnd(hinput.cnt), varptr(refstat)
			}
		}
		line ginfo_winx-90,cy+26,90,cy+26
		cy+=31-7*((vtate=2)&(length(item)>=12))
	loop
	pos ginfo_winx/2-170,cy+20-12*((vtate=2)&(length(item)>=12))
	objsize 160,24
	button gosub lang.0.60,*inputend
	hbutton1=stat
	pos ginfo_winx/2+10,cy+20-12*((vtate=2)&(length(item)>=12))
	button gosub lang.0.61,*inputend2
	hbutton2=stat
	objsel hinput.0
	f11_keyp=1
	while (inputnow=1)
		if(f11fl=1){
			getkey f11_key,122
			getkey shift_key,16
			if((f11_key=1)&(f11_keyp=0)&(ginfo2()!=-1)){// F11
				if(shift_key=1){
					split ref.8,";",fnsp
					objprm hinput.8,fnsp.0
				}else{
					if(ref2.5="0"){
						stat1="lt"
					}else:if(ref2.5="1"){
						stat1="ch"
					}else:if(ref2.5="2"){
						stat1="ex"
					}else:if(ref2.5="3"){
						stat1="in"
					}
					split ref.8,".",fnsp
					objprm hinput.8,fnsp.0+".ogg;"+fnsp.0+"_"+stat1+"_f.ogg"//+";"+fnsp.0+"_"+stat1+"_p.ogg;"+fnsp.0+"_"+stat1+"_fp.ogg"
				}
			}
			f11_keyp=f11_key
		}
		getkey escstat,27
		if((escstat=1)&(ginfo2()!=-1)):inputnow=3
		getkey enterstat,13
		if((enterstat=1)&(enter=1)&(ginfo2()!=-1)){
			inputnow=2
		}
		getkey ctrl_key,17
		if((enterstat=1)&((enter=2)|(ctrl_key=1))&(ginfo2()!=-1)){
			objsel -1
			if((stat=hbutton1)|(ctrl_key=1)){
				if(enterstatp=0):inputnow=2
			}else:objsel hbutton1
		}
		wait 1
		enterstatp=enterstat
	wend
	refval=2-inputnow
	foreach item
		if(((option.cnt!="")&(option.cnt!="*"))|(type.cnt=0)):ref.cnt=str(ref2.cnt)
		if(type.cnt=2){
			sdim refstat, 1024*2 + 2
			GetWindowTextW objinfo_hwnd(hinput.cnt), varptr(refstat), 1024
			UTF16toUTF8 refstat,refstat2
			ref.cnt=refstat2
		}
	loop
	foreach hinput
		clrobj hinput.cnt
	loop
	if(idTool>0){
		clrobj 0,idTool-1
	}
	clrobj idTool+1,-1// hinput.cnt,hinput.(length(item)-1)
	//clrobj hbutton1
	//clrobj hbutton2
	foreach item
		if(type.cnt=2):DeleteObject hFont.cnt
	loop
	gmode 0
	gosub *draw
	inputnow=0
	return refval

*inputend
	inputnow=2
	return

*inputend2
	inputnow=3
	return

*selinit
	/*
	repeat notenum-1
		cnt_2=cnt
		repeat notenum-1-cnt_2
			if(note.cnt.0=note.cnt_2.0){
				if(note.cnt.1=note.cnt_2.0){
					
				}
				break
			}
		loop
	loop*/
	selnotenum=0
	selanalognum=0
	selspinnum=0
	selstpnum=0
	lastseltype=-1
	lastsel=0
	selshift=0
	cnowflen=0
	return

*selinit2
	selnotenum=0
	selanalognum=0
	selspinnum=0
	selstpnum=0
	lastseltype=-1
	lastsel=0
	selshift=0
	return

*clipinit
	clipnotenum=0
	clipanalognum=0
	clipspinnum=0
	clipstpnum=0
	cliptiltnum=0
	clipztopnum=0
	clipzbotnum=0
	clipzsidenum=0
	return

*error
	onerror 0
	gosub *error2
	end

*error2
	dialog "#Error "+err+"\n"+replace(lang.0.6,"%0",""+err),3,lang.0.2
	if(stat=6){
		acmd=CMD_SAVEAS
		gosub *OnCommand
	}
	return

*new
	gosub *confirmsave
	if(confirmstat=2){
		acmd=-1
		return
	}
	fname=""
	isutf8=1
	gosub *selinit
	cnowf=0
	cnowflen=0

	BASS_StreamFree mid

	pendfl=-1
	dim note,131072,6
	sdim notesefname,256,131072

	clearKeySoundLibrary

	dim analog,131072,6
	dim spin,131072,6
	dim tilt,131072,3
	dim ztop,131072,3
	dim zbot,131072,3
	dim zside,131072,3
	dim anaran,131072,3
	dim bpml,131072,2
	dim stp,131072,2
	dim anagain,131072,3
	dim anafil,131072,3
	dim anvol,131072,3
	dim anse,131072,2
	dim beatl,131072,3
	dim comment,512
	sdim commentstr,512,1024
	dim div,131072
	notenum=0
	analognum=0
	dim chiprate,131072,2
	dim longrate,131072,2
	dim laserrate,131072,2
	chipratenum=0
	longratenum=0
	laserratenum=0
	userfxnum=0
	sdim userfx_name,16,256
	ddim userfx_params,256,10
	ddim userfx_params_enable,256,10
	userfilternum=0
	sdim userfilter_name,16,256
	ddim userfilter_params,256,10
	ddim userfilter_params_min,256,10
	ddim userfilter_params_max,256,10
	userchprmnum=0
	ddim userchprm,4096,6
	sdim swaudio,64,32
	swaudionum=0
	dim userfx_swaudiomid,256
	fxdefbuf_fx=""
	fxdefbuf_filter=""
	sharpstr=""
	commentnum=0
	spinnum=0
	divnum=0
	bpmlnum=1
	tiltnum=0
	ztopnum=0
	zbotnum=0
	zsidenum=0
	anarannum=0
	stpnum=0
	beatlnum=1
	beatl.0.0=0
	beatl.0.1=4
	beatl.0.2=4
	anagainnum=1
	anafilnum=1
	anvolnum=1
	ansenum=0
	bpm=120000
	bpml.0.1=120000
	anagain.0.1=50
	anafil.0.1=0
	anvol.0.1=50
	beat=4
	offset=0
	editdiv=16
	editmode=0
	edittarget=0
	csongtitle=""
	csongtitleimg=""
	csongtitle_a=""
	csongartist=""
	csongartistimg=""
	csongeffect=""
	csongjacket=".jpg"
	csongillustrator=""
	csonginfo=""
	csongicon=".png"
	csongv=""
	csongvoffset=0
	csongdifficulty=2
	csonglevel=1
	csongtotal=0
	csongoftbpm=0
	csongvol=75
	csongver = "" + CURRENT_KSH_VERSION
	csongver_int = CURRENT_KSH_VERSION
	csongfile=".mp3"
	bgname="desert"
	bgname_l="arrow"
	poffset=0
	plength=15000
	laserdelay1=40
	disableautoanvol=1
	posnow=0
	ud_cnt=0
	ud_cur=0
	ud_redomax=0
	gosub *refreshmenu_undo
	pendfl=-1
	dim analogparent,131072
	dim analogparentran,131072
	e=0
	gosub *refreshtitle
	gosub *draw
	return

*command_save
	savestat=1
	if(fname=""){
		acmd=CMD_SAVEAS
		if(saveasstat=0):savestat=0
		gosub *OnCommand
		acmd=-1:return
	}
	inputnow=1
	//stat1=0
	//repeat analognum
	//	if((analog.cnt.5=1)&(analog.cnt.3!=analog.cnt.0*50)):stat1=1:stat2=analog.cnt.0:stat3=c2b(analog.cnt.1)+1:break
	//loop
	//if((stat1=1)&(saveasstat=0)){
	//	if(stat2=0){
	//		dialog replace(lang.0.11,"\%0",""+stat3)/*"LEFT(青)LASERオブジェクトが正常でない位置から始まっている箇所があります。\n続行しますか?"*/,2,lang.0.10/*"注意"*/
	//	}else{
	//		dialog replace(lang.0.12,"\%0",""+stat3)/*"RIGHT(赤)LASERオブジェクトが正常でない位置から始まっている箇所があります。\n続行しますか?"*/,2,lang.0.10/*"注意"*/
	//	}
	//	if(stat=7){
	//		inputnow=0
	//		acmd=-1:return
	//	}
	//}
	if((csongtitle="")&(saveasstat=0)){
		dialog lang.0.15/*"曲のタイトル(title)が指定されていません。\n続行しますか?"*/,2,lang.0.10/*"注意"*/
		if(stat=7){
			dialog lang.0.16/*"曲のタイトル(title)は「ツール(T)」→「譜面に関する設定(T)」から編集できます。"*/
			inputnow=0
			acmd=-1:return
		}
	}
	inputnow=0
	if((strmid(fname,-1,4)!=".ksh")&(strmid(fname,-1,4)!=".ksh")):fname+=".ksh"
	exist fname
	if(strsize!=-1):bcopy fname,dir_default+"\\backup.bak"
	buf=bom
	buf+="title="+csongtitle+"\n"
	if(csongtitleimg!=""):buf+="title_img="+utf8enc(csongtitleimg)+"\n"
	buf+="artist="+csongartist+"\n"
	if(csongartistimg!=""):buf+="artist_img="+utf8enc(csongartistimg)+"\n"
	buf+="effect="+csongeffect+"\n"
	buf+="jacket="+utf8enc(csongjacket)+"\n"
	buf+="illustrator="+csongillustrator+"\n"
	if(csongdifficulty=0){
		buf+="difficulty=light\n"
	}else:if(csongdifficulty=1){
		buf+="difficulty=challenge\n"
	}else:if(csongdifficulty=2){
		buf+="difficulty=extended\n"
	}else{
		buf+="difficulty=infinite\n"
	}
	buf+="level="+csonglevel+"\n"
	singlebpm=0
	if(bpmlnum=1){
		stat1=str(double(bpml.0.1)/1000)
		stat1=strtrim(stat1,2,'0')
		buf+="t="+strtrim(stat1,2,'.')+"\n"
	}else{
		bpmmin=bpml.0.1
		bpmmax=bpml.0.1
		repeat max(bpmlnum-1,0),1
			if(bpmmin>bpml.cnt.1):bpmmin=bpml.cnt.1
			if(bpmmax<bpml.cnt.1):bpmmax=bpml.cnt.1
		loop
		if(bpmmax=bpmmin){
			stat1=str(double(bpml.0.1)/1000)
			stat1=strtrim(stat1,2,'0')
			buf+="t="+strtrim(stat1,2,'.')+"\n"
			singlebpm=1
		}else{
			stat1=str(double(bpmmax)/1000)
			stat1=strtrim(stat1,2,'0')
			stat1=strtrim(stat1,2,'.')
			stat2=str(double(bpmmin)/1000)
			stat2=strtrim(stat2,2,'0')
			stat2=strtrim(stat2,2,'.')
			buf+="t="+stat2+"-"+stat1+"\n"
		}
	}
	stat2=str(double(csongoftbpm)/1000)
	stat2=strtrim(stat2,2,'0')
	stat2=strtrim(stat2,2,'.')
	if(csongoftbpm!=0):buf+="to="+stat2+"\n"
	buf+="m="+utf8enc(csongfile)+"\n"
	if(csongvol!=100):buf+="mvol="+csongvol+"\n"
	buf+="o="+offset+"\n"
	buf+="bg="+utf8enc(bgname)+"\n"

	// layer名の区切り文字置き換え(v1.67)
	if (csongver_int < 167) {
		bgname_l_ = bgname_l
		strrep bgname_l_,";","/"
		buf+="layer="+utf8enc(bgname_l_)+"\n"
	} else {
		buf+="layer="+utf8enc(bgname_l)+"\n"
	}

	buf+="po="+poffset+"\n"
	buf+="plength="+plength+"\n"
	if(csongv!=""){
		buf+="v="+utf8enc(csongv)+"\n"
		buf+="vo="+csongvoffset+"\n"
	}
	if(anagainnum>0){
		buf+="pfiltergain="+anagain.0.1+"\n"
	}
	if(anafilnum>0){
		stat2="peak"
		if(anafil.0.1=1):stat2="hpf1"
		if(anafil.0.1=2):stat2="hpf2"
		if(anafil.0.1=3):stat2="lpf1"
		if(anafil.0.1=4):stat2="lpf2"
		if(anafil.0.1=5):stat2="bitc"
		if(anafil.0.1=6):stat2="fx;bitc"
		if(anafil.0.1>=100):stat2=userfilter_name.(anafil.0.1-100-(userfxnum-userfilternum))
		buf+="filtertype="+stat2+"\n"
	}
	buf+="chokkakuautovol="+(1-disableautoanvol)+"\n"
	if(anvolnum>0){
		buf+="chokkakuvol="+anvol.0.1+"\n"
	}
	if(csongtotal>=100):buf+="total="+csongtotal+"\n"
	if(laserdelay1!=40):buf+="pfilterdelay="+laserdelay1+"\n"
	if(csonginfo!=""):buf+="information="+csonginfo+"\n"
	if((csongicon!="")&(csongicon!=".png")):buf+="icon="+utf8enc(csongicon)+"\n"
	buf += "ver=" + csongver + "\n"
	commentfcnt=0
	repeat commentnum
		if(comment.cnt<0){
			buf+=commentstr.cnt+"\n"
			commentfcnt=cnt+1
		}else:break
	loop
	buf+="--\n"
	dim notefcnt,6
	analogfcntl=0
	analogfcntr=0
	beatn=4
	beatd=4
	cbcnt=0
	beatlfcnt=0
	tiltp=0
	anagainp=anagain.0.1
	anafilp=anafil.0.1
	anvolp=anvol.0.1
	chipratep=1
	longratep=1
	laserratep=1
	sdim fxp,32,2
	fxp="*","*"
	repeat
		endfl=1
		repeat notenum
			if(note.cnt.1+note.cnt.2>=cbcnt):endfl=0:break
		loop
		if(endfl=1){
			repeat analognum
				if(analog.cnt.1+analog.cnt.2>=cbcnt):endfl=0:break
			loop
		}
		if(endfl=1){
			repeat spinnum
				if(spin.cnt.1+spin.cnt.2>=cbcnt):endfl=0:break
			loop
		}
		if(endfl=1){
			repeat bpmlnum
				if(bpml.cnt.0>=cbcnt):endfl=0:break
			loop
		}
		if(endfl=1){
			repeat beatlnum
				if(beatl.cnt.0>=cbcnt):endfl=0:break
			loop
		}
		if(endfl=1){
			repeat tiltnum
				if(tilt.cnt.0>=cbcnt):endfl=0:break
			loop
		}
		if(endfl=1){
			repeat stpnum
				if(stp.cnt.0>=cbcnt):endfl=0:break
			loop
		}
		if(endfl=1){
			repeat anagainnum
				if(anagain.cnt.0>=cbcnt):endfl=0:break
			loop
		}
		if(endfl=1){
			repeat anafilnum
				if(anafil.cnt.0>=cbcnt):endfl=0:break
			loop
		}
		if(endfl=1){
			repeat anvolnum
				if(anvol.cnt.0>=cbcnt):endfl=0:break
			loop
		}
		if(endfl=1){
			repeat ansenum
				if(anse.cnt.0>=cbcnt):endfl=0:break
			loop
		}
		if(endfl=1){
			repeat ztopnum
				if(ztop.cnt.0>=cbcnt):endfl=0:break
			loop
		}
		if(endfl=1){
			repeat zbotnum
				if(zbot.cnt.0>=cbcnt):endfl=0:break
			loop
		}
		if(endfl=1){
			repeat zsidenum
				if(zside.cnt.0>=cbcnt):endfl=0:break
			loop
		}
		if(endfl=1){
			repeat commentnum
				if(comment.cnt>=cbcnt):endfl=0:break
			loop
		}
		if(endfl=1):break
		repeat max(beatlnum-beatlfcnt,0),beatlfcnt
			if(beatl.cnt.0<=cbcnt){
				buf+="beat="+beatl.cnt.1+"/"+beatl.cnt.2+"\n"
				beatn=beatl.cnt.1
				beatd=beatl.cnt.2
				beatlfcnt=cnt+1
			}else:break
		loop
		buf2=""
		sdivn=UNIT_MEASURE*beatn/beatd
		xfl=0
		repeat notenum
			if((note.cnt.1>=cbcnt)&(note.cnt.1<cbcnt+UNIT_MEASURE*beatn/beatd)){
				if(note.cnt.1-cbcnt!=0):sdivn=gcd(gcd(note.cnt.1-cbcnt,UNIT_MEASURE*beatn/beatd),sdivn)
				if(note.cnt.2>0):xfl=1
			}
			if((note.cnt.1+note.cnt.2>=cbcnt)&(note.cnt.1+note.cnt.2<cbcnt+UNIT_MEASURE*beatn/beatd)){
				if(note.cnt.1+note.cnt.2-cbcnt!=0):sdivn=gcd(gcd(note.cnt.1+note.cnt.2-cbcnt,UNIT_MEASURE*beatn/beatd),sdivn)
				if(note.cnt.2>0):xfl=1
			}
		loop
		repeat analognum
			if((analog.cnt.1>=cbcnt)&(analog.cnt.1<cbcnt+UNIT_MEASURE*beatn/beatd)){
				if(analog.cnt.1-cbcnt!=0):sdivn=gcd(gcd(analog.cnt.1-cbcnt,UNIT_MEASURE*beatn/beatd),sdivn)
				xfl=1
			}
			if((analog.cnt.1+analog.cnt.2>=cbcnt)&(analog.cnt.1+analog.cnt.2<cbcnt+UNIT_MEASURE*beatn/beatd)){
				if(analog.cnt.1+analog.cnt.2-cbcnt!=0):sdivn=gcd(gcd(analog.cnt.1+analog.cnt.2-cbcnt,UNIT_MEASURE*beatn/beatd),sdivn)
				xfl=1
			}
		loop
		repeat spinnum
			if((spin.cnt.1>=cbcnt)&(spin.cnt.1<cbcnt+UNIT_MEASURE*beatn/beatd)){
				if(spin.cnt.1-cbcnt!=0):sdivn=gcd(gcd(spin.cnt.1-cbcnt,UNIT_MEASURE*beatn/beatd),sdivn)
			}
		loop
		repeat bpmlnum
			if((bpml.cnt.0>=cbcnt)&(bpml.cnt.0<cbcnt+UNIT_MEASURE*beatn/beatd)){
				if(bpml.cnt.0-cbcnt!=0):sdivn=gcd(gcd(bpml.cnt.0-cbcnt,UNIT_MEASURE*beatn/beatd),sdivn)
			}
		loop
		repeat tiltnum
			if((tilt.cnt.0>=cbcnt)&(tilt.cnt.0<cbcnt+UNIT_MEASURE*beatn/beatd)){
				if(tilt.cnt.0-cbcnt!=0):sdivn=gcd(gcd(tilt.cnt.0-cbcnt,UNIT_MEASURE*beatn/beatd),sdivn)
			}
		loop
		repeat stpnum
			if((stp.cnt.0>=cbcnt)&(stp.cnt.0<cbcnt+UNIT_MEASURE*beatn/beatd)){
				if(stp.cnt.0-cbcnt!=0):sdivn=gcd(gcd(stp.cnt.0-cbcnt,UNIT_MEASURE*beatn/beatd),sdivn)
			}
		loop
		repeat anagainnum
			if((anagain.cnt.0>=cbcnt)&(anagain.cnt.0<cbcnt+UNIT_MEASURE*beatn/beatd)){
				if(anagain.cnt.0-cbcnt!=0):sdivn=gcd(gcd(anagain.cnt.0-cbcnt,UNIT_MEASURE*beatn/beatd),sdivn)
			}
		loop
		repeat anafilnum
			if((anafil.cnt.0>=cbcnt)&(anafil.cnt.0<cbcnt+UNIT_MEASURE*beatn/beatd)){
				if(anafil.cnt.0-cbcnt!=0):sdivn=gcd(gcd(anafil.cnt.0-cbcnt,UNIT_MEASURE*beatn/beatd),sdivn)
			}
		loop
		repeat anvolnum
			if((anvol.cnt.0>=cbcnt)&(anvol.cnt.0<cbcnt+UNIT_MEASURE*beatn/beatd)){
				if(anvol.cnt.0-cbcnt!=0):sdivn=gcd(gcd(anvol.cnt.0-cbcnt,UNIT_MEASURE*beatn/beatd),sdivn)
			}
		loop
		repeat ansenum
			if((anse.cnt.0>=cbcnt)&(anse.cnt.0<cbcnt+UNIT_MEASURE*beatn/beatd)){
				if(anse.cnt.0-cbcnt!=0):sdivn=gcd(gcd(anse.cnt.0-cbcnt,UNIT_MEASURE*beatn/beatd),sdivn)
			}
		loop
		repeat ztopnum
			if((ztop.cnt.0>=cbcnt)&(ztop.cnt.0<cbcnt+UNIT_MEASURE*beatn/beatd)){
				if(ztop.cnt.0-cbcnt!=0):sdivn=gcd(gcd(ztop.cnt.0-cbcnt,UNIT_MEASURE*beatn/beatd),sdivn)
			}
		loop
		repeat zbotnum
			if((zbot.cnt.0>=cbcnt)&(zbot.cnt.0<cbcnt+UNIT_MEASURE*beatn/beatd)){
				if(zbot.cnt.0-cbcnt!=0):sdivn=gcd(gcd(zbot.cnt.0-cbcnt,UNIT_MEASURE*beatn/beatd),sdivn)
			}
		loop
		repeat zsidenum
			if((zside.cnt.0>=cbcnt)&(zside.cnt.0<cbcnt+UNIT_MEASURE*beatn/beatd)){
				if(zside.cnt.0-cbcnt!=0):sdivn=gcd(gcd(zside.cnt.0-cbcnt,UNIT_MEASURE*beatn/beatd),sdivn)
			}
		loop
		repeat commentnum
			if((comment.cnt>=cbcnt)&(comment.cnt<cbcnt+UNIT_MEASURE*beatn/beatd)){
				if(comment.cnt-cbcnt!=0):sdivn=gcd(gcd(comment.cnt-cbcnt,UNIT_MEASURE*beatn/beatd),sdivn)
			}
		loop
		sdiv=UNIT_MEASURE*beatn/beatd/sdivn
		if(sdiv<UNIT_MEASURE*beatn/beatd):sdiv*=1+xfl
		if((UNIT_MEASURE*beatn/beatd)\sdiv!=0):sdiv=UNIT_MEASURE*beatn/beatd
		repeat sdiv
			dim n,10
			dim fxvalue,2
			fxvalue=-1,-1
			dim fxvalue2,2
			fxvalue2=-1,-1
			cnt2=cnt
			stat1=0
			fcntstat=min(min(min(min(min(notefcnt.0,notefcnt.1),notefcnt.2),notefcnt.3),notefcnt.4),notefcnt.5)
			repeat notenum-fcntstat,fcntstat
				if(cbcnt>note.cnt.1+note.cnt.2){
					notefcnt.(note.cnt.0)=cnt
					continue
				}
				stat1=0
				if((note.cnt.1>=cbcnt)&(note.cnt.1<cbcnt+UNIT_MEASURE*beatn/beatd)){
					if((cnt2=(note.cnt.1-cbcnt)/(UNIT_MEASURE*beatn/beatd/sdiv))&(note.cnt.2=0)){
						n.(note.cnt.0)=1
						stat1=1
						if((note.cnt.0>3)&(notesefname.cnt!="")){
							buf2+="fx-"+str_lr.(note.cnt.0-4)+"_se="+notesefname.cnt+"\n"
						}
					}
				}
				if((note.cnt.1+note.cnt.2>=cbcnt)&(note.cnt.1<cbcnt+UNIT_MEASURE*beatn/beatd)&(stat1=0)){
					if((cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)>=note.cnt.1-cbcnt)&(cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)<note.cnt.1+note.cnt.2-cbcnt)&(note.cnt.2>0)){
						n.(note.cnt.0)=note.cnt.3*(note.cnt.1=cbcnt+cnt2*(UNIT_MEASURE*beatn/beatd/sdiv))+2
						if((note.cnt.1=cbcnt+cnt2*(UNIT_MEASURE*beatn/beatd/sdiv))&(note.cnt.3=0)&(note.cnt.0>3)):n.(note.cnt.0)=100
						if((note.cnt.0>3)&(note.cnt.1=cbcnt+cnt2*(UNIT_MEASURE*beatn/beatd/sdiv))){
							fxvalue.(note.cnt.0-4)=note.cnt.4
							fxvalue2.(note.cnt.0-4)=note.cnt.5
						}
					}
				}
				if(cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)<note.cnt.1-cbcnt):break
			loop
			repeat spinnum
				if((spin.cnt.1>=cbcnt)&(spin.cnt.1<cbcnt+UNIT_MEASURE*beatn/beatd)){
					if(cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)=spin.cnt.1-cbcnt){
						n.8=spin.cnt.0+1
						n.9=cnt
					}
				}
				if(cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)<spin.cnt.1-cbcnt):break
			loop
			if(bpmlnum>0){
				repeat bpmlnum-((bpmlnum=1)|singlebpm),((bpmlnum=1)|singlebpm)
					if((bpml.cnt.0>=cbcnt)&(bpml.cnt.0<cbcnt+UNIT_MEASURE*beatn/beatd)){
						if(cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)=bpml.cnt.0-cbcnt){
							stat1=str(double(bpml.cnt.1)/1000)
							stat1=strtrim(stat1,2,'0')
							buf2+="t="+strtrim(stat1,2,'.')+"\n"
						}
					}
				loop
			}
			repeat commentnum-commentfcnt,commentfcnt
				if((comment.cnt>=cbcnt)&(comment.cnt<cbcnt+UNIT_MEASURE*beatn/beatd)){
					if(cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)=comment.cnt-cbcnt){
						buf2+=commentstr.cnt+"\n"
						commentfcnt=cnt+1
					}
				}else:break
			loop
			repeat chipratenum
				if((chiprate.cnt.0>=cbcnt)&(chiprate.cnt.0<cbcnt+UNIT_MEASURE*beatn/beatd)){
					if((cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)=chiprate.cnt.0-cbcnt)&(chiprate.cnt.1!=chipratep)){
						buf2+="chiprate="+chiprate.cnt.1+"x\n"
						chipratep=chiprate.cnt.1
					}
				}
			loop
			repeat longratenum
				if((longrate.cnt.0>=cbcnt)&(longrate.cnt.0<cbcnt+UNIT_MEASURE*beatn/beatd)){
					if((cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)=longrate.cnt.0-cbcnt)&(longrate.cnt.1!=longratep)){
						buf2+="longrate="+longrate.cnt.1+"x\n"
						longratep=longrate.cnt.1
					}
				}
			loop
			repeat laserratenum
				if((laserrate.cnt.0>=cbcnt)&(laserrate.cnt.0<cbcnt+UNIT_MEASURE*beatn/beatd)){
					if((cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)=laserrate.cnt.0-cbcnt)&(laserrate.cnt.1!=laserratep)){
						buf2+="laserrate="+laserrate.cnt.1+"x\n"
						laserratep=laserrate.cnt.1
					}
				}
			loop
			if(anagainnum>0){
				repeat anagainnum-1,1
					if((anagain.cnt.0>=cbcnt)&(anagain.cnt.0<cbcnt+UNIT_MEASURE*beatn/beatd)){
						if((cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)=anagain.cnt.0-cbcnt)&(anagain.cnt.1!=anagainp)){
							buf2+="pfiltergain="+anagain.cnt.1+"\n"
							anagainp=anagain.cnt.1
						}
					}
				loop
			}
			if(anafilnum>0){
				repeat anafilnum-1,1
					if((anafil.cnt.0>=cbcnt)&(anafil.cnt.0<cbcnt+UNIT_MEASURE*beatn/beatd)){
						if((cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)=anafil.cnt.0-cbcnt)&(anafil.cnt.1!=anafilp)){
							stat2="peak"
							if(anafil.cnt.1=1):stat2="hpf1"
							if(anafil.cnt.1=2):stat2="hpf2"
							if(anafil.cnt.1=3):stat2="lpf1"
							if(anafil.cnt.1=4):stat2="lpf2"
							if(anafil.cnt.1=5):stat2="bitc"
							if(anafil.cnt.1=6):stat2="fx;bitc"
							if(anafil.cnt.1>=100):stat2=userfilter_name.(anafil.cnt.1-100-(userfxnum-userfilternum))
							buf2+="filtertype="+stat2+"\n"
							anafilp=anafil.cnt.1
						}
					}
				loop
			}
			if(anvolnum>0){
				repeat anvolnum-1,1
					if((anvol.cnt.0>=cbcnt)&(anvol.cnt.0<cbcnt+UNIT_MEASURE*beatn/beatd)){
						if((cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)=anvol.cnt.0-cbcnt)&(anvol.cnt.1!=anvolp)){
							buf2+="chokkakuvol="+anvol.cnt.1+"\n"
							anvolp=anvol.cnt.1
						}
					}
				loop
			}
			repeat ansenum
				if((anse.cnt.0>=cbcnt)&(anse.cnt.0<cbcnt+UNIT_MEASURE*beatn/beatd)){
					if(cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)=anse.cnt.0-cbcnt){
						switch anse.cnt.1
						case 1
							buf2+="chokkakuse=down\n"
							swbreak
						case 2
							buf2+="chokkakuse=up\n"
							swbreak
						case 3
							buf2+="chokkakuse=swing\n"
							swbreak
						case 4
							buf2+="chokkakuse=mute\n"
							swbreak
						swend
					}
				}
			loop
			repeat tiltnum
				if((tilt.cnt.0>=cbcnt)&(tilt.cnt.0<cbcnt+UNIT_MEASURE*beatn/beatd)){
					if((cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)=tilt.cnt.0-cbcnt)&((tilt.cnt.0!=0)|(tilt.cnt.1!=0))){
						if((tiltp!=tilt.cnt.1)|(tilt.cnt.1>6)):buf2+="tilt="+tiltname(tilt.cnt.1)+"\n"
						if(tilt.cnt.1!=tilt.cnt.2):buf2+="tilt="+tiltname(tilt.cnt.2)+"\n"
						tiltp=tilt.cnt.2
					}
				}
			loop
			repeat ztopnum
				if((ztop.cnt.0>=cbcnt)&(ztop.cnt.0<cbcnt+UNIT_MEASURE*beatn/beatd)){
					if(cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)=ztop.cnt.0-cbcnt){
						if(ztop.cnt.1!=ztop.cnt.2){
							buf2+="zoom_top="+ztop.cnt.1+"\nzoom_top="+ztop.cnt.2+"\n"
						}else:buf2+="zoom_top="+ztop.cnt.1+"\n"
					}
				}
			loop
			repeat zbotnum
				if((zbot.cnt.0>=cbcnt)&(zbot.cnt.0<cbcnt+UNIT_MEASURE*beatn/beatd)){
					if(cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)=zbot.cnt.0-cbcnt){
						if(zbot.cnt.1!=zbot.cnt.2){
							buf2+="zoom_bottom="+zbot.cnt.1+"\nzoom_bottom="+zbot.cnt.2+"\n"
						}else:buf2+="zoom_bottom="+zbot.cnt.1+"\n"
					}
				}
			loop
			repeat zsidenum
				if((zside.cnt.0>=cbcnt)&(zside.cnt.0<cbcnt+UNIT_MEASURE*beatn/beatd)){
					if(cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)=zside.cnt.0-cbcnt){
						if(zside.cnt.1!=zside.cnt.2){
							buf2+="zoom_side="+zside.cnt.1+"\nzoom_side="+zside.cnt.2+"\n"
						}else:buf2+="zoom_side="+zside.cnt.1+"\n"
					}
				}
			loop
			repeat analognum
				if((analog.cnt.1>=cbcnt)&(analog.cnt.1<cbcnt+UNIT_MEASURE*beatn/beatd)&(analogparentran.cnt=2)&(analog.cnt.5=1)){
					if(cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)=analog.cnt.1-cbcnt){
						if(analog.cnt.0=0):buf2+="laserrange_l=2x\n"
						if(analog.cnt.0=1):buf2+="laserrange_r=2x\n"
					}
				}
			loop
			repeat stpnum
				if((stp.cnt.0>=cbcnt)&(stp.cnt.0<cbcnt+UNIT_MEASURE*beatn/beatd)){
					if(cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)=stp.cnt.0-cbcnt){
						buf2+="stop="+stp.cnt.1+"\n"
					}
				}
			loop
			repeat analognum-analogfcntl,analogfcntl
				if(analog.cnt.0>0):continue
				if(cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)>analog.cnt.1+analog.cnt.2-cbcnt){
					analogfcntl=cnt
					continue
				}
				if((cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)>analog.cnt.1-cbcnt)&(cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)<analog.cnt.1+analog.cnt.2-cbcnt)){
					n.(analog.cnt.0+6)=-1
				}
				if(cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)=analog.cnt.1-cbcnt){
					n.(analog.cnt.0+6)=analog.cnt.3+1
				}
				if(cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)=analog.cnt.1+analog.cnt.2-cbcnt){
					n.(analog.cnt.0+6)=analog.cnt.4+1
				}
				if(cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)<analog.cnt.1-cbcnt):break
			loop
			repeat analognum-analogfcntr,analogfcntr
				if(analog.cnt.0<1):continue
				if(cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)>analog.cnt.1+analog.cnt.2-cbcnt){
					analogfcntr=cnt
					continue
				}
				if((cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)>analog.cnt.1-cbcnt)&(cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)<analog.cnt.1+analog.cnt.2-cbcnt)){
					n.(analog.cnt.0+6)=-1
				}
				if(cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)=analog.cnt.1-cbcnt){
					n.(analog.cnt.0+6)=analog.cnt.3+1
				}
				if(cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)=analog.cnt.1+analog.cnt.2-cbcnt){
					n.(analog.cnt.0+6)=analog.cnt.4+1
				}
				if(cnt2*(UNIT_MEASURE*beatn/beatd/sdiv)<analog.cnt.1-cbcnt):break
			loop
			nl="-"
			nr="-"
			if(n.6=-1):nl=":"
			if(n.7=-1):nr=":"
			if((n.6>0)&(n.6<52)):nl=p2a(n.6-1)
			if((n.7>0)&(n.7<52)):nr=p2a(n.7-1)
			stat3=""
			if(n.8>0){
				//stat3+="@"
				if(n.8=1):stat3+="@("
				if(n.8=2):stat3+="@)"
				if(n.8=3):stat3+="@<"
				if(n.8=4):stat3+="@>"
				if(n.8=5):stat3+="S<"
				if(n.8=6):stat3+="S>"
				stat3+=str(spin.(n.9).2)
				if((n.8=5)|(n.8=6)){
					stat3+=";"+str(spin.(n.9).3)+";"+str(spin.(n.9).4)+";"+str(spin.(n.9).5)
				}
			}
			if(n.8<0){
				stat3+="/"
				stat3+=str(n.9)
			}
			sdim ns,1,6
			repeat 6
				ns.cnt="0"
				if(n.cnt=1){
					if(cnt<=3){
						ns.cnt="1"
					}else{
						ns.cnt="2"
						fxp.(cnt-4)="*"
					}
				}else:if(n.cnt=2){
					if(cnt<=3){
						ns.cnt="2"
					}else{
						ns.cnt="1"
					}
				}else:if(n.cnt<=0){
					ns.cnt="0"
					if(cnt>3):fxp.(cnt-4)="*"
				}else:if(cnt>3){
					ns.cnt="1"
					fxcur=""
					if(n.cnt=3){
						fxcur="Retrigger;"+fxvalue.(cnt-4)
					}else:if(n.cnt=4){
						fxcur="Retrigger;12"
					}else:if(n.cnt=5){
						fxcur="Retrigger;16"
					}else:if(n.cnt=6){
						fxcur="Retrigger;24"
					}else:if(n.cnt=7){
						fxcur="Retrigger;32"
					}else:if(n.cnt=8){
						fxcur="Gate;"+fxvalue.(cnt-4)
					}else:if(n.cnt=9){
						fxcur="Gate;8"
					}else:if(n.cnt=10){
						fxcur="Gate;12"
					}else:if(n.cnt=11){
						fxcur="Gate;16"
					}else:if(n.cnt=12){
						fxcur="Gate;24"
					}else:if(n.cnt=13){
						fxcur="Gate;32"
					}else:if(n.cnt=14){
						fxcur="Flanger"
					}else:if(n.cnt=15){
						fxcur="PitchShift;"+fxvalue.(cnt-4)
					}else:if(n.cnt=16){
						fxcur="BitCrusher;"+fxvalue.(cnt-4)
					}else:if(n.cnt=17){
						fxcur="Phaser"
					}else:if(n.cnt=18){
						fxcur="Wobble;"+fxvalue.(cnt-4)
					}else:if(n.cnt=19){
						fxcur="TapeStop;"+fxvalue.(cnt-4)
					}else:if(n.cnt=20){
						fxcur="Echo;"+fxvalue.(cnt-4)+";"+fxvalue2.(cnt-4)
					}else:if(n.cnt=21){
						fxcur="SideChain"
					}else:if(n.cnt=100){
						fxcur=""
					}else:if(n.cnt>=102){
						fxcur=""+userfx_name.(n.cnt-102)
						if((int(userfx_params.(n.cnt-102).0)=FXDEF_FXTYPE_RETR)|(int(userfx_params.(n.cnt-102).0)=FXDEF_FXTYPE_GATE)|(int(userfx_params.(n.cnt-102).0)=FXDEF_FXTYPE_WOBB)|(int(userfx_params.(n.cnt-102).0)=FXDEF_FXTYPE_BITC)|(int(userfx_params.(n.cnt-102).0)=FXDEF_FXTYPE_TSTP)|(int(userfx_params.(n.cnt-102).0)=FXDEF_FXTYPE_PITC)){
							fxcur+=";"+fxvalue.(cnt-4)
						}else:if(int(userfx_params.(n.cnt-102).0)=FXDEF_FXTYPE_ECHO){
							fxcur+=";"+fxvalue.(cnt-4)+";"+fxvalue2.(cnt-4)
						}
					}
					if(fxp.(cnt-4)!=fxcur){
						buf2+="fx-"+str_lr.(cnt-4)+"="+fxcur+"\n"
						fxp.(cnt-4)=fxcur
					}
				}
			loop
			buf2+=""+ns.0+ns.1+ns.2+ns.3+"|"+ns.4+ns.5+"|"+nl+nr+stat3+"\n"
		loop
		buf+=buf2+"--\n"
		cbcnt+=UNIT_MEASURE*beatn/beatd
	loop
	buf+=fxdefbuf_fx
	buf+=fxdefbuf_filter
	buf+=sharpstr
	notesel buf
	notesave fname
	e=0:gosub *refreshtitle
	return

*saveconfig
	confs=""
	dir_curp=dir_cur
	dim confex,9
	repeat length(confstr)
		if(StartsWith(confstr.cnt, "currentlang=")):confex.0=1
		if(StartsWith(confstr.cnt, "editor_disabledd=")):confex.1=1
		if(StartsWith(confstr.cnt, "editor_assisttick=")):confex.2=1
		if(StartsWith(confstr.cnt, "editor_reducespacing=")):confex.3=1
		if(StartsWith(confstr.cnt, "editor_zoomlanex=")):confex.4=1
		if(StartsWith(confstr.cnt, "editor_increasewinsize=")):confex.5=1
		if(StartsWith(confstr.cnt, "editor_measurepercolumn=")):confex.6=1
		if(StartsWith(confstr.cnt, "editor_linebrightness=")):confex.7=1
		if(StartsWith(confstr.cnt, "editor_loopplayback=")):confex.8=1
	loop
	ex=0
	cex=-1
	foreach confex
		if(confex.cnt=0):ex++
	loop
	repeat length(confstr)+ex
		if(cnt=length(confstr)+ex-1){
			stat1=""
		}else{
			stat1="\n"
		}
		if(cnt>=length(confstr)){
			repeat length(confex)-cex-1,cex+1
				if(confex.cnt=0):cex=cnt:break
			loop
		}
		if((StartsWith(confstr.cnt, "currentlang="))|(cex=0)){
			confs+="currentlang="+clang+stat1
		}else:if((StartsWith(confstr.cnt, "editor_disabledd="))|(cex=1)){
			confs+="editor_disabledd="+disabledd+stat1
		}else:if((StartsWith(confstr.cnt, "editor_assisttick="))|(cex=2)){
			confs+="editor_assisttick="+assisttick+stat1
		}else:if((StartsWith(confstr.cnt, "editor_reducespacing="))|(cex=3)){
			stat2=0
			if(vsep=24):stat2=0
			if(vsep=72):stat2=-1
			if(vsep=7):stat2=1
			confs+="editor_reducespacing="+stat2+stat1
		}else:if((StartsWith(confstr.cnt, "editor_zoomlanex="))|(cex=4)){
			confs+="editor_zoomlanex="+vzoomx+stat1
		}else:if((StartsWith(confstr.cnt, "editor_increasewinsize="))|(cex=5)){
			confs+="editor_increasewinsize="+maximize+stat1
		}else:if((StartsWith(confstr.cnt, "editor_measurepercolumn="))|(cex=6)){
			confs+="editor_measurepercolumn="+vtate+stat1
		}else:if((StartsWith(confstr.cnt, "editor_linebrightness="))|(cex=7)){
			confs+="editor_linebrightness="+linebright+stat1
		}else:if((StartsWith(confstr.cnt, "editor_loopplayback="))|(cex=8)){
			confs+="editor_loopplayback="+loopplayback+stat1
		}else{
			confs+=confstr.cnt+stat1
		}
	loop
	notesel confs
	split confs,"\n",confstr
	chdir dir_default
	notesave "config.ini"
	chdir dir_curp
	return

*playing
	if(pendfl!=-1){
		pendfl=1
		acmd=-1:return
	}
	if(pstartfl=1){
		return
	}
	getkey ctrl_key,17
	bpmhalf=_bpmhalf|ctrl_key
	pstartfl=1
	drawall=0
	redr=0
	gosub *draw
	mplayfl=0
	peffect=0
	feffect=0
	mid2=-1

	// 直角音を読み込む
	loadLaserSlamSounds csongver_int

	sdim csongflist,256,1
	split csongfile,";",csongflist
	if(fname != "" & fileExists(getpath(fname,32)+csongflist.0)){
		stat1=min(max(stat-1,0),3)
		repeat stat1
			exist getpath(fname,32)+csongflist.stat1
			if(strsize!=-1):break
			stat1--
		loop
		if(stat1=0):feffect=1
		if(preview_fx=0){
			if((stat1=1)|(stat1=3)):stat1--
			feffect=0
		}
		if(stat1<=1):peffect=1
		if(preview_laser=0){
			if((stat1=2)|(stat1=3)):stat1-=2
			peffect=0
		}
		dim user_now,max(userfxnum,1)
		exist getpath(fname,32)+csongflist.stat1
		if(strsize!=-1){
			filepath=getpath(fname,32)+csongflist.(min(stat1,3))
			sdim mdata,strsize
			bload filepath,mdata
			mid=BASS_StreamCreateFile(1,varptr(mdata),0,0,strsize,0,0x20000+0x200000*(bpmhalf=1))
			dim mid_sw,swaudionum
			repeat swaudionum*(feffect=1)
				exist getpath(fname,32)+swaudio.cnt
				if(strsize>0){
					filepath=getpath(fname,32)+swaudio.cnt
				}else{
					filepath=getpath(fname,32)+csongflist.(min(stat1,3))
					filepath=getpath(filepath,32)+swaudio.cnt
				}
				mid_sw.cnt=BASS_StreamCreateFile(0,filepath,0,0,0,0,0x20000+0x200000*(bpmhalf=1))
			loop
			if(bpmhalf=1){
				mid2=mid
				mid=BASS_FX_TempoCreate(mid2,0)
				BASS_ChannelSetAttribute mid,0x10000,-50.0f
				dim mid_sw2,swaudionum
				repeat swaudionum*(feffect=1)
					mid_sw2.cnt=mid_sw.cnt
					mid_sw.cnt=BASS_FX_TempoCreate(mid_sw2.cnt,0)
					BASS_ChannelSetAttribute mid_sw.cnt,0x10000,-50.0f
				loop
			}
			BASS_ChannelSetAttribute mid,2,double(vol)/100
			repeat swaudionum*(feffect=1)
				BASS_ChannelSetAttribute mid_sw.cnt,2,double(vol)/100
			loop
			mlength=BASS_ChannelGetLength_ms(mid)*(1+bpmhalf)
			hCompFX=BASS_ChannelSetFX(mid,0x10011,0)
			dim compfx,6
			compfx=tofloat(18.0f),tofloat(-24.0f),tofloat(100.0f),tofloat(1.0f),tofloat(0.01f),-1
			BASS_FXSetParameters hCompFX,compfx
			dim hCompFX_sw,swaudionum
			repeat swaudionum*(feffect=1)
				hCompFX_sw.cnt=BASS_ChannelSetFX(mid_sw.cnt,0x10011,0)
				BASS_FXSetParameters hCompFX_sw.cnt,compfx
			loop
			if(feffect=1){
				dim hFX_Echo,2
				repeat 2
					hFX_Echo.cnt=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\regawo.dll",0,26)
					BASS_VST_SetParam hFX_Echo.cnt,2,1.00f
				loop
				hFX_Retr=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\regawo.dll",0,25)
				BASS_VST_SetParam hFX_Retr,2,0.70f
				hFX_Pitc=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\pitc.dll",0,20)
				BASS_VST_SetParam hFX_Pitc,0,0.0f/48.0f/2.0f+0.50f
				BASS_VST_SetParam hFX_Pitc,1,700.0f/44100.0f
				BASS_VST_SetParam hFX_Pitc,2,0.40f*2.0f
				BASS_VST_SetParam hFX_Pitc,3,0.0f
				hFX_BitC=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\bitc.dll",0,19)
				BASS_VST_SetParam hFX_BitC,0,0
				dim hFX_TStp,2
				hFX_TStp.0=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\tstp.dll",0,19)
				hFX_TStp.1=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\tstp.dll",0,18)
				hFX_Gate=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\regawo.dll",0,17)
				BASS_VST_SetParam hFX_Gate,7,0.50f
				BASS_VST_SetParam hFX_Gate,8,0.90f
				BASS_VST_SetParam hFX_Gate,10,500.0f/22050.0f
				BASS_VST_SetParam hFX_Gate,11,20000.0f/22050.0f
				BASS_VST_SetParam hFX_Gate,12,1.414f/50.0f
				BASS_VST_SetParam hFX_Gate,13,0.80f
				hFX_Phas=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\phas.dll",0,16)
				BASS_VST_SetParam hFX_Phas,0,0.25f
				BASS_VST_SetParam hFX_Phas,1,0.0f
				BASS_VST_SetParam hFX_Phas,2,1500.0f/22050.0f
				BASS_VST_SetParam hFX_Phas,3,20000.0f/22050.0f
				BASS_VST_SetParam hFX_Phas,4,0.707f/50.0f
				BASS_VST_SetParam hFX_Phas,5,0.35f
				BASS_VST_SetParam hFX_Phas,6,0.75f
				BASS_VST_SetParam hFX_Phas,7,8.0f/20.0f
				BASS_VST_SetParam hFX_Phas,8,0.0f
				hFX_Flan=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\flan.dll",0,15)
				BASS_VST_SetParam hFX_Flan,0,0.25f
				BASS_VST_SetParam hFX_Flan,1,30.0f/44100.0f
				BASS_VST_SetParam hFX_Flan,2,45.0f/44100.0f
				BASS_VST_SetParam hFX_Flan,3,0.60f
				BASS_VST_SetParam hFX_Flan,4,0.0f
				BASS_VST_SetParam hFX_Flan,5,0.75f
				BASS_VST_SetParam hFX_Flan,6,0.0f
				hFX_SiCh=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\sich.dll",0,14)
				BASS_VST_SetParam hFX_SiCh,1,0.0050f
				BASS_VST_SetParam hFX_SiCh,2,0.0f
				BASS_VST_SetParam hFX_SiCh,3,0.0010f
				dim hFX_User,userfxnum+userfilternum
				repeat userfxnum
					if(fxdef_dllname.(int(userfx_params.cnt.0))=""):hFX_User.cnt=-1:continue
					hFX_User.cnt=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\"+fxdef_dllname.(int(userfx_params.cnt.0)),0,fxdef_priority.(int(userfx_params.cnt.0)))
					cnt2=cnt
					repeat fxdef_prmnum.(int(userfx_params.cnt2.0)),1
						if((userfx_params.cnt2.cnt<0.0f)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)){
							BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(-userfx_params.cnt2.cnt/10.0f,0.0f),1.0f)*(1+bpmhalf)
						}else:if(fxdef_max.cnt.(int(userfx_params.cnt2.0))>0.0f){
							BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(fxdef_prmmax.cnt.(int(userfx_params.cnt2.0))*userfx_params.cnt2.cnt/fxdef_max.cnt.(int(userfx_params.cnt2.0)),0.0f),1.0f)
						}else:if((userfx_params.cnt2.cnt>0.0f)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)&(fxdef_linkprm.(int(userfx_params.cnt2.0))=cnt)){
							user_now.cnt2=int(1.0f/userfx_params.cnt2.cnt)
						}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_PITCH)){
							// PitchShift pitch
							BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),maxf(minf(absf(userfx_params.cnt2.cnt),1.0f),0.0f)
						}
					loop
					// ByPassの設定
					BASS_VST_SetParam hFX_User.cnt,29,1.0f
				loop
			}
			//if(csongvol>100){
				hVolFX=BASS_ChannelSetFX(mid.0,0x10003,5)
				dim volfx,2
				volfx=0,tofloat(double(csongvol)/10.0f/100.0f)
				BASS_FXSetParameters hVolFX,volfx
				dim hVolFX_sw,swaudionum
				repeat swaudionum*(feffect=1)
					volfx=0,tofloat(double(csongvol)/10.0f/100.0f)
					hVolFX_sw.cnt=BASS_ChannelSetFX(mid_sw.cnt,0x10003,5)
					BASS_FXSetParameters hVolFX_sw.cnt,volfx
				loop
			//}
			hBitCFX=BASS_VST_ChannelSetDSP(mid,dir_default+"\\lib\\bitc.dll",0,0)
			BASS_VST_SetParam hBitCFX,0,0.0f
			dim hBitCFX_sw,swaudionum
			repeat swaudionum*(feffect=1)
				hBitCFX_sw.cnt=BASS_VST_ChannelSetDSP(mid_sw.cnt,dir_default+"\\lib\\bitc.dll",0,0)
				BASS_VST_SetParam hBitCFX_sw.cnt,0,0.0f
			loop
			mplayfl=1
		}
	}
	repeat anagainnum
		anagain.cnt.2=c2t(anagain.cnt.0)
	loop
	repeat anafilnum
		anafil.cnt.2=c2t(anafil.cnt.0)
	loop
	repeat anvolnum
		anvol.cnt.2=c2t(anvol.cnt.0)
	loop
	analoganjnum=0
	dim analoganj,131072,3
	repeat analognum
		if((analog.cnt.2<=UNIT_MEASURE/32)&(analog.cnt.3!=analog.cnt.4)){
			analoganj.analoganjnum.0=analog.cnt.0
			analoganj.analoganjnum.1=cnt
			analoganjnum++
		}
	loop
	repeat analoganjnum
		stat1=cnt
		repeat ansenum
			if(anse.cnt.0=analog.(analoganj.stat1.1).1){
				analoganj.stat1.2=anse.cnt.1
				break
			}
		loop
	loop
	cnow=min(cnowf,cnowf+cnowflen)
	cnowft=c2t(cnow)
	if((synchro=1)&((vzoom(cnow)/UNIT_MEASURE/vtate-vyk/2>=posnow)|(vzoom(cnow)/UNIT_MEASURE/vtate<posnow))){
		if(vzoom(cnow)/UNIT_MEASURE/vtate-vyk/2>=posnow){
			_stat1=min(abs(((vzoom(cnow)\(UNIT_MEASURE*vtate))*(41+9*2+vsp)/UNIT_MEASURE/vtate+(vzoom(cnow)/UNIT_MEASURE/vtate-posnow-vyk/2)*(vzoom(cnow)\(UNIT_MEASURE*vtate))*(41+9*2+vsp)/UNIT_MEASURE/vtate+(vzoom(cnow)/UNIT_MEASURE/vtate-posnow-vyk/2)*(41+9*2+vsp))*3/(41+9*2+vsp)),24)
		}else{
			_stat1=min(abs(((vzoom(cnow)\(UNIT_MEASURE*vtate))*(41+9*2+vsp)/UNIT_MEASURE/vtate-(posnow-vzoom(cnow)/UNIT_MEASURE/vtate)*(vzoom(cnow)\(UNIT_MEASURE*vtate))*(41+9*2+vsp)/UNIT_MEASURE/vtate-(posnow-vzoom(cnow)/UNIT_MEASURE/vtate)*(41+9*2+vsp))*3/(41+9*2+vsp)),24)
		}
		if(_stat1>=1){
			repeat _stat1,1
				cnt3=cnt
				redraw 0
				gsel 0
				pos 0,0
				color 0,0,0
				boxf
				gmode 5,,,256
				repeat vyk
					cnt2=cnt
					repeat vtate
						if(vzoom(cnow)/UNIT_MEASURE/vtate-vyk/2>=posnow){
							pos vsep/2+cnt2*(41+9*2+vsp)-(41+9*2)/2*(vzoomx=0)-(41+9*2)*3/4*(vzoomx=1)-cnt3*((vzoom(cnow)\(UNIT_MEASURE*vtate))*(41+9*2+vsp)/UNIT_MEASURE/vtate+(vzoom(cnow)/UNIT_MEASURE/vtate-posnow-vyk/2)*(41+9*2+vsp))/_stat1,topsep-10+vUNIT_MEASURE*(vtate-cnt-1)
						}else{
							pos vsep/2+cnt2*(41+9*2+vsp)-(41+9*2)/2*(vzoomx=0)-(41+9*2)*3/4*(vzoomx=1)-cnt3*((vzoom(cnow)\(UNIT_MEASURE*vtate))*(41+9*2+vsp)/UNIT_MEASURE/vtate-(posnow-vzoom(cnow)/UNIT_MEASURE/vtate)*(41+9*2+vsp))/_stat1,topsep-10+vUNIT_MEASURE*(vtate-cnt-1)
						}
						if(vzoomx=0){
							gcopy 6,0,vUNIT_MEASURE*(vtate*vyoko-1)-vUNIT_MEASURE*(cnt2*vtate+cnt),(41+9*2)*2,vUNIT_MEASURE+(cnt=0)
						}else{
							gsel BUF_ZOOMTEMP
							pos 0,0
							gzoom (41+9*2)*3,vUNIT_MEASURE+(cnt=0),6,0,vUNIT_MEASURE*(vtate*vyoko-1)-vUNIT_MEASURE*(cnt2*vtate+cnt),(41+9*2)*2,vUNIT_MEASURE+(cnt=0),0
							gsel 0
							gcopy BUF_ZOOMTEMP,0,0,(41+9*2)*3,vUNIT_MEASURE+(cnt=0)
						}
					loop
				loop
				redraw 1
				await 9
			loop
		}
		if(cnow/UNIT_MEASURE/vtate<posnow){
			posnow=cnow/UNIT_MEASURE/vtate
			gosub *draw
		}
	}
	dim notet,notenum
	repeat notenum
		notet.cnt=c2t(note.cnt.1)
	loop
	dim noteendt,notenum
	repeat notenum
		noteendt.cnt=c2t(note.cnt.1+note.cnt.2)
	loop
	dim notesej, notenum, 4
	notesejnum = 0
	repeat notenum
		if (notesefname.cnt != "") {
			notesej.notesejnum.0 = cnt
			notesej.notesejnum.1 = 1 // 判定(オートのため1)

			sdim splitstat, 1
			split notesefname.cnt, ";", splitstat
			if (length(splitstat) = 1) {
				notesej.notesejnum.3 = 100
			} else {
				notesej.notesejnum.3 = int(splitstat.1)
			}
			_stat1 = splitstat.0

			loadKeySoundToLibrary _stat1, getpath(fname, 32), csongver_int
			if (keySoundExistsInLibrary(_stat1)) {
				notesej.notesejnum.2 = getKeySoundFromLibrary(_stat1) // 再生するKeySoundへのポインタ
				notesejnum++
			}
		}
	loop
	notesejfcnt=0
	dim analogconnect,analognum
	repeat analognum
		if(analog.cnt.2>UNIT_MEASURE/32):continue
		// 後ろに繋がっているものがあるか探索
		stattype=analog.cnt.0
		statpos=analog.cnt.1+analog.cnt.2
		f2=0
		repeat max(analognum-cnt-1,0),cnt+1
			if((analog.cnt.1=statpos)&(analog.cnt.0=stattype)&(analog.cnt.2>0)){
				f2=1
				break
			}
			if(analog.cnt.1>statpos):break
		loop
		analogconnect.cnt=f2
	loop
	dim analogt,analognum,2
	/*
	repeat analognum
		analogt.cnt.0=c2t(analog.cnt.1)
		analogt.cnt.1=c2t(analog.cnt.1+analog.cnt.2)
	loop
	*/
	dim bpmlt,bpmlnum
	repeat bpmlnum
		bpmlt.cnt=c2t(bpml.cnt.0)
	loop
	cnowplus=0
	if((cnowf=0)|(cnowf+cnowflen=0)){
		cnowf++
		cnowplus=1
	}
	t_end=max(c2t(max(cnowf,cnowf+cnowflen)),c2t(min(cnowf,cnowf+cnowflen))+60)
	bpmp=0
	bpmfxp=0
	pstartfl=0
	repeat 512// ループ再生用のループ
		cnt_loop=cnt
		if((mplayfl=1)&(peffect+peffect2=2)&(pefftype!=-1)){
			hPeakFX=BASS_ChannelSetFX(mid,0x10013,2)
			hPeakFX2=BASS_ChannelSetFX(mid,0x10013,3)
			dim hPeakFX_sw,swaudionum
			dim hPeakFX2_sw,swaudionum
			repeat swaudionum*(feffect=1)
				hPeakFX_sw.cnt=BASS_ChannelSetFX(mid_sw.cnt,0x10013,2)
				hPeakFX2_sw.cnt=BASS_ChannelSetFX(mid_sw.cnt,0x10013,3)
			loop
		}
		mfl=0
		//ot=0
		ot=d3timer()-c2t(min(cnowf,cnowf+cnowflen))+laserdelay0*((feffect=1)&(cnt_loop=0))
		t_mo=0
		pendfl=0
		t_moex=-offset//(1+bpmhalf)
		tp=0
		tpp=0
		ldelayresett=-5000
		cnow=min(cnowf,cnowf+cnowflen)
		cnowp=min(cnowf,cnowf+cnowflen)
		cnowfx=0
		cnowfxp=0
		cnowfxp_50ms=0
		dim tickp,6
		repeat 6
			tickp.cnt=-1
		loop
		tickcp0=-50000
		tickcp1=-50000
		dim chokkakup,2
		chokkakup=-1,-1
		filtertypep=0
		anagainfcnt_play=0
		anafilfcnt_play=0
		anafilfcnt_play_real=0
		anvolfcnt_play=0
		analogjfcnt=0,0
		posnowp=posnow
		stopcnt=0
		shuwat=-50000
		ddim shuwapos,1
		shuwapos=1000.0f
		tshift=0
		enda=0
		canagainp=0
		retr_beat=-1
		retr_beatp=-2
		sich_trigger=0
		dim user_trigger,max(userfxnum,1)
		sich_beat=-1
		sich_beatp=-2
		dim user_beat,max(userfxnum,1)
		dim user_beatp,max(userfxnum,1)
		retr_now=0
		gate_now=0
		wobble_now=0
		dim echo_trigger,2
		dim echo_now,2
		c2bnow=0
		c2bnowp=0
		c2bnowp_50ms=0
		delayfl=0
		iscnowfjust=(cnowf=b2c(c2b(cnowf)))
		dim feffectnow,2
		dim feffectp,2
		dim feffectnow_real,2
		dim feffectp_real,2
		dim feffectparam,2
		dim feffectparam2,2
		dim notefcnt_feffect,2
		userchprmfcnt=0
		ddim _userfx_params,userfxnum,length2(userfx_params)
		ddim _userfx_params_enable,userfxnum,length2(userfx_params_enable)
		repeat userfxnum
			_cnt=cnt
			repeat length2(userfx_params)
				_userfx_params._cnt.cnt=userfx_params._cnt.cnt
				_userfx_params_enable._cnt.cnt=userfx_params_enable._cnt.cnt
			loop
		loop
		ddim _userfilter_params,userfilternum,length2(userfilter_params)
		ddim _userfilter_params_min,userfilternum,length2(userfilter_params_min)
		ddim _userfilter_params_max,userfilternum,length2(userfilter_params_max)
		repeat userfilternum
			_cnt=cnt
			repeat length2(userfilter_params)
				_userfilter_params._cnt.cnt=userfilter_params._cnt.cnt
				_userfilter_params_min._cnt.cnt=userfilter_params_min._cnt.cnt
				_userfilter_params_max._cnt.cnt=userfilter_params_max._cnt.cnt
			loop
		loop
		peffstat2p=0
		swaudionow=-1
		swaudionow_resultp=-1
		repeat
			if(enda=1):break
			if((mfl=0)|(mplayfl=0)){
				t=(d3timer()-ot)/(1+bpmhalf)
			}else{
				BASS_ChannelUpdate mid
				repeat swaudionum*(feffect=1)
					BASS_ChannelUpdate mid_sw.cnt
				loop
				t=BASS_ChannelGetPosition_ms(mid)+t_mo
			}
			tfx_diff=d3timer()
			cnow=0
			tt=0
			if(bpmlnum>0){
				cnt2=0
				repeat bpmlnum-1
					if(bpmlt.(cnt+1)/(1+bpmhalf)<t){
						tt=bpmlt.(cnt+1)/(1+bpmhalf)
						cnow+=bpml.(cnt+1).0-bpml.cnt.0
						cnt2++
					}else:break
				loop
				bpm=bpml.cnt2.1;/(bpmhalf+1)
				cnow+=int(double(t-tt)*bpm/625/beat/1000*2)
			}
			cnowfx=0
			tt=0
			if(bpmlnum>0){
				cnt2=0
				repeat bpmlnum-1
					if(bpmlt.(cnt+1)/(1+bpmhalf)<t+laserdelay0/(1+bpmhalf)+40*bpmhalf){
						tt=bpmlt.(cnt+1)/(1+bpmhalf)
						cnowfx+=bpml.(cnt+1).0-bpml.cnt.0
						cnt2++
					}else:break
				loop
				bpmfx=bpml.cnt2.1;/(bpmhalf+1)
				cnowfx+=int(double(t+laserdelay0/(1+bpmhalf)+40*bpmhalf-tt)*bpmfx/625/beat/1000*2)
			}
			cnowfx_50ms=0
			tt=0
			if(bpmlnum>0){
				cnt2=0
				repeat bpmlnum-1
					if(bpmlt.(cnt+1)/(1+bpmhalf)<t+laserdelay0/(1+bpmhalf)+40*bpmhalf+50){
						tt=bpmlt.(cnt+1)/(1+bpmhalf)
						cnowfx_50ms+=bpml.(cnt+1).0-bpml.cnt.0
						cnt2++
					}else:break
				loop
				bpmfx_50ms=bpml.cnt2.1;/(bpmhalf+1)
				cnowfx_50ms+=int(double(t+laserdelay0/(1+bpmhalf)+40*bpmhalf+50-tt)*bpmfx/625/beat/1000*2)
			}
			if((bpmhalf=1)&(mfl=1)){
				t*=2
				t+=80//+45*tshift
			}
			if(cnt=0){
				tp=t
				tpp=tp-8
				tppp=tp-16
			}
			//if(bpmhalf=0):t+=20*(1-tshift)
			if((bpmhalf=1)&((cnt=0)|(cnow<=min(cnowf,cnowf+cnowflen)))):tp=t
			if((t>=t_moex)&(mplayfl=1)&(mfl=0)){
				stat1=c2t(min(cnowf,cnowf+cnowflen))-laserdelay0*((feffect=1)&(cnt_loop=0))-80*bpmhalf
				if((feffect=1)&(cnt_loop=0)){
					// 再生直後から音声エフェクトを適用するために、バッファサイズによるレイテンシ分だけ手前から再生する
					// (ただしカーソルより手前の音声が聞こえるとまずいので、はじめはミュートしておく)
					BASS_ChannelSetAttribute mid,2,0.0
					repeat swaudionum*(feffect=1)
						BASS_ChannelSetAttribute mid_sw.cnt,2,0.0
					loop
					delayfl=1
					delayend=stat1+laserdelay0+80*bpmhalf
				}
				BASS_ChannelPlay(mid)
				repeat swaudionum*(feffect=1)
					BASS_ChannelPlay(mid_sw.cnt)
				loop
				//BASS_ChannelSetAttribute mid,2,double(vol)*double(min(csongvol,100))/10000
				BASS_ChannelSetPosition_ms mid,(stat1-t_moex*(1+bpmhalf))*(stat1>t_moex*(1+bpmhalf))/(1+bpmhalf)
				repeat swaudionum*(feffect=1)
					BASS_ChannelSetPosition_ms mid_sw.cnt,(stat1-t_moex*(1+bpmhalf))*(stat1>t_moex*(1+bpmhalf))/(1+bpmhalf)
				loop
				//if((c2t(min(cnowf,cnowf+cnowflen))-t_moex)*(c2t(min(cnowf,cnowf+cnowflen))>t_moex)>0):tshift=1
				if(stat1<=t_moex){
					t_mo=t
				}else:t_mo=t_moex
				mfl=1
			}
			if((delayfl=1)&(t+(t-tp)/2>=delayend)){
				// 音声エフェクトのレイテンシ回避用の余分再生が終わったらミュートを解除
				if(swaudionow<0){
					BASS_ChannelSetAttribute mid,2,double(vol)/100
				}else{
					BASS_ChannelSetAttribute mid_sw.swaudionow,2,double(vol)/100
				}
				delayfl=0
			}
			//if((t=tp)&(tp=tpp)&(tpp=tppp)&(t-t_mo>500)&(mfl=1)):stopcnt++
			if((pendfl=1)|(t-t_mo>=mlength)|(stopcnt>30)):break
			if((loopplayback=1)&(cnowflen!=0)&(t+(t-tp)/2+38>=t_end)):break
			if((vzoom(cnow)/UNIT_MEASURE/vtate-vyk/2>posnow)&(synchro=1)):posnow=vzoom(cnow)/UNIT_MEASURE/vtate-vyk/2
			gmode 1//,,,256
			if(synchro=1){
				posnow+=(vzoom(cnow)/UNIT_MEASURE/vtate-vyk/2>=posnow)*(vzoom(cnow)/UNIT_MEASURE/vtate-vyk/2-posnow)
				if(posnow!=posnowp):gosub *draw
			}
			gsel 0
			redraw 0
			pos 0,0
			color 0,0,0
			boxf
			gmode 5,,,256
			repeat vyk
				cnt2=cnt
				repeat vtate
					pos vsep/2+cnt2*(41+9*2+vsp)-(41+9*2)/2*(vzoomx=0)-(41+9*2)*3/4*(vzoomx=1)-(synchro=1)*(vzoom(cnow)/UNIT_MEASURE/vtate-vyk/2>=posnow)*((vzoom(cnow)\(UNIT_MEASURE*vtate))*(41+9*2+vsp)/UNIT_MEASURE/vtate),topsep-10+vUNIT_MEASURE*(vtate-cnt-1)
					if(vzoomx=0){
						gcopy 6,0,vUNIT_MEASURE*(vtate*vyoko-1)-vUNIT_MEASURE*(cnt2*vtate+cnt),(41+9*2)*2,vUNIT_MEASURE+(cnt=0)
					}else{
						gsel BUF_ZOOMTEMP
						pos 0,0
						gzoom (41+9*2)*3,vUNIT_MEASURE+(cnt=0),6,0,vUNIT_MEASURE*(vtate*vyoko-1)-vUNIT_MEASURE*(cnt2*vtate+cnt),(41+9*2)*2,vUNIT_MEASURE+(cnt=0),0
						gsel 0
						gcopy BUF_ZOOMTEMP,0,0,(41+9*2)*3,vUNIT_MEASURE+(cnt=0)
					}
					if((vzoom(cnow)>=UNIT_MEASURE*(vtate*(posnow+cnt2)+cnt))&(vzoom(cnow)<=UNIT_MEASURE*(vtate*(posnow+cnt2)+cnt+1))&(delayfl=0)){
						color 255,UNIT_MEASURE/4*2-cnow\(UNIT_MEASURE/4)*2,0
						cx=ginfo_cx
						cy=ginfo_cy
						line (41+9*2)*(2+vzoomx)/4+cx,cy+UNIT_MEASURE-(vzoom(cnow)-UNIT_MEASURE*(vtate*(posnow+cnt2)+cnt)),(41+9*2)*(2+vzoomx)/4+cx+(41+9*2)*(2+vzoomx)/2,cy+UNIT_MEASURE-(vzoom(cnow)-UNIT_MEASURE*(vtate*(posnow+cnt2)+cnt))
						line (41+9*2)*(2+vzoomx)/4+cx,cy+UNIT_MEASURE-(vzoom(cnow)-UNIT_MEASURE*(vtate*(posnow+cnt2)+cnt))-1,(41+9*2)*(2+vzoomx)/4+cx+(41+9*2)*(2+vzoomx)/2,cy+UNIT_MEASURE-(vzoom(cnow)-UNIT_MEASURE*(vtate*(posnow+cnt2)+cnt))-1
					}
				loop
			loop
			gmode 0
			redraw 1
			posnowp=posnow
			if(assisttick=1){
				repeat notenum-max(min6(tickp.0,tickp.1,tickp.2,tickp.3,tickp.4,tickp.5),0),max(min6(tickp.0,tickp.1,tickp.2,tickp.3,tickp.4,tickp.5),0)
					stat1=notet.cnt
					if((stat1>=t-500)&(tickp.(note.cnt.0)<cnt)&(note.cnt.1>=min(cnowf,cnowf+cnowflen)-cnowplus)){
						if((stat1<=t+(t-tp)/2+35)){
							if((note.cnt.0<=3)&(tickcp0<note.cnt.1)){
								stat1=BASS_SampleGetChannel(tickid,0)
								BASS_ChannelPlay stat1
								tickp.(note.cnt.0)=cnt
								tickcp0=note.cnt.1
							}
							if((note.cnt.0>3)&(note.cnt.2=0)&(tickcp1<note.cnt.1)){
								stat1=BASS_SampleGetChannel(tick2id,0)
								BASS_ChannelPlay stat1
								tickp.(note.cnt.0)=cnt
								tickcp1=note.cnt.1
							}
						}else{
							break
						}
					}
				loop
			}
			filtertype=0
			if(anafilnum>0){
				repeat anafilnum-anafilfcnt_play,anafilfcnt_play
					if(anafil.cnt.2<=t+(t-tp)/2+laserdelay0){
						filtertype=anafil.cnt.1
						anafilfcnt_play=cnt
					}else:break
				loop
			}
			if(filtertype!=filtertypep):ldelayresett=t
			filtertype_real=0
			if(anafilnum>0){
				repeat anafilnum-anafilfcnt_play_real,anafilfcnt_play_real
					if(anafil.cnt.2<=t+(t-tp)/2){
						filtertype_real=anafil.cnt.1
						anafilfcnt_play_real=cnt
					}else:break
				loop
			}
			stat1=0
			analognow=-1,-1
			panalognow=0,1000
			panalognow2=-1,-1
			repeat analognum-min(analogjfcnt.0,analogjfcnt.1),min(analogjfcnt.0,analogjfcnt.1)
				if(analog.cnt.1+analog.cnt.2<cnow):analogjfcnt.(analog.cnt.0)=cnt:continue
				if(analogt.cnt.0=0):analogt.cnt.0=c2t(analog.cnt.1)
				stat1=analogt.cnt.0
				if(stat1-(t+((t-tp)/2+laserdelay0-laserdelay))>0):break
				if(analogt.cnt.1=0):analogt.cnt.1=c2t(analog.cnt.1+analog.cnt.2)
				stat2=analogt.cnt.1
				if((stat1<=t+((t-tp)/2+laserdelay0-laserdelay))&(stat2>t+((t-tp)/2+laserdelay0-laserdelay))){
					if(analog.cnt.2<=UNIT_MEASURE/32){
						panalognow.(analog.cnt.0)=analog.cnt.4*20*(analogconnect.cnt=1)+1000*analog.cnt.0*(analogconnect.cnt=0)
						if(analogconnect.cnt=1):panalognow2.(analog.cnt.0)=analog.cnt.4*20
					}else{
						panalognow.(analog.cnt.0)=analog.cnt.3*20+(analog.cnt.4-analog.cnt.3)*20*(stat2-stat1-(stat2-t-((t-tp)/2+laserdelay0-laserdelay)))/(stat2-stat1)
						panalognow2.(analog.cnt.0)=analog.cnt.3*20+(analog.cnt.4-analog.cnt.3)*20*(stat2-stat1-(stat2-t-((t-tp)/2+laserdelay0-laserdelay)))/(stat2-stat1)
					}
				}
				if((stat1<=t+(t-tp)/2)&(stat2>t+(t-tp)/2)){
					if(analog.cnt.2<=UNIT_MEASURE/32){
						analognow.(analog.cnt.0)=analog.cnt.4*20*(analogconnect.cnt=1)-1/*1000*analog.cnt.0*/*(analogconnect.cnt=0)
					}else{
						analognow.(analog.cnt.0)=analog.cnt.3*20+(analog.cnt.4-analog.cnt.3)*20*(stat2-stat1-(stat2-t-(t-tp)/2))/(stat2-stat1)
					}
				}
			loop
			if((panalognow2.0>=0)|(panalognow2.1>=0)){
				peffstat2=1
			}else:peffstat2=0
			// 直角音の再生
			analoganflag=0
			if(enablean=1){
				canvol=0
				if(anvolnum>0){
					repeat anvolnum-anvolfcnt,anvolfcnt
						if(anvol.cnt.2<=t+(t-tp)/2+38){
							canvol=anvol.cnt.1
							anvolfcnt=cnt
						}else:break
					loop
				}
				repeat analoganjnum-max(min(chokkakup.0,chokkakup.1),0),max(min(chokkakup.0,chokkakup.1),0)
					if(analog.(analoganj.cnt.1).2<=UNIT_MEASURE/32){
						if(analogt.(analoganj.cnt.1).0=0):analogt.(analoganj.cnt.1).0=c2t(analog.(analoganj.cnt.1).1)
						stat1=analogt.(analoganj.cnt.1).0
						if((stat1>=t-500)&(analog.(analoganj.cnt.1).1>=min(cnowf,cnowf+cnowflen)-cnowplus)&(chokkakup.(analoganj.cnt.0)<cnt)){
							if(stat1<=t+(t-tp)/2+38){
								stat1=min(abs(analog.(analoganj.cnt.1).3-analog.(analoganj.cnt.1).4)*(1+(analogparentran.(analogparent.(analoganj.cnt.1))=2)),25)
								if(disableautoanvol=1):stat1=25
								if(cnt+1<analoganjnum){
									if((chokkakup.(1-analoganj.cnt.0)<cnt+1)&(analog.(analoganj.cnt.1).1=analog.(analoganj.(cnt+1).1).1)&(analog.(analoganj.cnt.1).0!=analog.(analoganj.(cnt+1).1).0)){
										chokkakup.(1-analoganj.cnt.0)=cnt+1
										if(abs(analog.(analoganj.(cnt+1).1).3-analog.(analoganj.(cnt+1).1).4)>stat1):stat1=min(abs(analog.(analoganj.(cnt+1).1).3-analog.(analoganj.(cnt+1).1).4),25)
									}
								}
								if(cnt-1>=0){
									if((chokkakup.(1-analoganj.cnt.0)<cnt-1)&(analog.(analoganj.cnt.1).1=analog.(analoganj.(cnt-1).1).1)&(analog.(analoganj.cnt.1).0!=analog.(analoganj.(cnt-1).1).0)){
										chokkakup.(1-analoganj.cnt.0)=cnt-1
										if(abs(analog.(analoganj.(cnt-1).1).3-analog.(analoganj.(cnt-1).1).4)>stat1):stat1=min(abs(analog.(analoganj.(cnt-1).1).3-analog.(analoganj.(cnt-1).1).4),25)
									}
								}
								playLaserSlamSound analoganj.cnt.2, double(canvol)/100*stat1/25*double(vol)/100
								analoganflag=1
								chokkakup.(analoganj.cnt.0)=cnt
								chocnt++
								if(chocnt=50):chocnt=0
							}else{
								break
							}
						}
					}
				loop
			}
			bassupdatefl=0
			// FXエフェクトの適用
			if(feffect=1){
				tfx_diff=d3timer()-tfx_diff

				// キー音の再生
				repeat notesejnum-notesejfcnt,notesejfcnt
					if(notet.(notesej.cnt.0)<t-1000){
						notesejfcnt=cnt
					}else:if(notet.(notesej.cnt.0)>t+1000){
						break
					}
					if((note.(notesej.cnt.0).2=0)&(notesej.cnt.1!=2)){
						if((notet.(notesej.cnt.0)>=t-500)&(notet.(notesej.cnt.0)>=cnowft)){
							if(notet.(notesej.cnt.0)<=t+(t-tp)/2+38){
								if (notesej.cnt.2 != 0) {
									// KeySoundのポインタがNULLでなければ再生
									PlayKeySound notesej.cnt.2, double(notesej.cnt.3) / 100 * double(vol) / 100
								}
								notesej.cnt.1=2
							}else{
								break
							}
						}
					}
				loop
				if(cnt=0){
					repeat userfilternum,userfxnum-userfilternum
						if(int(userfx_params.cnt.0)=FXDEF_FXTYPE_RETR){
							if(userfilter_params.(cnt-(userfxnum-userfilternum)).2>0.0f){
								user_now.cnt=int(1.0f/userfilter_params.(cnt-(userfxnum-userfilternum)).2)
							}
						}else:if(int(userfx_params.cnt.0)=FXDEF_FXTYPE_GATE){
							if(userfilter_params.(cnt-(userfxnum-userfilternum)).1>0.0f){
								user_now.cnt=int(1.0f/userfilter_params.(cnt-(userfxnum-userfilternum)).1)
							}
						}else:if(int(userfx_params.cnt.0)=FXDEF_FXTYPE_WOBB){
							if(userfilter_params.(cnt-(userfxnum-userfilternum)).1>0.0f){
								user_now.cnt=int(1.0f/userfilter_params.(cnt-(userfxnum-userfilternum)).1)
							}
						}else:if(int(userfx_params.cnt.0)=FXDEF_FXTYPE_BITC){
							BASS_VST_SetParam hFX_User.cnt,0,maxf(minf(userfilter_params.(cnt-(userfxnum-userfilternum)).1/128.0f,1.0f),0.0f)
						}else:if(int(userfx_params.cnt.0)=FXDEF_FXTYPE_TSTP){
							BASS_VST_SetParam hFX_User.cnt,1,maxf(minf(userfilter_params.(cnt-(userfxnum-userfilternum)).1,1.0f),0.0f)
						}else:if(int(userfx_params.cnt.0)=FXDEF_FXTYPE_ECHO){
							if(userfilter_params.(cnt-(userfxnum-userfilternum)).2>0.0f){
								user_now.cnt=int(1.0f/userfilter_params.(cnt-(userfxnum-userfilternum)).2)
							}
						}else:if(int(userfx_params.cnt.0)=FXDEF_FXTYPE_PITC){
							BASS_VST_SetParam hFX_User.cnt,0,maxf(minf(absf(userfilter_params.(cnt-(userfxnum-userfilternum)).1),1.0f),0.0f)
						}
					loop
				}
				if(bpmfx!=bpmfxp){
					BASS_VST_SetParam hFX_Flan,0,maxf(minf(2.0f*60.0f*4*1000/bpmfx/10,1.0f),0.0f)*(1+bpmhalf)
					BASS_VST_SetParam hFX_Phas,0,maxf(minf(60.0f*4*1000/bpmfx/10,1.0f),0.0f)*(1+bpmhalf)
					BASS_VST_SetParam hFX_SiCh,4,maxf(minf(60.0f*0.5f*1000/bpmfx/10,1.0f),0.0f)*(1+bpmhalf)
					if(retr_now>0){
						BASS_VST_SetParam hFX_Retr,1,60.0f*4.0f*1000.0f/bpmfx/10.0f/retr_now*(1+bpmhalf)
					}
					if(gate_now>0){
						BASS_VST_SetParam hFX_Gate,6,60.0f*4.0f*1000.0f/bpmfx/10.0f/gate_now*(1+bpmhalf)
					}
					if(wobble_now>0){
						BASS_VST_SetParam hFX_Gate,9,60.0f*4.0f*1000.0f/bpmfx/10.0f/wobble_now*(1+bpmhalf)
					}
					repeat 2
						if(echo_now.cnt>0){
							BASS_VST_SetParam hFX_Echo.cnt,1,60.0f*4.0f*1000.0f/bpmfx/10.0f/echo_now.cnt*(1+bpmhalf)
						}
					loop
					// user_nowの反映
					repeat userfxnum
						cnt2=cnt
						repeat fxdef_prmnum.(int(userfx_params.cnt2.0)),1
							if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)&(userfx_params.cnt2.cnt>=0.0f)&(fxdef_linkprm.(int(userfx_params.cnt2.0))!=cnt)){
								BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),maxf(minf(userfx_params.cnt2.cnt*60.0f*4*1000/bpmfx/10,1.0f),0.0f)*(1+bpmhalf)
							}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)&(userfx_params.cnt2.cnt>=0.0f)&(fxdef_linkprm.(int(userfx_params.cnt2.0))=cnt)){
								if(user_now.cnt2>0){
									BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),maxf(minf(60.0f*4*1000/bpmfx/10/user_now.cnt2,1.0f),0.0f)*(1+bpmhalf)
								}
							}
							if((int(userfx_params.cnt2.0)=FXDEF_FXTYPE_ECHO)&(cnt=2)){
								if(user_now.cnt2>0){
									BASS_VST_SetParam hFX_User.cnt2,3,maxf(minf(60.0f*4*1000/bpmfx/10/user_now.cnt2*1.25f,1.0f),0.0f)*(1+bpmhalf)
								}
							}
						loop
					loop
				}
				c2bnow=c2b(cnowfx)
				sich_beat=(cnowfx-b2c(c2bnow))/(UNIT_MEASURE/4)
				c2bnow_50ms=c2b(cnowfx_50ms)
				retr_beat=(cnowfx_50ms-b2c(c2bnow_50ms))/(UNIT_MEASURE/2)
				// Retrigger/Gate/Wobble 更新トリガ判定
				if((retr_beat!=retr_beatp)|(c2bnow_50ms!=c2bnowp_50ms)){
					dstat=c2tf(b2c(c2bnow_50ms)+(cnowfx_50ms-b2c(c2bnow_50ms))/(UNIT_MEASURE/2)*(UNIT_MEASURE/2))-double(t+laserdelay0+tfx_diff)
					BASS_VST_SetParam hFX_Retr,19,maxf(minf(dstat/10000.0f,1.0f),0.0f)
					if(c2bnow_50ms!=c2bnowp_50ms){
						BASS_VST_SetParam hFX_Gate,19,maxf(minf(dstat/10000.0f,1.0f),0.0f)
						// ユーザー定義FXのGate/Wobble更新(1小節間隔固定)
						repeat userfxnum
							if((userfx_params.cnt.0=FXDEF_FXTYPE_GATE)|(userfx_params.cnt.0=FXDEF_FXTYPE_WOBB)){
								BASS_VST_SetParam hFX_User.cnt,19,maxf(minf(dstat/10000.0f,1.0f),0.0f)
							}
						loop
					}
					//bassupdatefl=1
				}
				retr_beatp=retr_beat
				repeat userfxnum
					if((userfx_params.cnt.0=FXDEF_FXTYPE_RETR)||(userfx_params.cnt.0=FXDEF_FXTYPE_ECHO)){
						// ユーザー定義FXのRetrigger/Echo 更新トリガ判定
						if((userfx_params.cnt.1>0.0f)&(int(userfx_params.cnt.1*UNIT_MEASURE)>0)&(userfx_params.cnt.1<1.0f)){
							user_beat.cnt=(cnowfx_50ms-b2c(c2bnow_50ms))/max(int(userfx_params.cnt.1*UNIT_MEASURE),1)
						}else:if(userfx_params.cnt.1>=1.0f){
							stat1=b2c(c2bnow_50ms)
							user_beat.cnt=int((double(c2bnow_50ms)+double(cnowfx_50ms-stat1)/(b2c(c2bnow_50ms+1)-stat1))/userfx_params.cnt.1)
						}else:user_beat.cnt=0
						if(((user_beat.cnt!=user_beatp.cnt)|(c2bnow_50ms!=c2bnowp_50ms))&(int(userfx_params.cnt.1*UNIT_MEASURE)>0)&(userfx_params.cnt.1<1.0f)){
							dstat=c2tf(b2c(c2bnow_50ms)+(cnowfx_50ms-b2c(c2bnow_50ms))/int(userfx_params.cnt.1*UNIT_MEASURE)*int(userfx_params.cnt.1*UNIT_MEASURE))-double(t+laserdelay0+tfx_diff)
							BASS_VST_SetParam hFX_User.cnt,19,maxf(minf(dstat/10000.0f,1.0f),0.0f)
						}else:if((user_beat.cnt!=user_beatp.cnt)&(userfx_params.cnt.1>=1.0f)){
							stat1=int(double(user_beat.cnt)*userfx_params.cnt.1)
							stat1=b2c(stat1)+int(double(b2c(stat1+1)-b2c(stat1))*(double(user_beat.cnt)*userfx_params.cnt.1-double(stat1)))
							dstat=c2tf(stat1)-double(t+laserdelay0+tfx_diff)
							BASS_VST_SetParam hFX_User.cnt,19,maxf(minf(dstat/10000.0f,1.0f),0.0f)
						}
					}
				loop
				f=0
				feffectnow=0,0
				feffectparam=0,0
				feffectparam2=0,0
				feffectnow_real=0,0
				repeat notenum-min(notefcnt_feffect.0,notefcnt_feffect.1),min(notefcnt_feffect.0,notefcnt_feffect.1)
					if((note.cnt.0>3)&(note.cnt.2>0)&(noteendt.cnt<=t+40*bpmhalf)):notefcnt_feffect.(note.cnt.0-4)=cnt+1
					if((note.cnt.0>3)&(notet.cnt<=t+40*bpmhalf)&(noteendt.cnt>t+40*bpmhalf)){
						feffectnow_real.(note.cnt.0-4)=note.cnt.3
					}
					if((note.cnt.0>3)&(notet.cnt<=t+laserdelay0+40*bpmhalf)&(noteendt.cnt>t+laserdelay0+40*bpmhalf)){
						feffectnow.(note.cnt.0-4)=note.cnt.3
						feffectparam.(note.cnt.0-4)=note.cnt.4
						feffectparam2.(note.cnt.0-4)=note.cnt.5
						f=1
					}
					if(notet.cnt>t+laserdelay0+40*bpmhalf):break
				loop
				// ByPassの設定
				if(f=1){
					repeat userfxnum-userfilternum
						BASS_VST_SetParam hFX_User.cnt,29,0.0f
					loop
				}else{
					repeat userfxnum-userfilternum
						BASS_VST_SetParam hFX_User.cnt,29,1.0f
					loop
				}
				// ユーザー定義FXの手動パラメータ変更
				repeat max(userchprmnum-userchprmfcnt,0),userchprmfcnt
					if(userchprm.cnt.0<=cnowfx){
						cnt2=int(userchprm.cnt.1)
						cnt3=int(userchprm.cnt.2)
						if((userchprm.cnt.3=1.0f)&(userchprm.cnt.4=1.0f)&(fxdef_max.cnt3.(int(userfx_params.cnt2.0))=-1.0f)){
							BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt3.(int(userfx_params.cnt2.0)),0.000003
						}else{
							userfx_params.cnt2.cnt3=userchprm.cnt.3
							userfx_params_enable.cnt2.cnt3=userchprm.cnt.4
							if(cnt2>=userfxnum-userfilternum){
								userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt3=userchprm.cnt.4
								userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt3=userchprm.cnt.5
							}
							if((feffectnow.0=100+cnt2)|(feffectnow.1=100+cnt2)){
								// 変更タイミングと対象ロングFXの有効時が重なった場合
								if((userfx_params_enable.cnt2.cnt3<0.0f)&(fxdef_type.cnt3.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)){
									BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt3.(int(userfx_params.cnt2.0)),minf(maxf(-userfx_params_enable.cnt2.cnt3/10.0f,0.0f),1.0f)*(1+bpmhalf)
								}else:if(fxdef_max.cnt3.(int(userfx_params.cnt2.0))>0.0f){
									BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt3.(int(userfx_params.cnt2.0)),minf(maxf(fxdef_prmmax.cnt3.(int(userfx_params.cnt2.0))*userfx_params_enable.cnt2.cnt3/fxdef_max.cnt3.(int(userfx_params.cnt2.0)),0.0f),1.0f)
								}else:if((fxdef_prmno.cnt3.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt3.(int(userfx_params.cnt2.0))=FXDEF_PITCH)){
									// PitchShift pitch
									BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt3.(int(userfx_params.cnt2.0)),maxf(minf(absf(userfx_params_enable.cnt2.cnt3),1.0f),0.0f)
								}
								if(fxdef_linkprm.(int(userfx_params.cnt2.0))>=0){
									if((cnt3=fxdef_linkprm.(int(userfx_params.cnt2.0)))&(userfx_params_enable.cnt2.(fxdef_linkprm.(int(userfx_params.cnt2.0)))>0)){
										user_now.cnt2=int(1.0f/userfx_params_enable.cnt2.(fxdef_linkprm.(int(userfx_params.cnt2.0))))
									}
								}
							}else{
								if((userfx_params.cnt2.cnt3<0.0f)&(fxdef_type.cnt3.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)){
									BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt3.(int(userfx_params.cnt2.0)),minf(maxf(-userfx_params.cnt2.cnt3/10.0f,0.0f),1.0f)*(1+bpmhalf)
								}else:if(fxdef_max.cnt3.(int(userfx_params.cnt2.0))>0.0f){
									BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt3.(int(userfx_params.cnt2.0)),minf(maxf(fxdef_prmmax.cnt3.(int(userfx_params.cnt2.0))*userfx_params.cnt2.cnt3/fxdef_max.cnt3.(int(userfx_params.cnt2.0)),0.0f),1.0f)
								}else:if((fxdef_prmno.cnt3.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt3.(int(userfx_params.cnt2.0))=FXDEF_PITCH)){
									// PitchShift pitch
									BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt3.(int(userfx_params.cnt2.0)),maxf(minf(absf(userfx_params.cnt2.cnt3),1.0f),0.0f)
								}
								if(fxdef_linkprm.(int(userfx_params.cnt2.0))>=0){
									if((cnt3=fxdef_linkprm.(int(userfx_params.cnt2.0)))&(userfx_params.cnt2.(fxdef_linkprm.(int(userfx_params.cnt2.0)))>0)){
										user_now.cnt2=int(1.0f/userfx_params.cnt2.(fxdef_linkprm.(int(userfx_params.cnt2.0))))
									}
								}
							}
							if((fxdef_prmno.cnt3.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt3.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)&(userfx_params.cnt2.cnt3>=0.0f)&(fxdef_linkprm.(int(userfx_params.cnt2.0))!=cnt3)){
								BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt3.(int(userfx_params.cnt2.0)),maxf(minf(userfx_params.cnt2.cnt3*60.0f*4*1000/bpmfx/10,1.0f),0.0f)
							}else:if((fxdef_prmno.cnt3.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt3.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)&(userfx_params.cnt2.cnt3>=0.0f)&(fxdef_linkprm.(int(userfx_params.cnt2.0))=cnt3)){
								if(user_now.cnt2>0){
									BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt3.(int(userfx_params.cnt2.0)),maxf(minf(60.0f*4*1000/bpmfx/10/user_now.cnt2,1.0f),0.0f)*(1+bpmhalf)
								}
							}
							if((int(userfx_params.cnt2.0)=FXDEF_FXTYPE_ECHO)&(cnt3=2)){
								if(user_now.cnt2>0){
									BASS_VST_SetParam hFX_User.cnt2,3,maxf(minf(60.0f*4*1000/bpmfx/10/user_now.cnt2*1.25f,1.0f),0.0f)*(1+bpmhalf)
								}
							}
						}
						userchprmfcnt=cnt+1
					}
					if(userchprm.cnt.0>cnowfx):break
				loop
				repeat 2
					// SwitchAudioの処理
					if(feffectnow_real.cnt!=feffectp_real.cnt){
						if(feffectp_real.cnt>=100){
							cnt2=feffectp_real.cnt-100
							if(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_AUDI){
								if(feffectnow_real.(1-cnt)<100){
									swaudionow=-1
								}else:if(int(userfx_params.(feffectnow_real.(1-cnt)-100).0)=FXDEF_FXTYPE_AUDI){
									swaudionow=userfx_swaudiomid.(feffectnow_real.(1-cnt)-100)
								}else{
									swaudionow=-1
								}
							}
						}
						if(feffectnow_real.cnt>=100){
							cnt2=feffectnow_real.cnt-100
							if(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_AUDI){
								swaudionow=userfx_swaudiomid.cnt2
							}
						}
						bassupdatefl=1
					}
					if(feffectnow.cnt!=feffectp.cnt){
						// 以下, エフェクト解除
						if((feffectp.cnt=FX_PHAS)&(feffectnow.(1-cnt)!=FX_PHAS)){
							BASS_VST_SetParam hFX_Phas,1,0
							BASS_VST_SetParam hFX_Phas,8,0
						}
						if((feffectp.cnt=FX_FLAN)&(feffectnow.(1-cnt)!=FX_FLAN)){
							BASS_VST_SetParam hFX_Flan,6,0
						}
						if((feffectp.cnt=FX_PITC)&(feffectnow.(1-cnt)!=FX_PITC)){
							BASS_VST_SetParam hFX_Pitc,3,0
							if(feffectnow.(1-cnt)=FX_PITC){
								BASS_VST_SetParam hFX_Pitc,0,double(feffectparam.(1-cnt))/48.0f/2.0f+0.50f
							}
						}
						if((feffectp.cnt=FX_BITC)&(feffectnow.(1-cnt)!=FX_BITC)){
							BASS_VST_SetParam hFX_BitC,0,0
							if(feffectnow.(1-cnt)=FX_BITC){
								BASS_VST_SetParam hFX_BitC,0,double(feffectparam.(1-cnt))/128.0f
							}
						}
						if(feffectp.cnt=FX_TSTP){
							BASS_VST_SetParam hFX_TStp.cnt,0,0
							if(feffectnow.(1-cnt)=FX_TSTP){
								BASS_VST_SetParam hFX_TStp.(1-cnt),2,1.0f
							}
						}
						if((feffectp.cnt>=FX_RE8)&(feffectp.cnt<=FX_RE32)&(feffectnow.(1-cnt)<FX_RE8)|(feffectnow.(1-cnt)>FX_RE32)){
							BASS_VST_SetParam hFX_Retr,1,0
							retr_now=0
						}
						if((feffectp.cnt>=FX_RE8)&(feffectp.cnt<=FX_RE32)&(feffectnow.(1-cnt)>=FX_RE8)&(feffectnow.(1-cnt)<=FX_RE32)){
							BASS_VST_SetParam hFX_Retr,1,60.0f*4.0f*1000.0f/bpmfx/10.0f/feffectparam.(1-cnt)*(1+bpmhalf)
							retr_now=feffectparam.(1-cnt)
						}
						if((feffectp.cnt>=FX_GA4)&(feffectp.cnt<=FX_GA32)&(feffectnow.(1-cnt)<FX_GA4)|(feffectnow.(1-cnt)>FX_GA32)){
							BASS_VST_SetParam hFX_Gate,6,0
							gate_now=0
						}
						if((feffectp.cnt>=FX_GA4)&(feffectp.cnt<=FX_GA32)&(feffectnow.(1-cnt)>=FX_GA4)&(feffectnow.(1-cnt)<=FX_GA32)){
							BASS_VST_SetParam hFX_Gate,6,60.0f*4.0f*1000.0f/bpmfx/10.0f/feffectparam.(1-cnt)*(1+bpmhalf)
							gate_now=feffectparam.(1-cnt)
						}
						if((feffectp.cnt=FX_WO12)&(feffectnow.(1-cnt)!=FX_WO12)){
							BASS_VST_SetParam hFX_Gate,9,0
							wobble_now=0
						}
						if((feffectp.cnt=FX_WO12)&(feffectnow.(1-cnt)=FX_WO12)){
							BASS_VST_SetParam hFX_Gate,9,60.0f*4.0f*1000.0f/bpmfx/10.0f/feffectparam.(1-cnt)*(1+bpmhalf)
							wobble_now=feffectparam.(1-cnt)
						}
						if(feffectp.cnt=FX_EC4){
							BASS_VST_SetParam hFX_Echo.cnt,1,0
							if(feffectnow.(1-cnt)=FX_EC4){
								BASS_VST_SetParam hFX_Echo.(1-cnt),5,1.0f
							}
						}
						if((feffectp.cnt=FX_SICH)&(feffectnow.(1-cnt)!=FX_SICH)){
							BASS_VST_SetParam hFX_SiCh,5,0.01
						}
						if(feffectp.cnt>=100){
							cnt2=feffectp.cnt-100
							if((int(userfx_params.cnt2.0)=FXDEF_FXTYPE_RETR)|(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_GATE)|(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_WOBB)){
								if(feffectnow.(1-cnt)=feffectp.cnt){
									BASS_VST_SetParam hFX_User.cnt2,(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_RETR)*1+(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_GATE)*6+(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_WOBB)*9,60.0f*4.0f*1000.0f/bpmfx/10.0f/feffectparam.(1-cnt)*(1+bpmhalf)
									user_now.cnt2=feffectparam.(1-cnt)
								}
							}else:if(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_BITC){
								if(feffectnow.(1-cnt)=feffectp.cnt){
									BASS_VST_SetParam hFX_User.cnt2,0,minf(maxf(double(feffectparam.(1-cnt))/128.0f,0.0f),1.0f)
									user_now.cnt2=feffectparam.(1-cnt)
								}
							}else:if(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_TSTP){
								if(feffectnow.(1-cnt)=feffectp.cnt){
									BASS_VST_SetParam hFX_User.cnt2,1,minf(maxf(double(feffectparam.(1-cnt))/100.0f,0.0f),1.0f)
									user_now.cnt2=feffectparam.(1-cnt)
								}
							}else:if(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_PITC){
								if(feffectnow.(1-cnt)=feffectp.cnt){
									BASS_VST_SetParam hFX_User.cnt2,0,minf(maxf(double(feffectparam.(1-cnt))/48.0f/2.0f+0.5f,0.0f),1.0f)
									user_now.cnt2=feffectparam.(1-cnt)
								}
							}
							if(int(userfx_params.cnt2.0)!=FXDEF_FXTYPE_AUDI){
								repeat fxdef_prmnum.(int(userfx_params.cnt2.0)),1
									if(userfx_params.cnt2.cnt!=userfx_params_enable.cnt2.cnt){
										if((userfx_params.cnt2.cnt<0.0f)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)){
											BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(-userfx_params.cnt2.cnt/10.0f,0.0f),1.0f)
										}else:if(fxdef_max.cnt.(int(userfx_params.cnt2.0))>0.0f){
											BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(fxdef_prmmax.cnt.(int(userfx_params.cnt2.0))*userfx_params.cnt2.cnt/fxdef_max.cnt.(int(userfx_params.cnt2.0)),0.0f),1.0f)
										}else:if((userfx_params.cnt2.cnt=1.0f)&(fxdef_max.cnt.(int(userfx_params.cnt2.0))=-1.0f)){
											BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),0.000003
										}
									}
								loop
							}
						}
						// 以下, エフェクト付加
						if(feffectnow.cnt=FX_PHAS){
							BASS_VST_SetParam hFX_Phas,1,0.50f
							BASS_VST_SetParam hFX_Phas,8,0.50f
						}
						if(feffectnow.cnt=FX_FLAN){
							BASS_VST_SetParam hFX_Flan,6,0.80f
						}
						if(feffectnow.cnt=FX_PITC){
							BASS_VST_SetParam hFX_Pitc,0,double(feffectparam.cnt)/48.0f/2.0f+0.50f
							BASS_VST_SetParam hFX_Pitc,3,1.00f
						}
						if(feffectnow.cnt=FX_BITC){
							BASS_VST_SetParam hFX_BitC,0,double(feffectparam.cnt)/128.0f
						}
						if(feffectnow.cnt=FX_TSTP){
							BASS_VST_SetParam hFX_TStp.cnt,1,double(feffectparam.cnt)/100.0f/(1+bpmhalf)
							BASS_VST_SetParam hFX_TStp.cnt,0,1.0f
							BASS_VST_SetParam hFX_TStp.cnt,2,1.0f
							BASS_VST_SetParam hFX_TStp.(1-cnt),2,0.0f
						}
						if((feffectnow.cnt>=FX_RE8)&(feffectnow.cnt<=FX_RE32)){
							BASS_VST_SetParam hFX_Retr,1,60.0f*4.0f*1000.0f/bpmfx/10.0f/feffectparam.cnt*(1+bpmhalf)
							retr_now=feffectparam.cnt
						}
						if((feffectnow.cnt>=FX_GA4)&(feffectnow.cnt<=FX_GA32)){
							BASS_VST_SetParam hFX_Gate,6,60.0f*4.0f*1000.0f/bpmfx/10.0f/feffectparam.cnt*(1+bpmhalf)
							gate_now=feffectparam.cnt
						}
						if(feffectnow.cnt=FX_WO12){
							BASS_VST_SetParam hFX_Gate,9,60.0f*4.0f*1000.0f/bpmfx/10.0f/feffectparam.cnt*(1+bpmhalf)
							wobble_now=feffectparam.cnt
						}
						if(feffectnow.cnt=FX_EC4){
							echo_trigger.cnt=1-echo_trigger.cnt
							BASS_VST_SetParam hFX_Echo.cnt,0,double(echo_trigger.cnt)
							BASS_VST_SetParam hFX_Echo.cnt,1,60.0f*4.0f*1000.0f/bpmfx/10.0f/feffectparam.cnt*(1+bpmhalf)
							BASS_VST_SetParam hFX_Echo.cnt,3,60.0f*4.0f*1000.0f/bpmfx/10.0f/feffectparam.cnt*1.25f*(1+bpmhalf)
							BASS_VST_SetParam hFX_Echo.cnt,4,double(feffectparam2.cnt)/100
							BASS_VST_SetParam hFX_Echo.cnt,5,1.0f
							BASS_VST_SetParam hFX_Echo.(1-cnt),5,0.0f
						}
						if(feffectnow.cnt=FX_SICH){
							BASS_VST_SetParam hFX_SiCh,5,0.05f
						}
						if(feffectnow.cnt>=100){
							cnt2=feffectnow.cnt-100
							if((int(userfx_params.cnt2.0)=FXDEF_FXTYPE_RETR)|(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_GATE)|(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_WOBB)|(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_ECHO)){
								BASS_VST_SetParam hFX_User.cnt2,((int(userfx_params.cnt2.0)=FXDEF_FXTYPE_RETR)|(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_ECHO))*1+(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_GATE)*6+(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_WOBB)*9,60.0f*4.0f*1000.0f/bpmfx/10.0f/feffectparam.cnt*(1+bpmhalf)
								user_now.cnt2=feffectparam.cnt
							}else:if(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_BITC){
								BASS_VST_SetParam hFX_User.cnt2,0,minf(maxf(double(feffectparam.cnt)/128.0f,0.0f),1.0f)
								user_now.cnt2=feffectparam.cnt
							}else:if(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_TSTP){
								BASS_VST_SetParam hFX_User.cnt2,1,minf(maxf(double(feffectparam.cnt)/100.0f,0.0f),1.0f)/(1+bpmhalf)
								user_now.cnt2=feffectparam.cnt
							}else:if(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_PITC){
								BASS_VST_SetParam hFX_User.cnt2,0,minf(maxf(double(feffectparam.cnt)/48.0f/2.0f+0.5f,0.0f),1.0f)
								user_now.cnt2=feffectparam.cnt
							}
							if(int(userfx_params.cnt2.0)!=FXDEF_FXTYPE_AUDI){
								repeat fxdef_prmnum.(int(userfx_params.cnt2.0)),1
									if(userfx_params.cnt2.cnt!=userfx_params_enable.cnt2.cnt){
										if((userfx_params_enable.cnt2.cnt<0.0f)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)){
											BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(-userfx_params_enable.cnt2.cnt/10.0f,0.0f),1.0f)
										}else:if(fxdef_max.cnt.(int(userfx_params.cnt2.0))>0.0f){
											BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(fxdef_prmmax.cnt.(int(userfx_params.cnt2.0))*userfx_params_enable.cnt2.cnt/fxdef_max.cnt.(int(userfx_params.cnt2.0)),0.0f),1.0f)
										}else:if((userfx_params_enable.cnt2.cnt=1.0f)&(fxdef_max.cnt.(int(userfx_params.cnt2.0))=-1.0f)){
											BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),0.000003
										}
									}
								loop
							}
							if(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_ECHO){
								BASS_VST_SetParam hFX_User.cnt2,4,minf(maxf(double(feffectparam2.cnt)/100.0f,0.0f),1.0f)
							}
						}
						bassupdatefl=1
					}
					feffectp_real.cnt=feffectnow_real.cnt
					feffectp.cnt=feffectnow.cnt
				loop
				if(((sich_beat!=sich_beatp)|(c2bnow!=c2bnowp))&((feffectnow.0=FX_SICH)|(feffectnow.1=FX_SICH))){
					if((cnt!=0)|(iscnowfjust=1)){
						sich_trigger=1-sich_trigger
						BASS_VST_SetParam hFX_SiCh,0,double(sich_trigger)
						bassupdatefl=1
					}
				}
				sich_beatp=sich_beat
			}
			// ピークフィルタの適用
			if(peffect+peffect2=2){
				canagain=0
				if(anagainnum>0){
					repeat anagainnum-anagainfcnt_play,anagainfcnt_play
						if(anagain.cnt.2<=t+(t-tp)/2+laserdelay0){
							canagain=anagain.cnt.1
							anagainfcnt_play=cnt
						}else:break
					loop
				}
				ddim pdstat2,1
				pdstat2=pdstat
				ddim pdstat,1
				pdstat=double(max(panalognow.0,1000-panalognow.1))/1000.0
				pstat3=pstat2
				pstat2=((panalognow.0<=20)&(panalognow.1>=980))|(pdstat=0.0f)
				if((pstat2=1)&(pstat3=0)&(cnt!=0)){
					shuwat=t
					shuwapos=pdstat2
				}
				if(analoganflag=1){
					shuwat=t
					shuwapos=analogantarget
				}
				// SwitchAudioの処理
				swaudionow_filter=-1
				if(((analognow.0!=-1)|(analognow.1!=-1))&(filtertype_real>=100)){
					if(int(userfx_params.(filtertype_real-100).0)=FXDEF_FXTYPE_AUDI){
						swaudionow_filter=userfx_swaudiomid.(filtertype_real-100)
					}
				}
				if((filtertype=0)&(pefftype!=-1)&((cnt=0)|(pdstat!=pdstat2)|(filtertype!=filtertypep)|(pstat2!=pstat3)|(t-shuwat<=100)|(canagain!=canagainp))){
					if(filtertype!=filtertypep):shuwat=-50000
					if(pstat2=1){
						dim pfilter,7
						pfilter=6,tofloat(3000.0f*((maxf(shuwapos,0.8f)-0.8f)/0.2f)+10000.0f-9950.0f*(cos(shuwapos)*4.0f+cos(shuwapos)*cos(shuwapos)*5.0f)/9.0f),tofloat(minf(maxf(14.0f*minf(shuwapos,0.15f)/0.15f+3.0f*(1.0-absf(shuwapos-0.35f)/0.35f)-3.5f*((maxf(shuwapos,0.8f)-0.8f)/0.2f),0.0f),18.0f)*1.1f*(50-min(t-shuwat,50))/50.0f*min(canagain,50)/50),tofloat(1.2f),tofloat(0.0f),tofloat(0.0f),-1*(t-shuwat<=50)
						BASS_FXSetParameters hPeakFX,pfilter
						repeat swaudionum*(feffect=1)
							BASS_FXSetParameters hPeakFX_sw.cnt,pfilter
						loop
						pfilter=6,tofloat(3000.0f*((maxf(shuwapos,0.8f)-0.8f)/0.2f)+10000.0f-9950.0f*(cos(shuwapos)*4.0f+cos(shuwapos)*cos(shuwapos)*5.0f)/9.0f),tofloat(minf(maxf(14.0f*minf(shuwapos,0.15f)/0.15f+3.0f*(1.0-absf(shuwapos-0.35f)/0.35f)-3.5f*((maxf(shuwapos,0.8f)-0.8f)/0.2f),0.0f),18.0f)*1.1f*(50-min(t-shuwat,50))/50.0f*min(canagain,50)/50),tofloat(1.2f),tofloat(0.0f),tofloat(0.0f),0
						BASS_FXSetParameters hPeakFX2,pfilter
						repeat swaudionum*(feffect=1)
							BASS_FXSetParameters hPeakFX2_sw.cnt,pfilter
						loop
					}else{
						dim pfilter,7
						pfilter=6,tofloat(3000.0f*((maxf(pdstat,0.8f)-0.8f)/0.2f)+10000.0f-9950.0f*(cos(pdstat)*4.0f+cos(pdstat)*cos(pdstat)*5.0f)/9.0f),tofloat(minf(maxf(14.0f*minf(pdstat,0.15f)/0.15f+3.0f*(1.0-absf(pdstat-0.35f)/0.35f)-3.5f*((maxf(pdstat,0.8f)-0.8f)/0.2f),0.0f),18.0f)*(1.0f+0.5f*(disableshuwa=0)*(50-min(t-shuwat,50))/50.0f*(shuwapos>=100.0f))*canagain/50),tofloat(1.2f),tofloat(0.0f),tofloat(0.0f),-1
						BASS_FXSetParameters hPeakFX,pfilter
						repeat swaudionum*(feffect=1)
							BASS_FXSetParameters hPeakFX_sw.cnt,pfilter
						loop
						pfilter=6,tofloat(3000.0f*((maxf(pdstat,0.8f)-0.8f)/0.2f)+10000.0f-9950.0f*(cos(pdstat)*4.0f+cos(pdstat)*cos(pdstat)*5.0f)/9.0f),tofloat(minf(maxf(14.0f*minf(pdstat,0.15f)/0.15f+3.0f*(1.0-absf(pdstat-0.35f)/0.35f)-3.5f*((maxf(pdstat,0.8f)-0.8f)/0.2f),0.0f),18.0f)*(1.0f+0.5f*(disableshuwa=0)*(50-min(t-shuwat,50))/50.0f*(shuwapos>=100.0f))*canagain/50),tofloat(1.2f),tofloat(0.0f),tofloat(0.0f),0
						BASS_FXSetParameters hPeakFX2,pfilter
						repeat swaudionum*(feffect=1)
							BASS_FXSetParameters hPeakFX2_sw.cnt,pfilter
						loop
					}
					BASS_VST_SetParam hBitCFX,0,0.0f
					repeat swaudionum*(feffect=1)
						BASS_VST_SetParam hBitCFX_sw.cnt,0,0.0f
					loop
					repeat userfilternum*(feffect=1),userfxnum-userfilternum
						cnt2=cnt
						repeat fxdef_prmnum.(int(userfx_params.cnt.0)),1
							if((userfilter_params.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)|(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)){
								if((userfx_params.cnt2.cnt<0.0f)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)){
									BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(-userfx_params.cnt2.cnt/10.0f,0.0f),1.0f)
								}else:if(fxdef_max.cnt.(int(userfx_params.cnt2.0))>0.0f){
									BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(fxdef_prmmax.cnt.(int(userfx_params.cnt2.0))*userfx_params.cnt2.cnt/fxdef_max.cnt.(int(userfx_params.cnt2.0)),0.0f),1.0f)
								}
							}
						loop
					loop
					bassupdatefl=1
				}else:if((filtertype!=0)&(pefftype!=-1)&((pdstat!=pdstat2)|(filtertype!=filtertypep)|(pstat2!=pstat3))){
					dim pfilter,7
					if((filtertype<0)|(filtertype>=5)){
						pfilter=6,tofloat(1000.0f),tofloat(0.0f),tofloat(1.2f),tofloat(0.0f),tofloat(0.0f),0
					}
					if(filtertype=1):pfilter=1,tofloat(4600.0f-4500.0f*cos(pdstat)),tofloat(minf(maxf(13.0f*minf(pdstat,0.2f)/0.2f+4.0f*(1.0-absf(pdstat-0.35f)/0.35f)-3.0f*((maxf(pdstat,0.8f)-0.8f)/0.2f),0.0f),16.0f)*(1.0f+0.1f*(1-disableshuwa)*(50-min(t-shuwat,50))/50.0f*(shuwapos>=100.0f))*canagain/50),tofloat(0.8f),tofloat(0.0f),tofloat(0.0f),-1*(pstat2=0)
					//if(filtertype=2):pfilter=1,tofloat(10000.0f-10000.0f+9950.0f*(cos(pdstat)*4.0f+cos(pdstat)*5.0f)/9.0f),tofloat(minf(maxf(11.0f*minf(pdstat,0.2f)/0.2f+6.0f*(1.0-absf(pdstat-0.35f)/0.35f)-1.5f*((maxf(pdstat,0.8f)-0.8f)/0.2f),0.0f),16.0f)*(1.0f+0.1f*(50-min(t-shuwat,50))/50.0f*(shuwapos>=100.0f))*canagain/50),tofloat(1.25f),tofloat(0.0f),tofloat(0.0f),-1
					if(filtertype=3):pfilter=0,tofloat(15000.0f-14200.0f*sin(sin(pdstat*1.25)/sin(1.25f)*1.5)/sin(1.5f)),tofloat(minf(maxf(13.0f*minf(pdstat,0.15f)/0.15f+4.0f*(1.0-absf(pdstat-0.35f)/0.35f)-3.0f*((maxf(pdstat,0.8f)-0.8f)/0.2f),0.0f),16.0f)*(1.0f+0.5f*(1-disableshuwa)*(50-min(t-shuwat,50))/50.0f*(shuwapos>=100.0f))*canagain/50),tofloat(0.8f),tofloat(0.0f),tofloat(0.0f),-1*(pstat2=0)
					//if(filtertype=4):pfilter=0,tofloat(10000.0f-5000.0f+4950.0f*(cos(pdstat)*4.0f+cos(pdstat)*5.0f)/9.0f),tofloat(minf(maxf(11.0f*minf(pdstat,0.2f)/0.2f+6.0f*(1.0-absf(pdstat-0.35f)/0.35f)-1.5f*((maxf(pdstat,0.8f)-0.8f)/0.2f),0.0f),16.0f)*(1.0f+0.1f*(50-min(t-shuwat,50))/50.0f*(shuwapos>=100.0f))*canagain/50),tofloat(1.25f),tofloat(0.0f),tofloat(0.0f),-1
					BASS_FXSetParameters hPeakFX,pfilter
					repeat swaudionum*(feffect=1)
						BASS_FXSetParameters hPeakFX_sw.cnt,pfilter
					loop
					if(filtertype=1):pfilter=6,tofloat(4600.0f-4500.0f*cos(pdstat)),tofloat(minf(maxf(13.0f*minf(pdstat,0.2f)/0.2f+4.0f*(1.0-absf(pdstat-0.35f)/0.35f)-3.0f*((maxf(pdstat,0.8f)-0.8f)/0.2f),0.0f),16.0f)*(1.0f+0.1f*(1-disableshuwa)*(50-min(t-shuwat,50))/50.0f*(shuwapos>=100.0f))*canagain/65),tofloat(0.8f),tofloat(0.0f),tofloat(0.0f),-1*(pstat2=0)
					//if(filtertype=2):pfilter=6,tofloat(2000.0f-10000.0f+9950.0f*(cos(pdstat)*4.0f+cos(pdstat)*5.0f)/9.0f),tofloat(minf(maxf(11.0f*minf(pdstat,0.2f)/0.2f+6.0f*(1.0-absf(pdstat-0.35f)/0.35f)-1.5f*((maxf(pdstat,0.8f)-0.8f)/0.2f),0.0f),16.0f)*(1.0f+0.1f*(50-min(t-shuwat,50))/50.0f*(shuwapos>=100.0f))*canagain/50),tofloat(1.25f),tofloat(0.0f),tofloat(0.0f),-1
					if(filtertype=3):pfilter=6,tofloat(15000.0f-14200.0f*sin(sin(pdstat*1.25)/sin(1.25f)*1.5)/sin(1.5f)),tofloat(minf(maxf(15.0f*minf(pdstat,0.15f)/0.15f+2.0f*(1.0-absf(pdstat-0.35f)/0.35f)-3.0f*((maxf(pdstat,0.8f)-0.8f)/0.2f),0.0f),16.0f)*(1.0f+0.5f*(1-disableshuwa)*(50-min(t-shuwat,50))/50.0f*(shuwapos>=100.0f))*canagain/90),tofloat(0.8f),tofloat(0.0f),tofloat(0.0f),-1*(pstat2=0)
					//if(filtertype=4):pfilter=6,tofloat(1000.0f-5000.0f+4950.0f*(cos(pdstat)*4.0f+cos(pdstat)*5.0f)/9.0f),tofloat(minf(maxf(11.0f*minf(pdstat,0.2f)/0.2f+6.0f*(1.0-absf(pdstat-0.35f)/0.35f)-1.5f*((maxf(pdstat,0.8f)-0.8f)/0.2f),0.0f),16.0f)*(1.0f+0.1f*(50-min(t-shuwat,50))/50.0f*(shuwapos>=100.0f))*canagain/50),tofloat(1.25f),tofloat(0.0f),tofloat(0.0f),-1
					BASS_FXSetParameters hPeakFX2,pfilter
					repeat swaudionum*(feffect=1)
						BASS_FXSetParameters hPeakFX2_sw.cnt,pfilter
					loop
					if((filtertype=5)|((filtertype=6)&(feffect=1))){
						BASS_VST_SetParam hBitCFX,0,pdstat*30.0f/128.0f
						repeat swaudionum*(feffect=1)
							BASS_VST_SetParam hBitCFX_sw.cnt,0,pdstat*30.0f/128.0f
						loop
					}else{
						BASS_VST_SetParam hBitCFX,0,0.0f
						repeat swaudionum*(feffect=1)
							BASS_VST_SetParam hBitCFX_sw.cnt,0,0.0f
						loop
					}
					repeat userfilternum*(feffect=1),userfxnum-userfilternum
						cnt2=cnt
						if(filtertype=cnt2+100){
							repeat fxdef_prmnum.(int(userfx_params.cnt.0)),1
								if((userfilter_params.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)|(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)){
									if((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt<0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt<0.0f)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)){
										// linkされていない * ms
										BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(-userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt/10.0f,0.0f),1.0f)*(1.0f-pdstat)+minf(maxf(-userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt/10.0f,0.0f),1.0f)*pdstat
									}else:if(fxdef_max.cnt.(int(userfx_params.cnt2.0))>0.0f){
										// 一般
										BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(fxdef_prmmax.cnt.(int(userfx_params.cnt2.0))*(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt*(1.0f-pdstat)+userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt*pdstat)/fxdef_max.cnt.(int(userfx_params.cnt2.0)),0.0f),1.0f)
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)&(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt>=0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt>=0.0f)&(fxdef_linkprm.(int(userfx_params.cnt2.0))=cnt)){
										// linkされた 1/* 小節 (waveLength, Wobble period)
										if((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt>0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt>0.0f)){
											user_now.cnt2=divconv3(int((1.0f-pdstat)*divconv2(divconv(int(1.0f/userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)))+minf(pdstat,0.999f)*(divconv2(divconv(int(1.0f/userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)))+1)))
										}else{
											user_now.cnt2=0
										}
										if(user_now.cnt2>0){
											BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),maxf(minf(60.0f*4*1000/bpmfx/10/user_now.cnt2,1.0f),0.0f)
										}
										if(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_ECHO){
											BASS_VST_SetParam hFX_User.cnt2,3,maxf(minf(60.0f*4*1000/bpmfx/10/user_now.cnt2*1.25f,1.0f),0.0f)
										}
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_RATE)&(fxdef_linkprm.(int(userfx_params.cnt2.0))=cnt)){
										// linkされた rate (Tapestop speed)
										BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt*(1.0f-pdstat)+userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt*pdstat,0.0f),1.0f)/(1+bpmhalf)
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_PITCH)){
										// PitchShift pitch
										if((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt<0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt<0.0f)){
											BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(round((absf(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)*(1.0f-pdstat)+absf(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)*pdstat)*96.0f)/96.0f,0.0f),1.0f)
										}else{
											BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(absf(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)*(1.0f-pdstat)+absf(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)*pdstat,0.0f),1.0f)
										}
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_SAMPLE)&(fxdef_linkprm.(int(userfx_params.cnt2.0))=cnt)){
										// linkされた sample (reduction)
										BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt*(1.0f-pdstat)+userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt*pdstat)/128.0f,0.0f),1.0f)
									}else:if((int(userfx_params.cnt2.0)=FXDEF_FXTYPE_SICH)&(cnt=1)){
										// SideChain period
										if((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt>0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt>0.0f)){
											userfx_params.cnt2.cnt=1.0f/(divconv3(int((1.0f-pdstat)*divconv2(divconv(int(1.0f/userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)))+minf(pdstat,0.999f)*(divconv2(divconv(int(1.0f/userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)))+1))))
										}else{
											userfx_params.cnt2.cnt=0.0f
										}
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)&(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt>=0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt>=0.0f)){
										// linkされていない 1/* 小節 (Flanger periodなど)
										BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),maxf(minf((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt*(1.0f-pdstat)+userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt*pdstat)*60.0f*4*1000/bpmfx/10,1.0f),0.0f)
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(userfx_params_enable.cnt2.cnt=1.0f)&(fxdef_max.cnt.(int(userfx_params.cnt2.0))=-1.0f)&((peffstat2p!=peffstat2)|(filtertypep!=filtertype))){
										// updateTrigger
										BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),0.000003
									}
								}
							loop
						}else{
							repeat fxdef_prmnum.(int(userfx_params.cnt.0)),1
								if((userfilter_params.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)|(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)){
									if((userfx_params.cnt2.cnt<0.0f)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)){
										BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(-userfx_params.cnt2.cnt/10.0f,0.0f),1.0f)
									}else:if(fxdef_max.cnt.(int(userfx_params.cnt2.0))>0.0f){
										BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(fxdef_prmmax.cnt.(int(userfx_params.cnt2.0))*userfx_params.cnt2.cnt/fxdef_max.cnt.(int(userfx_params.cnt2.0)),0.0f),1.0f)
									}
								}
							loop
						}
					loop
					bassupdatefl=1
				}else:if(peffstat2=1){
					if((filtertype<0)|(filtertype>=5)){
						pfilter=6,tofloat(1000.0f),tofloat(0.0f),tofloat(1.2f),tofloat(0.0f),tofloat(0.0f),-1
						BASS_FXSetParameters hPeakFX,pfilter
						BASS_FXSetParameters hPeakFX2,pfilter
						repeat swaudionum*(feffect=1)
							BASS_FXSetParameters hPeakFX_sw.cnt,pfilter
							BASS_FXSetParameters hPeakFX2_sw.cnt,pfilter
						loop
					}
					repeat userfilternum*(feffect=1),userfxnum-userfilternum
						cnt2=cnt
						if(filtertype=cnt2+100){
							repeat fxdef_prmnum.(int(userfx_params.cnt.0)),1
								if((userfilter_params.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)|(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)){
									if((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt<0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt<0.0f)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)){
										// * ms
										BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(-userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt/10.0f,0.0f),1.0f)*(1.0f-pdstat)+minf(maxf(-userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt/10.0f,0.0f),1.0f)*pdstat
										if((int(userfx_params.cnt2.0)=FXDEF_FXTYPE_ECHO)&(cnt=2)){
											BASS_VST_SetParam hFX_User.cnt2,3,minf(maxf(-userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt/10.0f,0.0f),1.0f)*(1.0f-pdstat)+minf(maxf(-userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt/10.0f*1.25f,0.0f),1.0f)*pdstat
										}
									}else:if(fxdef_max.cnt.(int(userfx_params.cnt2.0))>0.0f){
										// 一般
										BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(fxdef_prmmax.cnt.(int(userfx_params.cnt2.0))*(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt*(1.0f-pdstat)+userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt*pdstat)/fxdef_max.cnt.(int(userfx_params.cnt2.0)),0.0f),1.0f)
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)&(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt>=0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt>=0.0f)&(fxdef_linkprm.(int(userfx_params.cnt2.0))=cnt)){
										// linkされた 1/* 小節 (waveLength, Wobble period)
										if((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt>0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt>0.0f)){
											user_now.cnt2=divconv3(int((1.0f-pdstat)*divconv2(divconv(int(1.0f/userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)))+minf(pdstat,0.999f)*(divconv2(divconv(int(1.0f/userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)))+1)))
										}else{
											user_now.cnt2=0
										}
										if(user_now.cnt2>0){
											BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),maxf(minf(60.0f*4*1000/bpmfx/10/user_now.cnt2,1.0f),0.0f)
										}
										if(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_ECHO){
											BASS_VST_SetParam hFX_User.cnt2,3,maxf(minf(60.0f*4*1000/bpmfx/10/user_now.cnt2*1.25f,1.0f),0.0f)
										}
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_RATE)&(fxdef_linkprm.(int(userfx_params.cnt2.0))=cnt)){
										// linkされた rate (Tapestop speed)
										BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt*(1.0f-pdstat)+userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt*pdstat,0.0f),1.0f)/(1+bpmhalf)
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_PITCH)){
										// PitchShift pitch
										if((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt<0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt<0.0f)){
											BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(round((absf(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)*(1.0f-pdstat)+absf(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)*pdstat)*96.0f)/96.0f,0.0f),1.0f)
										}else{
											BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(absf(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)*(1.0f-pdstat)+absf(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)*pdstat,0.0f),1.0f)
										}
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_SAMPLE)&(fxdef_linkprm.(int(userfx_params.cnt2.0))=cnt)){
										// linkされた sample (reduction)
										BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt*(1.0f-pdstat)+userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt*pdstat)/128.0f,0.0f),1.0f)
									}else:if((int(userfx_params.cnt2.0)=FXDEF_FXTYPE_SICH)&(cnt=1)){
										// SideChain period
										if((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt>0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt>0.0f)){
											userfx_params.cnt2.cnt=1.0f/(divconv3(int((1.0f-pdstat)*divconv2(divconv(int(1.0f/userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)))+minf(pdstat,0.999f)*(divconv2(divconv(int(1.0f/userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)))+1))))
										}else{
											userfx_params.cnt2.cnt=0.0f
										}
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)&(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt>=0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt>=0.0f)){
										// linkされていない 1/* 小節 (Flanger periodなど)
										BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),maxf(minf((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt*(1.0f-pdstat)+userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt*pdstat)*60.0f*4*1000/bpmfx/10,1.0f),0.0f)
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(userfx_params_enable.cnt2.cnt=1.0f)&(fxdef_max.cnt.(int(userfx_params.cnt2.0))=-1.0f)&((peffstat2p!=peffstat2)|(filtertypep!=filtertype))){
										// updateTrigger
										BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),0.000003
									}
								}
							loop
						}else{
							repeat fxdef_prmnum.(int(userfx_params.cnt.0)),1
								if((userfilter_params.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)|(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)){
									if((userfx_params.cnt2.cnt<0.0f)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)){
										BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(-userfx_params.cnt2.cnt/10.0f,0.0f),1.0f)
									}else:if(fxdef_max.cnt.(int(userfx_params.cnt2.0))>0.0f){
										BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(fxdef_prmmax.cnt.(int(userfx_params.cnt2.0))*userfx_params.cnt2.cnt/fxdef_max.cnt.(int(userfx_params.cnt2.0)),0.0f),1.0f)
									}
								}
							loop
						}
					loop
					bassupdatefl=1
				}else:if(peffstat2=0){
					pfilter=6,tofloat(1000.0f),tofloat(0.0f),tofloat(1.2f),tofloat(0.0f),tofloat(0.0f),-1
					BASS_FXSetParameters hPeakFX,pfilter
					BASS_FXSetParameters hPeakFX2,pfilter
					repeat swaudionum*(feffect=1)
						BASS_FXSetParameters hPeakFX_sw.cnt,pfilter
						BASS_FXSetParameters hPeakFX2_sw.cnt,pfilter
					loop
					repeat userfilternum*(feffect=1),userfxnum-userfilternum
						cnt2=cnt
						repeat fxdef_prmnum.(int(userfx_params.cnt.0)),1
							if((userfilter_params.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)|(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)){
								if((userfx_params.cnt2.cnt<0.0f)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)){
									BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(-userfx_params.cnt2.cnt/10.0f,0.0f),1.0f)
								}else:if(fxdef_max.cnt.(int(userfx_params.cnt2.0))>0.0f){
									BASS_VST_SetParam hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(fxdef_prmmax.cnt.(int(userfx_params.cnt2.0))*userfx_params.cnt2.cnt/fxdef_max.cnt.(int(userfx_params.cnt2.0)),0.0f),1.0f)
								}
							}
						loop
					loop
					bassupdatefl=1
				}
				// ByPassの設定
				if(peffstat2=1){
					repeat userfilternum*(feffect=1),userfxnum-userfilternum
						BASS_VST_SetParam hFX_User.cnt,29,0.0f
					loop
				}else{
					repeat userfilternum*(feffect=1),userfxnum-userfilternum
						BASS_VST_SetParam hFX_User.cnt,29,1.0f
					loop
				}
				filtertypep=filtertype
				peffstat2p=peffstat2
			}
			// ロングエフェクト (SideChainのみレーザーの後に処理)
			if(feffect=1){
				_cnt=cnt
				repeat userfxnum
					if(userfx_params.cnt.0=FXDEF_FXTYPE_SICH){
						// ユーザー定義FXのSideChain 更新トリガ判定
						if((userfx_params.cnt.1>0.0f)&(int(userfx_params.cnt.1*UNIT_MEASURE)>0)&(userfx_params.cnt.1<1.0f)){
							user_beat.cnt=(cnowfx-b2c(c2bnow))/max(int(userfx_params.cnt.1*UNIT_MEASURE),1)
						}else:if(userfx_params.cnt.1>=1.0f){
							stat1=b2c(c2bnow)
							user_beat.cnt=int((double(c2bnow)+double(cnowfx-stat1)/(b2c(c2bnow+1)-stat1))/userfx_params.cnt.1)
						}else:user_beat.cnt=0
						if(((user_beat.cnt!=user_beatp.cnt)|(c2bnow!=c2bnowp))&(userfx_params.cnt.1>0.0f)&(userfx_params.cnt.1<1.0f)&((feffectnow.0=100+cnt)|(feffectnow.1=100+cnt)|(cnt>=userfxnum-userfilternum))){
							if(/*(*/_cnt!=0/*)|(iscnowfjust=1)*/){
								user_trigger.cnt=1-user_trigger.cnt
								BASS_VST_SetParam hFX_User.cnt,0,double(user_trigger.cnt)
								bassupdatefl=1
							}
						}
					}
					user_beatp.cnt=user_beat.cnt
				loop
				c2bnowp=c2bnow
				c2bnowp_50ms=c2bnow_50ms
			}
			// SwitchAudioの音声切り替え処理
			swaudionow_result=-1
			if(swaudionow_filter!=-1):swaudionow_result=swaudionow_filter
			if(swaudionow!=-1):swaudionow_result=swaudionow
			if(delayfl=0){
				if(swaudionow_result<0){
					BASS_ChannelSetAttribute mid.0,2,double(vol)/100
					repeat swaudionum*(feffect=1)
						BASS_ChannelSetAttribute mid_sw.cnt,2,0.0
					loop
				}else{
					BASS_ChannelSetAttribute mid.0,2,0.0
					repeat swaudionum*(feffect=1)
						if(cnt!=swaudionow_result):BASS_ChannelSetAttribute mid_sw.cnt,2,0.0
					loop
					BASS_ChannelSetAttribute mid_sw.swaudionow_result,2,double(vol)/100
				}
			}
			if(bassupdatefl=1){
				BASS_ChannelUpdate mid
				repeat swaudionum*(feffect=1)
					BASS_ChannelUpdate mid_sw.cnt
				loop
			}
			swaudionow_resultp=swaudionow_result
			bpmp=bpm
			bpmfxp=bpmfx
			canagainp=canagain
			tppp=tpp
			tpp=tp
			tp=t
			cnowp=cnow
			cnowfxp=cnowfx
			gsel 0
			await 1
		loop
		repeat userfxnum
			_cnt=cnt
			repeat length2(userfx_params)
				userfx_params._cnt.cnt=_userfx_params._cnt.cnt
				userfx_params_enable._cnt.cnt=_userfx_params_enable._cnt.cnt
			loop
		loop
		repeat userfilternum
			_cnt=cnt
			repeat length2(userfilter_params)
				userfilter_params._cnt.cnt=_userfilter_params._cnt.cnt
				userfilter_params_min._cnt.cnt=_userfilter_params_min._cnt.cnt
				userfilter_params_max._cnt.cnt=_userfilter_params_max._cnt.cnt
			loop
		loop
		BASS_VST_SetParam hFX_Flan,0,0
		BASS_VST_SetParam hFX_BitC,0,0
		BASS_VST_SetParam hFX_TStp,0,0
		BASS_VST_SetParam hFX_Retr,1,0
		BASS_VST_SetParam hFX_Gate,4,0
		BASS_VST_SetParam hFX_Gate,7,0
		BASS_ChannelStop mid
		BASS_ChannelRemoveFX mid,hPeakFX
		BASS_ChannelRemoveFX mid,hPeakFX2
		if((pendfl=1)|(t-t_mo>=mlength)|(stopcnt>30)){
			if(mfl=1){
				BASS_StreamFree mid
				mid=-1
				if(mid2!=-1){
					BASS_StreamFree mid2
					mid2=-1
				}
			}
			break
		}
	loop
	if((synchro=1)&(vzoom(cnow)/UNIT_MEASURE/vtate-vyk/2>=posnow)){
		stat1___=min((vzoom(cnow)\(UNIT_MEASURE*vtate))*5/UNIT_MEASURE/vtate,24)
		repeat stat1___,1
			cnt3=cnt
			redraw 0
			gsel 0
			pos 0,0
			color 0,0,0
			boxf
			gmode 5,,,256
			repeat vyk
				cnt2=cnt
				repeat vtate
					stat1=stat1___
					pos vsep/2-(41+9*2)/2*(vzoomx=0)-(41+9*2)*3/4*(vzoomx=1)+cnt2*(41+9*2+vsp)-(stat1-cnt3)*((vzoom(cnow)\(UNIT_MEASURE*vtate))*(41+9*2+vsp)/UNIT_MEASURE/vtate)/stat1,topsep-10+vUNIT_MEASURE*(vtate-cnt-1)
					if(vzoomx=0){
						gcopy 6,0,vUNIT_MEASURE*(vtate*vyoko-1)-vUNIT_MEASURE*(cnt2*vtate+cnt),(41+9*2)*2,vUNIT_MEASURE+(cnt=0)
					}else{
						gsel BUF_ZOOMTEMP
						pos 0,0
						gzoom (41+9*2)*3,vUNIT_MEASURE+(cnt=0),6,0,vUNIT_MEASURE*(vtate*vyoko-1)-vUNIT_MEASURE*(cnt2*vtate+cnt),(41+9*2)*2,vUNIT_MEASURE+(cnt=0),0
						gsel 0
						gcopy BUF_ZOOMTEMP,0,0,(41+9*2)*3,vUNIT_MEASURE+(cnt=0)
					}
				loop
			loop
			redraw 1
			await 18
		loop
	}
	enda=1
	drawall=0
	redr=1
	if(mid!=-1){
		BASS_StreamFree mid
		mid=-1
	}
	if(mid2!=-1){
		BASS_StreamFree mid2
		mid2=-1
	}
	repeat swaudionum*(feffect=1)
		BASS_StreamFree mid_sw.cnt
	loop
	if(bpmhalf=1){
		repeat swaudionum*(feffect=1)
			BASS_StreamFree mid_sw2.cnt
		loop
	}
	if((cnowplus=1)&(cnowf>0)):cnowf--:cnowplus=0
	gmode 0
	gosub *draw
	pendfl=-1
	return

#defcfunc min int a,int b
	if(a>=b){
		return b
	}else:return a
	
#defcfunc max int a,int b
	if(a<=b){
		return b
	}else:return a

#defcfunc maxf double a,double b
	if(a>=b){
		return a
	}else:return b
	
#defcfunc minf double a,double b
	if(a>=b){
		return b
	}else:return a
	
#defcfunc min3 int a,int b,int c
	return min(min(a,b),c)
	
#defcfunc min4 int a_,int b_,int c_,int d_
	return min(min(min(a_,b_),c_),d_)
	
#defcfunc min5 int a__,int b__,int c__,int d__,int e__
	return min(min(min(min(a__,b__),c__),d__),e__)
	
#defcfunc min6 int a___,int b___,int c___,int d___,int e___,int f___
	return min(min5(a___,b___,c___,d___,e___),f___)

#defcfunc fxdef_str2param str a, int p1
	a2=a
	if(p1=FXDEF_INT){
		return double(a)
	}else:if(p1=FXDEF_RATE){
		if(strmid(a2,-1,1)="%"){
			return double(a)/100.0f
		}else{
			return double(a)
		}
	}else:if(p1=FXDEF_SAMPLE){
		if(strmid(a2,-1,7)="samples"){
			return double(int(a))
		}else:return 0.0f
	}else:if(p1=FXDEF_LENGTH){
		if(strmid(a2,-1,2)="ms"){
			return -double(a)/1000.0f
		}else:if((strmid(a2,-1,1)="s")&(strmid(a2,-1,2)!="es")){
			return -double(a)
		}else:if(strmid(a2,0,2)="1/"){
			if(int(strmid(a2,2,16))>0){
				return 1.0f/int(strmid(a2,2,16))
			}else:return 0.0f
		}else:return double(a)
	}else:if(p1=FXDEF_SWITCH){
		if(a="on"){
			return 1.0f
		}else:return 0.0f
	}else:if(p1=FXDEF_FREQ){
		if(strmid(a2,-1,3)="kHz"){
			return double(a)*1000.0f
		}else:if((strmid(a2,-1,2)="Hz")){
			return double(a)
		}else:return 0.0f
	}else:if(p1=FXDEF_FLOAT){
		return maxf(double(a),0.01f)
	}else:if(p1=FXDEF_NEGDB){
		if(strmid(a2,-1,2)="dB"){
			return maxf(-double(a),0.0f)
		}
	}else:if(p1=FXDEF_PITCH){
		if(instr(a2,1,".")!=-1){
			return minf(maxf(double(a),-48.0f),48.0f)/48.0f/2.0f+0.50f
		}else:return -(minf(maxf(double(a),-48.0f),48.0f)/48.0f/2.0f+0.50f)
	}else:if(p1=FXDEF_FILENAME){
		swaudio.swaudionum=strtrim(a2,0,'"')
		swaudionum++
	}
	return 0.0f

#defcfunc divconv int divconvval
	_divconvval=divconvval
	if((_divconvval>=2)&(_divconvval<4)):_divconvval=2
	if((_divconvval>=4)&(_divconvval<6)):_divconvval=4
	if((_divconvval>=6)&(_divconvval<8)):_divconvval=6
	if((_divconvval>=8)&(_divconvval<12)):_divconvval=8
	if((_divconvval>=12)&(_divconvval<16)):_divconvval=12
	if((_divconvval>=16)&(_divconvval<24)):_divconvval=16
	if((_divconvval>=24)&(_divconvval<32)):_divconvval=24
	if((_divconvval>=32)&(_divconvval<48)):_divconvval=32
	if((_divconvval>=48)&(_divconvval<64)):_divconvval=48
	if((_divconvval>=64)&(_divconvval<96)):_divconvval=64
	if((_divconvval>=96)&(_divconvval<128)):_divconvval=96
	if((_divconvval>=128)&(_divconvval<192)):_divconvval=128
	if(_divconvval>=192):_divconvval=192
	return _divconvval


#defcfunc divconv2 int divconvval
	if(divconvval=0){
		return 0
	}else:if(divconvval=2){
		return 1
	}else:if(divconvval=4){
		return 2
	}else:if(divconvval=6){
		return 3
	}else:if(divconvval=8){
		return 4
	}else:if(divconvval=12){
		return 5
	}else:if(divconvval=16){
		return 6
	}else:if(divconvval=24){
		return 7
	}else:if(divconvval=32){
		return 8
	}else:if(divconvval=48){
		return 9
	}else:if(divconvval=64){
		return 10
	}else:if(divconvval=96){
		return 11
	}else:if(divconvval=128){
		return 12
	}else:if(divconvval=192){
		return 13
	}else:return 0


#defcfunc divconv3 int divconvval
	if(divconvval=0){
		return 0
	}else:if(divconvval=1){
		return 2
	}else:if(divconvval=2){
		return 4
	}else:if(divconvval=3){
		return 6
	}else:if(divconvval=4){
		return 8
	}else:if(divconvval=5){
		return 12
	}else:if(divconvval=6){
		return 16
	}else:if(divconvval=7){
		return 24
	}else:if(divconvval=8){
		return 32
	}else:if(divconvval=9){
		return 48
	}else:if(divconvval=10){
		return 64
	}else:if(divconvval=11){
		return 96
	}else:if(divconvval=12){
		return 128
	}else:if(divconvval=13){
		return 192
	}else:return 0

#defcfunc a2p str a
	a2=a
	p=peek(a2,0)
	if((p>='0')&(p<='9')){
		return int(a)
	}else:if((p>='A')&(p<='Z')){
		return p-'A'+10
	}else:if((p>='a')&(p<='o')){
		return p-'a'+36
	}else:return -1

#defcfunc p2a int p1
	if((p1>=0)&(p1<=9)){
		return str(p1)
	}else:if((p1>=10)&(p1<36)){
		pchr=(p1-10)+'A'
	}else:if((p1>=36)&(p1<51)){
		pchr=(p1-36)+'a'
	}else:return -1
	pchr2="*"
	poke pchr2,0,pchr
	return pchr2

#deffunc ardel array ar,int armax,int artarget
	if(armax<2):return
	if(artarget<0):return
	if(artarget>armax-1):return
	repeat armax-artarget-1,artarget
		ar.cnt=ar.(cnt+1)
	loop
	return

#deffunc ardel2 array ar1,int arxmax,int arymax,int artargetx
	if(arxmax<2):return
	if(artargetx<0):return
	if(artargetx>arxmax-1):return
	repeat arxmax-artargetx-1,artargetx
		arcnt2=cnt
		repeat arymax
			ar1.arcnt2.cnt=ar1.(arcnt2+1).cnt
		loop
	loop
	return
/*
#defcfunc b2c int b1
	_cbcnt=0
	b2=0
	repeat beatlnum
		if(cnt=beatlnum-1){
			if(_cbcnt+UNIT_MEASURE*(b1-b2)*beatl.cnt.1/beatl.cnt.2>beatl.cnt.0){
				_cbcnt+=UNIT_MEASURE*beatl.cnt.1/beatl.cnt.2*(b1-b2)
				//b2=b1
			}
		}else{
			if(_cbcnt+UNIT_MEASURE*beatl.cnt.1/beatl.cnt.2*(b1-b2)>beatl.cnt.0){
				_cbcnt+=UNIT_MEASURE*beatl.cnt.1/beatl.cnt.2*min((beatl.(cnt+1).0-beatl.cnt.0)/(UNIT_MEASURE*beatl.cnt.1/beatl.cnt.2),b1-b2)
				b2+=min((beatl.(cnt+1).0-beatl.cnt.0)/(UNIT_MEASURE*beatl.cnt.1/beatl.cnt.2),b1-b2)
			}else:break
		}
	loop
	return _cbcnt
*/
#defcfunc b2c int b1
	_cbcnt=0
	b2=0
	repeat beatlnum
		if(cnt=beatlnum-1){
			_cbcnt+=UNIT_MEASURE*beatl.cnt.1/beatl.cnt.2*(b1-b2)
		}else{
			_cbcnt+=UNIT_MEASURE*beatl.cnt.1/beatl.cnt.2*min((beatl.(cnt+1).0-beatl.cnt.0)/(UNIT_MEASURE*beatl.cnt.1/beatl.cnt.2),b1-b2)
			b2+=min((beatl.(cnt+1).0-beatl.cnt.0)/(UNIT_MEASURE*beatl.cnt.1/beatl.cnt.2),b1-b2)
		}
		if(b1<=b2):break
	loop
	return _cbcnt

#defcfunc c2b int c1
	cb=0
	cb2=0
	repeat
		repeat beatlnum
			if(beatl.cnt.0<=cb){
				beatn=beatl.cnt.1
				beatd=beatl.cnt.2
				beatlfcnt=cnt+1
			}
		loop
		if(cb+UNIT_MEASURE*beatn/beatd>c1):break
		cb+=UNIT_MEASURE*beatn/beatd
		cb2++
	loop
	return cb2

#module GetGCDandLCM
#defcfunc _gcd int high, int low, local tmp
    tmp = high \ low
    if tmp {
        return _gcd(low, tmp)
    } else {
        return low
    }

#defcfunc gcd int i1, int i2
    if i1 > i2 {
        return _gcd(i1, i2)
    } else {
        return _gcd(i2, i1)
    }

#defcfunc lcm int i1, int i2
    return i1 * i2 / gcd(i1, i2)
#global

#defcfunc ginfo2
	ginfostat2=ginfo(2)
	if(ginfostat2!=-1){
		ginfostat=ginfo(3)
		gsel 0
		IsIconic hwnd
		if(stat=1):ginfostat2=-1
		gsel ginfostat
	}
	return ginfostat2

#defcfunc tofloat double p1
	temp = p1
	return lpeek(temp)>>29&7|(p1<0)<<31|lpeek(temp,4)-(p1!0)*0x38000000<<3

#module
#defcfunc cnvstowf str p1
	cnvstow p2,p1
	return p2
#global

#module
    #uselib "gdi32.dll"
    #func _GetTextMetricsA "GetTextMetricsA" sptr,sptr

    #defcfunc getstrh int _hdc , str _string
	    dim tm,56
	    szTxt = _string
	
	    _GetTextMetricsA _hdc,varptr@(tm)
	    notesel szTxt
	    return tm.0*notemax
	    
#global

#defcfunc headcmp var a,int num,str b
	memcpy _headcmpstr,a,num,0,0
	poke _headcmpstr,num
	return _headcmpstr=b

#module
	#uselib "user32"
	#func global DrawTextW "DrawTextW" wptr,wptr,wptr,wptr,wptr
    #deffunc mesW var p1, local p //Unicode対応のAPIを使う
        p.0 = ginfo_cx@, ginfo_cy@, ginfo_winx@, ginfo_winy@
        DrawTextW@ hdc,varptr(p1),-1,varptr(p),0
    return
#global

#module
#defcfunc tiltname int type
	if(type=0){
		return "normal"
	}else:if(type=1){
		return "bigger"
	}else:if(type=2){
		return "biggest"
	}else:if(type=3){
		return "keep_normal"
	}else:if(type=4){
		return "keep_bigger"
	}else:if(type=5){
		return "keep_biggest"
	}else:if(type=6){
		return "zero"
	}else{
		return strf("%g",double(type-7)/100000-1000.0f)
	}

#defcfunc tiltname_input int type
	if(type=0){
		return "normal"
	}else:if(type=1){
		return "bigger"
	}else:if(type=2){
		return "biggest"
	}else:if(type=3){
		return "keep_normal"
	}else:if(type=4){
		return "keep_bigger"
	}else:if(type=5){
		return "keep_biggest"
	}else:if(type=6){
		return "zero"
	}else{
		return strf("%g",double(type-7)/1000-100000.0f)
	}

#defcfunc tiltname2 int type1,int type2
	if(type1=type2){
		return tiltname(type1)
	}else{
		return tiltname(type1)+";"+tiltname(type2)
	}

#defcfunc tiltname2_input int type1,int type2
	if(type1=type2){
		return tiltname_input(type1)
	}else{
		return tiltname_input(type1)+";"+tiltname_input(type2)
	}

#defcfunc tiltname2_disp_long int type1,int type2
	if(type1=type2){
		return tiltname_disp_long(type1)
	}else{
		return tiltname_disp_long(type1)+";"+tiltname_disp_long(type2)
	}

#defcfunc tiltval str type
	if(type="normal"){
		return 0
	}else:if(type="bigger"){
		return 1
	}else:if(type="biggest"){
		return 2
	}else:if(type="keep_normal"){
		return 3
	}else:if(type="keep_bigger"){
		return 4
	}else:if(type="keep_biggest"){
		return 5
	}else:if(type="zero"){
		return 6
	}else{
		type_=type
		if((strmid(type_,0,1)!="0")&(strmid(type_,0,1)!="-")&(int(strmid(type_,0,1))=0)){
			return -1
		}else:if((double(type)>=-100000.0f)&(double(type)<=100000.0f)){
			return int((double(type)+100000.0f)*1000)+7
		}else{
			return -1
		}
	}

#defcfunc tiltval1 str type
	type_=type
	idx=instr(type_,0,";")
	if(idx=-1){
		return tiltval(type_)
	}else{
		return tiltval(strmid(type_,0,idx))
	}

#defcfunc tiltval2 str type
	type_=type
	idx=instr(type_,0,";")
	if(idx=-1){
		return tiltval(type_)
	}else{
		return tiltval(strmid(type_,idx+1,16))
	}

#defcfunc tiltname_disp int type
	if(type=0){
		return "NORMAL"
	}else:if(type=1){
		return "BIGGER"
	}else:if(type=2){
		return "BIGGEST"
	}else:if(type=3){
		return "KEEP(NOR)"
	}else:if(type=4){
		return "KEEP(ER)"
	}else:if(type=5){
		return "KEEP(EST)"
	}else:if(type=6){
		return "ZERO"
	}else{
		return strf("%g",double(type-7)/1000-100000.0f)
	}

#defcfunc tiltname_disp_long int type
	if(type=0){
		return "NORMAL"
	}else:if(type=1){
		return "BIGGER"
	}else:if(type=2){
		return "BIGGEST"
	}else:if(type=3){
		return "KEEP(NORMAL)"
	}else:if(type=4){
		return "KEEP(BIGGER)"
	}else:if(type=5){
		return "KEEP(BIGGEST)"
	}else:if(type=6){
		return "ZERO"
	}else{
		return strf("%g",double(type-7)/1000-100000.0f)
	}
#global