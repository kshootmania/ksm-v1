#deffunc start_play
	chdir dir_default+"\\songs"
	JStickSearchID 0,joylist
	length_joylist=stat
	gosub *joyinit
	if((iscmdline=0)|(iscourse=1)){
		chdir dir_default+"\\songs"
		dirlist filelistdir,csongdir,5
		if(stat=0){
			dialog lang.2.13/*"指定された譜面ファイルが見つかりません。"*/
			chdir dir_default+"\\songs"
			state=st_select
			return
		}
		chdir csongdir
	}else{
		chdir getpath(cnotesfile,32)
	}
	fps=0
	totalscore=0
	totalscorep=0
	totalscore_disp_base=0
	totalscore_disp_baset=-50000
	c2tcnt=0
	hsrccnt=0
	notecnt=0
	analogcnt=0
	chocnt=0
	font lang.0.1,getsize(18)
	if(imeget()=1):imeset 0
	sdim csongfile,1,1
	cmovfile=""
	mfl=0
	mflp=0
	vfl=0
	vflp=0
	mstop=0
	mshift=0
	mtotalshift=0
	mendt=-1
	mendc=-1
	mendat=-1
	fadeoutfl=0
	ldelayresett=-5000
	at=0
	bpm=120000
	beatn=4
	beatd=4
	stpsh=0
	hs=70
	offset=diroffset
	endfl=0
	tochu=1
	tochu_esc=0
	tickfl=0
	dim tickp,6
	tickp=-1,-1,-1,-1,-1,-1
	tickcp0=-50000
	tickcp1=-50000
	dim chokkakup,2
	chokkakup=-1,-1
	notesejfcnt=0
	ddim ttp_,1
	ttp_=16.6f
	laserdelay0_orig=bufferlength/*233-ttp*/-soundfx_delay-GLOBAL_SOUNDFX_DELAY
	t_mo=-50000
	t_mop=-50000
	t_moex=0
	chainvt=-1
	chainefft=-1
	chainnow_song=0
	chainmax_song=0
	noerror_song=1
	if((iscourse=0)|(coursenow=0)){
		chainmax=0
		chainnow=0
		noerror=1
		if((effratetype<=0)&(iscourse=0)){
			gauge=0
			unlimited_gauge=0
		}else{
			gauge=100000
			unlimited_gauge=100000
		}
	}
	no_hstype_c=1
	dim judge,6,2
	dim ljudge,2
	dim shljudge,4
	dim ljudgep,2
	dim shljudgep,4
	dim ljudgeendt,2
	dim shljudgeendt,4
	ljudgeendt=-50000,-50000
	shljudgeendt=-50000,-50000,-50000,-50000
	dim judgel,6,judgelmax,2
	dim judgelnext,6
	notenum=0
	notefxnum=0
	shljnum=0
	longjnum=0
	analogjnum=0
	analoganjnum=0
	chiprate=1
	longrate=1
	laserrate=1
	dim note,131072,8
	dim notefx,131072,8
	dim notese,131072
	HashClear se_ids
	dim notesej,131072,4
	dim longj,131072,8
	dim shlj,131072,8
	dim analogj,131072,5
	dim analoganj,131072,6
	dim analoganjdamage,131072
	dim analogbuf,131072
	dim analogturn,2,131072
	dim analogturnnum,2
	dim noteresult,131072
	dim keystat,7,11
	dim keystatp,7,11
	dim keystator,11
	dim keystatorp,11
	dim longstat,2
	dim longcritical,2
	dim longstatpp,2
	dim lstartt,2
	dim shlstat,4
	dim shlcritical,4
	dim shlstatpp,4
	dim shlstartt,4
	analognum=0
	dim analog,131072,10
	dim analoggr,131072
	dim analoggrmax,2
	anarannum=0
	anaranfl=1
	dim anaran,131072,3
	dim anagrran,2,131072
	dim analognext,131072
	dim analogprev,131072
	fxparamsnum=0
	dim fxparams,131072,3
	fxnum=0
	dim fx,131072,5
	spinnum=0
	sprnum=0
	dim spin,131072,5
	dim spr,131072,6
	/*
	rotatenum=0
	dim rotate,131072,6*/
	tiltnum=0
	dim tilt,131072,2
	tilttype=0
	tiltstart=0
	tiltfcnt=-1
	bpmlnum=0
	dim bpml,131072,3
	beatlnum=0
	dim beatl,131072,2
	stpnum=0
	dim stp,131072,2
	anagainnum=0
	dim anagain,131072,3
	anafilnum=0
	dim anafil,131072,3
	anvolnum=0
	dim anvol,131072,3
	ansenum=0
	dim anse,131072,2
	divnum=0
	dim div,8192
	ddim rop,2
	userfxnum=0
	sdim userfx_name,16,256
	ddim userfx_params,256,9
	ddim userfx_params_enable,256,9
	userfilternum=0
	sdim userfilter_name,16,256
	ddim userfilter_params,256,9
	ddim userfilter_params_min,256,9
	ddim userfilter_params_max,256,9
	userchprmnum=0
	userchprmfcnt=0
	ddim userchprm,4096,6
	sdim swaudio,256,32
	swaudionum=0
	dim userfx_swaudiomid,256
	spintp=0
	spinangle=0
	spinanglepp=0
	spinrpt=-50000
	spinrp=0
	spinrps=0
	dim spinnow,4
	spinnow=-1,0,0,-1 // 方向(L:0 R:1),開始c,長さc,番号
	dim sprnow,4
	sprnow=-1,0,0,-1 // 方向(L:0 R:1),開始c,長さc,番号
	bgmouikkaic=0
	bgmouikkaia=0
	bgmouikkai=0
	bgmouikkaicnt=-1
	bgmouikkaikaisu=2
	dim meshstat_y,2,2
	dim meshstat_x,2,2
	dim meshstat_z,2,2
	dim analogstatp,2
	dim arstatp,8,3
	dim analogpos,2
	analogpos=0,1000
	dim analognow,2
	analognow=-1,-1
	dim panalognow,2
	dim panalognow2,2
	panalognow=0,1000
	dim canalognow,2
	canalognow=-1,-1
	ddim anadamage,2
	shuwat=-50000
	ddim shuwapos,1
	shuwapos=1000.0f
	disableshuwa=0
	dim analogfuture,2
	analogfuture=-1,-1
	dim analognowp,2
	analognowp=-1,-1
	dim panalognowp,2
	panalognowp=0,0
	dim canalognowp,2
	canalognowp=0,0
	dim analogposp,2
	analogposp=0,1000
	dim analogokt,2
	analogokt=-50000,-50000
	dim analogngt,2
	analogngt=-50000,-50000
	dim analogngcnt,2
	analogngcnt=0,0
	dim anapret,2
	anapret=-50000,-50000
	dim anastartt,2
	anastartt=-50000,-50000
	dim anaendt,2
	anaendt=-50000,-50000
	dim anadjp,2
	anadjp=0,0
	dim analogokcnt,2
	analogokcnt=-1,-1
	dim analoganokt,2
	analoganokt=-50000,-50000
	dim analoganokcnt,2
	analoganokcnt=-1,-1
	dim analogefft,2,131072,2
	dim analogefftnum,2
	dim anaendstat,2
	anaendstat=-1,-1
	dim anadirection,2
	anadirection=1,0
	dim anadirectionp,2
	anadirectionp=1,0
	dim anaturnt,2
	anaturnt=-50000,-50000
	dim pdoutt,2
	pdoutt=-50000,-50000
	dim anakp,2
	anakp=-1,-1
	dim anakdiff,2
	anakdiff=0,0
	dim anaktp
	anaktp=0,0
	oldpfilter=0
	shaket=-50000
	shakewidth=0
	shake2c=-50000
	shake2width=0
	shake2len=1
	shake2n=1
	shake2type=1
	stat179p=1
	tadj=0
	stat0tp=0
	nowsttp=-1
	lanesubflp=1
	lanesubfl=0
	bpmlsttpfcnt=0
	bpmlsttpfcnt2=0
	bpmlcfcnt=0
	bpmlcfcnt_fx=0
	bpmlcfcnt_fx_50ms=0
	stpfcnt=0
	ddim ztopnowp,1
	ddim zbotnowp,1
	ddim zsidenowp,1
	ddim ztiltnowp,1
	ddim ztiltrate,1
	ddim ztiltratep,1
	ddim rorp,1
	ztilton=0
	csongtotal=0
	randomize
	if(turn=2){
		stat1=0
		dim pturn,4
		repeat 4
			cnt2=cnt
			repeat
				pturn.cnt2=rnd(4)
				repeat cnt2
					if(pturn.cnt=pturn.cnt2){
						stat1=1
						break
					}else:stat1=0
				loop
				if(stat1=0){
					break
				}
			loop
		loop
		pturnl=rnd(2)
		pturna=rnd(2)
	}
	if((turn=3)|(turn=4)){
		pturnl=rnd(2)
		pturna=rnd(2)
	}
	if(auto=1){
		dim kmode,3
		kmode=shortmode,longmode,analogmode
		if(shortmode=mode_on):shortmode=mode_auto
		if(longmode=mode_on):longmode=mode_auto
		if(analogmode=mode_on):analogmode=mode_auto
	}
	if(adjmode=1){
		dim kmode,3
		kmode=shortmode,longmode,analogmode
		shortmode=mode_on
		longmode=mode_hide
		analogmode=mode_hide
	}
	gsel 0
	if(output=1){
		alCreateImage 50,ginfo_winx,ginfo_winy
	}
	exist cnotesfile
	if(strsize<=0){
		dialog lang.2.13/*"指定された譜面ファイルが見つかりません。"*/
		if(iscmdline=1):end
		chdir dir_default+"\\songs"
		state=st_select
		return
	}

	// 譜面ファイルの読み込み
	notesel buf
	noteload cnotesfile,-1

	varmd5 csongmd5hash, buf, strlen(buf)
	isutf8=0
	if (lpeek(buf, 0) & 0x00FFFFFF) == 0xBFBBEF{
		isutf8=1
		DeleteUTF8BOM buf
	}

	// IR用のファイルハッシュを計算
	sdim buf_ir_chart,strlen(buf)
	cnt3=-1
	dim anagrcnt,2
	sdim d,256,notemax
	ir_ignore="//","title=","title_img=","artist=","artist_img=","effect=","illustrator=","jacket=","level=","difficulty=","m=","o=","v=","vo=","mvol=","bg=","layer=","po=","plength=","pfiltergain=","filtertype=","chokkakuautovol=","chokkakuvol=","chokkakuse=","icon=","ver=","fx-l=","fx-r=","#define","information="
	repeat notemax
		noteget buf2,cnt
		d.cnt=buf2
		f=1
		foreach ir_ignore
			if(headcmp(buf2,strlen(ir_ignore.cnt),ir_ignore.cnt)){
				f=0
				break
			}
		loop
		if(f=1){
			buf_ir_chart+=buf2+"\n"
		}
	loop
	varmd5 csongmd5hash_ir_chart, buf_ir_chart, strlen(buf_ir_chart)

	// 譜面内容の読み込み
	sp=notemax
	buf=""
	repeat sp
		cnt2=cnt
		if(d.cnt="--"){
			div.divnum=0
			exc=0
			repeat
				if(cnt2+cnt+1>=length(d)){
					break
				}
				if(d.(cnt2+cnt+1)="--"){
					break
				}
				if(strmid(d.(cnt2+cnt+1),7,1)!="|"){
					div.divnum--
				}
				div.divnum++
			loop
			divnum++
		}
	loop
	cnt2a=-1
	stat4=0
	cnt3=-1
	ddim cbcnt,1
	beatn=4
	beatd=4
	csongtitle=""
	csongtitleimg=""
	csongartist=""
	csongartistimg=""
	csongeffect=""      // IR用
	csongillustrator="" // IR用
	csongjacket=""
	csongvol=100*dirvol/100
	csongoftbpm=0
	laserdelay1=40
	disableautoanvol=0
	bgname="desert"
	bgname_l="arrow"
	bgspeed=0
	bgrotation=3
	csonglevel=0
	csongver=""
	csongver_int=100
	fxdefbuf_fx=""
	fxdefbuf_filter=""
	csongfile_exist=0
	csonginfo=""
	csongeffect=""
	csonglayerstr=""
	tiltp=7
	repeat sp
		cnt2a++
		if(d.cnt="--"){
			cnt3++ // カレント小節数
			if(cnt3>0):cbcnt+=bpba*beatn/beatd
			cnt2=-1
			continue
		}
		if(headcmp(d.cnt,3,"bg=")){
			bgname=strmid(d.cnt,3,128)
			_sjis_ bgname
			continue
		}
		if(headcmp(d.cnt,6,"layer=")){
			csonglayerstr=strmid(d.cnt,6,256)
			_sjis_ csonglayerstr
			continue
		}
		if(headcmp(d.cnt,6,"title=")){
			csongtitle=strmid(d.cnt,6,128)
			_utf8_ csongtitle
			if(vfoldername=1){
				csongtitle+="("+utf8enc(strmid(csongdir,instr(csongdir,0,"\\")+1,strlen(csongdir)-instr(csongdir,0,"\\")-1))+")"
			}
			continue
		}
		if(headcmp(d.cnt,10,"title_img=")){
			csongtitleimg=strmid(d.cnt,10,128)
			_sjis_ csongtitleimg
			continue
		}
		if(headcmp(d.cnt,7,"artist=")){
			csongartist=strmid(d.cnt,7,128)
			_utf8_ csongartist
			continue
		}
		if(headcmp(d.cnt,7,"effect=")){
			csongeffect=strmid(d.cnt,7,128)
			_sjis_ csongeffect
			continue
		}
		if(headcmp(d.cnt,12,"illustrator=")){
			csongillustrator=strmid(d.cnt,12,128)
			_sjis_ csongillustrator
			continue
		}
		if(headcmp(d.cnt,12,"information=")){
			csonginfo=strmid(d.cnt,12,128)
			_sjis_ csonginfo
			continue
		}
		if(headcmp(d.cnt,11,"artist_img=")){
			csongartistimg=strmid(d.cnt,11,128)
			_sjis_ csongartistimg
			continue
		}
		if(headcmp(d.cnt,7,"jacket=")){
			csongjacket=strmid(d.cnt,7,128)
			_sjis_ csongjacket
			if(instr(csongjacket,0,".")=-1){
				if(iscmdline=0){
					if(instr(csongdir,instr(csongdir,0,"\\")+1,"\\")>=0){
						csongjacket="..\\..\\..\\..\\imgs\\jacket\\"+csongjacket+".jpg"
					}else:csongjacket="..\\..\\..\\imgs\\jacket\\"+csongjacket+".jpg"
				}
			}
		}
		if(headcmp(d.cnt,11,"difficulty=")){
			stat2=strmid(d.cnt,11,16)
			if(stat2="light"){
				csongdifficulty=0
			}else:if(stat2="challenge"){
				csongdifficulty=1
			}else:if(stat2="extended"){
				csongdifficulty=2
			}else:csongdifficulty=3
			continue
		}
		if(headcmp(d.cnt,6,"level=")){
			csonglevel=int(strmid(d.cnt,6,2))
			continue
		}
		if(headcmp(d.cnt,16,"chokkakuautovol=")){
			disableautoanvol=1-max(min(int(strmid(d.cnt,16,1)),1),0)
		}
		if(headcmp(d.cnt,2,"m=")){
			//BASS_SetConfig 45,16777216
			sdim csongfile,1,1
			stat1=strmid(d.cnt,2,1024)
			_sjis_ stat1
			split stat1,";",csongfile
			dim mid,length(csongfile)*(auto=0)+auto
			//dim mid_pre,length(csongfile)*(auto=0)+auto
			exist csongfile.0
			if((length(csongfile)=2)&(strsize=-1)):csongfile.0=csongfile.1
			if(length(csongfile)<=1){
				dim mid,1
				//dim mid_pre,1
				dim hPeakFX,1
				dim hPeakFX2,1
				dim hCompFX,1
				dim hVolFX2,1
				dim hBitCFX,1
				peffect=1
				feffect=1
			}else:if(length(csongfile)<=2){
				dim mid,2-(auto=1)
				//dim mid_pre,2-(auto=1)
				dim hPeakFX,2-(auto=1)
				dim hPeakFX2,2-(auto=1)
				dim hCompFX,2-(auto=1)
				dim hVolFX2,2-(auto=1)
				dim hBitCFX,2-(auto=1)
				peffect=1
				feffect=0
			}else{
				peffect=0
				feffect=0
			}
			exist csongfile.(max(length(csongfile)-1,0))
			if((auto=1)&(length(csongfile)>=4)&(strsize!=-1)){
				csongfile.0=csongfile.1
				csongfile.1=csongfile.3
				dim mid,2
				//dim mid_pre,2
			}
			if(length(csongfile)>=2){
				exist csongfile.1
				if(((strsize=-1)|(feffecta=1))&(auto=1)){
					dim mid,1
					//dim mid_pre,1
					stat1=csongfile.0
					sdim csongfile,256,1
					csongfile.0=stat1
					feffect=1
				}
				if(((strsize=-1)|(feffecta=1))&(auto=0)){
					dim mid,1
					//dim mid_pre,1
					feffect=1
				}
			}
			exist csongfile.(max(length(csongfile)-1,0))
			if(((strsize=-1)|(peffecta=1))&(length(csongfile)>=4)&(auto=1)){
				stat1=csongfile.1
				sdim csongfile,256,1
				csongfile.0=stat1
				dim hPeakFX,1
				dim hPeakFX2,1
				dim hCompFX,1
				dim hVolFX2,1
				dim hBitCFX,1
				peffect=1
				oldpfilter=1
				if(anagainnum=0){
					anagain.0.0=0
					anagain.0.1=50
					anagainnum=1
					laserdelay1=0
					disableshuwa=1
				}else:if((anagainnum=1)&(anagain.0.1=0)){
					anagain.0.0=0
					anagain.0.1=50
					laserdelay1=0
					disableshuwa=1
				}
			}
			if(((peffecta=1)|(strsize=-1))&(auto=0)){
				if((length(csongfile)>=4)&(anagainnum=0)){
					anagain.0.0=0
					anagain.0.1=50
					anagainnum=1
					laserdelay1=0
					disableshuwa=1
				}else:if((length(csongfile)>=4)&(anagainnum=1)&(anagain.0.1=0)){
					anagain.0.0=0
					anagain.0.1=50
					laserdelay1=0
					disableshuwa=1
				}
				dim mid,2-(feffect=1)
				//dim mid_pre,2-(feffect=1)
				dim hPeakFX,2-(feffect=1)
				dim hPeakFX2,2-(feffect=1)
				dim hCompFX,2-(feffect=1)
				dim hVolFX2,1
				dim hBitCFX,2-(feffect=1)
				peffect=1
				oldpfilter=1
			}
			if((feffect=1)&(peffect=0)){
				dim mid,1
				//dim mid_pre,1
				dim hPeakFX,1
				dim hPeakFX2,1
				dim hCompFX,1
				dim hVolFX2,1
				dim hBitCFX,1
				peffect=1
				oldpfilter=1
				anagain.0.0=0
				anagain.0.1=50
				anagainnum=1
				laserdelay1=0
				disableshuwa=1
			}
			foreach mid
				mid.cnt=-1
				//mid_pre.cnt=-1
			loop
			foreach mid
				if(auto=0){
					if((length(csongfile)<=cnt)|((cnt>=2)&(peffect=1))){
						ccsongfile=csongfile.min(cnt\2,length(csongfile)-1)
					}else{
						ccsongfile=csongfile.cnt
					}
				}else{
					if((length(csongfile)<=cnt)|((cnt>=2)&(peffect=1))){
						ccsongfile=csongfile.min(1,length(csongfile)-1)
					}else:if((auto=1)&(length(csongfile)>=4)&(strsize!=-1)){
						ccsongfile=csongfile.(min(cnt,length(csongfile)-1))
					}else{
						ccsongfile=csongfile.(length(csongfile)-1)
					}
				}
				csongfile_exist=1
				exist ccsongfile
				if(strsize<=0):csongfile_exist=0
				//if((strsize<=0)&(strmid(csongfile.cnt,0,5)!="http:")):csongfile_exist=0
				if((strmid(ccsongfile,0,5)="http:")|(strmid(ccsongfile,0,6)="https:")){
					mid.cnt=BASS_StreamCreateURL(ccsongfile,0,0x20000,0,0,0)
					mlength=BASS_ChannelGetLength_ms(mid.cnt)
					if((peffect=1)&(auto=1)){
						hPeakFX.cnt=BASS_ChannelSetFX(mid.cnt,0x10013,2)
						hPeakFX2.cnt=BASS_ChannelSetFX(mid.cnt,0x10013,3)
						hBitCFX.cnt=BASS_VST_ChannelSetDSP(mid.cnt,dir_default+"\\lib\\bitc.dll",0,8)
						BASS_VST_SetParam_R hBitCFX.cnt,0,0.0f
						hCompFX.cnt=-1
						hVolFX2.cnt=-1
					}else:if((peffect=1)/*&(cnt>=2)*/){
						hPeakFX.cnt=BASS_ChannelSetFX(mid.cnt,0x10013,2)
						hPeakFX2.cnt=BASS_ChannelSetFX(mid.cnt,0x10013,3)
						hBitCFX.cnt=BASS_VST_ChannelSetDSP(mid.cnt,dir_default+"\\lib\\bitc.dll",0,8)
						BASS_VST_SetParam_R hBitCFX.cnt,0,0.0f
						hCompFX.cnt=-1
						hVolFX2.cnt=-1
					}
					csongfile_exist=1
				}else{
					/*
					mid_pre.cnt=BASS_StreamCreateFile(0,ccsongfile,0,0,0,0,0x20000)
					BASS_ChannelSetAttribute mid_pre.cnt,2,0.0f
					BASS_ChannelPlay mid_pre.cnt*/
					mdataptr=0
					exist ccsongfile
					if(strsize>0){
						if(cnt=0){
							sdim mdata0,strsize
							bload ccsongfile,mdata0
							mdataptr=varptr(mdata0)
						}else:if(cnt=1){
							sdim mdata1,strsize
							bload ccsongfile,mdata1
							mdataptr=varptr(mdata1)
						}else:if(cnt=2){
							sdim mdata2,strsize
							bload ccsongfile,mdata2
							mdataptr=varptr(mdata2)
						}else{
							sdim mdata3,strsize
							bload ccsongfile,mdata3
							mdataptr=varptr(mdata3)
						}
						mid.cnt=BASS_StreamCreateFile(1,mdataptr,0,0,strsize,0,0x20000)
					}
					if(cnt=0){
						mlength=BASS_ChannelGetLength_ms(mid.cnt)
					}else{
						BASS_ChannelSetLink mid.0,mid.cnt
						if(BASS_ErrorGetCode()!=0){
							mlinkfailed=mlinkfailed|1
						}
					}
					if((peffect=1)&(auto=1)){
						hPeakFX.cnt=BASS_ChannelSetFX(mid.cnt,0x10013,2)
						hPeakFX2.cnt=BASS_ChannelSetFX(mid.cnt,0x10013,3)
						hCompFX.cnt=-1
						hBitCFX.cnt=BASS_VST_ChannelSetDSP(mid.cnt,dir_default+"\\lib\\bitc.dll",0,8)
						BASS_VST_SetParam_R hBitCFX.cnt,0,0.0f
						hVolFX2.cnt=-1
					}else:if((peffect=1)/*&(cnt>=2)*/){
						hPeakFX.cnt=BASS_ChannelSetFX(mid.cnt,0x10013,2)
						hPeakFX2.cnt=BASS_ChannelSetFX(mid.cnt,0x10013,3)
						hBitCFX.cnt=BASS_VST_ChannelSetDSP(mid.cnt,dir_default+"\\lib\\bitc.dll",0,8)
						BASS_VST_SetParam_R hBitCFX.cnt,0,0.0f
						hCompFX.cnt=-1
						hVolFX2.cnt=-1
					}
				}
			loop
			continue
		}
		if(headcmp(d.cnt,4,"ver=")){
			csongver=strmid(d.cnt,4,128)
			csongver_int=int(strmid(csongver,0,3))
			continue
		}
		if(headcmp(d.cnt,5,"mvol=")){
			csongvol=int(strmid(d.cnt,5,5))*dirvol/100
			continue
		}
		if(headcmp(d.cnt,13,"pfilterdelay=")){
			laserdelay1=int(strmid(d.cnt,13,16))
			if(laserdelay<0):laserdelay1=40
			if(laserdelay>160):laserdelay1=160
			continue
		}
		if(headcmp(d.cnt,2,"v=")){
			cmovfile=strmid(d.cnt,2,128)
			_sjis_ cmovfile
			continue
		}
		if(headcmp(d.cnt,2,"o=")){
			offset=int(strmid(d.cnt,2,64))+diroffset
			continue
		}
		if(headcmp(d.cnt,3,"vo=")){
			voffset=int(strmid(d.cnt,3,64))
			continue
		}
		if(headcmp(d.cnt,6,"total=")){
			csongtotal=int(strmid(d.cnt,6,64))
			continue
		}
		if(headcmp(d.cnt,2,"t=")){
			if((int(double(strmid(d.cnt,2,64))*1000)>0)&(strmid(d.cnt,2,64)=replace(strmid(d.cnt,2,64),"-",""))){
				bpm=int(double(strmid(d.cnt,2,64))*1000)
				if(cnt3<0){
					bpml.bpmlnum.0=int(cbcnt)
				}else{
					bpml.bpmlnum.0=(cnt2+1)*bpba*beatn/beatd/div.cnt3+int(cbcnt)
				}
				if(bpml.bpmlnum.0<0):bpml.bpmlnum.0=0
				bpml.bpmlnum.1=bpm
				bpmlnum++
			}
			continue
		}
		if(headcmp(d.cnt,3,"to=")){
			csongoftbpm=int(double(strmid(d.cnt,3,16))*1000)
			if(csongoftbpm<1):csongoftbpm=0
			if(csongoftbpm>65535000):csongoftbpm=0
			continue
		}
		if(headcmp(d.cnt,5,"beat=")){
			sdim beatstat,16,2
			stat1=strmid(d.cnt,5,33)
			split stat1,"/",beatstat
			if(length(beatstat)=2){
				if(cnt3<0){
					beatl.beatlnum.0=int(cbcnt)
				}else{
					beatl.beatlnum.0=(cnt2+1)*(bpba*beatn/beatd)/div.cnt3+int(cbcnt)
				}
				beatl.beatlnum.1=int(beatstat.0)
				beatl.beatlnum.2=int(beatstat.1)
				if((beatl.beatlnum.1>0)&(beatl.beatlnum.2>0)){
					beatlnum++
					beatn=int(beatstat.0)
					beatd=int(beatstat.1)
				}
			}
			continue
		}
		if(headcmp(d.cnt,5,"stop=")){
			if(adjmode!=1){
				if(cnt3<0){
					stp.stpnum.0=int(cbcnt)
				}else{
					stp.stpnum.0=(cnt2+1)*bpba*beatn/beatd/div.cnt3+int(cbcnt)
				}
				if((stp.stpnum.0>=0)&(int(strmid(d.cnt,5,16))>0)){
					stp.stpnum.1=int(strmid(d.cnt,5,16))*625/12
					//stpsh+=stp.stpnum.1
					if(stpnum<=0){
						stpnum++
					}else:if(stp.(stpnum-1).0+stp.(stpnum-1).1<=stp.stpnum.0){
						stpnum++
					}
				}
			}
			continue
		}

		// 現在のmeasure値(カウント値)
		if(cnt3<0){
			cmeasure=int(cbcnt)
		}else:if(div.cnt3=0){
			cmeasure=int(cbcnt)
		}else{
			cmeasure=(cnt2+1)*bpba*beatn/beatd/div.cnt3+int(cbcnt)
		}
		
		if(headcmp(d.cnt,5,"tilt=")){
			if(cnt3<0){
				tilt.tiltnum.0=cbcnt+stpsh
			}else{
				tilt.tiltnum.0=(cnt2+1)*bpba*beatn/beatd/div.cnt3+cbcnt
			}
			if(strmid(d.cnt,5,16)="normal"){
				tilt.tiltnum.1=0
			}else:if(strmid(d.cnt,5,16)="big"){
				tilt.tiltnum.1=1
			}else:if(strmid(d.cnt,5,16)="bigger"){
				tilt.tiltnum.1=1
			}else:if(strmid(d.cnt,5,16)="biggest"){
				tilt.tiltnum.1=2
			}else:if(strmid(d.cnt,5,16)="keep_normal"){
				tilt.tiltnum.1=3
			}else:if(strmid(d.cnt,5,16)="keep_bigger"){
				tilt.tiltnum.1=4
			}else:if(strmid(d.cnt,5,16)="keep_biggest"){
				tilt.tiltnum.1=5
			}else:if(strmid(d.cnt,5,16)="zero"){
				tilt.tiltnum.1=6
			}else:if(strmid(d.cnt,5,16)="keep"){
				tilt.tiltnum.1=4
			}else{
				// 傾きの数値指定(値の推移計算はGameSystemに移管済み)
				tilt.tiltnum.1=7
			}
			tiltp=tilt.tiltnum.1
			if((tilt.tiltnum.0!=0)|(tilt.tiltnum.1!=0)):tiltnum++
			continue
		}
		if(headcmp(d.cnt,13,"center_split=")){
			anaranfl=2
			continue
		}
		if(headcmp(d.cnt,13,"laserrange_l=")){
			anaran.anarannum.0=0^(pturna|(turn=1))
			if(cnt3<0){
				anaran.anarannum.1=int(cbcnt)
			}else{
				anaran.anarannum.1=(cnt2+1)*bpba*beatn/beatd/div.cnt3+int(cbcnt)
			}
			if(strmid(d.cnt,13,2)="2x"){
				anaran.anarannum.2=2
			}else:anaran.anarannum.2=1
			anarannum++
			anaranfl=2
			continue
		}
		if(headcmp(d.cnt,13,"laserrange_r=")){
			anaran.anarannum.0=1^(pturna|(turn=1))
			if(cnt3<0){
				anaran.anarannum.1=int(cbcnt)
			}else{
				anaran.anarannum.1=(cnt2+1)*bpba*beatn/beatd/div.cnt3+int(cbcnt)
			}
			if(strmid(d.cnt,13,2)="2x"){
				anaran.anarannum.2=2
			}else:anaran.anarannum.2=1
			anarannum++
			anaranfl=2
			continue
		}
		if(headcmp(d.cnt,12,"pfiltergain=")){
			if(cnt3<0){
				anagain.anagainnum.0=int(cbcnt)
			}else{
				anagain.anagainnum.0=(cnt2+1)*bpba*beatn/beatd/div.cnt3+int(cbcnt)
			}
			if(((int(strmid(d.cnt,12,3))=0)&(oldpfilter=0))|((int(strmid(d.cnt,12,3))>0)&(int(strmid(d.cnt,12,3))<=100))){
				anagain.anagainnum.1=int(strmid(d.cnt,12,3))
				anagainnum++
			}
			continue
		}
		if(headcmp(d.cnt,12,"chokkakuvol=")){
			if(cnt3<0){
				anvol.anvolnum.0=int(cbcnt)
			}else{
				anvol.anvolnum.0=(cnt2+1)*bpba*beatn/beatd/div.cnt3+int(cbcnt)
			}
			if((int(strmid(d.cnt,12,3))>=0)&(int(strmid(d.cnt,12,3))<=100)){
				anvol.anvolnum.1=int(strmid(d.cnt,12,3))
				anvolnum++
			}
			continue
		}
		if(headcmp(d.cnt,11,"chokkakuse=")){
			if(cnt3<0){
				anse.ansenum.0=int(cbcnt)
			}else{
				anse.ansenum.0=(cnt2+1)*bpba*beatn/beatd/div.cnt3+int(cbcnt)
			}
			f=1
			switch strmid(d.cnt,11,64)
			case "down"
				anse.ansenum.1=1
				swbreak
			case "up"
				anse.ansenum.1=2
				swbreak
			case "swing"
				anse.ansenum.1=3
				swbreak
			case "mute"
				anse.ansenum.1=4
				swbreak
			default
				f=0
			swend
			if(f=1):ansenum++
			continue
		}
		stat1=replace(d.cnt,"\t"," ")
		if(strmid(stat1,0,11)="#define_fx "){
			fxdefbuf_fx+=stat1+"\n"
			continue
		}
		if(strmid(stat1,0,15)="#define_filter "){
			fxdefbuf_filter+=stat1+"\n"
			continue
		}
		if((strmid(d.cnt,7,1)!="|")|(d.cnt!=replace(d.cnt,"=",""))){
			continue
		}
		if(cnt3<0):continue
		if(div.cnt3=0):continue
		cnt2++ // カレント小節数/div(小節内)
	loop
	if(csongver=""){
		csongvol=csongvol*6/10
	}
	cmov=(cmovfile="")

	// layer名をパース
	if(csonglayerstr!=""){
		sdim bgnamestat,0,1
		if(csongver_int>=166){
			split csonglayerstr,";",bgnamestat
		}else{
			split csonglayerstr,"/",bgnamestat
		}
		if(length(bgnamestat)=3){
			if(bgnamestat.2="2"):bgrotation=2
			if(bgnamestat.2="1"):bgrotation=1
			if(bgnamestat.2="0"):bgrotation=0
			bgname_l=bgnamestat.0
			bgspeed=int(bgnamestat.1)
		}else:if(length(bgnamestat)=2){
			bgname_l=bgnamestat.0
			bgspeed=int(bgnamestat.1)
		}else{
			bgname_l=csonglayerstr
			bgspeed=0
		}
	}
	
	// BPMの記述がない場合BPMを120にする
	if(bpmlnum=0){
		bpml.0.0=0
		bpml.0.1=120000
		bpmlnum=1
	}
	
	// BPMの上限を65535.000にする
	if(int(strmid(csongver,0,3))>=130){
		repeat bpmlnum
			bpml.cnt.1=min(bpml.cnt.1,65535000)
		loop
	}
	
	if(csongvol>100){
		dim hVolFX,length(mid)
		foreach mid
			hVolFX.cnt=BASS_ChannelSetFX(mid.cnt,0x10003,5)
			dim volfx,2
			volfx=0,tofloat(double(csongvol)/100.0f)
			BASS_FXSetParameters hVolFX.cnt,volfx
		loop
		dim hVolFX,swaudionum
		repeat swaudionum
			hVolFX_sw.cnt=BASS_ChannelSetFX(mid_sw.cnt,0x10003,5)
			dim volfx,2
			volfx=0,tofloat(double(csongvol)/100.0f)
			BASS_FXSetParameters hVolFX_sw.cnt,volfx
		loop
		csongvol=100
	}
	
	// 最大BPM値を調べる
	maxbpm=1
	maxbpm_ir=1
	repeat bpmlnum
		if(maxbpm<bpml.cnt.1):maxbpm=min(bpml.cnt.1,65535000)
		if(maxbpm_ir<bpml.cnt.1):maxbpm_ir=bpml.cnt.1
	loop
	
	// 最小BPM値を調べる(IR用)
	minbpm_ir=bpml.0.1
	repeat bpmlnum-1,1
		if(minbpm_ir>bpml.cnt.1):minbpm_ir=bpml.cnt.1
	loop
	
	// 平均BPM値を調べる
	if(beatlnum=0){
		beatl.0.0=0
		beatl.0.1=4
		beatl.0.2=4
		beatlnum=1
	}
	repeat bpmlnum
		bpml.cnt.2=c2t(bpml.cnt.0)
	loop
	ddim avestat,1
	avebpm=min(bpml.0.1,65535000)
	if(bpmlnum>1){
		stat1=c2t(b2c(divnum))
		repeat bpmlnum
			if(cnt<bpmlnum-1){
				avestat+=double(min(bpml.cnt.1,65535000))*(bpml.(cnt+1).2-bpml.cnt.2)
			}else{
				avestat+=double(min(bpml.cnt.1,65535000))*(stat1-bpml.cnt.2)
			}
		loop
		avestat/=max(stat1,1)
		avebpm=max(int(avestat),1)
	}
	
	// コマンドラインでの開始地点指定を計算
	if(cmdline_from!=0){
		cmdline_from=b2c(cmdline_from)
	}
	
	// 最頻BPM値を調べる
	dim oftbpmstat,65535
	oftbpm=1
	oftstat=0
	repeat bpmlnum
		if(cnt<bpmlnum-1){
			oftbpmstat.(min(max(bpml.cnt.1/1000,1),65535)-1)+=bpml.(cnt+1).0-bpml.cnt.0
		}else{
			oftbpmstat.(min(max(bpml.cnt.1/1000,1),65535)-1)+=b2c(divnum)-bpml.cnt.0
		}
		if((oftstat<oftbpmstat.(min(max(bpml.cnt.1/1000,1),65535)-1))|((oftstat=oftbpmstat.(min(max(bpml.cnt.1/1000,1),65535)-1))&(min(max(bpml.cnt.1/1000,1),65535)>oftbpm))){
			oftstat=oftbpmstat.(min(max(bpml.cnt.1/1000,1),65535)-1)
			oftbpm=min(max(bpml.cnt.1/1000,1),65535)
		}
	loop
	oftbpm*=1000
	if((csongoftbpm>0)&(csongoftbpm>=minbpm)&(csongoftbpm<=maxbpm)):oftbpm=csongoftbpm
	dim oftbpmstat,0
	
	// プレイ前の画面の表示
	imgbufload_bg "bg3.jpg",149,"image/jpeg",1
	BASS_ChannelSlideAttribute selbgmid,2,0.0,50
	timestart=d3timer()
	if((courseend!=1)&(cmdline_from=0)){
		BASS_ChannelSetAttribute selenterid,2,double(mastervol)/100
		BASS_ChannelSetPosition_ms selenterid,0
		BASS_ChannelPlay selenterid
	}
	alDeleteImage 35
	if(iscmdline=0){
		alCreateImageByFile 35,dir_default+"\\songs\\"+csongdir+"\\"+csongjacket
	}else{
		if(instr(csongjacket,0,".")=-1){
			alCreateImageByFile 35,dir_default+"\\imgs\\jacket\\"+csongjacket+".jpg"
		}else{
			alCreateImageByFile 35,getpath(cnotesfile,32)+"\\"+csongjacket
		}
	}
	buffer 129,getsize(320),getsize(320)
	alStretchImageToScreen 35,129,0,0,alGetWidth(),alGetHeight(),0,0,getsize(300),getsize(300)
	endfl2=0
	gosub *pl_minfoprepare
	enterkeyp=0
	enterfl=0
	lastkeyt=1200
	if((analoginput=2)&(analogmode=mode_on)&(ts3>30)){
		if(hidem=1):mouse -1,-1
		mouse defx,defy
	}
	dim sliderp,2
	if(analoginput=4){
		repeat 2
			cnt0=cnt
			sliderp.cnt=0
			repeat length_joylist
				joyGetPosEx joystat2,joylist.cnt
				sliderp.cnt0+=joystat2.(4+(cnt0^analogsw))
			loop
		loop
	}
	slider=0
	repeat
		if(courseend=1):break
		if(cmdline_from>0):break
		gosub *getjoystat
		timenow=d3timer()-timestart
		if(ts>120):ts=0
		if(ts2>60):ts2=0
		if(ts3>30):ts3=0
		ts+=max(timenow-timep,1)
		ts2+=max(timenow-timep,1)
		ts3+=max(timenow-timep,1)
		dim stickstat,2
		if(analoginput=2){
			repeat 2
				cnt0=cnt
				ddim dstat1,1
				if(cnt0=0):dstat1=(ginfo_mx-defx)*2*(mx*2-1)
				if(cnt0=1):dstat1=(ginfo_my-defy)*2*(my*2-1)
				stat1=int(round(dstat1*msen*2))
				if(abs(stat1)<10){
					stickstat.cnt=0
				}else{
					stickstat.cnt=sgn(stat1)*min(abs(int(double(sgn(stat1)*(abs(stat1)-10))))/120,22000*max(timenow-timep,2)/16/300)
				}
			loop
		}
		if(analoginput=4){
			repeat 2
				cnt0=cnt
				slider=0
				repeat length_joylist
					joyGetPosEx joystat2,joylist.cnt
					slider+=joystat2.(4+(cnt0^analogsw))
				loop
				stat1=slider-sliderp.cnt0
				sliderp.cnt0=slider
				if(abs(stat1)>32768):stat1-=sgn(stat1)*65536
				stat1=stat1*msen/400
				if(abs(stat1)<25){
					stickstat.cnt=0
				}else{
					stickstat.cnt=sgn(stat1)*min(abs(int(double(sgn(stat1)*(abs(stat1)-25))*max(timenow-timep,2)/150)),max(timenow-timep,2))
				}
			loop
		}
		if(analoginput=5){
			repeat 2
				cnt0=cnt
				slider=0
				repeat length_joylist
					joyGetPosEx joystat2,joylist.cnt
					slider+=joystat2.(2+(cnt0^analogsw))
				loop
				stat1=slider-sliderp.cnt0
				sliderp.cnt0=slider
				if(abs(stat1)>32768):stat1-=sgn(stat1)*65536
				stat1=stat1*msen/400
				if(abs(stat1)<25){
					stickstat.cnt=0
				}else{
					stickstat.cnt=sgn(stat1)*min(abs(int(double(sgn(stat1)*(abs(stat1)-25))*max(timenow-timep,2)/150)),max(timenow-timep,2))
				}
			loop
		}
		if(analoginput=3){
			repeat 2
				cnt0=cnt
				stat1=0
				repeat length_joylist
					joyGetPosEx joystat2,joylist.cnt
					stat1+=joystat2.(2+(cnt0^analogsw)*2)-32768
				loop
				if(abs(stat1)<12000){
					stickstat.cnt=0
				}else{
					stickstat.cnt=sgn(stat1)*min(abs(int(double(sgn(stat1)*(abs(stat1)-12000))*max(timenow-timep,2)/16/300)),18000*max(timenow-timep,2)/16/300)
				}
			loop
		}
		getkey enter_key,13
		enter_key=enter_key|getjoykeystat(11)
		if(ginfo2()=0){
			gosub *refreshhs
			getkey_a stat1,38
			getkey stat2,key.(7+2*analogsw)
			getkey stat3,key.(9-2*analogsw)
			stat1=stat1|((stat2|stat3)&(enter_key=1))
			getkey stat2,key2.(7+2*analogsw)
			getkey stat3,key2.(9-2*analogsw)
			stat1=stat1|((stat2|stat3|getjoykeystat(7+2*analogsw)|getjoykeystat(9-2*analogsw)|(stickstat.0>0)|(stickstat.1>0))&(enter_key=1))
			if((stat1=1)&(ts2>60)){
				if((hstypenow=0)&(hsr<99)){
					hsr++
				}else:if((hstypenow=1)&(hso<2000)){
					hso+=25
				}else:if((hstypenow=2)&(hsc<2000)){
					hsc+=25
				}else:if((hstypenow=3)&(hsm<2000)){
					hsm+=25
				}else:if((hstypenow=4)&(hsa<2000)){
					hsa+=25
				}
				enterfl=1
				if(timenow<lastkeyt+1700):lastkeyt=max(timenow,lastkeyt)
			}
			getkey_a stat1,40
			getkey stat2,key.(6+2*analogsw)
			getkey stat3,key.(8-2*analogsw)
			stat1=stat1|((stat2|stat3)&(enter_key=1))
			getkey stat2,key2.(6+2*analogsw)
			getkey stat3,key2.(8-2*analogsw)
			stat1=stat1|((stat2|stat3|getjoykeystat(6+2*analogsw)|getjoykeystat(8-2*analogsw)|(stickstat.0<0)|(stickstat.1<0))&(enter_key=1))
			if((stat1=1)&(ts2>60)){
				if((hstypenow=0)&(hsr>5)){
					hsr--
				}else:if((hstypenow=1)&(hso>25)){
					hso-=25
				}else:if((hstypenow=2)&(hsc>25)){
					hsc-=25
				}else:if((hstypenow=3)&(hsm>25)){
					hsm-=25
				}else:if((hstypenow=4)&(hsa>25)){
					hsa-=25
				}
				enterfl=1
				if(timenow<lastkeyt+1700):lastkeyt=max(timenow,lastkeyt)
			}
			getkey stat1,37
			getkey stat2,key.4
			stat1=stat1|(stat2&(enter_key=1))
			getkey stat2,key2.4
			stat1=stat1|((stat2|getjoykeystat(4))&(enter_key=1))
			if((stat1=1)&(ts>120)){
				gosub *refreshhs
				if(hstypenow=0){
					stat2=bpm*hsr/10
				}else:if(hstypenow=1){
					stat2=int(double(hso)*bpm*1000f/oftbpm)
				}else:if(hstypenow=2){
					stat2=hsc*1000
				}else:if(hstypenow=3){
					stat2=int(double(hsm)*bpm*1000f/maxbpm)
				}else:if(hstypenow=4){
					stat2=int(double(hsa)*bpm*1000f/avebpm)
				}
				hsr=10
				hsc=-1
				hsm=-1
				hsa=-1
				hso=-1
				repeat 5
					hstypenow--
					if(hstypenow<0):hstypenow=4
					if(vhstype.hstypenow=1):break
				loop
				if(hstypenow=0){
					hsr=max(min(int(round(double(stat2)/bpm*10)),99),5)
				}else:if(hstypenow=1){
					hso=ran(int(round(double(stat2)*oftbpm/bpm/25/1000))*25,25,2000)
				}else:if(hstypenow=2){
					hsc=ran(int(round(double(stat2)/25/1000))*25,25,2000)
				}else:if(hstypenow=3){
					hsm=ran(int(round(double(stat2)*maxbpm/bpm/25/1000))*25,25,2000)
				}else:if(hstypenow=4){
					hsa=ran(int(round(double(stat2)*avebpm/bpm/25/1000))*25,25,2000)
				}
				enterfl=1
				if(timenow<lastkeyt+1700):lastkeyt=max(timenow,lastkeyt)
			}
			getkey_a stat1,39
			getkey stat2,key.5
			stat1=stat1|(stat2&(enter_key=1))
			getkey stat2,key2.5
			stat1=stat1|((stat2|getjoykeystat(5))&(enter_key=1))
			if((stat1=1)&(ts>120)){
				gosub *refreshhs
				if(hstypenow=0){
					stat2=bpm*hsr/10
				}else:if(hstypenow=1){
					stat2=int(double(hso)*bpm*1000f/oftbpm)
				}else:if(hstypenow=2){
					stat2=hsc*1000
				}else:if(hstypenow=3){
					stat2=int(double(hsm)*bpm*1000f/maxbpm)
				}else:if(hstypenow=4){
					stat2=int(double(hsa)*bpm*1000f/avebpm)
				}
				hsr=10
				hsc=-1
				hsm=-1
				hsa=-1
				hso=-1
				repeat 5
					hstypenow++
					if(hstypenow>4):hstypenow=0
					if(vhstype.hstypenow=1):break
				loop
				if(hstypenow=0){
					hsr=max(min(int(round(double(stat2)/bpm*10)),99),5)
				}else:if(hstypenow=1){
					hso=ran(int(round(double(stat2)*oftbpm/bpm/25/1000))*25,25,2000)
				}else:if(hstypenow=2){
					hsc=ran(int(round(double(stat2)/25/1000))*25,25,2000)
				}else:if(hstypenow=3){
					hsm=ran(int(round(double(stat2)*maxbpm/bpm/25/1000))*25,25,2000)
				}else:if(hstypenow=4){
					hsa=ran(int(round(double(stat2)*avebpm/bpm/25/1000))*25,25,2000)
				}
				enterfl=1
				if(timenow<lastkeyt+1700):lastkeyt=max(timenow,lastkeyt)
			}
		}
		gosub *refreshhs
		if(hstypenow=0){
			hs=108*hsr/10/2
		}else:if(hstypenow=1){
			hs=108*hso*1000/oftbpm/2
		}else:if(hstypenow=2){
			hs=108/2
		}else:if(hstypenow=3){
			hs=108*hsm*1000/maxbpm/2
		}else{
			hs=108*hsa*1000/avebpm/2
		}
		if(hs<1):hs=1
		gsel 0
		redraw 0
		pos 0,0
		gcopy 149,0,0,scrsize_w,scrsize_h
		alResetCopyMode
		alCopyImageToScreen 53,0,scrsize_w/2-getsize(180),scrsize_h/2+getsize(100)
		pos scrsize_w/2-(300-int(double(60)*sin(double(min(timenow,3000))*M_PI/2/3000)))*scrsize_h/480/2,scrsize_h/2-(300-int(double(60)*sin(double(min(timenow,3000))*M_PI/2/3000)))*scrsize_h/480/2-getsize(60)
		gzoom (300-int(double(60)*sin(double(min(timenow,3000))*M_PI/2/3000)))*scrsize_h/480,(300-int(double(60)*sin(double(min(timenow,3000))*M_PI/2/3000)))*scrsize_h/480,129,0,0,getsize(300),getsize(300),1
		alCopyImageToScreen 97,0,scrsize_w-getsize(226),scrsize_h-getsize(27)
		if((hsc=-1)&(hsm=-1)&(hsa=-1)&(hso=-1)){
			if(strlen(str(hsr))=1){
				stat1="x0."+hsr
			}else{
				stat1=str(hsr)
				stat1="x"+strmid(stat1,0,1)+"."+strmid(stat1,1,1)
			}
		}else:if(hsc!=-1){
			stat1="C"
		}else:if(hsm!=-1){
			stat1="m"+hsm
		}else:if(hsa!=-1){
			stat1="a"+hsa
		}else{
			stat1=""+hso
		}
		stat3=0
		stat4=0
		repeat strlen(stat1)
			if(strmid(stat1,cnt,1)="."){
				stat3+=5*scrsize_h/480
			}
		loop
		repeat strlen(stat1)
			if(int(strmid(stat1,cnt,1))=0){
				if(strmid(stat1,cnt,1)="x"){
					stat2=11
				}else:if(strmid(stat1,cnt,1)="C"){
					stat2=12
				}else:if(strmid(stat1,cnt,1)="m"){
					stat2=13
				}else:if(strmid(stat1,cnt,1)="a"){
					stat2=14
				}else:if(strmid(stat1,cnt,1)="."){
					stat2=10
					stat4+=5*scrsize_h/480
				}else:if(strmid(stat1,cnt,1)=" "){
					continue
				}else{
					stat2=0
				}
			}else{
				stat2=int(strmid(stat1,cnt,1))
			}
			alCopyImageToScreen 52,0,scrsize_w-getsize(92)-getsize(10)*strlen(stat1)/2+stat3/2+getsize(10)*cnt-stat4,scrsize_h-getsize(17),getsize(10),getsize(9),0,getsize(9)*stat2
		loop
		if((hsc=-1)&(hsm=-1)&(hsa=-1)&(hso=-1)){
			stat1=int(double(bpml.0.1)*hsr/10000)
		}else:if(hsc!=-1){
			stat1=hsc
		}else:if(hsm!=-1){
			stat1=int(double(bpml.0.1/100)*hsm/maxbpm*100)
		}else:if(hsa!=-1){
			stat1=int(double(bpml.0.1/100)*hsa/avebpm*100)
		}else{
			stat1=int(double(bpml.0.1/100)*hso/oftbpm*100)
		}
		stat1=str(stat1)
		repeat strlen(stat1)
			if(int(strmid(stat1,cnt,1))=0){
				if(strmid(stat1,cnt,1)="x"){
					stat2=11
				}else:if(strmid(stat1,cnt,1)="C"){
					stat2=12
				}else:if(strmid(stat1,cnt,1)="m"){
					stat2=13
				}else:if(strmid(stat1,cnt,1)="a"){
					stat2=14
				}else:if(strmid(stat1,cnt,1)=" "){
					continue
				}else{
					stat2=0
				}
			}else{
				stat2=int(strmid(stat1,cnt,1))
			}
			alCopyImageToScreen 52,0,scrsize_w-getsize(35)-getsize(10)*strlen(stat1)/2+getsize(10)*cnt,scrsize_h-getsize(17),getsize(10),getsize(9),getsize(10),getsize(9)*stat2
		loop
		getkey f11_key,122
		esc_key=getesckey()
		enter_key=enter_key|f11_key
		enter_key=enter_key|getjoykeystat(11)|getjoykeystat(13)
		if((timenow>lastkeyt+1800)|((enterfl=0)&(timenow>1200)&(enter_key=0)&(enter_keyp=1)&(ginfo2()=0))|((esc_key=1)&(ginfo2()=0))){
			if((esc_key=1)&(ginfo2()=0)):endfl2=1:autodemo=0
			break
		}else{
			gmode 3,,,max(256-(d3timer()-timestart)*256/1200,0)
			color 255,255,255
			gsquare -1,sx_a,sy_a
			gmode 3,,,max((d3timer()-timestart-(lastkeyt+1500))*256/300,0)
			color 0,0,0
			gsquare -1,sx_a,sy_a
			gmode 0
			enter_keyp=enter_key
		}
		if((ts2>60)&(analoginput=2)){
			if(hidem=1):mouse -1,-1
			mouse defx,defy
		}
		redraw 1
		timep=timenow
		await 7
		if(analoginput=1){
			keshucnt=0:onkey 1
		}
	loop
	buffer 149,1,1
	courseendfl=0
	if(endfl2=1){
		if(((auto=1)|(adjmode=1))&(length(kmode)=3)){
			shortmode=kmode.0
			longmode=kmode.1
			analogmode=kmode.2
		}
		if((iscourse=0)|(coursenow=0)){
			BASS_ChannelSlideAttribute selenterid,2,0.0,250
			chdir dir_default+"\\songs"
			refreshsonglistoff=1
			state=st_select
		}else{
			BASS_ChannelSlideAttribute selenterid,2,0.0,250
			endfl2=0
			autodemo=0
			courseendfl=1
		}
	}
	gsel 0
	color 0,0,0
	boxf
	if(endfl2=1){
		pos 0,0
		gcopy 29,0,0,scrsize_w,scrsize_h
	}
	alCopyImageToScreen IMG_LOADING,0,scrsize_w-getsize(208),getsize(442)
	redraw 1:await 7:redraw 0
	if(endfl2=1):endfl2=0:return
	if((cmovfile!="")&(output=0)){
		if(vmov=1){
			mci "open \""+cmovfile+"\" type MPEGVideo alias v"
			mci "set v audio all off"
			mci "set v time format ms"
			gsel 0
			mci "window v handle "+hwnd
			mci "put v destination at "+(scrsize_w/2-getsize(302))+" "+getsize(140)+" "+getsize(160)+" "+getsize(120)
		}
	}
	if(feffect=0){
		userfxnum=0
		swaudionum=0
	}
	if(feffect=1){
		notesel fxdefbuf_fx
		repeat notemax
			notesel fxdefbuf_fx
			noteget stat1,cnt
			stat1=strmid(stat1,11,1024)
			stat1=strtrim(stat1,0,' ')
			if(stat1=""):continue
			sdim fxdefstat,,2
			fxdefstat.0=strmid(stat1,0,instr(stat1,0," "))
			fxdefstat.1=strmid(stat1,instr(stat1,0," ")+1,strlen(stat1)-instr(stat1,0," ")-1)
			if(length(fxdefstat)>=2){
				f2=1
				sdim fxdefstat2,1
				split fxdefstat.1,";",fxdefstat2
				foreach fxdefstat2
					fxdefstat2.cnt=strtrim(fxdefstat2.cnt,0,' ')
				loop
				// 一致するエフェクト名があるか調べる
				repeat FXDEF_FXTYPEMAX+1
					if(fxdef_name.0.cnt=""):continue
					if(fxdefstat2.0="type="+fxdef_name.0.cnt){
						userfx_name.userfxnum=fxdefstat.0
						userfx_params.userfxnum.0=double(cnt)
						// まずはデフォルト値を流し込む
						repeat fxdef_prmnum.cnt,1
							userfx_params.userfxnum.cnt=fxdef_default.cnt.(int(userfx_params.userfxnum.0))
							userfx_params_enable.userfxnum.cnt=fxdef_enable.cnt.(int(userfx_params.userfxnum.0))
						loop
						// 各パラメータ設定を反復処理
						repeat max(length(fxdefstat2)-1,0),1
							f=1
							sdim fxdefstat3,1
							split fxdefstat2.cnt,"=",fxdefstat3
							if(length(fxdefstat3)<=1){
								dialog "Warning: Unknown format (\""+fxdefstat2.cnt+"\")"
							}else{
								f=1
								// 一致するパラメータ名があるか調べる
								repeat fxdef_prmnum.(int(userfx_params.userfxnum.0)),1
									if(fxdefstat3.0=fxdef_name.cnt.(int(userfx_params.userfxnum.0))){
										if(fxdef_type.cnt.(int(userfx_params.userfxnum.0))=FXDEF_FILENAME){
											if(swaudionum>=31){
												dialog "Error: Too many \"Switch Audio\" Effects"
											}else{
												userfx_swaudiomid.userfxnum=swaudionum
												userfx_params.userfxnum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
											}
										}else{
											if(instr(fxdefstat3.1,0,">")=-1){
												userfx_params.userfxnum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
												userfx_params_enable.userfxnum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
											}else{
												userfx_params.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,0,">")),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
												userfx_params_enable.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,0,">")+1,256),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
											}
										}
										f=0
										break
									}
								loop
								if(f=1):dialog "Warning: Unknown paramater (\""+fxdefstat3.0+"\")"
							}
						loop
						userfxnum++
						f2=0
						break
					}
				loop
				if(f2=1):dialog "Error: Unknown effect type (\""+fxdefstat2.0+"\")"
			}
		loop
		notesel fxdefbuf_filter
		repeat notemax
			notesel fxdefbuf_filter
			noteget stat1,cnt
			stat1=strmid(stat1,15,1024)
			stat1=strtrim(stat1,0,' ')
			if(stat1=""):continue
			sdim fxdefstat,,2
			fxdefstat.0=strmid(stat1,0,instr(stat1,0," "))
			fxdefstat.1=strmid(stat1,instr(stat1,0," ")+1,strlen(stat1)-instr(stat1,0," ")-1)
			if(length(fxdefstat)>=2){
				f2=1
				sdim fxdefstat2,1
				split fxdefstat.1,";",fxdefstat2
				foreach fxdefstat2
					fxdefstat2.cnt=strtrim(fxdefstat2.cnt,0,' ')
				loop
				// 一致するエフェクト名があるか調べる
				repeat FXDEF_FXTYPEMAX+1
					if(fxdef_name.0.cnt=""):continue
					if(fxdefstat2.0="type="+fxdef_name.0.cnt){
						userfilter_name.userfilternum=fxdefstat.0
						userfilter_params.userfilternum.0=double(cnt)
						userfx_name.userfxnum=""
						userfx_params.userfxnum.0=double(cnt)
						// まずはデフォルト値を流し込む
						repeat fxdef_prmnum.cnt,1
							userfilter_params.userfilternum.cnt=fxdef_default.cnt.(int(userfilter_params.userfilternum.0))
							userfilter_params_min.userfilternum.cnt=fxdef_enable.cnt.(int(userfilter_params.userfilternum.0))
							userfilter_params_max.userfilternum.cnt=fxdef_enable.cnt.(int(userfilter_params.userfilternum.0))
							userfx_params.userfxnum.cnt=fxdef_default.cnt.(int(userfx_params.userfxnum.0))
							userfx_params_enable.userfxnum.cnt=fxdef_enable.cnt.(int(userfx_params.userfxnum.0))
						loop
						// 各パラメータ設定を反復処理
						repeat max(length(fxdefstat2)-1,0),1
							f=1
							sdim fxdefstat3,1
							split fxdefstat2.cnt,"=",fxdefstat3
							if(length(fxdefstat3)<=1){
								dialog "Warning: Unknown format (\""+fxdefstat2.cnt+"\")"
							}else{
								f=1
								// 一致するパラメータ名があるか調べる
								repeat fxdef_prmnum.(int(userfilter_params.userfilternum.0)),1
									if(fxdefstat3.0=fxdef_name.cnt.(int(userfilter_params.userfilternum.0))){
										if(fxdef_type.cnt.(int(userfx_params.userfxnum.0))=FXDEF_FILENAME){
											if(swaudionum>=31){
												dialog "Error: Too many \"Switch Audio\" Effects"
											}else{
												userfx_swaudiomid.userfxnum=swaudionum
												userfx_params.userfxnum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
											}
										}else{
											if(instr(fxdefstat3.1,0,">")=-1){
												if(instr(fxdefstat3.1,1,"-")=-1){
													userfilter_params.userfilternum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_min.userfilternum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_max.userfilternum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfx_params.userfxnum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
													userfx_params_enable.userfxnum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
												}else{
													userfilter_params.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,1,"-")+1),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_min.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,1,"-")+1),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_max.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,1,"-")+2,256),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfx_params.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,1,"-")+1),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
													userfx_params_enable.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,1,"-")+1),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
												}
											}else{
												if(instr(fxdefstat3.1,instr(fxdefstat3.1,0,">")+2,"-")=-1){
													userfilter_params.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,0,">")),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_min.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,0,">")+1,256),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_max.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,0,">")+1,256),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfx_params.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,0,">")),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
													userfx_params_enable.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,0,">")+1,256),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
												}else{
													userfilter_params.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,0,">")),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_min.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,0,">")+1,instr(fxdefstat3.1,instr(fxdefstat3.1,0,">")+2,"-")+1),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_max.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,instr(fxdefstat3.1,0,">")+2,"-")+instr(fxdefstat3.1,0,">")+2+1,256),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfx_params.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,0,">")),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
													userfx_params_enable.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,0,">")+1,instr(fxdefstat3.1,instr(fxdefstat3.1,0,">")+2,"-")+1),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
												}
											}
										}
										f=0
										break
									}
								loop
								if(f=1):dialog "Warning: Unknown paramater (\""+fxdefstat3.0+"\")"
							}
						loop
						userfilternum++
						userfxnum++
						f2=0
						break
					}
				loop
				if(f2=1):dialog "Error: Unknown effect type (\""+fxdefstat2.0+"\")"
			}
		loop
		dim userfx_fl,userfxnum
	}
	ddim rorp,1
	ddim ror_p,1
	cnt3=-1
	cnt2a=-1
	stat4=0
	stat4_2=0
	totalcombo=0
	mlinkfailed=0
	pturnlp=pturnl
	dim arfcnt,6
	dim np,6
	np=-1,-1,-1,-1,-1,-1
	ddim cbcnt,1
	beatn=4
	beatd=4
	t_finalnote=1
	fl_Retr=0
	fl_Gate=0
	fl_Flan=0
	fl_Pitc=0
	fl_BitC=0
	fl_Phas=0
	fl_TStp=0
	fl_Echo=0
	fl_SiCh=0
	dim fxfl,2
	sdim next_se,256,2
	next_se="",""
	next_se_vol=100,100
	_csongtitle=csongtitle
	if (lpeek(_csongtitle, 0) & 0x00FFFFFF) == 0xBFBBEF{
		DeleteUTF8BOM _csongtitle
	}
	repeat sp
		cnt2a++
		if(headcmp(d.cnt,2,"//")){
			continue
		}
		if(d.cnt="--"){
			cnt3++ // カレント小節数
			if(cnt3>0):cbcnt+=bpba*beatn/beatd
			cnt2=-1
			continue
		}
		if(headcmp(d.cnt,2,"t=")){
			bpm=int(double(strmid(d.cnt,2,16))*1000)
			continue
		}
		if(headcmp(d.cnt,5,"beat=")){
			sdim beatstat,16,2
			stat1=strmid(d.cnt,5,33)
			split stat1,"/",beatstat
			if(length(beatstat)=2){
				if((int(beatstat.0)>0)&(int(beatstat.1)>0)){
					beatn=int(beatstat.0)
					beatd=int(beatstat.1)
				}
			}
			continue
		}
		if(headcmp(d.cnt,9,"chiprate=")){
			if(strmid(d.cnt,9,2)="1x"){
				chiprate=1
			}else:if(strmid(d.cnt,9,2)="2x"){
				chiprate=2
			}else:if(strmid(d.cnt,9,2)="3x"){
				chiprate=3
			}
			continue
		}
		if(headcmp(d.cnt,9,"longrate=")){
			if(strmid(d.cnt,9,2)="1x"){
				longrate=1
			}else:if(strmid(d.cnt,9,2)="2x"){
				longrate=2
			}else:if(strmid(d.cnt,9,2)="3x"){
				longrate=3
			}
			continue
		}
		if(headcmp(d.cnt,10,"laserrate=")){
			if(strmid(d.cnt,10,2)="1x"){
				laserrate=1
			}else:if(strmid(d.cnt,10,2)="2x"){
				laserrate=2
			}else:if(strmid(d.cnt,10,2)="3x"){
				laserrate=2
			}
			continue
		}
		if(headcmp(d.cnt,11,"filtertype=")){
			if(cnt3<0){
				anafil.anafilnum.0=int(cbcnt)
			}else{
				anafil.anafilnum.0=(cnt2+1)*bpba*beatn/beatd/div.cnt3+int(cbcnt)
			}
			f=1
			_cnt=cnt
			repeat userfilternum,userfxnum-userfilternum
				if(strmid(d._cnt,11,256)=userfilter_name.(cnt-(userfxnum-userfilternum))){
					anafil.anafilnum.1=100+cnt
					userfx_fl.cnt=1
					f=0
					break
				}
			loop
			if(f=1){
				if(strmid(d.cnt,11,4)="hpf1"){
					anafil.anafilnum.1=1
				}else:if(strmid(d.cnt,11,4)="hpf2"){
					anafil.anafilnum.1=2
				}else:if(strmid(d.cnt,11,4)="lpf1"){
					anafil.anafilnum.1=3
				}else:if(strmid(d.cnt,11,4)="lpf2"){
					anafil.anafilnum.1=4
				}else:if(strmid(d.cnt,11,4)="bitc"){
					anafil.anafilnum.1=5
				}else:if((feffect=1)&(strmid(d.cnt,11,7)="fx;bitc")){
					anafil.anafilnum.1=5
				}else:if((strmid(d.cnt,11,3)="fx;")|(strmid(d.cnt,11,3)="fx")){
					anafil.anafilnum.1=-1
				}else:if(strmid(d.cnt,11,4)="peak"){
					anafil.anafilnum.1=0
				}else{
					dialog "Error: Undefined filter (\""+strmid(d.cnt,11,256)+"\")"
					anafil.anafilnum.1=0
				}
			}
			anafilnum++
			continue
		}
		continuefl=0
		_cnt=cnt
		repeat 2
			if(headcmp(d._cnt,5,"fx-"+str_lr.cnt+"=")){
				fx.fxnum.0=cnt
				if(cnt3<0){
					fx.fxnum.1=cbcnt
				}else{
					fx.fxnum.1=(cnt2+1)*bpba*beatn/beatd/div.cnt3+cbcnt
				}
				stat1=strmid(d._cnt,5,64)
				if(stat1=""){
					fx.fxnum.2=0
				}else{
					sdim fxsplitstat,1
					split stat1,";",fxsplitstat
					f=1
					repeat userfxnum
						if(fxsplitstat.0=userfx_name.cnt){
							fx.fxnum.2=100+cnt
							userfx_fl.cnt=1
							if(userfx_params.cnt.0=FXDEF_FXTYPE_RETR){
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=8
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
							}else:if(userfx_params.cnt.0=FXDEF_FXTYPE_GATE){
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=4
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
							}else:if(userfx_params.cnt.0=FXDEF_FXTYPE_BITC){
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=5
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),64),1)
							}else:if(userfx_params.cnt.0=FXDEF_FXTYPE_WOBB){
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=12
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
							}else:if(userfx_params.cnt.0=FXDEF_FXTYPE_TSTP){
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=50
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),100),1)
							}else:if(userfx_params.cnt.0=FXDEF_FXTYPE_ECHO){
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=4
									fx.fxnum.4=60
								}else:if(length(fxsplitstat)<=2){
									fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
									fx.fxnum.4=60
								}else{
									fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
									fx.fxnum.4=max(min(int(fxsplitstat.2),100),0)
								}
							}else:if(userfx_params.cnt.0=FXDEF_FXTYPE_PITC){
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=12
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),48),-48)
							}
							f=0
							break
						}
					loop
					if(f=1){
						switch fxsplitstat.0
						case "Retrigger":
							if(length(fxsplitstat)<=1){
								fx.fxnum.3=8
							}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
							if(fx.fxnum.3=12){
								fx.fxnum.2=FX_RE12
							}else:if(fx.fxnum.3=16){
								fx.fxnum.2=FX_RE16
							}else:if(fx.fxnum.3=24){
								fx.fxnum.2=FX_RE24
							}else:if(fx.fxnum.3=32){
								fx.fxnum.2=FX_RE32
							}else{
								fx.fxnum.2=FX_RE8
							}
							fl_Retr=1
							swbreak
						case "Gate":
							if(length(fxsplitstat)<=1){
								fx.fxnum.3=4
							}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
							if(fx.fxnum.3=8){
								fx.fxnum.2=FX_GA8
							}else:if(fx.fxnum.3=12){
								fx.fxnum.2=FX_GA12
							}else:if(fx.fxnum.3=16){
								fx.fxnum.2=FX_GA16
							}else:if(fx.fxnum.3=24){
								fx.fxnum.2=FX_GA24
							}else:if(fx.fxnum.3=32){
								fx.fxnum.2=FX_GA32
							}else{
								fx.fxnum.2=FX_GA4
							}
							fl_Gate=1
							swbreak
						case "Flanger":
							fx.fxnum.2=FX_FLAN
							fl_Flan=1
							swbreak
						case "PitchShift":
							if(length(fxsplitstat)<=1){
								fx.fxnum.3=12
							}else:fx.fxnum.3=max(min(int(fxsplitstat.1),48),-48)
							fx.fxnum.2=FX_PITC
							fl_Pitc=1
							swbreak
						case "Phaser":
							fx.fxnum.2=FX_PHAS
							fl_Phas=1
							swbreak
						case "BitCrusher":
							if(length(fxsplitstat)<=1){
								fx.fxnum.3=5
							}else:fx.fxnum.3=max(min(int(fxsplitstat.1),64),0)
							fx.fxnum.2=FX_BITC
							fl_BitC=1
							swbreak
						case "Wobble":
							if(length(fxsplitstat)<=1){
								fx.fxnum.3=12
							}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
							fx.fxnum.2=FX_WO12
							fl_Gate=1
							swbreak
						case "TapeStop":
							if(length(fxsplitstat)<=1){
								fx.fxnum.3=50
							}else:fx.fxnum.3=max(min(int(fxsplitstat.1),100),0)
							fx.fxnum.2=FX_TSTP
							fl_TStp=1
							swbreak
						case "Echo":
							if(length(fxsplitstat)<=1){
								fx.fxnum.3=4
								fx.fxnum.4=60
							}else:if(length(fxsplitstat)<=2){
								fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
								fx.fxnum.4=60
							}else{
								fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
								fx.fxnum.4=max(min(int(fxsplitstat.2),100),0)
							}
							fx.fxnum.2=FX_EC4
							fl_Echo=1
							swbreak
						case "SideChain":
							fx.fxnum.2=FX_SICH
							fl_SiCh=1
							swbreak
						case "":
							fx.fxnum.2=0
							swbreak
						default:
							fx.fxnum.2=0
							dialog "Error: Undefined fx (\""+fxsplitstat.0+"\")"
						swend
					}
				}
				fxfl.cnt=1
				fxnum++
				continuefl=1
			}
		loop
		if(continuefl=1):continue
		if(headcmp(d.cnt,12,"fx-l_param1=")){
			fxparams.fxparamsnum.0=0
			if(cnt3<0){
				fxparams.fxparamsnum.1=cbcnt
			}else{
				fxparams.fxparamsnum.1=(cnt2+1)*bpba*beatn/beatd/div.cnt3+cbcnt
			}
			fxparams.fxparamsnum.2=int(strmid(d.cnt,12,8))
			fxparamsnum++
			continue
		}
		if(headcmp(d.cnt,12,"fx-r_param1=")){
			fxparams.fxparamsnum.0=1
			if(cnt3<0){
				fxparams.fxparamsnum.1=cbcnt
			}else{
				fxparams.fxparamsnum.1=(cnt2+1)*bpba*beatn/beatd/div.cnt3+cbcnt
			}
			fxparams.fxparamsnum.2=int(strmid(d.cnt,12,8))
			fxparamsnum++
			continue
		}
		if(headcmp(d.cnt,8,"fx-l_se=")|headcmp(d.cnt,8,"fx-r_se=")){
			_stat1=strmid(d.cnt,8,256)
			sdim splitstat,1
			split _stat1,";",splitstat
			if(length(splitstat)=1){
				_stat3=100
			}else{
				_stat3=min(max(int(splitstat.1),0),100)
			}
			_stat1=splitstat.0
			if(getpath(_stat1,2)=""){
				_stat1=dir_default+"\\se\\note\\"+_stat1+".wav"
			}
			exist _stat1
			if(strsize<=0){
				dialog "Error: Cannot open sound \""+_stat1+"\""
			}
			if(HashCheckKey(se_ids,_stat1)=0){
				// まだ読み込んだことのない効果音の場合
				se_ids(_stat1)=BASS_SampleLoad(0,_stat1,0,0,0,10,0)
			}
			if(headcmp(d.cnt,8,"fx-l_se=")){
				next_se.0=_stat1
				next_se_vol.0=_stat3
			}
			if(headcmp(d.cnt,8,"fx-r_se=")){
				next_se.1=_stat1
				next_se_vol.1=_stat3
			}
			continue
		}
		if((headcmp(d.cnt,3,"fx:")&(instr(d.cnt,3,"="))!=-1)){
			if(cnt3<0){
				userchprm.userchprmnum.0=c2tf(cbcnt)
			}else{
				userchprm.userchprmnum.0=c2tf((cnt2+1)*bpba*beatn/beatd/div.cnt3+cbcnt)
			}
			sdim fxsplit_stat,1
			_stat1=strmid(d.cnt,3,instr(d.cnt,3,"="))
			_stat4=strmid(d.cnt,4+instr(d.cnt,3,"="),256)
			if(instr(_stat1,0,":")!=-1){
				_stat2=strmid(_stat1,0,instr(_stat1,0,":"))
				_stat3=0
				f=1
				repeat userfxnum-userfilternum
					// 一致するユーザー定義FXを探索
					if(_stat2=userfx_name.cnt){
						userchprm.userchprmnum.1=double(cnt)
						_stat3=int(userfx_params.cnt.0)
						f=0
						break
					}
				loop
				if(f=1){
					dialog "Error: Undefined fx (\""+_stat2+"\")"
				}else:if(_stat3=FXDEF_FXTYPE_AUDI){
					dialog "Error: Cannot change \"SwitchAudio\" value"
				}else{
					f=1
					_stat1=strmid(_stat1,instr(_stat1,0,":")+1,256)
					// 一致するパラメータ名があるか調べる
					repeat fxdef_prmnum._stat3,1
						if(_stat1=fxdef_name.cnt._stat3){
							userchprm.userchprmnum.2=double(cnt)
							if(instr(_stat4,0,">")=-1){
								userchprm.userchprmnum.3=fxdef_str2param(_stat4,fxdef_type.cnt._stat3)
								userchprm.userchprmnum.4=fxdef_str2param(_stat4,fxdef_type.cnt._stat3)
							}else{
								userchprm.userchprmnum.3=fxdef_str2param(strmid(_stat4,0,instr(_stat4,0,">")),fxdef_type.cnt._stat3)
								userchprm.userchprmnum.4=fxdef_str2param(strmid(_stat4,instr(_stat4,0,">")+1,256),fxdef_type.cnt._stat3)
							}
							userfx_fl.(int(userchprm.userchprmnum.1))=1
							userchprmnum++
							f=0
							break
						}
					loop
					if(f=1):dialog "Error: Unknown paramater (\""+_stat1+"\")"
				}
			}
			continue
		}
		if((headcmp(d.cnt,7,"filter:")&(instr(d.cnt,7,"="))!=-1)){
			if(cnt3<0){
				userchprm.userchprmnum.0=c2tf(cbcnt)
			}else{
				userchprm.userchprmnum.0=c2tf((cnt2+1)*bpba*beatn/beatd/div.cnt3+cbcnt)
			}
			_stat1=strmid(d.cnt,7,instr(d.cnt,7,"="))
			_stat4=strmid(d.cnt,8+instr(d.cnt,7,"="),256)
			if(instr(_stat1,0,":")!=-1){
				_stat2=strmid(_stat1,0,instr(_stat1,0,":"))
				_stat3=0
				f=1
				repeat userfilternum
					// 一致するユーザー定義FXを探索
					if(_stat2=userfilter_name.cnt){
						userchprm.userchprmnum.1=double(cnt+userfxnum-userfilternum)
						_stat3=int(userfx_params.(cnt+userfxnum-userfilternum).0)
						f=0
						break
					}
				loop
				if(f=1){
					dialog "Error: Undefined filter (\""+_stat2+"\")"
				}else:if(_stat3=FXDEF_FXTYPE_AUDI){
					dialog "Error: \"SwitchAudio\" value cannot be changed"
				}else{
					f=1
					_stat1=strmid(_stat1,instr(_stat1,0,":")+1,256)
					// 一致するパラメータ名があるか調べる
					repeat fxdef_prmnum._stat3,1
						if(_stat1=fxdef_name.cnt._stat3){
							userchprm.userchprmnum.2=double(cnt)
							if(instr(_stat4,0,">")=-1){
								if(instr(_stat4,1,"-")=-1){
									userchprm.userchprmnum.3=fxdef_str2param(_stat4,fxdef_type.cnt._stat3)
									userchprm.userchprmnum.4=fxdef_str2param(_stat4,fxdef_type.cnt._stat3)
									userchprm.userchprmnum.5=fxdef_str2param(_stat4,fxdef_type.cnt._stat3)
								}else{
									userchprm.userchprmnum.3=fxdef_str2param(strmid(_stat4,0,instr(_stat4,1,"-")+1),fxdef_type.cnt.(_stat3))
									userchprm.userchprmnum.4=fxdef_str2param(strmid(_stat4,0,instr(_stat4,1,"-")+1),fxdef_type.cnt.(_stat3))
									userchprm.userchprmnum.5=fxdef_str2param(strmid(_stat4,instr(_stat4,1,"-")+2,256),fxdef_type.cnt.(_stat3))
								}
							}else{
								if(instr(_stat4,instr(_stat4,0,">")+2,"-")=-1){
									userchprm.userchprmnum.3=fxdef_str2param(strmid(_stat4,0,instr(_stat4,0,">")),fxdef_type.cnt.(_stat3))
									userchprm.userchprmnum.4=fxdef_str2param(strmid(_stat4,instr(_stat4,0,">")+1,256),fxdef_type.cnt.(_stat3))
									userchprm.userchprmnum.5=fxdef_str2param(strmid(_stat4,instr(_stat4,0,">")+1,256),fxdef_type.cnt.(_stat3))
								}else{
									userchprm.userchprmnum.3=fxdef_str2param(strmid(_stat4,0,instr(_stat4,0,">")),fxdef_type.cnt.(_stat3))
									userchprm.userchprmnum.4=fxdef_str2param(strmid(_stat4,instr(_stat4,0,">")+1,instr(_stat4,instr(_stat4,0,">")+2,"-")+1),fxdef_type.cnt.(_stat3))
									userchprm.userchprmnum.5=fxdef_str2param(strmid(_stat4,instr(_stat4,instr(_stat4,0,">")+2,"-")+instr(_stat4,0,">")+2+1,256),fxdef_type.cnt.(_stat3))
								}
							}
							userfx_fl.(int(userchprm.userchprmnum.1))=1
							userchprmnum++
							f=0
							break
						}
					loop
					if(f=1):dialog "Error: Unknown paramater (\""+_stat1+"\")"
				}
			}
			continue
		}
		if((strmid(d.cnt,7,1)!="|")|(d.cnt!=replace(d.cnt,"=",""))){
			continue
		}
		if(cnt3<0){
			dialog lang.2.1/*"譜面データの始端には小節線(--)を入力する必要があります。"*/,1,lang.0.2
			endfl=1
			break
		}
		if(/*(d.cnt="--")|*/(div.cnt3=0)){
			continue
		}
		cnt2++ // カレント小節数/div(小節内)
		exc=0
		if(cnt2a>0){
			repeat
				if((cnt2a-cnt-1)<0){
					exc=-1
					break
				}
				if(strmid(d.(cnt2a-cnt-1),4,1)!="|"){
					exc++
					continue
				}
				break
			loop
		}
		// ショートオブジェクトのリストアップ
		repeat 4
			if(shortmode=3):break
			if(adjmode=1):break
			// short
			if(strmid(d.cnt2a,cnt,1)="1"){
				if(turn=1){
					note.notenum.0=3-cnt
				}else:if(turn=2){
					note.notenum.0=pturn.cnt
				}else{
					note.notenum.0=cnt
				}
				note.notenum.1=int(cbcnt)+cnt2*bpba*beatn/beatd/div.cnt3
				if(note.notenum.1>=cmdline_from){
					note.notenum.2=0
					note.notenum.3=c2t(note.notenum.1)
					note.notenum.4=note.notenum.3
					note.notenum.5=-1
					note.notenum.7=chiprate
					if(np.cnt!=-1){
						note.(np.cnt).5=notenum
					}
					np.cnt=notenum
					note.notenum.6=0
					if(t_finalnote<note.notenum.4):t_finalnote=note.notenum.4
					if((coloring=1)&(div.cnt3!=0)){
						f=0
						if(cnt2=0){
							note.notenum.6=1
							f=1
						}
						if((f=0)&(div.cnt3>=2)){
							if((div.cnt3\2=0)&(cnt2\(div.cnt3/2)=0)){
								note.notenum.6=1
								f=1
							}
						}
						if((f=0)&(div.cnt3>=4)){
							if((div.cnt3\4=0)&(cnt2\(div.cnt3/4)=0)){
								note.notenum.6=1
								f=1
							}
						}
						if((f=0)&(div.cnt3>=8)){
							if((div.cnt3\8=0)&(cnt2\(div.cnt3/8)=0)){
								note.notenum.6=2
								f=1
							}
						}
						if((f=0)&(div.cnt3>=12)){
							if((div.cnt3\12=0)&(cnt2\(div.cnt3/12)=0)){
								note.notenum.6=3
								f=1
							}
						}
						if((f=0)&(div.cnt3>=16)){
							if((div.cnt3\16=0)&(cnt2\(div.cnt3/16)=0)){
								note.notenum.6=4
								f=1
							}
						}
						if((f=0)&(div.cnt3>=24)){
							if((div.cnt3\24=0)&(cnt2\(div.cnt3/24)=0)){
								note.notenum.6=5
								f=1
							}
						}
						if((f=0)&(div.cnt3>=32)){
							if((div.cnt3\32=0)&(cnt2\(div.cnt3/32)=0)){
								note.notenum.6=6
								f=1
							}
						}
						if((f=0)&(div.cnt3>=48)){
							if((div.cnt3\48=0)&(cnt2\(div.cnt3/48)=0)){
								note.notenum.6=7
								f=1
							}
						}
						if((f=0)&(div.cnt3>=64)){
							if((div.cnt3\64=0)&(cnt2\(div.cnt3/64)=0)){
								note.notenum.6=8
								f=1
							}
						}
					}
					notese.notenum=-1 // チップBTオブジェクトは効果音を鳴らさない
					notenum++
					if(shortmode!=mode_off){
						totalcombo++
						stat4+=6*chiprate
						stat4_2+=200*chiprate
					}
				}
				continue
			}
			// long
			lcnt=cnt
			if(bpm<256000){
				f1=(note.notenum.2<=bpba*3/16)
				f2=bpba_16
			}else{
				f1=(note.notenum.2<=bpba*3/8)
				f2=bpba_8
			}
			if(strmid(d.cnt2a,cnt,1)="2")&((strmid(d.(cnt2a-exc-1),cnt,1)!="2")|(exc=-1)){
				excd=0
				beatn2=beatn
				beatd2=beatd
				ddim lend,1
				lend=double(bpba)*beatn2/beatd2/div.cnt3
				repeat
					if(cnt2a+cnt+1>=length(d)){
						break
					}
					if(d.(cnt2a+cnt+1)=""){
						break
					}
					if(strmid(d.(cnt2a+cnt+1),0,2)="--"){
						excd++
						continue
					}
					if(headcmp(d.(cnt2a+cnt+1),5,"beat=")){
						sdim beatstat,16,2
						stat1=strmid(d.(cnt2a+cnt+1),5,33)
						split stat1,"/",beatstat
						if(length(beatstat)=2){
							if((int(beatstat.0)>0)&(int(beatstat.1)>0)){
								beatn2=int(beatstat.0)
								beatd2=int(beatstat.1)
							}
						}
						continue
					}
					if(strmid(d.(cnt2a+cnt+1),4,1)!="|"){
						continue
					}
					if(strmid(d.(cnt2a+cnt+1),lcnt,1)="2"){
						if(div.(cnt3+excd)=0):break
						lend+=double(bpba)*beatn2/beatd2/div.(cnt3+excd)
					}else{
						break
					}
				loop
				if(turn=1){
					note.notenum.0=3-cnt
				}else:if(turn=2){
					note.notenum.0=pturn.cnt
				}else{
					note.notenum.0=cnt
				}
				note.notenum.1=int(cbcnt)+cnt2*bpba*beatn/beatd/div.cnt3
				if(note.notenum.1>=cmdline_from){
					note.notenum.2=int(lend)
					note.notenum.3=c2t(note.notenum.1)
					note.notenum.4=c2t(note.notenum.1+note.notenum.2)
					if(t_finalnote<note.notenum.4):t_finalnote=note.notenum.4
					if(shortmode!=1){
						if(bpm<256000){
							stat1=(note.notenum.2<=bpba*3/16)
							stat2=bpba_16
						}else{
							stat1=(note.notenum.2<=bpba*3/8)
							stat2=bpba_8
						}
						if(stat1=1){
							if(turn=1){
								shlj.shljnum.0=3-cnt
							}else:if(turn=2){
								shlj.shljnum.0=pturn.cnt
							}else{
								shlj.shljnum.0=cnt
							}
							shlj.shljnum.1=note.notenum.1
							shlj.shljnum.2=note.notenum.2
							if(bpm<256000){
								if(note.notenum.2>=bpba_16*2){
									shlj.shljnum.1+=bpba_16
									shlj.shljnum.2=bpba_16
								}
							}else{
								if(note.notenum.2>=bpba_8*2){
									shlj.shljnum.1+=bpba_8
									shlj.shljnum.2=bpba_8
								}
							}
							shlj.shljnum.4=c2t(shlj.shljnum.1)
							shlj.shljnum.5=c2t(shlj.shljnum.1+shlj.shljnum.2)
							shlj.shljnum.6=notenum
							shlj.shljnum.7=longrate
							if(shortmode!=mode_off){
								stat4+=longrate
								stat4_2+=50*longrate
							}
							shljnum++
							totalcombo++
						}else{
							for i,(note.notenum.1+stat2-1)/stat2*stat2+stat2,note.notenum.1+note.notenum.2-stat2,stat2
								if(turn=1){
									shlj.shljnum.0=3-cnt
								}else:if(turn=2){
									shlj.shljnum.0=pturn.cnt
								}else{
									shlj.shljnum.0=cnt
								}
								shlj.shljnum.1=i
								shlj.shljnum.2=0
								if(i>note.notenum.1+note.notenum.2-stat2*2){
									shlj.shljnum.2+=stat2*2
								}else{
									shlj.shljnum.2+=stat2
								}
								shlj.shljnum.4=c2t(shlj.shljnum.1)
								shlj.shljnum.5=c2t(shlj.shljnum.1+shlj.shljnum.2)
								shlj.shljnum.6=notenum
								shlj.shljnum.7=longrate
								if(shortmode!=mode_off){
									stat4+=longrate
									stat4_2+=50*longrate
								}
								shljnum++
								totalcombo++
							next
						}
					}
					note.notenum.5=-1
					if(np.cnt!=-1){
						note.(np.cnt).5=notenum
					}
					np.cnt=notenum
					notese.notenum=-1 // ロングBTオブジェクトは効果音を鳴らさない
					notenum++
				}
			}
		loop
		// ロングオブジェクトのリストアップ
		repeat 2
			if(longmode=3):break
			lcnt=cnt
			if(strmid(d.cnt2a,cnt+5,1)="2"){
				if(turn=1){
					note.notenum.0=5-cnt
				}else:if((turn=2)|(turn=3)|(turn=4)){
					note.notenum.0=4+(cnt^pturnl)
				}else{
					note.notenum.0=cnt+4
				}
				note.notenum.1=int(cbcnt)+cnt2*bpba*beatn/beatd/div.cnt3
				if(note.notenum.1>=cmdline_from){
					note.notenum.2=0
					note.notenum.3=c2t(note.notenum.1)
					note.notenum.4=note.notenum.3
					note.notenum.5=-1
					note.notenum.7=chiprate
					if(t_finalnote<note.notenum.4):t_finalnote=note.notenum.4
					if(np.(cnt+4)!=-1){
						note.(np.(cnt+4)).5=notenum
					}
					np.(cnt+4)=notenum
					notese.notenum=-1
					// チップFXオブジェクトは効果音があれば鳴らす
					if(next_se.lcnt!=""){
						notese.notenum=notesejnum
						notesej.notesejnum.0=notenum // ノートSEの元オブジェクト番号
						notesej.notesejnum.1=0 // ノートSEの判定(0/1)
						notesej.notesejnum.2=se_ids(next_se.lcnt) // 再生するSampleのID
						notesej.notesejnum.3=next_se_vol.lcnt // 再生音量(%)
						notesejnum++
					}
					notenum++
					if(longmode!=mode_off){
						stat4+=6*chiprate
						stat4_2+=200*chiprate
						totalcombo++
					}
				}
				continue
			}
			if(strmid(d.cnt2a,cnt+5,1)!="0")&((strmid(d.(cnt2a-exc-1),cnt+5,1)="0")|(strmid(d.(cnt2a-exc-1),cnt+5,1)="2")|(exc=-1)){
				excd=0
				beatn2=beatn
				beatd2=beatd
				ddim lend,1
				lend=double(bpba)*beatn2/beatd2/div.cnt3
				repeat
					if(cnt2a+cnt+1>=length(d)){
						break
					}
					if(d.(cnt2a+cnt+1)=""){
						break
					}
					if(strmid(d.(cnt2a+cnt+1),0,2)="--"){
						excd++
						continue
					}
					if(headcmp(d.(cnt2a+cnt+1),5,"beat=")){
						sdim beatstat,16,2
						stat1=strmid(d.(cnt2a+cnt+1),5,33)
						split stat1,"/",beatstat
						if(length(beatstat)=2){
							if((int(beatstat.0)>0)&(int(beatstat.1)>0)){
								beatn2=int(beatstat.0)
								beatd2=int(beatstat.1)
							}
						}
						continue
					}
					if(strmid(d.(cnt2a+cnt+1),4,1)!="|"){
						continue
					}
					if((strmid(d.(cnt2a+cnt+1),lcnt+5,1)!="0")&(strmid(d.(cnt2a+cnt+1),lcnt+5,1)!="2")){
						if(div.(cnt3+excd)=0):break
						lend+=double(bpba)*beatn2/beatd2/div.(cnt3+excd)
					}else{
						break
					}
				loop
				if(turn=1){
					note.notenum.0=5-cnt
				}else:if((turn=2)|(turn=3)|(turn=4)){
					note.notenum.0=4+(cnt^pturnl)
				}else{
					note.notenum.0=cnt+4
				}
				note.notenum.1=int(cbcnt)+cnt2*bpba*beatn/beatd/div.cnt3
				if(note.notenum.1>=cmdline_from){
					note.notenum.2=int(lend)
					note.notenum.3=c2t(note.notenum.1)
					note.notenum.4=c2t(note.notenum.1+note.notenum.2)
					if(t_finalnote<note.notenum.4):t_finalnote=note.notenum.4
					if(longmode!=1){
						if(bpm<256000){
							stat1=(note.notenum.2<=bpba*3/16)
							stat2=bpba_16
						}else{
							stat1=(note.notenum.2<=bpba*3/8)
							stat2=bpba_8
						}
						if(stat1=1){
							if(turn=1){
								longj.longjnum.0=1-cnt
							}else:if((turn=2)|(turn=3)|(turn=4)){
								longj.longjnum.0=(cnt^pturnl)
							}else{
								longj.longjnum.0=cnt
							}
							longj.longjnum.1=note.notenum.1
							longj.longjnum.2=note.notenum.2
							if(bpm<256000){
								if(note.notenum.2>=bpba*2/16){
									longj.longjnum.1+=bpba_16
									longj.longjnum.2=bpba_16
								}
							}else{
								if(note.notenum.2>=bpba*2/8){
									longj.longjnum.1+=bpba_8
									longj.longjnum.2=bpba_8
								}
							}
							longj.longjnum.4=c2t(longj.longjnum.1)
							longj.longjnum.5=c2t(longj.longjnum.1+longj.longjnum.2)
							longj.longjnum.6=notenum
							longj.longjnum.7=longrate
							if(longmode!=mode_off){
								stat4+=longrate
								stat4_2+=50*longrate
							}
							longjnum++
							totalcombo++
						}else{
							for i,(note.notenum.1+stat2-1)/stat2*stat2+stat2,note.notenum.1+note.notenum.2-stat2,stat2
								if(turn=1){
									longj.longjnum.0=1-cnt
								}else:if((turn=2)|(turn=3)|(turn=4)){
									longj.longjnum.0=(cnt^pturnl)
								}else{
									longj.longjnum.0=cnt
								}
								longj.longjnum.1=i
								longj.longjnum.2=0
								if(i>note.notenum.1+note.notenum.2-stat2*2){
									longj.longjnum.2+=stat2*2
								}else{
									longj.longjnum.2+=stat2
								}
								longj.longjnum.4=c2t(longj.longjnum.1)
								longj.longjnum.5=c2t(longj.longjnum.1+longj.longjnum.2)
								longj.longjnum.6=notenum
								longj.longjnum.7=longrate
								if(longmode!=mode_off){
									stat4+=longrate
									stat4_2+=50*longrate
								}
								longjnum++
								totalcombo++
							next
						}
					}
					note.notenum.5=-1
					if(np.(cnt+4)!=-1){
						note.(np.(cnt+4)).5=notenum
					}
					np.(cnt+4)=notenum
					notese.notenum=-1 // ロングFXオブジェクトは効果音を鳴らさない
					notenum++
				}
			}
			if((strmid(d.cnt2a,cnt+5,1)!="0")&((strmid(d.(cnt2a-exc-1),cnt+5,1)!=strmid(d.cnt2a,cnt+5,1))|(exc=-1)|((csongver_int>=160)&(fxfl.cnt=1)))){
				excd=0
				beatn2=beatn
				beatd2=beatd
				ddim lend,1
				lend=double(bpba)*beatn2/beatd2/div.cnt3
				stat2=strmid(d.cnt2a,cnt+5,1)
				repeat
					if(cnt2a+cnt+1>=length(d)){
						break
					}
					if(d.(cnt2a+cnt+1)=""){
						break
					}
					if(strmid(d.(cnt2a+cnt+1),0,2)="--"){
						excd++
						continue
					}
					if(headcmp(d.(cnt2a+cnt+1),5,"beat=")){
						sdim beatstat,16,2
						stat1=strmid(d.(cnt2a+cnt+1),5,33)
						split stat1,"/",beatstat
						if(length(beatstat)=2){
							if((int(beatstat.0)>0)&(int(beatstat.1)>0)){
								beatn2=int(beatstat.0)
								beatd2=int(beatstat.1)
							}
						}
						continue
					}
					if(strmid(d.(cnt2a+cnt+1),4,1)!="|"){
						continue
					}
					if(strmid(d.(cnt2a+cnt+1),lcnt+5,1)=stat2){
						if(div.(cnt3+excd)=0):break
						lend+=double(bpba)*beatn2/beatd2/div.(cnt3+excd)
					}else{
						break
					}
				loop
				if(turn=1){
					notefx.notefxnum.0=5-cnt
				}else:if((turn=2)|(turn=3)|(turn=4)){
					notefx.notefxnum.0=4+(cnt^pturnl)
				}else{
					notefx.notefxnum.0=cnt+4
				}
				notefx.notefxnum.1=int(cbcnt)+cnt2*bpba*beatn/beatd/div.cnt3
				notefx.notefxnum.2=int(lend)
				notefx.notefxnum.3=c2t(notefx.notefxnum.1)
				notefx.notefxnum.4=c2t(notefx.notefxnum.1+notefx.notefxnum.2)
				if(csongver_int>=160){
					repeat fxnum
						if((fx.cnt.0=lcnt)&(fx.cnt.1=notefx.notefxnum.1)){
							notefx.notefxnum.5=fx.cnt.2
							notefx.notefxnum.6=fx.cnt.3
							notefx.notefxnum.7=fx.cnt.4
							break
						}
					loop
				}else{
					stat1=strmid(d.cnt2a,cnt+5,1)
					if(stat2="S"){
						notefx.notefxnum.5=1
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Retr=1
					}else:if(stat2="V"){
						notefx.notefxnum.5=2
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Retr=1
					}else:if(stat2="T"){
						notefx.notefxnum.5=3
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Retr=1
					}else:if(stat2="W"){
						notefx.notefxnum.5=4
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Retr=1
					}else:if(stat2="U"){
						notefx.notefxnum.5=5
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Retr=1
					}else:if(stat2="G"){
						notefx.notefxnum.5=6
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Gate=1
					}else:if(stat2="H"){
						notefx.notefxnum.5=7
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Gate=1
					}else:if(stat2="K"){
						notefx.notefxnum.5=8
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Gate=1
					}else:if(stat2="I"){
						notefx.notefxnum.5=9
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Gate=1
					}else:if(stat2="L"){
						notefx.notefxnum.5=10
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Gate=1
					}else:if(stat2="J"){
						notefx.notefxnum.5=11
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Gate=1
					}else:if(stat2="F"){
						notefx.notefxnum.5=12
						fl_Flan=1
					}else:if(stat2="P"){
						notefx.notefxnum.5=13
						note.notenum.4=12
					}else:if(stat2="B"){
						notefx.notefxnum.5=14
						notefx.notefxnum.6=5
						repeat fxparamsnum
							if((fxparams.cnt.0=notefx.notefxnum.0-4)&(fxparams.cnt.1=notefx.notefxnum.1)){
								notefx.notefxnum.6=min(max(fxparams.cnt.2,0),64)
							}
						loop
						fl_BitC=1
					}else:if(stat2="Q"){
						notefx.notefxnum.5=15
						fl_Phas=1
					}else:if(stat2="X"){
						notefx.notefxnum.5=16
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Gate=1
					}else:if(stat2="A"){
						notefx.notefxnum.5=17
						repeat fxparamsnum
							if((fxparams.cnt.0=notefx.notefxnum.0-4)&(fxparams.cnt.1=notefx.notefxnum.1)){
								notefx.notefxnum.6=min(max(fxparams.cnt.2,0),100)
							}
						loop
						fl_TStp=1
					}else:if(stat2="D"){
						notefx.notefxnum.5=19
						fl_SiCh=1
					}else{
						notefx.notefxnum.5=0
					}
				}
				notefxnum++
			}
			fxfl.cnt=0
		loop
		// アナログデバイスのリストアップ
		dim analogturnstat,2
		repeat 2
			if(analogmode=3):break
			if((strmid(d.cnt2a,cnt+8,1)!="-")&(strmid(d.cnt2a,cnt+8,1)!=":")){
				cnt0=cnt
				// アナログデバイスの開始地点かどうかを判定
				exc=0
				if(cnt2a=0){
					analog.analognum.5=1
					anagrcnt.cnt=max(anagrcnt.0,anagrcnt.1)+1
				}else{
					repeat
						if(cnt2a-cnt-1<0){
							analog.analognum.5=1
							anagrcnt.cnt=max(anagrcnt.0,anagrcnt.1)+1
							break
						}
						if(strmid(d.(cnt2a-cnt-1),cnt0+8,1)=":"){
							exc++
							continue
						}
						if(strmid(d.(cnt2a-cnt-1),4,1)!="|"){
							exc++
							continue
						}
						break
					loop
					if(cnt2a-exc-1>=0){
						if(strmid(d.(cnt2a-exc-1),cnt+8,1)="-"){
							analog.analognum.5=1
							anagrcnt.cnt=max(anagrcnt.0,anagrcnt.1)+1
						}
						if(cnt2a>1){
							exc2=0
							repeat
								if(strmid(d.(cnt2a-exc-cnt-1),4,1)!="|"){
									exc2++
									continue
								}
								break
							loop
						}
					}
				}
				// アナログデバイスの変化にかかる長さを確認
				excd=0
				stat3=0
				beatn2=beatn
				beatd2=beatd
				ddim lend,1
				lend=double(bpba)*beatn2/beatd2/div.(cnt3+excd)
				repeat
					if(stat3=1){
						stat3=0
					}
					if(cnt2a+cnt+1>=sp){
						stat1=-1 // 異常
						break
					}
					if(strmid(d.(cnt2a+cnt+1),0,2)="--"){
						excd++
						continue
					}
					if(headcmp(d.(cnt2a+cnt+1),5,"beat=")){
						sdim beatstat,16,2
						stat1=strmid(d.(cnt2a+cnt+1),5,33)
						split stat1,"/",beatstat
						if(length(beatstat)=2){
							if((int(beatstat.0)>0)&(int(beatstat.1)>0)){
								beatn2=int(beatstat.0)
								beatd2=int(beatstat.1)
							}
						}
						continue
					}
					if(strmid(d.(cnt2a+cnt+1),4,1)!="|"){
						continue
					}
					if(div.(cnt3+excd)=0){
						break
					}
					if(strmid(d.(cnt2a+cnt+1),cnt0+8,1)!=":"){
						stat1=a2p(strmid(d.(cnt2a+cnt+1),cnt0+8,1))
						break
					}
					lend+=double(bpba)*beatn2/beatd2/div.(cnt3+excd)
				loop
				// 異常がなければリストに追加
				if(stat1!=-1){
					// 対象のアナログデバイス(L:0,R:1)
					if(turn=1){
						analog.analognum.0=1-cnt
					}else:if((turn=2)|(turn=3)|(turn=4)){
						analog.analognum.0=cnt^pturna
					}else{
						analog.analognum.0=cnt
					}
					analog.analognum.1=int(cbcnt)+cnt2*bpba*beatn/beatd/div.cnt3 // 変化の始点カウント値
					if(analog.analognum.1>=cmdline_from){
						analog.analognum.2=int(lend) // 変化にかかる時間
						analog.analognum.6=c2t(analog.analognum.1) // 変化の始点t
						analog.analognum.7=c2t(analog.analognum.1+analog.analognum.2) // 変化の終点t
						if(t_finalnote<analog.analognum.7):t_finalnote=analog.analognum.7
						if((analog.analognum.5=1)&(anaendstat.cnt!=-1)){
							analog.(anaendstat.cnt).8=1
						}
						analog.analognum.9=-1
						if(anaendstat.cnt>=0):analognext.(anaendstat.cnt)=analognum
						analognext.analognum=-1
						analogprev.analognum=anaendstat.cnt
						anaendstat.cnt=analognum
						analog.analognum.3=a2p(strmid(d.cnt2a,cnt+8,1)) // 変化の初期値
						analog.analognum.4=stat1 // 変化の目標値
						if((turn=1)|(((turn=2)|(turn=3)|(turn=4))&(pturna=1))){
							analog.analognum.3=50-analog.analognum.3
							analog.analognum.4=50-analog.analognum.4
						}
						if((analog.analognum.5=0)&(analogturnstat.cnt!=abs(analog.analognum.4-analog.analognum.3))){
							analogturn.cnt.(analogturnnum.cnt)=analog.analognum.6
							analogturnnum.cnt++
						}
						analogturnstat.cnt=abs(analog.analognum.4-analog.analognum.3)
						analoggr.analognum=anagrcnt.cnt // アナログデバイスのまとまりの番号
						analoggrmax.cnt=anagrcnt.cnt
						if(analogmode!=mode_off){
							if(bpm<256000){
								stat1=bpba_16
							}else{
								stat1=bpba_8
							}
							if((analog.analognum.2>bpba_32)|(analog.analognum.3=analog.analognum.4)){
								for i,(analog.analognum.1+stat1-1)/stat1*stat1/*+analog.analognum.5*stat1*/,analog.analognum.1+analog.analognum.2,stat1
									if(turn=1){
										analogj.analogjnum.0=1-cnt
									}else:if((turn=2)|(turn=3)|(turn=4)){
										analogj.analogjnum.0=cnt^pturna
									}else{
										analogj.analogjnum.0=cnt
									}
									analogj.analogjnum.1=i
									analogj.analogjnum.3=max(laserrate,1)
									analogjnum++
									if(analogmode!=mode_off){
										stat4+=laserrate
										stat4_2+=50*laserrate
									}
								next
							}else{
								if(turn=1){
									analoganj.analoganjnum.0=1-cnt
								}else:if((turn=2)|(turn=3)|(turn=4)){
									analoganj.analoganjnum.0=cnt^pturna
								}else{
									analoganj.analoganjnum.0=cnt
								}
								analoganj.analoganjnum.1=analognum
								analoganj.analoganjnum.3=analog.analognum.4
								analoganj.analoganjnum.4=0
								analoganj.analoganjnum.5=max(laserrate,1)
								analoganjnum++
								if(analogmode!=mode_off){
									stat4+=6*laserrate
									stat4_2+=200*laserrate
								}
							}
						}
						analognum++
					}
				}
			}
		loop
		if(strmid(d.cnt2a,10,1)="@"){
			// 画面回転のリストアップ
			f=1
			if(strmid(d.cnt2a,11,1)="("){
				spin.spinnum.0=0 // 時計回り回転
			}else:if(strmid(d.cnt2a,11,1)=")"){
				spin.spinnum.0=1 // 反時計回り
			}else:if(strmid(d.cnt2a,11,1)="<"){
				spin.spinnum.0=2 // 時計回り半回転
			}else:if(strmid(d.cnt2a,11,1)=">"){
				spin.spinnum.0=3 // 反時計回り半回転
			}else:f=0
			if(f=1){
				if(turn=1){
					spin.spinnum.0=spin.spinnum.0/2*2+1-(spin.spinnum.0-spin.spinnum.0/2*2)
				}else:if((turn=2)|(turn=3)|(turn=4)){
					spin.spinnum.0=spin.spinnum.0/2*2+(spin.spinnum.0-spin.spinnum.0/2*2)^pturna
				}
				spin.spinnum.1=int(cbcnt)+cnt2*bpba*beatn/beatd/div.cnt3 //位置
				spin.spinnum.2=int(double(strmid(d.cnt2a,12,32))*625/12*145/100) //長さ(c)
				spinnum++
			}
		}
		if(strmid(d.cnt2a,10,1)="S"){
			// ばねエフェクトのリストアップ
			f=1
			if(strmid(d.cnt2a,11,1)="<"){
				spr.sprnum.0=0 // 左向き
			}else:if(strmid(d.cnt2a,11,1)=">"){
				spr.sprnum.0=1 // 右向き
			}else:f=0
			if(f=1){
				stat1=strmid(d.cnt2a,12,64)
				sdim splitstat,64,1
				split stat1,";",splitstat
				if(turn=1){
					spr.sprnum.0=spr.sprnum.0/2*2+1-(spr.sprnum.0-spr.sprnum.0/2*2)
				}else:if((turn=2)|(turn=3)|(turn=4)){
					spr.sprnum.0=spr.sprnum.0/2*2+(spr.sprnum.0-spr.sprnum.0/2*2)^pturna
				}
				spr.sprnum.1=int(cbcnt)+cnt2*bpba*beatn/beatd/div.cnt3 //位置
				spr.sprnum.2=int(double(splitstat.0)*625/12) //長さ(c)
				spr.sprnum.3=250 //揺れ幅
				if(length(splitstat)>=2):spr.sprnum.3=max(int(splitstat.1),0)
				spr.sprnum.4=3 //回数 (片道+1 往復+2)
				if(length(splitstat)>=3):spr.sprnum.4=max(int(splitstat.2),0)
				spr.sprnum.5=2 //減衰の有無 (0:なし 1:あり(遅) 2:あり)
				if(spr.sprnum.4>=0){
					if(length(splitstat)>=4):spr.sprnum.5=min(max(int(splitstat.3),0),2)
					sprnum++
				}
			}
		}
		pturnlp=pturnl
		next_se="",""
		next_se_vol=100,100
	loop
	repeat 2
		if(anaendstat.cnt!=-1):analog.(anaendstat.cnt).8=1
	loop
	totalcombo+=analoganjnum+analogjnum
	dim mid_sw,swaudionum
	repeat swaudionum
		exist swaudio.cnt
		if(strsize>0){
			mid_sw.cnt=KSHLib_SwitchAudioOpen(cnt,swaudio.cnt,0x20000)
		}else{
			exist getpath(ccsongfile,32)+swaudio.cnt
			if(strsize>0){
				mid_sw.cnt=KSHLib_SwitchAudioOpen(cnt,getpath(ccsongfile,32)+swaudio.cnt,0x20000)
			}else:dialog "Error: Could not find SwitchAudio file (\""+swaudio.cnt+"\")"
		}
		BASS_ChannelSetLink mid.0,mid_sw.cnt
		if(BASS_ErrorGetCode()!=0){
			mlinkfailed=1
		}
		hPeakFX_sw.cnt=BASS_ChannelSetFX(mid_sw.cnt,0x10013,2)
		hPeakFX2_sw.cnt=BASS_ChannelSetFX(mid_sw.cnt,0x10013,3)
		hBitCFX_sw.cnt=BASS_VST_ChannelSetDSP(mid_sw.cnt,dir_default+"\\lib\\bitc.dll",0,8)
		BASS_VST_SetParam_R hBitCFX_sw.cnt,0,0.0f
		hCompFX_sw.cnt=-1
		hVolFX2_sw.cnt=-1
	loop
	// VSTエフェクトの適用
	dim user_now,max(userfxnum,1)
	if(feffect=1){
		dim hFX_Echo,2
		hFX_Echo=-1,-1
		if(fl_Echo=1){
			repeat 2
				hFX_Echo.cnt=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\regawo.dll",0,26)
				BASS_VST_SetParam_R hFX_Echo.cnt,1,0.0f
				BASS_VST_SetParam_R hFX_Echo.cnt,2,1.00f
				BASS_VST_SetParam_R hFX_Echo.cnt,29,1.0f
			loop
		}
		if(fl_Retr=1){
			hFX_Retr=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\regawo.dll",0,25)
			BASS_VST_SetParam_R hFX_Retr,1,0.0f
			BASS_VST_SetParam_R hFX_Retr,2,0.70f
			BASS_VST_SetParam_R hFX_Retr,29,1.0f
		}
		if(fl_Pitc=1){
			hFX_Pitc=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\pitc.dll",0,20)
			BASS_VST_SetParam_R hFX_Pitc,0,0.0f/48.0f/2.0f+0.50f
			BASS_VST_SetParam_R hFX_Pitc,1,700.0f/44100.0f
			BASS_VST_SetParam_R hFX_Pitc,2,0.40f*2.0f
			BASS_VST_SetParam_R hFX_Pitc,3,0.0f
		}
		if(fl_BitC=1){
			hFX_BitC=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\bitc.dll",0,19)
			BASS_VST_SetParam_R hFX_BitC,0,0
		}
		dim hFX_TStp,2
		hFX_TStp=-1,-1
		if(fl_TStp=1){
			hFX_TStp.0=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\tstp.dll",0,19)
			hFX_TStp.1=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\tstp.dll",0,18)
		}
		if(fl_Gate=1){
			hFX_Gate=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\regawo.dll",0,17)
			BASS_VST_SetParam_R hFX_Gate,1,0.0f
			BASS_VST_SetParam_R hFX_Gate,7,0.50f
			BASS_VST_SetParam_R hFX_Gate,8,0.90f
			BASS_VST_SetParam_R hFX_Gate,10,500.0f/22050.0f
			BASS_VST_SetParam_R hFX_Gate,11,20000.0f/22050.0f
			BASS_VST_SetParam_R hFX_Gate,12,1.414f/50.0f
			BASS_VST_SetParam_R hFX_Gate,13,0.80f
			BASS_VST_SetParam_R hFX_Gate,29,0.0f // GateとWobbleがあるためByPassにすると処理がややこしい
		}
		if(fl_Phas=1){
			hFX_Phas=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\phas.dll",0,16)
			BASS_VST_SetParam_R hFX_Phas,0,0.25f
			BASS_VST_SetParam_R hFX_Phas,1,0.0f
			BASS_VST_SetParam_R hFX_Phas,2,1500.0f/22050.0f
			BASS_VST_SetParam_R hFX_Phas,3,20000.0f/22050.0f
			BASS_VST_SetParam_R hFX_Phas,4,0.707f/50.0f
			BASS_VST_SetParam_R hFX_Phas,5,0.35f
			BASS_VST_SetParam_R hFX_Phas,6,0.75f
			BASS_VST_SetParam_R hFX_Phas,7,8.0f/20.0f
			BASS_VST_SetParam_R hFX_Phas,8,0.0f
		}
		if(fl_Flan=1){
			hFX_Flan=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\flan.dll",0,15)
			BASS_VST_SetParam_R hFX_Flan,0,0.25f
			BASS_VST_SetParam_R hFX_Flan,1,30.0f/44100.0f
			BASS_VST_SetParam_R hFX_Flan,2,45.0f/44100.0f
			BASS_VST_SetParam_R hFX_Flan,3,0.60f
			BASS_VST_SetParam_R hFX_Flan,4,0.0f
			BASS_VST_SetParam_R hFX_Flan,5,0.75f
			BASS_VST_SetParam_R hFX_Flan,6,0.0f
		}
		if(fl_SiCh=1){
			hFX_SiCh=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\sich.dll",0,14)
			BASS_VST_SetParam_R hFX_SiCh,1,0.0050f
			BASS_VST_SetParam_R hFX_SiCh,2,0.0f
			BASS_VST_SetParam_R hFX_SiCh,3,0.0010f
		}
		dim hFX_User,userfxnum+userfilternum
		repeat userfxnum
			if(userfx_fl.cnt=0){
				hFX_User.cnt=-1
				continue
			}
			hFX_User.cnt=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\"+fxdef_dllname.(int(userfx_params.cnt.0)),0,fxdef_priority.(int(userfx_params.cnt.0)))
			cnt2=cnt
			repeat fxdef_prmnum.(int(userfx_params.cnt2.0)),1
				if((userfx_params.cnt2.cnt<0.0f)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)){
					BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(-userfx_params.cnt2.cnt/10.0f,0.0f),1.0f)
				}else:if(fxdef_max.cnt.(int(userfx_params.cnt2.0))>0.0f){
					BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(fxdef_prmmax.cnt.(int(userfx_params.cnt2.0))*userfx_params.cnt2.cnt/fxdef_max.cnt.(int(userfx_params.cnt2.0)),0.0f),1.0f)
				}else:if((userfx_params.cnt2.cnt>0.0f)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)&(fxdef_linkprm.(int(userfx_params.cnt2.0))=cnt)){
					user_now.cnt2=int(1.0f/userfx_params.cnt2.cnt)
				}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_PITCH)){
					// PitchShift pitch
					BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),maxf(minf(absf(userfx_params.cnt2.cnt),1.0f),0.0f)
				}
			loop
			// ByPassの設定
			BASS_VST_SetParam_R hFX_User.cnt,29,1.0f
		loop
	}
	// 回転の適用
	spinfcnt=0
	sprfcnt=0
	repeat analognum
		if((analog.cnt.2<=bpba_32)&(analog.cnt.3!=analog.cnt.4)){
			stat1=cnt
			repeat spinnum-spinfcnt,spinfcnt
				if(spin.cnt.1<analog.stat1.1):spinfcnt=cnt
				if((spin.cnt.1=analog.stat1.1)&(sgn(analog.stat1.4-analog.stat1.3)=((spin.cnt.0-spin.cnt.0/2*2)*2-1))&(spin.cnt.0<10)){
					analog.stat1.9=cnt
					spin.cnt.0+=10
					break
				}
			loop
			repeat sprnum
				if(spr.cnt.1<analog.stat1.1):sprfcnt=cnt
				if((spr.cnt.1=analog.stat1.1)&(sgn(analog.stat1.4-analog.stat1.3)=((spr.cnt.0-spr.cnt.0/2*2)*2-1))&(spr.cnt.0<10)){
					analog.stat1.9=-cnt-2
					spr.cnt.0+=10
					break
				}
			loop
		}
	loop
	repeat spinnum
		if(spin.cnt.0>=10){
			spin.cnt.0-=10
		}else:spin.cnt.0=-1
	loop
	repeat sprnum
		if(spr.cnt.0>=10){
			spr.cnt.0-=10
		}else:spr.cnt.0=-1
	loop
	// 直角音の種類の適用
	repeat analoganjnum
		stat1=cnt
		repeat ansenum
			if(anse.cnt.0=analog.(analoganj.stat1.1).1){
				analoganj.stat1.4=anse.cnt.1
				break
			}
		loop
	loop
	// レーザー移動幅の適用
	repeat 2
		cnt2=cnt
		repeat max(analoggrmax.0,analoggrmax.1)+1
			anagrran.cnt2.cnt=1
		loop
	loop
	repeat anarannum
		cnt2=cnt
		repeat analognum
			if((anaran.cnt2.0=analog.cnt.0)&(anaran.cnt2.1=analog.cnt.1)&(analog.cnt.5=1)){
				anagrran.(analog.cnt.0).(analoggr.cnt)=anaran.cnt2.2
			}
			if((analog.cnt.1>=anaran.cnt2.1)&(analog.cnt.0=anaran.cnt2.0)):break
		loop
	loop
	if(adjmode=1){
		repeat
			note.notenum.0=2
			note.notenum.1=int(double(cnt)*bpba_4)
			note.notenum.2=0
			note.notenum.3=c2t(note.notenum.1)
			note.notenum.4=note.notenum.3
			note.notenum.5=-1
			if(note.notenum.3>mlength):break
			if(np.3!=-1){
				note.(np.3).5=notenum
			}
			np.3=notenum
			notenum++
			stat4+=6
			stat4_2+=200
		loop
	}
	gosub *minfoprepare
	// ゲージ増減量の決定
	if(csongtotal<100){
		gaugemax=int(double(stat4)*20)
		if(gaugemax<125000){
			gaugemax=(gaugemax*gaugemax/125000)/5+gaugemax*4/5
		}
		if(gaugemax>100000){
			gaugemax=100000+(gaugemax-100000)/2
		}
		gaugemax=min(gaugemax,125000)
	}else{
		gaugemax=int(double(stat4_2)*100/csongtotal)
	}
	if(gaugemax>stat4_2):gaugemax=stat4_2
	if(gaugemax=0):gaugemax=1
	csongtotal=stat4_2*100/gaugemax
	// 無駄な確保をやめる
	sdim d,1
	dim kar,notenum,8
	repeat notenum
		cnt2=cnt
		repeat 8
			kar.cnt2.cnt=note.cnt2.cnt
		loop
	loop
	dim note,notenum,8
	repeat notenum
		cnt2=cnt
		repeat 8
			note.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,notefxnum,8
	repeat notefxnum
		cnt2=cnt
		repeat 8
			kar.cnt2.cnt=notefx.cnt2.cnt
		loop
	loop
	dim notefx,notefxnum,8
	repeat notefxnum
		cnt2=cnt
		repeat 8
			notefx.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,notesejnum,4
	repeat notesejnum
		cnt2=cnt
		repeat 4
			kar.cnt2.cnt=notesej.cnt2.cnt
		loop
	loop
	dim notesej,notesejnum,4
	repeat notesejnum
		cnt2=cnt
		repeat 4
			notesej.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,longjnum,8
	repeat longjnum
		cnt2=cnt
		repeat 8
			kar.cnt2.cnt=longj.cnt2.cnt
		loop
	loop
	dim longj,longjnum,8
	repeat longjnum
		cnt2=cnt
		repeat 8
			longj.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,shljnum,8
	repeat shljnum
		cnt2=cnt
		repeat 8
			kar.cnt2.cnt=shlj.cnt2.cnt
		loop
	loop
	dim shlj,shljnum,8
	repeat shljnum
		cnt2=cnt
		repeat 8
			shlj.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,analogjnum,4
	repeat analogjnum
		cnt2=cnt
		repeat 4
			kar.cnt2.cnt=analogj.cnt2.cnt
		loop
	loop
	dim analogj,analogjnum,5
	repeat analogjnum
		cnt2=cnt
		repeat 4
			analogj.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,analoganjnum,6
	repeat analoganjnum
		cnt2=cnt
		repeat 6
			kar.cnt2.cnt=analoganj.cnt2.cnt
		loop
	loop
	dim analoganj,analoganjnum,6
	repeat analoganjnum
		cnt2=cnt
		repeat 6
			analoganj.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,2,max(analogturnnum.0,analogturnnum.1)
	repeat max(analogturnnum.0,analogturnnum.1)
		kar.0.cnt=analogturn.0.cnt
		kar.1.cnt=analogturn.1.cnt
	loop
	dim analogturn,2,max(analogturnnum.0,analogturnnum.1)
	repeat max(analogturnnum.0,analogturnnum.1)
		analogturn.0.cnt=kar.0.cnt
		analogturn.1.cnt=kar.1.cnt
	loop
	dim noteresult,notenum
	dim noteresult,notenum
	dim kar,analognum,10
	repeat analognum
		cnt2=cnt
		repeat 10
			kar.cnt2.cnt=analog.cnt2.cnt
		loop
	loop
	dim analog,analognum,10
	repeat analognum
		cnt2=cnt
		repeat 10
			analog.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,analognum
	repeat analognum
		kar.cnt=analoggr.cnt
	loop
	dim analoggr,analognum
	repeat analognum
		analoggr.cnt=kar.cnt
	loop
	dim kar,analognum
	repeat analognum
		kar.cnt=analogbuf.cnt
	loop
	dim analogbuf,analognum
	repeat analognum
		analogbuf.cnt=kar.cnt
	loop
	dim kar,spinnum,4
	repeat spinnum
		cnt2=cnt
		repeat 4
			kar.cnt2.cnt=spin.cnt2.cnt
		loop
	loop
	dim spin,spinnum,4
	repeat spinnum
		cnt2=cnt
		repeat 4
			spin.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,sprnum,6
	repeat sprnum
		cnt2=cnt
		repeat 6
			kar.cnt2.cnt=spr.cnt2.cnt
		loop
	loop
	dim spr,sprnum,6
	repeat sprnum
		cnt2=cnt
		repeat 6
			spr.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,tiltnum,2
	repeat tiltnum
		cnt2=cnt
		repeat 2
			kar.cnt2.cnt=tilt.cnt2.cnt
		loop
	loop
	dim tilt,tiltnum,5//6
	repeat tiltnum
		cnt2=cnt
		repeat 2
			tilt.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,bpmlnum,3
	repeat bpmlnum
		cnt2=cnt
		repeat 3
			kar.cnt2.cnt=bpml.cnt2.cnt
		loop
	loop
	dim bpml,bpmlnum,3
	repeat bpmlnum
		cnt2=cnt
		repeat 3
			bpml.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,beatlnum,3
	repeat beatlnum
		cnt2=cnt
		repeat 3
			kar.cnt2.cnt=beatl.cnt2.cnt
		loop
	loop
	dim beatl,beatlnum,3
	repeat beatlnum
		cnt2=cnt
		repeat 3
			beatl.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,anagainnum,2
	repeat anagainnum
		cnt2=cnt
		repeat 2
			kar.cnt2.cnt=anagain.cnt2.cnt
		loop
	loop
	dim anagain,anagainnum,3
	repeat anagainnum
		cnt2=cnt
		repeat 2
			anagain.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,anafilnum,2
	repeat anafilnum
		cnt2=cnt
		repeat 2
			kar.cnt2.cnt=anafil.cnt2.cnt
		loop
	loop
	dim anafil,anafilnum,3
	repeat anafilnum
		cnt2=cnt
		repeat 2
			anafil.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,anvolnum,3
	repeat anvolnum
		cnt2=cnt
		repeat 3
			kar.cnt2.cnt=anvol.cnt2.cnt
		loop
	loop
	dim anvol,anvolnum,3
	repeat anvolnum
		cnt2=cnt
		repeat 3
			anvol.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,stpnum,2
	repeat stpnum
		cnt2=cnt
		repeat 2
			kar.cnt2.cnt=stp.cnt2.cnt
		loop
	loop
	dim stp,stpnum,2
	repeat stpnum
		cnt2=cnt
		repeat 2
			stp.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,1
	if(gaugemax<=0):gaugemax=1
	stateinit=0
	dim notefcnt,6
	dim analogfcnt,2
	dim jfcnt,6
	notejfcnt=0
	dim notefxfcnt,2
	dim shljfcnt,4
	dim longjfcnt,2
	dim analogjfcnt,2
	dim analogjfcnt2,2
	dim analogefffcnt,2
	dim analogturnfcnt,2
	analoganjfcnt=0
	anagainfcnt=0
	anafilfcnt=0
	anafilfcnt2=0
	anvolfcnt=0
	notetickfcnt=0
	rotatefcnt=0
	bpm=bpml.0.1
	nscore=0
	lscore=0
	analogscore=0
	critical=0
	near=0
	errorn=0
	fast=0
	slow=0
	ddim tiltrnow,1
	ddim tiltrnowp,1
	ddim tiltnowstart,1
	tiltnow=0
	tiltnowp=0
	tiltnowslidet=1
	tiltnowstart2=0
	ddim romaxstat,3
	romaxstat.0=maxf(romax*(tiltnowp\3=0)+rotatemax*(tiltnowp\3=1)+rotatemax2*(tiltnowp\3=2),0.1)
	romaxstat.1=maxf(romax*(tiltnow\3=0)+rotatemax*(tiltnow\3=1)+rotatemax2*(tiltnow\3=2),0.1)
	romaxstat.2=double(min(1000,int(800+200*rhsrate)))*romaxstat.1/1000
	tiltrnow=romaxstat.2
	tiltnowt=-50000
	tiltnowstart=tiltrnow
	filtertypep=0
	filtertypep2=0
	canagainp=0
	canagainp2=0
	retr_beat=-1
	retr_beatp=-2
	sich_trigger=0
	dim user_trigger,max(userfxnum,1)
	sich_beat=-1
	sich_beatp=-2
	dim user_beat,max(userfxnum,1)
	dim user_beatp,max(userfxnum,1)
	retr_now=0
	gate_now=0
	wobble_now=0
	dim echo_trigger,2
	dim echo_now,2
	c2bnow=0
	c2bnowp=0
	c2bnowp_50ms=0
	layernowp=-6
	bgnowp=-1
	dim feffectnow,2
	dim feffectp,2
	dim feffectnow_real,2
	dim feffectp_real,2
	feffectp_real=-1,-1
	dim feffectparam,2
	dim feffectparam2,2
	ddim sync,1
	zure=0
	zuremax=0
	d3timerp=d3timer()
	repeat anagainnum
		anagain.cnt.2=c2t(anagain.cnt.0)
	loop
	repeat anafilnum
		anafil.cnt.2=c2t(anafil.cnt.0)
	loop
	repeat analogjnum
		analogj.cnt.4=c2t(analogj.cnt.1)
	loop
	repeat anvolnum
		anvol.cnt.2=c2t(anvol.cnt.0)
	loop
	repeat spinnum
		spin.cnt.4=c2t(spin.cnt.1)
	loop
	repeat tiltnum
		tilt.cnt.2=c2t(tilt.cnt.0)
	loop
	// KEEP時の傾きを事前に計算
	repeat tiltnum
		cnt2=cnt
		ddim ro,2
		repeat analognum
			if((analog.cnt.1<=tilt.cnt2.0-2)&(analog.cnt.1+analog.cnt.2>tilt.cnt2.0-2)){
				if(analog.cnt.2<=bpba_32){
					if(analog.cnt.8=0){
						if(analog.cnt.0=0){
							ro.0+=double(analog.cnt.4)*20
						}else{
							ro.1-=double(abs(analog.cnt.4-50))*20
						}
					}
				}else{
					if(analog.cnt.0=0){
						ro.0+=double(analog.cnt.3)*20+double(analog.cnt.4-analog.cnt.3)*20*(analog.cnt.2-(analog.cnt.1+analog.cnt.2-(tilt.cnt2.0-2)))/analog.cnt.2
					}else{
						ro.1-=double(abs(analog.cnt.3-50))*20+double(abs(analog.cnt.4-50)-abs(analog.cnt.3-50))*20*(analog.cnt.2-(analog.cnt.1+analog.cnt.2-(tilt.cnt2.0-2)))/analog.cnt.2
					}
				}
			}
		loop
		tilt.cnt.4=int(round(ro.0+ro.1))
	loop
	repeat spinnum
		spin.cnt.3=c2t(spin.cnt.1+spin.cnt.2)-spin.cnt.4
	loop
	shortnum=0
	lshnum=0
	repeat notenum
		if((note.cnt.2=0)&(((note.cnt.0<=3)&(shortmode!=mode_off))|((note.cnt.0>3)&(longmode!=mode_off)))){
			if(note.cnt.0<=3){
				shortnum++
			}else{
				lshnum++
			}
		}
	loop
	ddim ro,2
	t_moex=-offset-T_MOEX_DELAY-globaloffset // t_moex: expected music offset time
	if((cmov=0)&(vmov=1)&(output=0)){
		stat1=-voffset-T_MOEX_DELAY-globaloffset
		if(stat1<0):mci "seek v to 0"
	}
	gsel 0
	redraw 0
	hgreset
	selcang
	objsetf2 0,-M_PI/12,0.0f
	selcpos
	objsetf2 1,-45.0f,366.0f
	buffer 156,82/ra,7/ra
	pos 0,0
	gzoom 82/ra,7/ra,1,0,1,82/ra,7
	buffer 157,82/ra,7/ra
	pos 0,0
	gzoom 82/ra,7/ra,42,0,1,82/ra,7
	gsel 0
	texload2 dir_default+"\\cache\\laser_p.png"
	tex_laser_p=stat
	texload2 dir_default+"\\imgs\\score_header.png",480,48
	tex_score_header=stat
	dim tex_num2,2
	texload2 dir_default+"\\cache\\num2_0.png",two(getsize(10)),two(getsize(9)*16*2)
	tex_num2.0=stat
	texload2 dir_default+"\\cache\\num2_1.png",two(getsize(10)),two(getsize(9)*16*2)
	tex_num2.1=stat
	texload2 dir_default+"\\cache\\result_scorenum.png",two(getsize(24)),two(getsize(24)*10)
	tex_result_scorenum=stat
	texload2 dir_default+"\\cache\\er.png"
	tex_er=stat
	texload2 dir_default+"\\cache\\er_p.png"
	tex_er_p=stat
	texload2 dir_default+"\\imgs\\num0.png",136,1200
	tex_num0=stat
	texload2 dir_default+"\\imgs\\playresult.png",540,600
	tex_playresult=stat
	texload2 dir_default+"\\cache\\minfo_label.png"
	tex_minfo_label=stat
	texload2 dir_default+"\\cache\\minfo_detail.png"
	tex_minfo_detail=stat
	texload2 dir_default+"\\cache\\minfo_cur.png"
	tex_minfo_cur=stat
	texload2 dir_default+"\\cache\\fps.png"
	tex_fps=stat
	texload2 dir_default+"\\cache\\timingadjust_ms.png"
	tex_timingadjust_ms=stat
	texload2 dir_default+"\\cache\\timingadjust.png"
	tex_timingadjust=stat
	texload2 dir_default+"\\cache\\timingadjust_sign.png"
	tex_timingadjust_sign=stat
	// 背景画像読み込み
	if(bg>=1){
		stat3=0
		exist dir_default+"\\imgs\\bg\\"+bgname+"0.jpg"
		stat1=strsize
		exist dir_default+"\\imgs\\bg\\"+bgname+"1.jpg"
		stat2=strsize
		if((stat1<=0)|(stat2<=0)){
			sdim bgname2,64,1
			split bgname,";",bgname2
			if(length(bgname2)=1){
				exist bgname2.0
				stat1=strsize
				stat2=strsize
				stat4=bgname2.0
				bgname2=stat4,stat4
			}else:if(length(bgname2)>=2){
				exist bgname2.0
				stat1=strsize
				exist bgname2.1
				stat2=strsize
			}
			if((stat1<=0)|(stat2<=0)){
				bgname="desert"
			}else:stat3=1
		}

		// "cache/bg"ディレクトリが存在しなければ作成
		dirlist buf,dir_default+"\\cache\\bg",5
		if(buf=""):mkdir dir_default+"\\cache\\bg"

		if(stat3=0){
			exist dir_default+"\\cache\\bg\\"+bgname+"0.jpg"
			if(strsize=-1){
				gsel 2
				picload dir_default+"\\imgs\\bg\\"+bgname+"0.jpg"
				alCreateImage 2,two(getsize(900)),two(getsize(800))
				alStretchScreenToImage 2,2,0,0,720,640,0,0,getsize(900),getsize(800)
				alSaveFile dir_default+"\\cache\\bg\\"+bgname+"0.jpg","image/jpeg",0,0,two(getsize(900)),two(getsize(800))
				alDeleteImage 2
			}
			texload dir_default+"\\cache\\bg\\"+bgname+"0.jpg"
			addspr mod_bg0,0,0,0,getsize(900)-1,getsize(800)-1,stat
			exist dir_default+"\\cache\\bg\\"+bgname+"1.jpg"
			if(strsize=-1){
				gsel 2
				picload dir_default+"\\imgs\\bg\\"+bgname+"1.jpg"
				alCreateImage 2,two(getsize(900)),two(getsize(800))
				alStretchScreenToImage 2,2,0,0,720,640,0,0,getsize(900),getsize(800)
				alSaveFile dir_default+"\\cache\\bg\\"+bgname+"1.jpg","image/jpeg",0,0,two(getsize(900)),two(getsize(800))
				alDeleteImage 2
			}
			texload dir_default+"\\cache\\bg\\"+bgname+"1.jpg"
			addspr mod_bg1,0,0,0,getsize(900)-1,getsize(800)-1,stat
		}else{
			gsel 2
			picload bgname2.0
			alCreateImage 2,two(getsize(900)),two(getsize(800))
			alStretchScreenToImage 2,2,0,0,720,640,0,0,getsize(900),getsize(800)
			alSaveFile dir_default+"\\cache\\playbg0.jpg","image/jpeg",0,0,two(getsize(900)),two(getsize(800))
			alDeleteImage 2
			texload dir_default+"\\cache\\playbg0.jpg"
			addspr mod_bg0,0,0,0,getsize(900)-1,getsize(800)-1,stat
			gsel 2
			picload bgname2.1
			alCreateImage 2,two(getsize(900)),two(getsize(800))
			alStretchScreenToImage 2,2,0,0,720,640,0,0,getsize(900),getsize(800)
			alSaveFile dir_default+"\\cache\\playbg1.jpg","image/jpeg",0,0,two(getsize(900)),two(getsize(800))
			alDeleteImage 2
			texload dir_default+"\\cache\\playbg1.jpg"
			addspr mod_bg1,0,0,0,getsize(900)-1,getsize(800)-1,stat
		}
		regobj obj_bg,mod_bg0
	}
	if(bg>=2){
		exist dir_default+"\\imgs\\bg\\"+bgname_l+".gif"
		stat1=strsize
		stat3=0
		if(stat1<=0){
			exist bgname_l
			stat1=strsize
			if(stat1<=0){
				bgname_l="arrow"
			}else:stat3=1
		}
		buffer 2
		if(stat3=1){
			picload bgname_l
		}else{
			picload dir_default+"\\imgs\\bg\\"+bgname_l+".gif"
		}
		layermax=ginfo_winx/600
		dim mod_layer,layermax/3
		buffer 159,two(min(getsize(880),600)*3),two(min(getsize(704),480)*2)
		repeat layermax/3+1
			pos 0,0
			gmode 0
			gzoom min(getsize(880),600)*3,min(getsize(704),480)*2,2,600*3*cnt,0,600*3,480*2
			addspr mod_layer.cnt,0,0,0,min(getsize(880),600)-1,min(getsize(704),480)-1
			settex min(getsize(880),600)*3,min(getsize(704),480)*2,0,-1
		loop
		buffer 2,1,1
		buffer 159,1,1
		regobj obj_layer,mod_layer.0
		setscale obj_layer,880.0f*scrsize_h/480/min(getsize(880),600),880.0f*scrsize_h/480/min(getsize(880),600),880.0f*scrsize_h/480/min(getsize(880),600)
		setefx obj_layer,767
		setpos obj_layer,0.0f,-34.0f*scrsize_h/480/(880.0f*scrsize_h/480/min(getsize(880),600)),0.0f
		dim ev_layeruv,2,3
		repeat 2
			cnt2=cnt
			repeat 3
				newevent ev_layeruv(cnt2,cnt)
				event_uv ev_layeruv(cnt2,cnt),min(getsize(880),600)*cnt,min(getsize(704),480)*cnt2
			loop
		loop
	}
	buffer 129,int(38.5f*scrsize_h/480),int(38.5f*scrsize_h/480)
	alSelectImage 35
	alStretchImageToScreen 35,129,0,0,alGetWidth(),alGetHeight(),0,0,int(38.5f*scrsize_h/480),int(38.5f*scrsize_h/480)
	settex2 -1
	tex_jacket=stat
	gsel 51+118*(anaranfl=2)
	settex vw/ra*anaranfl,vh/ra,0,tex_lane_s
	tex_lane_s=stat
	addmesh mod_lane_s,1,1,0,double(vw2)*2/13,double(vh2)*13/20,tex_lane_s
	regobj obj_lane_s,mod_lane_s
	setefx obj_lane_s,1279,0,0
	sellambient
	objsetf3 256.0f,256.0f,256.0f
	gsel 5+163*(anaranfl=2)
	settex vw/ra*anaranfl,vh/ra,0,tex_lane
	tex_lane=stat
	texload2 dir_default+"\\imgs\\cline.png",344,26
	tex_cline=stat
	addmesh mod_lane,1,1,0,double(vw2)*2/13,double(vh2)*13/20,tex_lane
	regobj obj_lane,mod_lane
	setefx obj_lane,767-512*(bg=0),0,0
	addplate mod_cline,1,344.0f/8,26.0f/8,0,0,343,25,tex_cline
	regobj obj_cline,mod_cline
	setpos obj_cline,0.0f,-2.6f,double(vh2)*13/20/2+0.4f
	setang obj_cline,-M_PI/6,0.0f,0.0f
	gsel 155
	settex judgel_winx*anaranfl,judgel_winy,0,tex_judgel
	tex_judgel=stat
	addplate mod_judgel,0,452.0f*0.95f/8,140.0f*0.95f/8,0,0,judgel_winx-1,judgel_winy-1,tex_judgel
	gsel 155+15
	settex judgel_winx*anaranfl,judgel_winy,0,tex_judgel2x
	tex_judgel2x=stat
	addplate mod_judgel2x,0,452.0f*0.95f/8*2,140.0f*0.95f/8,0,0,judgel_winx*2-1,judgel_winy-1,tex_judgel2x
	regobj obj_judgel,mod_judgel,OBJ_XFRONT
	setpos obj_judgel,0.0f,-2.4f*1.5f,double(vh2)*13/20/2+1.2f*1.5f
	setefx obj_judgel,767,0,0
	dim mod_analogcur,2
	dim obj_analogcur,2
	repeat 2
		addplate mod_analogcur.cnt,1,4.5f,4.5f,0,64*cnt,63,64*cnt+63
		texload2 dir_default+"\\imgs\\laser_cur.png",64,64*2
		regobj obj_analogcur.cnt,mod_analogcur.cnt,OBJ_XFRONT
		setpos obj_analogcur.cnt,0.0f,-2.8f,double(vh2)*13/20/2+1.0f
		setang obj_analogcur.cnt,-M_PI/3,0.0f,0.0f
	loop
	gsel 21
	settex2 -1
	tex_combonum=stat
	gsel 23
	settex2 -1
	tex_er_g=stat
	gsel 147
	settex2 -1
	tex_er_g_pattern=stat
	getpos HGOBJ_CAMERA, camx, camy, camz
	fvset fv1,0.0f,-2.6f,double(vh2)*13/20/2+0.4f
	fvface fv1,camx,camy,camz
	fv2str fv1
	stat1=refstr
	split stat1,",",fvstat
	fv1=double(fvstat.0)
	mdelayt=0
	mrepeat=0
	minforefresh=1
	analogdelay=analogdelayconf+judgedelay
	bpmp=bpm
	dim peffstatap,2
	peffstat2p=0
	swaudionow=-1
	swaudionow_resultp=-1
	mtp=0
	gsel 0
	if((analoginput=2)&(analogmode=mode_on)){
		if(hidem=1):mouse -1,-1
		mouse defx,defy
	}
	dim sliderp,2
	if(analoginput=4){
		repeat 2
			cnt0=cnt
			sliderp.cnt=0
			repeat length_joylist
				joyGetPosEx joystat2,joylist.cnt
				sliderp.cnt0+=joystat2.(4+(cnt0^analogsw))
			loop
		loop
	}
	cnowp=0
	cnowfxp=0
	cnowfxp_50ms=0
	bpmfxp=-1
	slider=0
	dim arstat,8,3
	dim chobufp,4
	plfl=1
	font lang.0.1,getsize(18)
	hgsettime -3400-1000*(cmovfile!=""),INT_MAX
	ts_bass=0
	ddim timingdif,1
	timingdif=-50000f
	ddim ttp,1
	
	if(cmdline_from>0){
		hgsettime max(c2t(cmdline_from)-1000,0),INT_MAX
	}
	
	csongfile_empty=(csongfile.0="")|(csongfile.0=".mp3")
	scrsize480=double(scrsize_h)/480

	// GameSystemの生成
	game_system = 0
	if (CreateGameSystem(cnotesfile, double(t_moex), varptr(game_system)) == 0) {
		dialog lang.2.5/*"譜面データの読み込み中にエラーが発生しました。"*/
		chdir dir_default+"\\songs"
		state=st_select
		return // CreateGameSystemでfalseが返された場合、DestroyGameSystemを明示的に呼ぶ必要はない
	}

	; playmainloop
	repeat
		cpos=0
		nowsttp=-1
		stat1=0
		gsel 0
		getkey enter_key,13
		enter_key=enter_key|getjoykeystat(11)
		stat1=BASS_ChannelGetPosition_ms(mid.0)
		if((stat1<mtp-500)&(mstop=0)&(stat179p=0)){
			mrepeat=1
			foreach mid
				BASS_ChannelSlideAttribute mid.cnt,2,0.0,0
			loop
			repeat swaudionum
				BASS_ChannelSlideAttribute mid_sw.cnt,2,0.0,0
			loop
		}
		mtp=stat1
		if(mshift!=0){
			stat1+=mshift
			hgsettime t_mo+stat1,INT_MAX
			at=t_mo+stat1
			timingdif=0.0f
			mtotalshift-=mshift
			tadj=1
			foreach mid
				BASS_ChannelSetPosition_ms mid.cnt,stat1
			loop
			repeat swaudionum
				BASS_ChannelSetPosition_ms mid_sw.cnt,stat1
			loop
			mshift=0
		}
		t=t_mo+stat1
		t2=t
		if(cnt=0):timestatestart=d3timer()
		if(output=0){
			hggettime at,0
			if(mfl=0){
				if((disableadjtimer=1)&((t>at)|(abs(at-t)>50))&(mendt=-1)&(t_mo!=-50000)){
					hgsettime t,INT_MAX
					at=t
				}
			}
		}else{
			at=100*cnt/3-3400-1000*(cmovfile!="")
		}
		if((output=1)|(mfl=0)|(csongfile_empty)|(csongfile_exist=0)|(at>=mlength-1)){
			t=at
		}else:if((disableadjtimer=0)&(mstop=0)){
			if(timingdif<-40000):timingdif=double(t-at)
			timingdif=(timingdif*7+double(t-at))/8f
			t=at+int(round(timingdif))
		}
		if(mstop=1):t=t_mo+stoppos:at=t
		if((endtype=0)&(adjmode=0)){
			if((tochu=0)&(mendt=-1)){
				endfl=1
				mendt=tp
				mendc=cnowp
				mendat=d3timerp
			}
		}else{
			if(mendt!=-1){
				endfl=1
			}
			if((mlength<=stat1)&(mendt=-1)){
				mendt=tp
				mendc=cnowp
				mendat=d3timerp
			}
		}
		d3timerp=d3timer()
		if(mlength=0):mlength=1
		cpos=200*t/mlength
		if(mendt!=-1):cpos=200
		if(ginfo2()=0){
			getkey ctrl_key,17
			getkey alt_key,18
			getkey stat1,179
			if(((stat1=1)|(ctrl_key+enter_key=2))&(t>1500)&(stat179p=0)&(ginfo2()=0)){
				if(mstop=0){
					stoppos=BASS_ChannelGetPosition_ms(mid.0)
					foreach mid
						BASS_ChannelStop mid.cnt
						if(mlinkfailed=0):break
					loop
					if(mlinkfailed!=0){
						repeat swaudionum
							BASS_ChannelStop mid_sw.cnt
						loop
					}
					mstop=1
				}else{
					foreach mid
						BASS_ChannelSetAttribute mid.cnt,2,0.0
					loop
					repeat swaudionum
						BASS_ChannelSetAttribute mid_sw.cnt,2,0.0
					loop
					foreach mid
						BASS_ChannelPlay mid.cnt
						if(mlinkfailed=0):break
					loop
					if(mlinkfailed!=0){
						repeat swaudionum
							BASS_ChannelPlay mid_sw.cnt
						loop
					}
					if(length(mid)=2){
						foreach mid
							BASS_ChannelUpdate mid.cnt
						loop
						repeat swaudionum
							BASS_ChannelUpdate mid_sw.cnt
						loop
						//BASS_Update
					}
					stat0=0
					repeat 10
						foreach mid
							BASS_ChannelSetPosition_ms mid.cnt,stoppos-stat0*cnt/max(length(mid)-1,1)
						loop
						repeat swaudionum
							BASS_ChannelSetPosition_ms mid_sw.cnt,stoppos-stat0
						loop
						stat0+=BASS_ChannelGetPosition_ms(mid.(max(length(mid)-1,0)))-BASS_ChannelGetPosition_ms(mid.0)
						stat1=BASS_ChannelGetPosition_ms(mid.(max(length(mid)-1,0)))-BASS_ChannelGetPosition_ms(mid.0)
						if(abs(stat1)<3+cnt/2):break
					loop
					hgsettime t_mo+stoppos,INT_MAX
					mstop=0
				}
			}
			if((stat1=1)|(ctrl_key+enter_key=2)){
				stat179p=1
			}else{
				stat179p=0
			}
			getkey stat1,176
			getkey_a stat2,39
			if((mstop=0)&((stat1=1)|((ctrl_key+stat2=2)&(alt_key=0)))&(t>1500)&(ginfo2()=0)){
				if(ts2>60):mshift+=1000
			}else:if((tadj=1)|(tadj=2)){
				stat0=stat0tp
				stat2=t
				repeat 2+8*(tadj=1)
					foreach mid
						BASS_ChannelSetPosition_ms mid.cnt,stat2-stat0*cnt/max(length(mid)-1,1)+offset
					loop
					repeat swaudionum
						BASS_ChannelSetPosition_ms mid_sw.cnt,stat2-stat0+offset
					loop
					stat0+=BASS_ChannelGetPosition_ms(mid.(max(length(mid)-1,0)))-BASS_ChannelGetPosition_ms(mid.0)
					stat1=BASS_ChannelGetPosition_ms(mid.(max(length(mid)-1,0)))-BASS_ChannelGetPosition_ms(mid.0)
					if(abs(stat1)<3+cnt/2):break
				loop
				stat0tp=stat0
				tadj=0
			}
		}
		tfx_diff=d3timer()
		if(cnt!=0){
			t+=sync
			rt=t
		}else{
			rt=t
			tp2=t-16
		}
		if((mendt!=-1)&(output=0)){
			t=d3timer()-mendat+mendt
		}
		tstat=t
		if(cnt=0):tp=t-16
		if(output=1):t=at
		t_tp=t-tp
		cnow=0
		tt=0
		if(bpmlnum>0){
			repeat bpmlnum-max(bpmlcfcnt,1),max(bpmlcfcnt,1)
				if(bpml.cnt.2<t){
					tt=bpml.cnt.2
					cnow=bpml.cnt.0
					bpmlcfcnt=cnt
				}else:break
			loop
			bpm=bpml.bpmlcfcnt.1
			cnow+=int(round(double(t-tt)*bpm/24000))
		}
		stat1=0
		repeat max(stpnum-stpfcnt,0),stpfcnt
			if(cnow>=stp.cnt.0+stp.cnt.1):stpfcnt=cnt:continue
			if(cnow<stp.cnt.0):break
			if((cnow<stp.cnt.0+stp.cnt.1)&(cnow>=stp.cnt.0)){
				stat1=1
			}
		loop
		if((mstop=0)&(mshift=0)&(stat1=0)){
			if(cnt<12){
				ttp_=(ttp_+double(t_tp))/2
			}else:if(cnt<24){
				ttp_=(ttp_*3+double(t_tp))/4
			}else{
				ttp_=(ttp_*7+double(t_tp))/8
			}
			ttp=0
		}
		laserdelay0=laserdelay0_orig
		if(ts>120):ts=0
		if(ts2>60):ts2=0
		if(ts3>30):ts3=0
		ts_timer=d3timer()
		if(cnt=0):ts_timerp=ts_timer
		ts+=max(ts_timer-ts_timerp,1)
		ts2+=max(ts_timer-ts_timerp,1)
		ts3+=max(ts_timer-ts_timerp,1)
		ts_bass+=max(ts_timer-ts_timerp,1)
		ts_timerp=ts_timer
		cstp=0
		if(hsc=-1){
			cnowstpsh=getstpsh(cnow)
		}
		if(ginfo2()=0){
			getkey shift_key,16
			getkey ctrl_key,17
			getkey alt_key,18
			getkey_a stat2,39
			if((ctrl_key+stat2+alt_key+shift_key=4)&(ts>120)&(ginfo2()=0)){
				sync+=1.0
			}else:if((ctrl_key+stat2+alt_key=3)&(ts>120)&(ginfo2()=0)){
				sync+=5.0
			}
			getkey stat2,37
			if((ctrl_key+stat2+alt_key+shift_key=4)&(ts>120)&(ginfo2()=0)){
				sync-=1.0
			}else:if((ctrl_key+stat2+alt_key=3)&(ts>120)&(ginfo2()=0)){
				sync-=5.0
			}
		}
		if((t_moex<=rt)&(mfl=0)&(output=0)&(mendt=-1)&(mplayfl=1)){
			if((csongfile_empty=0)&(csongfile_exist=1)){
				if(rt>t_moex){
					foreach mid
						BASS_ChannelSetPosition_ms mid.cnt,rt-t_moex
					loop
					repeat swaudionum
						BASS_ChannelSetPosition_ms mid_sw.cnt,rt-t_moex
					loop
				}else{
					foreach mid
						BASS_ChannelSetPosition_ms mid.cnt,0
					loop
					repeat swaudionum
						BASS_ChannelSetPosition_ms mid_sw.cnt,0
					loop
				}
				foreach mid
					BASS_ChannelSetAttribute mid.cnt,2,0.0
				loop
				repeat swaudionum
					BASS_ChannelSetAttribute mid_sw.cnt,2,0.0
				loop
				foreach mid
					BASS_ChannelPlay mid.cnt
					if(mlinkfailed=0):break
				loop
				if(mlinkfailed!=0){
					repeat swaudionum
						BASS_ChannelPlay mid_sw.cnt
					loop
				}
				if(length(mid)=2){
					foreach mid
						BASS_ChannelUpdate mid.cnt
					loop
				}
				t_mo=t_moex
				mfl=1
			}
		}
		if(cnt=0):cnowstart=cnow
		if((-voffset-T_MOEX_DELAY-globaloffset<=t)&(vfl=0)&(vmov>=1)){
			if((cmovfile!="")&(output=0)){
				stat1=-voffset-T_MOEX_DELAY-globaloffset
				if(vmov=1){
					if(t>stat1):mci "seek v to "+(t-stat1)
					mci "play v"
				}
				if(t<=stat1){
					t_vo=t
				}else:t_vo=stat1
				vfl=1
			}
		}
		vflp=vfl
		mflp=mfl

		// GameSystemを更新
		UpdateGameSystem game_system, double(t)
		
		dim arstat,8,3
		dim arfl,6
		repeat 6
			arstat.cnt.2=-1
		loop
		if(cnt=0){
			repeat 6
				arstatp.cnt.2=-1
			loop
		}
		stat4=0
		stat5=0
		de=0
		repeat 6
			tcnt=cnt
			rcnt=jfcnt.tcnt
			repeat
				if((rcnt>=notenum)|(rcnt<0)):break
				if(note.rcnt.0!=tcnt){
					jfcnt.tcnt=rcnt
					rcnt++
				}else{
					// ショート/ロングオブジェクト (一番近いものを決定)
					if(t-note.rcnt.4>200):jfcnt.tcnt=rcnt
					if(noteresult.rcnt=0){
						stat1=note.rcnt.3
						if((note.rcnt.2=0)&((abs(stat1-(t-judgedelay)+de)<abs(arstat.tcnt.0))|(arstat.tcnt.1=0))){
							arstat.tcnt.0=stat1-(t-judgedelay)+de // 距離
							arstat.tcnt.1=1 // ノーツ存在フラグ
							arstat.tcnt.2=rcnt // ノート番号
							arfcnt.tcnt=rcnt // ノート番号
						}else:if((note.rcnt.2>0)&(stat1-(t-judgedelay)+de<=150)&((abs(note.rcnt.3-(t-judgedelay))<abs(arstat.tcnt.0))|(arstat.tcnt.1=0))&(note.rcnt.1+note.rcnt.2>cnow)){
							arstat.tcnt.0=stat1-(t-judgedelay)+de // 距離
							arstat.tcnt.1=1 // ノーツ存在フラグ
							arstat.tcnt.2=rcnt // ノート番号
							arfcnt.tcnt=rcnt // ノート番号
							break
						}else:if((note.rcnt.2=0)&(abs(stat1-(t-judgedelay)+de)>=abs(arstat.(note.rcnt.0).0))&(arstat.tcnt.1=1)&(note.rcnt.1>cnow)){
							break
						}else:if((note.rcnt.2>0)&(stat1-(t-judgedelay)+de>200)&(arstat.tcnt.1=1)&(note.rcnt.1>cnow)){
							break
						}
					}
					rcnt=note.rcnt.5
				}
			loop
		loop
		repeat analognum-min(analogjfcnt.0,analogjfcnt.1),min(analogjfcnt.0,analogjfcnt.1)
			if(analog.cnt.6-max(t,t-analogdelay)>=2100):break
			if(min(min(min(t+ttp2+30,t+ttp*adj),t+ttp*adj-analogdelay),t)>analog.cnt.7){
				analogjfcnt.(analog.cnt.0)=cnt
				continue
			}
			// アナログデバイス (被っているor被る予定のものを早い者勝ちで決定)
			if(arstat.(6+analog.cnt.0).0=0){
				if((analog.cnt.6-(t-analogdelay)<2100)&(analog.cnt.7>t-analogdelay)){
					arstat.(6+analog.cnt.0).0=1 // 現在被っているor被る予定か
					arstat.(6+analog.cnt.0).1=cnt // ノート番号
					arstat.(6+analog.cnt.0).2=analog.cnt.5 // アナログデバイスの始点か
				}
			}else:if(arstat.6.0+arstat.7.0=2){
				break
			}
		loop
		if(cnt=0){
			repeat 8
				cnt2=cnt
				repeat 3
					arstatp.cnt2.cnt=arstat.cnt2.cnt
				loop
			loop
			repeat 2
				arstatp.(6+cnt).0=0
			loop
		}
		anastraight=0,0
		// アナログデバイスの回すべき方向を決定
		repeat 2
			stat1=arstatp.(6+cnt).1
			if(arstat.(6+cnt).0=0){
				anadirection.cnt=1-cnt
			}else:if(analog.stat1.3<analog.stat1.4){
				anadirection.cnt=1
			}else:if(analog.stat1.3>analog.stat1.4){
				anadirection.cnt=0
			}else{
				if(analog.stat1.3=0){
					anadirection.cnt=1
				}
				if(analog.stat1.3=50){
					anadirection.cnt=0
				}
				anastraight.cnt=1
			}
		loop
		// キー入力・判定
		stat1=getesckey()
		isendbyesckey=((stat1=1)&(ginfo2()=0))
		if((courseendfl=1)|(courseend=1)|((stat1=1)&(ginfo2()=0))|(((endfl=1)&(mendt=-1))|((endfl=1)&(mendt!=-1)&(d3timer()-mendat>2400+2400*((mendtype=0)&(((effratetype<=0)&(iscourse=0))|(gauge/1000>0))))))){
			tochu_esc=isendbyesckey
			if(((auto=1)|(adjmode=1))&(length(kmode)=3)){
				shortmode=kmode.0
				longmode=kmode.1
				analogmode=kmode.2
			}
			alDeleteImage 53
			alDeleteImage 54
			tex_lane=-1
			tex_lane_s=-1
			tex_judgel=-1
			tex_judgel2x=-1
			mod_lane=-1
			mod_lane_s=-1
			mod_judgel=-1
			if((stat1=1)&(ginfo2()=0)&(autodemo>=1)):autodemo=-1
			state=st_result
			hgreset
			foreach mid
				BASS_StreamFree mid.cnt
			loop
			repeat swaudionum
				BASS_StreamFree mid_sw.cnt
				KSHLib_SwitchAudioFree cnt
			loop
			foreach se_ids_keys
		  		if(se_ids_keys(cnt)==""):continue
				BASS_SampleFree se_ids_values.cnt
			loop
			DestroyGameSystem game_system
			game_system = 0

			gosub *mdatafree
			BASS_SetConfig 1,updateperiod
			if((cmov=0)&(vmov=1)&(output=0)):mci "close v"
			confs=""
			repeat length(confstr)
				if(cnt=length(confstr)-1){
					stat1=""
				}else{
					stat1="\n"
				}
				if(headcmp(confstr.cnt,8,"hispeed=")){
					if((hsm=-1)&(hsc=-1)&(hsa=-1)&(hso=-1)){
						confs+="hispeed=x"+hsr+stat1
					}else:if(hsm!=-1){
						confs+="hispeed=m"+hsm+stat1
					}else:if(hsc!=-1){
						confs+="hispeed=C"+hsc+stat1
					}else:if(hsa!=-1){
						confs+="hispeed=a"+hsa+stat1
					}else{
						confs+="hispeed="+hso+stat1
					}
				}else{
					confs+=confstr.cnt+stat1
				}
			loop
			notesel confs
			split confs,"\n",confstr
			chdir dir_default
			notesave "config.ini"
			chdir "songs"
			gsel 0
			if(int(sync)!=0){
				selnow=1
				repeat
					gosub *getjoystat
					redraw 0
					color 0,0,0
					pos 0,0
					boxf
					pos 90*scrsize_h/480,getsize(220)
					color 255,255,255
					getkey stat1,37
					getkey stat2,key.(6+2*analogsw)
					getkey stat3,key.(8-2*analogsw)
					stat1=stat1|stat2|stat3|getjoykeystat(6+2*analogsw)|getjoykeystat(8-2*analogsw)
					if((stat1=1)&(selnow=1)&(ginfo2()=0)):selnow=0
					getkey_a stat1,39
					getkey stat2,key.(7+2*analogsw)
					getkey stat3,key.(9-2*analogsw)
					stat1=stat1|stat2|stat3|getjoykeystat(7+2*analogsw)|getjoykeystat(9-2*analogsw)
					if((stat1=1)&(selnow=0)&(ginfo2()=0)):selnow=1
					stat3=""
					if(sync<0):stat3="+"
					stat1=lang.2.50/*"曲のタイミング修正を譜面ファイルに保存しますか?\n(曲のオフセットのずれ: "*/+stat3+(-int(sync))+lang.2.51/*"msec)"*/+"\n"
					if(selnow=0){
						stat1+=lang.2.52/*"[  はい  ]    いいえ   "*/
					}else:stat1+=lang.2.53/*"   はい     [ いいえ ] "*/
					gsel 0
					pos scrsize_w/2-getsize(640)/2,scrsize_h/2-getsize(240)/2
					color 255,255,255
					font lang.0.1,getsize(16)
					drawtxt stat1,getsize(640),getsize(240),getsize(16)
					getkey stat1,13
					stat1=stat1|getjoykeystat(11)
					if((stat1=1)&(ginfo2()=0)){
						break
					}
					redraw 1
					await 7
				loop
				redraw 0
				color 0,0,0
				pos 0,0
				boxf
				if(selnow=0){
					color 255,255,255
					pos 190*scrsize_h/480,getsize(220)
					mes lang.2.55/*"保存しています..."*/
					redraw 1
					notesel buf
					if(iscmdline=0){
						chdir dir_default+"\\songs\\"+csongdir
					}
					noteload cnotesfile,-1
					repeat notemax
						noteget stat1,cnt
						if(headcmp(stat1,2,"o=")):noteadd "o="+str(offset-int(sync)),cnt,1:break
					loop
					notesave cnotesfile
				}
				redraw 1
			}
			chdir dir_default+"\\songs"
			break
		}
		if(cnt=0){
			if(double(hs)*bpm>800000f){
				rhsrate=1.0
			}else{
				rhsrate=double(maxf(hs*bpm,600000f))/800000f
			}
		}
		if(double(hs)*bpm<800000f){
			rhsrate=double(maxf(double(hs)*bpm,600000f))/800000*min(100,t_tp)/100+rhsrate*(100-min(100,t_tp))/100
		}else:rhsrate=1.0*min(100,t_tp)/100+rhsrate*(100-min(100,t_tp))/100
		if(bpm!=bpmp):minforefresh=1
		gosub *getjoystat
		dim keystat,7,11
		if((ginfo2()=0)&(enter_key=0)){
			repeat 6
				cnt2=cnt
				repeat 11
					stat1=0
					if(cnt2=0):getkey stat1,key.cnt
					if(cnt2=1):getkey stat1,key2.cnt
					keystat.cnt2.cnt=stat1
				loop
				if((keystat.cnt2.10=1)|(longmode=2)){
					keystat.6.4=1
					keystat.6.5=1
				}
			loop
			repeat 2
				cnt2=cnt
				repeat 11
					if((joykey.cnt2.cnt/32<length(joystat))&(joykey.cnt2.cnt>=0)){
						keystat.(cnt2+2).cnt=joystat.(joykey.cnt2.cnt/32).(joykey.cnt2.cnt\32)
					}
				loop
				if(keystat.(cnt2+2).10=1){
					keystat.6.4=1
					keystat.6.5=1
				}
			loop
		}
		if(analogsw=1){
			repeat 7
				stat1=keystat.cnt.6
				stat2=keystat.cnt.7
				keystat.cnt.6=keystat.cnt.8
				keystat.cnt.7=keystat.cnt.9
				keystat.cnt.8=stat1
				keystat.cnt.9=stat2
			loop
		}
		dim keystator,11
		repeat 11
			keystator.cnt=keystat.0.cnt|keystat.1.cnt|keystat.2.cnt|keystat.3.cnt|keystat.4.cnt|keystat.5.cnt|keystat.6.cnt
		loop
		dim shljudge,4
		dim ljudge,2
		foreach keystat
			cntkey=cnt
			repeat 6
				if(((effratetype>0)|(iscourse=1))&(gauge/1000<=0)):break
				if((keystat.cntkey.cnt=1)&(keystatp.cntkey.cnt=0)&(cnt<=3)){ // BTショートオブジェクト
					if(arstat.cnt.2!=-1){
						if(note.(arstat.cnt.2).2=0){
							if((noteresult.(arstat.cnt.2)=0)&(shortmode!=mode_off)){
								if((shortmode!=mode_auto)&(shortmode!=mode_off)){
									dis=abs(arstat.cnt.0)
									tar=arstat.cnt.2
									if((dis<43)|((arstat.cnt.0>=0)&&(arstat.cnt.0<113)&&(notese.(arstat.cnt.2)!=-1))){
										sync+=double(arstat.cnt.0)*(autosync*(adjmode=0)+adjmode)/90
										zure+=arstat.cnt.0 : zuremax++
										if(notese.(arstat.cnt.2)!=-1){
											if(notesej.(notese.(arstat.cnt.2)).1=0):notesej.(notese.(arstat.cnt.2)).1=1
										}
										noteresult.tar=3
										chainnow++:chainnow_song++
										critical++
										nscore+=2
										if(chainnow>chainmax):chainmax=chainnow
										if(chainnow_song>chainmax_song):chainmax_song=chainnow_song
										if(chainnow\100=0):chainefft=t
										chainvt=t
										ngauge+=200*note.(arstat.cnt.2).7
										if(ngauge>gaugemax):ngauge=gaugemax
										addgauge 4*note.(arstat.cnt.2).7,0
										judge.cnt.0=t-(t_tp)
										judge.cnt.1=3
										judgel.cnt.(judgelnext.cnt).0=t
										judgel.cnt.(judgelnext.cnt).1=3
										judgelnext.cnt=(judgelnext.cnt+1)\judgelmax
									}else:if(dis<113){
										sync+=double(arstat.cnt.0)*(autosync*(adjmode=0)+adjmode)/90
										zure+=arstat.cnt.0 : zuremax++
										if(notese.(arstat.cnt.2)!=-1){
											if(notesej.(notese.(arstat.cnt.2)).1=0):notesej.(notese.(arstat.cnt.2)).1=1
										}
										noteresult.tar=2
										chainnow++:chainnow_song++
										near++
										nscore++
										if(arstat.cnt.0<0){
											slow++
										}else{
											fast++
										}
										if(chainnow>chainmax):chainmax=chainnow
										if(chainnow_song>chainmax_song):chainmax_song=chainnow_song
										if(chainnow\100=0):chainefft=t
										chainvt=t
										ngauge+=50*note.(arstat.cnt.2).7
										if(ngauge>gaugemax):ngauge=gaugemax
										addgauge note.(arstat.cnt.2).7,1
										judge.cnt.0=t-(t_tp)
										judge.cnt.1=2
										if(vtiming=1){
											if(arstat.cnt.0<0){
												judge.cnt.1=4
											}else{
												judge.cnt.1=5
											}
										}
										judgel.cnt.(judgelnext.cnt).0=t
										judgel.cnt.(judgelnext.cnt).1=2
										if(vtiming=1){
											if(arstat.cnt.0>0){
												judgel.cnt.(judgelnext.cnt).1=4
											}
										}
										judgelnext.cnt=(judgelnext.cnt+1)\judgelmax
									}else:if(dis<260-100*(effratetype=-1)){
										noteresult.tar=-1
										judgel.cnt.(judgelnext.cnt).0=t
										judgel.cnt.(judgelnext.cnt).1=1
										judge.cnt.0=t-(t_tp)
										judge.cnt.1=1
										if(vtiming=1){
											judge.cnt.1=6
										}
										judgelnext.cnt=(judgelnext.cnt+1)\judgelmax
									}else:if((judge.cnt.1<=1)|((t-judgedelay)-de-judge.cnt.0>175)){
										judge.cnt.0=t-(t_tp)
										judge.cnt.1=1
									}
								}
							}
						}
					}else:if(shortmode!=mode_off){
						judge.cnt.0=t
						judge.cnt.1=1
					}
				}
				if((cnt<=3)&(shljudge.(min(cnt,3))=0)&(cntkey=0)){ // BTロングオブジェクト
					cnt2=cnt
					stat1=0
					foreach keystat
						stat1=stat1|(((keystatp.cnt.cnt2=0)|((keystatp.cnt.cnt2=1)&(shlstatpp.cnt2=1)))&(keystat.cnt.cnt2=1))
					loop
					if(arstat.cnt.2=-1):shlstat.cnt=0
					if(((stat1=1)|(shortmode=2))&(arstat.cnt.2!=-1)){
						dim astat,5
						astat=note.(arstat.cnt.2).0,note.(arstat.cnt.2).1,note.(arstat.cnt.2).2,note.(arstat.cnt.2).3,note.(arstat.cnt.2).4
						if((shlstatpp.cnt=0)|(shortmode=2)){ // 押した瞬間
							// 今現在被っているor被る予定のSHLがあるか調べる → @
							if(note.(arstat.cnt.2).2>0){
								shlstat.cnt=1
								shljudge.cnt=1
								shlcritical.cnt=arstat.cnt.2
								if(shortmode=2){
									shlstartt.cnt=astat.3
								}else:shlstartt.cnt=max(t,astat.3)
							}
						}
						// @で該当なら現在SHLに被っているかを調べる → 判定
						if(((shortmode=2)&(shlcritical.cnt=arstat.cnt.2)&(shlstat.cnt=1))|((shlstat.cnt=1)&(shlcritical.cnt=arstat.cnt.2)&(arstat.cnt.1=1))){
							stat1=cnt
							repeat shljnum-shljfcnt.stat1,shljfcnt.stat1
								if((shlj.cnt.0=stat1)&((shlj.cnt.3=0)|(shlj.cnt.3=2))){
									if((shlj.cnt.4<=(t-judgedelay)-de)/*&(shlj.cnt.5>(t-judgedelay)-de)*/){
										shlj.cnt.3=1
										//shljfcnt.(shlj.cnt.0)=cnt
										chainnow++:chainnow_song++
										critical++
										nscore+=2
										if(chainnow>chainmax):chainmax=chainnow
										if(chainnow_song>chainmax_song):chainmax_song=chainnow_song
										if(chainnow\100=0):chainefft=t
										chainvt=t
										ngauge+=50*shlj.cnt.7
										if(ngauge>gaugemax):ngauge=gaugemax
										addgauge shlj.cnt.7,0
									}
								}
								if((shlj.cnt.4-((t-judgedelay)-de)>0)&(shlj.cnt.0=stat1)):break
							loop
							shljudge.cnt=1
						}
						shlstatpp.cnt=1
					}else{
						shlstatpp.cnt=0
					}
				}
				if((keystat.cntkey.cnt=1)&(keystatp.cntkey.cnt=0)&(cnt>3)&(cnt<=5)){ // FXショートオブジェクト
					if(arstat.cnt.2!=-1){
						if(note.(arstat.cnt.2).2=0){
							if((noteresult.(arstat.cnt.2)=0)&(longmode!=mode_off)){
								if((longmode!=mode_auto)&(longmode!=mode_off)){
									dis=abs(arstat.cnt.0)
									tar=arstat.cnt.2
									if((dis<43)|((arstat.cnt.0>=0)&&(arstat.cnt.0<113)&&(notese.(arstat.cnt.2)!=-1))){
										sync+=double(arstat.cnt.0)*(autosync*(adjmode=0)+adjmode)/90
										zure+=arstat.cnt.0 : zuremax++
										if(notese.(arstat.cnt.2)!=-1){
											if(notesej.(notese.(arstat.cnt.2)).1=0):notesej.(notese.(arstat.cnt.2)).1=1
										}
										noteresult.tar=3
										chainnow++:chainnow_song++
										critical++
										lscore+=2
										if(chainnow>chainmax):chainmax=chainnow
										if(chainnow_song>chainmax_song):chainmax_song=chainnow_song
										if(chainnow\100=0):chainefft=t
										chainvt=t
										ngauge+=200*note.(arstat.cnt.2).7
										if(ngauge>gaugemax):ngauge=gaugemax
										addgauge 4*note.(arstat.cnt.2).7,0
										judge.cnt.0=t-(t_tp)
										judge.cnt.1=3
										judgel.cnt.(judgelnext.cnt).0=t
										judgel.cnt.(judgelnext.cnt).1=3
										judgelnext.cnt=(judgelnext.cnt+1)\judgelmax
									}else:if(dis<113){
										sync+=double(arstat.cnt.0)*(autosync*(adjmode=0)+adjmode)/90
										zure+=arstat.cnt.0 : zuremax++
										if(notese.(arstat.cnt.2)!=-1){
											if(notesej.(notese.(arstat.cnt.2)).1=0):notesej.(notese.(arstat.cnt.2)).1=1
										}
										noteresult.tar=2
										chainnow++:chainnow_song++
										near++
										lscore++
										if(arstat.cnt.0<0){
											slow++
										}else{
											fast++
										}
										if(chainnow>chainmax):chainmax=chainnow
										if(chainnow_song>chainmax_song):chainmax_song=chainnow_song
										if(chainnow\100=0):chainefft=t
										chainvt=t
										ngauge+=50*note.(arstat.cnt.2).7
										if(ngauge>gaugemax):ngauge=gaugemax
										addgauge note.(arstat.cnt.2).7,1
										judge.cnt.0=t-(t_tp)
										judge.cnt.1=2
										if(vtiming=1){
											if(arstat.cnt.0<0){
												judge.cnt.1=4
											}else{
												judge.cnt.1=5
											}
										}
										judgel.cnt.(judgelnext.cnt).0=t
										judgel.cnt.(judgelnext.cnt).1=2
										if(vtiming=1){
											if(arstat.cnt.0>0){
												judgel.cnt.(judgelnext.cnt).1=4
											}
										}
										judgelnext.cnt=(judgelnext.cnt+1)\judgelmax
									}else:if(dis<250-100*(effratetype=-1)){
										noteresult.tar=-1
										judgel.cnt.(judgelnext.cnt).0=t
										judgel.cnt.(judgelnext.cnt).1=1
										judge.cnt.0=t-(t_tp)
										judge.cnt.1=1
										if(vtiming=1){
											judge.cnt.1=6
										}
										judgelnext.cnt=(judgelnext.cnt+1)\judgelmax
									}else:if((judge.cnt.1<=1)|((t-judgedelay)-de-judge.cnt.0>175)){
										judge.cnt.0=t-(t_tp)
										judge.cnt.1=1
									}
								}
							}
						}
					}else:if(longmode!=mode_off){
						if(cnt>0){
							judge.cnt.0=t
							judge.cnt.1=1
						}
					}
				}
				if((cnt>3)&(cnt<=5)&(cntkey=0)){
					cnt2=cnt
					stat1=0
					foreach keystat
						stat1=stat1|(((keystatp.cnt.cnt2=0)|((keystatp.cnt.cnt2=1)&(longstatpp.(max(cnt2-4,0))=1)))&(keystat.cnt.cnt2=1))
					loop
					if(arstat.cnt.2=-1){
						longstat.(cnt-4)=0
						longstatpp.(cnt-4)=0
					}else:if((stat1=1)|(longmode=2)){ // FXロングオブジェクト
						dim astat,5
						astat=note.(arstat.cnt.2).0,note.(arstat.cnt.2).1,note.(arstat.cnt.2).2,note.(arstat.cnt.2).3,note.(arstat.cnt.2).4
						if((longstatpp.(cnt-4)=0)|(longmode=mode_auto)){ // 押した瞬間
							// 今現在被っているor被る予定のLOがあるか調べる → @
							if(note.(arstat.cnt.2).2>0){
								longstat.(cnt-4)=1
								ljudge.(cnt-4)=1
								longcritical.(cnt-4)=arstat.cnt.2
								if(longmode=mode_auto){
									lstartt.(cnt-4)=astat.3
								}else:lstartt.(cnt-4)=max(t,astat.3)
							}else{
								longstat.(cnt-4)=0
							}
						}
						// @で該当なら現在LOに被っているかを調べる → 判定
						if(((longmode=2)&(longcritical.(cnt-4)=arstat.cnt.2)&(longstat.(cnt-4)=1))|((longstat.(cnt-4)=1)&(longcritical.(cnt-4)=arstat.cnt.2)&(arstat.cnt.1=1))){
							stat1=cnt-4
							repeat longjnum-longjfcnt.stat1,longjfcnt.stat1
								if((longj.cnt.0=stat1)&((longj.cnt.3=0)|(longj.cnt.3=2))){
									if(longj.cnt.4<=(t-judgedelay)-de){
										longj.cnt.3=1
										chainnow++:chainnow_song++
										critical++
										lscore+=2
										if(chainnow>chainmax):chainmax=chainnow
										if(chainnow_song>chainmax_song):chainmax_song=chainnow_song
										if(chainnow\100=0):chainefft=t
										chainvt=t
										ngauge+=50*longj.cnt.7
										if(ngauge>gaugemax):ngauge=gaugemax
										addgauge longj.cnt.7,0
									}
								}
								if((longj.cnt.4>(t-judgedelay)-de)&(longj.cnt.0=stat1)):break
							loop
							ljudge.(cnt-4)=1
						}
						longstatpp.(cnt-4)=1
					}else{
						longstatpp.(cnt-4)=0
					}
				}
			loop
		loop
		if(((effratetype<=0)&(iscourse=0))|(gauge/1000>0)){
			// ASSIST TICKの再生
			repeat notenum-notetickfcnt,notetickfcnt
				if(note.cnt.3>t+t_tp+30):break
				if(note.cnt.0<=3){
					if((assisttick=1)&(tickcp1<note.cnt.1)&(note.cnt.3<=t+t_tp+30)&(tickp.(note.cnt.0)<cnt)){
						stat1=BASS_SampleGetChannel(tickid,0)
						BASS_ChannelSetAttribute stat1,2,double(mastervol)/100
						BASS_ChannelPlay stat1
						tickp.(note.cnt.0)=cnt
						tickcp1=note.cnt.1
					}
				}
				if((note.cnt.0>3)&(note.cnt.2=0)){
					if((assisttick=1)&(tickcp1<note.cnt.1)&(note.cnt.3<=t+t_tp+30)&(tickp.(note.cnt.0)<cnt)){
						stat1=BASS_SampleGetChannel(tick2id,0)
						BASS_ChannelSetAttribute stat1,2,double(mastervol)/100
						BASS_ChannelPlay stat1
						tickp.(note.cnt.0)=cnt
						tickcp2=note.cnt.1
					}
				}
				if(note.cnt.3<=t+t_tp+30):notetickfcnt=cnt
			loop
			repeat notenum-notejfcnt,notejfcnt
				if((note.cnt.0<=3)&(note.cnt.2=0)){
					if(((t-judgedelay)-note.cnt.3>=110)&(t>=0)){
						notejfcnt=max(cnt,notejfcnt)
					}
					if(shortmode=mode_auto){
						if((note.cnt.3<=t)&(noteresult.cnt=0)&(t>=0)){
							if(notese.cnt!=-1){
								if(notesej.(notese.cnt).1=0):notesej.(notese.cnt).1=1
							}
							noteresult.cnt=3
							chainnow++:chainnow_song++
							critical++
							nscore+=2
							if(chainnow>chainmax):chainmax=chainnow
							if(chainnow_song>chainmax_song):chainmax_song=chainnow_song
							if(chainnow\100=0):chainefft=t
							chainvt=t
							ngauge+=200*note.cnt.7
							if(ngauge>gaugemax):ngauge=gaugemax
							addgauge 4*note.cnt.7,0
							judge.(note.cnt.0).0=t-(t_tp)
							judge.(note.cnt.0).1=3
							judgel.(note.cnt.0).(judgelnext.(note.cnt.0)).0=t
							judgel.(note.cnt.0).(judgelnext.(note.cnt.0)).1=3
							judgelnext.(note.cnt.0)=(judgelnext.(note.cnt.0)+1)\judgelmax
						}
					}else:if(shortmode!=mode_off){
						if(((t-judgedelay)-note.cnt.3>=110)&(noteresult.cnt<=0)&(t>=0)){
							noteresult.cnt=1
							judgel.(note.cnt.0).(judgelnext.(note.cnt.0)).0=t
							judgel.(note.cnt.0).(judgelnext.(note.cnt.0)).1=1
							judgelnext.(note.cnt.0)=(judgelnext.(note.cnt.0)+1)\judgelmax
							chainnow=0:chainnow_song=0
							errorn++
							ngauge-=gaugemax*2/100*(10+(note.cnt.7-1)*5)/10
							if(ngauge<0):ngauge=0
							subgauge 4.0f*(1.0f+double(note.cnt.7-1)/2)
							noerror=0
							noerror_song=0
						}
					}
				}
				if((note.cnt.0>3)&(note.cnt.2=0)){
					if(((t-judgedelay)-note.cnt.3>=110)&(t>=0)){
						notejfcnt=max(cnt,notejfcnt)
					}
					if(longmode=mode_auto){
						if((note.cnt.3<=t+(t_tp))&(noteresult.cnt=0)&(t>=0)){
							if(notese.cnt!=-1){
								if(notesej.(notese.cnt).1=0):notesej.(notese.cnt).1=1
							}
							noteresult.cnt=3
							chainnow++:chainnow_song++
							critical++
							lscore+=2
							if(chainnow>chainmax):chainmax=chainnow
							if(chainnow_song>chainmax_song):chainmax_song=chainnow_song
							if(chainnow\100=0):chainefft=t
							chainvt=t
							ngauge+=200*note.cnt.7
							if(ngauge>gaugemax):ngauge=gaugemax
							addgauge 4*note.cnt.7,0
							judge.(note.cnt.0).0=t-(t_tp)
							judge.(note.cnt.0).1=3
							judgel.(note.cnt.0).(judgelnext.(note.cnt.0)).0=note.cnt.3-80
							judgel.(note.cnt.0).(judgelnext.(note.cnt.0)).1=3
							judgelnext.(note.cnt.0)=(judgelnext.(note.cnt.0)+1)\judgelmax
						}
					}else:if(longmode!=mode_off){
						if(((t-judgedelay)-note.cnt.3>=110)&(noteresult.cnt<=0)&(t>=0)){
							noteresult.cnt=1
							judgel.(note.cnt.0).(judgelnext.(note.cnt.0)).0=t
							judgel.(note.cnt.0).(judgelnext.(note.cnt.0)).1=1
							judgelnext.(note.cnt.0)=(judgelnext.(note.cnt.0)+1)\judgelmax
							chainnow=0:chainnow_song=0
							errorn++
							ngauge-=gaugemax*2/100*(10+(note.cnt.7-1)*5)/10
							if(ngauge<0):ngauge=0
							subgauge 4.0f*(1.0f+double(note.cnt.7-1)/2)
							noerror=0
							noerror_song=0
						}
					}
				}
				if(note.cnt.1-cnow>bpba_2):break
			loop
			repeat 2
				cnt0=cnt
				colfl=0
				repeat longjnum-longjfcnt.cnt0,longjfcnt.cnt0
					if(longj.cnt.0!=cnt0):continue
					if(colfl=0):longjfcnt.cnt0=max(longjfcnt.cnt0,cnt):colfl=1
					if((longj.cnt.4<(t-judgedelay)-de)&(longj.cnt.3=2)){
						longj.cnt.3=1
						chainnow++:chainnow_song++
						critical++
						lscore+=2
						if(chainnow>chainmax):chainmax=chainnow
						if(chainnow_song>chainmax_song):chainmax_song=chainnow_song
						if(chainnow\100=0):chainefft=t
						chainvt=t
						ngauge+=50*longj.cnt.7
						if(ngauge>gaugemax):ngauge=gaugemax
						addgauge longj.cnt.7,0
						longjfcnt.cnt0=max(longjfcnt.cnt0,cnt+1)
					}
					if((longj.cnt.4<(t-judgedelay)-de)&(longj.cnt.3=0)){
						if((((ljudge.cnt0=1)|(0&(arstatp.(4+longj.cnt.0).2=longj.cnt.6)&(arstat.(4+longj.cnt.0).2!=longj.cnt.6)&(ljudgep.(longj.cnt.0)=1)&(keystator.(4+longj.cnt.0)=1)))&(longcritical.cnt0=longj.cnt.6))|(longmode=mode_auto)){
							longj.cnt.3=1
							chainnow++:chainnow_song++
							critical++
							lscore+=2
							if(chainnow>chainmax):chainmax=chainnow
							if(chainnow_song>chainmax_song):chainmax_song=chainnow_song
							if(chainnow\100=0):chainefft=t
							chainvt=t
							ngauge+=50*longj.cnt.7
							if(ngauge>gaugemax):ngauge=gaugemax
							addgauge longj.cnt.7,0
							longjfcnt.cnt0=max(longjfcnt.cnt0,cnt+1)
						}else:if(longj.cnt.5<(t-judgedelay)-de){
							longj.cnt.3=-1
							chainnow=0:chainnow_song=0
							errorn++
							ngauge-=gaugemax/200*(10+(longj.cnt.7-1)*5)/10
							if(ngauge<0):ngauge=0
							subgauge 1.0f+double(longj.cnt.7-1)/2
							noerror=0
							noerror_song=0
							longjfcnt.cnt0=max(longjfcnt.cnt0,cnt+1)
						}
					}
					if(longj.cnt.5<(t-judgedelay)-de):longjfcnt.cnt0=max(longjfcnt.cnt0,cnt+1)
					if(longj.cnt.4>=(t-judgedelay)-de):break
				loop
			loop
			repeat 4
				cnt0=cnt
				colfl=0
				repeat shljnum-shljfcnt.cnt0,shljfcnt.cnt0
					if(shlj.cnt.0!=cnt0):continue
					if(colfl=0):shljfcnt.cnt0=max(shljfcnt.cnt0,cnt):colfl=1
					if((shlj.cnt.4<(t-judgedelay)-de)&(shlj.cnt.3=2)){
						shlj.cnt.3=1
						chainnow++:chainnow_song++
						critical++
						nscore+=2
						if(chainnow>chainmax):chainmax=chainnow
						if(chainnow_song>chainmax_song):chainmax_song=chainnow_song
						if(chainnow\100=0):chainefft=t
						chainvt=t
						ngauge+=50*shlj.cnt.7
						if(ngauge>gaugemax):ngauge=gaugemax
						addgauge shlj.cnt.7,0
						shljfcnt.(shlj.cnt.0)=cnt+1
					}
					if((shlj.cnt.4<(t-judgedelay)-de)&(shlj.cnt.3=0)){
						if(((shljudge.(shlj.cnt.0)=1)&(shlcritical.(shlj.cnt.0)=shlj.cnt.6))|(shortmode=mode_auto)){
							shlj.cnt.3=1
							chainnow++:chainnow_song++
							critical++
							nscore+=2
							if(chainnow>chainmax):chainmax=chainnow
							if(chainnow_song>chainmax_song):chainmax_song=chainnow_song
							if(chainnow\100=0):chainefft=t
							chainvt=t
							ngauge+=50*shlj.cnt.7
							if(ngauge>gaugemax):ngauge=gaugemax
							addgauge shlj.cnt.7,0
							shljfcnt.(shlj.cnt.0)=cnt+1 
						}else:if(shlj.cnt.5<(t-judgedelay)-de){
							shlj.cnt.3=-1
							chainnow=0:chainnow_song=0
							errorn++
							ngauge-=gaugemax/200*(10+(shlj.cnt.7-1)*5)/10
							if(ngauge<0):ngauge=0
							subgauge 1.0f+double(shlj.cnt.7-1)/2
							noerror=0
							noerror_song=0
							shljfcnt.(shlj.cnt.0)=cnt+1
						}
					}
					if(shlj.cnt.5<(t-judgedelay)-de):shljfcnt.(shlj.cnt.0)=cnt+1 
					if(shlj.cnt.4>=(t-judgedelay)-de):break
				loop
			loop
		}
		filtertype=0
		if(anafilnum>0){
			repeat anafilnum-anafilfcnt,anafilfcnt
				if(anafil.cnt.2<=t+ttp+laserdelay0){
					filtertype=anafil.cnt.1
					anafilfcnt=cnt
				}else:break
			loop
		}
		filtertype2=0
		if(anafilnum>0){
			repeat anafilnum-anafilfcnt2,anafilfcnt2
				if(anafil.cnt.2<=t+ttp){
					filtertype2=anafil.cnt.1
					anafilfcnt2=cnt
				}else:break
			loop
		}
		if(filtertype!=filtertypep){
			ldelayresett=t
		}
		// アナログデバイスによる傾き処理
		ddim ro,2         // レーンの傾き
		sh=0
		analognow=-1,-1    // 理想カーソル位置として使用される値(判定調整に依存)
		panalognow=0,1000  // LASER音声エフェクトに使用される値(バッファリングによるエフェクトのタイミングずれを考慮したもの)
		panalognow2=-1,-1  // LASER音声エフェクトに使用される値(上のものをLASER非アクティブ時を-1にしたもの)
		canalognow=-1,-1   // 理想カーソル位置として使用される値(判定調整に非依存)
		canalognow2=-1,-1  // 理想カーソル位置として使用される値(上のものをLASER非アクティブ時を-1にしたもの)
		analogfuture=-1,-1 // 30ms後のanalognowの値(LASER判定の補正およびLASER音声エフェクトで理想値を鳴らすかどうかの判断に活用)
		dim prerofl,2
		repeat analognum-min(analogjfcnt.0,analogjfcnt.1),min(analogjfcnt.0,analogjfcnt.1)
			if((min(min(analog.cnt.6-(t+ttp2),analog.cnt.6-(t+ttp*adj)),analog.cnt.6-(t+ttp*adj-analogdelay))>0)&(analog.cnt.1>cnow+sttp*adj+bpba_2)):break
			if((t+ttp*adj+30>=analog.cnt.6)&(t-analogdelay+ttp*adj+30<analog.cnt.7)){
				analogfuture.(analog.cnt.0)=x20(analog.cnt.3)+(x20(analog.cnt.4)-x20(analog.cnt.3))*(analog.cnt.7-analog.cnt.6-(analog.cnt.7-(t+ttp*adj+30)))/(analog.cnt.7-analog.cnt.6)
			}
			if((analog.cnt.6<=t+ttp2)&(analog.cnt.7>t+ttp2)){
				if(analog.cnt.2<=bpba_32){
					panalognow.(analog.cnt.0)=x20(analog.cnt.4)*(analog.cnt.8=0)+1000*analog.cnt.0*(analog.cnt.8=1)
					if(analog.cnt.8=0):panalognow2.(analog.cnt.0)=panalognow.(analog.cnt.0)
				}else{
					panalognow.(analog.cnt.0)=x20(analog.cnt.3)+(x20(analog.cnt.4)-x20(analog.cnt.3))*(analog.cnt.7-analog.cnt.6-(analog.cnt.7-(t+ttp2)))/(analog.cnt.7-analog.cnt.6)
					panalognow2.(analog.cnt.0)=panalognow.(analog.cnt.0)
				}
			}
			if((analog.cnt.6<=t+ttp*adj)&(analog.cnt.7>t+ttp*adj)){
				if(analog.cnt.2<=bpba_32){
					if(analog.cnt.8=0){
						if(analog.cnt.0=0){
							ro.0+=double(analog.cnt.4)*20
						}else{
							ro.1-=double(abs(analog.cnt.4-50))*20
						}
					}
					canalognow.(analog.cnt.0)=x20(analog.cnt.4)
				}else{
					if(analog.cnt.0=0){
						ro.0+=double(analog.cnt.3)*20+double(analog.cnt.4-analog.cnt.3)*20*(analog.cnt.7-analog.cnt.6-(analog.cnt.7-(t-analogdelay+ttp-(t_tp)/2)))/(analog.cnt.7-analog.cnt.6)
					}else{
						ro.1-=double(abs(analog.cnt.3-50))*20+double(abs(analog.cnt.4-50)-abs(analog.cnt.3-50))*20*(analog.cnt.7-analog.cnt.6-(analog.cnt.7-(t-analogdelay+ttp-(t_tp)/2)))/(analog.cnt.7-analog.cnt.6)
					}
					canalognow.(analog.cnt.0)=x20(analog.cnt.3)+(x20(analog.cnt.4)-x20(analog.cnt.3))*(analog.cnt.7-analog.cnt.6-(analog.cnt.7-(t+ttp*adj)))/(analog.cnt.7-analog.cnt.6)
				}
			}else:if((analog.cnt.1<=cnow+sttp*adj+bpba_2)&(analog.cnt.1>cnow+sttp*adj)&(canalognow.(analog.cnt.0)=-1)&(prerofl.(analog.cnt.0)=0)){
				if(analog.cnt.0=0){
					ro.0+=double(analog.cnt.3)*20//*min((cnow+sttp*adj+bpba_2)-analog.cnt.1,bpba_4)/(bpba_4)
				}else{
					ro.1-=double(abs(analog.cnt.3-50))*20//*min((cnow+sttp*adj+bpba_2)-analog.cnt.1,bpba_4)/(bpba_4)
				}
				prerofl.(analog.cnt.0)=1
			}
			if((analog.cnt.6<=t+ttp*adj-analogdelay)&(analog.cnt.7>t+ttp*adj-analogdelay)){
				if(analog.cnt.2<=bpba_32){
					analognow.(analog.cnt.0)=x20(analog.cnt.4)
				}else{
					analognow.(analog.cnt.0)=x20(analog.cnt.3)+(x20(analog.cnt.4)-x20(analog.cnt.3))*(analog.cnt.7-analog.cnt.6-(analog.cnt.7-(t-analogdelay+ttp*adj)))/(analog.cnt.7-analog.cnt.6)
				}
			}
		loop
		canalognow2=canalognow.0,canalognow.1
		repeat 2
			if(canalognow.cnt=-1):canalognow.cnt=analognow.cnt
			if(canalognow.cnt=-1):canalognow.cnt=cnt*1000
		loop
		dim anaturnnextt,2
		anaturnnextt=-50000,-50000
		repeat 2
			cnt0=cnt
			repeat analogturnnum.cnt0-analogturnfcnt.cnt0,analogturnfcnt.cnt0
				if(analogturn.cnt0.cnt<t+ttp*adj-analogdelay):analogturnfcnt.cnt0=cnt:continue
				anaturnnextt.cnt0=analogturn.cnt0.cnt
				break
			loop
		loop
		if(t_tp<1):tp=t-1
		gsel 0
		repeat max(tiltnum-tiltfcnt-1,0),tiltfcnt+1
			if(tilt.cnt.2<=t+ttp*adj){
				if(tilt.cnt.1=7){
					ztilton=1
					continue
				}
				tiltpre=tiltnow
				tiltnow=tilt.cnt.1
				ddim romaxstat,3
				romaxstat.0=maxf(romax*(tiltnowp\3=0)+rotatemax*(tiltnowp\3=1)+rotatemax2*(tiltnowp\3=2),0.1)*(tiltnowp<6)
				romaxstat.1=maxf(romax*(tiltnow\3=0)+rotatemax*(tiltnow\3=1)+rotatemax2*(tiltnow\3=2),0.1)*(tiltnow<6)
				romaxstat.2=double(min(1000,int(800+200*rhsrate)))*romaxstat.1/1000
				tiltnowt=t
				tiltnowslidet=int(absf(tiltrnow-romaxstat.2)*20)
				tiltnowstart2=tilt.cnt.4
				tiltnowstart=double(tiltrnow)
				tiltfcnt=cnt
				ztilton=0
			}else:if(tilt.cnt.2>t+ttp*adj):break
		loop
		ddim romaxstat,3
		romaxstat.0=maxf(romax*(tiltnowp\3=0)+rotatemax*(tiltnowp\3=1)+rotatemax2*(tiltnowp\3=2),0.1)*(tiltnowp<6)
		romaxstat.1=maxf(romax*(tiltnow\3=0)+rotatemax*(tiltnow\3=1)+rotatemax2*(tiltnow\3=2),0.1)*(tiltnow<6)
		romaxstat.2=double(min(1000,int(800+200*rhsrate)))*romaxstat.1/1000
		tiltrnow=double(max(tiltnowslidet,16)-max(min(t-tiltnowt,max(tiltnowslidet,16)),0))*tiltnowstart/max(tiltnowslidet,16)+double(max(min(t-tiltnowt,max(tiltnowslidet,16)),0))*romaxstat.2/max(tiltnowslidet,16)
		ddim ror,1
		ror=double(sgn(ro.0+ro.1)*min(abs(ro.0+ro.1),int(800+200*rhsrate)))
		rotimed=2
		if((csongver!="")&(strmid(csongver,0,3)!="120")&(t-tiltnowt<150)&(ror=0)&(tiltnow<3)&((tiltpre>=3)|(tiltnow>tiltpre))):ror=double(sgn(tiltnowstart2)*min(abs(tiltnowstart2),int(800+200*rhsrate))):rotimed=3
		ddim rotime2,1
		rotime2=rotime*(0.15f+0.85f*minf(maxf(absf(double(ror)-double(rorp)),100.0f),400.0f)/400.0f)+25.0*(2*(abs(ro.0+ro.1)>=980)+7*(abs(ro.0+ro.1)<=20))
		rotime2*=2
		rotime2/=rotimed
		ror_p=ror

		// 傾きの値に向けて線形に推移
		speed=4.5f
		speed*=minf(absf(ror-rorp),100.0f)/100.0f // 目標の傾きに近い場合は減速する
		if(absf(ror)<1.0f){
			// 目標の傾きがゼロ(1/1000未満)の場合、遅くする
			speed/=5.0f
		}
		speed=maxf(speed,0.5f) // 速さが小さくなりすぎないように
		if(rorp<ror){
			ror=minf(rorp+double(t_tp)*speed,ror)
		}else{
			ror=maxf(rorp-double(t_tp)*speed,ror)
		}

		// 傾きキープ
		if((csongver="")|(csongver="120")|(csongver="120a")){
			if((tiltnow>=3)&(tiltnow<6)&((abs(ro.0+ro.1)<abs(rop.0+rop.1))|((abs(ro.0+ro.1)=abs(rop.0+rop.1))&(sgn(ro.0+ro.1)!=sgn(rop.0+rop.1))))):ror=rorp:ro=rop.0,rop.1
		}else:if(csongver="120b"){
			if((tiltnow>=3)&(tiltnow<6)&((abs(ro.0+ro.1)<abs(rop.0+rop.1))|((sgn(ro.0+ro.1)+sgn(rop.0+rop.1)=0)&(absf(rorp)>18.0)))):ror=rorp:ro=rop.0,rop.1
			if((t-tiltnowt<tiltnowslidet)&(tiltnow\3>tiltpre\3)&(ro.0+ro.1=0))&((abs(ro.0+ro.1)<=abs(rop.0+rop.1))):ror=rorp:ro=rop.0,rop.1
		}else{
			if((tiltnow>=3)&(tiltnow<6)&((abs(ro.0+ro.1)<abs(rop.0+rop.1))|((sgn(ro.0+ro.1)+sgn(rop.0+rop.1)=0)&(absf(rorp)>18.0)))):ror=rorp:ro=rop.0,rop.1
		}
		
		dim anaturnnextfl,2
		repeat 2
			anaturnnextfl.cnt=(((anaturnnextt.cnt-(t+ttp*adj-analogdelay))>180)|((anaturnnextt.cnt-(t+ttp*adj-analogdelay))<0))
		loop
		// アナログデバイス終了直後か判定
		repeat 2
			if((arstatp.(6+cnt).0=1)&(arstat.(6+cnt).0=0)){
				anaendt.cnt=t+150+200*((analoginput=2)|(analoginput=4))
				anadamage.cnt=0.0f
			}else:if((arstatp.(6+cnt).0=1)&(arstat.(6+cnt).0=1)){
				if(analoggr.(arstatp.(6+cnt).1)!=analoggr.(arstat.(6+cnt).1)){
					anaendt.cnt=t+150+200*((analoginput=2)|(analoginput=4))
					anadamage.cnt=0.0f
				}
			}
		loop
		// アナログデバイスの補正
		repeat 2
			if(anadirection.cnt!=anadirectionp.cnt){
				anaturnt.cnt=t
				analogokt.cnt+=20
			}
		loop
		repeat 2
			if(t-anaktp.cnt>100):anakdiff.cnt=0
			analogngcnt.cnt/=2
			if(analoganokcnt.cnt!=-1){
				if(((t-analoganokt.cnt<=18)&(analoggr.(arstat.(6+cnt).1)=analoggr.(analoganokcnt.cnt)))&(analoganokcnt.cnt!=arstat.(6+cnt).1)&(analog.(arstat.(6+cnt).1).2<=bpba_32)){
					analoganokcnt.cnt=-1
				}else:if(((t-analoganokt.cnt<=75)&(analoggr.(arstat.(6+cnt).1)=analoggr.(analoganokcnt.cnt)))):analogpos.cnt=analognow.cnt
			}
			if((t-analogngt.cnt<(t_tp)*3/5+20*(analoginput=0)+20*(analoginput=2))&(anakdiff.cnt<9)&(anaturnnextt.cnt0-(t+ttp*adj-analogdelay)>400+100*(analoginput=1)-200*(analog.(arstat.(6+cnt).1).8=0)-80*(analog.(arstat.(6+cnt).1).7-analog.(arstat.(6+cnt).1).6<=400))&((t>30+analoganokt.cnt)|(analoganokcnt.cnt=-1))){
				if(t-analogokt.cnt<40+10*(analoginput=1)):analogpos.cnt+=sgn(analognow.cnt-analogpos.cnt)*min(abs(analognow.cnt-analogpos.cnt)/4,(t_tp)*(40+10*(analoginput=1))/1000)
				analogngcnt.cnt+=1+((anaturnnextt.cnt0-(t+ttp*adj-analogdelay)>50)|(t\3=0))+(anadjp.cnt=1)*(2+(analoginput=0))
				analogokt.cnt-=100
				continue
			}
			if((analogokcnt.cnt!=-1)&(analogngcnt.cnt<7+(analoginput=0)*3)){
				if((analog.(arstat.(6+cnt).1).2<=bpba_32)&(analog.(analogokcnt.cnt).2>bpba_32)){
					analogokt.cnt=-10000
				}
				stat1=120+min(max(50-anaturnt.cnt,0),50)+25*(t-analogngt.cnt>75)*(analoginput=2)-30*(t-analogngt.cnt<25)*(analoginput=2)+60*(t-analogngt.cnt>60)*(analoginput=2)*(anaturnnextt.cnt0-(t+ttp*adj-analogdelay)<=50)*(anaturnnextt.cnt0-(t+ttp*adj-analogdelay)>0)+60*(analoginput=3)+60*(analoginput=4)+60*(analoginput=5)+(20*(analog.(analogokcnt.cnt).8=1)+40)*(anaturnnextt.cnt0-(t+ttp*adj-analogdelay)<=150)+20*(anaturnnextt.cnt0-(t+ttp*adj-analogdelay)<=180)+20*(t-analog.(analogokcnt.cnt).6<=20)+(85-25*(analoganokcnt.cnt!=arstat.(6+cnt).1))*(analoginput=1)-10*(anadirection.cnt!=anadirectionp.cnt)-3*(analogokcnt.cnt!=arstat.(6+cnt).1)+(analogfuture.cnt!=-1)*abs(analogfuture.cnt-analognow.cnt)/20-30*(analoganokcnt.cnt!=arstat.(6+cnt).1)
				if(stat1<15):stat1=15
				if(analogfuture.cnt=-1):stat1+=20
				if(anaturnnextt.cnt0-(t+ttp*adj-analogdelay)<180):stat1+=12+(t_tp)*2+stat1/8+((t_tp)/2+5)*(analog.(arstat.(6+cnt).1).8=1)
				if((((t-analogokt.cnt<stat1)&(analognow.cnt!=-1)&(arstat.(6+cnt).0=1)&(analoggr.(arstat.(6+cnt).1)=analoggr.(analogokcnt.cnt))))&(analog.(arstat.(6+cnt).1).2>bpba_32)){
					analogpos.cnt=analognow.cnt
					anadjp.cnt=1
				}
			}
		loop
		// アナログデバイスのカーソル移動
		if((analogmode=mode_on)&(((effratetype<=0)&(iscourse=0))|(gauge/1000>0))){
			// SLIDER入力など
			if((analoginput=4)|(analoginput=5)|(analoginput=3)|(analoginput=2)){
				dim stickstat,2
				repeat 2
					cnt0=cnt
					slider=0
					stat1=0
					if(analoginput=4){
						repeat length_joylist
							joyGetPosEx joystat2,joylist.cnt
							slider+=joystat2.(4+(cnt0^analogsw))
						loop
						stat1=slider-sliderp.cnt0
						if(abs(stat1)>32768):stat1-=sgn(stat1)*65536
						sliderp.cnt0=slider
						stat1=stat1*msen/400
						if(abs(stat1)<25){
							stickstat.cnt=0
						}else{
							stickstat.cnt=sgn(stat1)
						}
					}else:if(analoginput=5){
						repeat length_joylist
							joyGetPosEx joystat2,joylist.cnt
							slider+=joystat2.(2+(cnt0^analogsw))
						loop
						stat1=slider-sliderp.cnt0
						sliderp.cnt0=slider
						if(abs(stat1)>32768):stat1-=sgn(stat1)*65536
						stat1=stat1*msen/400
						if(abs(stat1)<25){
							stickstat.cnt=0
						}else{
							stickstat.cnt=sgn(stat1)
						}
					}else:if(analoginput=3){
						repeat length_joylist
							joyGetPosEx joystat2,joylist.cnt
							stat1+=joystat2.(2+(cnt0^analogsw)*2)-32768
						loop
						if(abs(stat1)<12000){
							stickstat.cnt=0
						}else{
							stickstat.cnt=sgn(stat1)
						}
						if(abs(stat1)<12000){
							stat1=0
						}else{
							stat1=min(int(double(sgn(stat1)*(abs(stat1)-12000))*max(t_tp,2)/16/300),18000*max(t_tp,2)/16/300)
						}
					}else{
						ddim dstat1,1
						if(cnt0=0^analogsw):dstat1=(ginfo_mx-defx)*2*(mx*2-1)
						if(cnt0=1^analogsw):dstat1=(ginfo_my-defy)*2*(my*2-1)
						stat1=int(round(dstat1*msen/10))
						stat2=int(round(dstat1*msen*2))
						if(abs(stat2)<10){
							stickstat.cnt=0
						}else{
							stickstat.cnt=sgn(stat2)
						}
					}
					if(enter_key=1):stat1=0
					if((arstat.(6+cnt0).0=1)&(analognow.cnt0!=-1)&(anadamage.cnt0<45.0f)){
						if((analog.(arstat.(6+cnt0).1).2>bpba_32)|(anastraight.cnt0=1)){
							if(analogprev.(arstat.(6+cnt0).1)<0){
								analogpos.cnt0=analognow.cnt0
							}else:if(((analog.(analogprev.(arstat.(6+cnt0).1)).2>bpba_32)&(abs(analogpos.cnt0-analognow.cnt0)<200))|(analog.(analogprev.(arstat.(6+cnt0).1)).3=analog.(analogprev.(arstat.(6+cnt0).1)).4)|(t-analog.(arstat.(6+cnt0).1).6>130)){
								analogpos.cnt0=analognow.cnt0
							}
						}
					}
					if((analognow.cnt0!=-1)&((analogpos.cnt0!=analognow.cnt0)|(anastraight.cnt0=0))):anadamage.cnt0=minf(anadamage.cnt0+double(t_tp)/(1.0f+0.2f*(analogpos.cnt0=analognow.cnt0)),150.0f)
					if((analognow.cnt0=-1)&(arstat.(6+cnt0).0=1)){
						if((analog.(arstat.(6+cnt0).1).6-t<800)&(abs(x20(analog.(arstat.(6+cnt0).1).3)-analogpos.cnt0)<100)){
							analogpos.cnt0=x20(analog.(arstat.(6+cnt0).1).3)
						}
					}
					if(anastraight.cnt0=1):anadamage.cnt0=maxf(anadamage.cnt0,20.0f)
					if(stat1!=0){
						cc2t=analog.(arstat.(6+cnt0).1).6
						cc2t2=-50000
						stat2=(sgn(stat1)+1)/2
						stat3=sgn(stat1)
						if(arstat.(6+cnt0).0=1){
							if(analogprev.(arstat.(6+cnt0).1)>=0):cc2t2=analog.(analogprev.(arstat.(6+cnt0).1)).7
							if((analognow.cnt0!=-1)&((anadirection.cnt0=stat2)|(anastraight.cnt0=1))&(sgn(analogpos.cnt0+stat1*6-analognow.cnt0)=stat3)&(sgn(analogpos.cnt0-analognow.cnt0-stat3*50)!=stat3)){
								analogpos.cnt0=analognow.cnt0
								anadamage.cnt0=double(maxf(anadamage.cnt0-double(t_tp)*2,-45.0f))
							}else{
								if((analognow.cnt0=-1)&(cc2t-t<800)&(abs(x20(analog.(arstat.(6+cnt0).1).3)-analogpos.cnt0)<100)){
									analogpos.cnt0=x20(analog.(arstat.(6+cnt0).1).3)
								}else:if(t-cc2t2>200){
									analogpos.cnt0+=stat1
									if((analognow.cnt0!=-1)&(sgn(analogpos.cnt0+stat1*6-analognow.cnt0)!=stat3)):anadamage.cnt0=minf(anadamage.cnt0+double(t_tp)/(1.0f+0.2f*(analogpos.cnt0=analognow.cnt0)),150.0f)
								}
							}
						}
						repeat analoganjnum-analoganjfcnt,analoganjfcnt
							if(analog.(analoganj.cnt.1).6-(t-analogdelay)-ttp>100):break
							if((analoganj.cnt.0!=cnt0)|(analoganj.cnt.2!=0)):continue
							if((analoganj.cnt.0=cnt0)&(abs(analog.(analoganj.cnt.1).6-(t-analogdelay)-ttp)<=60)&(sgn(analog.(analoganj.cnt.1).4-analog.(analoganj.cnt.1).3)=stat3)&((analogpos.(analog.(analoganj.cnt.1).0)-(analog.(analoganj.cnt.1).4*20+50*stat3))*stat3<=0)&(analoganj.cnt.2=0)){
								analoganjdamage.cnt+=max(t_tp,1)
								if(analoganjdamage.cnt>=10){
									analoganj.cnt.2=1
									chainnow++:chainnow_song++
									critical++
									analogscore++
									if(chainnow>chainmax):chainmax=chainnow
									if(chainnow_song>chainmax_song):chainmax_song=chainnow_song
									if(chainnow\100=0):chainefft=t
									chainvt=t
									ngauge+=200*analoganj.cnt.5
									if(ngauge>gaugemax):ngauge=gaugemax
									addgauge 4*analoganj.cnt.5,0
									analogefft.cnt0.(analogefftnum.cnt0).0=max(t,analog.(analoganj.cnt.1).6)
									analogefft.cnt0.(analogefftnum.cnt0).1=analog.(analoganj.cnt.1).4*20
									analogefftnum.cnt0++
									analoganokt.cnt0=analog.(analoganj.cnt.1).6+60
									analoganokcnt.cnt0=analoganj.cnt.1
									spincheck analoganj.cnt.1
								}
							}
							if((analoganj.cnt.0=cnt0)&(analog.(analoganj.cnt.1).6-(t-analogdelay)-ttp<=100)&(sgn(analog.(analoganj.cnt.1).4-analog.(analoganj.cnt.1).3)!=stat3)&((analogpos.(analog.(analoganj.cnt.1).0)-(analog.(analoganj.cnt.1).4*20+50*stat3))*stat3<=0)&(analoganj.cnt.2=0)){
								analoganjdamage.cnt=max(analoganjdamage.cnt-(t_tp),0)
							}
							break
						loop
					}
				loop
				if((analoginput=2)&(ts3>30)){
					if(hidem=1):mouse -1,-1
					mouse defx,defy
				}
			}
			// キーボード
			if(analoginput=0){
				cc2t=analog.(arstat.6.1).6
				if((keystator.6=1)&((keystator.7=0)|(keystatorp.6=0))){
					cnt0=0
					if((analognow.0=-1)&((cc2t-t>200)|(abs(analogpos.cnt0-x20(analog.(arstat.(6+cnt0).1).3))>50))){
						if((t-anastartt.0>100)&(t-anaendt.0>0)&(t-analoganokt.0>30)):analogpos.0-=(t_tp)*1350/1000
					}else:if(analognow.0=-1){
						//analogpos.0-=(t_tp)*300/1000
					}else:if((arstat.6.0=1)&(analognow.0=analogpos.0)){
						if((anastraight.0=0)&((t>30+analoganokt.0)|(analoganokcnt.0=-1))){
							if((analogokt.0>(t_tp)*7)&(t-anaturnt.cnt0>100)&(anaturnnextfl.0=1)&(anadirection.0=1)){
								analogokt.0-=(t_tp)*7
								analogngt.0=t-(anaturnnextt.cnt0-(t+ttp*adj-analogdelay)<=30)*20
							}
							if(((anadirection.0=1)|(anastraight.cnt0=1))&((t>30+analoganokt.0)|(analoganokcnt.0=-1))){
								analogpos.0-=(t_tp)*600/1000/(1+(anaturnnextt.cnt0-(t+ttp*adj-analogdelay)<=30))
							}
						}
					}else:if((arstat.6.0=1)&(analognow.0<analogpos.0)){
						analogpos.0=analognow.0:analogokt.0=t:analogokcnt.0=arstat.6.1
						anadjp.cnt=1
					}else:if((abs(analogpos.0-analognow.0)>50)&((t>30+analoganokt.0)|(analoganokcnt.0=-1))){
						analogpos.0-=(t_tp)*1350/1000
					}else:if((abs(analogpos.0-analognow.0)>10)&((t>30+analoganokt.0)|(analoganokcnt.0=-1))){
						analogpos.0-=(t_tp)*400/1000
					}
					repeat analoganjnum-analoganjfcnt,analoganjfcnt
						if(analog.(analoganj.cnt.1).6-(t-analogdelay)-ttp>100):break
						if((analoganj.cnt.0=0)&(abs(analog.(analoganj.cnt.1).6-(t-analogdelay)-ttp)<=60)&(analog.(analoganj.cnt.1).4<analog.(analoganj.cnt.1).3)&(analog.(analoganj.cnt.1).4*20-50<=analogpos.(analog.(analoganj.cnt.1).0))/*&((arstat.6.1=analoganj.cnt.1)|(analog.(arstat.6.1).2>bpba_32))*/&(analoganj.cnt.2=0)){
							analoganj.cnt.2=1
							chainnow++:chainnow_song++
							critical++
							analogscore++
							if(chainnow>chainmax):chainmax=chainnow
							if(chainnow_song>chainmax_song):chainmax_song=chainnow_song
							if(chainnow\100=0):chainefft=t
							chainvt=t
							ngauge+=200*analoganj.cnt.5
							if(ngauge>gaugemax):ngauge=gaugemax
							addgauge 4*analoganj.cnt.5,0
							analogefft.(analoganj.cnt.0).(analogefftnum.(analoganj.cnt.0)).0=max(t,analog.(analoganj.cnt.1).6)
							analogefft.(analoganj.cnt.0).(analogefftnum.(analoganj.cnt.0)).1=analog.(analoganj.cnt.1).4*20
							analogefftnum.(analoganj.cnt.0)++
							analoganokt.0=analog.(analoganj.cnt.1).6+60
							analoganokcnt.0=analoganj.cnt.1
							spincheck analoganj.cnt.1
						}
					loop
				}
				if((keystator.7=1)&((keystator.6=0)|(keystatorp.7=0))){
					cnt0=0
					if((analognow.0=-1)&((cc2t-t>200)|(abs(analogpos.cnt0-x20(analog.(arstat.(6+cnt0).1).3))>50))){
						if((t-anastartt.0>100)&(t-anaendt.0>0)):analogpos.0+=(t_tp)*1350/1000
					}else:if(analognow.0=-1){
						//analogpos.0+=(t_tp)*300/1000
					}else:if((arstat.6.0=1)&(analognow.0=analogpos.0)){
						if((anastraight.0=0)&((t>30+analoganokt.0)|(analoganokcnt.0=-1))){
							if((analogokt.0>(t_tp)*7)&(t-anaturnt.cnt0>100)&(anaturnnextfl.0=1)&(anadirection.0=0)){
								analogokt.0-=(t_tp)*7
								analogngt.0=t-(anaturnnextt.cnt0-(t+ttp*adj-analogdelay)<=30)*20
							}
							if(((anadirection.0=0)|(anastraight.cnt0=1))&((t>30+analoganokt.0)|(analoganokcnt.0=-1))){
								analogpos.0+=(t_tp)*600/1000/(1+(anaturnnextt.cnt0-(t+ttp*adj-analogdelay)<=30))
							}
						}
					}else:if((arstat.6.0=1)&(analognow.0>analogpos.0)){
						analogpos.0=analognow.0:analogokt.0=t:analogokcnt.0=arstat.6.1
						anadjp.cnt=1
					}else:if((abs(analogpos.0-analognow.0)>50)&((t>30+analoganokt.0)|(analoganokcnt.0=-1))){
						analogpos.0+=(t_tp)*1350/1000
					}else:if((abs(analogpos.0-analognow.0)>10)&((t>30+analoganokt.0)|(analoganokcnt.0=-1))){
						analogpos.0+=(t_tp)*400/1000
					}
					repeat analoganjnum-analoganjfcnt,analoganjfcnt
						if(analog.(analoganj.cnt.1).6-(t-analogdelay)-ttp>100):break
						if((analoganj.cnt.0=0)&(abs(analog.(analoganj.cnt.1).6-(t-analogdelay)-ttp)<=60)&(analog.(analoganj.cnt.1).4>analog.(analoganj.cnt.1).3)&(analog.(analoganj.cnt.1).4*20+50>=analogpos.(analog.(analoganj.cnt.1).0))/*&((arstat.6.1=analoganj.cnt.1)|(analog.(arstat.6.1).2>bpba_32))*/&(analoganj.cnt.2=0)){
							analoganj.cnt.2=1
							chainnow++:chainnow_song++
							critical++
							analogscore++
							if(chainnow>chainmax):chainmax=chainnow
							if(chainnow_song>chainmax_song):chainmax_song=chainnow_song
							if(chainnow\100=0):chainefft=t
							chainvt=t
							ngauge+=200*analoganj.cnt.5
							if(ngauge>gaugemax):ngauge=gaugemax
							addgauge 4*analoganj.cnt.5,0
							analogefft.(analoganj.cnt.0).(analogefftnum.(analoganj.cnt.0)).0=max(t,analog.(analoganj.cnt.1).6)
							analogefft.(analoganj.cnt.0).(analogefftnum.(analoganj.cnt.0)).1=analog.(analoganj.cnt.1).4*20
							analogefftnum.(analoganj.cnt.0)++
							analoganokt.0=analog.(analoganj.cnt.1).6+60
							analoganokcnt.0=analoganj.cnt.1
							spincheck analoganj.cnt.1
						}
					loop
				}
				cc2t=analog.(arstat.7.1).6
				if((keystator.8=1)&((keystator.9=0)|(keystatorp.8=0))){
					cnt0=1
					if((analognow.1=-1)&((cc2t-t>200)|(abs(analogpos.cnt0-x20(analog.(arstat.(6+cnt0).1).3))>50))){
						if((t-anastartt.1>100)&(t-anaendt.1>0)):analogpos.1-=(t_tp)*1350/1000
					}else:if(analognow.1=-1){
						//analogpos.1-=(t_tp)*300/1000
					}else:if((arstat.7.0=1)&(analognow.1=analogpos.1)){
						if((anastraight.1=0)&((t>30+analoganokt.1)|(analoganokcnt.1=-1))){
							if((analogokt.1>(t_tp)*7)&(t-anaturnt.cnt0>100)&(anaturnnextfl.1=1)&(anadirection.1=1)){
								analogokt.1-=(t_tp)*7
								analogngt.1=t-(anaturnnextt.cnt0-(t+ttp*adj-analogdelay)<=30)*20
							}
							if(((anadirection.1=1)|(anastraight.cnt0=1))&((t>30+analoganokt.1)|(analoganokcnt.1=-1))){
								analogpos.1-=(t_tp)*600/1000/(1+(anaturnnextt.cnt0-(t+ttp*adj-analogdelay)<=30))
							}
						}
					}else:if((arstat.7.0=1)&(analognow.1<analogpos.1)){
						analogpos.1=analognow.1:analogokt.1=t:analogokcnt.1=arstat.7.1
						anadjp.cnt=1
					}else:if((abs(analogpos.1-analognow.1)>50)&((t>30+analoganokt.1)|(analoganokcnt.1=-1))){
						analogpos.1-=(t_tp)*1350/1000
					}else:if((abs(analogpos.1-analognow.1)>10)&((t>30+analoganokt.1)|(analoganokcnt.1=-1))){
						analogpos.1-=(t_tp)*400/1000
					}
					repeat analoganjnum-analoganjfcnt,analoganjfcnt
						if(analog.(analoganj.cnt.1).6-(t-analogdelay)-ttp>100):break
						if((analoganj.cnt.0=1)&(abs(analog.(analoganj.cnt.1).6-(t-analogdelay)-ttp)<=60)&(analog.(analoganj.cnt.1).4<analog.(analoganj.cnt.1).3)&(analog.(analoganj.cnt.1).4*20-50<=analogpos.(analog.(analoganj.cnt.1).0))/*&((arstat.7.1=analoganj.cnt.1)|(analog.(arstat.7.1).2>bpba_32))*/&(analoganj.cnt.2=0)){
							analoganj.cnt.2=1
							chainnow++:chainnow_song++
							critical++
							analogscore++
							if(chainnow>chainmax):chainmax=chainnow
							if(chainnow_song>chainmax_song):chainmax_song=chainnow_song
							if(chainnow\100=0):chainefft=t
							chainvt=t
							ngauge+=200*analoganj.cnt.5
							if(ngauge>gaugemax):ngauge=gaugemax
							addgauge 4*analoganj.cnt.5,0
							analogefft.(analoganj.cnt.0).(analogefftnum.(analoganj.cnt.0)).0=max(t,analog.(analoganj.cnt.1).6)
							analogefft.(analoganj.cnt.0).(analogefftnum.(analoganj.cnt.0)).1=analog.(analoganj.cnt.1).4*20
							analogefftnum.(analoganj.cnt.0)++
							analoganokt.1=analog.(analoganj.cnt.1).6+60
							analoganokcnt.1=analoganj.cnt.1
							spincheck analoganj.cnt.1
						}
					loop
				}
				if((keystator.9=1)&((keystator.8=0)|(keystatorp.9=0))){
					cnt0=1
					if((analognow.1=-1)&((cc2t-t>200)|(abs(analogpos.cnt0-x20(analog.(arstat.(6+cnt0).1).3))>50))){
						if((t-anastartt.1>100)&(t-anaendt.1>0)):analogpos.1+=(t_tp)*1350/1000
					}else:if(analognow.1=-1){
						//analogpos.1+=(t_tp)*300/1000
					}else:if((arstat.7.0=1)&(analognow.1=analogpos.1)){
						if((anastraight.1=0)&((t>30+analoganokt.1)|(analoganokcnt.1=-1))){
							if((analogokt.1>(t_tp)*7)&(t-anaturnt.cnt0>100)&(anaturnnextfl.1=1)&(anadirection.1=0)){
								analogokt.1-=(t_tp)*7
								analogngt.1=t-(anaturnnextt.cnt0-(t+ttp*adj-analogdelay)<=30)*20
							}
							if(((anadirection.1=0)|(anastraight.cnt0=1))&((t>30+analoganokt.1)|(analoganokcnt.1=-1))){
								analogpos.1+=(t_tp)*600/1000/(1+(anaturnnextt.cnt0-(t+ttp*adj-analogdelay)<=30))
							}
						}
					}else:if((arstat.7.0=1)&(analognow.1>analogpos.1)){
						analogpos.1=analognow.1:analogokt.1=t:analogokcnt.1=arstat.7.1
						anadjp.cnt=1
					}else:if((abs(analogpos.1-analognow.1)>50)&((t>30+analoganokt.1)|(analoganokcnt.1=-1))){
						analogpos.1+=(t_tp)*1350/1000
					}else:if((abs(analogpos.1-analognow.1)>10)&((t>30+analoganokt.1)|(analoganokcnt.1=-1))){
						analogpos.1+=(t_tp)*400/1000
					}
					repeat analoganjnum-analoganjfcnt,analoganjfcnt
						if(analog.(analoganj.cnt.1).6-(t-analogdelay)-ttp>100):break
						if((analoganj.cnt.0=1)&(abs(analog.(analoganj.cnt.1).6-(t-analogdelay)-ttp)<=60)&(analog.(analoganj.cnt.1).4>analog.(analoganj.cnt.1).3)&(analog.(analoganj.cnt.1).4*20+50>=analogpos.(analog.(analoganj.cnt.1).0))/*&((arstat.7.1=analoganj.cnt.1)|(analog.(arstat.7.1).2>bpba_32))*/&(analoganj.cnt.2=0)){
							analoganj.cnt.2=1
							chainnow++:chainnow_song++
							critical++
							analogscore++
							if(chainnow>chainmax):chainmax=chainnow
							if(chainnow_song>chainmax_song):chainmax_song=chainnow_song
							if(chainnow\100=0):chainefft=t
							chainvt=t
							ngauge+=200*analoganj.cnt.5
							if(ngauge>gaugemax):ngauge=gaugemax
							addgauge 4*analoganj.cnt.5,0
							analogefft.(analoganj.cnt.0).(analogefftnum.(analoganj.cnt.0)).0=max(t,analog.(analoganj.cnt.1).6)
							analogefft.(analoganj.cnt.0).(analogefftnum.(analoganj.cnt.0)).1=analog.(analoganj.cnt.1).4*20
							analogefftnum.(analoganj.cnt.0)++
							analoganokt.1=analog.(analoganj.cnt.1).6+60
							analoganokcnt.1=analoganj.cnt.1
							spincheck analoganj.cnt.1
						}
					loop
				}
			}
			repeat 2
				if(analogpos.cnt<0):analogpos.cnt=0
				if(analogpos.cnt>1000):analogpos.cnt=1000
				if((arstat.(cnt+6).0=0)|(((arstatp.(cnt+6).0!=arstat.(cnt+6).0)|(arstatp.(cnt+6).1!=arstat.(cnt+6).1))&(arstat.(cnt+6).2=1))){
					analogpos.cnt=cnt*1000
					anastartt.cnt=t
					if(arstat.(cnt+6).0=1){
						analogpos.cnt=x20(analog.(arstat.(cnt+6).1).3)
					}
				}
				if((analognow.cnt!=-1)&(analog.(arstat.(cnt+6).1).5=1)&((keystator.(7+cnt)=1)|(keystatorp.(7+cnt)=1))&(analognowp.cnt=-1)&(abs(analogpos.cnt-analognow.cnt)<100)):analogpos.cnt=analognow.cnt
			loop
		}else{
			repeat 2
				if((analognow.cnt=-1)|((arstatp.(cnt+6).1!=arstat.(cnt+6).1)&(arstat.(cnt+6).2=1))){
					analogpos.cnt=cnt*1000
					anastartt.cnt=t
					if(arstat.(cnt+6).0=1){
						analogpos.cnt=x20(analog.(arstat.(cnt+6).1).3)
					}
				}else:analogpos.cnt=analognow.cnt
			loop
		}
		repeat analoganjnum-analoganjfcnt,analoganjfcnt
			if(analog.(analoganj.cnt.1).6>t+(t_tp)/2+30):break
			if((analog.(analoganj.cnt.1).6<=t+(t_tp)/2+30)&(analoganj.cnt.2=0)&(analogmode=mode_auto)){
				analoganj.cnt.2=1
				chainnow++:chainnow_song++
				critical++
				analogscore++
				if(chainnow>chainmax):chainmax=chainnow
				if(chainnow_song>chainmax_song):chainmax_song=chainnow_song
				if(chainnow\100=0):chainefft=t
				chainvt=t
				ngauge+=200*analoganj.cnt.5
				if(ngauge>gaugemax):ngauge=gaugemax
				addgauge 4*analoganj.cnt.5,0
				analogefft.(analoganj.cnt.0).(analogefftnum.(analoganj.cnt.0)).0=max(t,analog.(analoganj.cnt.1).6)
				analogefft.(analoganj.cnt.0).(analogefftnum.(analoganj.cnt.0)).1=analog.(analoganj.cnt.1).4*20
				analogefftnum.(analoganj.cnt.0)++
				spincheck analoganj.cnt.1
				analoganjfcnt=cnt
			}else:if((analog.(analoganj.cnt.1).6-(t-analogdelay)-ttp<=-100)&(analoganj.cnt.2=0)&(analogmode!=mode_auto)){
				analoganj.cnt.2=-1
				chainnow=0:chainnow_song=0
				errorn++
				ngauge-=gaugemax*2/100*(10+(analoganj.cnt.5-1)*5)/10
				if(ngauge<0):ngauge=0
				subgauge 4.0f*(1.0f+double(analoganj.cnt.5-1)/2)
				noerror=0
				noerror_song=0
				analoganjfcnt=cnt
			}
		loop
		dim af,2
		dim adjstat,2
		repeat 2
			adjstat.cnt=(t_tp)*8-10*(analoginput=1)-30*(analogokcnt.cnt!=arstat.(6+cnt).1)+(analogfuture.cnt!=-1)*abs(analogfuture.cnt-analognow.cnt)/20+10
			if(adjstat.cnt<20):adjstat.cnt=20
			if(analognowp.cnt!=-1):adjstat=adjstat*4/5
		loop
		if(((effratetype<=0)&(iscourse=0))|(gauge/1000>0)){
			repeat analogjnum-min(analogjfcnt2.0,analogjfcnt2.1),min(analogjfcnt2.0,analogjfcnt2.1)
				if((analogj.cnt.4<t+ttp*adj-analogdelay)&(analogj.cnt.2=0)){
					if((((abs(analogpos.(analogj.cnt.0)-analognow.(analogj.cnt.0))<100+abs(analognow.(analogj.cnt.0)-analogfuture.(analogj.cnt.0))/24*(analogfuture.(analogj.cnt.0)!=-1))|(t-analoganokt.(analogj.cnt.0)<=50))&(analognow.(analogj.cnt.0)!=-1))|(analogmode=mode_auto)){
						analogj.cnt.2=1
						chainnow++:chainnow_song++
						critical++
						analogscore++
						if(chainnow>chainmax):chainmax=chainnow
						if(chainnow_song>chainmax_song):chainmax_song=chainnow_song
						if(chainnow\100=0):chainefft=t
						chainvt=t
						ngauge+=50*analogj.cnt.3
						if(ngauge>gaugemax):ngauge=gaugemax
						addgauge analogj.cnt.3,0
					}else{
						if((((analognowp.(analogj.cnt.0)!=-1)&(abs(analogposp.(analogj.cnt.0)-analognowp.(analogj.cnt.0)))<100+abs(analognow.(analogj.cnt.0)-analogfuture.(analogj.cnt.0))/24*(analogfuture.(analogj.cnt.0)!=-1)))|((analognow.(analogj.cnt.0)=-1)&(t-analogokt.(analogj.cnt.0)<adjstat.(analogj.cnt.0)))|((t-analoganokt.(analogj.cnt.0)<80))){
							analogj.cnt.2=1
							chainnow++:chainnow_song++
							critical++
							analogscore++
							if(chainnow>chainmax):chainmax=chainnow
							if(chainnow_song>chainmax_song):chainmax_song=chainnow_song
							if(chainnow\100=0):chainefft=t
							chainvt=t
							ngauge+=50*analogj.cnt.3
							if(ngauge>gaugemax):ngauge=gaugemax
							addgauge analogj.cnt.3,0
						}else{
							analogj.cnt.2=-1
							chainnow=0:chainnow_song=0
							errorn++
							ngauge-=gaugemax/200*(10+(analogj.cnt.3-1)*5)/10
							if(ngauge<0):ngauge=0
							subgauge 1.0f+double(analogj.cnt.3-1)/2
							noerror=0
							noerror_song=0
						}
					}
					analogjfcnt2.(analogj.cnt.0)=cnt
				}
				if(analogj.cnt.4-(t-analogdelay)-ttp*adj>bpba):af.(analogj.cnt.0)=1
				if(af.0+af.1=2):break
			loop
		}
		if((ginfo2()=0)&(((effratetype<=0)&(iscourse=0))|(gauge/1000>0))){
			gosub *refreshhs
			if(hstypenow=0){
				stat2=bpm*hsr/10
			}else:if(hstypenow=1){
				stat2=hso*bpm/oftbpm
			}else:if(hstypenow=2){
				stat2=hsc
			}else:if(hstypenow=3){
				stat2=hsm*bpm/maxbpm
			}else:if(hstypenow=4){
				stat2=hsa*bpm/avebpm
			}
			getkey ctrl_key,17
			getkey_a stat1,38
			getkey stat2,key.(7+2*analogsw)
			getkey stat3,key.(9-2*analogsw)
			stat1=stat1|((stat2|stat3)&(enter_key=1))
			getkey stat2,key2.(7+2*analogsw)
			getkey stat3,key2.(9-2*analogsw)
			stat1=stat1|((stat2|stat3|getjoykeystat(7+2*analogsw)|getjoykeystat(9-2*analogsw)|(stickstat.0>0)|(stickstat.1>0))&(enter_key=1))
			if((stat1=1)&(ts2>60)&(ctrl_key=0)){
				if((hstypenow=0)&(hsr<99)){
					hsr++
				}else:if((hstypenow=1)&(hso<2000)){
					hso+=25
				}else:if((hstypenow=2)&(hsc<2000)){
					hsc+=25
				}else:if((hstypenow=3)&(hsm<2000)){
					hsm+=25
				}else:if((hstypenow=4)&(hsa<2000)){
					hsa+=25
				}
				minforefresh=1
			}
			getkey_a stat1,40
			getkey stat2,key.(6+2*analogsw)
			getkey stat3,key.(8-2*analogsw)
			stat1=stat1|((stat2|stat3)&(enter_key=1))
			getkey stat2,key2.(6+2*analogsw)
			getkey stat3,key2.(8-2*analogsw)
			stat1=stat1|((stat2|stat3|getjoykeystat(6+2*analogsw)|getjoykeystat(8-2*analogsw)|(stickstat.0<0)|(stickstat.1<0))&(enter_key=1))
			if((stat1=1)&(ts2>60)&(ctrl_key=0)){
				if((hstypenow=0)&(hsr>5)){
					hsr--
				}else:if((hstypenow=1)&(hso>25)){
					hso-=25
				}else:if((hstypenow=2)&(hsc>25)){
					hsc-=25
				}else:if((hstypenow=3)&(hsm>25)){
					hsm-=25
				}else:if((hstypenow=4)&(hsa>25)){
					hsa-=25
				}
				minforefresh=1
			}
			getkey stat1,37
			getkey stat2,key.4
			stat1=stat1|(stat2&(enter_key=1))
			getkey stat2,key2.4
			stat1=stat1|((stat2|getjoykeystat(4))&(enter_key=1))
			if((stat1=1)&(ts>120)&(ctrl_key=0)){
				gosub *refreshhs
				if(hstypenow=0){
					stat2=bpm*hsr/10
				}else:if(hstypenow=1){
					stat2=int(double(hso)*bpm/oftbpm*1000)
				}else:if(hstypenow=2){
					stat2=hsc*1000
				}else:if(hstypenow=3){
					stat2=int(double(hsm)*bpm/maxbpm*1000)
				}else:if(hstypenow=4){
					stat2=int(double(hsa)*bpm/avebpm*1000)
				}
				hsr=10
				hsc=-1
				hsm=-1
				hsa=-1
				hso=-1
				repeat 5
					hstypenow--
					if(hstypenow<0):hstypenow=4
					if(vhstype.hstypenow=1):break
				loop
				if(hstypenow=0){
					hsr=max(min(int(round(double(stat2)/bpm*10)),99),5)
				}else:if(hstypenow=1){
					hso=ran(int(round(double(stat2)*oftbpm/bpm/25/1000))*25,25,2000)
				}else:if(hstypenow=2){
					hsc=ran(int(round(double(stat2)/25/1000))*25,25,2000)
				}else:if(hstypenow=3){
					hsm=ran(int(round(double(stat2)*maxbpm/bpm/25/1000))*25,25,2000)
				}else:if(hstypenow=4){
					hsa=ran(int(round(double(stat2)*avebpm/bpm/25/1000))*25,25,2000)
				}
				minforefresh=1
			}
			getkey_a stat1,39
			getkey stat2,key.5
			stat1=stat1|(stat2&(enter_key=1))
			getkey stat2,key2.5
			stat1=stat1|((stat2|getjoykeystat(5))&(enter_key=1))
			if((stat1=1)&(ts>120)&(ctrl_key=0)){
				gosub *refreshhs
				if(hstypenow=0){
					stat2=bpm*hsr/10
				}else:if(hstypenow=1){
					stat2=int(double(hso)*bpm/oftbpm*1000)
				}else:if(hstypenow=2){
					stat2=hsc*1000
				}else:if(hstypenow=3){
					stat2=int(double(hsm)*bpm/maxbpm*1000)
				}else:if(hstypenow=4){
					stat2=int(double(hsa)*bpm/avebpm*1000)
				}
				hsr=10
				hsc=-1
				hsm=-1
				hsa=-1
				hso=-1
				repeat 5
					hstypenow++
					if(hstypenow>4):hstypenow=0
					if(vhstype.hstypenow=1):break
				loop
				if(hstypenow=0){
					hsr=max(min(int(round(double(stat2)/bpm*10)),99),5)
				}else:if(hstypenow=1){
					hso=ran(int(round(double(stat2)*oftbpm/bpm/25/1000))*25,25,2000)
				}else:if(hstypenow=2){
					hsc=ran(int(round(double(stat2)/25/1000))*25,25,2000)
				}else:if(hstypenow=3){
					hsm=ran(int(round(double(stat2)*maxbpm/bpm/25/1000))*25,25,2000)
				}else:if(hstypenow=4){
					hsa=ran(int(round(double(stat2)*avebpm/bpm/25/1000))*25,25,2000)
				}
				minforefresh=1
			}
		}
		gosub *refreshhs
		if(hstypenow=0){
			hs=108*hsr/10/2
		}else:if(hstypenow=1){
			hs=108*hso*1000/oftbpm/2
		}else:if(hstypenow=2){
			no_hstype_c=0
			hs=108/2
		}else:if(hstypenow=3){
			hs=108*hsm*1000/maxbpm/2
		}else{
			hs=108*hsa*1000/avebpm/2
		}
		if(hs<1):hs=1

		// ずれがある場合は補正
		stat1=BASS_ChannelGetPosition_ms(mid.0)
		repeat max(length(mid)-1,0),1
			stat2=BASS_ChannelGetPosition_ms(mid.cnt)
			if(abs(stat1-stat2)>100){
				tadj=2
			}
		loop

		// 直角音の再生
		analoganflag=0
		canvol=0
		if(anvolnum>0){
			repeat anvolnum-anvolfcnt,anvolfcnt
				if(anvol.cnt.2<=t+30){
					canvol=anvol.cnt.1
					anvolfcnt=cnt
				}else:break
			loop
		}
		repeat analoganjnum-max(min(chokkakup.0,chokkakup.1),0),max(min(chokkakup.0,chokkakup.1),0)
			if((analog.(analoganj.cnt.1).2<=bpba_32)&(((auto_chokkaku_se=0)&&(analoganj.cnt.2=1))|(analogmode=mode_auto)|(auto_chokkaku_se!=0))){
				if((analog.(analoganj.cnt.1).6>=t-500)&(chokkakup.(analoganj.cnt.0)<cnt)){
					if(analog.(analoganj.cnt.1).6<=t+30){
						stat1=min(abs(analog.(analoganj.cnt.1).3-analog.(analoganj.cnt.1).4)*(1+(anagrran.(analog.(analoganj.cnt.1).0).(analoggr.(analoganj.cnt.1))=2)),25)
						if(disableautoanvol=1):stat1=25
						if(cnt+1<analoganjnum){
							if((chokkakup.(1-analoganj.cnt.0)<cnt+1)&(analog.(analoganj.cnt.1).1=analog.(analoganj.(cnt+1).1).1)&(analog.(analoganj.cnt.1).0!=analog.(analoganj.(cnt+1).1).0)){
								chokkakup.(1-analoganj.cnt.0)=cnt+1
								if(abs(analog.(analoganj.(cnt+1).1).3-analog.(analoganj.(cnt+1).1).4)>stat1):stat1=min(abs(analog.(analoganj.(cnt+1).1).3-analog.(analoganj.(cnt+1).1).4),25)
							}
						}
						if(cnt-1>=0){
							if((chokkakup.(1-analoganj.cnt.0)<cnt-1)&(analog.(analoganj.cnt.1).1=analog.(analoganj.(cnt-1).1).1)&(analog.(analoganj.cnt.1).0!=analog.(analoganj.(cnt-1).1).0)){
								chokkakup.(1-analoganj.cnt.0)=cnt-1
								if(abs(analog.(analoganj.(cnt-1).1).3-analog.(analoganj.(cnt-1).1).4)>stat1):stat1=min(abs(analog.(analoganj.(cnt-1).1).3-analog.(analoganj.(cnt-1).1).4),25)
							}
						}
						stat2=BASS_SampleGetChannel(chokkakuid.(analoganj.cnt.4),0)
						BASS_ChannelSetAttribute stat2,2,double(canvol)/100*stat1/25*mastervol/100*dirvol/100
						BASS_ChannelPlay stat2
						analoganflag=1
						chokkakup.(analoganj.cnt.0)=cnt
						chocnt++
						if(chocnt=50):chocnt=0
						if(analog.(analoganj.cnt.1).9>=-1){
							shaket=tp
							shakewidth=50*sgn(analog.(analoganj.cnt.1).4-analog.(analoganj.cnt.1).3)
						}
					}else{
						break
					}
				}
			}
		loop
		// ノートSEの再生
		repeat notesejnum-notesejfcnt,notesejfcnt
			if(note.(notesej.cnt.0).3<t-1000){
				notesejfcnt=cnt
			}else:if(note.(notesej.cnt.0).3>t+1000){
				break
			}
			if((note.(notesej.cnt.0).2=0)&(notesej.cnt.1!=2)&(((auto_note_se=0)&&(notesej.cnt.1=1))|(((note.(notesej.cnt.0).0<4)&(shortmode=mode_auto))|((note.(notesej.cnt.0).0>=4)&(longmode=mode_auto)))|(auto_note_se!=0))){
				if(note.(notesej.cnt.0).3>=t-500){
					if(note.(notesej.cnt.0).3<=t+30){
						stat2=BASS_SampleGetChannel(notesej.cnt.2,0)
						BASS_ChannelSetAttribute stat2,2,double(mastervol)/100*dirvol/100*notesej.cnt.3/100
						BASS_ChannelPlay stat2
						notesej.cnt.1=2
					}else{
						break
					}
				}
			}
		loop
		// ロングエフェクト/ピークフィルタの適用
		canagain=0
		if(anagainnum>0){
			repeat anagainnum-anagainfcnt,anagainfcnt
				if(anagain.cnt.2<=t+laserdelay0){
					canagain=anagain.cnt.1
					anagainfcnt=cnt
				}else:break
			loop
		}
		dim leffstata,2
		if(arstat.4.1+arstat.5.1=0){
			leffstat=0
		}else{
			repeat 2,4
				if(arstat.cnt.1=1){
					if((note.(arstat.cnt.2).2>0)&(ljudge.(cnt-4)=1)&(note.(arstat.cnt.2).1<=cnow)){
						leffstata.(cnt-4)=1
					}
					if((note.(arstat.cnt.2).2>0)&(ljudge.(cnt-4)=0)&(note.(arstat.cnt.2).1<=cnow)){
						leffstata.(cnt-4)=-1
					}
				}
			loop
			if(leffstata.0+leffstata.1>=1){
				leffstat=1
			}else:leffstat=0
		} 
		if(fadeoutfl=0){
			// ロングエフェクト
			if(feffect=1){
				tfx_diff=d3timer()-tfx_diff
				cnowfx=0
				tt=0
				if(bpmlnum>0){
					repeat bpmlnum-max(bpmlcfcnt_fx,1),max(bpmlcfcnt_fx,1)
						if(bpml.cnt.2<t+laserdelay0+tfx_diff){
							tt=bpml.cnt.2
							cnowfx=bpml.cnt.0
							bpmlcfcnt_fx=cnt
						}else:break
					loop
					bpmfx=bpml.bpmlcfcnt_fx.1
					cnowfx+=int(round(double(t+laserdelay0+tfx_diff-tt)*bpmfx/24000))
				}
				cnowfx_50ms=0
				tt=0
				if(bpmlnum>0){
					repeat bpmlnum-max(bpmlcfcnt_fx_50ms,1),max(bpmlcfcnt_fx_50ms,1)
						if(bpml.cnt.2<t+laserdelay0+tfx_diff+50){
							tt=bpml.cnt.2
							cnowfx_50ms=bpml.cnt.0
							bpmlcfcnt_fx_50ms=cnt
						}else:break
					loop
					bpmfx_50ms=bpml.bpmlcfcnt_fx_50ms.1
					cnowfx_50ms+=int(round(double(t+laserdelay0+tfx_diff-tt+50)*bpmfx_50ms/24000))
				}
				if(cnt=0){
					repeat userfilternum,userfxnum-userfilternum
						if(int(userfx_params.cnt.0)=FXDEF_FXTYPE_RETR){
							if(userfilter_params.(cnt-(userfxnum-userfilternum)).2>0.0f){
								user_now.cnt=int(1.0f/userfilter_params.(cnt-(userfxnum-userfilternum)).2)
							}
						}else:if(int(userfx_params.cnt.0)=FXDEF_FXTYPE_GATE){
							if(userfilter_params.(cnt-(userfxnum-userfilternum)).1>0.0f){
								user_now.cnt=int(1.0f/userfilter_params.(cnt-(userfxnum-userfilternum)).1)
							}
						}else:if(int(userfx_params.cnt.0)=FXDEF_FXTYPE_WOBB){
							if(userfilter_params.(cnt-(userfxnum-userfilternum)).1>0.0f){
								user_now.cnt=int(1.0f/userfilter_params.(cnt-(userfxnum-userfilternum)).1)
							}
						}else:if(int(userfx_params.cnt.0)=FXDEF_FXTYPE_BITC){
							BASS_VST_SetParam_R hFX_User.cnt,0,maxf(minf(userfilter_params.(cnt-(userfxnum-userfilternum)).1/128.0f,1.0f),0.0f)
						}else:if(int(userfx_params.cnt.0)=FXDEF_FXTYPE_TSTP){
							BASS_VST_SetParam_R hFX_User.cnt,1,maxf(minf(userfilter_params.(cnt-(userfxnum-userfilternum)).1,1.0f),0.0f)
						}else:if(int(userfx_params.cnt.0)=FXDEF_FXTYPE_ECHO){
							if(userfilter_params.(cnt-(userfxnum-userfilternum)).2>0.0f){
								user_now.cnt=int(1.0f/userfilter_params.(cnt-(userfxnum-userfilternum)).2)
							}
						}else:if(int(userfx_params.cnt.0)=FXDEF_FXTYPE_PITC){
							BASS_VST_SetParam_R hFX_User.cnt,0,maxf(minf(absf(userfilter_params.(cnt-(userfxnum-userfilternum)).1),1.0f),0.0f)
						}
					loop
				}
				if(bpmfx!=bpmfxp){
					if(fl_Flan=1):BASS_VST_SetParam_R hFX_Flan,0,maxf(minf(2.0f*60.0f*4*1000/bpmfx/10,1.0f),0.0f)
					if(fl_Phas=1):BASS_VST_SetParam_R hFX_Phas,0,maxf(minf(60.0f*2*1000/bpmfx/10,1.0f),0.0f)
					if(fl_SiCh=1):BASS_VST_SetParam_R hFX_SiCh,4,maxf(minf(60.0f*0.5f*1000/bpmfx/10,1.0f),0.0f)
					if((fl_Retr=1)&(retr_now>0)){
						BASS_VST_SetParam_R hFX_Retr,1,60.0f*4.0f*1000.0f/bpmfx/10.0f/retr_now
					}
					if((fl_Gate=1)&(gate_now>0)){
						BASS_VST_SetParam_R hFX_Gate,6,60.0f*4.0f*1000.0f/bpmfx/10.0f/gate_now
					}
					if((fl_Gate=1)&(wobble_now>0)){
						BASS_VST_SetParam_R hFX_Gate,9,60.0f*4.0f*1000.0f/bpmfx/10.0f/wobble_now
					}
					repeat 2
						if((fl_Echo=1)&(echo_now.cnt>0)){
							BASS_VST_SetParam_R hFX_Echo.cnt,1,60.0f*4.0f*1000.0f/bpmfx/10.0f/echo_now.cnt
							BASS_VST_SetParam_R hFX_Echo.cnt,3,60.0f*4.0f*1000.0f/bpmfx/10.0f/echo_now.cnt*1.25f
						}
					loop
					repeat userfxnum
						cnt2=cnt
						repeat fxdef_prmnum.(int(userfx_params.cnt2.0)),1
							if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)&(userfx_params.cnt2.cnt>=0.0f)&(fxdef_linkprm.(int(userfx_params.cnt2.0))!=cnt)){
								BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),maxf(minf(userfx_params.cnt2.cnt*60.0f*4*1000/bpmfx/10,1.0f),0.0f)
							}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)&(userfx_params.cnt2.cnt>=0.0f)&(fxdef_linkprm.(int(userfx_params.cnt2.0))=cnt)){
								if(user_now.cnt2>0){
									BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),maxf(minf(60.0f*4*1000/bpmfx/10/user_now.cnt2,1.0f),0.0f)
								}
							}
							if((int(userfx_params.cnt2.0)=FXDEF_FXTYPE_ECHO)&(cnt=2)){
								if(user_now.cnt2>0){
									BASS_VST_SetParam_R hFX_User.cnt2,3,maxf(minf(60.0f*4*1000/bpmfx/10/user_now.cnt2*1.25f,1.0f),0.0f)
								}
							}
						loop
					loop
				}
				if(ts_bass>max(updateperiod/5,1)){
					c2bnow=c2b(cnowfx)
					sich_beat=(cnowfx-b2c(c2bnow))/(bpba_4)
					c2bnow_50ms=c2b(cnowfx_50ms)
					retr_beat=(cnowfx_50ms-b2c(c2bnow_50ms))/(bpba_2)
					// Retrigger/Gate/Wobble 更新トリガ判定
					if((retr_beat!=retr_beatp)|(c2bnow_50ms!=c2bnowp_50ms)){
						// 小節頭から数えたカウント値をbpba/2間隔にそろえて時間変換、現在時刻からの時間差分を求める(Retrigger用)
						dstat=c2tf(b2c(c2bnow_50ms)+(cnowfx_50ms-b2c(c2bnow_50ms))/(bpba_2)*(bpba_2))-double(t+laserdelay0+tfx_diff)
						if(fl_Retr=1):BASS_VST_SetParam_R hFX_Retr,19,maxf(minf(dstat/10000.0f,1.0f),0.0f)
						if(c2bnow_50ms!=c2bnowp_50ms){
							// ユーザー定義FXのGate/Wobble更新(1小節間隔固定)
							if(fl_Gate=1):BASS_VST_SetParam_R hFX_Gate,19,maxf(minf(dstat/10000.0f,1.0f),0.0f)
							repeat userfxnum
								if((userfx_params.cnt.0=FXDEF_FXTYPE_GATE)|(userfx_params.cnt.0=FXDEF_FXTYPE_WOBB)){
									BASS_VST_SetParam_R hFX_User.cnt,19,maxf(minf(dstat/10000.0f,1.0f),0.0f)
								}
							loop
						}
					}
					retr_beatp=retr_beat
					repeat userfxnum
						if((userfx_params.cnt.0=FXDEF_FXTYPE_RETR)||(userfx_params.cnt.0=FXDEF_FXTYPE_ECHO)){
							// ユーザー定義FXのRetrigger/Echo 更新トリガ判定
							if((userfx_params.cnt.1>0.0f)&(int(userfx_params.cnt.1*bpba)>0)&(userfx_params.cnt.1<1.0f)){
								user_beat.cnt=(cnowfx_50ms-b2c(c2bnow_50ms))/max(int(userfx_params.cnt.1*bpba),1)
							}else:if(userfx_params.cnt.1>=1.0f){
								stat1=b2c(c2bnow_50ms)
								user_beat.cnt=int((double(c2bnow_50ms)+double(cnowfx_50ms-stat1)/(b2c(c2bnow_50ms+1)-stat1))/userfx_params.cnt.1)
							}else:user_beat.cnt=0
							if(((user_beat.cnt!=user_beatp.cnt)|(c2bnow_50ms!=c2bnowp_50ms))&(int(userfx_params.cnt.1*bpba)>0)&(userfx_params.cnt.1<1.0f)){
								dstat=c2tf(b2c(c2bnow_50ms)+(cnowfx_50ms-b2c(c2bnow_50ms))/int(userfx_params.cnt.1*bpba)*int(userfx_params.cnt.1*bpba))-double(t+laserdelay0+tfx_diff)
								BASS_VST_SetParam_R hFX_User.cnt,19,maxf(minf(dstat/10000.0f,1.0f),0.0f)
							}else:if((user_beat.cnt!=user_beatp.cnt)&(userfx_params.cnt.1>=1.0f)){
								stat1=int(double(user_beat.cnt)*userfx_params.cnt.1)
								stat1=b2c(stat1)+int(double(b2c(stat1+1)-b2c(stat1))*(double(user_beat.cnt)*userfx_params.cnt.1-double(stat1)))
								dstat=c2tf(stat1)-double(t+laserdelay0+tfx_diff)
								BASS_VST_SetParam_R hFX_User.cnt,19,maxf(minf(dstat/10000.0f,1.0f),0.0f)
							}
						}
					loop
					f=0
					feffectnow=0,0
					feffectparam=0,0
					feffectparam2=0,0
					feffectnow_real=0,0
					repeat notefxnum-min(notefxfcnt.0,notefxfcnt.1),min(notefxfcnt.0,notefxfcnt.1)
						if((notefx.cnt.3<=t)&(notefx.cnt.4>t)&(leffstata.(notefx.cnt.0-4)=1)){
							feffectnow_real.(notefx.cnt.0-4)=notefx.cnt.5
						}
						if((notefx.cnt.3<=t+laserdelay0)&(notefx.cnt.4>t+laserdelay0)&((leffstata.(notefx.cnt.0-4)=1)|(notefx.cnt.3+30>t))){
							feffectnow.(notefx.cnt.0-4)=notefx.cnt.5
							feffectparam.(notefx.cnt.0-4)=notefx.cnt.6
							feffectparam2.(notefx.cnt.0-4)=notefx.cnt.7
							f=1
						}
						if(notefx.cnt.3>t+laserdelay0):break
						if(notefx.cnt.4<=t):notefxfcnt.(notefx.cnt.0-4)=cnt+1
					loop
					// ByPassの設定
					if(f=1){
						repeat userfxnum-userfilternum
							BASS_VST_SetParam_R hFX_User.cnt,29,0.0f
						loop
					}else{
						repeat userfxnum-userfilternum
							BASS_VST_SetParam_R hFX_User.cnt,29,1.0f
						loop
					}
					// ユーザー定義FXの手動パラメータ変更
					repeat max(userchprmnum-userchprmfcnt,0),userchprmfcnt
						if(userchprm.cnt.0<=t+laserdelay0+tfx_diff){
							cnt2=int(userchprm.cnt.1)
							cnt3=int(userchprm.cnt.2)
							if((userchprm.cnt.3=1.0f)&(userchprm.cnt.4=1.0f)&(fxdef_max.cnt3.(int(userfx_params.cnt2.0))=-1.0f)){
								BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt3.(int(userfx_params.cnt2.0)),0.000003
							}else{
								userfx_params.cnt2.cnt3=userchprm.cnt.3
								userfx_params_enable.cnt2.cnt3=userchprm.cnt.4
								if(cnt2>=userfxnum-userfilternum){
									userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt3=userchprm.cnt.4
									userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt3=userchprm.cnt.5
								}
								if((feffectnow.0=100+cnt2)|(feffectnow.1=100+cnt2)){
									// 変更タイミングと対象ロングFXの有効時が重なった場合
									if((userfx_params_enable.cnt2.cnt3<0.0f)&(fxdef_type.cnt3.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)){
										BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt3.(int(userfx_params.cnt2.0)),minf(maxf(-userfx_params_enable.cnt2.cnt3/10.0f,0.0f),1.0f)
									}else:if(fxdef_max.cnt3.(int(userfx_params.cnt2.0))>0.0f){
										BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt3.(int(userfx_params.cnt2.0)),minf(maxf(fxdef_prmmax.cnt3.(int(userfx_params.cnt2.0))*userfx_params_enable.cnt2.cnt3/fxdef_max.cnt3.(int(userfx_params.cnt2.0)),0.0f),1.0f)
									}else:if((fxdef_prmno.cnt3.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt3.(int(userfx_params.cnt2.0))=FXDEF_PITCH)){
										// PitchShift pitch
										BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt3.(int(userfx_params.cnt2.0)),maxf(minf(absf(userfx_params_enable.cnt2.cnt3),1.0f),0.0f)
									}
									if(fxdef_linkprm.(int(userfx_params.cnt2.0))>=0){
										if((cnt3=fxdef_linkprm.(int(userfx_params.cnt2.0)))&(userfx_params_enable.cnt2.(fxdef_linkprm.(int(userfx_params.cnt2.0)))>0)){
											user_now.cnt2=int(1.0f/userfx_params_enable.cnt2.(fxdef_linkprm.(int(userfx_params.cnt2.0))))
										}
									}
								}else{
									if((userfx_params.cnt2.cnt3<0.0f)&(fxdef_type.cnt3.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)){
										BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt3.(int(userfx_params.cnt2.0)),minf(maxf(-userfx_params.cnt2.cnt3/10.0f,0.0f),1.0f)
									}else:if(fxdef_max.cnt3.(int(userfx_params.cnt2.0))>0.0f){
										BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt3.(int(userfx_params.cnt2.0)),minf(maxf(fxdef_prmmax.cnt3.(int(userfx_params.cnt2.0))*userfx_params.cnt2.cnt3/fxdef_max.cnt3.(int(userfx_params.cnt2.0)),0.0f),1.0f)
									}else:if((fxdef_prmno.cnt3.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt3.(int(userfx_params.cnt2.0))=FXDEF_PITCH)){
										// PitchShift pitch
										BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt3.(int(userfx_params.cnt2.0)),maxf(minf(absf(userfx_params.cnt2.cnt3),1.0f),0.0f)
									}
									if(fxdef_linkprm.(int(userfx_params.cnt2.0))>=0){
										if((cnt3=fxdef_linkprm.(int(userfx_params.cnt2.0)))&(userfx_params.cnt2.(fxdef_linkprm.(int(userfx_params.cnt2.0)))>0)){
											user_now.cnt2=int(1.0f/userfx_params.cnt2.(fxdef_linkprm.(int(userfx_params.cnt2.0))))
										}
									}
								}
								if((fxdef_prmno.cnt3.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt3.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)&(userfx_params.cnt2.cnt3>=0.0f)&(fxdef_linkprm.(int(userfx_params.cnt2.0))!=cnt3)){
									BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt3.(int(userfx_params.cnt2.0)),maxf(minf(userfx_params.cnt2.cnt3*60.0f*4*1000/bpmfx/10,1.0f),0.0f)
								}else:if((fxdef_prmno.cnt3.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt3.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)&(userfx_params.cnt2.cnt3>=0.0f)&(fxdef_linkprm.(int(userfx_params.cnt2.0))=cnt3)){
									if(user_now.cnt2>0){
										BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt3.(int(userfx_params.cnt2.0)),maxf(minf(60.0f*4*1000/bpmfx/10/user_now.cnt2,1.0f),0.0f)
									}
								}
								if((int(userfx_params.cnt2.0)=FXDEF_FXTYPE_ECHO)&(cnt3=2)){
									if(user_now.cnt2>0){
										BASS_VST_SetParam_R hFX_User.cnt2,3,maxf(minf(60.0f*4*1000/bpmfx/10/user_now.cnt2*1.25f,1.0f),0.0f)
									}
								}
							}
							userchprmfcnt=cnt+1
						}
						if(userchprm.cnt.0>t+laserdelay0+tfx_diff):break
					loop
					repeat 2
						// SwitchAudioの処理
						if(feffectnow_real.cnt!=feffectp_real.cnt){
							if(feffectp_real.cnt>=100){
								cnt2=feffectp_real.cnt-100
								if(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_AUDI){
									if(feffectnow_real.(1-cnt)<100){
										swaudionow=-1
									}else:if(int(userfx_params.(feffectnow_real.(1-cnt)-100).0)=FXDEF_FXTYPE_AUDI){
										swaudionow=userfx_swaudiomid.(feffectnow_real.(1-cnt)-100)
									}else{
										swaudionow=-1
									}
								}
							}
							if(feffectnow_real.cnt>=100){
								cnt2=feffectnow_real.cnt-100
								if(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_AUDI){
									swaudionow=userfx_swaudiomid.cnt2
								}
							}
						}
						if(feffectnow.cnt!=feffectp.cnt){
							// 以下, エフェクト解除
							if((feffectp.cnt=FX_PHAS)&(feffectnow.(1-cnt)!=FX_PHAS)){
								BASS_VST_SetParam_R hFX_Phas,1,0.0f
								BASS_VST_SetParam_R hFX_Phas,8,0
							}
							if((feffectp.cnt=FX_FLAN)&(feffectnow.(1-cnt)!=FX_FLAN)){
								BASS_VST_SetParam_R hFX_Flan,6,0
							}
							if((feffectp.cnt=FX_PITC)&(feffectnow.(1-cnt)!=FX_PITC)){
								BASS_VST_SetParam_R hFX_Pitc,3,0
								if(feffectnow.(1-cnt)=FX_PITC){
									BASS_VST_SetParam_R hFX_Pitc,0,double(feffectparam.(1-cnt))/48.0f/2.0f+0.50f
								}
							}
							if((feffectp.cnt=FX_BITC)&(feffectnow.(1-cnt)!=FX_BITC)){
								BASS_VST_SetParam_R hFX_BitC,0,0
								if(feffectnow.(1-cnt)=FX_BITC){
									BASS_VST_SetParam_R hFX_BitC,0,double(feffectparam.(1-cnt))/128.0f
								}
							}
							if(feffectp.cnt=FX_TSTP){
								BASS_VST_SetParam_R hFX_TStp.cnt,0,0
								if(feffectnow.(1-cnt)=FX_TSTP){
									BASS_VST_SetParam_R hFX_TStp.(1-cnt),2,1.0f
								}
							}
							if((feffectp.cnt>=FX_RE8)&(feffectp.cnt<=FX_RE32)&(feffectnow.(1-cnt)<FX_RE8)|(feffectnow.(1-cnt)>FX_RE32)){
								BASS_VST_SetParam_R hFX_Retr,29,1.0f
								BASS_VST_SetParam_R hFX_Retr,1,0
								retr_now=0
							}
							if((feffectp.cnt>=FX_RE8)&(feffectp.cnt<=FX_RE32)&(feffectnow.(1-cnt)>=FX_RE8)&(feffectnow.(1-cnt)<=FX_RE32)){
								BASS_VST_SetParam_R hFX_Retr,29,0.0f
								BASS_VST_SetParam_R hFX_Retr,1,60.0f*4.0f*1000.0f/bpmfx/10.0f/feffectparam.(1-cnt)
								retr_now=feffectparam.(1-cnt)
							}
							if((feffectp.cnt>=FX_GA4)&(feffectp.cnt<=FX_GA32)&(feffectnow.(1-cnt)<FX_GA4)|(feffectnow.(1-cnt)>FX_GA32)){
								//BASS_VST_SetParam_R hFX_Gate,29,1.0f
								BASS_VST_SetParam_R hFX_Gate,6,0
								gate_now=0
							}
							if((feffectp.cnt>=FX_GA4)&(feffectp.cnt<=FX_GA32)&(feffectnow.(1-cnt)>=FX_GA4)&(feffectnow.(1-cnt)<=FX_GA32)){
								//BASS_VST_SetParam_R hFX_Gate,29,0.0f
								BASS_VST_SetParam_R hFX_Gate,6,60.0f*4.0f*1000.0f/bpmfx/10.0f/feffectparam.(1-cnt)
								gate_now=feffectparam.(1-cnt)
							}
							if((feffectp.cnt=FX_WO12)&(feffectnow.(1-cnt)!=FX_WO12)){
								//BASS_VST_SetParam_R hFX_Gate,29,1.0f
								BASS_VST_SetParam_R hFX_Gate,9,0
								wobble_now=0
							}
							if((feffectp.cnt=FX_WO12)&(feffectnow.(1-cnt)=FX_WO12)){
								//BASS_VST_SetParam_R hFX_Gate,29,0.0f
								BASS_VST_SetParam_R hFX_Gate,9,60.0f*4.0f*1000.0f/bpmfx/10.0f/feffectparam.(1-cnt)
								wobble_now=feffectparam.(1-cnt)
							}
							if(feffectp.cnt=FX_EC4){
								BASS_VST_SetParam_R hFX_Echo.cnt,29,1.0f
								BASS_VST_SetParam_R hFX_Echo.cnt,1,0
								if(feffectnow.(1-cnt)=FX_EC4){
									BASS_VST_SetParam_R hFX_Echo.(1-cnt),29,0.0f
									BASS_VST_SetParam_R hFX_Echo.(1-cnt),5,1.0f
								}
							}
							if((feffectp.cnt=FX_SICH)&(feffectnow.(1-cnt)!=FX_SICH)){
								BASS_VST_SetParam_R hFX_SiCh,5,0.01
							}
							if(feffectp.cnt>=100){
								cnt2=feffectp.cnt-100
								if((int(userfx_params.cnt2.0)=FXDEF_FXTYPE_RETR)|(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_GATE)|(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_WOBB)){
									if(feffectnow.(1-cnt)=feffectp.cnt){
										BASS_VST_SetParam_R hFX_User.cnt2,(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_RETR)*1+(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_GATE)*6+(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_WOBB)*9,60.0f*4.0f*1000.0f/bpmfx/10.0f/feffectparam.(1-cnt)
										user_now.cnt2=feffectparam.(1-cnt)
									}
								}else:if(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_BITC){
									if(feffectnow.(1-cnt)=feffectp.cnt){
										BASS_VST_SetParam_R hFX_User.cnt2,0,minf(maxf(double(feffectparam.(1-cnt))/128.0f,0.0f),1.0f)
										user_now.cnt2=feffectparam.(1-cnt)
									}
								}else:if(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_TSTP){
									if(feffectnow.(1-cnt)=feffectp.cnt){
										BASS_VST_SetParam_R hFX_User.cnt2,1,minf(maxf(double(feffectparam.(1-cnt))/100.0f,0.0f),1.0f)
										user_now.cnt2=feffectparam.(1-cnt)
									}
								}else:if(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_PITC){
									if(feffectnow.(1-cnt)=feffectp.cnt){
										BASS_VST_SetParam_R hFX_User.cnt2,0,minf(maxf(double(feffectparam.(1-cnt))/48.0f/2.0f+0.5f,0.0f),1.0f)
										user_now.cnt2=feffectparam.(1-cnt)
									}
								}
								repeat fxdef_prmnum.(int(userfx_params.cnt2.0)),1
									if(userfx_params.cnt2.cnt!=userfx_params_enable.cnt2.cnt){
										if((userfx_params.cnt2.cnt<0.0f)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)){
											BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(-userfx_params.cnt2.cnt/10.0f,0.0f),1.0f)
										}else:if(fxdef_max.cnt.(int(userfx_params.cnt2.0))>0.0f){
											BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(fxdef_prmmax.cnt.(int(userfx_params.cnt2.0))*userfx_params.cnt2.cnt/fxdef_max.cnt.(int(userfx_params.cnt2.0)),0.0f),1.0f)
										}else:if((userfx_params.cnt2.cnt=1.0f)&(fxdef_max.cnt.(int(userfx_params.cnt2.0))=-1.0f)){
											BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),0.000003
										}
									}
								loop
							}
							// 以下, エフェクト付加
							if(feffectnow.cnt=FX_PHAS){
								BASS_VST_SetParam_R hFX_Phas,1,0.50f
								BASS_VST_SetParam_R hFX_Phas,8,0.50f
							}
							if(feffectnow.cnt=FX_FLAN){
								BASS_VST_SetParam_R hFX_Flan,6,0.80f
							}
							if(feffectnow.cnt=FX_PITC){
								BASS_VST_SetParam_R hFX_Pitc,0,double(feffectparam.cnt)/48.0f/2.0f+0.50f
								BASS_VST_SetParam_R hFX_Pitc,3,1.00f
							}
							if(feffectnow.cnt=FX_BITC){
								BASS_VST_SetParam_R hFX_BitC,0,double(feffectparam.cnt)/128.0f
							}
							if(feffectnow.cnt=FX_TSTP){
								BASS_VST_SetParam_R hFX_TStp.cnt,1,double(feffectparam.cnt)/100.0f
								BASS_VST_SetParam_R hFX_TStp.cnt,0,1.0f
								BASS_VST_SetParam_R hFX_TStp.cnt,2,1.0f
								BASS_VST_SetParam_R hFX_TStp.(1-cnt),2,0.0f
							}
							if((feffectnow.cnt>=FX_RE8)&(feffectnow.cnt<=FX_RE32)){
								BASS_VST_SetParam_R hFX_Retr,29,0.0f
								BASS_VST_SetParam_R hFX_Retr,1,60.0f*4.0f*1000.0f/bpmfx/10.0f/feffectparam.cnt
								retr_now=feffectparam.cnt
							}
							if((feffectnow.cnt>=FX_GA4)&(feffectnow.cnt<=FX_GA32)){
								//BASS_VST_SetParam_R hFX_Gate,29,0.0f
								BASS_VST_SetParam_R hFX_Gate,6,60.0f*4.0f*1000.0f/bpmfx/10.0f/feffectparam.cnt
								gate_now=feffectparam.cnt
							}
							if(feffectnow.cnt=FX_WO12){
								//BASS_VST_SetParam_R hFX_Gate,29,0.0f
								BASS_VST_SetParam_R hFX_Gate,9,60.0f*4.0f*1000.0f/bpmfx/10.0f/feffectparam.cnt
								wobble_now=feffectparam.cnt
							}
							if(feffectnow.cnt=FX_EC4){
								echo_trigger.cnt=1-echo_trigger.cnt
								BASS_VST_SetParam_R hFX_Echo.cnt,29,0.0f
								BASS_VST_SetParam_R hFX_Echo.cnt,0,double(echo_trigger.cnt)
								BASS_VST_SetParam_R hFX_Echo.cnt,1,60.0f*4.0f*1000.0f/bpmfx/10.0f/feffectparam.cnt
								BASS_VST_SetParam_R hFX_Echo.cnt,3,60.0f*4.0f*1000.0f/bpmfx/10.0f/feffectparam.cnt*1.25f
								BASS_VST_SetParam_R hFX_Echo.cnt,4,double(feffectparam2.cnt)/100
								BASS_VST_SetParam_R hFX_Echo.cnt,5,1.0f
								BASS_VST_SetParam_R hFX_Echo.(1-cnt),5,0.0f
							}
							if(feffectnow.cnt=FX_SICH){
								BASS_VST_SetParam_R hFX_SiCh,5,0.05f
							}
							if(feffectnow.cnt>=100){
								cnt2=feffectnow.cnt-100
								if((int(userfx_params.cnt2.0)=FXDEF_FXTYPE_RETR)|(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_GATE)|(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_WOBB)|(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_ECHO)){
									BASS_VST_SetParam_R hFX_User.cnt2,((int(userfx_params.cnt2.0)=FXDEF_FXTYPE_RETR)|(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_ECHO))*1+(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_GATE)*6+(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_WOBB)*9,60.0f*4.0f*1000.0f/bpmfx/10.0f/feffectparam.cnt
									user_now.cnt2=feffectparam.cnt
								}else:if(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_BITC){
									BASS_VST_SetParam_R hFX_User.cnt2,0,minf(maxf(double(feffectparam.cnt)/128.0f,0.0f),1.0f)
									user_now.cnt2=feffectparam.cnt
								}else:if(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_TSTP){
									BASS_VST_SetParam_R hFX_User.cnt2,1,minf(maxf(double(feffectparam.cnt)/100.0f,0.0f),1.0f)
									user_now.cnt2=feffectparam.cnt
								}else:if(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_PITC){
									BASS_VST_SetParam_R hFX_User.cnt2,0,minf(maxf(double(feffectparam.cnt)/48.0f/2.0f+0.5f,0.0f),1.0f)
									user_now.cnt2=feffectparam.cnt
								}
								repeat fxdef_prmnum.(int(userfx_params.cnt2.0)),1
									if(userfx_params.cnt2.cnt!=userfx_params_enable.cnt2.cnt){
										if((userfx_params_enable.cnt2.cnt<0.0f)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)){
											BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(-userfx_params_enable.cnt2.cnt/10.0f,0.0f),1.0f)
										}else:if(fxdef_max.cnt.(int(userfx_params.cnt2.0))>0.0f){
											BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(fxdef_prmmax.cnt.(int(userfx_params.cnt2.0))*userfx_params_enable.cnt2.cnt/fxdef_max.cnt.(int(userfx_params.cnt2.0)),0.0f),1.0f)
										}else:if((userfx_params_enable.cnt2.cnt=1.0f)&(fxdef_max.cnt.(int(userfx_params.cnt2.0))=-1.0f)){
											BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),0.000003
										}
									}
								loop
								if(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_ECHO){
									BASS_VST_SetParam_R hFX_User.cnt2,4,minf(maxf(double(feffectparam2.cnt)/100.0f,0.0f),1.0f)
								}
							}
						}
						feffectp_real.cnt=feffectnow_real.cnt
						feffectp.cnt=feffectnow.cnt
					loop
					if(((sich_beat!=sich_beatp)|(c2bnow!=c2bnowp))&((feffectnow.0=FX_SICH)|(feffectnow.1=FX_SICH))){
						if(cnt!=0){
							sich_trigger=1-sich_trigger
							if(fl_SiCh=1):BASS_VST_SetParam_R hFX_SiCh,0,double(sich_trigger)
						}
					}
					sich_beatp=sich_beat
				}
			}
			// レーザーエフェクト
			dim peffstata,2
			dim peffstata2,2
			dim peffstata3,2
			repeat 2
				if(panalognow.cnt!=1000*cnt){
					if((analognow.cnt=-1)|(abs(analogpos.cnt-analognow.cnt)<100+abs(analognow.cnt-analogfuture.cnt)/24*(analogfuture.cnt!=-1))|(t-analoganokt.cnt<=50)){
						peffstata.cnt=1
					}else:peffstata.cnt=-1
				}
				if(panalognow2.cnt!=-1){
					if((analognow.cnt=-1)|(abs(analogpos.cnt-analognow.cnt)<100+abs(analognow.cnt-analogfuture.cnt)/24*(analogfuture.cnt!=-1))|(t-analoganokt.cnt<=50)){
						peffstata2.cnt=1
					}else:peffstata2.cnt=-1
				}
				if(analognow.cnt!=-1){
					if((abs(analogpos.cnt-analognow.cnt)<100+abs(analognow.cnt-analogfuture.cnt)/24*(analogfuture.cnt!=-1))|(t-analoganokt.cnt<=50)){
						peffstata3.cnt=1
						if(arstat.(6+cnt).0=1){
							if((analog.(arstat.(6+cnt).1).2<=bpba_32)&(analog.(arstat.(6+cnt).1).8=1)){
								peffstata3.cnt=0
							}
						}
					}else:peffstata3.cnt=-1
				}
			loop
			if(peffstata.0+peffstata.1>=1){
				peffstat=1
			}else:peffstat=0
			if(peffstata2.0+peffstata2.1>=1){
				peffstat2=1
			}else:peffstat2=0
			if(peffstata3.0+peffstata3.1>=1){
				peffstat3=1
			}else:peffstat3=0
			if((peffect=1)&(ts_bass>max(updateperiod/5,1))){
				ddim pdstat2,1
				pdstat2=pdstat
				ddim pdstat,1
				panalogstat=panalognow.0,panalognow.1
				repeat 2
					if((abs(analognow.cnt-analogpos.cnt)>50)&(abs(analognowp.cnt-analogposp.cnt)<=50)):pdoutt.cnt=t
				loop
				repeat 2
					if((abs(analognow.cnt-analogpos.cnt)>50)&(analognow.cnt!=-1)&(t-pdoutt>50)):panalogstat.cnt=analogpos.cnt
				loop
				pdstat=double(max((panalognow.0>=0)*panalogstat.0*((peffstata.0=1)|(analognow.0=-1)),(1000-panalogstat.1)*((peffstata.1=1)|(analognow.1=-1))))/1000.0f
				pstat3=pstat2
				pstat2=(((analognow.0!=-1)&(analog.(arstat.6.1).2<=bpba_32)&(analog.(arstat.6.1).8=1))|((analognow.1!=-1)&(analog.(arstat.7.1).2<=bpba_32)&(analog.(arstat.7.1).8=1))|((panalogstat.0<=20)&((panalogstat.1>=980))))|(pdstat=0.0f)
				if((pstat2=1)&(pstat3=0)){
					shuwat=t
					shuwapos=pdstat2
				}
				if(analoganflag=1){
					shuwat=t
					shuwapos=pdstat2
				}
			}
			if(filtertype2<0){
				// FX音源に切り替えるレーザー音声エフェクトの場合
				f=0
				repeat 2
					if(arstat.(4+cnt).1=1){
						f+=(1+cnt)*((note.(arstat.(4+cnt).2).2=0)|(arstat.(4+cnt).0<note.(arstat.(4+cnt).2).3-note.(arstat.(4+cnt).2).4))
					}
				loop
				stat1=(leffstat+peffstat3*2)*(peffect=0)+(leffstat|(((f\2)|(arstat.4.0>0)|(arstat.4.1=0))&((f/2)|(arstat.5.0>0)|(arstat.5.1=0))))*(peffstat3|((analognow.0=-1)&(analognow.1=-1)))*(peffect=1)
			}else{
				stat1=leffstat+peffstat3*2*(peffect=0)+((max(peffstata.0,0)+max(peffstata.1,0)+((t-shuwat<=200)&(disableshuwa=0)))>=1)*(peffect=1)*2
			}
			if(auto=1):stat1/=2
			if(peffect=1):stat1\=2
			if(feffect=1):stat1=0
			if(stat1>=length(mid)):stat1=length(mid)-1
			mnow=0
			// 音声の切り替え
			if(feffect=1){
				mnow=0
			}
			if((stat1>=0)&(feffect=0)){
				foreach mid
					if(cnt!=stat1):BASS_ChannelSetAttribute mid.cnt,2,0.0
				loop
				if(mrepeat=0):BASS_ChannelSetAttribute mid.stat1,2,double(csongvol)/100*mastervol/100
				mnow=stat1
			}
			// SwitchAudioの処理
			swaudionow_filter=-1
			if(feffect=1){
				if((peffstat3=1)&(filtertype2>=100)){
					if(int(userfx_params.(filtertype2-100).0)=FXDEF_FXTYPE_AUDI){
						swaudionow_filter=userfx_swaudiomid.(filtertype2-100)
					}
				}
				// SwitchAudioの音声切り替え処理
				swaudionow_result=-1
				if(swaudionow_filter!=-1):swaudionow_result=swaudionow_filter
				if(swaudionow!=-1):swaudionow_result=swaudionow
				if(swaudionow_result<0){
					BASS_ChannelSetAttribute mid.0,2,double(csongvol)/100*mastervol/100
					repeat swaudionum
						BASS_ChannelSetAttribute mid_sw.cnt,2,0.0
					loop
				}else{
					BASS_ChannelSetAttribute mid.0,2,0.0
					repeat swaudionum
						if(cnt!=swaudionow_result):BASS_ChannelSetAttribute mid_sw.cnt,2,0.0
					loop
					BASS_ChannelSetAttribute mid_sw.swaudionow_result,2,double(csongvol)/100*mastervol/100
				}
				swaudionow_resultp=swaudionow_result
			}
			if((peffect=1)&(ts_bass>max(updateperiod/5,1))){
				if((filtertype=0)&(1|(cnt=0)|(t_tp>500)|(pdstat!=pdstat2)|(filtertype!=filtertypep2)|(pstat2!=pstat3)|((t-shuwat<=200)&(disableshuwa=0))|(canagain!=canagainp2))){
					if(filtertype!=filtertypep):shuwat=-50000
					if((pstat2=1)&(disableshuwa=0)){
						pfilter=6,tofloat(3000.0f*((maxf(shuwapos,0.8f)-0.8f)/0.2f)+10000.0f-9950.0f*(cos(shuwapos)*4.0f+cos(shuwapos)*cos(shuwapos)*5.0f)/9.0f),tofloat(minf(maxf(14.0f*minf(shuwapos,0.15f)/0.15f+3.0f*(1.0-absf(shuwapos-0.35f)/0.35f)-3.5f*((maxf(shuwapos,0.8f)-0.8f)/0.2f),0.0f),18.0f)*1.1f*(50-min(t-shuwat,50))/50.0f*min(canagain,50)/50),tofloat(1.2f),tofloat(0.0f),tofloat(0.0f),-1*(t-shuwat<=50)
						foreach mid
							BASS_FXSetParameters hPeakFX.cnt,pfilter
						loop
						repeat swaudionum
							BASS_FXSetParameters hPeakFX_sw.cnt,pfilter
						loop
						pfilter=6,tofloat(3000.0f*((maxf(shuwapos,0.8f)-0.8f)/0.2f)+10000.0f-9950.0f*(cos(shuwapos)*4.0f+cos(shuwapos)*cos(shuwapos)*5.0f)/9.0f),tofloat(minf(maxf(14.0f*minf(shuwapos,0.15f)/0.15f+3.0f*(1.0-absf(shuwapos-0.35f)/0.35f)-3.5f*((maxf(shuwapos,0.8f)-0.8f)/0.2f),0.0f),18.0f)*1.1f*(50-min(t-shuwat,50))/50.0f*min(canagain,50)/50),tofloat(1.2f),tofloat(0.0f),tofloat(0.0f),0
						foreach mid
							BASS_FXSetParameters hPeakFX2.cnt,pfilter
						loop
						repeat swaudionum
							BASS_FXSetParameters hPeakFX2_sw.cnt,pfilter
						loop
					}else{
						pfilter=6,tofloat(3000.0f*((maxf(pdstat,0.8f)-0.8f)/0.2f)+10000.0f-9950.0f*(cos(pdstat)*4.0f+cos(pdstat)*cos(pdstat)*5.0f)/9.0f),tofloat(minf(maxf(14.0f*minf(pdstat,0.15f)/0.15f+3.0f*(1.0-absf(pdstat-0.35f)/0.35f)-3.5f*((maxf(pdstat,0.8f)-0.8f)/0.2f),0.0f),18.0f)*(1.0f+0.5f*(disableshuwa=0)*(50-min(t-shuwat,50))/50.0f*(shuwapos>=100.0f))*canagain/50),tofloat(1.2f),tofloat(0.0f),tofloat(0.0f),-1
						foreach mid
							BASS_FXSetParameters hPeakFX.cnt,pfilter
						loop
						repeat swaudionum
							BASS_FXSetParameters hPeakFX_sw.cnt,pfilter
						loop
						pfilter=6,tofloat(3000.0f*((maxf(pdstat,0.8f)-0.8f)/0.2f)+10000.0f-9950.0f*(cos(pdstat)*4.0f+cos(pdstat)*cos(pdstat)*5.0f)/9.0f),tofloat(minf(maxf(14.0f*minf(pdstat,0.15f)/0.15f+3.0f*(1.0-absf(pdstat-0.35f)/0.35f)-3.5f*((maxf(pdstat,0.8f)-0.8f)/0.2f),0.0f),18.0f)*(1.0f+0.5f*(disableshuwa=0)*(50-min(t-shuwat,50))/50.0f*(shuwapos>=100.0f))*canagain/50),tofloat(1.2f),tofloat(0.0f),tofloat(0.0f),0
						foreach mid
							BASS_FXSetParameters hPeakFX2.cnt,pfilter
						loop
						repeat swaudionum
							BASS_FXSetParameters hPeakFX2_sw.cnt,pfilter
						loop
					}
					foreach mid
						BASS_VST_SetParam_R hBitCFX.cnt,0,0.0f
					loop
					repeat swaudionum
						BASS_VST_SetParam_R hBitCFX_sw.cnt,0,0.0f
					loop
					repeat userfilternum,userfxnum-userfilternum
						cnt2=cnt
						repeat fxdef_prmnum.(int(userfx_params.cnt.0)),1
							if((userfilter_params.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)|(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)){
								if((userfx_params.cnt2.cnt<0.0f)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)){
									BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(-userfx_params.cnt2.cnt/10.0f,0.0f),1.0f)
								}else:if(fxdef_max.cnt.(int(userfx_params.cnt2.0))>0.0f){
									BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(fxdef_prmmax.cnt.(int(userfx_params.cnt2.0))*userfx_params.cnt2.cnt/fxdef_max.cnt.(int(userfx_params.cnt2.0)),0.0f),1.0f)
								}
							}
						loop
					loop
					filtertypep2=filtertype
					canagainp2=canagain
				}else:if((filtertype!=0)&(filtertype<100)&(1|(cnt=1)|(t_tp>500)|(pdstat!=pdstat2)|(filtertype!=filtertypep2)|(pstat2!=pstat3)|(canagain!=canagainp2))){
					if((filtertype<0)|(filtertype>=5)){
						pfilter=6,tofloat(1000.0f),tofloat(0.0f),tofloat(1.2f),tofloat(0.0f),tofloat(0.0f),0
					}
					if(filtertype=1):pfilter=1,tofloat(4600.0f-4500.0f*cos(pdstat)),tofloat(minf(maxf(13.0f*minf(pdstat,0.2f)/0.2f+4.0f*(1.0-absf(pdstat-0.35f)/0.35f)-3.0f*((maxf(pdstat,0.8f)-0.8f)/0.2f),0.0f),16.0f)*(1.0f+0.1f*(1-disableshuwa)*(50-min(t-shuwat,50))/50.0f*(shuwapos>=100.0f))*canagain/50),tofloat(0.8f),tofloat(0.0f),tofloat(0.0f),-1*(pstat2=0)
					//if(filtertype=2):pfilter=1,tofloat(10000.0f-10000.0f+9950.0f*(cos(pdstat)*4.0f+cos(pdstat)*5.0f)/9.0f),tofloat(minf(maxf(11.0f*minf(pdstat,0.2f)/0.2f+6.0f*(1.0-absf(pdstat-0.35f)/0.35f)-1.5f*((maxf(pdstat,0.8f)-0.8f)/0.2f),0.0f),16.0f)*(1.0f+0.1f*(50-min(t-shuwat,50))/50.0f*(shuwapos>=100.0f))*canagain/50),tofloat(1.25f),tofloat(0.0f),tofloat(0.0f),-1
					if(filtertype=3):pfilter=0,tofloat(15000.0f-14200.0f*sin(sin(pdstat*1.25)/sin(1.25f)*1.5)/sin(1.5f)),tofloat(minf(maxf(13.0f*minf(pdstat,0.15f)/0.15f+4.0f*(1.0-absf(pdstat-0.35f)/0.35f)-3.0f*((maxf(pdstat,0.8f)-0.8f)/0.2f),0.0f),16.0f)*(1.0f+0.5f*(1-disableshuwa)*(50-min(t-shuwat,50))/50.0f*(shuwapos>=100.0f))*canagain/50),tofloat(0.8f),tofloat(0.0f),tofloat(0.0f),-1*(pstat2=0)
					//if(filtertype=4):pfilter=0,tofloat(10000.0f-5000.0f+4950.0f*(cos(pdstat)*4.0f+cos(pdstat)*5.0f)/9.0f),tofloat(minf(maxf(11.0f*minf(pdstat,0.2f)/0.2f+6.0f*(1.0-absf(pdstat-0.35f)/0.35f)-1.5f*((maxf(pdstat,0.8f)-0.8f)/0.2f),0.0f),16.0f)*(1.0f+0.1f*(50-min(t-shuwat,50))/50.0f*(shuwapos>=100.0f))*canagain/50),tofloat(1.25f),tofloat(0.0f),tofloat(0.0f),-1
					foreach mid
						BASS_FXSetParameters hPeakFX.cnt,pfilter
					loop
					repeat swaudionum
						BASS_FXSetParameters hPeakFX_sw.cnt,pfilter
					loop
					if(filtertype=1):pfilter=6,tofloat(4600.0f-4500.0f*cos(pdstat)),tofloat(minf(maxf(13.0f*minf(pdstat,0.2f)/0.2f+4.0f*(1.0-absf(pdstat-0.35f)/0.35f)-3.0f*((maxf(pdstat,0.8f)-0.8f)/0.2f),0.0f),16.0f)*(1.0f+0.1f*(1-disableshuwa)*(50-min(t-shuwat,50))/50.0f*(shuwapos>=100.0f))*canagain/65),tofloat(0.8f),tofloat(0.0f),tofloat(0.0f),-1*(pstat2=0)
					//if(filtertype=2):pfilter=6,tofloat(2000.0f-10000.0f+9950.0f*(cos(pdstat)*4.0f+cos(pdstat)*5.0f)/9.0f),tofloat(minf(maxf(11.0f*minf(pdstat,0.2f)/0.2f+6.0f*(1.0-absf(pdstat-0.35f)/0.35f)-1.5f*((maxf(pdstat,0.8f)-0.8f)/0.2f),0.0f),16.0f)*(1.0f+0.1f*(50-min(t-shuwat,50))/50.0f*(shuwapos>=100.0f))*canagain/50),tofloat(1.25f),tofloat(0.0f),tofloat(0.0f),-1
					if(filtertype=3):pfilter=6,tofloat(15000.0f-14200.0f*sin(sin(pdstat*1.25)/sin(1.25f)*1.5)/sin(1.5f)),tofloat(minf(maxf(15.0f*minf(pdstat,0.15f)/0.15f+2.0f*(1.0-absf(pdstat-0.35f)/0.35f)-3.0f*((maxf(pdstat,0.8f)-0.8f)/0.2f),0.0f),16.0f)*(1.0f+0.5f*(1-disableshuwa)*(50-min(t-shuwat,50))/50.0f*(shuwapos>=100.0f))*canagain/90),tofloat(0.8f),tofloat(0.0f),tofloat(0.0f),-1*(pstat2=0)
					//if(filtertype=4):pfilter=6,tofloat(1000.0f-5000.0f+4950.0f*(cos(pdstat)*4.0f+cos(pdstat)*5.0f)/9.0f),tofloat(minf(maxf(11.0f*minf(pdstat,0.2f)/0.2f+6.0f*(1.0-absf(pdstat-0.35f)/0.35f)-1.5f*((maxf(pdstat,0.8f)-0.8f)/0.2f),0.0f),16.0f)*(1.0f+0.1f*(50-min(t-shuwat,50))/50.0f*(shuwapos>=100.0f))*canagain/50),tofloat(1.25f),tofloat(0.0f),tofloat(0.0f),-1
					if(filtertype=0){
						if(filtertype!=filtertypep):shuwat=-50000
						if((pstat2=1)&(disableshuwa=0)){
							pfilter=6,tofloat(3000.0f*((maxf(shuwapos,0.8f)-0.8f)/0.2f)+10000.0f-9950.0f*(cos(shuwapos)*4.0f+cos(shuwapos)*cos(shuwapos)*5.0f)/9.0f),tofloat(minf(maxf(14.0f*minf(shuwapos,0.15f)/0.15f+3.0f*(1.0-absf(shuwapos-0.35f)/0.35f)-3.5f*((maxf(shuwapos,0.8f)-0.8f)/0.2f),0.0f),18.0f)*1.1f*(50-min(t-shuwat,50))/50.0f*min(canagain,50)/50),tofloat(1.2f),tofloat(0.0f),tofloat(0.0f),-1*(t-shuwat<=50)
						}else{
							pfilter=6,tofloat(3000.0f*((maxf(pdstat,0.8f)-0.8f)/0.2f)+10000.0f-9950.0f*(cos(pdstat)*4.0f+cos(pdstat)*cos(pdstat)*5.0f)/9.0f),tofloat(minf(maxf(14.0f*minf(pdstat,0.15f)/0.15f+3.0f*(1.0-absf(pdstat-0.35f)/0.35f)-3.5f*((maxf(pdstat,0.8f)-0.8f)/0.2f),0.0f),18.0f)*(1.0f+0.5f*(disableshuwa=0)*(50-min(t-shuwat,50))/50.0f*(shuwapos>=100.0f))*canagain/50),tofloat(1.2f),tofloat(0.0f),tofloat(0.0f),0
						}
					}
					foreach mid
						BASS_FXSetParameters hPeakFX2.cnt,pfilter
					loop
					repeat swaudionum
						BASS_FXSetParameters hPeakFX2_sw.cnt,pfilter
					loop
					if(filtertype=5){
						foreach mid
							BASS_VST_SetParam_R hBitCFX.cnt,0,pdstat*30.0f/128.0f
						loop
						repeat swaudionum
							BASS_VST_SetParam_R hBitCFX_sw.cnt,0,pdstat*30.0f/128.0f
						loop
					}else{
						foreach mid
							BASS_VST_SetParam_R hBitCFX.cnt,0,0.0f
						loop
						repeat swaudionum
							BASS_VST_SetParam_R hBitCFX_sw.cnt,0,0.0f
						loop
					}
					repeat userfilternum,userfxnum-userfilternum
						cnt2=cnt/*
						if(filtertype=cnt2+100){
							repeat fxdef_prmnum.(int(userfx_params.cnt.0)),1
								if((userfilter_params.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)|(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)){
									if((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt<0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt<0.0f)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)){
										// linkされていない * ms
										BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(-userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt/10.0f,0.0f),1.0f)*(1.0f-pdstat)+minf(maxf(-userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt/10.0f,0.0f),1.0f)*pdstat
									}else:if(fxdef_max.cnt.(int(userfx_params.cnt2.0))>0.0f){
										// 一般
										BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(fxdef_prmmax.cnt.(int(userfx_params.cnt2.0))*(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt*(1.0f-pdstat)+userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt*pdstat)/fxdef_max.cnt.(int(userfx_params.cnt2.0)),0.0f),1.0f)
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)&(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt>=0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt>=0.0f)&(fxdef_linkprm.(int(userfx_params.cnt2.0))=cnt)){
										// linkされた 1/* 小節 (waveLength, Wobble period)
										if((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt>0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt>0.0f)){
											user_now.cnt2=divconv3(int((1.0f-pdstat)*divconv2(divconv(int(1.0f/userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)))+minf(pdstat,0.999f)*(divconv2(divconv(int(1.0f/userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)))+1)))
										}else{
											user_now.cnt2=0
										}
										if(user_now.cnt2>0){
											BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),maxf(minf(60.0f*4*1000/bpmfx/10/user_now.cnt2,1.0f),0.0f)
										}
										if(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_ECHO){
											BASS_VST_SetParam_R hFX_User.cnt2,3,maxf(minf(60.0f*4*1000/bpmfx/10/user_now.cnt2*1.25f,1.0f),0.0f)
										}
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_RATE)&(fxdef_linkprm.(int(userfx_params.cnt2.0))=cnt)){
										// linkされた rate (Tapestop speed)
										BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt*(1.0f-pdstat)+userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt*pdstat,0.0f),1.0f)
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_PITCH)){
										// PitchShift pitch
										if((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt<0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt<0.0f)){
											BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(round((absf(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)*(1.0f-pdstat)+absf(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)*pdstat)*96.0f)/96.0f,0.0f),1.0f)
										}else{
											BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(absf(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)*(1.0f-pdstat)+absf(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)*pdstat,0.0f),1.0f)
										}
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_SAMPLE)&(fxdef_linkprm.(int(userfx_params.cnt2.0))=cnt)){
										// linkされた sample (reduction)
										BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt*(1.0f-pdstat)+userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt*pdstat)/128.0f,0.0f),1.0f)
									}else:if((int(userfx_params.cnt2.0)=FXDEF_FXTYPE_SICH)&(cnt=1)){
										// SideChain period
										if((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt>0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt>0.0f)){
											userfx_params.cnt2.cnt=1.0f/(divconv3(int((1.0f-pdstat)*divconv2(divconv(int(1.0f/userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)))+minf(pdstat,0.999f)*(divconv2(divconv(int(1.0f/userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)))+1))))
										}else{
											userfx_params.cnt2.cnt=0.0f
										}
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)&(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt>=0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt>=0.0f)){
										// linkされていない 1/* 小節 (Flanger periodなど)
										BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),maxf(minf((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt*(1.0f-pdstat)+userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt*pdstat)*60.0f*4*1000/bpmfx/10,1.0f),0.0f)
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(userfx_params_enable.cnt2.cnt=1.0f)&(fxdef_max.cnt.(int(userfx_params.cnt2.0))=-1.0f)&((peffstat2p!=peffstat2)|(filtertypep!=filtertype))){
										// updateTrigger
										BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),0.000003
									}
								}
							loop
						}else{*/
							repeat fxdef_prmnum.(int(userfx_params.cnt.0)),1
								if((userfilter_params.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)|(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)){
									if((userfx_params.cnt2.cnt<0.0f)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)){
										BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(-userfx_params.cnt2.cnt/10.0f,0.0f),1.0f)
									}else:if(fxdef_max.cnt.(int(userfx_params.cnt2.0))>0.0f){
										BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(fxdef_prmmax.cnt.(int(userfx_params.cnt2.0))*userfx_params.cnt2.cnt/fxdef_max.cnt.(int(userfx_params.cnt2.0)),0.0f),1.0f)
									}
								}
							loop
						//}
					loop
					filtertypep2=filtertype
					canagainp2=canagain
				}else:if((peffstata2.0=1)|(peffstata2.1=1)){
					if((filtertype<0)|(filtertype>=5)){
						pfilter=6,tofloat(1000.0f),tofloat(0.0f),tofloat(1.2f),tofloat(0.0f),tofloat(0.0f),0
						foreach mid
							BASS_FXSetParameters hPeakFX.cnt,pfilter
							BASS_FXSetParameters hPeakFX2.cnt,pfilter
						loop
						repeat swaudionum
							BASS_FXSetParameters hPeakFX_sw.cnt,pfilter
							BASS_FXSetParameters hPeakFX2_sw.cnt,pfilter
						loop
						foreach mid
							BASS_VST_SetParam_R hBitCFX.cnt,0,0.0f
						loop
						repeat swaudionum
							BASS_VST_SetParam_R hBitCFX_sw.cnt,0,0.0f
						loop
					}
					repeat userfilternum,userfxnum-userfilternum
						cnt2=cnt
						if(filtertype=cnt2+100){
							repeat fxdef_prmnum.(int(userfx_params.cnt.0)),1
								if((userfilter_params.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)|(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)){
									if((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt<0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt<0.0f)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)){
										// * ms
										BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(-userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt/10.0f,0.0f),1.0f)*(1.0f-pdstat)+minf(maxf(-userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt/10.0f,0.0f),1.0f)*pdstat
										if((int(userfx_params.cnt2.0)=FXDEF_FXTYPE_ECHO)&(cnt=2)){
											BASS_VST_SetParam_R hFX_User.cnt2,3,minf(maxf(-userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt/10.0f,0.0f),1.0f)*(1.0f-pdstat)+minf(maxf(-userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt/10.0f*1.25f,0.0f),1.0f)*pdstat
										}
									}else:if(fxdef_max.cnt.(int(userfx_params.cnt2.0))>0.0f){
										// 一般
										BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(fxdef_prmmax.cnt.(int(userfx_params.cnt2.0))*(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt*(1.0f-pdstat)+userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt*pdstat)/fxdef_max.cnt.(int(userfx_params.cnt2.0)),0.0f),1.0f)
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)&(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt>=0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt>=0.0f)&(fxdef_linkprm.(int(userfx_params.cnt2.0))=cnt)){
										// linkされた 1/* 小節 (waveLength, Wobble period)
										if((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt>0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt>0.0f)){
											user_now.cnt2=divconv3(int((1.0f-pdstat)*divconv2(divconv(int(1.0f/userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)))+minf(pdstat,0.999f)*(divconv2(divconv(int(1.0f/userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)))+1)))
										}else{
											user_now.cnt2=0
										}
										if(user_now.cnt2>0){
											BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),maxf(minf(60.0f*4*1000/bpmfx/10/user_now.cnt2,1.0f),0.0f)
										}
										if(int(userfx_params.cnt2.0)=FXDEF_FXTYPE_ECHO){
											BASS_VST_SetParam_R hFX_User.cnt2,3,maxf(minf(60.0f*4*1000/bpmfx/10/user_now.cnt2*1.25f,1.0f),0.0f)
										}
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_RATE)&(fxdef_linkprm.(int(userfx_params.cnt2.0))=cnt)){
										// linkされた rate (speed)
										BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt*(1.0f-pdstat)+userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt*pdstat,0.0f),1.0f)
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_PITCH)){
										// PitchShift pitch
										if((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt<0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt<0.0f)){
											BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(round((absf(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)*(1.0f-pdstat)+absf(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)*pdstat)*96.0f)/96.0f,0.0f),1.0f)
										}else{
											BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(absf(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)*(1.0f-pdstat)+absf(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)*pdstat,0.0f),1.0f)
										}
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_SAMPLE)&(fxdef_linkprm.(int(userfx_params.cnt2.0))=cnt)){
										// linkされた sample (reduction)
										BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt*(1.0f-pdstat)+userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt*pdstat)/128.0f,0.0f),1.0f)
									}else:if((int(userfx_params.cnt2.0)=FXDEF_FXTYPE_SICH)&(cnt=1)){
										// SideChain period
										if((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt>0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt>0.0f)){
											userfx_params.cnt2.cnt=1.0f/(divconv3(int((1.0f-pdstat)*divconv2(divconv(int(1.0f/userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)))+minf(pdstat,0.999f)*(divconv2(divconv(int(1.0f/userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)))+1))))
										}else{
											userfx_params.cnt2.cnt=0.0f
										}
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)&(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt>=0.0f)&(userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt>=0.0f)){
										// linkされていない 1/* 小節 (Flanger periodなど)
										BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),maxf(minf((userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt*(1.0f-pdstat)+userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt*pdstat)*60.0f*4*1000/bpmfx/10,1.0f),0.0f)
									}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(userfx_params_enable.cnt2.cnt=1.0f)&(fxdef_max.cnt.(int(userfx_params.cnt2.0))=-1.0f)&((peffstat2p!=peffstat2)|(filtertypep!=filtertype))){
										// updateTrigger
										BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),0.000003
									}
								}
							loop
						}else{
							repeat fxdef_prmnum.(int(userfx_params.cnt.0)),1
								if((userfilter_params.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)|(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)){
									if((userfx_params.cnt2.cnt<0.0f)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)){
										BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(-userfx_params.cnt2.cnt/10.0f,0.0f),1.0f)
									}else:if(fxdef_max.cnt.(int(userfx_params.cnt2.0))>0.0f){
										BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(fxdef_prmmax.cnt.(int(userfx_params.cnt2.0))*userfx_params.cnt2.cnt/fxdef_max.cnt.(int(userfx_params.cnt2.0)),0.0f),1.0f)
									}
								}
							loop
						}
					loop
				}else{
					pfilter=6,tofloat(1000.0f),tofloat(0.0f),tofloat(1.2f),tofloat(0.0f),tofloat(0.0f),0
					foreach mid
						BASS_FXSetParameters hPeakFX.cnt,pfilter
						BASS_FXSetParameters hPeakFX2.cnt,pfilter
					loop
					repeat swaudionum
						BASS_FXSetParameters hPeakFX_sw.cnt,pfilter
						BASS_FXSetParameters hPeakFX2_sw.cnt,pfilter
					loop
					foreach mid
						BASS_VST_SetParam_R hBitCFX.cnt,0,0.0f
					loop
					repeat swaudionum
						BASS_VST_SetParam_R hBitCFX_sw.cnt,0,0.0f
					loop
					repeat userfilternum,userfxnum-userfilternum
						cnt2=cnt
						repeat fxdef_prmnum.(int(userfx_params.cnt.0)),1
							if((userfilter_params.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt)|(userfilter_params_min.(cnt2-(userfxnum-userfilternum)).cnt!=userfilter_params_max.(cnt2-(userfxnum-userfilternum)).cnt)){
								if((userfx_params.cnt2.cnt<0.0f)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)){
									BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(-userfx_params.cnt2.cnt/10.0f,0.0f),1.0f)
								}else:if(fxdef_max.cnt.(int(userfx_params.cnt2.0))>0.0f){
									BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(fxdef_prmmax.cnt.(int(userfx_params.cnt2.0))*userfx_params.cnt2.cnt/fxdef_max.cnt.(int(userfx_params.cnt2.0)),0.0f),1.0f)
								}
							}
						loop
					loop
				}
				// ByPassの設定
				if(peffstat2=1){
					repeat userfilternum,userfxnum-userfilternum
						BASS_VST_SetParam_R hFX_User.cnt,29,0.0f
					loop
				}else{
					repeat userfilternum,userfxnum-userfilternum
						BASS_VST_SetParam_R hFX_User.cnt,29,1.0f
					loop
				}
				peffstat2p=peffstat2
				foreach mid
					if(hCompFX.cnt=-1){
						if(mnow=cnt){
							hCompFX.cnt=BASS_ChannelSetFX(mid.cnt,0x10011,0)
							BASS_FXSetParameters hCompFX.cnt,compparam
							hVolFX2.cnt=BASS_ChannelSetFX(mid.cnt,0x10003,10)
							dim volfx,2
							volfx=0,tofloat(0.1f)
							BASS_FXSetParameters hVolFX2.cnt,volfx
						}
					}
				loop
				repeat swaudionum
					if(hCompFX_sw.cnt=-1){
						if(swaudionow_result=cnt){
							hCompFX_sw.cnt=BASS_ChannelSetFX(mid_sw.cnt,0x10011,0)
							BASS_FXSetParameters hCompFX_sw.cnt,compparam
							hVolFX2_sw.cnt=BASS_ChannelSetFX(mid_sw.cnt,0x10003,10)
							dim volfx,2
							volfx=0,tofloat(0.1f)
							BASS_FXSetParameters hVolFX2_sw.cnt,volfx
						}
					}
				loop
			}
		}
		if(fadeoutfl=0){
			// ロングエフェクト (SideChainのみレーザーの後に処理)
			if(feffect=1){
				_cnt=cnt
				repeat userfxnum
					if(userfx_params.cnt.0=FXDEF_FXTYPE_SICH){
						// ユーザー定義FXのSideChain 更新トリガ判定
						if((userfx_params.cnt.1>0.0f)&(int(userfx_params.cnt.1*bpba)>0)&(userfx_params.cnt.1<1.0f)){
							user_beat.cnt=(cnowfx-b2c(c2bnow))/max(int(userfx_params.cnt.1*bpba),1)
						}else:if(userfx_params.cnt.1>=1.0f){
							stat1=b2c(c2bnow)
							user_beat.cnt=int((double(c2bnow)+double(cnowfx-stat1)/(b2c(c2bnow+1)-stat1))/userfx_params.cnt.1)
						}else:user_beat.cnt=0
						if(((user_beat.cnt!=user_beatp.cnt)|(c2bnow!=c2bnowp))&(userfx_params.cnt.1>0.0f)&(userfx_params.cnt.1<1.0f)&((feffectnow.0=100+cnt)|(feffectnow.1=100+cnt)|(cnt>=userfxnum-userfilternum))){
							if(_cnt!=0){
								user_trigger.cnt=1-user_trigger.cnt
								BASS_VST_SetParam_R hFX_User.cnt,0,double(user_trigger.cnt)
							}
						}
					}
					user_beatp.cnt=user_beat.cnt
				loop
				c2bnowp=c2bnow
				c2bnowp_50ms=c2bnow_50ms
			}
		}
		foreach mid
			BASS_ChannelUpdate mid.cnt
		loop
		repeat swaudionum
			BASS_ChannelUpdate mid_sw.cnt
		loop
		peffstatap=peffstata.0,peffstata.1
		canagainp=canagain
		filtertypep=filtertype
		filtertype2p=filtertype2
		if(analogmode=mode_off){
			repeat spinnum
				if((cnow+sttp*adj>=spin.cnt.1)&(cnow+sttp*adj<spin.cnt.1+spin.cnt.2)&(spin.cnt.0!=-1)){
					spinnow.0=spin.cnt.0
					spinnow0p=spin.cnt.0
					spinnow.1=spin.cnt.1
					spinnow.2=spin.cnt.2
					spinnow.3=cnt
				}
			loop
		}
		// 画面回転の計算
		spinangle=0.0f
		spinangles=0.0f
		if(spinnow.0>=0){
			if(spinnow.1+spinnow.2<cnow+sttp*adj){
				spinnow.0=-1
				spinangle=0.0f
			}else:if((spinnow.2>0)&(spinnow.1<=cnow+sttp*adj)){
				if(spinnow.0<2){
					if(((cnow+sttp*adj-bgmouikkaic>bgmouikkai/2)|(bgmouikkai=0))&(spinnow.3>bgmouikkaicnt)){
						bgmouikkaic=cnow+sttp*adj
						bgmouikkai=spinnow.2*75/100
						bgmouikkaia=1-spinnow.0*2
						bgmouikkaicnt=spinnow.3
						bgmouikkaikaisu=2
					}
					spinangle=675.0f*(cnow+sttp*adj-spinnow.1)/spinnow.2
					spinangles=520.0f*(cnow+sttp*adj-spinnow.1)/spinnow.2
					if(spinangle<360.0f){
						spinangle=sin(double(spinangle)*0.75f/360.0f)*360.0f/sin(0.75f)
					}else:if(spinangle<440.0f){
						dstat=sin(deg2rad((spinangle-360.0f)*90.0f/80.0f))
						dstat*=30.0f
						spinangle=360.0f+dstat
					}else{
						dstat=675.0f-spinangle
						dstat*=90.0f
						dstat/=235.0f
						dstat=cos(deg2rad(dstat))*cos(deg2rad(dstat))
						dstat*=30.0f
						spinangle=30.0f-dstat
					}
					spinangle*=1-spinnow.0*2
					spinangles*=1-spinnow.0*2
					spinanglepp=spinangle
				}else{
					if(((cnow+sttp*adj-bgmouikkaic>bgmouikkai/2)|(bgmouikkai=0))&(spinnow.3>bgmouikkaicnt)){
						bgmouikkaic=cnow+sttp*adj
						bgmouikkai=spinnow.2*75/100
						bgmouikkaia=1-(spinnow.0-2)*2
						bgmouikkaicnt=spinnow.3
						bgmouikkaikaisu=1
					}
					spinangle=400.0f*(cnow+sttp*adj-spinnow.1)/spinnow.2
					spinangles=520.0f*(cnow+sttp*adj-spinnow.1)/spinnow.2
					if(spinangle<110.0f){
						spinangle=sin(double(spinangle)*1.8/110)/sin(1.8)*60
					}else:if(spinangle<220.0f){
						spinangle=(cos(double(spinangle-110)*1.8/110)-cos(1.8))/(1.0-cos(1.8))*60
					}else:if(spinangle<310.0f){
						spinangle=-sin(double(spinangle-220)*1.8/90)/sin(1.8)*15
					}else:if(spinangle<400.0f){
						spinangle=-(cos(double(spinangle-310)*1.8/90)-cos(1.8))/(1.0-cos(1.8))*15
					}
					spinangle*=1-(spinnow.0-2)*2
					spinangles*=1-(spinnow.0-2)*2
					spinanglepp=spinangle
				}
			}
			spintp=t+ttp*adj+75*adj3
			spincp=cnow+sttp*adj
		}
		// スコア計算
		tochu=(critical+near+errorn<totalcombo)
		ddim dstat,1
		if(shortnum+shljnum+lshnum+longjnum+analoganjnum+analogjnum>0){
			dstat=double(10000000)/(shortnum+shljnum+lshnum+longjnum+analoganjnum+analogjnum)/2
		}else{
			dstat=0
		}
		if(critical=totalcombo){
			totalscore=10000000
		}else{
			totalscore=int(dstat*(critical*2+near))
		}

		// 表示スコア(推移時間を設ける)
		if(totalscorep!=totalscore){
			totalscore_disp_base=totalscorep
			totalscore_disp_baset=t
		}
		if((t>=totalscore_disp_baset)&(t-totalscore_disp_baset<200)){
			totalscore_disp=totalscore_disp_base+int(double(totalscore-totalscore_disp_base)*(t-totalscore_disp_baset)/200) // 推移中のスコアを表示
		}else{
			totalscore_disp=totalscore // 時間が経っていれば真のスコアを表示
		}
		totalscorep=totalscore

		if(cnt\(frameskip+1)=0){
			// レーン描画
			center_split_now = GetCurrentCamValue(game_system, CAM_CENTER_SPLIT) / 100.0f
			center_split_px = int(center_split_now * bt_width) / 2 / ra
			if((bg>=1)&((lanesubflp=1)|(lanesubfl=1))){
				gsel 51+118*(anaranfl=2)
				gmode 0
				pos 0,0
				if(anaranfl=2){
					color 0,0,0
					boxf
					pos vw/ra/2,0
				}
				pos ginfo_cx-center_split_px,ginfo_cy
				gcopy 47,vw/ra,0,vw/ra/2,vh/ra
				pos ginfo_cx+vw/ra/2+center_split_px*2,ginfo_cy
				gcopy 47,vw/ra+vw/ra/2,0,vw/ra/2,vh/ra
			}
			gsel 5+163*(anaranfl=2)
			gmode 0
			pos 0,0
			if(anaranfl=2){
				color 0,0,0
				boxf
				pos vw/ra/2,0
			}
			pos ginfo_cx-center_split_px,ginfo_cy
			gcopy 47,0,0,vw/ra/2,vh/ra
			pos ginfo_cx+vw/ra/2+center_split_px*2,ginfo_cy
			gcopy 47,vw/ra/2,0,vw/ra/2,vh/ra
			
			// 小節線描画
			beatn=4
			beatd=4
			ddim cbcnt,1
			beatlfcnt=0
			gmode 5,,,110
			stat1_=-500
			repeat
				repeat max(beatlnum-beatlfcnt,0),beatlfcnt
					if(beatl.cnt.0<=cbcnt){
						beatn=beatl.cnt.1
						beatd=beatl.cnt.2
						beatlfcnt=cnt+1
					}
				loop
				if(cbcnt>=cnow-bpba_4){
					stat1=-(hsrc(int(cbcnt),-1)*10*hs/bpba-vh+24)/ra
					if(stat1!=stat1_){
						pos xsh/ra+(anaranfl=2)*vw/ra/2-center_split_px,stat1
						gcopy 15,0,0,220/ra/2,16/ra
						pos ginfo_cx+220/ra/2+center_split_px*2,ginfo_cy
						gcopy 15,220/ra/2,0,220/ra/2,16/ra
						if(stat1<0):break
						stat1_=stat1
					}
				}
				cbcnt+=double(bpba)*beatn/beatd
			loop

			// レーン光沢アニメーションの描画
			repeat 4
				gmode 5,,,255
				pos (8+xsh)/ra+(anaranfl=2)*vw/ra/2-center_split_px,(300*cnt+300*((t+10000)\200)/200)/ra
				gcopy 34,0,0,210/ra/2,64/ra
				pos ginfo_cx+210/ra/2+center_split_px*2,ginfo_cy
				gcopy 34,210/ra/2,0,210/ra/2,64/ra
			loop

			// ショート/ロングオブジェクトの描画
			// ロングFX
			repeat 2,4
				gsel 5+163*(anaranfl=2)
				tcnt=cnt
				i=notefcnt.tcnt
				repeat
					//notecnt++
					if((i<0)|(i>=notenum)):break
					if(note.i.0!=tcnt){
						i++
						notefcnt.tcnt=i
						continue
					}
					if(note.i.1+note.i.2<cnow-bpba_4){
						notefcnt.tcnt=note.i.5
						i=note.i.5
						continue
					}
					if(note.i.2>0){
						hsrc1=hsrc(note.i.1,note.i.3)
						if(hsrc1>bpba*(vh+20)/10/hs){
							break
						}
						gmode 2
						hsrc12=hsrc(note.i.1+note.i.2,note.i.4)
						stat1=max(((hsrc12*hs*10/bpba)-(hsrc1*hs*10/bpba))/ra/*-6/ra*/,1)
						stat3=max(0,(hsrc1*10*hs/bpba)/ra+16/ra-vh/ra-7/ra+stat1)
						stat4=max(0,-(hsrc1*10*hs/bpba)/ra-16/ra+7/ra)
						gsel 5+163*(anaranfl=2)
						pos (bt_xsh+(note.i.0-4)*fx_width)/ra+(anaranfl=2)*vw/ra/2+center_split_px*((note.i.0-4)*2-1), -(hsrc1*10*hs/bpba)/ra+vh/ra-16/ra+7/ra-stat1+stat3-slshift
						if(stat1-stat3-stat4>0){
							stat2=note.i.3-t
							if((arstat.(note.i.0).2=i)&(stat2<=50)&(ljudge.(note.i.0-4)=0)){
								gcopy 150,0,0,82/ra,stat1-stat3-stat4
							}else:if((arstat.(note.i.0).2=i)&(stat2<=50)&(ljudge.(note.i.0-4)=1)&((t\100)<50)){
								gcopy 150,82/ra,0,82/ra,stat1-stat3-stat4
							}else:if((arstat.(note.i.0).2=i)&(stat2<=50)&(ljudge.(note.i.0-4)=1)){
								gcopy 150,82/ra*2,0,82/ra,stat1-stat3-stat4
							}else{
								gcopy 150,82/ra*3,0,82/ra,stat1-stat3-stat4
							}
							if(bg>=1){
								gsel 51+118*(anaranfl=2)
								gmode 6,,,256
								lanesubfl=1
								gsel 5+163*(anaranfl=2)
							}
							pos ginfo_cx, -(hsrc1*10*hs/bpba)/ra+vh/ra-16/ra+7/ra-stat1-slshift
							gcopy 1,0,9,82/ra,1
							pos ginfo_cx, -(hsrc1*10*hs/bpba)/ra+vh/ra-6/ra-16/ra+7/ra-slshift
							gcopy 156,0,0,82/ra,7/ra
						}
					}
					i=note.i.5
				loop
			loop
			// ロングBT
			repeat 4
				gsel 5+163*(anaranfl=2)
				tcnt=cnt
				i=notefcnt.tcnt
				repeat
					//notecnt++
					if((i<0)|(i>=notenum)):break
					if(note.i.0!=tcnt){
						i++
						notefcnt.tcnt=i
						continue
					}
					if(note.i.1+note.i.2<cnow-bpba_4){
						notefcnt.tcnt=note.i.5
						i=note.i.5
						continue
					}
					if(note.i.2>0){
						hsrc1=hsrc(note.i.1,note.i.3)
						if(hsrc1>bpba*(vh+20)/10/hs){
							break
						}
						hsrc12=hsrc(note.i.1+note.i.2,note.i.4)
						stat1=max(((hsrc12*hs*10/bpba)-(hsrc1*hs*10/bpba))/ra/*-6/ra*/,1)
						stat3=max(0,(hsrc1*10*hs/bpba)/ra+16/ra-vh/ra-7/ra+stat1)
						stat4=max(0,-(hsrc1*10*hs/bpba)/ra-16/ra+7/ra)
						if(stat1-stat3-stat4>0){
							gsel 5+163*(anaranfl=2)
							gmode 5,,,255
							pos (bt_xsh+note.i.0*bt_width)/ra+(anaranfl=2)*vw/ra/2+center_split_px*(note.i.0/2*2-1), -(hsrc1*10*hs/bpba+16)/ra+vh/ra+7/ra-stat1+stat3-slshift
							stat2=note.i.3-t
							if((arstat.(note.i.0).2=i)&(stat2<=50)&(shljudge.(note.i.0)=0)){
								gcopy 151,0,0,40/ra,stat1-stat3-stat4
							}else:if((arstat.(note.i.0).2=i)&(stat2<=50)&(shljudge.(note.i.0)=1)&((t\100)<50)){
								gcopy 151,80/ra,0,40/ra,stat1-stat3-stat4
							}else:if((arstat.(note.i.0).2=i)&(stat2<=50)&(shljudge.(note.i.0)=1)){
								gcopy 151,80/ra*2,0,40/ra,stat1-stat3-stat4
							}else{
								gcopy 151,80/ra*3,0,40/ra,stat1-stat3-stat4
							}
							if(bg>=1){
								gsel 51+118*(anaranfl=2)
								gmode 6,,,256
								pos (bt_xsh+note.i.0*bt_width)/ra+(anaranfl=2)*vw/ra/2+center_split_px*(note.i.0/2*2-1), -(hsrc1*10*hs/bpba+16)/ra+vh/ra+7/ra-stat1+stat3-slshift
								if((arstat.(note.i.0).2=i)&(stat2<=50)&(shljudge.(note.i.0)=0)){
									gcopy 151,40/ra,0,40/ra,stat1-stat3-stat4
								}else:if((arstat.(note.i.0).2=i)&(stat2<=50)&(shljudge.(note.i.0)=1)&((t\100)<50)){
									gcopy 151,80/ra+40/ra,0,40/ra,stat1-stat3-stat4
								}else:if((arstat.(note.i.0).2=i)&(stat2<=50)&(shljudge.(note.i.0)=1)){
									gcopy 151,80/ra*2+40/ra,0,40/ra,stat1-stat3-stat4
								}else{
									gcopy 151,80/ra*3+40/ra,0,40/ra,stat1-stat3-stat4
								}
								lanesubfl=1
							}
							gmode 2
							pos ginfo_cx, -(hsrc1*10*hs/bpba-vh+16)/ra-slshift
							gcopy 157,0,0,40/ra,7/ra
							gmode 0
							if(bg>=1){
								gsel 51+118*(anaranfl=2)
								gmode 2
								pos ginfo_cx,-(hsrc1*10*hs/bpba-vh+16)/ra-slshift
								gcopy 2,40/ra,0,40/ra,7/ra
								gmode 0
								lanesubfl=1
							}
						}
					}
					i=note.i.5
				loop
			loop
			// チップFX
			repeat 2,4
				gsel 5+163*(anaranfl=2)
				tcnt=cnt
				i=notefcnt.tcnt
				repeat
					//notecnt++
					if((i<0)|(i>=notenum)):break
					if(note.i.0!=tcnt){
						i++
						notefcnt.tcnt=i
						continue
					}
					if(note.i.1+note.i.2<cnow-bpba_4){
						notefcnt.tcnt=note.i.5
						i=note.i.5
						continue
					}
					if(note.i.2=0){
						hsrc1=hsrc(note.i.1,note.i.3)
						if(hsrc1>bpba*(vh+20)/10/hs){
							break
						}
						gmode 7
						pos (bt_xsh+(note.i.0-4)*fx_width)/ra+(anaranfl=2)*vw/ra/2+center_split_px*((note.i.0-4)*2-1), (-hsrc1*10*hs/bpba+vh-16+2-1)/ra-slshift
						if(notese.i=-1){
							gcopy 43,0,(hsrc1*10*hs/bpba*8/vh*40)/ra,82/ra,40/ra
						}else{
							gcopy 186,0,(hsrc1*10*hs/bpba*8/vh*40)/ra,82/ra,40/ra
						}
					}
					i=note.i.5
				loop
			loop
			// チップBT
			repeat 4
				gsel 5+163*(anaranfl=2)
				tcnt=cnt
				i=notefcnt.tcnt
				repeat
					//notecnt++
					if((i<0)|(i>=notenum)):break
					if(note.i.0!=tcnt){
						i++
						notefcnt.tcnt=i
						continue
					}
					if(note.i.1+note.i.2<cnow-bpba_4){
						notefcnt.tcnt=note.i.5
						i=note.i.5
						continue
					}
					if(note.i.2=0){
						hsrc1=hsrc(note.i.1,note.i.3)
						if(hsrc1>bpba*(vh+20)/10/hs){
							break
						}
						gsel 5+163*(anaranfl=2)
						gmode 7
						pos (bt_xsh+note.i.0*bt_width)/ra+(anaranfl=2)*vw/ra/2+center_split_px*(note.i.0/2*2-1), (-hsrc1*10*hs/bpba-16+2+vh)/ra-slshift
						gcopy 53+min(max((hsrc1*10*hs/bpba*8/vh),0),7)*9+note.i.6,0,0,40/ra,40/ra
					}
					i=note.i.5
				loop
			loop
			// 判定の描画
			gsel 5+163*(anaranfl=2)
			repeat 4
				if(((shortmode!=mode_auto)&(judge.cnt.1>0))|((shortmode=mode_auto)&(judge.cnt.1=3))){
					if((t-judge.cnt.0)>155){
						judge.cnt.1=0
						continue
					}
					pos (bt_xsh+bt_width*cnt)/ra+(anaranfl=2)*vw/ra/2+center_split_px*(cnt/2*2-1),(vh-300)/ra
					if((t-judge.cnt.0)<75){
						gmode 5,,,220
						pos ginfo_cx+(20-(t-judge.cnt.0)*20/75)/ra,ginfo_cy
						gcopy 9,(40*judge.cnt.1-40+20-(t-judge.cnt.0)*20/75)/ra,0,(t-judge.cnt.0)*40/75/ra,300/ra
					}else{
						gmode 5,,,220+(judge.cnt.0-t+75)*220/80
						gcopy 9,(40*judge.cnt.1-40)/ra,0,40/ra,300/ra
					}
				}
			loop
			repeat 2,4
				if(((longmode!=mode_auto)&(judge.cnt.1>0))|((longmode=mode_auto)&(judge.cnt.1=3))){
					if((t-judge.cnt.0)>155){
						judge.cnt.1=0
						continue
					}
					pos (bt_xsh+(cnt-4)*fx_width)/ra+(anaranfl=2)*vw/ra/2+center_split_px*((cnt-4)*2-1),(vh-300)/ra
					if((t-judge.cnt.0)<75){
						gmode 5,,,200
						pos ginfo_cx+(41-(t-judge.cnt.0)*41/75)/ra,ginfo_cy
						gcopy 44,(82*judge.cnt.1-82+41-(t-judge.cnt.0)*41/75)/ra,0,(t-judge.cnt.0)*82/75/ra,300/ra
					}else{
						gmode 5,,,200+(judge.cnt.0-t+75)*220/80
						gcopy 44,(82*judge.cnt.1-82)/ra,0,82/ra,300/ra
					}
				}
			loop
			// アナログデバイスの描画
			gsel 5+163*(anaranfl=2)
			gmode 5,,,255
			repeat 2
				cnt0=cnt
				colfl=0
				for i,analogfcnt.cnt0,analognum
					if(analog.i.0!=cnt0){
						_continue
					}else:if(colfl=0):analogfcnt.cnt0=i:colfl=1
					hsrc12=hsrc(analog.i.1+analog.i.2+(analog.i.2<=bpba_32)+sttp*(adj=0),analog.i.7+ttp*(adj=0)+75*adj3)
					analogcnt++
					if(hsrc12<-bpba_2){
						analogfcnt.(analog.i.0)=i+1
						_continue
					}
					hsrc1=hsrc(analog.i.1+sttp*(adj=0),analog.i.6+ttp*(adj=0)+75*adj3)
					if((hsrc1>bpba*(vh+200)/(10*hs))&(colfl=1)){
						_break
					}
					stat1=(((abs(analogpos.(analog.i.0)-analognow.(analog.i.0))<100+abs(analognow.(analog.i.0)-analogfuture.(analog.i.0))/24*(analogfuture.(analog.i.0)!=-1))&(analognow.(analog.i.0)!=-1))|(analogmode=mode_auto)|(t-analoganokt.(analog.i.0)<=50)|(t-analogokt.(analog.i.0)<(t_tp)*5+(analogfuture.(analog.i.0)!=-1)*abs(analogfuture.(analog.i.0)-analognow.(analog.i.0))/20))&(analognow.(analog.i.0)!=-1)&(analogmode!=mode_off)&(analoggr.i=analoggr.(arstat.(6+analog.i.0).1))
					if(analog.i.5=1){
						gsel 5+163*(anaranfl=2)
						gmode 5,,,255
						pos (analogxsh+((analog.i.3*(anagrran.(analog.i.0).(analoggr.i))-25*(anagrran.(analog.i.0).(analoggr.i)=2))*4+4*((analog.i.3=12)|(analog.i.3=37))*(anagrran.(analog.i.0).(analoggr.i)=2)-10)*analograte/100)/ra+(anaranfl=2)*vw/ra/2,(-hsrc1*10*hs/bpba+vh-15)/ra
						gcopy 152,44/ra*analog.i.0*2,0,44/ra,200/ra
						if(bg>=1){
							gsel 51+118*(anaranfl=2)
							gmode 5,,,255
							pos (analogxsh+((analog.i.3*(anagrran.(analog.i.0).(analoggr.i))-25*(anagrran.(analog.i.0).(analoggr.i)=2))*4+4*((analog.i.3=12)|(analog.i.3=37))*(anagrran.(analog.i.0).(analoggr.i)=2)-10)*analograte/100)/ra+(anaranfl=2)*vw/ra/2,(-hsrc1*10*hs/bpba+vh-15)/ra
							gcopy 152,44/ra*analog.i.0*2+44/ra,0,44/ra,200/ra
						}
					}
					gmode 5,,,255
					if((analog.i.3!=analog.i.4)&(analog.i.2<=bpba_32)){
						// 直角(横棒)
						stat1_=min((analog.i.3*(anagrran.(analog.i.0).(analoggr.i))-25*(anagrran.(analog.i.0).(analoggr.i)=2)+((analog.i.3=12)|(analog.i.3=37))*(anagrran.(analog.i.0).(analoggr.i)=2)),(analog.i.4*(anagrran.(analog.i.0).(analoggr.i))-25*(anagrran.(analog.i.0).(analoggr.i)=2)+((analog.i.4=12)|(analog.i.4=37))*(anagrran.(analog.i.0).(analoggr.i)=2)))*4+26
						stat2_=max((analog.i.3*(anagrran.(analog.i.0).(analoggr.i))-25*(anagrran.(analog.i.0).(analoggr.i)=2)+((analog.i.3=12)|(analog.i.3=37))*(anagrran.(analog.i.0).(analoggr.i)=2)),(analog.i.4*(anagrran.(analog.i.0).(analoggr.i))-25*(anagrran.(analog.i.0).(analoggr.i)=2)+((analog.i.4=12)|(analog.i.4=37))*(anagrran.(analog.i.0).(analoggr.i)=2)))*4-21
						sx1=stat1_,stat2_,stat2_,stat1_
						sy1=-hsrc1*10*hs/bpba+vh-10,-hsrc1*10*hs/bpba+vh-10,-hsrc12*10*hs/bpba+vh-10,-hsrc12*10*hs/bpba+vh-10
					}else{
						sx1=(analog.i.3*(anagrran.(analog.i.0).(analoggr.i))-25*(anagrran.(analog.i.0).(analoggr.i)=2))*4+4*((analog.i.3=12)|(analog.i.3=37))*(anagrran.(analog.i.0).(analoggr.i)=2)-22,(analog.i.4*(anagrran.(analog.i.0).(analoggr.i))-25*(anagrran.(analog.i.0).(analoggr.i)=2))*4+4*((analog.i.4=12)|(analog.i.4=37))*(anagrran.(analog.i.0).(analoggr.i)=2)-22,(analog.i.4*(anagrran.(analog.i.0).(analoggr.i))-25*(anagrran.(analog.i.0).(analoggr.i)=2))*4+4*((analog.i.4=12)|(analog.i.4=37))*(anagrran.(analog.i.0).(analoggr.i)=2)+22,(analog.i.3*(anagrran.(analog.i.0).(analoggr.i))-25*(anagrran.(analog.i.0).(analoggr.i)=2))*4+4*((analog.i.3=12)|(analog.i.3=37))*(anagrran.(analog.i.0).(analoggr.i)=2)+22
						sy1=-hsrc1*10*hs/bpba+vh-10,-hsrc12*10*hs/bpba+vh-10,-hsrc12*10*hs/bpba+vh-10,-hsrc1*10*hs/bpba+vh-10
					}
					sx1=analogxsh+round(double(sx1.0)*analograte/100)+10,analogxsh+round(double(sx1.1)*analograte/100)+10,analogxsh+round(double(sx1.2)*analograte/100)+10,analogxsh+round(double(sx1.3)*analograte/100)+10
					sy1=sy1.0-5,sy1.1-5,sy1.2-5,sy1.3-5
					sx2=48*analog.i.0,48*analog.i.0,48+48*analog.i.0,48+48*analog.i.0
					if(stat1=1){
						_sy2=(t\120<60)+1,(t\120<60)+1,(t\120<60)+1,(t\120<60)+1
					}else:if((analognow.(analog.i.0)!=-1)&(analoggr.(arstat.(6+analog.i.0).1)=analoggr.i)&(analogmode!=mode_off)){
						_sy2=3,3,3,3
					}else{
						_sy2=0,0,0,0
					}
					gsel 5+163*(anaranfl=2)
					gmode 5,,,255
					sy2=(_sy2.0+1)*48-1,(_sy2.1+1)*48-1,(_sy2.2+1)*48-1,(_sy2.3+1)*48-1
					if((analog.i.3!=analog.i.4)&(analog.i.2<=bpba_32)){
						if(sy1.0/ra-sy1.2/ra>0){
							// 直角(角)
							if(chobufp.(analog.i.0*2+(analog.i.3<analog.i.4))!=sy1.0/ra-sy1.2/ra){
								buffer 160+(analog.i.0*2+(analog.i.3<analog.i.4)),48/ra,(sy1.0/ra-sy1.2/ra)*4
								if(analog.i.3<analog.i.4){
									pos 0,0
									gzoom 48/ra,(sy1.0/ra-sy1.2/ra)*4,4,48-48*analog.i.0,0,48,48*4
								}else{
									pos 0,(sy1.0/ra-sy1.2/ra)*4-1
									gzoom 48/ra,(-sy1.0/ra+sy1.2/ra)*4,4,48-48*analog.i.0,0,48,48*4
								}
								buffer 164+(analog.i.0*2+(analog.i.3<analog.i.4)),48/ra,(sy1.0/ra-sy1.2/ra)*4
								if(analog.i.3<analog.i.4){
									pos 0,(sy1.0/ra-sy1.2/ra)*4-1
									gzoom 48/ra,(-sy1.0/ra+sy1.2/ra)*4,154,48*analog.i.0,0,48,48*4
								}else{
									pos 0,0
									gzoom 48/ra,(sy1.0/ra-sy1.2/ra)*4,154,48*analog.i.0,0,48,48*4
								}
								if(bg>=1){
									buffer 173+(analog.i.0*2+(analog.i.3<analog.i.4)),48/ra,(sy1.0/ra-sy1.2/ra)*4
									if(analog.i.3<analog.i.4){
										pos 0,0
										gzoom 48/ra,(sy1.0/ra-sy1.2/ra)*4,172,48-48*analog.i.0,0,48,48*4
									}else{
										pos 0,(sy1.0/ra-sy1.2/ra)*4-1
										gzoom 48/ra,(-sy1.0/ra+sy1.2/ra)*4,172,48-48*analog.i.0,0,48,48*4
									}
									buffer 177+(analog.i.0*2+(analog.i.3<analog.i.4)),48/ra,(sy1.0/ra-sy1.2/ra)*4
									if(analog.i.3<analog.i.4){
										pos 0,(sy1.0/ra-sy1.2/ra)*4-1
										gzoom 48/ra,(-sy1.0/ra+sy1.2/ra)*4,171,48*analog.i.0,0,48,48*4
									}else{
										pos 0,0
										gzoom 48/ra,(sy1.0/ra-sy1.2/ra)*4,171,48*analog.i.0,0,48,48*4
									}
								}
								chobufp.(analog.i.0*2+(analog.i.3<analog.i.4))=sy1.0/ra-sy1.2/ra
							}
							gsel 5+163*(anaranfl=2)
							gmode 5,,,255
							pos sx1.0/ra-48/ra+(anaranfl=2)*vw/ra/2,sy1.2/ra
							gcopy 160+(analog.i.0*2+(analog.i.3<analog.i.4)),0,(sy1.0/ra-sy1.2/ra)*(_sy2.0*(analog.i.3<analog.i.4)+(3-_sy2.0)*(analog.i.3>analog.i.4)),48/ra,sy1.0/ra-sy1.2/ra
							pos sx1.1/ra+(anaranfl=2)*vw/ra/2,sy1.2/ra
							gcopy 164+(analog.i.0*2+(analog.i.3<analog.i.4)),0,(sy1.0/ra-sy1.2/ra)*(_sy2.0*(analog.i.3>analog.i.4)+(3-_sy2.0)*(analog.i.3<analog.i.4)),48/ra,sy1.0/ra-sy1.2/ra
							if(bg>=1){
								gsel 51+118*(anaranfl=2)
								pos sx1.0/ra-48/ra+(anaranfl=2)*vw/ra/2,sy1.2/ra
								gcopy 173+(analog.i.0*2+(analog.i.3<analog.i.4)),0,(sy1.0/ra-sy1.2/ra)*(_sy2.0*(analog.i.3<analog.i.4)+(3-_sy2.0)*(analog.i.3>analog.i.4)),48/ra,sy1.0/ra-sy1.2/ra
								pos sx1.1/ra+(anaranfl=2)*vw/ra/2,sy1.2/ra
								gcopy 177+(analog.i.0*2+(analog.i.3<analog.i.4)),0,(sy1.0/ra-sy1.2/ra)*(_sy2.0*(analog.i.3>analog.i.4)+(3-_sy2.0)*(analog.i.3<analog.i.4)),48/ra,sy1.0/ra-sy1.2/ra
							}
						}
					}
					gsel 5+163*(anaranfl=2)
					repeat 4
						sx1.cnt/=ra
						sy1.cnt/=ra
					loop
					if(((sy1.0>=0)|(sy1.1>=0)|(sy1.2>=0)|(sy1.3>=0))){
						// 0…左下
						// 1…左上
						// 2…右上
						// 3…右下
						if((analog.i.3=analog.i.4)|(analog.i.2>bpba_32)){
							dim sx1_,2
							if((sy1.1<0)&(sy1.1=sy1.2)&(sy1.1-sy1.0!=0)&(sy1.2-sy1.3!=0)){
								sx1_.0=sy1.1*(sx1.0-sx1.1)/(sy1.1-sy1.0)+sx1.1
								sx1_.1=sy1.2*(sx1.3-sx1.2)/(sy1.2-sy1.3)+sx1.2
							}
							// 下にはみ出している場合
							if((sy1.0>vh/ra)&(sy1.0=sy1.3)&(sy1.1-sy1.0!=0)&(sy1.2-sy1.3!=0)){
								sx1.0=(sy1.1-vh/ra)*(sx1.0-sx1.1)/(sy1.1-sy1.0)+sx1.1
								sx1.3=(sy1.2-vh/ra)*(sx1.3-sx1.2)/(sy1.2-sy1.3)+sx1.2
								sy1.0=vh/ra
								sy1.3=vh/ra
							}
							// 上にはみ出している場合
							if((sy1.1<0)&(sy1.1=sy1.2)){
								sx1.1=sx1_.0
								sx1.2=sx1_.1
								sy1.1=0
								sy1.2=0
							}
						}
						repeat 4
							sx1.cnt+=(anaranfl=2)*vw/ra/2
						loop
						gsquare 154,sx1,sy1,sx2,sy2
						if(bg>=1){
							gsel 51+118*(anaranfl=2)
							gmode 5,,,255
							gsquare 171,sx1,sy1,sx2,sy2
						}
					}
					sx2=48*analog.i.0,48*analog.i.0,47+48*analog.i.0,47+48*analog.i.0
					f=0
					stat2=0
					stat3=-1
					gsel 5+163*(anaranfl=2)
					f=analog.i.8
					if((analog.i.3!=analog.i.4)&(analog.i.2<=bpba_32)&(f=1)){
						hsrc2=-hsrc(analog.i.1+analog.i.2+bpba*2/32,-1)
						sx1=(analog.i.4*(anagrran.(analog.i.0).(analoggr.i))-25*(anagrran.(analog.i.0).(analoggr.i)=2))*4-24,(analog.i.4*(anagrran.(analog.i.0).(analoggr.i))-25*(anagrran.(analog.i.0).(analoggr.i)=2))*4-24,(analog.i.4*(anagrran.(analog.i.0).(analoggr.i))-25*(anagrran.(analog.i.0).(analoggr.i)=2))*4+24,(analog.i.4*(anagrran.(analog.i.0).(analoggr.i))-25*(anagrran.(analog.i.0).(analoggr.i)=2))*4+24
						sy1=-hsrc12*10*hs/bpba+vh,hsrc2*10*hs/bpba+vh,hsrc2*10*hs/bpba+vh,-hsrc12*10*hs/bpba+vh
						sx1=analogxsh+sx1.0*analograte/100+10,analogxsh+sx1.1*analograte/100+10,analogxsh+sx1.2*analograte/100+10,analogxsh+sx1.3*analograte/100+10
						sy1=sy1.0-15,sy1.1-15,sy1.2-15,sy1.3-15
						repeat 4
							sx1.cnt/=ra
							sy1.cnt/=ra
						loop
						repeat 4
							sx1.cnt+=(anaranfl=2)*vw/ra/2
						loop
						if((sx1.0>=0)|(sx1.1>=0)|(sx1.2>=0)|(sx1.3>=0)|(sy1.0>=0)|(sy1.1>=0)|(sy1.2>=0)|(sy1.3>=0)){
							gsquare 154,sx1,sy1,sx2,sy2
							if(bg>=1){
								gsel 51+118*(anaranfl=2)
								gmode 5,,,255
								gsquare 171,sx1,sy1,sx2,sy2
							}
						}
					}
					gsel 5+163*(anaranfl=2)
					gmode 0
				next
			loop

			// 判定の描画2
			if((cnow+sttp*adj-spincp<spinnow.2*75/200)&(cnow+sttp*adj-spincp>0)&(spinnow.2>0)){
				dstat=sin(deg2rad(180*(cnow+sttp*adj-spincp)/(spinnow.2*75/200)))*sin(deg2rad(180*(cnow+sttp*adj-spincp)/(spinnow.2*75/200)))*7
				mouikkai=int(dstat)*((1-spinnow0p*2)*(spinnow0p/2=0)+(1-(spinnow0p-2)*2)*(spinnow0p/2=1))
			}else{
				mouikkai=0
			}
			dstat=spinangles*360.0f/520.0f
			dstat=sin(deg2rad(dstat))
			dstat*=20*(1-2*(spinnow0p/2=1))
			gsel 155+15*(anaranfl=2)
			color 0,0,0
			boxf
			gmode 5,,,255
			repeat 6
				cnt0=cnt
				repeat judgelmax,judgelnext.cnt0
					cnt2=cnt\judgelmax
					if(judgel.cnt0.cnt2.1=0):continue
					if(t-judgel.cnt0.cnt2.0>=500):judgelnext.cnt0=(cnt2+1)\judgelmax:continue
					if(t-judgel.cnt0.cnt2.0<0):break
					if(cnt0<=3){
						pos (92+60*cnt0)*scrsize_h/480+(anaranfl=2)*judgel_winx/2+int(center_split_now*60)/2*(cnt0/2*2-1),getsize(17)
					}else{
						pos (92+30+120*(cnt0-4))*scrsize_h/480+(anaranfl=2)*judgel_winx/2+int(center_split_now*60)/2*((cnt0-4)*2-1),getsize(17)
					}
					if((t-judgel.cnt0.cnt2.0<500)&(judgel.cnt0.cnt2.1=4)){
						gcopy 17,getsize(86),getsize(86)*((t-judgel.cnt0.cnt2.0)*12/500),getsize(86),getsize(86)
					}else:if((t-judgel.cnt0.cnt2.0<500)&(judgel.cnt0.cnt2.1=3)){
						gcopy 16,0,getsize(86)*((t-judgel.cnt0.cnt2.0)*12/500),getsize(86),getsize(86)
					}else:if((t-judgel.cnt0.cnt2.0<500)&(judgel.cnt0.cnt2.1=2)){
						gcopy 17,0,getsize(86)*((t-judgel.cnt0.cnt2.0)*12/500),getsize(86),getsize(86)
					}else:if((t-judgel.cnt0.cnt2.0<500)&(judgel.cnt0.cnt2.1=1)){
						gcopy 18,0,getsize(86)*((t-judgel.cnt0.cnt2.0)*12/500),getsize(86),getsize(86)
					}
				loop
			loop
			repeat 4
				if(t-shlstartt.cnt>=0){
					pos (92-17+60*cnt)*scrsize_h/480+(anaranfl=2)*judgel_winx/2+int(center_split_now*60)/2*(cnt/2*2-1),getsize(20)/2
					if((t-shlstartt.cnt<500)&(shljudge.cnt=1)){
						gcopy 45,0,getsize(120)*((t-shlstartt.cnt)*8/500),getsize(120),getsize(120)
					}else:if(shljudge.cnt=1){
						gcopy 45,0,getsize(120)*(9+((t-shlstartt.cnt-500)\1625)*26/1625),getsize(120),getsize(120)
					}else{
						if(shljudgep.cnt=1){
							shljudgeendt.cnt=t
						}
						if(t-shljudgeendt.cnt<500){
							gcopy 45,0,getsize(120)*(34+(t-shljudgeendt.cnt)*8/500),getsize(120),getsize(120)
						}
					}
				}
			loop
			repeat 2
				if(t-lstartt.cnt>=0){
					pos (96+120*cnt)*scrsize_h/480+(anaranfl=2)*judgel_winx/2+int(center_split_now*60)/2*(cnt*2-1),0
					if((t-lstartt.cnt<500)&(ljudge.cnt=1)){
						gcopy 30,0,getsize(140)*((t-lstartt.cnt)*8/500),getsize(140),getsize(140)
					}else:if(ljudge.cnt=1){
						gcopy 30,0,getsize(140)*(9+(((t-lstartt.cnt-500)\1625)*26/1625)),getsize(140),getsize(140)
					}else{
						if(ljudgep.cnt=1){
							ljudgeendt.cnt=t
						}
						if(t-ljudgeendt.cnt<500){
							gcopy 30,0,getsize(140)*(34+(t-ljudgeendt.cnt)*8/500),getsize(140),getsize(140)
						}
					}
				}
			loop
			if((analogmode=mode_auto)|(analogmode=mode_off)){
				repeat 2
					if(analognow.cnt!=-1):analogpos.cnt=analognow.cnt
				loop
			}
			// アナログデバイスのカーソルを表示
			dim analogvpos,2
			repeat 2
				if(arstat.(6+cnt).0=1){
					if((canalognow.cnt!=-1)&(abs(analogpos.cnt-analognow.cnt)<35+abs(analognow.cnt-analogfuture.cnt)/24*(analogfuture.cnt!=-1))){
						stat1=((canalognow.cnt*anarannow(cnt)-500*(anarannow(cnt)=2))*scrsize_h*59/200)/480
						analogvpos.cnt=canalognow.cnt
						analogstatp.cnt=1
					}else{
						stat1=((analogpos.cnt*anarannow(cnt)-500*(anarannow(cnt)=2))*scrsize_h*59/200)/480
						analogvpos.cnt=analogpos.cnt
						analogstatp.cnt=0
					}
					if((abs(analogposp.cnt-analognowp.cnt)<100+abs(analognow.cnt-analogfuture.cnt)/24*(analogfuture.cnt!=-1))&(analognow.cnt!=-1)){
						pos stat1+getsize(22)+(anaranfl=2)*judgel_winx/2,getsize(17)
						gcopy 50,getsize(100)*cnt,getsize(100)*((t\1200)*26/1200),getsize(100),getsize(100)
					}
				}
			loop
			// アナログデバイスのエフェクトを描画
			repeat 2
				if((analognowp.cnt!=-1)&((abs(analogposp.cnt-analognowp.cnt)<100)|(analogmode=mode_auto))&((anadirection.cnt!=anadirectionp.cnt)|(analognow.cnt=-1))){
					if(analognow.cnt=-1){
						analogefft.cnt.(analogefftnum.cnt).0=t
						analogefft.cnt.(analogefftnum.cnt).1=analognowp.cnt*anarannowp(cnt)-500*(anarannowp(cnt)=2)
					}else{
						analogefft.cnt.(analogefftnum.cnt).0=tp
						analogefft.cnt.(analogefftnum.cnt).1=analognowp.cnt*anarannowp(cnt)-500*(anarannowp(cnt)=2)
					}
					analogefftnum.cnt++
				}
			loop
			gmode 5,,,130
			repeat 2
				cnt2=cnt
				repeat max(analogefftnum.cnt2-analogefffcnt.cnt2-1,0),analogefffcnt.cnt2+1
					if(t-analogefft.cnt2.cnt.0<90){
						pos (analogefft.cnt2.cnt.1*scrsize_h*30/100)/480+(anaranfl=2)*judgel_winx/2,getsize(17)
						gcopy 41,getsize(172)*cnt2,(t-analogefft.cnt2.cnt.0)/30*86*scrsize_h/480,getsize(172),getsize(86)
					}else:if(t-analogefft.cnt2.cnt.0<170){
						pos (analogefft.cnt2.cnt.1*scrsize_h*30/100)/480+(anaranfl=2)*judgel_winx/2,getsize(17)
						gcopy 41,getsize(172)*cnt2,(3+(t-analogefft.cnt2.cnt.0-90)/40)*86*scrsize_h/480,getsize(172),getsize(86)
					}else{
						analogefffcnt.cnt2=cnt
						continue
					}
				loop
				if(analogefftnum.cnt2-analogefffcnt.cnt2-1>4):analogefffcnt.cnt2=analogefftnum.cnt2-5
			loop
			if(anaranfl=2){
				settex judgel_winx*2,judgel_winy,0,tex_judgel2x
			}else:settex judgel_winx,judgel_winy,0,tex_judgel

			// レーン傾きの数値指定の計算
			ddim ztiltnow,1
			ddim ztiltnow2,1
			ztiltnow2 = GetCurrentCamValue(game_system, CAM_MANUAL_TILT) * romax
			if(cnt=0):ztiltnowp=ztiltnow2
			ztiltnow=ztiltnow2*min(max(t_tp,1),ztilttime)/ztilttime+ztiltnowp*(ztilttime-min(max(t_tp,1),ztilttime))/ztilttime
			ztiltrate=1.0f*ztilton*min(max(t_tp,1),ztiltontime)/ztiltontime+ztiltratep*(ztiltontime-min(max(t_tp,1),ztiltontime))/ztiltontime

			// 背景描画
			bgnow=((((effratetype<=0)&(iscourse=0))&(100*gauge/gaugemax>=70))+(((effratetype>0)|(iscourse=1))&(gauge/1000>=30)))
			if((bg>=1)&((bgnow!=bgnowp)|(cnt=3))){
				if(bgnow=1){
					setobjmodel obj_bg,mod_bg1
				}else:setobjmodel obj_bg,mod_bg0
			}
			if(bg>=1){
				if(cnt=0):setobjmodel obj_bg,mod_bg1
				if(cnt=1):setobjmodel obj_bg,mod_bg0
			}
			if(bg>=1):setang obj_bg,0.0f,0.0f,deg2rad(ror*minf(tiltrnow,14.0f)/1000/3)
			if(bg>=2){
				stat1=0
				if((bgmouikkai!=0)&(cnow+sttp*adj-bgmouikkaic<bgmouikkai)):stat1=int(sin(double(cnow+sttp*adj-bgmouikkaic)/bgmouikkai*1.1)/sin(1.1)*360*bgmouikkaikaisu*bgmouikkaia)
				// アニメーション描画
				if(bgspeed=0){
					layernow=(cnow-cnowstart)/350\layermax
				}else{
					if(bgspeed>0){
						layernow=((t+3400+1000*(cmovfile!=""))\bgspeed)*layermax/bgspeed
					}else{
						layernow=layermax-1-((t+3400+1000*(cmovfile!=""))\abs(bgspeed))*layermax/abs(bgspeed)
					}
				}
				layernow=max(layernow,0)
				if(layernow/3!=layernowp/3):setobjmodel obj_layer,mod_layer.(layernow/3)
				if(layernow\3!=layernowp\3):setevent obj_layer,ev_layeruv.bgnow.(layernow\3),0
				setang obj_layer,0.0f,0.0f,deg2rad((ror*0.8*minf(tiltrnow,14.0)/1000*(1.0f-ztiltrate)+ztiltnow*ztiltrate)*((bgrotation=1)|(bgrotation=3))+stat1*((bgrotation=2)|(bgrotation=3)))
				layernowp=layernow
			}
			gmode 0
			ddim sha,1
			sha=17.0f*yure2_pow2(t-shaket,150,1)*shakewidth/150
			if(shake2type=2){
				sha+=10.0f*yure2_pow2(cnow-shake2c,shake2len,shake2n)*shake2width/50
			}else:if(shake2type=1){
				sha+=10.0f*yure2(cnow-shake2c,shake2len,shake2n)*shake2width/50
			}else{
				sha+=10.0f*yure(cnow-shake2c,shake2len,shake2n)*shake2width/50
			}
			ddim zsidenow,1
			ddim zsidenow2,1
			zsidenow2 = GetCurrentCamValue(game_system, CAM_ZOOM_SIDE)
			zsidenow2/=1.5f
			zsidenow2/=2.0f
			if(cnt=0):zsidenowp=zsidenow2
			zsidenow=zsidenow2*min(max(t_tp,1),ztime)/ztime+zsidenowp*(ztime-min(max(t_tp,1),ztime))/ztime
			sha+=zsidenow
			color 0,0,0
			// 3D表示
			ddim ztopnow,1
			ddim ztopnow2,1
			ztopnow2 = GetCurrentCamValue(game_system, CAM_ZOOM_TOP)
			if(csongver_int<167){
				// 旧バージョン互換
				ztopnow2/=1.5f
				ztopnow2/=50.0f
				if(ztopnow2<=0.0f):ztopnow2/=2.5f
			}
			if(cnt=0):ztopnowp=ztopnow2
			ztopnow=ztopnow2*min(max(t_tp,1),ztime)/ztime+ztopnowp*(ztime-min(max(t_tp,1),ztime))/ztime

			ddim ztopradnow,1
			ztopradnow=ztopnow*M_PI/1200.0f

			ddim zbotnow,1
			ddim zbotnow2,1
			zbotnow2 = GetCurrentCamValue(game_system, CAM_ZOOM_BOTTOM)
			zbotnow2/=1.5f
			zbotnow2/=120.0f
			if(zbotnow2>=0.0f):zbotnow2/=2.5f
			if(cnt=0):zbotnowp=zbotnow2
			zbotnow=zbotnow2*min(max(t_tp,1),ztime)/ztime+zbotnowp*(ztime-min(max(t_tp,1),ztime))/ztime

			// 判定アニメーションの大きさ(経験的に設定)
			ddim judgelrate,1
			if(csongver_int>=167){
				judgelrate=(powf(maxf(zbotnow+300.0f/1.5f/120.0f,0.0f)/(300.0/1.5f/120.0f),10.0f*(zbotnow-200.0f/1.5f/120.0f/2.5f)*double(zbotnow>200.0f/1.5f/120.0f/2.5f)+4f-2f*(zbotnow<0))+/* -300以上のとき0.5になるように→ */0.4545*powf(1.1f,minf((-300.0f/1.5f/120.0f+zbotnow)/(300.0f/1.5f/120.0f),1.0f)))/1.5f
			}else{
				// 旧バージョン互換
				judgelrate=(powf((zbotnow+300.0f/1.5f/120.0f)/(300.0/1.5f/120.0f),10.0f*(zbotnow-200.0f/1.5f/120.0f/2.5f)*double(zbotnow>200.0f/1.5f/120.0f/2.5f)+4f-2f*(zbotnow<0))+0.5f)/1.5f
			}

			// 判定ラインの大きさ(経験的に設定)
			ddim judgelrate_cline,1
			if(csongver_int>=167){
				judgelrate_cline=(powf(maxf(zbotnow+300.0f/1.5f/120.0f,0.0f)/(300.0/1.5f/120.0f),10.0f*(zbotnow-200.0f/1.5f/120.0f/2.5f)*double(zbotnow>200.0f/1.5f/120.0f/2.5f)+5f-3f*(zbotnow<0))+0.5f)/1.5f
			}else{
				// 旧バージョン互換
				judgelrate_cline=(powf((zbotnow+300.0f/1.5f/120.0f)/(300.0/1.5f/120.0f),10.0f*(zbotnow-200.0f/1.5f/120.0f/2.5f)*double(zbotnow>200.0f/1.5f/120.0f/2.5f)+5f-3f*(zbotnow<0))+0.5f)/1.5f
			}

			// 最終的なレーン傾きの値
			dstat=deg2rad(ror*tiltrnow/1000*(1.0f-ztiltrate)+spinangle+spinrp*(t-spinrpt<300)*(300-max(t-spinrpt,0))/300+ztiltnow*ztiltrate)

			axrate=80*scrsize_h/480
			ayrate=80*scrsize_h/480
			gsel 0
			if(bg>=1){
				setang obj_lane_s,0,0,-dstat
				setpos obj_lane_s,42.0f*sin(-dstat)-double(-sha)*cos(dstat)/2,-42.0f+42.0f*cos(-dstat)-double(-sha)*sin(dstat)/2,0
			}
			sellang
			if(csongver_int>=167){
				objsetf3 -M_PI/2+atan((-slr*zbotnow*sin(fv1))/(slr*slr-slr*zbotnow*cos(fv1))),0,dstat
			}else{
				// 旧バージョン互換
				objsetf3 -M_PI/2+atan((-slr*zbotnow*sin(fv1)-slr*ztopnow*sin(fv1))/(slr*slr-slr*zbotnow*cos(fv1)-slr*ztopnow*cos(fv1))),0,dstat
			}
			setang obj_lane,0,0,-dstat
			setpos obj_lane,42.0f*sin(-dstat)-double(-sha)*cos(dstat)/2,-42.0f+42.0f*cos(-dstat)-double(-sha)*sin(dstat)/2,0
			if(anaranfl=2){
				setobjmodel obj_judgel,mod_judgel2x
			}else{
				setobjmodel obj_judgel,mod_judgel
			}
			selang obj_judgel
			objsetf2 1,0,-dstat
			selpos obj_judgel
			objsetf2 0,40.2f*sin(-dstat)-double(-sha-(anaranfl=2)*452.0f*0.95f/8/2)*cos(dstat)/2*judgelrate,-43.7f+40.2f*cos(-dstat)-double(-sha)*sin(dstat)/2*judgelrate
			repeat 2
				setefx obj_analogcur.cnt,255*(arstat.(6+cnt).0=1)
				selang obj_analogcur.cnt
				objsetf2 1,0,-dstat
				selpos obj_analogcur.cnt
				objsetf2 0,40.2f*sin(-dstat)-(-5.2f+double(vw2)*2/13/2-double(analogvpos.cnt*anarannow(cnt)-500*(anarannow(cnt)=2))*282.0f/8/1000-double(sha)/2)*judgelrate*cos(-dstat),-43.2+40.2f*cos(-dstat)+(-5.2f+double(vw2)*2/13/2-double(analogvpos.cnt*anarannow(cnt)-500*(anarannow(cnt)=2))*282.0f/8/1000-double(sha)/2)*judgelrate*sin(-dstat)
			loop
			lanesubfl=1
			lanesubflp=lanesubfl
			if((cnow+sttp*adj-spincp<spinnow.2*75/200)&(cnow+sttp*adj-spincp>0)&(spinnow.2>0)){
				dstat=sin(deg2rad(180*(cnow+sttp*adj-spincp)/(spinnow.2*75/200)))*sin(deg2rad(180*(cnow+sttp*adj-spincp)/(spinnow.2*75/200)))*7
				mouikkai=dstat*((1-spinnow0p*2)*(spinnow0p/2=0)+(1-(spinnow0p-2)*2)*(spinnow0p/2=1))
			}else{
				mouikkai=0.0f
			}
			fv1=-0.6125 // カメラ座標と判定ラインを結んだ線の水平からの角度(rad)
			dstat=spinangles*360.0f/520.0f
			dstat=sin(deg2rad(dstat))
			dstat*=20*(1-2*(spinnow0p/2=1))
			// 最終的な判定ラインの傾きの値
			dstat=deg2rad(dstat/(1-3*((spinnow.0=2)|(spinnow.0=3)))+spinrps*(t-spinrpt<300)*(300-max(t-spinrpt,0))/300+ror*tiltrnow/1000*(1.0f-ztiltrate)+mouikkai+ztiltnow*ztiltrate)
			selang obj_cline
			objsetf2 1,0.0f,-dstat
			selpos obj_cline
			objsetf2 0,40.2f*sin(-dstat)-double(-sha)*cos(-dstat)/2*judgelrate_cline,-42.8f+40.2f*cos(-dstat)+double(-sha)*sin(-dstat)/2*judgelrate_cline
			f=0 // テクスチャを上下反転するかどうか
			if(csongver_int>=167){
				meshstat_y.0.0=int(lr*100*sin(ztopradnow)/2.5f) // 奥の辺 上方向
				meshstat_y.1.0=meshstat_y.0.0
				meshstat_y.0.1=int(-double(zbotnow)*sin(fv1)*slr/lr*10000-sr*100*sin(ztopradnow)/2.5f) // 手前の辺 上方向
				meshstat_y.1.1=meshstat_y.0.1
				meshstat_x.0.0=int(-double(vw2)*2/13*anaranfl/2*100) // 左の辺 右方向
				meshstat_x.0.1=meshstat_x.0.0
				meshstat_x.1.0=int(double(vw2)*2/13*anaranfl/2*100) // 右の辺 右方向
				meshstat_x.1.1=meshstat_x.1.0
				meshstat_z.0.0=int(lr/2*100-lr*100*cos(ztopradnow)) // 奥の辺 手前方向
				meshstat_z.1.0=meshstat_z.0.0
				meshstat_z.0.1=int(lr/2*100+sr/2*100*cos(ztopradnow)+double(zbotnow)*cos(fv1)*slr/lr*10000) // 手前の辺 手前方向
				meshstat_z.1.1=meshstat_z.0.1
				stat1=(int(ztopradnow*180/M_PI)+360000)\360
				if((stat1>=180-60)&(stat1<360-60)){
					// レーンが裏向きになった場合に座標とテクスチャ上下を反転
					stat1=meshstat_y.0.0
					meshstat_y.0.0=meshstat_y.0.1
					meshstat_y.1.0=meshstat_y.0.1
					meshstat_y.0.1=stat1
					meshstat_y.1.1=stat1
					stat1=meshstat_z.0.0
					meshstat_z.0.0=meshstat_z.0.1
					meshstat_z.1.0=meshstat_z.0.1
					meshstat_z.0.1=stat1
					meshstat_z.1.1=stat1
					f=1
				}
			}else{
				// 旧バージョン互換(zoom_topが大きくなるほど上辺を斜め上にする)
				meshstat_y.0.0=int(-double(ztopnow)*sin(fv1)*10000)
				meshstat_y.1.0=meshstat_y.0.0
				meshstat_y.0.1=int(-double(zbotnow)*sin(fv1)*slr/lr*10000+double(ztopnow)*sr/lr*sin(fv1)*10000)
				meshstat_y.1.1=meshstat_y.0.1
				meshstat_x.0.0=int(-double(vw2)*2/13*anaranfl/2*100)
				meshstat_x.0.1=meshstat_x.0.0
				meshstat_x.1.0=int(double(vw2)*2/13*anaranfl/2*100)
				meshstat_x.1.1=meshstat_x.1.0
				meshstat_z.0.0=int(-double(vh2)*13/20/2*100-double(ztopnow)*cos(fv1)*10000)
				meshstat_z.1.0=meshstat_z.0.0
				meshstat_z.0.1=int(double(vh2)*13/20/2*100+double(zbotnow)*cos(fv1)*slr/lr*10000+double(ztopnow)*cos(fv1)*sr/lr*10000)
				meshstat_z.1.1=meshstat_z.0.1
			}
			meshmap meshstat_y,mod_lane,0,0.01f // Y
			meshmap meshstat_x,mod_lane,1,0.01f // X
			meshmap meshstat_z,mod_lane,2,0.01f // Z
			if(bg>=1){
				meshmap meshstat_y,mod_lane_s,0,0.01f
				meshmap meshstat_x,mod_lane_s,1,0.01f
				meshmap meshstat_z,mod_lane_s,2,0.01f
			}
			setscale obj_cline,maxf(judgelrate_cline,1.0f),maxf(judgelrate_cline,1.0f),maxf(judgelrate_cline,1.0f)
			setscale obj_judgel,judgelrate,judgelrate,judgelrate

			// レーンのテクスチャを取得
			if((bg>=1)&((lanesubflp=1)|(lanesubfl=1)|(tex_lane_s=-1))){
				gsel 51+118*(anaranfl=2)
				color 0,0,0
				line vw/ra*anaranfl,0,0,0
				settex vw/ra*anaranfl,vh/ra/*stat2*/,f,tex_lane_s
			}
			gsel 5+163*(anaranfl=2)
			color 0,0,0
			line vw/ra*anaranfl,0,0,0
			settex vw/ra*anaranfl,vh/ra/*stat2*/,f,tex_lane

			hgdraw
			if((chainvt!=-1)&(t-chainvt<500)){
				// CHAIN数の表示
				stat1=str(chainnow)
				if(strlen(stat1)=3){
					stat1="0"+stat1
				}else:if(strlen(stat1)=2){
					stat1="00"+stat1
				}else:if(strlen(stat1)=1){
					stat1="000"+stat1
				}
				if(stat1!="0000"){
					pos scrsize_w/2+round(t\100*scrsize_h/480/50/(1+(round(t\100*scrsize_h/480/50)>=2))),(290+20/2)*scrsize_h/480
					hgzoom 80*scrsize_h/480,getsize(20),tex_combonum,0,getsize(20)*noerror,getsize(80),getsize(20),5,255
					repeat strlen(stat1)
						stat2=int(strmid(stat1,cnt,1))
						pos scrsize_w/2+(40/2-8+32*(cnt*2-strlen(stat1))/2)*scrsize_h/480+round(t\100*scrsize_h/480/50/(1+(round(t\100*scrsize_h/480/50)>=2))),(320+36/2)*scrsize_h/480
						hgzoom 40*scrsize_h/480,getsize(50),tex_combonum,getsize(40)*noerror,(40+stat2*50)*scrsize_h/480,getsize(40),getsize(50),5,255
					loop
				}
			}
			if((t-chainefft<300)&(chainefft!=-1)){
				if(t-chainefft<70){
					stat1=255*(t-chainefft)/70
				}else:if(t-chainefft<230){
					stat1=255
				}else{
					stat1=255*(300-t+chainefft)/70
				}
				pos scrsize_w/2,(324+36/2-3)*scrsize_h/480
				hgzoom 120*scrsize_h/480,getsize(40),tex_combonum,0,(540+(t-chainefft)*4/300*40)*scrsize_h/480,getsize(120),getsize(40),5,stat1
			}
			
			// アナログデバイスの予告表示
			repeat 2
				if((arstat.(6+cnt).0=1)&(arstatp.(6+cnt).0=0)&(analog.(arstat.(6+cnt).1).6-t>=1400)):anapret.cnt=t
			loop
			repeat 2
				pos scrsize_w/2+getsize(184)*(cnt*2-1),getsize(402)
				if(t-anapret.cnt<0):continue
				if(t-anapret.cnt<300){
					if((t-anapret.cnt)\120<60){
						hgcopy tex_laser_p,getsize(60),getsize(60)*cnt,getsize(60),getsize(60),3,255*(t-anapret.cnt)/300
					}else{
						hgcopy tex_laser_p,0,getsize(60)*cnt,getsize(60),getsize(60),3,255*(t-anapret.cnt)/300
					}
					gmode 0
				}else:if(t-anapret.cnt<2000){
					if(((t-anapret.cnt)\120<60)&(t-anapret.cnt<480)){
						hgcopy tex_laser_p,getsize(60),getsize(60)*cnt,getsize(60),getsize(60),3,255
					}else{
						hgcopy tex_laser_p,0,getsize(60)*cnt,getsize(60),getsize(60),3,255
					}
					gmode 0
				}else:if(t-anapret.cnt<2300){
					hgcopy tex_laser_p,0,getsize(60)*cnt,getsize(60),getsize(60),3,255-255*(t-anapret.cnt-2000)/300
					gmode 0
				}
			loop

			// 情報の表示
			gmode 0
			pos scrsize_w/2-getsize(155),getsize(45)
			hgcopy tex_minfo_label,0,0,getsize(240),getsize(44),3,255
			pos scrsize_w/2-int(286.5f*scrsize_h/480),int(45.5f*scrsize_h/480)
			hgcopy tex_jacket,0,0,int(38.5f*scrsize_h/480),int(38.5f*scrsize_h/480),0,255
			pos mdetail_xpos,mdetail_ypos
			hgcopy_a tex_minfo_detail,0,0,getsize(240),getsize(66),3,255
			stat1=str(bpm)
			stat1=strmid(stat1,0,strlen(stat1)-3)+"."+strmid(stat1,-1,3)
			stat1=strtrim(stat1,2,'0')
			stat1=strtrim(stat1,2,'.')
			stat2=0
			repeat strlen(stat1)
				if(strmid(stat1,cnt,1)="."):stat2-=5*scrsize_h/480
				pos mdetail_xpos+getsize(159)+getsize(10)*cnt+stat2,mdetail_ypos+int(round(4.0f*scrsize_h/480))
				hgcopy_a tex_num2.0,0,getsize(9)*2*(int(strmid(stat1,cnt,1))+(strmid(stat1,cnt,1)=".")*10),two(getsize(10)),two(getsize(9)),3,255
			loop
			if((hso=-1)&(hsc=-1)&(hsm=-1)&(hsa=-1)){
				if(strlen(str(hsr))=1){
					stat1="x0."+hsr
				}else{
					stat1=str(hsr)
					stat1="x"+strmid(stat1,0,1)+"."+strmid(stat1,1,1)
				}
			}else:if(hsc!=-1){
				stat1="C"
			}else:if(hsm!=-1){
				stat1="m"+hsm
			}else:if(hsa!=-1){
				stat1="a"+hsa
			}else{
				stat1=""+hso
			}
			stat3=0
			stat4=0
			repeat strlen(stat1)
				if(strmid(stat1,cnt,1)="."){
					stat3+=5*scrsize_h/480
				}
			loop
			repeat strlen(stat1)
				if(int(strmid(stat1,cnt,1))=0){
					if(strmid(stat1,cnt,1)="x"){
						stat2=11
					}else:if(strmid(stat1,cnt,1)="C"){
						stat2=12
					}else:if(strmid(stat1,cnt,1)="m"){
						stat2=13
					}else:if(strmid(stat1,cnt,1)="a"){
						stat2=14
					}else:if(strmid(stat1,cnt,1)="."){
						stat2=10
						stat4+=5*scrsize_h/480
					}else:if(strmid(stat1,cnt,1)=" "){
						continue
					}else{
						stat2=0
					}
				}else{
					stat2=int(strmid(stat1,cnt,1))
				}
				pos mdetail_xpos+getsize(131)-getsize(10)*strlen(stat1)/2+stat3/2+getsize(10)*cnt-stat4,mdetail_ypos+int(round(27.0f*scrsize_h/480))
				hgcopy_a tex_num2.0,0,getsize(9)*2*stat2,two(getsize(10)),two(getsize(9)),3,255
			loop
			if((hso=-1)&(hsc=-1)&(hsm=-1)&(hsa=-1)){
				stat1=int(double(bpm)*hsr/10000)
			}else:if(hsc!=-1){
				stat1=hsc
			}else:if(hsm!=-1){
				stat1=int(double(bpm/100)*hsm/maxbpm*100)
			}else:if(hsa!=-1){
				stat1=int(double(bpm/100)*hsa/avebpm*100)
			}else{
				stat1=int(double(bpm/100)*hso/oftbpm*100)
			}
			stat1=str(stat1)
			repeat strlen(stat1)
				if(int(strmid(stat1,cnt,1))=0){
					if(strmid(stat1,cnt,1)="x"){
						stat2=11
					}else:if(strmid(stat1,cnt,1)="C"){
						stat2=12
					}else:if(strmid(stat1,cnt,1)="m"){
						stat2=13
					}else:if(strmid(stat1,cnt,1)="a"){
						stat2=14
					}else:if(strmid(stat1,cnt,1)=" "){
						continue
					}else{
						stat2=0
					}
				}else{
					stat2=int(strmid(stat1,cnt,1))
				}
				pos mdetail_xpos+getsize(188)-getsize(10)*strlen(stat1)/2+getsize(10)*cnt,mdetail_ypos+int(round(27.0f*scrsize_h/480))
				hgcopy_a tex_num2.1,0,getsize(9)*2*stat2,two(getsize(10)),two(getsize(9)),3,255
			loop
			pos mdetail_xpos+getsize(8)-getsize(10)/2+getsize(225)*(min(t,mlength)+3400+1000*(cmovfile!=""))/(mlength+3400+1000*(cmovfile!="")),mdetail_ypos+getsize(56)-getsize(10)/2
			hgcopy_a tex_minfo_cur,0,0,two(getsize(10)),two(getsize(10)),3,255
			// 動画再生の外枠を描画
			if((cmov=0)&(vmov=1)&(output=0)){
				gmode 5,,,96
				color 255,255,255
				hgrect scrsize_w/2-getsize(302)+getsize(160)/2,getsize(140)+getsize(120)/2,,getsize(170),getsize(130)
			}
			// スコアの表示
			stat1=""
			stat2=str(totalscore_disp)
			repeat max(8-strlen(stat2),0)
				stat1+="0"
			loop
			stat1+=str(totalscore_disp)
			pos scrsize_w/2+getsize(60),getsize(16)
			hgzoom_a 240*scrsize_h/480,getsize(24),tex_score_header,0,0,480,48,3,255
			repeat 8
				pos scrsize_w/2+(60+240/2-(22*8+2*2)/2)*scrsize_h/480+getsize(22)*cnt,getsize(42)
				hgcopy_a tex_result_scorenum,0,getsize(24)*int(strmid(stat1,cnt,1)),getsize(24),getsize(24),3,255
			loop
			// フレームレート表示
			color 255,255,255
			stat1=d3timer()
			if(stat1-gtp>0){
				fpsnext+=1000/(stat1-gtp)
			}
			if((cnt\10=0)&(cnt>0)){
				fps=fpsnext/10
				fpsnext=0
			}
			fps=d3getfps()
			if(output=0){
				fpsstr=""+fps
				repeat strlen(fpsstr)
					pos scrsize_w-getsize(40)+(cnt-strlen(fpsstr))*10*scrsize_h/480,getsize(460)
					hgcopy_a tex_num2.0,0,getsize(9)*2*int(strmid(fpsstr,cnt,1)),two(getsize(10)),two(getsize(9)),3,255
				loop
				pos scrsize_w-getsize(38),getsize(460)
				hgcopy_a tex_fps,0,0,two(getsize(30)),two(getsize(9)),3,255
				if(int(-sync)!=0){
					fpsstr=""+str(abs(int(-sync)))
					repeat strlen(fpsstr)
						pos 15*scrsize_h/480+cnt*10*scrsize_h/480,getsize(460)
						hgcopy_a tex_num2.0,0,getsize(9)*2*int(strmid(fpsstr,cnt,1)),two(getsize(10)),two(getsize(9)),3,255
					loop
					pos 17*scrsize_h/480+strlen(fpsstr)*10*scrsize_h/480,getsize(460)
					hgcopy_a tex_timingadjust_ms,0,0,two(getsize(30)),two(getsize(9)),3,255
					pos 4*scrsize_h/480,getsize(460)
					hgcopy_a tex_timingadjust_sign,0,two(getsize(9))*(int(-sync)>0),two(getsize(9)),two(getsize(9)),3,255
					pos 4*scrsize_h/480,getsize(436)
					hgcopy_a tex_timingadjust,0,0,two(getsize(60)),two(getsize(20)),3,255
				}
			}
			gtp=stat1

			if(adjmode=1):gauge=0
			
			// エフェクティブ・レートの表示
			if((effratetype<=0)&(iscourse=0)){
				stat1=100*gauge/gaugemax
			}else{
				if(gauge>=0){
					stat1=gauge/1000
				}else{
					stat1=0
				}
			}
			
			; ゲージ外枠
			pos scrsize_w/2+round(erxsh1*scrsize_h/480),round(erysh1*scrsize_h/480)
			hgcopy_a tex_er,round((192.0f*errate1)*scrsize_h/480)*((effratetype+1)*(iscourse=0)+2*(iscourse=1))*2+((effratetype<=0)&(iscourse=0))*(stat1>=70)*round((192.0f*errate1)*scrsize_h/480)+((effratetype=1)|(iscourse=1))*(stat1>=30)*round((192.0f*errate1)*scrsize_h/480),0,round((192.0f*errate1)*scrsize_h/480),round(double(570.0f*errate1)*scrsize_h/480),3,255
			
			; ゲージ自体(内部)
			pos scrsize_w/2+round(erxsh1*scrsize_h/480)+int((34.0f*errate1)*scrsize_h/480),round(erysh1*scrsize_h/480)+round(126.0f*errate1*scrsize_h/480)+ceil(435.0f*errate1*scrsize_h/480)-ceil(435.0f*errate1*scrsize_h/480)*stat1/100
			hgcopy_a tex_er_g,ceil(48.0f*errate1*scrsize_h/480)*2*(effratetype+1)+((effratetype<=0)&(iscourse=0))*((stat1>=70)*ceil(48.0f*errate1*scrsize_h/480))+((effratetype=1)|(iscourse=1))*((stat1>=30)*ceil(48.0f*errate1*scrsize_h/480)),ceil(435.0f*errate1*scrsize_h/480)-ceil(435.0f*errate1*scrsize_h/480)*stat1/100,ceil(48.0f*errate1*scrsize_h/480),ceil(435.0f*errate1*scrsize_h/480)*stat1/100,5,255
			
			; ゲージエフェクト
			pos scrsize_w/2+round(erxsh1*scrsize_h/480)+int((34.0f*errate1)*scrsize_h/480),round(erysh1*scrsize_h/480)+round(126.0f*errate1*scrsize_h/480)+ceil(435.0f*errate1*scrsize_h/480)-ceil(435.0f*errate1*scrsize_h/480)*stat1/100
			hgcopy_a tex_er_g_pattern,ceil(48.0f*errate1*scrsize_h/480)*2*(effratetype+1)+((effratetype<=0)&(iscourse=0))*((stat1>=70)*ceil(48.0f*errate1*scrsize_h/480))+((effratetype=1)|(iscourse=1))*((stat1>=30)*ceil(48.0f*errate1*scrsize_h/480)),ceil(435.0f*errate1*scrsize_h/480)*2*(((cnow-cnowstart)*2/3)\bpba)/bpba+ceil(435.0f*errate1*scrsize_h/480)-ceil(435.0f*errate1*scrsize_h/480)*stat1/100,ceil(48.0f*errate1*scrsize_h/480),ceil(435.0f*errate1*scrsize_h/480)*stat1/100,5,255
			
			; ゲージパーセント表示
			pos scrsize_w/2+round(erxsh1*scrsize_h/480)+round(72.0f*errate1*scrsize_h/480),round(erysh1*scrsize_h/480)+round(127.0f*errate1*scrsize_h/480)+ceil(435.0f*errate1*scrsize_h/480)-ceil(435.0f*errate1*scrsize_h/480)*stat1/100-round(42.0f*errate1*scrsize_h/480/2)
			hgcopy_a tex_er_p,0,0,round(96.0f*errate1*scrsize_h/480),round(42.0f*errate1*scrsize_h/480),3,255
			
			stat2=str(stat1)
			repeat strlen(stat2)
				pos scrsize_w/2+round(erxsh1*scrsize_h/480)+round((144.0f-20.0f*(strlen(stat2)-cnt))*errate1*scrsize_h/480),round(erysh1*scrsize_h/480)+round(127.0f*errate1*scrsize_h/480)+ceil(435.0f*errate1*scrsize_h/480)-ceil(435.0f*errate1*scrsize_h/480)*stat1/100-round(15.9f*errate1*scrsize_h/480/2)
				hgzoom_a round(16.0f*errate1*scrsize_h/480),round(15.9f*errate1*scrsize_h/480),tex_num0,0,120*int(strmid(stat2,cnt,1)),136,120,3,255
			loop
			
			gmode 0
			if(mendt!=-1){
				if(((effratetype>0)|(iscourse=1))&(gauge/1000<=0)){
					gmode 5,,,255
					color 255,48+128-128*min(t-mendt,750)/750,0
					hgrect 0.0f,0.0f,0.0f,scrsize_w*4,scrsize_h*4
				}
				d3timerstat=d3timer()
				if((d3timerstat-mendat>=800)&((effratetype<=0)&(iscourse=0))&(adjmode!=1)&(output=0)){
					stat2=0
					if(stat1>=70*((effratetype<=0)&(iscourse=0))){
						stat2=1
						if(errorn=0):stat2=2
						if(totalscore=10000000):stat2=3
					}
					gmode 3,540,150,255*double(min((d3timerstat-mendat-800)/2,320))/320
					pos scrsize_w/2,getsize(200)
					hgrotate tex_playresult,0,150*stat2,0.0f,(135+min((d3timer()-mendat-800)/3,135))*scrsize_h/480,(25+min((d3timer()-mendat-800)/6,65))*scrsize_h/480
					gmode 0
				}
				if((d3timerstat-mendat>=0)&(output=0)&(gauge/1000<=0)&((effratetype>0)|(iscourse=1))){
					foreach mid
						BASS_ChannelSetAttribute mid.cnt,2,0.0
					loop
					repeat swaudionum
						BASS_ChannelSetAttribute mid_sw.cnt,2,0.0
					loop
					fadeoutfl=1
				}
				if((d3timerstat-mendat>=1000+2400*((mendtype=0)&(((effratetype<=0)&(iscourse=0))|(gauge/1000>0))))&(output=0)){
					// フェードアウト
					if(fadeoutfl=0){
						foreach mid
							if(cnt!=stat1):BASS_ChannelSetAttribute mid.cnt,2,0.0
						loop
						if(mrepeat=0){
							BASS_ChannelSetAttribute mid.0,2,double(csongvol)/100*mastervol/100
							BASS_ChannelSlideAttribute mid.0,2,0.0,1500
						}
						fadeoutfl=1
					}
					if(d3timerstat-mendat<=2400+2400*((mendtype=0)&(((effratetype<=0)&(iscourse=0))|(gauge/1000>0)))){
						gmode 3,,,256*(d3timerstat-mendat-(1000+2400*((mendtype=0)&(((effratetype<=0)&(iscourse=0))|(gauge/1000>0)))))/1400
					}else:gmode 3,,,256
					color 0,0,0
					hgrect 0.0f,0.0f,0.0f,scrsize_w*4,scrsize_h*4
				}
			}
		}
		if((t<500-3400-1000*(cmovfile!=""))&(mendt=-1)){
			gmode 3,,,256*(500-3400-1000*(cmovfile!="")-t)/500
			color 0,0,0
			hgrect 0.0f,0.0f,0.0f,scrsize_w*4,scrsize_h*4
		}
		gsel 0
		if(output=0){
			if(vsync=1){
				if(cnt=0):d3d9vsync_init 60,0
				d3d9vsync 0
			}
			hgsync 0
		}else{
			hgsync 0
		}
		if(mrepeat=1){
			foreach mid
				BASS_ChannelSetAttribute mid.cnt,2,0.0
			loop
			repeat swaudionum
				BASS_ChannelSetAttribute mid_sw.cnt,2,0.0
			loop
		}
		foreach keystat
			cntkey=cnt
			repeat 11
				keystatp.cntkey.cnt=keystat.cntkey.cnt
			loop
		loop
		repeat 11
			keystatorp.cnt=keystator.cnt
		loop
		c2tcnt=0
		hsrccnt=0
		notecnt=0
		analogcnt=0
		rop=ro.0,ro.1
		rorp=ror
		tiltrnowp=tiltrnow
		tiltnowp=tiltnow
		tp=t
		tp2=tstat
		t_mop=t_mo
		rtp=rt
		atp=at
		bpmp=bpm
		bpmfxp=bpmfx
		repeat 8
			cnt2=cnt
			repeat 3
				arstatp.cnt2.cnt=arstat.cnt2.cnt
			loop
		loop
		bgnowp=bgnow
		ljudgep=ljudge.0,ljudge.1
		shljudgep=shljudge.0,shljudge.1,shljudge.2,shljudge.3
		anadirectionp=anadirection.0,anadirection.1
		analogposp=analogpos.0,analogpos.1
		analognowp=analognow.0,analognow.1
		panalognowp=panalognow.0,panalognow.1
		canalognowp=canalognow.0,canalognow.1
		ztopnowp=ztopnow
		zbotnowp=zbotnow
		zsidenowp=zsidenow
		ztiltnowp=ztiltnow
		ztiltratep=ztiltrate
		cnowp=cnow
		cnowfxp=cnowfx
		if(mrepeat=1){
			foreach mid
				BASS_ChannelSetAttribute mid.cnt,2,0.0
			loop
			repeat swaudionum
				BASS_ChannelSetAttribute mid_sw.cnt,2,0.0
			loop
		}
		if(output=0){
			if((disableime>=1)&(((ts>160)&(disableime=2))|((cnt\2=0)&(disableime=3))|(disableime=3))){
				if(imeget()=1):imeset 0
			}
		}
		if(analoginput=1){
			keshucnt=0:onkey 1
		}
		if(output!=0){
			gsel 0
			hgcapture2 0,0,0,scrsize_w,scrsize_h,0,0
			alSelectImage 50
			alCopyScreenToImage 0,50
			if(outputds>1){
				alStretchImageToImage 50,50,0,0,alGetWidth(),alGetHeight(),0,0,alGetWidth()/outputds,alGetHeight()/outputds
			}
			alSelectImage 50
			stat1=str(cnt)
			stat2=""
			repeat max(6-strlen(stat1),0)
				stat2+="0"
			loop
			alSaveFile outputpath+stat2+cnt+".png", "image/png",0,0,alGetWidth()/outputds,alGetHeight()/outputds
		}
	loop
	return

*minfoprepare
	// 楽曲情報の準備
	alCreateImage 142,getsize(240),getsize(66)
	alCopyImageToImage 141,142
	alCreateImage 53,getsize(240),getsize(44)
	alCopyImageToImage 51,53
	alColor 0,32,8,255
	if(csongtitleimg=""){
		alFont lang.0.0,18
		alDrawText_CalcRect_ tsize,csongtitle
		if(tsize.2/9>50){
			alFont lang.0.0,getsize(9),1
		}else:if(tsize.2/9>40){
			alFont lang.0.0,getsize(10),1
		}else:if(tsize.2/9>38){
			alFont lang.0.0,getsize(11),1
		}else:if(tsize.2/9>34){
			alFont lang.0.0,getsize(12),1
		}else:if(tsize.2/9>30){
			alFont lang.0.0,getsize(13),1
		}else:if(tsize.2/9>26){
			alFont lang.0.0,getsize(14),1
		}else{
			alFont lang.0.0,getsize(15),1
		}
		alDrawText csongtitle,getsize(8),getsize(3),getsize(224),getsize(26),1,1
	}else{
		alCreateImageByFile 85,dir_default+"\\songs\\"+csongdir+"\\"+csongtitleimg
		alCopyModeColorMatrix colmatrix2
		alStretchImageToImage 85,53,0,0,alGetWidth(),alGetHeight(),getsize(120)-alGetWidth()*(getsize(20))/alGetHeight()/2,getsize(6),alGetWidth()*(getsize(20))/alGetHeight(),getsize(20)
		alSelectImage 53
		alResetCopyMode
	}
	if(csongartistimg=""){
		alFont lang.0.0,18
		alDrawText_CalcRect_ tsize,csongartist
		if(tsize.2/9>48){
			alFont lang.0.0,getsize(9)
		}else:if(tsize.2/9>36){
			alFont lang.0.0,getsize(10)
		}else{
			alFont lang.0.0,getsize(11)
		}
		alDrawText csongartist,getsize(8),getsize(28),getsize(224),getsize(14),1,1
	}else{
		alCreateImageByFile 85,dir_default+"\\songs\\"+csongdir+"\\"+csongartistimg
		alCopyModeColorMatrix colmatrix2
		alStretchImageToImage 85,53,0,0,alGetWidth(),alGetHeight(),(8+112)*scrsize_h/480-alGetWidth()*(getsize(14))/alGetHeight()/2,getsize(28),alGetWidth()*(getsize(14))/alGetHeight(),getsize(14)
		alSelectImage 53
		alResetCopyMode
	}
	alSelectImage 142
	alCopyImageToImage IMG_RESULT_DIFFICULTY,142,getsize(13),getsize(3),getsize(42),getsize(12),0,getsize(12)*csongdifficulty
	stat1=csonglevel
	if(stat1>20):stat1=20
	if(stat1<1):stat1=1
	stat1=str(stat1)
	repeat strlen(stat1)
		alCopyImageToImage 52,142,getsize(79)+getsize(10)*cnt,getsize(4),getsize(10),getsize(9),0,getsize(9)*int(strmid(stat1,cnt,1))
	loop
	alSelectImage 53
	alSaveFile dir_default+"\\cache\\minfo_label.png",,0,0,two(getsize(240)),two(getsize(44))
	alSelectImage 142
	alSaveFile dir_default+"\\cache\\minfo_detail.png",,0,0,two(getsize(240)),two(getsize(66))
	return

*pl_minfoprepare
	// 楽曲情報(プレイ前の画面)の準備
	alCreateImage 53,getsize(360),getsize(90)
	alCopyImageToImage 62,53
	alColor 0,32,8,255
	if(csongtitleimg=""){
		alFont lang.0.0,18
		alDrawText_CalcRect_ tsize,csongtitle
		if(tsize.2/9>50){
			alFont lang.0.0,16*3/4*scrsize_h/480,1
		}else:if(tsize.2/9>40){
			alFont lang.0.0,18*3/4*scrsize_h/480,1
		}else:if(tsize.2/9>38){
			alFont lang.0.0,20*3/4*scrsize_h/480,1
		}else:if(tsize.2/9>34){
			alFont lang.0.0,22*3/4*scrsize_h/480,1
		}else:if(tsize.2/9>30){
			alFont lang.0.0,24*3/4*scrsize_h/480,1
		}else:if(tsize.2/9>26){
			alFont lang.0.0,26*3/4*scrsize_h/480,1
		}else{
			alFont lang.0.0,28*3/4*scrsize_h/480,1
		}
		alDrawText csongtitle,16*3/4*scrsize_h/480,9*3/4*scrsize_h/480,448*3/4*scrsize_h/480,52*3/4*scrsize_h/480,1,1
	}else{
		alCreateImageByFile 85,dir_default+"\\songs\\"+csongdir+"\\"+csongtitleimg
		alCopyModeColorMatrix colmatrix2
		alStretchImageToImage 85,53,0,0,alGetWidth(),alGetHeight(),240*3/4*scrsize_h/480-alGetWidth()*(40*3/4*scrsize_h/480)/alGetHeight()/2,12*3/4*scrsize_h/480,alGetWidth()*(40*3/4*scrsize_h/480)/alGetHeight(),40*3/4*scrsize_h/480
		alSelectImage 53
		alResetCopyMode
	}
	if(csongartistimg=""){
		alFont lang.0.0,18
		alDrawText_CalcRect_ tsize,csongartist
		if(tsize.2/9>48){
			alFont lang.0.0,18*3/4*scrsize_h/480
		}else:if(tsize.2/9>36){
			alFont lang.0.0,20*3/4*scrsize_h/480
		}else{
			alFont lang.0.0,22*3/4*scrsize_h/480
		}
		alDrawText csongartist,16*3/4*scrsize_h/480,57*3/4*scrsize_h/480,448*3/4*scrsize_h/480,28*3/4*scrsize_h/480,1,1
	}else{
		alCreateImageByFile 85,dir_default+"\\songs\\"+csongdir+"\\"+csongartistimg
		alCopyModeColorMatrix colmatrix2
		alStretchImageToImage 85,53,0,0,alGetWidth(),alGetHeight(),(16+224)*3/4*scrsize_h/480-alGetWidth()*(28*3/4*scrsize_h/480)/alGetHeight()/2,56*3/4*scrsize_h/480,alGetWidth()*(28*3/4*scrsize_h/480)/alGetHeight(),28*3/4*scrsize_h/480
		alSelectImage 53
		alResetCopyMode
	}
	alCopyImageToImage 89,53,getsize(40),47*3/2*scrsize_h/480,getsize(63),getsize(18),0,getsize(18)*csongdifficulty
	stat1=csonglevel
	if(stat1>20):stat1=20
	if(stat1<1):stat1=1
	stat1=str(stat1)
	repeat strlen(stat1)
		alCopyImageToImage 88,53,getsize(139)+getsize(15)*cnt,48*3/2*scrsize_h/480,getsize(15),int(12.5*scrsize_h/480),0,int(12.5*scrsize_h/480)*int(strmid(stat1,cnt,1))
	loop
	stat1=str(bpml.0.1)
	stat1=strmid(stat1,0,strlen(stat1)-3)+"."+strmid(stat1,-1,3)
	stat1=strtrim(stat1,2,'0')
	stat1=strtrim(stat1,2,'.')
	stat2=0
	repeat strlen(stat1)
		if(strmid(stat1,cnt,1)="."):stat2-=5*scrsize_h/480
		alCopyImageToImage 88,53,getsize(259)+getsize(15)*cnt+stat2,48*3/2*scrsize_h/480,getsize(15),int(12.5*scrsize_h/480),0,int(12.5*scrsize_h/480)*(int(strmid(stat1,cnt,1))+(strmid(stat1,cnt,1)=".")*10)
	loop
	return

*joyinit
	if(length_joylist>0){
		dim joystatp,joylist.(length_joylist-1)+1,32
		dim joystat,joylist.(length_joylist-1)+1,32
	}else{
		dim joystat,1,32
		dim joystatp,1,32
	}

*getjoystat
	if(length_joylist>0){
		dim joystatp,joylist.(length_joylist-1)+1,32
		if(length2(joystat)=32){
			repeat length_joylist
				cnt2_=joylist.cnt
				if(length(joystat)>cnt2_){
					repeat 32
						joystatp.cnt2_.cnt=joystat.cnt2_.cnt
					loop
				}
			loop
		}else{
			repeat length_joylist
				cnt2_=joylist.cnt
				if(length(joystat)>cnt2_){
					repeat 32
						joystatp.cnt2_.cnt=1
					loop
				}
			loop
		}
		dim joystat,joylist.(length_joylist-1)+1,32
		repeat length_joylist
			cnt2_=joylist.cnt
			joyGetPosEx joydata, joylist.cnt
			repeat 32
				if(((joydata.8)&(pow(2,cnt)))>0){
					joystat.cnt2_.cnt=1
				}
			loop
		loop
	}
	return

#defcfunc getsttp
	if(nowsttp!=-1){
		return nowsttp
	}else:if(bpmlnum<=1){
		nowsttp=int(ttp*bpml.0.1/6000/beat)
		return nowsttp
	}else{
		s1=cnow
		s3=int(double(ttp)*bpml.bpmlsttpfcnt.1/6000/beat)
		repeat bpmlnum-bpmlsttpfcnt,bpmlsttpfcnt
			if(bpml.cnt.2>=t+ttp):break
			if(bpml.cnt.0<=s1){
				bpmlsttpfcnt=cnt
				continue
			}
			if((bpml.cnt.0>s1)&(bpml.cnt.2<t+ttp)){
				s3=bpml.cnt.0+int(double(t+ttp-bpml.cnt.2)*bpml.cnt.1/6000/beat)-cnow
			}
		loop
		nowsttp=s3
		return nowsttp
	}

#defcfunc b2c int b1
	_cbcnt=0
	b2=0
	repeat beatlnum
		if(cnt=beatlnum-1){
			_cbcnt+=bpba*beatl.cnt.1/beatl.cnt.2*(b1-b2)
		}else{
			_cbcnt+=bpba*beatl.cnt.1/beatl.cnt.2*min((beatl.(cnt+1).0-beatl.cnt.0)/(bpba*beatl.cnt.1/beatl.cnt.2),b1-b2)
			b2+=min((beatl.(cnt+1).0-beatl.cnt.0)/(bpba*beatl.cnt.1/beatl.cnt.2),b1-b2)
		}
		if(b1<=b2):break
	loop
	return _cbcnt
	
#defcfunc c2b int c1
	cb=0
	cb2=0
	repeat
		repeat beatlnum
			if(beatl.cnt.0<=cb){
				beatn=beatl.cnt.1
				beatd=beatl.cnt.2
				beatlfcnt=cnt+1
			}
		loop
		if(cb+bpba*beatn/beatd>c1):break
		cb+=bpba*beatn/beatd
		cb2++
	loop
	return cb2
	
#defcfunc c2t int c
	if(c<0){
		return int(double(c)*24000/bpml.0.1)
	}
	c2=c
	ct=0.0f
	cnt2_=0
	repeat bpmlnum
		cbpm=bpml.cnt.1
		if(cnt=bpmlnum-1):break
		if(bpml.(cnt+1).0<c2){
			ct+=double(bpml.(cnt+1).0-bpml.cnt.0)*24000/cbpm
		}else:break
		cnt2_++
	loop
	ct+=double(c2-bpml.cnt2_.0)*24000/cbpm
	return int(ct)

#defcfunc c2tf int c
	if(c<0){
		return double(c)*24000/bpml.0.1
	}
	c2=c
	ct=0.0f
	cnt2_=0
	repeat bpmlnum
		cbpm=bpml.cnt.1
		if(cnt=bpmlnum-1):break
		if(bpml.(cnt+1).0<c2){
			ct+=double(bpml.(cnt+1).0-bpml.cnt.0)*24000/cbpm
		}else:break
		cnt2_++
	loop
	ct+=double(c2-bpml.cnt2_.0)*24000/cbpm
	return ct

#defcfunc hsrc int c, int t1
	if(hsc=-1){
		if(stpnum=0):return c-cnow-sttp
		if(c>cnow){
			stpsh=cnowstpsh
			repeat stpnum-cstp,cstp
				if((cnow<stp.cnt.0+stp.cnt.1)&(cnow>=stp.cnt.0)){
					// 停止中
					stpsh+=stp.cnt.0+stp.cnt.1-cnow
				}else:if((c>stp.cnt.0)&(c<stp.cnt.0+stp.cnt.1)){
					// ノーツが停止中にある
					stpsh+=c-stp.cnt.0
				}else:if((cnow<stp.cnt.0)&(c>stp.cnt.0)){
					// ノーツが停止後にある
					stpsh+=stp.cnt.1
				}else:if(stp.cnt.0>=c):break
			loop
			return c-cnow-sttp-stpsh
		}
		return c-cnow-sttp
	}else{
		if(t1!=-1):return (t1-t-ttp*adj)*hsc/24
		return (c2t(c)-t-ttp*adj)*hsc/24
	}

#defcfunc getstpsh int c
	if(stpnum=0):return 0
	cstpsh=0
	repeat stpnum
		if((c<stp.cnt.0+stp.cnt.1)&(c>=stp.cnt.0)){
			cstpsh+=stp.cnt.0+stp.cnt.1-c
			cstp=cnt+1
		}
	loop
	return cstpsh

#defcfunc anarannow int c
	if(arstat.(6+c).0=1){
		return anagrran.c.(analoggr.(arstat.(6+c).1))
	}else:return 1

#defcfunc anarannowp int c
	if(arstatp.(6+c).0=1){
		return anagrran.c.(analoggr.(arstatp.(6+c).1))
	}else:return 1

#deffunc addgauge int a,int b
	if(iscourse=0){
		if(effratetype=0){
			gauge+=a*50
			unlimited_gauge+=a*50
			if(gauge>gaugemax):gauge=gaugemax
		}else:if(effratetype=-1){
			gauge+=a*55
			unlimited_gauge+=a*55
			if(gauge>gaugemax):gauge=gaugemax
		}else:if(b=0){
			gauge+=a*30
			unlimited_gauge+=a*30
			if(gauge>100000):gauge=100000
		}
	}else{
		if(effratetype=0){
			gauge+=100000*(a*50)/2/gaugemax
			unlimited_gauge+=100000*(a*50)/2/gaugemax
			if(gauge>100000):gauge=100000
		}else:if(effratetype=-1){
			gauge+=100000*(a*55)/2/gaugemax
			unlimited_gauge+=100000*(a*55)/2/gaugemax
			if(gauge>100000):gauge=100000
		}else:if(b=0){
			gauge+=a*20
			unlimited_gauge+=a*20
			if(gauge>100000):gauge=100000
		}else:if(b=1){
			gauge-=int(a*3037.5f*(100-41*(gauge/1000<=30))/100)
			unlimited_gauge-=int(a*3037.5f*(100-41*(gauge/1000<=30))/100)
			if((gauge/1000<=0)&(mendt=-1)){
				endfl=1
				mendt=t
				mendc=cnow
				mendat=d3timer()
				stat1=BASS_SampleGetChannel(hardfailedid,0)
				BASS_ChannelSetAttribute stat1,2,double(mastervol)/100
				BASS_ChannelPlay stat1
			}
		}
	}
	return

#deffunc subgauge double a
	if(iscourse=0){
		if(effratetype=0){
			gauge-=int(a*gaugemax/200)
			unlimited_gauge-=int(a*gaugemax/200)
			if(gauge<0):gauge=0
		}else:if(effratetype=-1){
			gauge-=int(double(gaugemax)*a*0.375/100)
			unlimited_gauge-=int(double(gaugemax)*a*0.375/100)
			if(gauge<0):gauge=0
		}else{
			gauge-=int(a*2250f*(100-41*(gauge/1000<=30))/100)
			unlimited_gauge-=int(a*2250f*(100-41*(gauge/1000<=30))/100)
			if((gauge/1000<=0)&(mendt=-1)){
				endfl=1
				mendt=t
				mendc=cnow
				mendat=d3timer()
				stat1=BASS_SampleGetChannel(hardfailedid,0)
				BASS_ChannelSetAttribute stat1,2,double(mastervol)/100
				BASS_ChannelPlay stat1
			}
		}
	}else{
		if(effratetype=0){
			gauge-=int(a*100000*(17-7*(gauge/1000<=30))/10/200)
			unlimited_gauge-=int(a*100000*(17-7*(gauge/1000<=30))/10/200)
		}else:if(effratetype=-1){
			gauge-=int(a*100000*(17-7*(gauge/1000<=30))/10*0.375/100)
			unlimited_gauge-=int(a*100000*(17-7*(gauge/1000<=30))/10*0.375/100)
		}else{
			gauge-=int(a*3037.5f*(100-41*(gauge/1000<=30))/100)
			unlimited_gauge-=int(a*3037.5f*(100-41*(gauge/1000<=30))/100)
		}
		if((gauge/1000<=0)&(mendt=-1)){
			endfl=1
			mendt=t
			mendc=cnow
			mendat=d3timer()
			stat1=BASS_SampleGetChannel(hardfailedid,0)
			BASS_ChannelSetAttribute stat1,2,double(mastervol)/100
			BASS_ChannelPlay stat1
		}
	}
	return

#deffunc spincheck int a
	if(analog.a.9=-1):return
	if(analog.a.9>=0){
		scnt=analog.a.9
		if((cnow<spin.scnt.1+spin.scnt.2)&(spin.scnt.0!=-1)){
			spinnow.0=spin.scnt.0
			spinnow0p=spin.scnt.0
			spinnow.1=cnowp+sttp*adj
			spinnow.2=spin.scnt.2
			spinnow.3=scnt
		}
	}else{
		sprcnt=-analog.a.9-2
		if((cnow<spr.sprcnt.1+spr.sprcnt.2)&(spr.sprcnt.0!=-1)){
			shake2c=cnowp
			shake2len=spr.sprcnt.2
			shake2n=spr.sprcnt.4
			shake2width=spr.sprcnt.3*(spr.sprcnt.0*2-1)
			shake2type=spr.sprcnt.5
		}
	}
	return

#defcfunc fxdef_str2param str a, int p1
	a2=a
	if(p1=FXDEF_INT){
		return double(a)
	}else:if(p1=FXDEF_RATE){
		if(strmid(a2,-1,1)="%"){
			return double(a)/100.0f
		}else{
			return double(a)
		}
	}else:if(p1=FXDEF_SAMPLE){
		if(strmid(a2,-1,7)="samples"){
			return double(int(a))
		}else:return 0.0f
	}else:if(p1=FXDEF_LENGTH){
		if(strmid(a2,-1,2)="ms"){
			return -double(a)/1000.0f
		}else:if((strmid(a2,-1,1)="s")&(strmid(a2,-1,2)!="es")){
			return -double(a)
		}else:if(strmid(a2,0,2)="1/"){
			if(int(strmid(a2,2,16))>0){
				return 1.0f/int(strmid(a2,2,16))
			}else:return 0.0f
		}else:return double(a)
	}else:if(p1=FXDEF_SWITCH){
		if(a="on"){
			return 1.0f
		}else:return 0.0f
	}else:if(p1=FXDEF_FREQ){
		if(strmid(a2,-1,3)="kHz"){
			return double(a)*1000.0f
		}else:if((strmid(a2,-1,2)="Hz")){
			return double(a)
		}else:return 0.0f
	}else:if(p1=FXDEF_FLOAT){
		return maxf(double(a),0.01f)
	}else:if(p1=FXDEF_NEGDB){
		if(strmid(a2,-1,2)="dB"){
			return maxf(-double(a),0.0f)
		}
	}else:if(p1=FXDEF_PITCH){
		if(instr(a2,1,".")!=-1){
			return minf(maxf(double(a),-48.0f),48.0f)/48.0f/2.0f+0.50f
		}else:return -(minf(maxf(double(a),-48.0f),48.0f)/48.0f/2.0f+0.50f)
	}else:if(p1=FXDEF_FILENAME){
		swaudio.swaudionum=strtrim(a2,0,'"')
		swaudionum++
	}
	return 0.0f

#defcfunc divconv int divconvval
	_divconvval=divconvval
	if((_divconvval>=2)&(_divconvval<4)):_divconvval=2
	if((_divconvval>=4)&(_divconvval<6)):_divconvval=4
	if((_divconvval>=6)&(_divconvval<8)):_divconvval=6
	if((_divconvval>=8)&(_divconvval<12)):_divconvval=8
	if((_divconvval>=12)&(_divconvval<16)):_divconvval=12
	if((_divconvval>=16)&(_divconvval<24)):_divconvval=16
	if((_divconvval>=24)&(_divconvval<32)):_divconvval=24
	if((_divconvval>=32)&(_divconvval<48)):_divconvval=32
	if((_divconvval>=48)&(_divconvval<64)):_divconvval=48
	if((_divconvval>=64)&(_divconvval<96)):_divconvval=64
	if((_divconvval>=96)&(_divconvval<128)):_divconvval=96
	if((_divconvval>=128)&(_divconvval<192)):_divconvval=128
	if(_divconvval>=192):_divconvval=192
	return _divconvval

#defcfunc divconv2 int divconvval
	if(divconvval=0){
		return 0
	}else:if(divconvval=2){
		return 1
	}else:if(divconvval=4){
		return 2
	}else:if(divconvval=6){
		return 3
	}else:if(divconvval=8){
		return 4
	}else:if(divconvval=12){
		return 5
	}else:if(divconvval=16){
		return 6
	}else:if(divconvval=24){
		return 7
	}else:if(divconvval=32){
		return 8
	}else:if(divconvval=48){
		return 9
	}else:if(divconvval=64){
		return 10
	}else:if(divconvval=96){
		return 11
	}else:if(divconvval=128){
		return 12
	}else:if(divconvval=192){
		return 13
	}else:return 0

#defcfunc divconv3 int divconvval
	if(divconvval=0){
		return 0
	}else:if(divconvval=1){
		return 2
	}else:if(divconvval=2){
		return 4
	}else:if(divconvval=3){
		return 6
	}else:if(divconvval=4){
		return 8
	}else:if(divconvval=5){
		return 12
	}else:if(divconvval=6){
		return 16
	}else:if(divconvval=7){
		return 24
	}else:if(divconvval=8){
		return 32
	}else:if(divconvval=9){
		return 48
	}else:if(divconvval=10){
		return 64
	}else:if(divconvval=11){
		return 96
	}else:if(divconvval=12){
		return 128
	}else:if(divconvval=13){
		return 192
	}else:return 0

#defcfunc a2p str a
	a2=a
	p=peek(a2,0)
	if((p>='0')&(p<='9')){
		return int(a)
	}else:if((p>='A')&(p<='Z')){
		return p-'A'+10
	}else:if((p>='a')&(p<='o')){
		return p-'a'+36
	}else:return -1

#defcfunc x20 int p1
	p1_=p1
	if(p1_=12){
		p1_=250
	}else:if(p1_=37){
		p1_=750
	}else:p1_*=20
	return p1_

#defcfunc yure double yureval,double yuremax,int yuretimes
	if((yureval>yuremax)|(yureval<0)):return 0.0
	return sin(M_PI*yuretimes*yureval/yuremax)

#defcfunc yure2 double yureval,double yuremax,int yuretimes
	if((yureval>yuremax)|(yureval<0)):return 0.0
	return sin(M_PI*yuretimes*yureval/yuremax)*(1.0f-double(yureval)/yuremax)

#defcfunc yure2_pow2 double yureval,double yuremax,int yuretimes
	if((yureval>yuremax)|(yureval<0)):return 0.0
	return sin(M_PI*yuretimes*yureval/yuremax)*powf(1.0f-yureval/yuremax,2)