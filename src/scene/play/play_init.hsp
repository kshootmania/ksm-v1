#deffunc start_play
	chdir dir_default+"\\songs"
	JStickSearchID 0,joylist
	length_joylist=stat
	gosub *joyinit
	if((iscmdline=0)|(iscourse=1)){
		chdir dir_default+"\\songs"
		dirlist filelistdir,csongdir,5
		if(stat=0){
			dialog lang.2.13/*"指定された譜面ファイルが見つかりません。"*/
			chdir dir_default+"\\songs"
			scene=SCENE_SELECT
			return
		}
		chdir csongdir
	}else{
		chdir getpath(cnotesfile,32)
	}

	// 判定タイミング調整のconfig上の値から実際の値を計算
	if(auto=1){
		// オートの場合は判定調整0として計算する
		judgedelay = visual_offset
		globaloffset = globaloffset_config - visual_offset
		analogdelay = judgedelay + analogdelay_config
		soundfx_delay = soundfx_delay_config + visual_offset
	}else{
		judgedelay = judgedelay_config + visual_offset
		globaloffset = globaloffset_config - visual_offset
		analogdelay = judgedelay + analogdelay_config
		soundfx_delay = soundfx_delay_config + visual_offset
	}

	fps=0
	totalscore=0
	totalscorep=0
	totalscore_disp_base=0
	totalscore_disp_baset=-50000
	c2tcnt=0
	hsrccnt=0
	notecnt=0
	analogcnt=0
	chocnt=0
	font lang.0.1,getsize(18)
	if(imeget()=1):imeset 0
	sdim csongfile,1,1
	cmovfile=""
	mfl=0
	mflp=0
	vfl=0
	vflp=0
	mstop=0
	mshift=0
	mtotalshift=0
	mendt=-1
	mendc=-1
	mendat=-1
	fadeoutfl=0
	ldelayresett=-5000
	at=0
	bpm=120000
	beatn=4
	beatd=4
	stpsh=0
	hs=70
	offset=diroffset
	endfl=0
	tochu=1
	tochu_esc=0
	tickfl=0
	dim tickp,6
	tickp=-1,-1,-1,-1,-1,-1
	tickcp0=-50000
	tickcp1=-50000
	dim chokkakup,2
	chokkakup=-1,-1
	notesejfcnt=0
	ddim ttp_,1
	ttp_=16.6f
	laserdelay0_orig=bufferlength/*233-ttp*/-soundfx_delay-GLOBAL_SOUNDFX_DELAY
	t_mo=-50000
	t_mop=-50000
	t_moex=0
	chainvt=-1
	chainefft=-1
	chainnow_song=0
	chainmax_song=0
	noerror_song=1
	if((iscourse=0)|(coursenow=0)){
		chainmax=0
		chainnow=0
		noerror=1
		if((effratetype<=0)&(iscourse=0)){
			gauge=0
			unlimited_gauge=0
		}else{
			gauge=100000
			unlimited_gauge=100000
		}
	}
	no_hstype_c=1
	dim judge,6,2
	dim ljudge,2
	dim shljudge,4
	dim ljudgep,2
	dim shljudgep,4
	dim ljudgeendt,2
	dim shljudgeendt,4
	ljudgeendt=-50000,-50000
	shljudgeendt=-50000,-50000,-50000,-50000
	dim judgel,6,judgelmax,2
	dim judgelnext,6
	notenum=0
	notesejnum=0
	notefxnum=0
	shljnum=0
	longjnum=0
	analogjnum=0
	analoganjnum=0
	chiprate=1
	longrate=1
	laserrate=1
	dim note,131072,8
	dim notefx,131072,8
	dim notese,131072
	dim notesej,131072,4
	dim longj,131072,8
	dim shlj,131072,8
	dim analogj,131072,5
	dim analoganj,131072,6
	dim analoganjdamage,131072
	dim analogbuf,131072
	dim analogturn,2,131072
	dim analogturnnum,2
	dim noteresult,131072
	dim keystat,7,11
	dim keystatp,7,11
	dim keystator,11
	dim keystatorp,11
	dim longstat,2
	dim longcritical,2
	dim longstatpp,2
	dim lstartt,2
	dim shlstat,4
	dim shlcritical,4
	dim shlstatpp,4
	dim shlstartt,4
	analognum=0
	dim analog,131072,10
	dim analoggr,131072
	dim analoggrmax,2
	anarannum=0
	anaranfl=1
	dim anaran,131072,3
	dim anagrran,2,131072
	dim analognext,131072
	dim analogprev,131072
	fxparamsnum=0
	dim fxparams,131072,3
	fxnum=0
	dim fx,131072,5
	spinnum=0
	sprnum=0
	dim spin,131072,5
	dim spr,131072,6
	/*
	rotatenum=0
	dim rotate,131072,6*/
	tiltnum=0
	dim tilt,131072,2
	tilttype=0
	tiltstart=0
	tiltfcnt=-1
	bpmlnum=0
	dim bpml,131072,3
	beatlnum=0
	dim beatl,131072,2
	stpnum=0
	dim stp,131072,2
	anagainnum=0
	dim anagain,131072,3
	anafilnum=0
	dim anafil,131072,3
	anvolnum=0
	dim anvol,131072,3
	ansenum=0
	dim anse,131072,2
	divnum=0
	dim div,8192
	ddim rop,2
	userfxnum=0
	sdim userfx_name,16,256
	ddim userfx_params,256,9
	ddim userfx_params_enable,256,9
	userfilternum=0
	sdim userfilter_name,16,256
	ddim userfilter_params,256,9
	ddim userfilter_params_min,256,9
	ddim userfilter_params_max,256,9
	userchprmnum=0
	userchprmfcnt=0
	ddim userchprm,4096,6
	sdim swaudio,256,32
	swaudionum=0
	dim userfx_swaudiomid,256
	spintp=0
	spinangle=0
	spinanglepp=0
	spinrpt=-50000
	spinrp=0
	spinrps=0
	dim spinnow,4
	spinnow=-1,0,0,-1 // 方向(L:0 R:1),開始c,長さc,番号
	dim sprnow,4
	sprnow=-1,0,0,-1 // 方向(L:0 R:1),開始c,長さc,番号
	bgmouikkaic=0
	bgmouikkaia=0
	bgmouikkai=0
	bgmouikkaicnt=-1
	bgmouikkaikaisu=2
	dim meshstat_y,2,2
	dim meshstat_x,2,2
	dim meshstat_z,2,2
	dim analogstatp,2
	dim arstatp,8,3
	dim analogpos,2
	analogpos=0,1000
	dim analognow,2
	analognow=-1,-1
	dim panalognow,2
	dim panalognow2,2
	panalognow=0,1000
	dim canalognow,2
	canalognow=-1,-1
	ddim anadamage,2
	shuwat=-50000
	ddim shuwapos,1
	shuwapos=1000.0f
	disableshuwa=0
	dim analogfuture,2
	analogfuture=-1,-1
	dim analognowp,2
	analognowp=-1,-1
	dim panalognowp,2
	panalognowp=0,0
	dim canalognowp,2
	canalognowp=0,0
	dim analogposp,2
	analogposp=0,1000
	dim analogokt,2
	analogokt=-50000,-50000
	dim analogngt,2
	analogngt=-50000,-50000
	dim analogngcnt,2
	analogngcnt=0,0
	dim anapret,2
	anapret=-50000,-50000
	dim anastartt,2
	anastartt=-50000,-50000
	dim anaendt,2
	anaendt=-50000,-50000
	dim anadjp,2
	anadjp=0,0
	dim analogokcnt,2
	analogokcnt=-1,-1
	dim analoganokt,2
	analoganokt=-50000,-50000
	dim analoganokcnt,2
	analoganokcnt=-1,-1
	dim analogefft,2,131072,2
	dim analogefftnum,2
	dim anaendstat,2
	anaendstat=-1,-1
	dim anadirection,2
	anadirection=1,0
	dim anadirectionp,2
	anadirectionp=1,0
	dim anaturnt,2
	anaturnt=-50000,-50000
	dim pdoutt,2
	pdoutt=-50000,-50000
	dim anakp,2
	anakp=-1,-1
	dim anakdiff,2
	anakdiff=0,0
	dim anaktp
	anaktp=0,0
	oldpfilter=0
	shaket=-50000
	shakewidth=0
	shake2c=-50000
	shake2width=0
	shake2len=1
	shake2n=1
	shake2type=1
	stat179p=1
	tadj=0
	stat0tp=0
	nowsttp=-1
	lanesubflp=1
	lanesubfl=0
	bpmlsttpfcnt=0
	bpmlsttpfcnt2=0
	bpmlcfcnt=0
	bpmlcfcnt_fx=0
	bpmlcfcnt_fx_50ms=0
	stpfcnt=0
	ddim ztopnowp,1
	ddim zbotnowp,1
	ddim zsidenowp,1
	ddim ztiltnowp,1
	ddim ztiltrate,1
	ddim ztiltratep,1
	ddim rorp,1
	ztilton=0
	csongtotal=0
	randomize
	pturnl = 0
	pturna = 0
	if (turn = 1) {
		pturnl = 1
		pturna = 1
	}
	if (turn=2) {
		stat1=0
		dim pturn,4
		repeat 4
			cnt2=cnt
			repeat
				pturn.cnt2=rnd(4)
				repeat cnt2
					if(pturn.cnt=pturn.cnt2){
						stat1=1
						break
					}else:stat1=0
				loop
				if(stat1=0){
					break
				}
			loop
		loop
		pturnl=rnd(2)
		pturna=rnd(2)
	}
	if(auto=1){
		dim kmode,3
		kmode=shortmode,longmode,analogmode
		if(shortmode=mode_on):shortmode=mode_auto
		if(longmode=mode_on):longmode=mode_auto
		if(analogmode=mode_on):analogmode=mode_auto
	}
	if(adjmode=1){
		dim kmode,3
		kmode=shortmode,longmode,analogmode
		shortmode=mode_on
		longmode=mode_hide
		analogmode=mode_hide
	}
	gsel 0
	if(output=1){
		alCreateImage 50,ginfo_winx,ginfo_winy
	}
	exist cnotesfile
	if(strsize<=0){
		dialog lang.2.13/*"指定された譜面ファイルが見つかりません。"*/
		if(iscmdline=1):end
		chdir dir_default+"\\songs"
		scene=SCENE_SELECT
		return
	}

	// 譜面ファイルの読み込み
	notesel buf
	noteload cnotesfile,-1

	varmd5 csongmd5hash, buf, strlen(buf)
	isutf8=0
	if (lpeek(buf, 0) & 0x00FFFFFF) == 0xBFBBEF{
		isutf8=1
		DeleteUTF8BOM buf
	}

	// IR用のファイルハッシュを計算
	csongmd5hash_ir_chart = getChartIRHash(buf)

	// 譜面ファイルの内容を1行ずつ配列dに入れる
	sdim d,256,notemax
	repeat notemax
		noteget buf2,cnt
		d.cnt=buf2
	loop

	// 譜面内容の読み込み
	sp=notemax
	buf=""
	repeat sp
		cnt2=cnt
		if(d.cnt="--"){
			div.divnum=0
			exc=0
			repeat
				if(cnt2+cnt+1>=length(d)){
					break
				}
				if(d.(cnt2+cnt+1)="--"){
					break
				}
				if(strmid(d.(cnt2+cnt+1),7,1)!="|"){
					div.divnum--
				}
				div.divnum++
			loop
			divnum++
		}
	loop
	cnt2a=-1
	stat4=0
	cnt3=-1
	ddim cbcnt,1
	beatn=4
	beatd=4
	csongtitle=""
	csongtitleimg=""
	csongartist=""
	csongartistimg=""
	csongeffect=""      // IR用
	csongillustrator="" // IR用
	csongjacket=""
	csongvol=100*dirvol/100
	csongoftbpm=0
	laserdelay1=40
	disableautoanvol=0
	bgname="desert"
	bgname_l="arrow"
	bgspeed=0
	bgrotation=3
	csonglevel=0
	csongver=""
	csongver_int=100
	fxdefbuf_fx=""
	fxdefbuf_filter=""
	csongfile_exist=0
	csonginfo=""
	csongeffect=""
	csonglayerstr=""
	tiltp=7
	repeat sp
		cnt2a++
		if(d.cnt="--"){
			cnt3++ // カレント小節数
			if(cnt3>0):cbcnt+=UNIT_MEASURE*beatn/beatd
			cnt2=-1
			continue
		}
		if(StartsWith(d.cnt, "bg=")){
			bgname=strmid(d.cnt,3,128)
			_sjis_ bgname
			continue
		}
		if(StartsWith(d.cnt, "layer=")){
			csonglayerstr=strmid(d.cnt,6,256)
			_sjis_ csonglayerstr
			continue
		}
		if(StartsWith(d.cnt, "title=")){
			csongtitle=strmid(d.cnt,6,128)
			_utf8_ csongtitle
			if(vfoldername=1){
				csongtitle+="("+utf8enc(strmid(csongdir,instr(csongdir,0,"\\")+1,strlen(csongdir)-instr(csongdir,0,"\\")-1))+")"
			}
			continue
		}
		if(StartsWith(d.cnt, "title_img=")){
			csongtitleimg=strmid(d.cnt,10,128)
			_sjis_ csongtitleimg
			continue
		}
		if(StartsWith(d.cnt, "artist=")){
			csongartist=strmid(d.cnt,7,128)
			_utf8_ csongartist
			continue
		}
		if(StartsWith(d.cnt, "effect=")){
			csongeffect=strmid(d.cnt,7,128)
			_sjis_ csongeffect
			continue
		}
		if(StartsWith(d.cnt, "illustrator=")){
			csongillustrator=strmid(d.cnt,12,128)
			_sjis_ csongillustrator
			continue
		}
		if(StartsWith(d.cnt, "information=")){
			csonginfo=strmid(d.cnt,12,128)
			_sjis_ csonginfo
			continue
		}
		if(StartsWith(d.cnt, "artist_img=")){
			csongartistimg=strmid(d.cnt,11,128)
			_sjis_ csongartistimg
			continue
		}
		if(StartsWith(d.cnt, "jacket=")){
			csongjacket=strmid(d.cnt,7,128)
			_sjis_ csongjacket
			if(instr(csongjacket,0,".")=-1){
				if(iscmdline=0){
					if(instr(csongdir,instr(csongdir,0,"\\")+1,"\\")>=0){
						csongjacket="..\\..\\..\\..\\imgs\\jacket\\"+csongjacket+".jpg"
					}else:csongjacket="..\\..\\..\\imgs\\jacket\\"+csongjacket+".jpg"
				}
			}
		}
		if(StartsWith(d.cnt, "difficulty=")){
			stat2=strmid(d.cnt,11,16)
			if(stat2="light"){
				csongdifficulty=0
			}else:if(stat2="challenge"){
				csongdifficulty=1
			}else:if(stat2="extended"){
				csongdifficulty=2
			}else:csongdifficulty=3
			continue
		}
		if(StartsWith(d.cnt, "level=")){
			csonglevel=int(strmid(d.cnt,6,2))
			continue
		}
		if(StartsWith(d.cnt, "chokkakuautovol=")){
			disableautoanvol=1-max(min(int(strmid(d.cnt,16,1)),1),0)
		}
		if(StartsWith(d.cnt, "m=")){
			//BASS_SetConfig 45,16777216
			sdim csongfile,1,1
			stat1=strmid(d.cnt,2,1024)
			_sjis_ stat1
			split stat1,";",csongfile
			dim mid,length(csongfile)*(auto=0)+auto
			//dim mid_pre,length(csongfile)*(auto=0)+auto
			exist csongfile.0
			if((length(csongfile)=2)&(strsize=-1)):csongfile.0=csongfile.1
			if(length(csongfile)<=1){
				dim mid,1
				//dim mid_pre,1
				dim hPeakFX,1
				dim hPeakFX2,1
				dim hCompFX,1
				dim hVolFX2,1
				dim hBitCFX,1
				peffect=1
				feffect=1
			}else:if(length(csongfile)<=2){
				dim mid,2-(auto=1)
				//dim mid_pre,2-(auto=1)
				dim hPeakFX,2-(auto=1)
				dim hPeakFX2,2-(auto=1)
				dim hCompFX,2-(auto=1)
				dim hVolFX2,2-(auto=1)
				dim hBitCFX,2-(auto=1)
				peffect=1
				feffect=0
			}else{
				peffect=0
				feffect=0
			}
			exist csongfile.(max(length(csongfile)-1,0))
			if((auto=1)&(length(csongfile)>=4)&(strsize!=-1)){
				csongfile.0=csongfile.1
				csongfile.1=csongfile.3
				dim mid,2
				//dim mid_pre,2
			}
			if(length(csongfile)>=2){
				exist csongfile.1
				if(((strsize=-1)|(feffecta=1))&(auto=1)){
					dim mid,1
					//dim mid_pre,1
					stat1=csongfile.0
					sdim csongfile,256,1
					csongfile.0=stat1
					feffect=1
				}
				if(((strsize=-1)|(feffecta=1))&(auto=0)){
					dim mid,1
					//dim mid_pre,1
					feffect=1
				}
			}
			exist csongfile.(max(length(csongfile)-1,0))
			if(((strsize=-1)|(peffecta=1))&(length(csongfile)>=4)&(auto=1)){
				stat1=csongfile.1
				sdim csongfile,256,1
				csongfile.0=stat1
				dim hPeakFX,1
				dim hPeakFX2,1
				dim hCompFX,1
				dim hVolFX2,1
				dim hBitCFX,1
				peffect=1
				oldpfilter=1
				if(anagainnum=0){
					anagain.0.0=0
					anagain.0.1=50
					anagainnum=1
					laserdelay1=0
					disableshuwa=1
				}else:if((anagainnum=1)&(anagain.0.1=0)){
					anagain.0.0=0
					anagain.0.1=50
					laserdelay1=0
					disableshuwa=1
				}
			}
			if(((peffecta=1)|(strsize=-1))&(auto=0)){
				if((length(csongfile)>=4)&(anagainnum=0)){
					anagain.0.0=0
					anagain.0.1=50
					anagainnum=1
					laserdelay1=0
					disableshuwa=1
				}else:if((length(csongfile)>=4)&(anagainnum=1)&(anagain.0.1=0)){
					anagain.0.0=0
					anagain.0.1=50
					laserdelay1=0
					disableshuwa=1
				}
				dim mid,2-(feffect=1)
				//dim mid_pre,2-(feffect=1)
				dim hPeakFX,2-(feffect=1)
				dim hPeakFX2,2-(feffect=1)
				dim hCompFX,2-(feffect=1)
				dim hVolFX2,1
				dim hBitCFX,2-(feffect=1)
				peffect=1
				oldpfilter=1
			}
			if((feffect=1)&(peffect=0)){
				dim mid,1
				//dim mid_pre,1
				dim hPeakFX,1
				dim hPeakFX2,1
				dim hCompFX,1
				dim hVolFX2,1
				dim hBitCFX,1
				peffect=1
				oldpfilter=1
				anagain.0.0=0
				anagain.0.1=50
				anagainnum=1
				laserdelay1=0
				disableshuwa=1
			}
			foreach mid
				mid.cnt=-1
				//mid_pre.cnt=-1
			loop
			foreach mid
				if(auto=0){
					if((length(csongfile)<=cnt)|((cnt>=2)&(peffect=1))){
						ccsongfile=csongfile.min(cnt\2,length(csongfile)-1)
					}else{
						ccsongfile=csongfile.cnt
					}
				}else{
					if((length(csongfile)<=cnt)|((cnt>=2)&(peffect=1))){
						ccsongfile=csongfile.min(1,length(csongfile)-1)
					}else:if((auto=1)&(length(csongfile)>=4)&(strsize!=-1)){
						ccsongfile=csongfile.(min(cnt,length(csongfile)-1))
					}else{
						ccsongfile=csongfile.(length(csongfile)-1)
					}
				}
				csongfile_exist=1
				exist ccsongfile
				if(strsize<=0):csongfile_exist=0
				//if((strsize<=0)&(strmid(csongfile.cnt,0,5)!="http:")):csongfile_exist=0
				if((strmid(ccsongfile,0,5)="http:")|(strmid(ccsongfile,0,6)="https:")){
					mid.cnt=BASS_StreamCreateURL(ccsongfile,0,0x20000,0,0,0)
					mlength=BASS_ChannelGetLength_ms(mid.cnt)
					if((peffect=1)&(auto=1)){
						hPeakFX.cnt=BASS_ChannelSetFX(mid.cnt,0x10013,2)
						hPeakFX2.cnt=BASS_ChannelSetFX(mid.cnt,0x10013,3)
						hBitCFX.cnt=BASS_VST_ChannelSetDSP(mid.cnt,dir_default+"\\lib\\bitc.dll",0,8)
						BASS_VST_SetParam_R hBitCFX.cnt,0,0.0f
						hCompFX.cnt=-1
						hVolFX2.cnt=-1
					}else:if((peffect=1)/*&(cnt>=2)*/){
						hPeakFX.cnt=BASS_ChannelSetFX(mid.cnt,0x10013,2)
						hPeakFX2.cnt=BASS_ChannelSetFX(mid.cnt,0x10013,3)
						hBitCFX.cnt=BASS_VST_ChannelSetDSP(mid.cnt,dir_default+"\\lib\\bitc.dll",0,8)
						BASS_VST_SetParam_R hBitCFX.cnt,0,0.0f
						hCompFX.cnt=-1
						hVolFX2.cnt=-1
					}
					csongfile_exist=1
				}else{
					/*
					mid_pre.cnt=BASS_StreamCreateFile(0,ccsongfile,0,0,0,0,0x20000)
					BASS_ChannelSetAttribute mid_pre.cnt,2,0.0f
					BASS_ChannelPlay mid_pre.cnt*/
					mdataptr=0
					exist ccsongfile
					if(strsize>0){
						if(cnt=0){
							sdim mdata0,strsize
							bload ccsongfile,mdata0
							mdataptr=varptr(mdata0)
						}else:if(cnt=1){
							sdim mdata1,strsize
							bload ccsongfile,mdata1
							mdataptr=varptr(mdata1)
						}else:if(cnt=2){
							sdim mdata2,strsize
							bload ccsongfile,mdata2
							mdataptr=varptr(mdata2)
						}else{
							sdim mdata3,strsize
							bload ccsongfile,mdata3
							mdataptr=varptr(mdata3)
						}
						mid.cnt=BASS_StreamCreateFile(1,mdataptr,0,0,strsize,0,0x20000)
					}
					if(cnt=0){
						mlength=BASS_ChannelGetLength_ms(mid.cnt)
					}else{
						BASS_ChannelSetLink mid.0,mid.cnt
						if(BASS_ErrorGetCode()!=0){
							mlinkfailed=mlinkfailed|1
						}
					}
					if((peffect=1)&(auto=1)){
						hPeakFX.cnt=BASS_ChannelSetFX(mid.cnt,0x10013,2)
						hPeakFX2.cnt=BASS_ChannelSetFX(mid.cnt,0x10013,3)
						hCompFX.cnt=-1
						hBitCFX.cnt=BASS_VST_ChannelSetDSP(mid.cnt,dir_default+"\\lib\\bitc.dll",0,8)
						BASS_VST_SetParam_R hBitCFX.cnt,0,0.0f
						hVolFX2.cnt=-1
					}else:if((peffect=1)/*&(cnt>=2)*/){
						hPeakFX.cnt=BASS_ChannelSetFX(mid.cnt,0x10013,2)
						hPeakFX2.cnt=BASS_ChannelSetFX(mid.cnt,0x10013,3)
						hBitCFX.cnt=BASS_VST_ChannelSetDSP(mid.cnt,dir_default+"\\lib\\bitc.dll",0,8)
						BASS_VST_SetParam_R hBitCFX.cnt,0,0.0f
						hCompFX.cnt=-1
						hVolFX2.cnt=-1
					}
				}
			loop
			continue
		}
		if(StartsWith(d.cnt, "ver=")){
			csongver=strmid(d.cnt,4,128)
			csongver_int=int(strmid(csongver,0,3))
			continue
		}
		if(StartsWith(d.cnt, "mvol=")){
			csongvol=int(strmid(d.cnt,5,5))*dirvol/100
			continue
		}
		if(StartsWith(d.cnt, "pfilterdelay=")){
			laserdelay1=int(strmid(d.cnt,13,16))
			if(laserdelay<0):laserdelay1=40
			if(laserdelay>160):laserdelay1=160
			continue
		}
		if(StartsWith(d.cnt, "v=")){
			cmovfile=strmid(d.cnt,2,128)
			_sjis_ cmovfile
			continue
		}
		if(StartsWith(d.cnt, "o=")){
			offset=int(strmid(d.cnt,2,64))+diroffset
			continue
		}
		if(StartsWith(d.cnt, "vo=")){
			voffset=int(strmid(d.cnt,3,64))
			continue
		}
		if(StartsWith(d.cnt, "total=")){
			csongtotal=int(strmid(d.cnt,6,64))
			continue
		}
		if(StartsWith(d.cnt, "t=")){
			if((int(double(strmid(d.cnt,2,64))*1000)>0)&(strmid(d.cnt,2,64)=replace(strmid(d.cnt,2,64),"-",""))){
				bpm=int(double(strmid(d.cnt,2,64))*1000)
				if(cnt3<0){
					bpml.bpmlnum.0=int(cbcnt)
				}else{
					bpml.bpmlnum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+int(cbcnt)
				}
				if(bpml.bpmlnum.0<0):bpml.bpmlnum.0=0
				bpml.bpmlnum.1=bpm
				bpmlnum++
			}
			continue
		}
		if(StartsWith(d.cnt, "to=")){
			csongoftbpm=int(double(strmid(d.cnt,3,16))*1000)
			if(csongoftbpm<1):csongoftbpm=0
			if(csongoftbpm>65535000):csongoftbpm=0
			continue
		}
		if(StartsWith(d.cnt, "beat=")){
			sdim beatstat,16,2
			stat1=strmid(d.cnt,5,33)
			split stat1,"/",beatstat
			if(length(beatstat)=2){
				if(cnt3<0){
					beatl.beatlnum.0=int(cbcnt)
				}else{
					beatl.beatlnum.0=(cnt2+1)*(UNIT_MEASURE*beatn/beatd)/div.cnt3+int(cbcnt)
				}
				beatl.beatlnum.1=int(beatstat.0)
				beatl.beatlnum.2=int(beatstat.1)
				if((beatl.beatlnum.1>0)&(beatl.beatlnum.2>0)){
					beatlnum++
					beatn=int(beatstat.0)
					beatd=int(beatstat.1)
				}
			}
			continue
		}
		if(StartsWith(d.cnt, "stop=")){
			if(adjmode!=1){
				if(cnt3<0){
					stp.stpnum.0=int(cbcnt)
				}else{
					stp.stpnum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+int(cbcnt)
				}
				if((stp.stpnum.0>=0)&(int(strmid(d.cnt,5,16))>0)){
					stp.stpnum.1=int(strmid(d.cnt,5,16))*625/12
					//stpsh+=stp.stpnum.1
					if(stpnum<=0){
						stpnum++
					}else:if(stp.(stpnum-1).0+stp.(stpnum-1).1<=stp.stpnum.0){
						stpnum++
					}
				}
			}
			continue
		}

		// 現在のmeasure値(カウント値)
		if(cnt3<0){
			cmeasure=int(cbcnt)
		}else:if(div.cnt3=0){
			cmeasure=int(cbcnt)
		}else{
			cmeasure=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+int(cbcnt)
		}
		
		if(StartsWith(d.cnt, "tilt=")){
			if(cnt3<0){
				tilt.tiltnum.0=cbcnt+stpsh
			}else{
				tilt.tiltnum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt
			}
			if(strmid(d.cnt,5,16)="normal"){
				tilt.tiltnum.1=0
			}else:if(strmid(d.cnt,5,16)="big"){
				tilt.tiltnum.1=1
			}else:if(strmid(d.cnt,5,16)="bigger"){
				tilt.tiltnum.1=1
			}else:if(strmid(d.cnt,5,16)="biggest"){
				tilt.tiltnum.1=2
			}else:if(strmid(d.cnt,5,16)="keep_normal"){
				tilt.tiltnum.1=3
			}else:if(strmid(d.cnt,5,16)="keep_bigger"){
				tilt.tiltnum.1=4
			}else:if(strmid(d.cnt,5,16)="keep_biggest"){
				tilt.tiltnum.1=5
			}else:if(strmid(d.cnt,5,16)="zero"){
				tilt.tiltnum.1=6
			}else:if(strmid(d.cnt,5,16)="keep"){
				tilt.tiltnum.1=4
			}else{
				// 傾きの数値指定(値の推移計算はGameSystemに移管済み)
				tilt.tiltnum.1=7
			}
			tiltp=tilt.tiltnum.1
			if((tilt.tiltnum.0!=0)|(tilt.tiltnum.1!=0)):tiltnum++
			continue
		}
		if(StartsWith(d.cnt, "center_split=")){
			anaranfl=2
			continue
		}
		if(StartsWith(d.cnt, "laserrange_l=")){
			anaran.anarannum.0=0^pturna
			if(cnt3<0){
				anaran.anarannum.1=int(cbcnt)
			}else{
				anaran.anarannum.1=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+int(cbcnt)
			}
			if(strmid(d.cnt,13,2)="2x"){
				anaran.anarannum.2=2
			}else:anaran.anarannum.2=1
			anarannum++
			anaranfl=2
			continue
		}
		if(StartsWith(d.cnt, "laserrange_r=")){
			anaran.anarannum.0=1^pturna
			if(cnt3<0){
				anaran.anarannum.1=int(cbcnt)
			}else{
				anaran.anarannum.1=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+int(cbcnt)
			}
			if(strmid(d.cnt,13,2)="2x"){
				anaran.anarannum.2=2
			}else:anaran.anarannum.2=1
			anarannum++
			anaranfl=2
			continue
		}
		if(StartsWith(d.cnt, "pfiltergain=")){
			if(cnt3<0){
				anagain.anagainnum.0=int(cbcnt)
			}else{
				anagain.anagainnum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+int(cbcnt)
			}
			if(((int(strmid(d.cnt,12,3))=0)&(oldpfilter=0))|((int(strmid(d.cnt,12,3))>0)&(int(strmid(d.cnt,12,3))<=100))){
				anagain.anagainnum.1=int(strmid(d.cnt,12,3))
				anagainnum++
			}
			continue
		}
		if(StartsWith(d.cnt, "chokkakuvol=")){
			if(cnt3<0){
				anvol.anvolnum.0=int(cbcnt)
			}else{
				anvol.anvolnum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+int(cbcnt)
			}
			if((int(strmid(d.cnt,12,3))>=0)&(int(strmid(d.cnt,12,3))<=100)){
				anvol.anvolnum.1=int(strmid(d.cnt,12,3))
				anvolnum++
			}
			continue
		}
		if(StartsWith(d.cnt, "chokkakuse=")){
			if(cnt3<0){
				anse.ansenum.0=int(cbcnt)
			}else{
				anse.ansenum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+int(cbcnt)
			}
			f=1
			switch strmid(d.cnt,11,64)
			case "down"
				anse.ansenum.1=1
				swbreak
			case "up"
				anse.ansenum.1=2
				swbreak
			case "swing"
				anse.ansenum.1=3
				swbreak
			case "mute"
				anse.ansenum.1=4
				swbreak
			default
				f=0
			swend
			if(f=1):ansenum++
			continue
		}
		stat1=replace(d.cnt,"\t"," ")
		if(strmid(stat1,0,11)="#define_fx "){
			fxdefbuf_fx+=stat1+"\n"
			continue
		}
		if(strmid(stat1,0,15)="#define_filter "){
			fxdefbuf_filter+=stat1+"\n"
			continue
		}
		if((strmid(d.cnt,7,1)!="|")|(d.cnt!=replace(d.cnt,"=",""))){
			continue
		}
		if(cnt3<0):continue
		if(div.cnt3=0):continue
		cnt2++ // カレント小節数/div(小節内)
	loop
	if(csongver=""){
		csongvol=csongvol*6/10
	}
	cmov=(cmovfile="")

	// 直角音を読み込む
	loadLaserSlamSounds csongver_int

	// layer名をパース
	if(csonglayerstr!=""){
		sdim bgnamestat,0,1
		if(csongver_int>=166){
			split csonglayerstr,";",bgnamestat
		}else{
			split csonglayerstr,"/",bgnamestat
		}
		if(length(bgnamestat)=3){
			if(bgnamestat.2="2"):bgrotation=2
			if(bgnamestat.2="1"):bgrotation=1
			if(bgnamestat.2="0"):bgrotation=0
			bgname_l=bgnamestat.0
			bgspeed=int(bgnamestat.1)
		}else:if(length(bgnamestat)=2){
			bgname_l=bgnamestat.0
			bgspeed=int(bgnamestat.1)
		}else{
			bgname_l=csonglayerstr
			bgspeed=0
		}
	}
	
	// BPMの記述がない場合BPMを120にする
	if(bpmlnum=0){
		bpml.0.0=0
		bpml.0.1=120000
		bpmlnum=1
	}
	
	// BPMの上限を65535.000にする
	if(int(strmid(csongver,0,3))>=130){
		repeat bpmlnum
			bpml.cnt.1=min(bpml.cnt.1,65535000)
		loop
	}
	
	if(csongvol>100){
		dim hVolFX,length(mid)
		foreach mid
			hVolFX.cnt=BASS_ChannelSetFX(mid.cnt,0x10003,5)
			dim volfx,2
			volfx=0,tofloat(double(csongvol)/100.0f)
			BASS_FXSetParameters hVolFX.cnt,volfx
		loop
		dim hVolFX,swaudionum
		repeat swaudionum
			hVolFX_sw.cnt=BASS_ChannelSetFX(mid_sw.cnt,0x10003,5)
			dim volfx,2
			volfx=0,tofloat(double(csongvol)/100.0f)
			BASS_FXSetParameters hVolFX_sw.cnt,volfx
		loop
		csongvol=100
	}
	
	// 最大BPM値を調べる
	maxbpm=1
	maxbpm_ir=1
	repeat bpmlnum
		if(maxbpm<bpml.cnt.1):maxbpm=min(bpml.cnt.1,65535000)
		if(maxbpm_ir<bpml.cnt.1):maxbpm_ir=bpml.cnt.1
	loop
	
	// 最小BPM値を調べる(IR用)
	minbpm_ir=bpml.0.1
	repeat bpmlnum-1,1
		if(minbpm_ir>bpml.cnt.1):minbpm_ir=bpml.cnt.1
	loop
	
	// 平均BPM値を調べる
	if(beatlnum=0){
		beatl.0.0=0
		beatl.0.1=4
		beatl.0.2=4
		beatlnum=1
	}
	repeat bpmlnum
		bpml.cnt.2=c2t(bpml.cnt.0)
	loop
	ddim avestat,1
	avebpm=min(bpml.0.1,65535000)
	if(bpmlnum>1){
		stat1=c2t(b2c(divnum))
		repeat bpmlnum
			if(cnt<bpmlnum-1){
				avestat+=double(min(bpml.cnt.1,65535000))*(bpml.(cnt+1).2-bpml.cnt.2)
			}else{
				avestat+=double(min(bpml.cnt.1,65535000))*(stat1-bpml.cnt.2)
			}
		loop
		avestat/=max(stat1,1)
		avebpm=max(int(avestat),1)
	}
	
	// コマンドラインでの開始地点指定を計算
	if(cmdline_from!=0){
		cmdline_from=b2c(cmdline_from)
	}
	
	// 最頻BPM値を調べる
	dim oftbpmstat,65535
	oftbpm=1
	oftstat=0
	repeat bpmlnum
		if(cnt<bpmlnum-1){
			oftbpmstat.(min(max(bpml.cnt.1/1000,1),65535)-1)+=bpml.(cnt+1).0-bpml.cnt.0
		}else{
			oftbpmstat.(min(max(bpml.cnt.1/1000,1),65535)-1)+=b2c(divnum)-bpml.cnt.0
		}
		if((oftstat<oftbpmstat.(min(max(bpml.cnt.1/1000,1),65535)-1))|((oftstat=oftbpmstat.(min(max(bpml.cnt.1/1000,1),65535)-1))&(min(max(bpml.cnt.1/1000,1),65535)>oftbpm))){
			oftstat=oftbpmstat.(min(max(bpml.cnt.1/1000,1),65535)-1)
			oftbpm=min(max(bpml.cnt.1/1000,1),65535)
		}
	loop
	oftbpm*=1000
	if((csongoftbpm>0)&(csongoftbpm>=minbpm)&(csongoftbpm<=maxbpm)):oftbpm=csongoftbpm
	dim oftbpmstat,0
	
	// プレイ前の画面の表示
	imgbufload_bg "bg3.jpg",149,"image/jpeg",1
	BASS_ChannelSlideAttribute selbgmid,2,0.0,50
	timestart=d3timer()
	if((courseend!=1)&(cmdline_from=0)){
		BASS_ChannelSetAttribute selenterid,2,double(mastervol)/100
		BASS_ChannelSetPosition_ms selenterid,0
		BASS_ChannelPlay selenterid
	}
	alDeleteImage 35
	if(iscmdline=0){
		alCreateImageByFile 35,dir_default+"\\songs\\"+csongdir+"\\"+csongjacket
	}else{
		if(instr(csongjacket,0,".")=-1){
			alCreateImageByFile 35,dir_default+"\\imgs\\jacket\\"+csongjacket+".jpg"
		}else{
			alCreateImageByFile 35,getpath(cnotesfile,32)+"\\"+csongjacket
		}
	}
	buffer 129,getsize(320),getsize(320)
	alStretchImageToScreen 35,129,0,0,alGetWidth(),alGetHeight(),0,0,getsize(300),getsize(300)
	endfl2=0
	gosub *pl_minfoprepare
	enterkeyp=0
	enterfl=0
	lastkeyt=1200
	if((analoginput=2)&(analogmode=mode_on)&(ts3>30)){
		if(hidem=1):mouse -1,-1
		mouse defx,defy
	}
	dim sliderp,2
	if(analoginput=4){
		repeat 2
			cnt0=cnt
			sliderp.cnt=0
			repeat length_joylist
				joyGetPosEx joystat2,joylist.cnt
				sliderp.cnt0+=joystat2.(4+(cnt0^analogsw))
			loop
		loop
	}
	slider=0
	repeat
		if(courseend=1):break
		if(cmdline_from>0):break
		gosub *getjoystat
		timenow=d3timer()-timestart
		if(ts>120):ts=0
		if(ts2>60):ts2=0
		if(ts3>30):ts3=0
		ts+=max(timenow-timep,1)
		ts2+=max(timenow-timep,1)
		ts3+=max(timenow-timep,1)
		dim stickstat,2
		if(analoginput=2){
			repeat 2
				cnt0=cnt
				ddim dstat1,1
				if(cnt0=0):dstat1=(ginfo_mx-defx)*2*(mx*2-1)
				if(cnt0=1):dstat1=(ginfo_my-defy)*2*(my*2-1)
				stat1=int(round(dstat1*msen*2))
				if(abs(stat1)<10){
					stickstat.cnt=0
				}else{
					stickstat.cnt=sgn(stat1)*min(abs(int(double(sgn(stat1)*(abs(stat1)-10))))/120,22000*max(timenow-timep,2)/16/300)
				}
			loop
		}
		if(analoginput=4){
			repeat 2
				cnt0=cnt
				slider=0
				repeat length_joylist
					joyGetPosEx joystat2,joylist.cnt
					slider+=joystat2.(4+(cnt0^analogsw))
				loop
				stat1=slider-sliderp.cnt0
				sliderp.cnt0=slider
				if(abs(stat1)>32768):stat1-=sgn(stat1)*65536
				stat1=stat1*msen/400
				if(abs(stat1)<25){
					stickstat.cnt=0
				}else{
					stickstat.cnt=sgn(stat1)*min(abs(int(double(sgn(stat1)*(abs(stat1)-25))*max(timenow-timep,2)/150)),max(timenow-timep,2))
				}
			loop
		}
		if(analoginput=5){
			repeat 2
				cnt0=cnt
				slider=0
				repeat length_joylist
					joyGetPosEx joystat2,joylist.cnt
					slider+=joystat2.(2+(cnt0^analogsw))
				loop
				stat1=slider-sliderp.cnt0
				sliderp.cnt0=slider
				if(abs(stat1)>32768):stat1-=sgn(stat1)*65536
				stat1=stat1*msen/400
				if(abs(stat1)<25){
					stickstat.cnt=0
				}else{
					stickstat.cnt=sgn(stat1)*min(abs(int(double(sgn(stat1)*(abs(stat1)-25))*max(timenow-timep,2)/150)),max(timenow-timep,2))
				}
			loop
		}
		if(analoginput=3){
			repeat 2
				cnt0=cnt
				stat1=0
				repeat length_joylist
					joyGetPosEx joystat2,joylist.cnt
					stat1+=joystat2.(2+(cnt0^analogsw)*2)-32768
				loop
				if(abs(stat1)<12000){
					stickstat.cnt=0
				}else{
					stickstat.cnt=sgn(stat1)*min(abs(int(double(sgn(stat1)*(abs(stat1)-12000))*max(timenow-timep,2)/16/300)),18000*max(timenow-timep,2)/16/300)
				}
			loop
		}
		getkey enter_key,13
		enter_key=enter_key|getjoykeystat(11)
		if(ginfo2()=0){
			gosub *refreshhs
			getkey_a stat1,38
			getkey stat2,key.(7+2*analogsw)
			getkey stat3,key.(9-2*analogsw)
			stat1=stat1|((stat2|stat3)&(enter_key=1))
			getkey stat2,key2.(7+2*analogsw)
			getkey stat3,key2.(9-2*analogsw)
			stat1=stat1|((stat2|stat3|getjoykeystat(7+2*analogsw)|getjoykeystat(9-2*analogsw)|(stickstat.0>0)|(stickstat.1>0))&(enter_key=1))
			if((stat1=1)&(ts2>60)){
				if((hstypenow=0)&(hsr<99)){
					hsr++
				}else:if((hstypenow=1)&(hso<2000)){
					hso+=25
				}else:if((hstypenow=2)&(hsc<2000)){
					hsc+=25
				}else:if((hstypenow=3)&(hsm<2000)){
					hsm+=25
				}else:if((hstypenow=4)&(hsa<2000)){
					hsa+=25
				}
				enterfl=1
				if(timenow<lastkeyt+1700):lastkeyt=max(timenow,lastkeyt)
			}
			getkey_a stat1,40
			getkey stat2,key.(6+2*analogsw)
			getkey stat3,key.(8-2*analogsw)
			stat1=stat1|((stat2|stat3)&(enter_key=1))
			getkey stat2,key2.(6+2*analogsw)
			getkey stat3,key2.(8-2*analogsw)
			stat1=stat1|((stat2|stat3|getjoykeystat(6+2*analogsw)|getjoykeystat(8-2*analogsw)|(stickstat.0<0)|(stickstat.1<0))&(enter_key=1))
			if((stat1=1)&(ts2>60)){
				if((hstypenow=0)&(hsr>5)){
					hsr--
				}else:if((hstypenow=1)&(hso>25)){
					hso-=25
				}else:if((hstypenow=2)&(hsc>25)){
					hsc-=25
				}else:if((hstypenow=3)&(hsm>25)){
					hsm-=25
				}else:if((hstypenow=4)&(hsa>25)){
					hsa-=25
				}
				enterfl=1
				if(timenow<lastkeyt+1700):lastkeyt=max(timenow,lastkeyt)
			}
			getkey stat1,37
			getkey stat2,key.4
			stat1=stat1|(stat2&(enter_key=1))
			getkey stat2,key2.4
			stat1=stat1|((stat2|getjoykeystat(4))&(enter_key=1))
			if((stat1=1)&(ts>120)){
				gosub *refreshhs
				if(hstypenow=0){
					stat2=bpm*hsr/10
				}else:if(hstypenow=1){
					stat2=int(double(hso)*bpm*1000f/oftbpm)
				}else:if(hstypenow=2){
					stat2=hsc*1000
				}else:if(hstypenow=3){
					stat2=int(double(hsm)*bpm*1000f/maxbpm)
				}else:if(hstypenow=4){
					stat2=int(double(hsa)*bpm*1000f/avebpm)
				}
				hsr=10
				hsc=-1
				hsm=-1
				hsa=-1
				hso=-1
				repeat 5
					hstypenow--
					if(hstypenow<0):hstypenow=4
					if(vhstype.hstypenow=1):break
				loop
				if(hstypenow=0){
					hsr=max(min(int(round(double(stat2)/bpm*10)),99),5)
				}else:if(hstypenow=1){
					hso=ran(int(round(double(stat2)*oftbpm/bpm/25/1000))*25,25,2000)
				}else:if(hstypenow=2){
					hsc=ran(int(round(double(stat2)/25/1000))*25,25,2000)
				}else:if(hstypenow=3){
					hsm=ran(int(round(double(stat2)*maxbpm/bpm/25/1000))*25,25,2000)
				}else:if(hstypenow=4){
					hsa=ran(int(round(double(stat2)*avebpm/bpm/25/1000))*25,25,2000)
				}
				enterfl=1
				if(timenow<lastkeyt+1700):lastkeyt=max(timenow,lastkeyt)
			}
			getkey_a stat1,39
			getkey stat2,key.5
			stat1=stat1|(stat2&(enter_key=1))
			getkey stat2,key2.5
			stat1=stat1|((stat2|getjoykeystat(5))&(enter_key=1))
			if((stat1=1)&(ts>120)){
				gosub *refreshhs
				if(hstypenow=0){
					stat2=bpm*hsr/10
				}else:if(hstypenow=1){
					stat2=int(double(hso)*bpm*1000f/oftbpm)
				}else:if(hstypenow=2){
					stat2=hsc*1000
				}else:if(hstypenow=3){
					stat2=int(double(hsm)*bpm*1000f/maxbpm)
				}else:if(hstypenow=4){
					stat2=int(double(hsa)*bpm*1000f/avebpm)
				}
				hsr=10
				hsc=-1
				hsm=-1
				hsa=-1
				hso=-1
				repeat 5
					hstypenow++
					if(hstypenow>4):hstypenow=0
					if(vhstype.hstypenow=1):break
				loop
				if(hstypenow=0){
					hsr=max(min(int(round(double(stat2)/bpm*10)),99),5)
				}else:if(hstypenow=1){
					hso=ran(int(round(double(stat2)*oftbpm/bpm/25/1000))*25,25,2000)
				}else:if(hstypenow=2){
					hsc=ran(int(round(double(stat2)/25/1000))*25,25,2000)
				}else:if(hstypenow=3){
					hsm=ran(int(round(double(stat2)*maxbpm/bpm/25/1000))*25,25,2000)
				}else:if(hstypenow=4){
					hsa=ran(int(round(double(stat2)*avebpm/bpm/25/1000))*25,25,2000)
				}
				enterfl=1
				if(timenow<lastkeyt+1700):lastkeyt=max(timenow,lastkeyt)
			}
		}
		gosub *refreshhs
		if(hstypenow=0){
			hs=108*hsr/10/2
		}else:if(hstypenow=1){
			hs=108*hso*1000/oftbpm/2
		}else:if(hstypenow=2){
			hs=108/2
		}else:if(hstypenow=3){
			hs=108*hsm*1000/maxbpm/2
		}else{
			hs=108*hsa*1000/avebpm/2
		}
		if(hs<1):hs=1
		gsel 0
		redraw 0
		pos 0,0
		gcopy 149,0,0,scrsize_w,scrsize_h
		alResetCopyMode
		alCopyImageToScreen 53,0,scrsize_w/2-getsize(180),scrsize_h/2+getsize(100)
		pos scrsize_w/2-(300-int(double(60)*sin(double(min(timenow,3000))*M_PI/2/3000)))*scrsize_h/480/2,scrsize_h/2-(300-int(double(60)*sin(double(min(timenow,3000))*M_PI/2/3000)))*scrsize_h/480/2-getsize(60)
		gzoom (300-int(double(60)*sin(double(min(timenow,3000))*M_PI/2/3000)))*scrsize_h/480,(300-int(double(60)*sin(double(min(timenow,3000))*M_PI/2/3000)))*scrsize_h/480,129,0,0,getsize(300),getsize(300),1
		alCopyImageToScreen 97,0,scrsize_w-getsize(226),scrsize_h-getsize(27)
		if((hsc=-1)&(hsm=-1)&(hsa=-1)&(hso=-1)){
			if(strlen(str(hsr))=1){
				stat1="x0."+hsr
			}else{
				stat1=str(hsr)
				stat1="x"+strmid(stat1,0,1)+"."+strmid(stat1,1,1)
			}
		}else:if(hsc!=-1){
			stat1="C"
		}else:if(hsm!=-1){
			stat1="m"+hsm
		}else:if(hsa!=-1){
			stat1="a"+hsa
		}else{
			stat1=""+hso
		}
		stat3=0
		stat4=0
		repeat strlen(stat1)
			if(strmid(stat1,cnt,1)="."){
				stat3+=5*scrsize_h/480
			}
		loop
		repeat strlen(stat1)
			if(int(strmid(stat1,cnt,1))=0){
				if(strmid(stat1,cnt,1)="x"){
					stat2=11
				}else:if(strmid(stat1,cnt,1)="C"){
					stat2=12
				}else:if(strmid(stat1,cnt,1)="m"){
					stat2=13
				}else:if(strmid(stat1,cnt,1)="a"){
					stat2=14
				}else:if(strmid(stat1,cnt,1)="."){
					stat2=10
					stat4+=5*scrsize_h/480
				}else:if(strmid(stat1,cnt,1)=" "){
					continue
				}else{
					stat2=0
				}
			}else{
				stat2=int(strmid(stat1,cnt,1))
			}
			alCopyImageToScreen 52,0,scrsize_w-getsize(92)-getsize(10)*strlen(stat1)/2+stat3/2+getsize(10)*cnt-stat4,scrsize_h-getsize(17),getsize(10),getsize(9),0,getsize(9)*stat2
		loop
		if((hsc=-1)&(hsm=-1)&(hsa=-1)&(hso=-1)){
			stat1=int(double(bpml.0.1)*hsr/10000)
		}else:if(hsc!=-1){
			stat1=hsc
		}else:if(hsm!=-1){
			stat1=int(double(bpml.0.1/100)*hsm/maxbpm*100)
		}else:if(hsa!=-1){
			stat1=int(double(bpml.0.1/100)*hsa/avebpm*100)
		}else{
			stat1=int(double(bpml.0.1/100)*hso/oftbpm*100)
		}
		stat1=str(stat1)
		repeat strlen(stat1)
			if(int(strmid(stat1,cnt,1))=0){
				if(strmid(stat1,cnt,1)="x"){
					stat2=11
				}else:if(strmid(stat1,cnt,1)="C"){
					stat2=12
				}else:if(strmid(stat1,cnt,1)="m"){
					stat2=13
				}else:if(strmid(stat1,cnt,1)="a"){
					stat2=14
				}else:if(strmid(stat1,cnt,1)=" "){
					continue
				}else{
					stat2=0
				}
			}else{
				stat2=int(strmid(stat1,cnt,1))
			}
			alCopyImageToScreen 52,0,scrsize_w-getsize(35)-getsize(10)*strlen(stat1)/2+getsize(10)*cnt,scrsize_h-getsize(17),getsize(10),getsize(9),getsize(10),getsize(9)*stat2
		loop
		getkey f11_key,122
		esc_key=getesckey()
		enter_key=enter_key|f11_key
		enter_key=enter_key|getjoykeystat(11)|getjoykeystat(13)
		if((timenow>lastkeyt+1800)|((enterfl=0)&(timenow>1200)&(enter_key=0)&(enter_keyp=1)&(ginfo2()=0))|((esc_key=1)&(ginfo2()=0))){
			if((esc_key=1)&(ginfo2()=0)):endfl2=1:autodemo=0
			break
		}else{
			gmode 3,,,max(256-(d3timer()-timestart)*256/1200,0)
			color 255,255,255
			gsquare -1,sx_a,sy_a
			gmode 3,,,max((d3timer()-timestart-(lastkeyt+1500))*256/300,0)
			color 0,0,0
			gsquare -1,sx_a,sy_a
			gmode 0
			enter_keyp=enter_key
		}
		if((ts2>60)&(analoginput=2)){
			if(hidem=1):mouse -1,-1
			mouse defx,defy
		}
		redraw 1
		timep=timenow
		await 7
		if(analoginput=1){
			keshucnt=0:onkey 1
		}
	loop
	buffer 149,1,1
	courseendfl=0
	if(endfl2=1){
		if(((auto=1)|(adjmode=1))&(length(kmode)=3)){
			shortmode=kmode.0
			longmode=kmode.1
			analogmode=kmode.2
		}
		if((iscourse=0)|(coursenow=0)){
			BASS_ChannelSlideAttribute selenterid,2,0.0,250
			chdir dir_default+"\\songs"
			refreshsonglistoff=1
			scene=SCENE_SELECT
		}else{
			BASS_ChannelSlideAttribute selenterid,2,0.0,250
			endfl2=0
			autodemo=0
			courseendfl=1
		}
	}
	gsel 0
	color 0,0,0
	boxf
	if(endfl2=1){
		pos 0,0
		gcopy 29,0,0,scrsize_w,scrsize_h
	}
	alCopyImageToScreen IMG_LOADING,0,scrsize_w-getsize(208),getsize(442)
	redraw 1:await 7:redraw 0
	if(endfl2=1):endfl2=0:return
	if((cmovfile!="")&(output=0)){
		if(vmov=1){
			mci "open \""+cmovfile+"\" type MPEGVideo alias v"
			mci "set v audio all off"
			mci "set v time format ms"
			gsel 0
			mci "window v handle "+hwnd
			mci "put v destination at "+(scrsize_w/2-getsize(302))+" "+getsize(140)+" "+getsize(160)+" "+getsize(120)
		}
	}
	if(feffect=0){
		userfxnum=0
		swaudionum=0
	}
	if(feffect=1){
		notesel fxdefbuf_fx
		repeat notemax
			notesel fxdefbuf_fx
			noteget stat1,cnt
			stat1=strmid(stat1,11,1024)
			stat1=strtrim(stat1,0,' ')
			if(stat1=""):continue
			sdim fxdefstat,,2
			fxdefstat.0=strmid(stat1,0,instr(stat1,0," "))
			fxdefstat.1=strmid(stat1,instr(stat1,0," ")+1,strlen(stat1)-instr(stat1,0," ")-1)
			if(length(fxdefstat)>=2){
				f2=1
				sdim fxdefstat2,1
				split fxdefstat.1,";",fxdefstat2
				foreach fxdefstat2
					fxdefstat2.cnt=strtrim(fxdefstat2.cnt,0,' ')
				loop
				// 一致するエフェクト名があるか調べる
				repeat FXDEF_FXTYPEMAX+1
					if(fxdef_name.0.cnt=""):continue
					if(fxdefstat2.0="type="+fxdef_name.0.cnt){
						userfx_name.userfxnum=fxdefstat.0
						userfx_params.userfxnum.0=double(cnt)
						// まずはデフォルト値を流し込む
						repeat fxdef_prmnum.cnt,1
							userfx_params.userfxnum.cnt=fxdef_default.cnt.(int(userfx_params.userfxnum.0))
							userfx_params_enable.userfxnum.cnt=fxdef_enable.cnt.(int(userfx_params.userfxnum.0))
						loop
						// 各パラメータ設定を反復処理
						repeat max(length(fxdefstat2)-1,0),1
							f=1
							sdim fxdefstat3,1
							split fxdefstat2.cnt,"=",fxdefstat3
							if(length(fxdefstat3)<=1){
								dialog "Warning: Unknown format (\""+fxdefstat2.cnt+"\")"
							}else{
								f=1
								// 一致するパラメータ名があるか調べる
								repeat fxdef_prmnum.(int(userfx_params.userfxnum.0)),1
									if(fxdefstat3.0=fxdef_name.cnt.(int(userfx_params.userfxnum.0))){
										if(fxdef_type.cnt.(int(userfx_params.userfxnum.0))=FXDEF_FILENAME){
											if(swaudionum>=31){
												dialog "Error: Too many \"Switch Audio\" Effects"
											}else{
												userfx_swaudiomid.userfxnum=swaudionum
												userfx_params.userfxnum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
											}
										}else{
											if(instr(fxdefstat3.1,0,">")=-1){
												userfx_params.userfxnum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
												userfx_params_enable.userfxnum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
											}else{
												userfx_params.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,0,">")),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
												userfx_params_enable.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,0,">")+1,256),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
											}
										}
										f=0
										break
									}
								loop
								if(f=1):dialog "Warning: Unknown paramater (\""+fxdefstat3.0+"\")"
							}
						loop
						userfxnum++
						f2=0
						break
					}
				loop
				if(f2=1):dialog "Error: Unknown effect type (\""+fxdefstat2.0+"\")"
			}
		loop
		notesel fxdefbuf_filter
		repeat notemax
			notesel fxdefbuf_filter
			noteget stat1,cnt
			stat1=strmid(stat1,15,1024)
			stat1=strtrim(stat1,0,' ')
			if(stat1=""):continue
			sdim fxdefstat,,2
			fxdefstat.0=strmid(stat1,0,instr(stat1,0," "))
			fxdefstat.1=strmid(stat1,instr(stat1,0," ")+1,strlen(stat1)-instr(stat1,0," ")-1)
			if(length(fxdefstat)>=2){
				f2=1
				sdim fxdefstat2,1
				split fxdefstat.1,";",fxdefstat2
				foreach fxdefstat2
					fxdefstat2.cnt=strtrim(fxdefstat2.cnt,0,' ')
				loop
				// 一致するエフェクト名があるか調べる
				repeat FXDEF_FXTYPEMAX+1
					if(fxdef_name.0.cnt=""):continue
					if(fxdefstat2.0="type="+fxdef_name.0.cnt){
						userfilter_name.userfilternum=fxdefstat.0
						userfilter_params.userfilternum.0=double(cnt)
						userfx_name.userfxnum=""
						userfx_params.userfxnum.0=double(cnt)
						// まずはデフォルト値を流し込む
						repeat fxdef_prmnum.cnt,1
							userfilter_params.userfilternum.cnt=fxdef_default.cnt.(int(userfilter_params.userfilternum.0))
							userfilter_params_min.userfilternum.cnt=fxdef_enable.cnt.(int(userfilter_params.userfilternum.0))
							userfilter_params_max.userfilternum.cnt=fxdef_enable.cnt.(int(userfilter_params.userfilternum.0))
							userfx_params.userfxnum.cnt=fxdef_default.cnt.(int(userfx_params.userfxnum.0))
							userfx_params_enable.userfxnum.cnt=fxdef_enable.cnt.(int(userfx_params.userfxnum.0))
						loop
						// 各パラメータ設定を反復処理
						repeat max(length(fxdefstat2)-1,0),1
							f=1
							sdim fxdefstat3,1
							split fxdefstat2.cnt,"=",fxdefstat3
							if(length(fxdefstat3)<=1){
								dialog "Warning: Unknown format (\""+fxdefstat2.cnt+"\")"
							}else{
								f=1
								// 一致するパラメータ名があるか調べる
								repeat fxdef_prmnum.(int(userfilter_params.userfilternum.0)),1
									if(fxdefstat3.0=fxdef_name.cnt.(int(userfilter_params.userfilternum.0))){
										if(fxdef_type.cnt.(int(userfx_params.userfxnum.0))=FXDEF_FILENAME){
											if(swaudionum>=31){
												dialog "Error: Too many \"Switch Audio\" Effects"
											}else{
												userfx_swaudiomid.userfxnum=swaudionum
												userfx_params.userfxnum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
											}
										}else{
											if(instr(fxdefstat3.1,0,">")=-1){
												if(instr(fxdefstat3.1,1,"-")=-1){
													userfilter_params.userfilternum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_min.userfilternum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_max.userfilternum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfx_params.userfxnum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
													userfx_params_enable.userfxnum.cnt=fxdef_str2param(fxdefstat3.1,fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
												}else{
													userfilter_params.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,1,"-")+1),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_min.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,1,"-")+1),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_max.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,1,"-")+2,256),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfx_params.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,1,"-")+1),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
													userfx_params_enable.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,1,"-")+1),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
												}
											}else{
												if(instr(fxdefstat3.1,instr(fxdefstat3.1,0,">")+2,"-")=-1){
													userfilter_params.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,0,">")),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_min.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,0,">")+1,256),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_max.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,0,">")+1,256),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfx_params.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,0,">")),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
													userfx_params_enable.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,0,">")+1,256),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
												}else{
													userfilter_params.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,0,">")),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_min.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,0,">")+1,instr(fxdefstat3.1,instr(fxdefstat3.1,0,">")+2,"-")+1),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfilter_params_max.userfilternum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,instr(fxdefstat3.1,0,">")+2,"-")+instr(fxdefstat3.1,0,">")+2+1,256),fxdef_type.cnt.(int(userfilter_params.userfilternum.0)))
													userfx_params.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,0,instr(fxdefstat3.1,0,">")),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
													userfx_params_enable.userfxnum.cnt=fxdef_str2param(strmid(fxdefstat3.1,instr(fxdefstat3.1,0,">")+1,instr(fxdefstat3.1,instr(fxdefstat3.1,0,">")+2,"-")+1),fxdef_type.cnt.(int(userfx_params.userfxnum.0)))
												}
											}
										}
										f=0
										break
									}
								loop
								if(f=1):dialog "Warning: Unknown paramater (\""+fxdefstat3.0+"\")"
							}
						loop
						userfilternum++
						userfxnum++
						f2=0
						break
					}
				loop
				if(f2=1):dialog "Error: Unknown effect type (\""+fxdefstat2.0+"\")"
			}
		loop
		dim userfx_fl,userfxnum
	}
	ddim rorp,1
	ddim ror_p,1
	cnt3=-1
	cnt2a=-1
	stat4=0
	stat4_2=0
	totalcombo=0
	mlinkfailed=0
	pturnlp=pturnl
	dim arfcnt,6
	dim np,6
	np=-1,-1,-1,-1,-1,-1
	ddim cbcnt,1
	beatn=4
	beatd=4
	t_finalnote=1
	fl_Retr=0
	fl_Gate=0
	fl_Flan=0
	fl_Pitc=0
	fl_BitC=0
	fl_Phas=0
	fl_TStp=0
	fl_Echo=0
	fl_SiCh=0
	dim fxfl,2
	dim anagrcnt,2

	// 直後のノーツに適用されるキー音情報
	sdim nextKeySoundNamesLR, 256, 2
	nextKeySoundNamesLR = "", ""
	nextKeySoundVolumesLR = 100, 100

	// 譜面内容を読み込む
	_csongtitle=csongtitle
	if (lpeek(_csongtitle, 0) & 0x00FFFFFF) == 0xBFBBEF{
		DeleteUTF8BOM _csongtitle
	}
	repeat sp
		cnt2a++
		if(StartsWith(d.cnt, "//")){
			continue
		}
		if(d.cnt="--"){
			cnt3++ // カレント小節数
			if(cnt3>0):cbcnt+=UNIT_MEASURE*beatn/beatd
			cnt2=-1
			continue
		}
		if(StartsWith(d.cnt, "t=")){
			bpm=int(double(strmid(d.cnt,2,16))*1000)
			continue
		}
		if(StartsWith(d.cnt, "beat=")){
			sdim beatstat,16,2
			stat1=strmid(d.cnt,5,33)
			split stat1,"/",beatstat
			if(length(beatstat)=2){
				if((int(beatstat.0)>0)&(int(beatstat.1)>0)){
					beatn=int(beatstat.0)
					beatd=int(beatstat.1)
				}
			}
			continue
		}
		if(StartsWith(d.cnt, "chiprate=")){
			if(strmid(d.cnt,9,2)="1x"){
				chiprate=1
			}else:if(strmid(d.cnt,9,2)="2x"){
				chiprate=2
			}else:if(strmid(d.cnt,9,2)="3x"){
				chiprate=3
			}
			continue
		}
		if(StartsWith(d.cnt, "longrate=")){
			if(strmid(d.cnt,9,2)="1x"){
				longrate=1
			}else:if(strmid(d.cnt,9,2)="2x"){
				longrate=2
			}else:if(strmid(d.cnt,9,2)="3x"){
				longrate=3
			}
			continue
		}
		if(StartsWith(d.cnt, "laserrate=")){
			if(strmid(d.cnt,10,2)="1x"){
				laserrate=1
			}else:if(strmid(d.cnt,10,2)="2x"){
				laserrate=2
			}else:if(strmid(d.cnt,10,2)="3x"){
				laserrate=2
			}
			continue
		}
		if(StartsWith(d.cnt, "filtertype=")){
			if(cnt3<0){
				anafil.anafilnum.0=int(cbcnt)
			}else{
				anafil.anafilnum.0=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+int(cbcnt)
			}
			f=1
			_cnt=cnt
			repeat userfilternum,userfxnum-userfilternum
				if(strmid(d._cnt,11,256)=userfilter_name.(cnt-(userfxnum-userfilternum))){
					anafil.anafilnum.1=100+cnt
					userfx_fl.cnt=1
					f=0
					break
				}
			loop
			if(f=1){
				if(strmid(d.cnt,11,4)="hpf1"){
					anafil.anafilnum.1=1
				}else:if(strmid(d.cnt,11,4)="hpf2"){
					anafil.anafilnum.1=2
				}else:if(strmid(d.cnt,11,4)="lpf1"){
					anafil.anafilnum.1=3
				}else:if(strmid(d.cnt,11,4)="lpf2"){
					anafil.anafilnum.1=4
				}else:if(strmid(d.cnt,11,4)="bitc"){
					anafil.anafilnum.1=5
				}else:if((feffect=1)&(strmid(d.cnt,11,7)="fx;bitc")){
					anafil.anafilnum.1=5
				}else:if((strmid(d.cnt,11,3)="fx;")|(strmid(d.cnt,11,3)="fx")){
					anafil.anafilnum.1=-1
				}else:if(strmid(d.cnt,11,4)="peak"){
					anafil.anafilnum.1=0
				}else{
					dialog "Error: Undefined filter (\""+strmid(d.cnt,11,256)+"\")"
					anafil.anafilnum.1=0
				}
			}
			anafilnum++
			continue
		}
		continuefl=0
		_cnt=cnt
		repeat 2
			if (startsWith(d._cnt, "fx-" + str_lr.cnt + "=")) {
				fx.fxnum.0=cnt
				if(cnt3<0){
					fx.fxnum.1=cbcnt
				}else{
					fx.fxnum.1=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt
				}
				stat1=strmid(d._cnt,5,64)
				if(stat1=""){
					fx.fxnum.2=0
				}else{
					sdim fxsplitstat,1
					split stat1,";",fxsplitstat
					f=1
					repeat userfxnum
						if(fxsplitstat.0=userfx_name.cnt){
							fx.fxnum.2=100+cnt
							userfx_fl.cnt=1
							if(userfx_params.cnt.0=FXDEF_FXTYPE_RETR){
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=8
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
							}else:if(userfx_params.cnt.0=FXDEF_FXTYPE_GATE){
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=4
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
							}else:if(userfx_params.cnt.0=FXDEF_FXTYPE_BITC){
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=5
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),64),1)
							}else:if(userfx_params.cnt.0=FXDEF_FXTYPE_WOBB){
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=12
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
							}else:if(userfx_params.cnt.0=FXDEF_FXTYPE_TSTP){
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=50
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),100),1)
							}else:if(userfx_params.cnt.0=FXDEF_FXTYPE_ECHO){
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=4
									fx.fxnum.4=60
								}else:if(length(fxsplitstat)<=2){
									fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
									fx.fxnum.4=60
								}else{
									fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
									fx.fxnum.4=max(min(int(fxsplitstat.2),100),0)
								}
							}else:if(userfx_params.cnt.0=FXDEF_FXTYPE_PITC){
								if(length(fxsplitstat)<=1){
									fx.fxnum.3=12
								}else:fx.fxnum.3=max(min(int(fxsplitstat.1),48),-48)
							}
							f=0
							break
						}
					loop
					if(f=1){
						switch fxsplitstat.0
						case "Retrigger":
							if(length(fxsplitstat)<=1){
								fx.fxnum.3=8
							}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
							if(fx.fxnum.3=12){
								fx.fxnum.2=FX_RE12
							}else:if(fx.fxnum.3=16){
								fx.fxnum.2=FX_RE16
							}else:if(fx.fxnum.3=24){
								fx.fxnum.2=FX_RE24
							}else:if(fx.fxnum.3=32){
								fx.fxnum.2=FX_RE32
							}else{
								fx.fxnum.2=FX_RE8
							}
							fl_Retr=1
							swbreak
						case "Gate":
							if(length(fxsplitstat)<=1){
								fx.fxnum.3=4
							}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
							if(fx.fxnum.3=8){
								fx.fxnum.2=FX_GA8
							}else:if(fx.fxnum.3=12){
								fx.fxnum.2=FX_GA12
							}else:if(fx.fxnum.3=16){
								fx.fxnum.2=FX_GA16
							}else:if(fx.fxnum.3=24){
								fx.fxnum.2=FX_GA24
							}else:if(fx.fxnum.3=32){
								fx.fxnum.2=FX_GA32
							}else{
								fx.fxnum.2=FX_GA4
							}
							fl_Gate=1
							swbreak
						case "Flanger":
							fx.fxnum.2=FX_FLAN
							fl_Flan=1
							swbreak
						case "PitchShift":
							if(length(fxsplitstat)<=1){
								fx.fxnum.3=12
							}else:fx.fxnum.3=max(min(int(fxsplitstat.1),48),-48)
							fx.fxnum.2=FX_PITC
							fl_Pitc=1
							swbreak
						case "Phaser":
							fx.fxnum.2=FX_PHAS
							fl_Phas=1
							swbreak
						case "BitCrusher":
							if(length(fxsplitstat)<=1){
								fx.fxnum.3=5
							}else:fx.fxnum.3=max(min(int(fxsplitstat.1),64),0)
							fx.fxnum.2=FX_BITC
							fl_BitC=1
							swbreak
						case "Wobble":
							if(length(fxsplitstat)<=1){
								fx.fxnum.3=12
							}else:fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
							fx.fxnum.2=FX_WO12
							fl_Gate=1
							swbreak
						case "TapeStop":
							if(length(fxsplitstat)<=1){
								fx.fxnum.3=50
							}else:fx.fxnum.3=max(min(int(fxsplitstat.1),100),0)
							fx.fxnum.2=FX_TSTP
							fl_TStp=1
							swbreak
						case "Echo":
							if(length(fxsplitstat)<=1){
								fx.fxnum.3=4
								fx.fxnum.4=60
							}else:if(length(fxsplitstat)<=2){
								fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
								fx.fxnum.4=60
							}else{
								fx.fxnum.3=max(min(int(fxsplitstat.1),192),1)
								fx.fxnum.4=max(min(int(fxsplitstat.2),100),0)
							}
							fx.fxnum.2=FX_EC4
							fl_Echo=1
							swbreak
						case "SideChain":
							fx.fxnum.2=FX_SICH
							fl_SiCh=1
							swbreak
						case "":
							fx.fxnum.2=0
							swbreak
						default:
							fx.fxnum.2=0
							dialog "Error: Undefined fx (\""+fxsplitstat.0+"\")"
						swend
					}
				}
				fxfl.cnt=1
				fxnum++
				continuefl=1
			}
		loop
		if(continuefl=1):continue
		if(StartsWith(d.cnt, "fx-l_param1=")){
			fxparams.fxparamsnum.0=0
			if(cnt3<0){
				fxparams.fxparamsnum.1=cbcnt
			}else{
				fxparams.fxparamsnum.1=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt
			}
			fxparams.fxparamsnum.2=int(strmid(d.cnt,12,8))
			fxparamsnum++
			continue
		}
		if(StartsWith(d.cnt, "fx-r_param1=")){
			fxparams.fxparamsnum.0=1
			if(cnt3<0){
				fxparams.fxparamsnum.1=cbcnt
			}else{
				fxparams.fxparamsnum.1=(cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt
			}
			fxparams.fxparamsnum.2=int(strmid(d.cnt,12,8))
			fxparamsnum++
			continue
		}
		if(StartsWith(d.cnt, "fx-l_se=")|StartsWith(d.cnt, "fx-r_se=")){
			_stat1=strmid(d.cnt,8,256)
			sdim splitstat,1
			split _stat1,";",splitstat
			_stat1 = splitstat.0
			if(length(splitstat)=1){
				_stat3=100
			}else{
				_stat3=min(max(int(splitstat.1),0),100)
			}
			loadKeySoundToLibrary _stat1, getpath(cnotesfile,32), csongver_int
			if(StartsWith(d.cnt, "fx-l_se=")){
				nextKeySoundNamesLR.0=_stat1
				nextKeySoundVolumesLR.0=_stat3
			}
			if(StartsWith(d.cnt, "fx-r_se=")){
				nextKeySoundNamesLR.1=_stat1
				nextKeySoundVolumesLR.1=_stat3
			}
			continue
		}
		if((StartsWith(d.cnt, "fx:")&(instr(d.cnt,3,"="))!=-1)){
			if(cnt3<0){
				userchprm.userchprmnum.0=c2tf(cbcnt)
			}else{
				userchprm.userchprmnum.0=c2tf((cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt)
			}
			sdim fxsplit_stat,1
			_stat1=strmid(d.cnt,3,instr(d.cnt,3,"="))
			_stat4=strmid(d.cnt,4+instr(d.cnt,3,"="),256)
			if(instr(_stat1,0,":")!=-1){
				_stat2=strmid(_stat1,0,instr(_stat1,0,":"))
				_stat3=0
				f=1
				repeat userfxnum-userfilternum
					// 一致するユーザー定義FXを探索
					if(_stat2=userfx_name.cnt){
						userchprm.userchprmnum.1=double(cnt)
						_stat3=int(userfx_params.cnt.0)
						f=0
						break
					}
				loop
				if(f=1){
					dialog "Error: Undefined fx (\""+_stat2+"\")"
				}else:if(_stat3=FXDEF_FXTYPE_AUDI){
					dialog "Error: Cannot change \"SwitchAudio\" value"
				}else{
					f=1
					_stat1=strmid(_stat1,instr(_stat1,0,":")+1,256)
					// 一致するパラメータ名があるか調べる
					repeat fxdef_prmnum._stat3,1
						if(_stat1=fxdef_name.cnt._stat3){
							userchprm.userchprmnum.2=double(cnt)
							if(instr(_stat4,0,">")=-1){
								userchprm.userchprmnum.3=fxdef_str2param(_stat4,fxdef_type.cnt._stat3)
								userchprm.userchprmnum.4=fxdef_str2param(_stat4,fxdef_type.cnt._stat3)
							}else{
								userchprm.userchprmnum.3=fxdef_str2param(strmid(_stat4,0,instr(_stat4,0,">")),fxdef_type.cnt._stat3)
								userchprm.userchprmnum.4=fxdef_str2param(strmid(_stat4,instr(_stat4,0,">")+1,256),fxdef_type.cnt._stat3)
							}
							userfx_fl.(int(userchprm.userchprmnum.1))=1
							userchprmnum++
							f=0
							break
						}
					loop
					if(f=1):dialog "Error: Unknown paramater (\""+_stat1+"\")"
				}
			}
			continue
		}
		if((StartsWith(d.cnt, "filter:")&(instr(d.cnt,7,"="))!=-1)){
			if(cnt3<0){
				userchprm.userchprmnum.0=c2tf(cbcnt)
			}else{
				userchprm.userchprmnum.0=c2tf((cnt2+1)*UNIT_MEASURE*beatn/beatd/div.cnt3+cbcnt)
			}
			_stat1=strmid(d.cnt,7,instr(d.cnt,7,"="))
			_stat4=strmid(d.cnt,8+instr(d.cnt,7,"="),256)
			if(instr(_stat1,0,":")!=-1){
				_stat2=strmid(_stat1,0,instr(_stat1,0,":"))
				_stat3=0
				f=1
				repeat userfilternum
					// 一致するユーザー定義FXを探索
					if(_stat2=userfilter_name.cnt){
						userchprm.userchprmnum.1=double(cnt+userfxnum-userfilternum)
						_stat3=int(userfx_params.(cnt+userfxnum-userfilternum).0)
						f=0
						break
					}
				loop
				if(f=1){
					dialog "Error: Undefined filter (\""+_stat2+"\")"
				}else:if(_stat3=FXDEF_FXTYPE_AUDI){
					dialog "Error: \"SwitchAudio\" value cannot be changed"
				}else{
					f=1
					_stat1=strmid(_stat1,instr(_stat1,0,":")+1,256)
					// 一致するパラメータ名があるか調べる
					repeat fxdef_prmnum._stat3,1
						if(_stat1=fxdef_name.cnt._stat3){
							userchprm.userchprmnum.2=double(cnt)
							if(instr(_stat4,0,">")=-1){
								if(instr(_stat4,1,"-")=-1){
									userchprm.userchprmnum.3=fxdef_str2param(_stat4,fxdef_type.cnt._stat3)
									userchprm.userchprmnum.4=fxdef_str2param(_stat4,fxdef_type.cnt._stat3)
									userchprm.userchprmnum.5=fxdef_str2param(_stat4,fxdef_type.cnt._stat3)
								}else{
									userchprm.userchprmnum.3=fxdef_str2param(strmid(_stat4,0,instr(_stat4,1,"-")+1),fxdef_type.cnt.(_stat3))
									userchprm.userchprmnum.4=fxdef_str2param(strmid(_stat4,0,instr(_stat4,1,"-")+1),fxdef_type.cnt.(_stat3))
									userchprm.userchprmnum.5=fxdef_str2param(strmid(_stat4,instr(_stat4,1,"-")+2,256),fxdef_type.cnt.(_stat3))
								}
							}else{
								if(instr(_stat4,instr(_stat4,0,">")+2,"-")=-1){
									userchprm.userchprmnum.3=fxdef_str2param(strmid(_stat4,0,instr(_stat4,0,">")),fxdef_type.cnt.(_stat3))
									userchprm.userchprmnum.4=fxdef_str2param(strmid(_stat4,instr(_stat4,0,">")+1,256),fxdef_type.cnt.(_stat3))
									userchprm.userchprmnum.5=fxdef_str2param(strmid(_stat4,instr(_stat4,0,">")+1,256),fxdef_type.cnt.(_stat3))
								}else{
									userchprm.userchprmnum.3=fxdef_str2param(strmid(_stat4,0,instr(_stat4,0,">")),fxdef_type.cnt.(_stat3))
									userchprm.userchprmnum.4=fxdef_str2param(strmid(_stat4,instr(_stat4,0,">")+1,instr(_stat4,instr(_stat4,0,">")+2,"-")+1),fxdef_type.cnt.(_stat3))
									userchprm.userchprmnum.5=fxdef_str2param(strmid(_stat4,instr(_stat4,instr(_stat4,0,">")+2,"-")+instr(_stat4,0,">")+2+1,256),fxdef_type.cnt.(_stat3))
								}
							}
							userfx_fl.(int(userchprm.userchprmnum.1))=1
							userchprmnum++
							f=0
							break
						}
					loop
					if(f=1):dialog "Error: Unknown paramater (\""+_stat1+"\")"
				}
			}
			continue
		}
		if((strmid(d.cnt,7,1)!="|")|(d.cnt!=replace(d.cnt,"=",""))){
			continue
		}
		if(cnt3<0){
			dialog lang.2.1/*"譜面データの始端には小節線(--)を入力する必要があります。"*/,1,lang.0.2
			endfl=1
			break
		}
		if(/*(d.cnt="--")|*/(div.cnt3=0)){
			continue
		}
		cnt2++ // カレント小節数/div(小節内)
		exc=0
		if(cnt2a>0){
			repeat
				if((cnt2a-cnt-1)<0){
					exc=-1
					break
				}
				if(strmid(d.(cnt2a-cnt-1),4,1)!="|"){
					exc++
					continue
				}
				break
			loop
		}
		// ショートオブジェクトのリストアップ
		repeat 4
			if(shortmode=3):break
			if(adjmode=1):break
			// short
			if(strmid(d.cnt2a,cnt,1)="1"){
				if(turn=1){
					note.notenum.0=3-cnt
				}else:if(turn=2){
					note.notenum.0=pturn.cnt
				}else{
					note.notenum.0=cnt
				}
				note.notenum.1=int(cbcnt)+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3
				if(note.notenum.1>=cmdline_from){
					note.notenum.2=0
					note.notenum.3=c2t(note.notenum.1)
					note.notenum.4=note.notenum.3
					note.notenum.5=-1
					note.notenum.7=chiprate
					if(np.cnt!=-1){
						note.(np.cnt).5=notenum
					}
					np.cnt=notenum
					note.notenum.6=0
					if(t_finalnote<note.notenum.4):t_finalnote=note.notenum.4
					if((coloring=1)&(div.cnt3!=0)){
						f=0
						if(cnt2=0){
							note.notenum.6=1
							f=1
						}
						if((f=0)&(div.cnt3>=2)){
							if((div.cnt3\2=0)&(cnt2\(div.cnt3/2)=0)){
								note.notenum.6=1
								f=1
							}
						}
						if((f=0)&(div.cnt3>=4)){
							if((div.cnt3\4=0)&(cnt2\(div.cnt3/4)=0)){
								note.notenum.6=1
								f=1
							}
						}
						if((f=0)&(div.cnt3>=8)){
							if((div.cnt3\8=0)&(cnt2\(div.cnt3/8)=0)){
								note.notenum.6=2
								f=1
							}
						}
						if((f=0)&(div.cnt3>=12)){
							if((div.cnt3\12=0)&(cnt2\(div.cnt3/12)=0)){
								note.notenum.6=3
								f=1
							}
						}
						if((f=0)&(div.cnt3>=16)){
							if((div.cnt3\16=0)&(cnt2\(div.cnt3/16)=0)){
								note.notenum.6=4
								f=1
							}
						}
						if((f=0)&(div.cnt3>=24)){
							if((div.cnt3\24=0)&(cnt2\(div.cnt3/24)=0)){
								note.notenum.6=5
								f=1
							}
						}
						if((f=0)&(div.cnt3>=32)){
							if((div.cnt3\32=0)&(cnt2\(div.cnt3/32)=0)){
								note.notenum.6=6
								f=1
							}
						}
						if((f=0)&(div.cnt3>=48)){
							if((div.cnt3\48=0)&(cnt2\(div.cnt3/48)=0)){
								note.notenum.6=7
								f=1
							}
						}
						if((f=0)&(div.cnt3>=64)){
							if((div.cnt3\64=0)&(cnt2\(div.cnt3/64)=0)){
								note.notenum.6=8
								f=1
							}
						}
					}
					notese.notenum=-1 // チップBTオブジェクトは効果音を鳴らさない
					notenum++
					if(shortmode!=mode_off){
						totalcombo++
						stat4+=6*chiprate
						stat4_2+=200*chiprate
					}
				}
				continue
			}
			// long
			lcnt=cnt
			if(bpm<256000){
				f1=(note.notenum.2<=UNIT_MEASURE*3/16)
				f2=UNIT_MEASURE_16
			}else{
				f1=(note.notenum.2<=UNIT_MEASURE*3/8)
				f2=UNIT_MEASURE_8
			}
			if(strmid(d.cnt2a,cnt,1)="2")&((strmid(d.(cnt2a-exc-1),cnt,1)!="2")|(exc=-1)){
				excd=0
				beatn2=beatn
				beatd2=beatd
				ddim lend,1
				lend=double(UNIT_MEASURE)*beatn2/beatd2/div.cnt3
				repeat
					if(cnt2a+cnt+1>=length(d)){
						break
					}
					if(d.(cnt2a+cnt+1)=""){
						continue
					}
					if(strmid(d.(cnt2a+cnt+1),0,2)="--"){
						excd++
						continue
					}
					if(StartsWith(d.(cnt2a+cnt+1), "beat=")){
						sdim beatstat,16,2
						stat1=strmid(d.(cnt2a+cnt+1),5,33)
						split stat1,"/",beatstat
						if(length(beatstat)=2){
							if((int(beatstat.0)>0)&(int(beatstat.1)>0)){
								beatn2=int(beatstat.0)
								beatd2=int(beatstat.1)
							}
						}
						continue
					}
					if(strmid(d.(cnt2a+cnt+1),4,1)!="|"){
						continue
					}
					if(strmid(d.(cnt2a+cnt+1),lcnt,1)="2"){
						if(div.(cnt3+excd)=0):break
						lend+=double(UNIT_MEASURE)*beatn2/beatd2/div.(cnt3+excd)
					}else{
						break
					}
				loop
				if(turn=1){
					note.notenum.0=3-cnt
				}else:if(turn=2){
					note.notenum.0=pturn.cnt
				}else{
					note.notenum.0=cnt
				}
				note.notenum.1=int(cbcnt)+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3
				if(note.notenum.1>=cmdline_from){
					note.notenum.2=int(lend)
					note.notenum.3=c2t(note.notenum.1)
					note.notenum.4=c2t(note.notenum.1+note.notenum.2)
					if(t_finalnote<note.notenum.4):t_finalnote=note.notenum.4
					if(shortmode!=1){
						if(bpm<256000){
							stat1=(note.notenum.2<=UNIT_MEASURE*3/16)
							stat2=UNIT_MEASURE_16
						}else{
							stat1=(note.notenum.2<=UNIT_MEASURE*3/8)
							stat2=UNIT_MEASURE_8
						}
						if(stat1=1){
							if(turn=1){
								shlj.shljnum.0=3-cnt
							}else:if(turn=2){
								shlj.shljnum.0=pturn.cnt
							}else{
								shlj.shljnum.0=cnt
							}
							shlj.shljnum.1=note.notenum.1
							shlj.shljnum.2=note.notenum.2
							if(bpm<256000){
								if(note.notenum.2>=UNIT_MEASURE_16*2){
									shlj.shljnum.1+=UNIT_MEASURE_16
									shlj.shljnum.2=UNIT_MEASURE_16
								}
							}else{
								if(note.notenum.2>=UNIT_MEASURE_8*2){
									shlj.shljnum.1+=UNIT_MEASURE_8
									shlj.shljnum.2=UNIT_MEASURE_8
								}
							}
							shlj.shljnum.4=c2t(shlj.shljnum.1)
							shlj.shljnum.5=c2t(shlj.shljnum.1+shlj.shljnum.2)
							shlj.shljnum.6=notenum
							shlj.shljnum.7=longrate
							if(shortmode!=mode_off){
								stat4+=longrate
								stat4_2+=50*longrate
							}
							shljnum++
							totalcombo++
						}else{
							for i,(note.notenum.1+stat2-1)/stat2*stat2+stat2,note.notenum.1+note.notenum.2-stat2,stat2
								if(turn=1){
									shlj.shljnum.0=3-cnt
								}else:if(turn=2){
									shlj.shljnum.0=pturn.cnt
								}else{
									shlj.shljnum.0=cnt
								}
								shlj.shljnum.1=i
								shlj.shljnum.2=0
								if(i>note.notenum.1+note.notenum.2-stat2*2){
									shlj.shljnum.2+=stat2*2
								}else{
									shlj.shljnum.2+=stat2
								}
								shlj.shljnum.4=c2t(shlj.shljnum.1)
								shlj.shljnum.5=c2t(shlj.shljnum.1+shlj.shljnum.2)
								shlj.shljnum.6=notenum
								shlj.shljnum.7=longrate
								if(shortmode!=mode_off){
									stat4+=longrate
									stat4_2+=50*longrate
								}
								shljnum++
								totalcombo++
							next
						}
					}
					note.notenum.5=-1
					if(np.cnt!=-1){
						note.(np.cnt).5=notenum
					}
					np.cnt=notenum
					notese.notenum=-1 // ロングBTオブジェクトは効果音を鳴らさない
					notenum++
				}
			}
		loop
		// ロングオブジェクトのリストアップ
		repeat 2
			if(longmode=3):break
			lcnt=cnt
			if(strmid(d.cnt2a,cnt+5,1)="2"){
				note.notenum.0 = 4 + (cnt ^ pturnl)
				note.notenum.1=int(cbcnt)+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3
				if(note.notenum.1>=cmdline_from){
					note.notenum.2=0
					note.notenum.3=c2t(note.notenum.1)
					note.notenum.4=note.notenum.3
					note.notenum.5=-1
					note.notenum.7=chiprate
					if(t_finalnote<note.notenum.4):t_finalnote=note.notenum.4
					if(np.(cnt+4)!=-1){
						note.(np.(cnt+4)).5=notenum
					}
					np.(cnt+4)=notenum
					notese.notenum=-1
					// チップFXオブジェクトは効果音があれば鳴らす
					if(nextKeySoundNamesLR.lcnt != "" & keySoundExistsInLibrary(nextKeySoundNamesLR.lcnt)){
						notese.notenum = notesejnum
						notesej.notesejnum.0 = notenum // キー音の元オブジェクト番号
						notesej.notesejnum.1 = 0 // キー音の判定(0/1)
						notesej.notesejnum.2 = getKeySoundFromLibrary(nextKeySoundNamesLR.lcnt) // 再生するKeySoundへのポインタ
						notesej.notesejnum.3 = nextKeySoundVolumesLR.lcnt // 再生音量(%)
						notesejnum++
					}
					notenum++
					if(longmode!=mode_off){
						stat4+=6*chiprate
						stat4_2+=200*chiprate
						totalcombo++
					}
				}
				continue
			}
			if(strmid(d.cnt2a,cnt+5,1)!="0")&((strmid(d.(cnt2a-exc-1),cnt+5,1)="0")|(strmid(d.(cnt2a-exc-1),cnt+5,1)="2")|(exc=-1)){
				excd=0
				beatn2=beatn
				beatd2=beatd
				ddim lend,1
				lend=double(UNIT_MEASURE)*beatn2/beatd2/div.cnt3
				repeat
					if(cnt2a+cnt+1>=length(d)){
						break
					}
					if(d.(cnt2a+cnt+1)=""){
						continue
					}
					if(strmid(d.(cnt2a+cnt+1),0,2)="--"){
						excd++
						continue
					}
					if(StartsWith(d.(cnt2a+cnt+1), "beat=")){
						sdim beatstat,16,2
						stat1=strmid(d.(cnt2a+cnt+1),5,33)
						split stat1,"/",beatstat
						if(length(beatstat)=2){
							if((int(beatstat.0)>0)&(int(beatstat.1)>0)){
								beatn2=int(beatstat.0)
								beatd2=int(beatstat.1)
							}
						}
						continue
					}
					if(strmid(d.(cnt2a+cnt+1),4,1)!="|"){
						continue
					}
					if((strmid(d.(cnt2a+cnt+1),lcnt+5,1)!="0")&(strmid(d.(cnt2a+cnt+1),lcnt+5,1)!="2")){
						if(div.(cnt3+excd)=0):break
						lend+=double(UNIT_MEASURE)*beatn2/beatd2/div.(cnt3+excd)
					}else{
						break
					}
				loop
				note.notenum.0 = 4 + (cnt ^ pturnl)
				note.notenum.1=int(cbcnt)+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3
				if(note.notenum.1>=cmdline_from){
					note.notenum.2=int(lend)
					note.notenum.3=c2t(note.notenum.1)
					note.notenum.4=c2t(note.notenum.1+note.notenum.2)
					if(t_finalnote<note.notenum.4):t_finalnote=note.notenum.4
					if(longmode!=1){
						if(bpm<256000){
							stat1=(note.notenum.2<=UNIT_MEASURE*3/16)
							stat2=UNIT_MEASURE_16
						}else{
							stat1=(note.notenum.2<=UNIT_MEASURE*3/8)
							stat2=UNIT_MEASURE_8
						}
						if(stat1=1){
							longj.longjnum.0 = (cnt ^ pturnl)
							longj.longjnum.1=note.notenum.1
							longj.longjnum.2=note.notenum.2
							if(bpm<256000){
								if(note.notenum.2>=UNIT_MEASURE*2/16){
									longj.longjnum.1+=UNIT_MEASURE_16
									longj.longjnum.2=UNIT_MEASURE_16
								}
							}else{
								if(note.notenum.2>=UNIT_MEASURE*2/8){
									longj.longjnum.1+=UNIT_MEASURE_8
									longj.longjnum.2=UNIT_MEASURE_8
								}
							}
							longj.longjnum.4=c2t(longj.longjnum.1)
							longj.longjnum.5=c2t(longj.longjnum.1+longj.longjnum.2)
							longj.longjnum.6=notenum
							longj.longjnum.7=longrate
							if(longmode!=mode_off){
								stat4+=longrate
								stat4_2+=50*longrate
							}
							longjnum++
							totalcombo++
						}else{
							for i,(note.notenum.1+stat2-1)/stat2*stat2+stat2,note.notenum.1+note.notenum.2-stat2,stat2
								longj.longjnum.0 = (cnt ^ pturnl)
								longj.longjnum.1 = i
								longj.longjnum.2 = 0
								if(i>note.notenum.1+note.notenum.2-stat2*2){
									longj.longjnum.2+=stat2*2
								}else{
									longj.longjnum.2+=stat2
								}
								longj.longjnum.4=c2t(longj.longjnum.1)
								longj.longjnum.5=c2t(longj.longjnum.1+longj.longjnum.2)
								longj.longjnum.6=notenum
								longj.longjnum.7=longrate
								if(longmode!=mode_off){
									stat4+=longrate
									stat4_2+=50*longrate
								}
								longjnum++
								totalcombo++
							next
						}
					}
					note.notenum.5=-1
					if(np.(cnt+4)!=-1){
						note.(np.(cnt+4)).5=notenum
					}
					np.(cnt+4)=notenum
					notese.notenum=-1 // ロングFXオブジェクトは効果音を鳴らさない
					notenum++
				}
			}
			if((strmid(d.cnt2a,cnt+5,1)!="0")&((strmid(d.(cnt2a-exc-1),cnt+5,1)!=strmid(d.cnt2a,cnt+5,1))|(exc=-1)|((csongver_int>=160)&(fxfl.cnt=1)))){
				excd=0
				beatn2=beatn
				beatd2=beatd
				ddim lend,1
				lend=double(UNIT_MEASURE)*beatn2/beatd2/div.cnt3
				stat2=strmid(d.cnt2a,cnt+5,1)
				repeat
					if(cnt2a+cnt+1>=length(d)){
						break
					}
					if(d.(cnt2a+cnt+1)=""){
						continue
					}
					if(strmid(d.(cnt2a+cnt+1),0,2)="--"){
						excd++
						continue
					}
					if(StartsWith(d.(cnt2a+cnt+1), "beat=")){
						sdim beatstat,16,2
						stat1=strmid(d.(cnt2a+cnt+1),5,33)
						split stat1,"/",beatstat
						if(length(beatstat)=2){
							if((int(beatstat.0)>0)&(int(beatstat.1)>0)){
								beatn2=int(beatstat.0)
								beatd2=int(beatstat.1)
							}
						}
						continue
					}
					if(strmid(d.(cnt2a+cnt+1),4,1)!="|"){
						continue
					}
					if(strmid(d.(cnt2a+cnt+1),lcnt+5,1)=stat2){
						if(div.(cnt3+excd)=0):break
						lend+=double(UNIT_MEASURE)*beatn2/beatd2/div.(cnt3+excd)
					}else{
						break
					}
				loop
				notefx.notefxnum.0 = 4 + (cnt ^ pturnl)
				notefx.notefxnum.1=int(cbcnt)+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3
				notefx.notefxnum.2=int(lend)
				notefx.notefxnum.3=c2t(notefx.notefxnum.1)
				notefx.notefxnum.4=c2t(notefx.notefxnum.1+notefx.notefxnum.2)
				if(csongver_int>=160){
					repeat fxnum
						if((fx.cnt.0=lcnt)&(fx.cnt.1=notefx.notefxnum.1)){
							notefx.notefxnum.5=fx.cnt.2
							notefx.notefxnum.6=fx.cnt.3
							notefx.notefxnum.7=fx.cnt.4
							break
						}
					loop
				}else{
					stat1=strmid(d.cnt2a,cnt+5,1)
					if(stat2="S"){
						notefx.notefxnum.5=1
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Retr=1
					}else:if(stat2="V"){
						notefx.notefxnum.5=2
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Retr=1
					}else:if(stat2="T"){
						notefx.notefxnum.5=3
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Retr=1
					}else:if(stat2="W"){
						notefx.notefxnum.5=4
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Retr=1
					}else:if(stat2="U"){
						notefx.notefxnum.5=5
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Retr=1
					}else:if(stat2="G"){
						notefx.notefxnum.5=6
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Gate=1
					}else:if(stat2="H"){
						notefx.notefxnum.5=7
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Gate=1
					}else:if(stat2="K"){
						notefx.notefxnum.5=8
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Gate=1
					}else:if(stat2="I"){
						notefx.notefxnum.5=9
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Gate=1
					}else:if(stat2="L"){
						notefx.notefxnum.5=10
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Gate=1
					}else:if(stat2="J"){
						notefx.notefxnum.5=11
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Gate=1
					}else:if(stat2="F"){
						notefx.notefxnum.5=12
						fl_Flan=1
					}else:if(stat2="P"){
						notefx.notefxnum.5=13
						note.notenum.4=12
					}else:if(stat2="B"){
						notefx.notefxnum.5=14
						notefx.notefxnum.6=5
						repeat fxparamsnum
							if((fxparams.cnt.0=notefx.notefxnum.0-4)&(fxparams.cnt.1=notefx.notefxnum.1)){
								notefx.notefxnum.6=min(max(fxparams.cnt.2,0),64)
							}
						loop
						fl_BitC=1
					}else:if(stat2="Q"){
						notefx.notefxnum.5=15
						fl_Phas=1
					}else:if(stat2="X"){
						notefx.notefxnum.5=16
						notefx.notefxnum.6=fx_div.(notefx.notefxnum.5)
						fl_Gate=1
					}else:if(stat2="A"){
						notefx.notefxnum.5=17
						repeat fxparamsnum
							if((fxparams.cnt.0=notefx.notefxnum.0-4)&(fxparams.cnt.1=notefx.notefxnum.1)){
								notefx.notefxnum.6=min(max(fxparams.cnt.2,0),100)
							}
						loop
						fl_TStp=1
					}else:if(stat2="D"){
						notefx.notefxnum.5=19
						fl_SiCh=1
					}else{
						notefx.notefxnum.5=0
					}
				}
				notefxnum++
			}
			fxfl.cnt=0
		loop
		// アナログデバイスのリストアップ
		dim analogturnstat,2
		repeat 2
			if(analogmode=3):break
			if((strmid(d.cnt2a,cnt+8,1)!="-")&(strmid(d.cnt2a,cnt+8,1)!=":")){
				cnt0=cnt
				// アナログデバイスの開始地点かどうかを判定
				exc=0
				if(cnt2a=0){
					analog.analognum.5=1
					anagrcnt.cnt=max(anagrcnt.0,anagrcnt.1)+1
				}else{
					repeat
						if(cnt2a-cnt-1<0){
							analog.analognum.5=1
							anagrcnt.cnt=max(anagrcnt.0,anagrcnt.1)+1
							break
						}
						if(strmid(d.(cnt2a-cnt-1),cnt0+8,1)=":"){
							exc++
							continue
						}
						if(strmid(d.(cnt2a-cnt-1),4,1)!="|"){
							exc++
							continue
						}
						break
					loop
					if(cnt2a-exc-1>=0){
						if(strmid(d.(cnt2a-exc-1),cnt+8,1)="-"){
							analog.analognum.5=1
							anagrcnt.cnt=max(anagrcnt.0,anagrcnt.1)+1
						}
						if(cnt2a>1){
							exc2=0
							repeat
								if(strmid(d.(cnt2a-exc-cnt-1),4,1)!="|"){
									exc2++
									continue
								}
								break
							loop
						}
					}
				}
				// アナログデバイスの変化にかかる長さを確認
				excd=0
				stat3=0
				beatn2=beatn
				beatd2=beatd
				ddim lend,1
				lend=double(UNIT_MEASURE)*beatn2/beatd2/div.(cnt3+excd)
				repeat
					if(stat3=1){
						stat3=0
					}
					if(cnt2a+cnt+1>=sp){
						stat1=-1 // 異常
						break
					}
					if(strmid(d.(cnt2a+cnt+1),0,2)="--"){
						excd++
						continue
					}
					if(StartsWith(d.(cnt2a+cnt+1), "beat=")){
						sdim beatstat,16,2
						stat1=strmid(d.(cnt2a+cnt+1),5,33)
						split stat1,"/",beatstat
						if(length(beatstat)=2){
							if((int(beatstat.0)>0)&(int(beatstat.1)>0)){
								beatn2=int(beatstat.0)
								beatd2=int(beatstat.1)
							}
						}
						continue
					}
					if(strmid(d.(cnt2a+cnt+1),4,1)!="|"){
						continue
					}
					if(div.(cnt3+excd)=0){
						break
					}
					if(strmid(d.(cnt2a+cnt+1),cnt0+8,1)!=":"){
						stat1=a2p(strmid(d.(cnt2a+cnt+1),cnt0+8,1))
						break
					}
					lend+=double(UNIT_MEASURE)*beatn2/beatd2/div.(cnt3+excd)
				loop
				// 異常がなければリストに追加
				if(stat1!=-1){
					// 対象のアナログデバイス(L:0,R:1)
					analog.analognum.0 = cnt ^ pturna
					analog.analognum.1 = int(cbcnt) + cnt2 * UNIT_MEASURE * beatn / beatd / div.cnt3 // 変化の始点カウント値
					if(analog.analognum.1>=cmdline_from){
						analog.analognum.2=int(lend) // 変化にかかる時間
						analog.analognum.6=c2t(analog.analognum.1) // 変化の始点t
						analog.analognum.7=c2t(analog.analognum.1+analog.analognum.2) // 変化の終点t
						if(t_finalnote<analog.analognum.7):t_finalnote=analog.analognum.7
						if((analog.analognum.5=1)&(anaendstat.cnt!=-1)){
							analog.(anaendstat.cnt).8=1
						}
						analog.analognum.9=-1
						if(anaendstat.cnt>=0):analognext.(anaendstat.cnt)=analognum
						analognext.analognum=-1
						analogprev.analognum=anaendstat.cnt
						anaendstat.cnt=analognum
						analog.analognum.3=a2p(strmid(d.cnt2a,cnt+8,1)) // 変化の初期値
						analog.analognum.4=stat1 // 変化の目標値
						if (pturna) {
							analog.analognum.3=50-analog.analognum.3
							analog.analognum.4=50-analog.analognum.4
						}
						if((analog.analognum.5=0)&(analogturnstat.cnt!=abs(analog.analognum.4-analog.analognum.3))){
							analogturn.cnt.(analogturnnum.cnt)=analog.analognum.6
							analogturnnum.cnt++
						}
						analogturnstat.cnt=abs(analog.analognum.4-analog.analognum.3)
						analoggr.analognum=anagrcnt.cnt // アナログデバイスのまとまりの番号
						analoggrmax.cnt=anagrcnt.cnt
						if(analogmode!=mode_off){
							if(bpm<256000){
								stat1=UNIT_MEASURE_16
							}else{
								stat1=UNIT_MEASURE_8
							}
							if((analog.analognum.2>UNIT_MEASURE_32)|(analog.analognum.3=analog.analognum.4)){
								for i,(analog.analognum.1+stat1-1)/stat1*stat1/*+analog.analognum.5*stat1*/,analog.analognum.1+analog.analognum.2,stat1
									analogj.analogjnum.0 = cnt ^ pturna
									analogj.analogjnum.1 = i
									analogj.analogjnum.3 = max(laserrate, 1)
									analogjnum++
									if(analogmode!=mode_off){
										stat4+=laserrate
										stat4_2+=50*laserrate
									}
								next
							}else{
								analoganj.analoganjnum.0 = cnt ^ pturna
								analoganj.analoganjnum.1 = analognum
								analoganj.analoganjnum.3 = analog.analognum.4
								analoganj.analoganjnum.4 = 0
								analoganj.analoganjnum.5 = max(laserrate, 1)
								analoganjnum++
								if(analogmode!=mode_off){
									stat4+=6*laserrate
									stat4_2+=200*laserrate
								}
							}
						}
						analognum++
					}
				}
			}
		loop
		if(strmid(d.cnt2a,10,1)="@"){
			// 画面回転のリストアップ
			f=1
			if(strmid(d.cnt2a,11,1)="("){
				spin.spinnum.0=0 // 時計回り回転
			}else:if(strmid(d.cnt2a,11,1)=")"){
				spin.spinnum.0=1 // 反時計回り
			}else:if(strmid(d.cnt2a,11,1)="<"){
				spin.spinnum.0=2 // 時計回り半回転
			}else:if(strmid(d.cnt2a,11,1)=">"){
				spin.spinnum.0=3 // 反時計回り半回転
			}else:f=0
			if(f=1){
				spin.spinnum.0 = spin.spinnum.0 / 2 * 2 + (spin.spinnum.0 - spin.spinnum.0 / 2 * 2) ^ pturna
				spin.spinnum.1 = int(cbcnt) + cnt2 * UNIT_MEASURE * beatn / beatd / div.cnt3 //位置
				spin.spinnum.2 = int(double(strmid(d.cnt2a, 12, 32)) * 625 / 12 * 145 / 100) //長さ(c)
				spinnum++
			}
		}
		if(strmid(d.cnt2a,10,1)="S"){
			// ばねエフェクトのリストアップ
			f=1
			if(strmid(d.cnt2a,11,1)="<"){
				spr.sprnum.0=0 // 左向き
			}else:if(strmid(d.cnt2a,11,1)=">"){
				spr.sprnum.0=1 // 右向き
			}else:f=0
			if(f=1){
				stat1=strmid(d.cnt2a,12,64)
				sdim splitstat,64,1
				split stat1,";",splitstat
				spr.sprnum.0 = spr.sprnum.0 / 2 * 2 + (spr.sprnum.0 - spr.sprnum.0 / 2 * 2) ^ pturna
				spr.sprnum.1=int(cbcnt)+cnt2*UNIT_MEASURE*beatn/beatd/div.cnt3 //位置
				spr.sprnum.2=int(double(splitstat.0)*625/12) //長さ(c)
				spr.sprnum.3=250 //揺れ幅
				if(length(splitstat)>=2):spr.sprnum.3=max(int(splitstat.1),0)
				spr.sprnum.4=3 //回数 (片道+1 往復+2)
				if(length(splitstat)>=3):spr.sprnum.4=max(int(splitstat.2),0)
				spr.sprnum.5=2 //減衰の有無 (0:なし 1:あり(遅) 2:あり)
				if(spr.sprnum.4>=0){
					if(length(splitstat)>=4):spr.sprnum.5=min(max(int(splitstat.3),0),2)
					sprnum++
				}
			}
		}
		pturnlp=pturnl
		nextKeySoundNamesLR = "", ""
		nextKeySoundVolumesLR = 100, 100
	loop
	repeat 2
		if(anaendstat.cnt!=-1):analog.(anaendstat.cnt).8=1
	loop
	totalcombo+=analoganjnum+analogjnum
	dim mid_sw,swaudionum
	repeat swaudionum
		exist swaudio.cnt
		if(strsize>0){
			mid_sw.cnt=KSHLib_SwitchAudioOpen(cnt,swaudio.cnt,0x20000)
		}else{
			exist getpath(ccsongfile,32)+swaudio.cnt
			if(strsize>0){
				mid_sw.cnt=KSHLib_SwitchAudioOpen(cnt,getpath(ccsongfile,32)+swaudio.cnt,0x20000)
			}else:dialog "Error: Could not find SwitchAudio file (\""+swaudio.cnt+"\")"
		}
		BASS_ChannelSetLink mid.0,mid_sw.cnt
		if(BASS_ErrorGetCode()!=0){
			mlinkfailed=1
		}
		hPeakFX_sw.cnt=BASS_ChannelSetFX(mid_sw.cnt,0x10013,2)
		hPeakFX2_sw.cnt=BASS_ChannelSetFX(mid_sw.cnt,0x10013,3)
		hBitCFX_sw.cnt=BASS_VST_ChannelSetDSP(mid_sw.cnt,dir_default+"\\lib\\bitc.dll",0,8)
		BASS_VST_SetParam_R hBitCFX_sw.cnt,0,0.0f
		hCompFX_sw.cnt=-1
		hVolFX2_sw.cnt=-1
	loop
	// VSTエフェクトの適用
	dim user_now,max(userfxnum,1)
	if(feffect=1){
		dim hFX_Echo,2
		hFX_Echo=-1,-1
		if(fl_Echo=1){
			repeat 2
				hFX_Echo.cnt=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\regawo.dll",0,26)
				BASS_VST_SetParam_R hFX_Echo.cnt,1,0.0f
				BASS_VST_SetParam_R hFX_Echo.cnt,2,1.00f
				BASS_VST_SetParam_R hFX_Echo.cnt,29,1.0f
			loop
		}
		if(fl_Retr=1){
			hFX_Retr=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\regawo.dll",0,25)
			BASS_VST_SetParam_R hFX_Retr,1,0.0f
			BASS_VST_SetParam_R hFX_Retr,2,0.70f
			BASS_VST_SetParam_R hFX_Retr,29,1.0f
		}
		if(fl_Pitc=1){
			hFX_Pitc=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\pitc.dll",0,20)
			BASS_VST_SetParam_R hFX_Pitc,0,0.0f/48.0f/2.0f+0.50f
			BASS_VST_SetParam_R hFX_Pitc,1,700.0f/44100.0f
			BASS_VST_SetParam_R hFX_Pitc,2,0.40f*2.0f
			BASS_VST_SetParam_R hFX_Pitc,3,0.0f
		}
		if(fl_BitC=1){
			hFX_BitC=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\bitc.dll",0,19)
			BASS_VST_SetParam_R hFX_BitC,0,0
		}
		dim hFX_TStp,2
		hFX_TStp=-1,-1
		if(fl_TStp=1){
			hFX_TStp.0=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\tstp.dll",0,19)
			hFX_TStp.1=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\tstp.dll",0,18)
		}
		if(fl_Gate=1){
			hFX_Gate=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\regawo.dll",0,17)
			BASS_VST_SetParam_R hFX_Gate,1,0.0f
			BASS_VST_SetParam_R hFX_Gate,7,0.50f
			BASS_VST_SetParam_R hFX_Gate,8,0.90f
			BASS_VST_SetParam_R hFX_Gate,10,500.0f/22050.0f
			BASS_VST_SetParam_R hFX_Gate,11,20000.0f/22050.0f
			BASS_VST_SetParam_R hFX_Gate,12,1.414f/50.0f
			BASS_VST_SetParam_R hFX_Gate,13,0.80f
			BASS_VST_SetParam_R hFX_Gate,29,0.0f // GateとWobbleがあるためByPassにすると処理がややこしい
		}
		if(fl_Phas=1){
			hFX_Phas=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\phas.dll",0,16)
			BASS_VST_SetParam_R hFX_Phas,0,0.25f
			BASS_VST_SetParam_R hFX_Phas,1,0.0f
			BASS_VST_SetParam_R hFX_Phas,2,1500.0f/22050.0f
			BASS_VST_SetParam_R hFX_Phas,3,20000.0f/22050.0f
			BASS_VST_SetParam_R hFX_Phas,4,0.707f/50.0f
			BASS_VST_SetParam_R hFX_Phas,5,0.35f
			BASS_VST_SetParam_R hFX_Phas,6,0.75f
			BASS_VST_SetParam_R hFX_Phas,7,8.0f/20.0f
			BASS_VST_SetParam_R hFX_Phas,8,0.0f
		}
		if(fl_Flan=1){
			hFX_Flan=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\flan.dll",0,15)
			BASS_VST_SetParam_R hFX_Flan,0,0.25f
			BASS_VST_SetParam_R hFX_Flan,1,30.0f/44100.0f
			BASS_VST_SetParam_R hFX_Flan,2,45.0f/44100.0f
			BASS_VST_SetParam_R hFX_Flan,3,0.60f
			BASS_VST_SetParam_R hFX_Flan,4,0.0f
			BASS_VST_SetParam_R hFX_Flan,5,0.75f
			BASS_VST_SetParam_R hFX_Flan,6,0.0f
		}
		if(fl_SiCh=1){
			hFX_SiCh=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\sich.dll",0,14)
			BASS_VST_SetParam_R hFX_SiCh,1,0.0050f
			BASS_VST_SetParam_R hFX_SiCh,2,0.0f
			BASS_VST_SetParam_R hFX_SiCh,3,0.0010f
		}
		dim hFX_User,userfxnum+userfilternum
		repeat userfxnum
			if(userfx_fl.cnt=0){
				hFX_User.cnt=-1
				continue
			}
			hFX_User.cnt=BASS_VST_ChannelSetDSP(mid.0,dir_default+"\\lib\\"+fxdef_dllname.(int(userfx_params.cnt.0)),0,fxdef_priority.(int(userfx_params.cnt.0)))
			cnt2=cnt
			repeat fxdef_prmnum.(int(userfx_params.cnt2.0)),1
				if((userfx_params.cnt2.cnt<0.0f)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)){
					BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(-userfx_params.cnt2.cnt/10.0f,0.0f),1.0f)
				}else:if(fxdef_max.cnt.(int(userfx_params.cnt2.0))>0.0f){
					BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),minf(maxf(fxdef_prmmax.cnt.(int(userfx_params.cnt2.0))*userfx_params.cnt2.cnt/fxdef_max.cnt.(int(userfx_params.cnt2.0)),0.0f),1.0f)
				}else:if((userfx_params.cnt2.cnt>0.0f)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_LENGTH)&(fxdef_linkprm.(int(userfx_params.cnt2.0))=cnt)){
					user_now.cnt2=int(1.0f/userfx_params.cnt2.cnt)
				}else:if((fxdef_prmno.cnt.(int(userfx_params.cnt2.0))!=-1)&(fxdef_type.cnt.(int(userfx_params.cnt2.0))=FXDEF_PITCH)){
					// PitchShift pitch
					BASS_VST_SetParam_R hFX_User.cnt2,fxdef_prmno.cnt.(int(userfx_params.cnt2.0)),maxf(minf(absf(userfx_params.cnt2.cnt),1.0f),0.0f)
				}
			loop
			// ByPassの設定
			BASS_VST_SetParam_R hFX_User.cnt,29,1.0f
		loop
	}
	// 回転の適用
	spinfcnt=0
	sprfcnt=0
	repeat analognum
		if((analog.cnt.2<=UNIT_MEASURE_32)&(analog.cnt.3!=analog.cnt.4)){
			stat1=cnt
			repeat spinnum-spinfcnt,spinfcnt
				if(spin.cnt.1<analog.stat1.1):spinfcnt=cnt
				if((spin.cnt.1=analog.stat1.1)&(sgn(analog.stat1.4-analog.stat1.3)=((spin.cnt.0-spin.cnt.0/2*2)*2-1))&(spin.cnt.0<10)){
					analog.stat1.9=cnt
					spin.cnt.0+=10
					break
				}
			loop
			repeat sprnum
				if(spr.cnt.1<analog.stat1.1):sprfcnt=cnt
				if((spr.cnt.1=analog.stat1.1)&(sgn(analog.stat1.4-analog.stat1.3)=((spr.cnt.0-spr.cnt.0/2*2)*2-1))&(spr.cnt.0<10)){
					analog.stat1.9=-cnt-2
					spr.cnt.0+=10
					break
				}
			loop
		}
	loop
	repeat spinnum
		if(spin.cnt.0>=10){
			spin.cnt.0-=10
		}else:spin.cnt.0=-1
	loop
	repeat sprnum
		if(spr.cnt.0>=10){
			spr.cnt.0-=10
		}else:spr.cnt.0=-1
	loop
	// 直角音の種類の適用
	repeat analoganjnum
		stat1=cnt
		repeat ansenum
			if(anse.cnt.0=analog.(analoganj.stat1.1).1){
				analoganj.stat1.4=anse.cnt.1
				break
			}
		loop
	loop
	// レーザー移動幅の適用
	repeat 2
		cnt2=cnt
		repeat max(analoggrmax.0,analoggrmax.1)+1
			anagrran.cnt2.cnt=1
		loop
	loop
	repeat anarannum
		cnt2=cnt
		repeat analognum
			if((anaran.cnt2.0=analog.cnt.0)&(anaran.cnt2.1=analog.cnt.1)&(analog.cnt.5=1)){
				anagrran.(analog.cnt.0).(analoggr.cnt)=anaran.cnt2.2
			}
			if((analog.cnt.1>=anaran.cnt2.1)&(analog.cnt.0=anaran.cnt2.0)):break
		loop
	loop
	if(adjmode=1){
		repeat
			note.notenum.0=2
			note.notenum.1=int(double(cnt)*UNIT_MEASURE_4)
			note.notenum.2=0
			note.notenum.3=c2t(note.notenum.1)
			note.notenum.4=note.notenum.3
			note.notenum.5=-1
			if(note.notenum.3>mlength):break
			if(np.3!=-1){
				note.(np.3).5=notenum
			}
			np.3=notenum
			notenum++
			stat4+=6
			stat4_2+=200
		loop
	}
	gosub *minfoprepare
	// ゲージ増減量の決定
	if(csongtotal<100){
		gaugemax=int(double(stat4)*20)
		if(gaugemax<125000){
			gaugemax=(gaugemax*gaugemax/125000)/5+gaugemax*4/5
		}
		if(gaugemax>100000){
			gaugemax=100000+(gaugemax-100000)/2
		}
		gaugemax=min(gaugemax,125000)
	}else{
		gaugemax=int(double(stat4_2)*100/csongtotal)
	}
	if(gaugemax>stat4_2):gaugemax=stat4_2
	if(gaugemax=0):gaugemax=1
	csongtotal=stat4_2*100/gaugemax
	// 無駄な確保をやめる
	sdim d,1
	dim kar,notenum,8
	repeat notenum
		cnt2=cnt
		repeat 8
			kar.cnt2.cnt=note.cnt2.cnt
		loop
	loop
	dim note,notenum,8
	repeat notenum
		cnt2=cnt
		repeat 8
			note.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,notefxnum,8
	repeat notefxnum
		cnt2=cnt
		repeat 8
			kar.cnt2.cnt=notefx.cnt2.cnt
		loop
	loop
	dim notefx,notefxnum,8
	repeat notefxnum
		cnt2=cnt
		repeat 8
			notefx.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,notesejnum,4
	repeat notesejnum
		cnt2=cnt
		repeat 4
			kar.cnt2.cnt=notesej.cnt2.cnt
		loop
	loop
	dim notesej,notesejnum,4
	repeat notesejnum
		cnt2=cnt
		repeat 4
			notesej.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,longjnum,8
	repeat longjnum
		cnt2=cnt
		repeat 8
			kar.cnt2.cnt=longj.cnt2.cnt
		loop
	loop
	dim longj,longjnum,8
	repeat longjnum
		cnt2=cnt
		repeat 8
			longj.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,shljnum,8
	repeat shljnum
		cnt2=cnt
		repeat 8
			kar.cnt2.cnt=shlj.cnt2.cnt
		loop
	loop
	dim shlj,shljnum,8
	repeat shljnum
		cnt2=cnt
		repeat 8
			shlj.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,analogjnum,4
	repeat analogjnum
		cnt2=cnt
		repeat 4
			kar.cnt2.cnt=analogj.cnt2.cnt
		loop
	loop
	dim analogj,analogjnum,5
	repeat analogjnum
		cnt2=cnt
		repeat 4
			analogj.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,analoganjnum,6
	repeat analoganjnum
		cnt2=cnt
		repeat 6
			kar.cnt2.cnt=analoganj.cnt2.cnt
		loop
	loop
	dim analoganj,analoganjnum,6
	repeat analoganjnum
		cnt2=cnt
		repeat 6
			analoganj.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,2,max(analogturnnum.0,analogturnnum.1)
	repeat max(analogturnnum.0,analogturnnum.1)
		kar.0.cnt=analogturn.0.cnt
		kar.1.cnt=analogturn.1.cnt
	loop
	dim analogturn,2,max(analogturnnum.0,analogturnnum.1)
	repeat max(analogturnnum.0,analogturnnum.1)
		analogturn.0.cnt=kar.0.cnt
		analogturn.1.cnt=kar.1.cnt
	loop
	dim noteresult,notenum
	dim noteresult,notenum
	dim kar,analognum,10
	repeat analognum
		cnt2=cnt
		repeat 10
			kar.cnt2.cnt=analog.cnt2.cnt
		loop
	loop
	dim analog,analognum,10
	repeat analognum
		cnt2=cnt
		repeat 10
			analog.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,analognum
	repeat analognum
		kar.cnt=analoggr.cnt
	loop
	dim analoggr,analognum
	repeat analognum
		analoggr.cnt=kar.cnt
	loop
	dim kar,analognum
	repeat analognum
		kar.cnt=analogbuf.cnt
	loop
	dim analogbuf,analognum
	repeat analognum
		analogbuf.cnt=kar.cnt
	loop
	dim kar,spinnum,4
	repeat spinnum
		cnt2=cnt
		repeat 4
			kar.cnt2.cnt=spin.cnt2.cnt
		loop
	loop
	dim spin,spinnum,4
	repeat spinnum
		cnt2=cnt
		repeat 4
			spin.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,sprnum,6
	repeat sprnum
		cnt2=cnt
		repeat 6
			kar.cnt2.cnt=spr.cnt2.cnt
		loop
	loop
	dim spr,sprnum,6
	repeat sprnum
		cnt2=cnt
		repeat 6
			spr.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,tiltnum,2
	repeat tiltnum
		cnt2=cnt
		repeat 2
			kar.cnt2.cnt=tilt.cnt2.cnt
		loop
	loop
	dim tilt,tiltnum,5//6
	repeat tiltnum
		cnt2=cnt
		repeat 2
			tilt.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,bpmlnum,3
	repeat bpmlnum
		cnt2=cnt
		repeat 3
			kar.cnt2.cnt=bpml.cnt2.cnt
		loop
	loop
	dim bpml,bpmlnum,3
	repeat bpmlnum
		cnt2=cnt
		repeat 3
			bpml.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,beatlnum,3
	repeat beatlnum
		cnt2=cnt
		repeat 3
			kar.cnt2.cnt=beatl.cnt2.cnt
		loop
	loop
	dim beatl,beatlnum,3
	repeat beatlnum
		cnt2=cnt
		repeat 3
			beatl.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,anagainnum,2
	repeat anagainnum
		cnt2=cnt
		repeat 2
			kar.cnt2.cnt=anagain.cnt2.cnt
		loop
	loop
	dim anagain,anagainnum,3
	repeat anagainnum
		cnt2=cnt
		repeat 2
			anagain.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,anafilnum,2
	repeat anafilnum
		cnt2=cnt
		repeat 2
			kar.cnt2.cnt=anafil.cnt2.cnt
		loop
	loop
	dim anafil,anafilnum,3
	repeat anafilnum
		cnt2=cnt
		repeat 2
			anafil.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,anvolnum,3
	repeat anvolnum
		cnt2=cnt
		repeat 3
			kar.cnt2.cnt=anvol.cnt2.cnt
		loop
	loop
	dim anvol,anvolnum,3
	repeat anvolnum
		cnt2=cnt
		repeat 3
			anvol.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,stpnum,2
	repeat stpnum
		cnt2=cnt
		repeat 2
			kar.cnt2.cnt=stp.cnt2.cnt
		loop
	loop
	dim stp,stpnum,2
	repeat stpnum
		cnt2=cnt
		repeat 2
			stp.cnt2.cnt=kar.cnt2.cnt
		loop
	loop
	dim kar,1
	if(gaugemax<=0):gaugemax=1
	is_scene_initial_frame=0
	dim notefcnt,6
	dim analogfcnt,2
	dim jfcnt,6
	notejfcnt=0
	dim notefxfcnt,2
	dim shljfcnt,4
	dim longjfcnt,2
	dim analogjfcnt,2
	dim analogjfcnt2,2
	dim analogefffcnt,2
	dim analogturnfcnt,2
	analoganjfcnt=0
	anagainfcnt=0
	anafilfcnt=0
	anafilfcnt2=0
	anvolfcnt=0
	notetickfcnt=0
	rotatefcnt=0
	bpm=bpml.0.1
	nscore=0
	lscore=0
	analogscore=0
	critical=0
	near=0
	errorn=0
	fast=0
	slow=0
	ddim tiltrnow,1
	ddim tiltrnowp,1
	ddim tiltnowstart,1
	tiltnow=0
	tiltnowp=0
	tiltnowslidet=1
	tiltnowstart2=0
	ddim romaxstat,3
	romaxstat.0=maxf(romax*(tiltnowp\3=0)+rotatemax*(tiltnowp\3=1)+rotatemax2*(tiltnowp\3=2),0.1)
	romaxstat.1=maxf(romax*(tiltnow\3=0)+rotatemax*(tiltnow\3=1)+rotatemax2*(tiltnow\3=2),0.1)
	romaxstat.2=romaxstat.1
	tiltrnow=romaxstat.2
	tiltnowt=-50000
	tiltnowstart=tiltrnow
	filtertypep=0
	filtertypep2=0
	canagainp=0
	canagainp2=0
	retr_beat=-1
	retr_beatp=-2
	sich_trigger=0
	dim user_trigger,max(userfxnum,1)
	sich_beat=-1
	sich_beatp=-2
	dim user_beat,max(userfxnum,1)
	dim user_beatp,max(userfxnum,1)
	retr_now=0
	gate_now=0
	wobble_now=0
	dim echo_trigger,2
	dim echo_now,2
	c2bnow=0
	c2bnowp=0
	c2bnowp_50ms=0
	layernowp=-6
	bgnowp=-1
	dim feffectnow,2
	dim feffectp,2
	dim feffectnow_real,2
	dim feffectp_real,2
	feffectp_real=-1,-1
	dim feffectparam,2
	dim feffectparam2,2
	ddim sync,1
	zure=0
	zuremax=0
	d3timerp=d3timer()
	repeat anagainnum
		anagain.cnt.2=c2t(anagain.cnt.0)
	loop
	repeat anafilnum
		anafil.cnt.2=c2t(anafil.cnt.0)
	loop
	repeat analogjnum
		analogj.cnt.4=c2t(analogj.cnt.1)
	loop
	repeat anvolnum
		anvol.cnt.2=c2t(anvol.cnt.0)
	loop
	repeat spinnum
		spin.cnt.4=c2t(spin.cnt.1)
	loop
	repeat tiltnum
		tilt.cnt.2=c2t(tilt.cnt.0)
	loop
	// KEEP時の傾きを事前に計算
	repeat tiltnum
		cnt2=cnt
		ddim ro,2
		repeat analognum
			if((analog.cnt.1<=tilt.cnt2.0-2)&(analog.cnt.1+analog.cnt.2>tilt.cnt2.0-2)){
				if(analog.cnt.2<=UNIT_MEASURE_32){
					if(analog.cnt.8=0){
						if(analog.cnt.0=0){
							ro.0+=double(analog.cnt.4)*20
						}else{
							ro.1-=double(abs(analog.cnt.4-50))*20
						}
					}
				}else{
					if(analog.cnt.0=0){
						ro.0+=double(analog.cnt.3)*20+double(analog.cnt.4-analog.cnt.3)*20*(analog.cnt.2-(analog.cnt.1+analog.cnt.2-(tilt.cnt2.0-2)))/analog.cnt.2
					}else{
						ro.1-=double(abs(analog.cnt.3-50))*20+double(abs(analog.cnt.4-50)-abs(analog.cnt.3-50))*20*(analog.cnt.2-(analog.cnt.1+analog.cnt.2-(tilt.cnt2.0-2)))/analog.cnt.2
					}
				}
			}
		loop
		tilt.cnt.4=int(round(ro.0+ro.1))
	loop
	repeat spinnum
		spin.cnt.3=c2t(spin.cnt.1+spin.cnt.2)-spin.cnt.4
	loop
	shortnum=0
	lshnum=0
	repeat notenum
		if((note.cnt.2=0)&(((note.cnt.0<=3)&(shortmode!=mode_off))|((note.cnt.0>3)&(longmode!=mode_off)))){
			if(note.cnt.0<=3){
				shortnum++
			}else{
				lshnum++
			}
		}
	loop
	ddim ro,2
	t_moex=-offset-T_MOEX_DELAY-globaloffset // t_moex: expected music offset time
	if((cmov=0)&(vmov=1)&(output=0)){
		stat1=-voffset-T_MOEX_DELAY-globaloffset
		if(stat1<0):mci "seek v to 0"
	}
	gsel 0
	redraw 0
	hgreset
	selcang
	objsetf2 0,-M_PI/12,0.0f
	selcpos
	objsetf2 1,-45.0f,366.0f
	buffer 156,82/ra,7/ra
	pos 0,0
	gzoom 82/ra,7/ra,1,0,1,82/ra,7
	buffer 157,82/ra,7/ra
	pos 0,0
	gzoom 82/ra,7/ra,42,0,1,82/ra,7
	gsel 0
	texload2 dir_default+"\\cache\\laser_p.png"
	tex_laser_p=stat
	texload2 dir_default+"\\imgs\\score_header.png",480,48
	tex_score_header=stat
	dim tex_num2,2
	texload2 dir_default+"\\cache\\num2_0.png",two(getsize(10)),two(getsize(9)*16*2)
	tex_num2.0=stat
	texload2 dir_default+"\\cache\\num2_1.png",two(getsize(10)),two(getsize(9)*16*2)
	tex_num2.1=stat
	texload2 dir_default+"\\cache\\result_scorenum.png",two(getsize(24)),two(getsize(24)*10)
	tex_result_scorenum=stat
	texload2 dir_default+"\\cache\\er.png"
	tex_er=stat
	texload2 dir_default+"\\cache\\er_p.png"
	tex_er_p=stat
	texload2 dir_default+"\\imgs\\num0.png",136,1200
	tex_num0=stat
	texload2 dir_default+"\\imgs\\playresult.png",540,600
	tex_playresult=stat
	texload2 dir_default+"\\cache\\minfo_label.png"
	tex_minfo_label=stat
	texload2 dir_default+"\\cache\\minfo_detail.png"
	tex_minfo_detail=stat
	texload2 dir_default+"\\cache\\minfo_cur.png"
	tex_minfo_cur=stat
	texload2 dir_default+"\\cache\\fps.png"
	tex_fps=stat
	texload2 dir_default+"\\cache\\timingadjust_ms.png"
	tex_timingadjust_ms=stat
	texload2 dir_default+"\\cache\\timingadjust.png"
	tex_timingadjust=stat
	texload2 dir_default+"\\cache\\timingadjust_sign.png"
	tex_timingadjust_sign=stat
	// 背景画像読み込み
	if(bg>=1){
		stat3=0
		exist dir_default+"\\imgs\\bg\\"+bgname+"0.jpg"
		stat1=strsize
		exist dir_default+"\\imgs\\bg\\"+bgname+"1.jpg"
		stat2=strsize
		if((stat1<=0)|(stat2<=0)){
			sdim bgname2,64,1
			split bgname,";",bgname2
			if(length(bgname2)=1){
				exist bgname2.0
				stat1=strsize
				stat2=strsize
				stat4=bgname2.0
				bgname2=stat4,stat4
			}else:if(length(bgname2)>=2){
				exist bgname2.0
				stat1=strsize
				exist bgname2.1
				stat2=strsize
			}
			if((stat1<=0)|(stat2<=0)){
				bgname="desert"
			}else:stat3=1
		}

		// "cache/bg"ディレクトリが存在しなければ作成
		dirlist buf,dir_default+"\\cache\\bg",5
		if(buf=""):mkdir dir_default+"\\cache\\bg"

		if(stat3=0){
			exist dir_default+"\\cache\\bg\\"+bgname+"0.jpg"
			if(strsize=-1){
				gsel 2
				picload dir_default+"\\imgs\\bg\\"+bgname+"0.jpg"
				alCreateImage 2,two(getsize(900)),two(getsize(800))
				alStretchScreenToImage 2,2,0,0,720,640,0,0,getsize(900),getsize(800)
				alSaveFile dir_default+"\\cache\\bg\\"+bgname+"0.jpg","image/jpeg",0,0,two(getsize(900)),two(getsize(800))
				alDeleteImage 2
			}
			texload dir_default+"\\cache\\bg\\"+bgname+"0.jpg"
			addspr mod_bg0,0,0,0,getsize(900)-1,getsize(800)-1,stat
			exist dir_default+"\\cache\\bg\\"+bgname+"1.jpg"
			if(strsize=-1){
				gsel 2
				picload dir_default+"\\imgs\\bg\\"+bgname+"1.jpg"
				alCreateImage 2,two(getsize(900)),two(getsize(800))
				alStretchScreenToImage 2,2,0,0,720,640,0,0,getsize(900),getsize(800)
				alSaveFile dir_default+"\\cache\\bg\\"+bgname+"1.jpg","image/jpeg",0,0,two(getsize(900)),two(getsize(800))
				alDeleteImage 2
			}
			texload dir_default+"\\cache\\bg\\"+bgname+"1.jpg"
			addspr mod_bg1,0,0,0,getsize(900)-1,getsize(800)-1,stat
		}else{
			gsel 2
			picload bgname2.0
			alCreateImage 2,two(getsize(900)),two(getsize(800))
			alStretchScreenToImage 2,2,0,0,720,640,0,0,getsize(900),getsize(800)
			alSaveFile dir_default+"\\cache\\playbg0.jpg","image/jpeg",0,0,two(getsize(900)),two(getsize(800))
			alDeleteImage 2
			texload dir_default+"\\cache\\playbg0.jpg"
			addspr mod_bg0,0,0,0,getsize(900)-1,getsize(800)-1,stat
			gsel 2
			picload bgname2.1
			alCreateImage 2,two(getsize(900)),two(getsize(800))
			alStretchScreenToImage 2,2,0,0,720,640,0,0,getsize(900),getsize(800)
			alSaveFile dir_default+"\\cache\\playbg1.jpg","image/jpeg",0,0,two(getsize(900)),two(getsize(800))
			alDeleteImage 2
			texload dir_default+"\\cache\\playbg1.jpg"
			addspr mod_bg1,0,0,0,getsize(900)-1,getsize(800)-1,stat
		}
		regobj obj_bg,mod_bg0
	}
	if(bg>=2){
		exist dir_default+"\\imgs\\bg\\"+bgname_l+".gif"
		stat1=strsize
		stat3=0
		if(stat1<=0){
			exist bgname_l
			stat1=strsize
			if(stat1<=0){
				bgname_l="arrow"
			}else:stat3=1
		}
		buffer 2
		if(stat3=1){
			picload bgname_l
		}else{
			picload dir_default+"\\imgs\\bg\\"+bgname_l+".gif"
		}
		layermax=ginfo_winx/600
		dim mod_layer,layermax/3
		buffer 159,two(min(getsize(880),600)*3),two(min(getsize(704),480)*2)
		repeat layermax/3+1
			pos 0,0
			gmode 0
			gzoom min(getsize(880),600)*3,min(getsize(704),480)*2,2,600*3*cnt,0,600*3,480*2
			addspr mod_layer.cnt,0,0,0,min(getsize(880),600)-1,min(getsize(704),480)-1
			settex min(getsize(880),600)*3,min(getsize(704),480)*2,0,-1
		loop
		buffer 2,1,1
		buffer 159,1,1
		regobj obj_layer,mod_layer.0
		setscale obj_layer,880.0f*scrsize_h/480/min(getsize(880),600),880.0f*scrsize_h/480/min(getsize(880),600),880.0f*scrsize_h/480/min(getsize(880),600)
		setefx obj_layer,767
		setpos obj_layer,0.0f,-34.0f*scrsize_h/480/(880.0f*scrsize_h/480/min(getsize(880),600)),0.0f
		dim ev_layeruv,2,3
		repeat 2
			cnt2=cnt
			repeat 3
				newevent ev_layeruv(cnt2,cnt)
				event_uv ev_layeruv(cnt2,cnt),min(getsize(880),600)*cnt,min(getsize(704),480)*cnt2
			loop
		loop
	}
	buffer 129,int(38.5f*scrsize_h/480),int(38.5f*scrsize_h/480)
	alSelectImage 35
	alStretchImageToScreen 35,129,0,0,alGetWidth(),alGetHeight(),0,0,int(38.5f*scrsize_h/480),int(38.5f*scrsize_h/480)
	settex2 -1
	tex_jacket=stat
	gsel 51+118*(anaranfl=2)
	settex vw/ra*anaranfl,vh/ra,0,tex_lane_s
	tex_lane_s=stat
	addmesh mod_lane_s,1,1,0,double(vw2)*2/13,double(vh2)*13/20,tex_lane_s
	regobj obj_lane_s,mod_lane_s
	setefx obj_lane_s,1279,0,0
	sellambient
	objsetf3 256.0f,256.0f,256.0f
	gsel 5+163*(anaranfl=2)
	settex vw/ra*anaranfl,vh/ra,0,tex_lane
	tex_lane=stat
	texload2 dir_default+"\\imgs\\cline.png",344,26
	tex_cline=stat
	addmesh mod_lane,1,1,0,double(vw2)*2/13,double(vh2)*13/20,tex_lane
	regobj obj_lane,mod_lane
	setefx obj_lane,767-512*(bg=0),0,0
	addplate mod_cline,1,344.0f/8,26.0f/8,0,0,343,25,tex_cline
	regobj obj_cline,mod_cline
	setpos obj_cline,0.0f,-2.6f,double(vh2)*13/20/2+0.4f
	setang obj_cline,-M_PI/6,0.0f,0.0f
	gsel 155
	settex judgel_winx*anaranfl,judgel_winy,0,tex_judgel
	tex_judgel=stat
	addplate mod_judgel,0,452.0f*0.95f/8,140.0f*0.95f/8,0,0,judgel_winx-1,judgel_winy-1,tex_judgel
	gsel 155+15
	settex judgel_winx*anaranfl,judgel_winy,0,tex_judgel2x
	tex_judgel2x=stat
	addplate mod_judgel2x,0,452.0f*0.95f/8*2,140.0f*0.95f/8,0,0,judgel_winx*2-1,judgel_winy-1,tex_judgel2x
	regobj obj_judgel,mod_judgel,OBJ_XFRONT
	setpos obj_judgel,0.0f,-2.4f*1.5f,double(vh2)*13/20/2+1.2f*1.5f
	setefx obj_judgel,767,0,0
	dim mod_analogcur,2
	dim obj_analogcur,2
	repeat 2
		addplate mod_analogcur.cnt,1,4.5f,4.5f,0,64*cnt,63,64*cnt+63
		texload2 dir_default+"\\imgs\\laser_cur.png",64,64*2
		regobj obj_analogcur.cnt,mod_analogcur.cnt,OBJ_XFRONT
		setpos obj_analogcur.cnt,0.0f,-2.8f,double(vh2)*13/20/2+1.0f
		setang obj_analogcur.cnt,-M_PI/3,0.0f,0.0f
	loop
	gsel 21
	settex2 -1
	tex_combonum=stat
	gsel 23
	settex2 -1
	tex_er_g=stat
	gsel 147
	settex2 -1
	tex_er_g_pattern=stat
	getpos HGOBJ_CAMERA, camx, camy, camz
	fvset fv1,0.0f,-2.6f,double(vh2)*13/20/2+0.4f
	fvface fv1,camx,camy,camz
	fv2str fv1
	stat1=refstr
	split stat1,",",fvstat
	fv1=double(fvstat.0)
	mdelayt=0
	mrepeat=0
	minforefresh=1

	bpmp=bpm
	dim peffstatap,2
	peffstat2p=0
	swaudionow=-1
	swaudionow_resultp=-1
	mtp=0
	gsel 0
	if((analoginput=2)&(analogmode=mode_on)){
		if(hidem=1):mouse -1,-1
		mouse defx,defy
	}
	dim sliderp,2
	if(analoginput=4){
		repeat 2
			cnt0=cnt
			sliderp.cnt=0
			repeat length_joylist
				joyGetPosEx joystat2,joylist.cnt
				sliderp.cnt0+=joystat2.(4+(cnt0^analogsw))
			loop
		loop
	}
	cnowp=0
	cnowfxp=0
	cnowfxp_50ms=0
	bpmfxp=-1
	slider=0
	dim arstat,8,3
	dim chobufp,4
	plfl=1
	font lang.0.1,getsize(18)
	hgsettime -3400-1000*(cmovfile!=""),INT_MAX
	ts_bass=0
	ddim timingdif,1
	timingdif=-50000f
	ddim ttp,1
	
	if(cmdline_from>0){
		hgsettime max(c2t(cmdline_from)-1000,0),INT_MAX
	}
	
	csongfile_empty=(csongfile.0="")|(csongfile.0=".mp3")
	scrsize480=double(scrsize_h)/480

	// GameSystemの生成
	game_system = 0
	if (CreateGameSystem(cnotesfile, double(t_moex), varptr(game_system)) == 0) {
		dialog lang.2.5/*"譜面データの読み込み中にエラーが発生しました。"*/
		chdir dir_default+"\\songs"
		scene=SCENE_SELECT
		return // CreateGameSystemでfalseが返された場合、DestroyGameSystemを明示的に呼ぶ必要はない
	}

	// playシーンのメインループ
	// (hgimg3の使用や連番出力の関係で時間待ちの仕様が他シーンと異なるため、別途ここでループ)
	repeat
		on_update_play
		if (stat = 0) {
			break
		}
	loop

	return